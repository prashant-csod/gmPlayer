/**
 * Check if script is not already loaded
 */
if (window.guideMeClientLoaded === true) {
    throw new Error("gm_client.js is already loaded!");
}
window.guideMeClientLoaded = true;

!function(e){function n(){}function t(e,n){return function(){e.apply(n,arguments)}}function o(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],s(e,this)}function i(e,n){for(;3===e._state;)e=e._value;return 0===e._state?void e._deferreds.push(n):(e._handled=!0,void o._immediateFn(function(){var t=1===e._state?n.onFulfilled:n.onRejected;if(null===t)return void(1===e._state?r:u)(n.promise,e._value);var o;try{o=t(e._value)}catch(i){return void u(n.promise,i)}r(n.promise,o)}))}function r(e,n){try{if(n===e)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var i=n.then;if(n instanceof o)return e._state=3,e._value=n,void f(e);if("function"==typeof i)return void s(t(i,n),e)}e._state=1,e._value=n,f(e)}catch(r){u(e,r)}}function u(e,n){e._state=2,e._value=n,f(e)}function f(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var n=0,t=e._deferreds.length;n<t;n++)i(e,e._deferreds[n]);e._deferreds=null}function c(e,n,t){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof n?n:null,this.promise=t}function s(e,n){var t=!1;try{e(function(e){t||(t=!0,r(n,e))},function(e){t||(t=!0,u(n,e))})}catch(o){if(t)return;t=!0,u(n,o)}}var a=setTimeout;o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var o=new this.constructor(n);return i(this,new c(e,t,o)),o},o.all=function(e){var n=Array.prototype.slice.call(e);return new o(function(e,t){function o(r,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var f=u.then;if("function"==typeof f)return void f.call(u,function(e){o(r,e)},t)}n[r]=u,0===--i&&e(n)}catch(c){t(c)}}if(0===n.length)return e([]);for(var i=n.length,r=0;r<n.length;r++)o(r,n[r])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(n){n(e)})},o.reject=function(e){return new o(function(n,t){t(e)})},o.race=function(e){return new o(function(n,t){for(var o=0,i=e.length;o<i;o++)e[o].then(n,t)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){a(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},o._setImmediateFn=function(e){o._immediateFn=e},o._setUnhandledRejectionFn=function(e){o._unhandledRejectionFn=e},"undefined"!=typeof module&&module.exports?module.exports=o:e.Promise||(e.Promise=o)}(this);
/*global chrome*/
if (GmCXt === undefined) var GmCXt = {};

GmCXt.browserApp = false;
GmCXt.isFirefox = typeof InstallTrigger !== 'undefined';
GmCXt.isChrome = !!window.chrome;

if (GmCXt.isFirefox && typeof browser !== 'undefined') {
    GmCXt.browserApp = 'firefox';
} else if (GmCXt.isChrome && chrome.storage) {
    GmCXt.browserApp = 'chrome';
} else if ((navigator.userAgent.indexOf("Opera") || navigator.userAgent.indexOf('OPR')) != -1) {
    GmCXt.browserApp = "Opera";
} else if (navigator.userAgent.indexOf("Safari") != -1) {
    GmCXt.browserApp = "Safari";
}

GmCXt.isIE = /*@cc_on!@*/ !!document.documentMode;
if (GmCXt.isIE) {
    if (!window.Promise && typeof Promise !== 'undefined') {
        window.Promise = Promise;
    }
    GmCXt.browserApp = 'ie';
}
/*! jQuery v3.7.1 | (c) OpenJS Foundation and other contributors | jquery.org/license */
var hostJquery;
var host$;
if (typeof jQuery !== 'undefined') {
	hostJquery = jQuery;
	host$ = $;
}
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(ie,e){"use strict";var oe=[],r=Object.getPrototypeOf,ae=oe.slice,g=oe.flat?function(e){return oe.flat.call(e)}:function(e){return oe.concat.apply([],e)},s=oe.push,se=oe.indexOf,n={},i=n.toString,ue=n.hasOwnProperty,o=ue.toString,a=o.call(Object),le={},v=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},y=function(e){return null!=e&&e===e.window},C=ie.document,u={type:!0,src:!0,nonce:!0,noModule:!0};function m(e,t,n){var r,i,o=(n=n||C).createElement("script");if(o.text=e,t)for(r in u)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e}var t="3.7.1",l=/HTML$/i,ce=function(e,t){return new ce.fn.init(e,t)};function c(e){var t=!!e&&"length"in e&&e.length,n=x(e);return!v(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}function fe(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}ce.fn=ce.prototype={jquery:t,constructor:ce,length:0,toArray:function(){return ae.call(this)},get:function(e){return null==e?ae.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=ce.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return ce.each(this,e)},map:function(n){return this.pushStack(ce.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(ae.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(ce.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(ce.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:oe.sort,splice:oe.splice},ce.extend=ce.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||v(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(ce.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||ce.isPlainObject(n)?n:{},i=!1,a[t]=ce.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},ce.extend({expando:"jQuery"+(t+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=r(e))||"function"==typeof(n=ue.call(t,"constructor")&&t.constructor)&&o.call(n)===a)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){m(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(c(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,i=e.nodeType;if(!i)while(t=e[r++])n+=ce.text(t);return 1===i||11===i?e.textContent:9===i?e.documentElement.textContent:3===i||4===i?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(c(Object(e))?ce.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:se.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!l.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(c(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:le}),"function"==typeof Symbol&&(ce.fn[Symbol.iterator]=oe[Symbol.iterator]),ce.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var pe=oe.pop,de=oe.sort,he=oe.splice,ge="[\\x20\\t\\r\\n\\f]",ve=new RegExp("^"+ge+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ge+"+$","g");ce.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var f=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function p(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}ce.escapeSelector=function(e){return(e+"").replace(f,p)};var ye=C,me=s;!function(){var e,b,w,o,a,T,r,C,d,i,k=me,S=ce.expando,E=0,n=0,s=W(),c=W(),u=W(),h=W(),l=function(e,t){return e===t&&(a=!0),0},f="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",t="(?:\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",p="\\["+ge+"*("+t+")(?:"+ge+"*([*^$|!~]?=)"+ge+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+t+"))|)"+ge+"*\\]",g=":("+t+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+p+")*)|.*)\\)|)",v=new RegExp(ge+"+","g"),y=new RegExp("^"+ge+"*,"+ge+"*"),m=new RegExp("^"+ge+"*([>+~]|"+ge+")"+ge+"*"),x=new RegExp(ge+"|>"),j=new RegExp(g),A=new RegExp("^"+t+"$"),D={ID:new RegExp("^#("+t+")"),CLASS:new RegExp("^\\.("+t+")"),TAG:new RegExp("^("+t+"|[*])"),ATTR:new RegExp("^"+p),PSEUDO:new RegExp("^"+g),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ge+"*(even|odd|(([+-]|)(\\d*)n|)"+ge+"*(?:([+-]|)"+ge+"*(\\d+)|))"+ge+"*\\)|)","i"),bool:new RegExp("^(?:"+f+")$","i"),needsContext:new RegExp("^"+ge+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ge+"*((?:-\\d)?\\d*)"+ge+"*\\)|)(?=[^-]|$)","i")},N=/^(?:input|select|textarea|button)$/i,q=/^h\d$/i,L=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,H=/[+~]/,O=new RegExp("\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\([^\\r\\n\\f])","g"),P=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},M=function(){V()},R=J(function(e){return!0===e.disabled&&fe(e,"fieldset")},{dir:"parentNode",next:"legend"});try{k.apply(oe=ae.call(ye.childNodes),ye.childNodes),oe[ye.childNodes.length].nodeType}catch(e){k={apply:function(e,t){me.apply(e,ae.call(t))},call:function(e){me.apply(e,ae.call(arguments,1))}}}function I(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(V(e),e=e||T,C)){if(11!==p&&(u=L.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return k.call(n,a),n}else if(f&&(a=f.getElementById(i))&&I.contains(e,a)&&a.id===i)return k.call(n,a),n}else{if(u[2])return k.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&e.getElementsByClassName)return k.apply(n,e.getElementsByClassName(i)),n}if(!(h[t+" "]||d&&d.test(t))){if(c=t,f=e,1===p&&(x.test(t)||m.test(t))){(f=H.test(t)&&U(e.parentNode)||e)==e&&le.scope||((s=e.getAttribute("id"))?s=ce.escapeSelector(s):e.setAttribute("id",s=S)),o=(l=Y(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+Q(l[o]);c=l.join(",")}try{return k.apply(n,f.querySelectorAll(c)),n}catch(e){h(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return re(t.replace(ve,"$1"),e,n,r)}function W(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function F(e){return e[S]=!0,e}function $(e){var t=T.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function B(t){return function(e){return fe(e,"input")&&e.type===t}}function _(t){return function(e){return(fe(e,"input")||fe(e,"button"))&&e.type===t}}function z(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&R(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function X(a){return F(function(o){return o=+o,F(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function U(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function V(e){var t,n=e?e.ownerDocument||e:ye;return n!=T&&9===n.nodeType&&n.documentElement&&(r=(T=n).documentElement,C=!ce.isXMLDoc(T),i=r.matches||r.webkitMatchesSelector||r.msMatchesSelector,r.msMatchesSelector&&ye!=T&&(t=T.defaultView)&&t.top!==t&&t.addEventListener("visibilitychange",M),le.getById=$(function(e){return r.appendChild(e).id=ce.expando,!T.getElementsByName||!T.getElementsByName(ce.expando).length}),le.disconnectedMatch=$(function(e){return i.call(e,"*")}),le.scope=$(function(){return T.querySelectorAll(":scope")}),le.cssHas=$(function(){try{return T.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),le.getById?(b.filter.ID=function(e){var t=e.replace(O,P);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(O,P);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},b.find.CLASS=function(e,t){if("undefined"!=typeof t.getElementsByClassName&&C)return t.getElementsByClassName(e)},d=[],$(function(e){var t;r.appendChild(e).innerHTML="<a id='"+S+"' href='' disabled='disabled'></a><select id='"+S+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+ge+"*(?:value|"+f+")"),e.querySelectorAll("[id~="+S+"-]").length||d.push("~="),e.querySelectorAll("a#"+S+"+*").length||d.push(".#.+[+~]"),e.querySelectorAll(":checked").length||d.push(":checked"),(t=T.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&d.push(":enabled",":disabled"),(t=T.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||d.push("\\["+ge+"*name"+ge+"*="+ge+"*(?:''|\"\")")}),le.cssHas||d.push(":has"),d=d.length&&new RegExp(d.join("|")),l=function(e,t){if(e===t)return a=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!le.sortDetached&&t.compareDocumentPosition(e)===n?e===T||e.ownerDocument==ye&&I.contains(ye,e)?-1:t===T||t.ownerDocument==ye&&I.contains(ye,t)?1:o?se.call(o,e)-se.call(o,t):0:4&n?-1:1)}),T}for(e in I.matches=function(e,t){return I(e,null,null,t)},I.matchesSelector=function(e,t){if(V(e),C&&!h[t+" "]&&(!d||!d.test(t)))try{var n=i.call(e,t);if(n||le.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){h(t,!0)}return 0<I(t,T,null,[e]).length},I.contains=function(e,t){return(e.ownerDocument||e)!=T&&V(e),ce.contains(e,t)},I.attr=function(e,t){(e.ownerDocument||e)!=T&&V(e);var n=b.attrHandle[t.toLowerCase()],r=n&&ue.call(b.attrHandle,t.toLowerCase())?n(e,t,!C):void 0;return void 0!==r?r:e.getAttribute(t)},I.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ce.uniqueSort=function(e){var t,n=[],r=0,i=0;if(a=!le.sortStable,o=!le.sortStable&&ae.call(e,0),de.call(e,l),a){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)he.call(e,n[r],1)}return o=null,e},ce.fn.uniqueSort=function(){return this.pushStack(ce.uniqueSort(ae.apply(this)))},(b=ce.expr={cacheLength:50,createPseudo:F,match:D,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(O,P),e[3]=(e[3]||e[4]||e[5]||"").replace(O,P),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||I.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&I.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return D.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&j.test(n)&&(t=Y(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(O,P).toLowerCase();return"*"===e?function(){return!0}:function(e){return fe(e,t)}},CLASS:function(e){var t=s[e+" "];return t||(t=new RegExp("(^|"+ge+")"+e+"("+ge+"|$)"))&&s(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=I.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(v," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,h,g){var v="nth"!==d.slice(0,3),y="last"!==d.slice(-4),m="of-type"===e;return 1===h&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u=v!==y?"nextSibling":"previousSibling",l=e.parentNode,c=m&&e.nodeName.toLowerCase(),f=!n&&!m,p=!1;if(l){if(v){while(u){o=e;while(o=o[u])if(m?fe(o,c):1===o.nodeType)return!1;s=u="only"===d&&!s&&"nextSibling"}return!0}if(s=[y?l.firstChild:l.lastChild],y&&f){p=(a=(r=(i=l[S]||(l[S]={}))[d]||[])[0]===E&&r[1])&&r[2],o=a&&l.childNodes[a];while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if(1===o.nodeType&&++p&&o===e){i[d]=[E,a,p];break}}else if(f&&(p=a=(r=(i=e[S]||(e[S]={}))[d]||[])[0]===E&&r[1]),!1===p)while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if((m?fe(o,c):1===o.nodeType)&&++p&&(f&&((i=o[S]||(o[S]={}))[d]=[E,p]),o===e))break;return(p-=g)===h||p%h==0&&0<=p/h}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||I.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?F(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=se.call(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:F(function(e){var r=[],i=[],s=ne(e.replace(ve,"$1"));return s[S]?F(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:F(function(t){return function(e){return 0<I(t,e).length}}),contains:F(function(t){return t=t.replace(O,P),function(e){return-1<(e.textContent||ce.text(e)).indexOf(t)}}),lang:F(function(n){return A.test(n||"")||I.error("unsupported lang: "+n),n=n.replace(O,P).toLowerCase(),function(e){var t;do{if(t=C?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=ie.location&&ie.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===function(){try{return T.activeElement}catch(e){}}()&&T.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:z(!1),disabled:z(!0),checked:function(e){return fe(e,"input")&&!!e.checked||fe(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return q.test(e.nodeName)},input:function(e){return N.test(e.nodeName)},button:function(e){return fe(e,"input")&&"button"===e.type||fe(e,"button")},text:function(e){var t;return fe(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:X(function(){return[0]}),last:X(function(e,t){return[t-1]}),eq:X(function(e,t,n){return[n<0?n+t:n]}),even:X(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:X(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:X(function(e,t,n){var r;for(r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:X(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=B(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=_(e);function G(){}function Y(e,t){var n,r,i,o,a,s,u,l=c[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=y.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=m.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(ve," ")}),a=a.slice(n.length)),b.filter)!(r=D[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?I.error(e):c(e,s).slice(0)}function Q(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function J(a,e,t){var s=e.dir,u=e.next,l=u||s,c=t&&"parentNode"===l,f=n++;return e.first?function(e,t,n){while(e=e[s])if(1===e.nodeType||c)return a(e,t,n);return!1}:function(e,t,n){var r,i,o=[E,f];if(n){while(e=e[s])if((1===e.nodeType||c)&&a(e,t,n))return!0}else while(e=e[s])if(1===e.nodeType||c)if(i=e[S]||(e[S]={}),u&&fe(e,u))e=e[s]||e;else{if((r=i[l])&&r[0]===E&&r[1]===f)return o[2]=r[2];if((i[l]=o)[2]=a(e,t,n))return!0}return!1}}function K(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Z(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function ee(d,h,g,v,y,e){return v&&!v[S]&&(v=ee(v)),y&&!y[S]&&(y=ee(y,e)),F(function(e,t,n,r){var i,o,a,s,u=[],l=[],c=t.length,f=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)I(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),p=!d||!e&&h?f:Z(f,u,d,n,r);if(g?g(p,s=y||(e?d:c||v)?[]:t,n,r):s=p,v){i=Z(s,l),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(s[l[o]]=!(p[l[o]]=a))}if(e){if(y||d){if(y){i=[],o=s.length;while(o--)(a=s[o])&&i.push(p[o]=a);y(null,s=[],i,r)}o=s.length;while(o--)(a=s[o])&&-1<(i=y?se.call(e,a):u[o])&&(e[i]=!(t[i]=a))}}else s=Z(s===t?s.splice(c,s.length):s),y?y(null,t,s,r):k.apply(t,s)})}function te(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=J(function(e){return e===i},a,!0),l=J(function(e){return-1<se.call(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!=w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[J(K(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return ee(1<s&&K(c),1<s&&Q(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ve,"$1"),t,s<n&&te(e.slice(s,n)),n<r&&te(e=e.slice(n)),n<r&&Q(e))}c.push(t)}return K(c)}function ne(e,t){var n,v,y,m,x,r,i=[],o=[],a=u[e+" "];if(!a){t||(t=Y(e)),n=t.length;while(n--)(a=te(t[n]))[S]?i.push(a):o.push(a);(a=u(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=E+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==T||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==T||(V(o),n=!C);while(s=v[a++])if(s(o,t||T,n)){k.call(r,o);break}i&&(E=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=pe.call(r));f=Z(f)}k.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&ce.uniqueSort(r)}return i&&(E=h,w=p),c},m?F(r):r))).selector=e}return a}function re(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&Y(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&C&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(O,P),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=D.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(O,P),H.test(o[0].type)&&U(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&Q(o)))return k.apply(n,r),n;break}}}return(l||ne(e,c))(r,t,!C,n,!t||H.test(e)&&U(t.parentNode)||t),n}G.prototype=b.filters=b.pseudos,b.setFilters=new G,le.sortStable=S.split("").sort(l).join("")===S,V(),le.sortDetached=$(function(e){return 1&e.compareDocumentPosition(T.createElement("fieldset"))}),ce.find=I,ce.expr[":"]=ce.expr.pseudos,ce.unique=ce.uniqueSort,I.compile=ne,I.select=re,I.setDocument=V,I.tokenize=Y,I.escape=ce.escapeSelector,I.getText=ce.text,I.isXML=ce.isXMLDoc,I.selectors=ce.expr,I.support=ce.support,I.uniqueSort=ce.uniqueSort}();var d=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&ce(e).is(n))break;r.push(e)}return r},h=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},b=ce.expr.match.needsContext,w=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function T(e,n,r){return v(n)?ce.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?ce.grep(e,function(e){return e===n!==r}):"string"!=typeof n?ce.grep(e,function(e){return-1<se.call(n,e)!==r}):ce.filter(n,e,r)}ce.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?ce.find.matchesSelector(r,e)?[r]:[]:ce.find.matches(e,ce.grep(t,function(e){return 1===e.nodeType}))},ce.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(ce(e).filter(function(){for(t=0;t<r;t++)if(ce.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)ce.find(e,i[t],n);return 1<r?ce.uniqueSort(n):n},filter:function(e){return this.pushStack(T(this,e||[],!1))},not:function(e){return this.pushStack(T(this,e||[],!0))},is:function(e){return!!T(this,"string"==typeof e&&b.test(e)?ce(e):e||[],!1).length}});var k,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(ce.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||k,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof ce?t[0]:t,ce.merge(this,ce.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:C,!0)),w.test(r[1])&&ce.isPlainObject(t))for(r in t)v(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=C.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):v(e)?void 0!==n.ready?n.ready(e):e(ce):ce.makeArray(e,this)}).prototype=ce.fn,k=ce(C);var E=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function A(e,t){while((e=e[t])&&1!==e.nodeType);return e}ce.fn.extend({has:function(e){var t=ce(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(ce.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&ce(e);if(!b.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&ce.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?ce.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?se.call(ce(e),this[0]):se.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(ce.uniqueSort(ce.merge(this.get(),ce(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),ce.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return d(e,"parentNode")},parentsUntil:function(e,t,n){return d(e,"parentNode",n)},next:function(e){return A(e,"nextSibling")},prev:function(e){return A(e,"previousSibling")},nextAll:function(e){return d(e,"nextSibling")},prevAll:function(e){return d(e,"previousSibling")},nextUntil:function(e,t,n){return d(e,"nextSibling",n)},prevUntil:function(e,t,n){return d(e,"previousSibling",n)},siblings:function(e){return h((e.parentNode||{}).firstChild,e)},children:function(e){return h(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(fe(e,"template")&&(e=e.content||e),ce.merge([],e.childNodes))}},function(r,i){ce.fn[r]=function(e,t){var n=ce.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=ce.filter(t,n)),1<this.length&&(j[r]||ce.uniqueSort(n),E.test(r)&&n.reverse()),this.pushStack(n)}});var D=/[^\x20\t\r\n\f]+/g;function N(e){return e}function q(e){throw e}function L(e,t,n,r){var i;try{e&&v(i=e.promise)?i.call(e).done(t).fail(n):e&&v(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}ce.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},ce.each(e.match(D)||[],function(e,t){n[t]=!0}),n):ce.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){ce.each(e,function(e,t){v(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==x(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return ce.each(arguments,function(e,t){var n;while(-1<(n=ce.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<ce.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},ce.extend({Deferred:function(e){var o=[["notify","progress",ce.Callbacks("memory"),ce.Callbacks("memory"),2],["resolve","done",ce.Callbacks("once memory"),ce.Callbacks("once memory"),0,"resolved"],["reject","fail",ce.Callbacks("once memory"),ce.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return ce.Deferred(function(r){ce.each(o,function(e,t){var n=v(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&v(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,v(t)?s?t.call(e,l(u,o,N,s),l(u,o,q,s)):(u++,t.call(e,l(u,o,N,s),l(u,o,q,s),l(u,o,N,o.notifyWith))):(a!==N&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){ce.Deferred.exceptionHook&&ce.Deferred.exceptionHook(e,t.error),u<=i+1&&(a!==q&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(ce.Deferred.getErrorHook?t.error=ce.Deferred.getErrorHook():ce.Deferred.getStackHook&&(t.error=ce.Deferred.getStackHook()),ie.setTimeout(t))}}return ce.Deferred(function(e){o[0][3].add(l(0,e,v(r)?r:N,e.notifyWith)),o[1][3].add(l(0,e,v(t)?t:N)),o[2][3].add(l(0,e,v(n)?n:q))}).promise()},promise:function(e){return null!=e?ce.extend(e,a):a}},s={};return ce.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=ae.call(arguments),o=ce.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?ae.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(L(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||v(i[t]&&i[t].then)))return o.then();while(t--)L(i[t],a(t),o.reject);return o.promise()}});var H=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;ce.Deferred.exceptionHook=function(e,t){ie.console&&ie.console.warn&&e&&H.test(e.name)&&ie.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},ce.readyException=function(e){ie.setTimeout(function(){throw e})};var O=ce.Deferred();function P(){C.removeEventListener("DOMContentLoaded",P),ie.removeEventListener("load",P),ce.ready()}ce.fn.ready=function(e){return O.then(e)["catch"](function(e){ce.readyException(e)}),this},ce.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--ce.readyWait:ce.isReady)||(ce.isReady=!0)!==e&&0<--ce.readyWait||O.resolveWith(C,[ce])}}),ce.ready.then=O.then,"complete"===C.readyState||"loading"!==C.readyState&&!C.documentElement.doScroll?ie.setTimeout(ce.ready):(C.addEventListener("DOMContentLoaded",P),ie.addEventListener("load",P));var M=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===x(n))for(s in i=!0,n)M(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,v(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(ce(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},R=/^-ms-/,I=/-([a-z])/g;function W(e,t){return t.toUpperCase()}function F(e){return e.replace(R,"ms-").replace(I,W)}var $=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function B(){this.expando=ce.expando+B.uid++}B.uid=1,B.prototype={cache:function(e){var t=e[this.expando];return t||(t={},$(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[F(t)]=n;else for(r in t)i[F(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][F(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(F):(t=F(t))in r?[t]:t.match(D)||[]).length;while(n--)delete r[t[n]]}(void 0===t||ce.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!ce.isEmptyObject(t)}};var _=new B,z=new B,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,U=/[A-Z]/g;function V(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(U,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:X.test(i)?JSON.parse(i):i)}catch(e){}z.set(e,t,n)}else n=void 0;return n}ce.extend({hasData:function(e){return z.hasData(e)||_.hasData(e)},data:function(e,t,n){return z.access(e,t,n)},removeData:function(e,t){z.remove(e,t)},_data:function(e,t,n){return _.access(e,t,n)},_removeData:function(e,t){_.remove(e,t)}}),ce.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=z.get(o),1===o.nodeType&&!_.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=F(r.slice(5)),V(o,r,i[r]));_.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){z.set(this,n)}):M(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=z.get(o,n))?t:void 0!==(t=V(o,n))?t:void 0;this.each(function(){z.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){z.remove(this,e)})}}),ce.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=_.get(e,t),n&&(!r||Array.isArray(n)?r=_.access(e,t,ce.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=ce.queue(e,t),r=n.length,i=n.shift(),o=ce._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){ce.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return _.get(e,n)||_.access(e,n,{empty:ce.Callbacks("once memory").add(function(){_.remove(e,[t+"queue",n])})})}}),ce.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?ce.queue(this[0],t):void 0===n?this:this.each(function(){var e=ce.queue(this,t,n);ce._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&ce.dequeue(this,t)})},dequeue:function(e){return this.each(function(){ce.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=ce.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=_.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var G=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Y=new RegExp("^(?:([+-])=|)("+G+")([a-z%]*)$","i"),Q=["Top","Right","Bottom","Left"],J=C.documentElement,K=function(e){return ce.contains(e.ownerDocument,e)},Z={composed:!0};J.getRootNode&&(K=function(e){return ce.contains(e.ownerDocument,e)||e.getRootNode(Z)===e.ownerDocument});var ee=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&K(e)&&"none"===ce.css(e,"display")};function te(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return ce.css(e,t,"")},u=s(),l=n&&n[3]||(ce.cssNumber[t]?"":"px"),c=e.nodeType&&(ce.cssNumber[t]||"px"!==l&&+u)&&Y.exec(ce.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)ce.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,ce.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ne={};function re(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=_.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ee(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ne[s])||(o=a.body.appendChild(a.createElement(s)),u=ce.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ne[s]=u)))):"none"!==n&&(l[c]="none",_.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}ce.fn.extend({show:function(){return re(this,!0)},hide:function(){return re(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ee(this)?ce(this).show():ce(this).hide()})}});var xe,be,we=/^(?:checkbox|radio)$/i,Te=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Ce=/^$|^module$|\/(?:java|ecma)script/i;xe=C.createDocumentFragment().appendChild(C.createElement("div")),(be=C.createElement("input")).setAttribute("type","radio"),be.setAttribute("checked","checked"),be.setAttribute("name","t"),xe.appendChild(be),le.checkClone=xe.cloneNode(!0).cloneNode(!0).lastChild.checked,xe.innerHTML="<textarea>x</textarea>",le.noCloneChecked=!!xe.cloneNode(!0).lastChild.defaultValue,xe.innerHTML="<option></option>",le.option=!!xe.lastChild;var ke={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Se(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&fe(e,t)?ce.merge([e],n):n}function Ee(e,t){for(var n=0,r=e.length;n<r;n++)_.set(e[n],"globalEval",!t||_.get(t[n],"globalEval"))}ke.tbody=ke.tfoot=ke.colgroup=ke.caption=ke.thead,ke.th=ke.td,le.option||(ke.optgroup=ke.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===x(o))ce.merge(p,o.nodeType?[o]:o);else if(je.test(o)){a=a||f.appendChild(t.createElement("div")),s=(Te.exec(o)||["",""])[1].toLowerCase(),u=ke[s]||ke._default,a.innerHTML=u[1]+ce.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;ce.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<ce.inArray(o,r))i&&i.push(o);else if(l=K(o),a=Se(f.appendChild(o),"script"),l&&Ee(a),n){c=0;while(o=a[c++])Ce.test(o.type||"")&&n.push(o)}return f}var De=/^([^.]*)(?:\.(.+)|)/;function Ne(){return!0}function qe(){return!1}function Le(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Le(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=qe;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return ce().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=ce.guid++)),e.each(function(){ce.event.add(this,t,i,r,n)})}function He(e,r,t){t?(_.set(e,r,!1),ce.event.add(e,r,{namespace:!1,handler:function(e){var t,n=_.get(this,r);if(1&e.isTrigger&&this[r]){if(n)(ce.event.special[r]||{}).delegateType&&e.stopPropagation();else if(n=ae.call(arguments),_.set(this,r,n),this[r](),t=_.get(this,r),_.set(this,r,!1),n!==t)return e.stopImmediatePropagation(),e.preventDefault(),t}else n&&(_.set(this,r,ce.event.trigger(n[0],n.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Ne)}})):void 0===_.get(e,r)&&ce.event.add(e,r,Ne)}ce.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.get(t);if($(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&ce.find.matchesSelector(J,i),n.guid||(n.guid=ce.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof ce&&ce.event.triggered!==e.type?ce.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(D)||[""]).length;while(l--)d=g=(s=De.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=ce.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=ce.event.special[d]||{},c=ce.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&ce.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),ce.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.hasData(e)&&_.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(D)||[""]).length;while(l--)if(d=g=(s=De.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=ce.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||ce.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)ce.event.remove(e,d+t[l],n,r,!0);ce.isEmptyObject(u)&&_.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=ce.event.fix(e),l=(_.get(this,"events")||Object.create(null))[u.type]||[],c=ce.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=ce.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((ce.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<ce(i,this).index(l):ce.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(ce.Event.prototype,t,{enumerable:!0,configurable:!0,get:v(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[ce.expando]?e:new ce.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click",!0),!1},trigger:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click"),!0},_default:function(e){var t=e.target;return we.test(t.type)&&t.click&&fe(t,"input")&&_.get(t,"click")||fe(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},ce.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},ce.Event=function(e,t){if(!(this instanceof ce.Event))return new ce.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ne:qe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&ce.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[ce.expando]=!0},ce.Event.prototype={constructor:ce.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ne,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ne,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ne,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},ce.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},ce.event.addProp),ce.each({focus:"focusin",blur:"focusout"},function(r,i){function o(e){if(C.documentMode){var t=_.get(this,"handle"),n=ce.event.fix(e);n.type="focusin"===e.type?"focus":"blur",n.isSimulated=!0,t(e),n.target===n.currentTarget&&t(n)}else ce.event.simulate(i,e.target,ce.event.fix(e))}ce.event.special[r]={setup:function(){var e;if(He(this,r,!0),!C.documentMode)return!1;(e=_.get(this,i))||this.addEventListener(i,o),_.set(this,i,(e||0)+1)},trigger:function(){return He(this,r),!0},teardown:function(){var e;if(!C.documentMode)return!1;(e=_.get(this,i)-1)?_.set(this,i,e):(this.removeEventListener(i,o),_.remove(this,i))},_default:function(e){return _.get(e.target,r)},delegateType:i},ce.event.special[i]={setup:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i);n||(C.documentMode?this.addEventListener(i,o):e.addEventListener(r,o,!0)),_.set(t,i,(n||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i)-1;n?_.set(t,i,n):(C.documentMode?this.removeEventListener(i,o):e.removeEventListener(r,o,!0),_.remove(t,i))}}}),ce.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){ce.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||ce.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),ce.fn.extend({on:function(e,t,n,r){return Le(this,e,t,n,r)},one:function(e,t,n,r){return Le(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,ce(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=qe),this.each(function(){ce.event.remove(this,e,n,t)})}});var Oe=/<script|<style|<link/i,Pe=/checked\s*(?:[^=]|=\s*.checked.)/i,Me=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Re(e,t){return fe(e,"table")&&fe(11!==t.nodeType?t:t.firstChild,"tr")&&ce(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function We(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Fe(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(_.hasData(e)&&(s=_.get(e).events))for(i in _.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)ce.event.add(t,i,s[i][n]);z.hasData(e)&&(o=z.access(e),a=ce.extend({},o),z.set(t,a))}}function $e(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=v(d);if(h||1<f&&"string"==typeof d&&!le.checkClone&&Pe.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),$e(t,r,i,o)});if(f&&(t=(e=Ae(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=ce.map(Se(e,"script"),Ie)).length;c<f;c++)u=e,c!==p&&(u=ce.clone(u,!0,!0),s&&ce.merge(a,Se(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,ce.map(a,We),c=0;c<s;c++)u=a[c],Ce.test(u.type||"")&&!_.access(u,"globalEval")&&ce.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?ce._evalUrl&&!u.noModule&&ce._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):m(u.textContent.replace(Me,""),u,l))}return n}function Be(e,t,n){for(var r,i=t?ce.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||ce.cleanData(Se(r)),r.parentNode&&(n&&K(r)&&Ee(Se(r,"script")),r.parentNode.removeChild(r));return e}ce.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=K(e);if(!(le.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||ce.isXMLDoc(e)))for(a=Se(c),r=0,i=(o=Se(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&we.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||Se(e),a=a||Se(c),r=0,i=o.length;r<i;r++)Fe(o[r],a[r]);else Fe(e,c);return 0<(a=Se(c,"script")).length&&Ee(a,!f&&Se(e,"script")),c},cleanData:function(e){for(var t,n,r,i=ce.event.special,o=0;void 0!==(n=e[o]);o++)if($(n)){if(t=n[_.expando]){if(t.events)for(r in t.events)i[r]?ce.event.remove(n,r):ce.removeEvent(n,r,t.handle);n[_.expando]=void 0}n[z.expando]&&(n[z.expando]=void 0)}}}),ce.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return M(this,function(e){return void 0===e?ce.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return $e(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Re(this,e).appendChild(e)})},prepend:function(){return $e(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Re(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(ce.cleanData(Se(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return ce.clone(this,e,t)})},html:function(e){return M(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Oe.test(e)&&!ke[(Te.exec(e)||["",""])[1].toLowerCase()]){e=ce.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(ce.cleanData(Se(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return $e(this,arguments,function(e){var t=this.parentNode;ce.inArray(this,n)<0&&(ce.cleanData(Se(this)),t&&t.replaceChild(e,this))},n)}}),ce.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){ce.fn[e]=function(e){for(var t,n=[],r=ce(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),ce(r[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var _e=new RegExp("^("+G+")(?!px)[a-z%]+$","i"),ze=/^--/,Xe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=ie),t.getComputedStyle(e)},Ue=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ve=new RegExp(Q.join("|"),"i");function Ge(e,t,n){var r,i,o,a,s=ze.test(t),u=e.style;return(n=n||Xe(e))&&(a=n.getPropertyValue(t)||n[t],s&&a&&(a=a.replace(ve,"$1")||void 0),""!==a||K(e)||(a=ce.style(e,t)),!le.pixelBoxStyles()&&_e.test(a)&&Ve.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function Ye(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",J.appendChild(u).appendChild(l);var e=ie.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),J.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=C.createElement("div"),l=C.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",le.clearCloneStyle="content-box"===l.style.backgroundClip,ce.extend(le,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=C.createElement("table"),t=C.createElement("tr"),n=C.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="box-sizing:content-box;border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",J.appendChild(e).appendChild(t).appendChild(n),r=ie.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,J.removeChild(e)),a}}))}();var Qe=["Webkit","Moz","ms"],Je=C.createElement("div").style,Ke={};function Ze(e){var t=ce.cssProps[e]||Ke[e];return t||(e in Je?e:Ke[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;while(n--)if((e=Qe[n]+t)in Je)return e}(e)||e)}var et=/^(none|table(?!-c[ea]).+)/,tt={position:"absolute",visibility:"hidden",display:"block"},nt={letterSpacing:"0",fontWeight:"400"};function rt(e,t,n){var r=Y.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0,l=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(l+=ce.css(e,n+Q[a],!0,i)),r?("content"===n&&(u-=ce.css(e,"padding"+Q[a],!0,i)),"margin"!==n&&(u-=ce.css(e,"border"+Q[a]+"Width",!0,i))):(u+=ce.css(e,"padding"+Q[a],!0,i),"padding"!==n?u+=ce.css(e,"border"+Q[a]+"Width",!0,i):s+=ce.css(e,"border"+Q[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u+l}function ot(e,t,n){var r=Xe(e),i=(!le.boxSizingReliable()||n)&&"border-box"===ce.css(e,"boxSizing",!1,r),o=i,a=Ge(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(_e.test(a)){if(!n)return a;a="auto"}return(!le.boxSizingReliable()&&i||!le.reliableTrDimensions()&&fe(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===ce.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===ce.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+it(e,t,n||(i?"border":"content"),o,r,a)+"px"}function at(e,t,n,r,i){return new at.prototype.init(e,t,n,r,i)}ce.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ge(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=F(t),u=ze.test(t),l=e.style;if(u||(t=Ze(s)),a=ce.cssHooks[t]||ce.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=Y.exec(n))&&i[1]&&(n=te(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(ce.cssNumber[s]?"":"px")),le.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=F(t);return ze.test(t)||(t=Ze(s)),(a=ce.cssHooks[t]||ce.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ge(e,t,r)),"normal"===i&&t in nt&&(i=nt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),ce.each(["height","width"],function(e,u){ce.cssHooks[u]={get:function(e,t,n){if(t)return!et.test(ce.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ot(e,u,n):Ue(e,tt,function(){return ot(e,u,n)})},set:function(e,t,n){var r,i=Xe(e),o=!le.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===ce.css(e,"boxSizing",!1,i),s=n?it(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-it(e,u,"border",!1,i)-.5)),s&&(r=Y.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=ce.css(e,u)),rt(0,t,s)}}}),ce.cssHooks.marginLeft=Ye(le.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ge(e,"marginLeft"))||e.getBoundingClientRect().left-Ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),ce.each({margin:"",padding:"",border:"Width"},function(i,o){ce.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+Q[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(ce.cssHooks[i+o].set=rt)}),ce.fn.extend({css:function(e,t){return M(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Xe(e),i=t.length;a<i;a++)o[t[a]]=ce.css(e,t[a],!1,r);return o}return void 0!==n?ce.style(e,t,n):ce.css(e,t)},e,t,1<arguments.length)}}),((ce.Tween=at).prototype={constructor:at,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||ce.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(ce.cssNumber[n]?"":"px")},cur:function(){var e=at.propHooks[this.prop];return e&&e.get?e.get(this):at.propHooks._default.get(this)},run:function(e){var t,n=at.propHooks[this.prop];return this.options.duration?this.pos=t=ce.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):at.propHooks._default.set(this),this}}).init.prototype=at.prototype,(at.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=ce.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){ce.fx.step[e.prop]?ce.fx.step[e.prop](e):1!==e.elem.nodeType||!ce.cssHooks[e.prop]&&null==e.elem.style[Ze(e.prop)]?e.elem[e.prop]=e.now:ce.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=at.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},ce.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},ce.fx=at.prototype.init,ce.fx.step={};var st,ut,lt,ct,ft=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function dt(){ut&&(!1===C.hidden&&ie.requestAnimationFrame?ie.requestAnimationFrame(dt):ie.setTimeout(dt,ce.fx.interval),ce.fx.tick())}function ht(){return ie.setTimeout(function(){st=void 0}),st=Date.now()}function gt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=Q[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function vt(e,t,n){for(var r,i=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function yt(o,e,t){var n,a,r=0,i=yt.prefilters.length,s=ce.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=st||ht(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:ce.extend({},e),opts:ce.extend(!0,{specialEasing:{},easing:ce.easing._default},t),originalProperties:e,originalOptions:t,startTime:st||ht(),duration:t.duration,tweens:[],createTween:function(e,t){var n=ce.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=F(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=ce.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=yt.prefilters[r].call(l,o,c,l.opts))return v(n.stop)&&(ce._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return ce.map(c,vt,l),v(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),ce.fx.timer(ce.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}ce.Animation=ce.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return te(n.elem,e,Y.exec(t),n),n}]},tweener:function(e,t){v(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ee(e),v=_.get(e,"fxshow");for(r in n.queue||(null==(a=ce._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,ce.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ft.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||ce.style(e,r)}if((u=!ce.isEmptyObject(t))||!ce.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=_.get(e,"display")),"none"===(c=ce.css(e,"display"))&&(l?c=l:(re([e],!0),l=e.style.display||l,c=ce.css(e,"display"),re([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===ce.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=_.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&re([e],!0),p.done(function(){for(r in g||re([e]),_.remove(e,"fxshow"),d)ce.style(e,r,d[r])})),u=vt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),ce.speed=function(e,t,n){var r=e&&"object"==typeof e?ce.extend({},e):{complete:n||!n&&t||v(e)&&e,duration:e,easing:n&&t||t&&!v(t)&&t};return ce.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in ce.fx.speeds?r.duration=ce.fx.speeds[r.duration]:r.duration=ce.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){v(r.old)&&r.old.call(this),r.queue&&ce.dequeue(this,r.queue)},r},ce.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ee).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=ce.isEmptyObject(t),o=ce.speed(e,n,r),a=function(){var e=yt(this,ce.extend({},t),o);(i||_.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=ce.timers,r=_.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&pt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||ce.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=_.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=ce.timers,o=n?n.length:0;for(t.finish=!0,ce.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),ce.each(["toggle","show","hide"],function(e,r){var i=ce.fn[r];ce.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(gt(r,!0),e,t,n)}}),ce.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){ce.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),ce.timers=[],ce.fx.tick=function(){var e,t=0,n=ce.timers;for(st=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||ce.fx.stop(),st=void 0},ce.fx.timer=function(e){ce.timers.push(e),ce.fx.start()},ce.fx.interval=13,ce.fx.start=function(){ut||(ut=!0,dt())},ce.fx.stop=function(){ut=null},ce.fx.speeds={slow:600,fast:200,_default:400},ce.fn.delay=function(r,e){return r=ce.fx&&ce.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=ie.setTimeout(e,r);t.stop=function(){ie.clearTimeout(n)}})},lt=C.createElement("input"),ct=C.createElement("select").appendChild(C.createElement("option")),lt.type="checkbox",le.checkOn=""!==lt.value,le.optSelected=ct.selected,(lt=C.createElement("input")).value="t",lt.type="radio",le.radioValue="t"===lt.value;var mt,xt=ce.expr.attrHandle;ce.fn.extend({attr:function(e,t){return M(this,ce.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){ce.removeAttr(this,e)})}}),ce.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?ce.prop(e,t,n):(1===o&&ce.isXMLDoc(e)||(i=ce.attrHooks[t.toLowerCase()]||(ce.expr.match.bool.test(t)?mt:void 0)),void 0!==n?null===n?void ce.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=ce.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!le.radioValue&&"radio"===t&&fe(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),mt={set:function(e,t,n){return!1===t?ce.removeAttr(e,n):e.setAttribute(n,n),n}},ce.each(ce.expr.match.bool.source.match(/\w+/g),function(e,t){var a=xt[t]||ce.find.attr;xt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=xt[o],xt[o]=r,r=null!=a(e,t,n)?o:null,xt[o]=i),r}});var bt=/^(?:input|select|textarea|button)$/i,wt=/^(?:a|area)$/i;function Tt(e){return(e.match(D)||[]).join(" ")}function Ct(e){return e.getAttribute&&e.getAttribute("class")||""}function kt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}ce.fn.extend({prop:function(e,t){return M(this,ce.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[ce.propFix[e]||e]})}}),ce.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&ce.isXMLDoc(e)||(t=ce.propFix[t]||t,i=ce.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=ce.find.attr(e,"tabindex");return t?parseInt(t,10):bt.test(e.nodeName)||wt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),le.optSelected||(ce.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),ce.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){ce.propFix[this.toLowerCase()]=this}),ce.fn.extend({addClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).addClass(t.call(this,e,Ct(this)))}):(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).removeClass(t.call(this,e,Ct(this)))}):arguments.length?(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return v(t)?this.each(function(e){ce(this).toggleClass(t.call(this,e,Ct(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=kt(t),this.each(function(){if(s)for(o=ce(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=Ct(this))&&_.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":_.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+Tt(Ct(n))+" ").indexOf(t))return!0;return!1}});var St=/\r/g;ce.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=v(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,ce(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=ce.map(t,function(e){return null==e?"":e+""})),(r=ce.valHooks[this.type]||ce.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=ce.valHooks[t.type]||ce.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(St,""):null==e?"":e:void 0}}),ce.extend({valHooks:{option:{get:function(e){var t=ce.find.attr(e,"value");return null!=t?t:Tt(ce.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!fe(n.parentNode,"optgroup"))){if(t=ce(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=ce.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<ce.inArray(ce.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),ce.each(["radio","checkbox"],function(){ce.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<ce.inArray(ce(e).val(),t)}},le.checkOn||(ce.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Et=ie.location,jt={guid:Date.now()},At=/\?/;ce.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new ie.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||ce.error("Invalid XML: "+(n?ce.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Dt=/^(?:focusinfocus|focusoutblur)$/,Nt=function(e){e.stopPropagation()};ce.extend(ce.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||C],d=ue.call(e,"type")?e.type:e,h=ue.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||C,3!==n.nodeType&&8!==n.nodeType&&!Dt.test(d+ce.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[ce.expando]?e:new ce.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:ce.makeArray(t,[e]),c=ce.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!y(n)){for(s=c.delegateType||d,Dt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||C)&&p.push(a.defaultView||a.parentWindow||ie)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(_.get(o,"events")||Object.create(null))[e.type]&&_.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&$(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!$(n)||u&&v(n[d])&&!y(n)&&((a=n[u])&&(n[u]=null),ce.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Nt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Nt),ce.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=ce.extend(new ce.Event,n,{type:e,isSimulated:!0});ce.event.trigger(r,null,t)}}),ce.fn.extend({trigger:function(e,t){return this.each(function(){ce.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return ce.event.trigger(e,t,n,!0)}});var qt=/\[\]$/,Lt=/\r?\n/g,Ht=/^(?:submit|button|image|reset|file)$/i,Ot=/^(?:input|select|textarea|keygen)/i;function Pt(n,e,r,i){var t;if(Array.isArray(e))ce.each(e,function(e,t){r||qt.test(n)?i(n,t):Pt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==x(e))i(n,e);else for(t in e)Pt(n+"["+t+"]",e[t],r,i)}ce.param=function(e,t){var n,r=[],i=function(e,t){var n=v(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!ce.isPlainObject(e))ce.each(e,function(){i(this.name,this.value)});else for(n in e)Pt(n,e[n],t,i);return r.join("&")},ce.fn.extend({serialize:function(){return ce.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=ce.prop(this,"elements");return e?ce.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!ce(this).is(":disabled")&&Ot.test(this.nodeName)&&!Ht.test(e)&&(this.checked||!we.test(e))}).map(function(e,t){var n=ce(this).val();return null==n?null:Array.isArray(n)?ce.map(n,function(e){return{name:t.name,value:e.replace(Lt,"\r\n")}}):{name:t.name,value:n.replace(Lt,"\r\n")}}).get()}});var Mt=/%20/g,Rt=/#.*$/,It=/([?&])_=[^&]*/,Wt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ft=/^(?:GET|HEAD)$/,$t=/^\/\//,Bt={},_t={},zt="*/".concat("*"),Xt=C.createElement("a");function Ut(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(D)||[];if(v(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Vt(t,i,o,a){var s={},u=t===_t;function l(e){var r;return s[e]=!0,ce.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Gt(e,t){var n,r,i=ce.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&ce.extend(!0,e,r),e}Xt.href=Et.href,ce.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":zt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":ce.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Gt(Gt(e,ce.ajaxSettings),t):Gt(ce.ajaxSettings,e)},ajaxPrefilter:Ut(Bt),ajaxTransport:Ut(_t),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=ce.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?ce(y):ce.event,x=ce.Deferred(),b=ce.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Wt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace($t,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(D)||[""],null==v.crossDomain){r=C.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Xt.protocol+"//"+Xt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=ce.param(v.data,v.traditional)),Vt(Bt,v,t,T),h)return T;for(i in(g=ce.event&&v.global)&&0==ce.active++&&ce.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Ft.test(v.type),f=v.url.replace(Rt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Mt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(At.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(It,"$1"),o=(At.test(f)?"&":"?")+"_="+jt.guid+++o),v.url=f+o),v.ifModified&&(ce.lastModified[f]&&T.setRequestHeader("If-Modified-Since",ce.lastModified[f]),ce.etag[f]&&T.setRequestHeader("If-None-Match",ce.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+zt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Vt(_t,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=ie.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&ie.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<ce.inArray("script",v.dataTypes)&&ce.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(ce.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(ce.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--ce.active||ce.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return ce.get(e,t,n,"json")},getScript:function(e,t){return ce.get(e,void 0,t,"script")}}),ce.each(["get","post"],function(e,i){ce[i]=function(e,t,n,r){return v(t)&&(r=r||n,n=t,t=void 0),ce.ajax(ce.extend({url:e,type:i,dataType:r,data:t,success:n},ce.isPlainObject(e)&&e))}}),ce.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),ce._evalUrl=function(e,t,n){return ce.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){ce.globalEval(e,t,n)}})},ce.fn.extend({wrapAll:function(e){var t;return this[0]&&(v(e)&&(e=e.call(this[0])),t=ce(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return v(n)?this.each(function(e){ce(this).wrapInner(n.call(this,e))}):this.each(function(){var e=ce(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=v(t);return this.each(function(e){ce(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){ce(this).replaceWith(this.childNodes)}),this}}),ce.expr.pseudos.hidden=function(e){return!ce.expr.pseudos.visible(e)},ce.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},ce.ajaxSettings.xhr=function(){try{return new ie.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Qt=ce.ajaxSettings.xhr();le.cors=!!Qt&&"withCredentials"in Qt,le.ajax=Qt=!!Qt,ce.ajaxTransport(function(i){var o,a;if(le.cors||Qt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Yt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&ie.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),ce.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),ce.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return ce.globalEval(e),e}}}),ce.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),ce.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=ce("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),C.head.appendChild(r[0])},abort:function(){i&&i()}}});var Jt,Kt=[],Zt=/(=)\?(?=&|$)|\?\?/;ce.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||ce.expando+"_"+jt.guid++;return this[e]=!0,e}}),ce.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Zt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=v(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Zt,"$1"+r):!1!==e.jsonp&&(e.url+=(At.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||ce.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=ie[r],ie[r]=function(){o=arguments},n.always(function(){void 0===i?ce(ie).removeProp(r):ie[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Kt.push(r)),o&&v(i)&&i(o[0]),o=i=void 0}),"script"}),le.createHTMLDocument=((Jt=C.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Jt.childNodes.length),ce.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(le.createHTMLDocument?((r=(t=C.implementation.createHTMLDocument("")).createElement("base")).href=C.location.href,t.head.appendChild(r)):t=C),o=!n&&[],(i=w.exec(e))?[t.createElement(i[1])]:(i=Ae([e],t,o),o&&o.length&&ce(o).remove(),ce.merge([],i.childNodes)));var r,i,o},ce.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Tt(e.slice(s)),e=e.slice(0,s)),v(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&ce.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?ce("<div>").append(ce.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},ce.expr.pseudos.animated=function(t){return ce.grep(ce.timers,function(e){return t===e.elem}).length},ce.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=ce.css(e,"position"),c=ce(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=ce.css(e,"top"),u=ce.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),v(t)&&(t=t.call(e,n,ce.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},ce.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){ce.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===ce.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===ce.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=ce(e).offset()).top+=ce.css(e,"borderTopWidth",!0),i.left+=ce.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-ce.css(r,"marginTop",!0),left:t.left-i.left-ce.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===ce.css(e,"position"))e=e.offsetParent;return e||J})}}),ce.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;ce.fn[t]=function(e){return M(this,function(e,t,n){var r;if(y(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),ce.each(["top","left"],function(e,n){ce.cssHooks[n]=Ye(le.pixelPosition,function(e,t){if(t)return t=Ge(e,n),_e.test(t)?ce(e).position()[n]+"px":t})}),ce.each({Height:"height",Width:"width"},function(a,s){ce.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){ce.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return M(this,function(e,t,n){var r;return y(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?ce.css(e,t,i):ce.style(e,t,n,i)},s,n?e:void 0,n)}})}),ce.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){ce.fn[t]=function(e){return this.on(t,e)}}),ce.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),ce.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){ce.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;ce.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),v(e))return r=ae.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(ae.call(arguments)))}).guid=e.guid=e.guid||ce.guid++,i},ce.holdReady=function(e){e?ce.readyWait++:ce.ready(!0)},ce.isArray=Array.isArray,ce.parseJSON=JSON.parse,ce.nodeName=fe,ce.isFunction=v,ce.isWindow=y,ce.camelCase=F,ce.type=x,ce.now=Date.now,ce.isNumeric=function(e){var t=ce.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},ce.trim=function(e){return null==e?"":(e+"").replace(en,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return ce});var tn=ie.jQuery,nn=ie.$;return ce.noConflict=function(e){return ie.$===ce&&(ie.$=nn),e&&ie.jQuery===ce&&(ie.jQuery=tn),ce},"undefined"==typeof e&&(ie.jQuery=ie.$=ce),ce});
var mg$ = $.noConflict(true);
if (hostJquery) {
	jQuery = hostJquery;
	$ = host$;
}
!function(t){var i=t(window);t.fn.visible=function(t,e,o){if(!(this.length<1)){var r=this.length>1?this.eq(0):this,n=r.get(0),f=i.width(),h=i.height(),o=o?o:"both",l=e===!0?n.offsetWidth*n.offsetHeight:!0;if("function"==typeof n.getBoundingClientRect){var g=n.getBoundingClientRect(),u=g.top>=0&&g.top<h,s=g.bottom>0&&g.bottom<=h,c=g.left>=0&&g.left<f,a=g.right>0&&g.right<=f,v=t?u||s:u&&s,b=t?c||a:c&&a;if("both"===o)return l&&v&&b;if("vertical"===o)return l&&v;if("horizontal"===o)return l&&b}else{var d=i.scrollTop(),p=d+h,w=i.scrollLeft(),m=w+f,y=r.offset(),z=y.top,B=z+r.height(),C=y.left,R=C+r.width(),j=t===!0?B:z,q=t===!0?z:B,H=t===!0?R:C,L=t===!0?C:R;if("both"===o)return!!l&&p>=q&&j>=d&&m>=L&&H>=w;if("vertical"===o)return!!l&&p>=q&&j>=d;if("horizontal"===o)return!!l&&m>=L&&H>=w}}}}(mg$);

/*
 * JavaScript MD5
 * https://github.com/blueimp/JavaScript-MD5
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 *
 * Based on
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

/* global define */

(function ($) {
  'use strict'

  /*
  * Add integers, wrapping at 2^32. This uses 16-bit operations internally
  * to work around bugs in some JS interpreters.
  */
  function safeAdd (x, y) {
    var lsw = (x & 0xffff) + (y & 0xffff)
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16)
    return (msw << 16) | (lsw & 0xffff)
  }

  /*
  * Bitwise rotate a 32-bit number to the left.
  */
  function bitRotateLeft (num, cnt) {
    return (num << cnt) | (num >>> (32 - cnt))
  }

  /*
  * These functions implement the four basic operations the algorithm uses.
  */
  function md5cmn (q, a, b, x, s, t) {
    return safeAdd(bitRotateLeft(safeAdd(safeAdd(a, q), safeAdd(x, t)), s), b)
  }
  function md5ff (a, b, c, d, x, s, t) {
    return md5cmn((b & c) | (~b & d), a, b, x, s, t)
  }
  function md5gg (a, b, c, d, x, s, t) {
    return md5cmn((b & d) | (c & ~d), a, b, x, s, t)
  }
  function md5hh (a, b, c, d, x, s, t) {
    return md5cmn(b ^ c ^ d, a, b, x, s, t)
  }
  function md5ii (a, b, c, d, x, s, t) {
    return md5cmn(c ^ (b | ~d), a, b, x, s, t)
  }

  /*
  * Calculate the MD5 of an array of little-endian words, and a bit length.
  */
  function binlMD5 (x, len) {
    /* append padding */
    x[len >> 5] |= 0x80 << (len % 32)
    x[((len + 64) >>> 9 << 4) + 14] = len

    var i
    var olda
    var oldb
    var oldc
    var oldd
    var a = 1732584193
    var b = -271733879
    var c = -1732584194
    var d = 271733878

    for (i = 0; i < x.length; i += 16) {
      olda = a
      oldb = b
      oldc = c
      oldd = d

      a = md5ff(a, b, c, d, x[i], 7, -680876936)
      d = md5ff(d, a, b, c, x[i + 1], 12, -389564586)
      c = md5ff(c, d, a, b, x[i + 2], 17, 606105819)
      b = md5ff(b, c, d, a, x[i + 3], 22, -1044525330)
      a = md5ff(a, b, c, d, x[i + 4], 7, -176418897)
      d = md5ff(d, a, b, c, x[i + 5], 12, 1200080426)
      c = md5ff(c, d, a, b, x[i + 6], 17, -1473231341)
      b = md5ff(b, c, d, a, x[i + 7], 22, -45705983)
      a = md5ff(a, b, c, d, x[i + 8], 7, 1770035416)
      d = md5ff(d, a, b, c, x[i + 9], 12, -1958414417)
      c = md5ff(c, d, a, b, x[i + 10], 17, -42063)
      b = md5ff(b, c, d, a, x[i + 11], 22, -1990404162)
      a = md5ff(a, b, c, d, x[i + 12], 7, 1804603682)
      d = md5ff(d, a, b, c, x[i + 13], 12, -40341101)
      c = md5ff(c, d, a, b, x[i + 14], 17, -1502002290)
      b = md5ff(b, c, d, a, x[i + 15], 22, 1236535329)

      a = md5gg(a, b, c, d, x[i + 1], 5, -165796510)
      d = md5gg(d, a, b, c, x[i + 6], 9, -1069501632)
      c = md5gg(c, d, a, b, x[i + 11], 14, 643717713)
      b = md5gg(b, c, d, a, x[i], 20, -373897302)
      a = md5gg(a, b, c, d, x[i + 5], 5, -701558691)
      d = md5gg(d, a, b, c, x[i + 10], 9, 38016083)
      c = md5gg(c, d, a, b, x[i + 15], 14, -660478335)
      b = md5gg(b, c, d, a, x[i + 4], 20, -405537848)
      a = md5gg(a, b, c, d, x[i + 9], 5, 568446438)
      d = md5gg(d, a, b, c, x[i + 14], 9, -1019803690)
      c = md5gg(c, d, a, b, x[i + 3], 14, -187363961)
      b = md5gg(b, c, d, a, x[i + 8], 20, 1163531501)
      a = md5gg(a, b, c, d, x[i + 13], 5, -1444681467)
      d = md5gg(d, a, b, c, x[i + 2], 9, -51403784)
      c = md5gg(c, d, a, b, x[i + 7], 14, 1735328473)
      b = md5gg(b, c, d, a, x[i + 12], 20, -1926607734)

      a = md5hh(a, b, c, d, x[i + 5], 4, -378558)
      d = md5hh(d, a, b, c, x[i + 8], 11, -2022574463)
      c = md5hh(c, d, a, b, x[i + 11], 16, 1839030562)
      b = md5hh(b, c, d, a, x[i + 14], 23, -35309556)
      a = md5hh(a, b, c, d, x[i + 1], 4, -1530992060)
      d = md5hh(d, a, b, c, x[i + 4], 11, 1272893353)
      c = md5hh(c, d, a, b, x[i + 7], 16, -155497632)
      b = md5hh(b, c, d, a, x[i + 10], 23, -1094730640)
      a = md5hh(a, b, c, d, x[i + 13], 4, 681279174)
      d = md5hh(d, a, b, c, x[i], 11, -358537222)
      c = md5hh(c, d, a, b, x[i + 3], 16, -722521979)
      b = md5hh(b, c, d, a, x[i + 6], 23, 76029189)
      a = md5hh(a, b, c, d, x[i + 9], 4, -640364487)
      d = md5hh(d, a, b, c, x[i + 12], 11, -421815835)
      c = md5hh(c, d, a, b, x[i + 15], 16, 530742520)
      b = md5hh(b, c, d, a, x[i + 2], 23, -995338651)

      a = md5ii(a, b, c, d, x[i], 6, -198630844)
      d = md5ii(d, a, b, c, x[i + 7], 10, 1126891415)
      c = md5ii(c, d, a, b, x[i + 14], 15, -1416354905)
      b = md5ii(b, c, d, a, x[i + 5], 21, -57434055)
      a = md5ii(a, b, c, d, x[i + 12], 6, 1700485571)
      d = md5ii(d, a, b, c, x[i + 3], 10, -1894986606)
      c = md5ii(c, d, a, b, x[i + 10], 15, -1051523)
      b = md5ii(b, c, d, a, x[i + 1], 21, -2054922799)
      a = md5ii(a, b, c, d, x[i + 8], 6, 1873313359)
      d = md5ii(d, a, b, c, x[i + 15], 10, -30611744)
      c = md5ii(c, d, a, b, x[i + 6], 15, -1560198380)
      b = md5ii(b, c, d, a, x[i + 13], 21, 1309151649)
      a = md5ii(a, b, c, d, x[i + 4], 6, -145523070)
      d = md5ii(d, a, b, c, x[i + 11], 10, -1120210379)
      c = md5ii(c, d, a, b, x[i + 2], 15, 718787259)
      b = md5ii(b, c, d, a, x[i + 9], 21, -343485551)

      a = safeAdd(a, olda)
      b = safeAdd(b, oldb)
      c = safeAdd(c, oldc)
      d = safeAdd(d, oldd)
    }
    return [a, b, c, d]
  }

  /*
  * Convert an array of little-endian words to a string
  */
  function binl2rstr (input) {
    var i;
    var output = '';
    var length32 = input.length * 32;
    for (i = 0; i < length32; i += 8) {
      output += String.fromCharCode((input[i >> 5] >>> (i % 32)) & 0xff);
    }
    return output;
  }

  /*
  * Convert a raw string to an array of little-endian words
  * Characters >255 have their high-byte silently ignored.
  */
  function rstr2binl (input) {
    var i
    var output = []
    output[(input.length >> 2) - 1] = undefined
    for (i = 0; i < output.length; i += 1) {
      output[i] = 0
    }
    var length8 = input.length * 8
    for (i = 0; i < length8; i += 8) {
      output[i >> 5] |= (input.charCodeAt(i / 8) & 0xff) << (i % 32)
    }
    return output
  }

  /*
  * Calculate the MD5 of a raw string
  */
  function rstrMD5 (s) {
    return binl2rstr(binlMD5(rstr2binl(s), s.length * 8))
  }

  /*
  * Calculate the HMAC-MD5, of a key and some data (raw strings)
  */
  function rstrHMACMD5 (key, data) {
    var i
    var bkey = rstr2binl(key)
    var ipad = []
    var opad = []
    var hash
    ipad[15] = opad[15] = undefined
    if (bkey.length > 16) {
      bkey = binlMD5(bkey, key.length * 8)
    }
    for (i = 0; i < 16; i += 1) {
      ipad[i] = bkey[i] ^ 0x36363636
      opad[i] = bkey[i] ^ 0x5c5c5c5c
    }
    hash = binlMD5(ipad.concat(rstr2binl(data)), 512 + data.length * 8)
    return binl2rstr(binlMD5(opad.concat(hash), 512 + 128))
  }

  /*
  * Convert a raw string to a hex string
  */
  function rstr2hex (input) {
    var hexTab = '0123456789abcdef'
    var output = ''
    var x
    var i
    for (i = 0; i < input.length; i += 1) {
      x = input.charCodeAt(i)
      output += hexTab.charAt((x >>> 4) & 0x0f) + hexTab.charAt(x & 0x0f)
    }
    return output
  }

  /*
  * Encode a string as utf-8
  */
  function str2rstrUTF8 (input) {
    return unescape(encodeURIComponent(input))
  }

  /*
  * Take string arguments and return either raw or hex encoded strings
  */
  function rawMD5 (s) {
    return rstrMD5(str2rstrUTF8(s))
  }
  function hexMD5 (s) {
    return rstr2hex(rawMD5(s))
  }
  function rawHMACMD5 (k, d) {
    return rstrHMACMD5(str2rstrUTF8(k), str2rstrUTF8(d))
  }
  function hexHMACMD5 (k, d) {
    return rstr2hex(rawHMACMD5(k, d))
  }

  function md5 (string, key, raw) {
    if (!key) {
      if (!raw) {
        return hexMD5(string)
      }
      return rawMD5(string)
    }
    if (!raw) {
      return hexHMACMD5(key, string)
    }
    return rawHMACMD5(key, string)
  }

  if (typeof define === 'function' && define.amd) {
    define(function () {
      return md5
    })
  } else if (typeof module === 'object' && module.exports) {
    module.exports = md5
  } else {
    $.md5 = md5
  }
})(this);


function SHA256(s){
    var chrsz = 8;
    var hexcase = 0;
   
    function safe_add (x, y) {
    var lsw = (x & 0xFFFF) + (y & 0xFFFF);
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
    return (msw << 16) | (lsw & 0xFFFF);
    }
   
    function S (X, n) { return ( X >>> n ) | (X << (32 - n)); }
    function R (X, n) { return ( X >>> n ); }
    function Ch(x, y, z) { return ((x & y) ^ ((~x) & z)); }
    function Maj(x, y, z) { return ((x & y) ^ (x & z) ^ (y & z)); }
    function Sigma0256(x) { return (S(x, 2) ^ S(x, 13) ^ S(x, 22)); }
    function Sigma1256(x) { return (S(x, 6) ^ S(x, 11) ^ S(x, 25)); }
    function Gamma0256(x) { return (S(x, 7) ^ S(x, 18) ^ R(x, 3)); }
    function Gamma1256(x) { return (S(x, 17) ^ S(x, 19) ^ R(x, 10)); }
   
    function core_sha256 (m, l) {
    var K = new Array(0x428A2F98, 0x71374491, 0xB5C0FBCF, 0xE9B5DBA5, 0x3956C25B, 0x59F111F1, 0x923F82A4, 0xAB1C5ED5, 0xD807AA98, 0x12835B01, 0x243185BE, 0x550C7DC3, 0x72BE5D74, 0x80DEB1FE, 0x9BDC06A7, 0xC19BF174, 0xE49B69C1, 0xEFBE4786, 0xFC19DC6, 0x240CA1CC, 0x2DE92C6F, 0x4A7484AA, 0x5CB0A9DC, 0x76F988DA, 0x983E5152, 0xA831C66D, 0xB00327C8, 0xBF597FC7, 0xC6E00BF3, 0xD5A79147, 0x6CA6351, 0x14292967, 0x27B70A85, 0x2E1B2138, 0x4D2C6DFC, 0x53380D13, 0x650A7354, 0x766A0ABB, 0x81C2C92E, 0x92722C85, 0xA2BFE8A1, 0xA81A664B, 0xC24B8B70, 0xC76C51A3, 0xD192E819, 0xD6990624, 0xF40E3585, 0x106AA070, 0x19A4C116, 0x1E376C08, 0x2748774C, 0x34B0BCB5, 0x391C0CB3, 0x4ED8AA4A, 0x5B9CCA4F, 0x682E6FF3, 0x748F82EE, 0x78A5636F, 0x84C87814, 0x8CC70208, 0x90BEFFFA, 0xA4506CEB, 0xBEF9A3F7, 0xC67178F2);
    var HASH = new Array(0x6A09E667, 0xBB67AE85, 0x3C6EF372, 0xA54FF53A, 0x510E527F, 0x9B05688C, 0x1F83D9AB, 0x5BE0CD19);
    var W = new Array(64);
    var a, b, c, d, e, f, g, h, i, j;
    var T1, T2;
   
    m[l >> 5] |= 0x80 << (24 - l % 32);
    m[((l + 64 >> 9) << 4) + 15] = l;
   
    for ( var i = 0; i<m.length; i+=16 ) {
    a = HASH[0];
    b = HASH[1];
    c = HASH[2];
    d = HASH[3];
    e = HASH[4];
    f = HASH[5];
    g = HASH[6];
    h = HASH[7];
   
    for ( var j = 0; j<64; j++) {
    if (j < 16) W[j] = m[j + i];
    else W[j] = safe_add(safe_add(safe_add(Gamma1256(W[j - 2]), W[j - 7]), Gamma0256(W[j - 15])), W[j - 16]);
   
    T1 = safe_add(safe_add(safe_add(safe_add(h, Sigma1256(e)), Ch(e, f, g)), K[j]), W[j]);
    T2 = safe_add(Sigma0256(a), Maj(a, b, c));
   
    h = g;
    g = f;
    f = e;
    e = safe_add(d, T1);
    d = c;
    c = b;
    b = a;
    a = safe_add(T1, T2);
    }
   
    HASH[0] = safe_add(a, HASH[0]);
    HASH[1] = safe_add(b, HASH[1]);
    HASH[2] = safe_add(c, HASH[2]);
    HASH[3] = safe_add(d, HASH[3]);
    HASH[4] = safe_add(e, HASH[4]);
    HASH[5] = safe_add(f, HASH[5]);
    HASH[6] = safe_add(g, HASH[6]);
    HASH[7] = safe_add(h, HASH[7]);
    }
    return HASH;
    }
   
    function str2binb (str) {
    var bin = Array();
    var mask = (1 << chrsz) - 1;
    for(var i = 0; i < str.length * chrsz; i += chrsz) {
    bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (24 - i % 32);
    }
    return bin;
    }
   
    function Utf8Encode(string) {
    string = string.replace(/\r\n/g,'\n');
    var utftext = '';
   
    for (var n = 0; n < string.length; n++) {
   
    var c = string.charCodeAt(n);
   
    if (c < 128) {
    utftext += String.fromCharCode(c);
    }
    else if((c > 127) && (c < 2048)) {
    utftext += String.fromCharCode((c >> 6) | 192);
    utftext += String.fromCharCode((c & 63) | 128);
    }
    else {
    utftext += String.fromCharCode((c >> 12) | 224);
    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
    utftext += String.fromCharCode((c & 63) | 128);
    }
   
    }
   
    return utftext;
    }
   
    function binb2hex (binarray) {
    var hex_tab = hexcase ? '0123456789ABCDEF' : '0123456789abcdef';
    var str = '';
    for(var i = 0; i < binarray.length * 4; i++) {
    str += hex_tab.charAt((binarray[i>>2] >> ((3 - i % 4)*8+4)) & 0xF) +
    hex_tab.charAt((binarray[i>>2] >> ((3 - i % 4)*8 )) & 0xF);
    }
    return str;
    }
   
    s = Utf8Encode(s);
    return binb2hex(core_sha256(str2binb(s), s.length * chrsz));
   }
! function(t, r) {
	"object" == typeof exports ? module.exports = exports = r() : "function" == typeof define && define.amd ? define([], r) : t.CryptoJS = r()
}(this, function() {
	var t = t || function(t, r) {
		var e = Object.create || function() {
				function t() {}
				return function(r) {
					var e;
					return t.prototype = r, e = new t, t.prototype = null, e
				}
			}(),
			i = {},
			n = i.lib = {},
			o = n.Base = function() {
				return {
					extend: function(t) {
						var r = e(this);
						return t && r.mixIn(t), r.hasOwnProperty("init") && this.init !== r.init || (r.init = function() {
							r.$super.init.apply(this, arguments)
						}), r.init.prototype = r, r.$super = this, r
					},
					create: function() {
						var t = this.extend();
						return t.init.apply(t, arguments), t
					},
					init: function() {},
					mixIn: function(t) {
						for (var r in t) t.hasOwnProperty(r) && (this[r] = t[r]);
						t.hasOwnProperty("toString") && (this.toString = t.toString)
					},
					clone: function() {
						return this.init.prototype.extend(this)
					}
				}
			}(),
			s = n.WordArray = o.extend({
				init: function(t, e) {
					t = this.words = t || [], e != r ? this.sigBytes = e : this.sigBytes = 4 * t.length
				},
				toString: function(t) {
					return (t || c).stringify(this)
				},
				concat: function(t) {
					var r = this.words,
						e = t.words,
						i = this.sigBytes,
						n = t.sigBytes;
					if (this.clamp(), i % 4)
						for (var o = 0; o < n; o++) {
							var s = e[o >>> 2] >>> 24 - o % 4 * 8 & 255;
							r[i + o >>> 2] |= s << 24 - (i + o) % 4 * 8
						} else
							for (var o = 0; o < n; o += 4) r[i + o >>> 2] = e[o >>> 2];
					return this.sigBytes += n, this
				},
				clamp: function() {
					var r = this.words,
						e = this.sigBytes;
					r[e >>> 2] &= 4294967295 << 32 - e % 4 * 8, r.length = t.ceil(e / 4)
				},
				clone: function() {
					var t = o.clone.call(this);
					return t.words = this.words.slice(0), t
				},
				random: function(r) {
					for (var e, i = [], n = function(r) {
							var r = r,
								e = 987654321,
								i = 4294967295;
							return function() {
								e = 36969 * (65535 & e) + (e >> 16) & i, r = 18e3 * (65535 & r) + (r >> 16) & i;
								var n = (e << 16) + r & i;
								return n /= 4294967296, n += .5, n * (t.random() > .5 ? 1 : -1)
							}
						}, o = 0; o < r; o += 4) {
						var a = n(4294967296 * (e || t.random()));
						e = 987654071 * a(), i.push(4294967296 * a() | 0)
					}
					return new s.init(i, r)
				}
			}),
			a = i.enc = {},
			c = a.Hex = {
				stringify: function(t) {
					for (var r = t.words, e = t.sigBytes, i = [], n = 0; n < e; n++) {
						var o = r[n >>> 2] >>> 24 - n % 4 * 8 & 255;
						i.push((o >>> 4).toString(16)), i.push((15 & o).toString(16))
					}
					return i.join("")
				},
				parse: function(t) {
					for (var r = t.length, e = [], i = 0; i < r; i += 2) e[i >>> 3] |= parseInt(t.substr(i, 2), 16) << 24 - i % 8 * 4;
					return new s.init(e, r / 2)
				}
			},
			h = a.Latin1 = {
				stringify: function(t) {
					for (var r = t.words, e = t.sigBytes, i = [], n = 0; n < e; n++) {
						var o = r[n >>> 2] >>> 24 - n % 4 * 8 & 255;
						i.push(String.fromCharCode(o))
					}
					return i.join("")
				},
				parse: function(t) {
					for (var r = t.length, e = [], i = 0; i < r; i++) e[i >>> 2] |= (255 & t.charCodeAt(i)) << 24 - i % 4 * 8;
					return new s.init(e, r)
				}
			},
			l = a.Utf8 = {
				stringify: function(t) {
					try {
						return decodeURIComponent(escape(h.stringify(t)))
					} catch (t) {
						throw new Error("Malformed UTF-8 data")
					}
				},
				parse: function(t) {
					return h.parse(unescape(encodeURIComponent(t)))
				}
			},
			f = n.BufferedBlockAlgorithm = o.extend({
				reset: function() {
					this._data = new s.init, this._nDataBytes = 0
				},
				_append: function(t) {
					"string" == typeof t && (t = l.parse(t)), this._data.concat(t), this._nDataBytes += t.sigBytes
				},
				_process: function(r) {
					var e = this._data,
						i = e.words,
						n = e.sigBytes,
						o = this.blockSize,
						a = 4 * o,
						c = n / a;
					c = r ? t.ceil(c) : t.max((0 | c) - this._minBufferSize, 0);
					var h = c * o,
						l = t.min(4 * h, n);
					if (h) {
						for (var f = 0; f < h; f += o) this._doProcessBlock(i, f);
						var u = i.splice(0, h);
						e.sigBytes -= l
					}
					return new s.init(u, l)
				},
				clone: function() {
					var t = o.clone.call(this);
					return t._data = this._data.clone(), t
				},
				_minBufferSize: 0
			}),
			u = (n.Hasher = f.extend({
				cfg: o.extend(),
				init: function(t) {
					this.cfg = this.cfg.extend(t), this.reset()
				},
				reset: function() {
					f.reset.call(this), this._doReset()
				},
				update: function(t) {
					return this._append(t), this._process(), this
				},
				finalize: function(t) {
					t && this._append(t);
					var r = this._doFinalize();
					return r
				},
				blockSize: 16,
				_createHelper: function(t) {
					return function(r, e) {
						return new t.init(e).finalize(r)
					}
				},
				_createHmacHelper: function(t) {
					return function(r, e) {
						return new u.HMAC.init(t, e).finalize(r)
					}
				}
			}), i.algo = {});
		return i
	}(Math);
	return function() {
			function r(t, r, e) {
				for (var i = [], o = 0, s = 0; s < r; s++)
					if (s % 4) {
						var a = e[t.charCodeAt(s - 1)] << s % 4 * 2,
							c = e[t.charCodeAt(s)] >>> 6 - s % 4 * 2;
						i[o >>> 2] |= (a | c) << 24 - o % 4 * 8, o++
					}
				return n.create(i, o)
			}
			var e = t,
				i = e.lib,
				n = i.WordArray,
				o = e.enc;
			o.Base64 = {
				stringify: function(t) {
					var r = t.words,
						e = t.sigBytes,
						i = this._map;
					t.clamp();
					for (var n = [], o = 0; o < e; o += 3)
						for (var s = r[o >>> 2] >>> 24 - o % 4 * 8 & 255, a = r[o + 1 >>> 2] >>> 24 - (o + 1) % 4 * 8 & 255, c = r[o + 2 >>> 2] >>> 24 - (o + 2) % 4 * 8 & 255, h = s << 16 | a << 8 | c, l = 0; l < 4 && o + .75 * l < e; l++) n.push(i.charAt(h >>> 6 * (3 - l) & 63));
					var f = i.charAt(64);
					if (f)
						for (; n.length % 4;) n.push(f);
					return n.join("")
				},
				parse: function(t) {
					var e = t.length,
						i = this._map,
						n = this._reverseMap;
					if (!n) {
						n = this._reverseMap = [];
						for (var o = 0; o < i.length; o++) n[i.charCodeAt(o)] = o
					}
					var s = i.charAt(64);
					if (s) {
						var a = t.indexOf(s);
						a !== -1 && (e = a)
					}
					return r(t, e, n)
				},
				_map: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="
			}
		}(),
		function(r) {
			function e(t, r, e, i, n, o, s) {
				var a = t + (r & e | ~r & i) + n + s;
				return (a << o | a >>> 32 - o) + r
			}

			function i(t, r, e, i, n, o, s) {
				var a = t + (r & i | e & ~i) + n + s;
				return (a << o | a >>> 32 - o) + r
			}

			function n(t, r, e, i, n, o, s) {
				var a = t + (r ^ e ^ i) + n + s;
				return (a << o | a >>> 32 - o) + r
			}

			function o(t, r, e, i, n, o, s) {
				var a = t + (e ^ (r | ~i)) + n + s;
				return (a << o | a >>> 32 - o) + r
			}
			var s = t,
				a = s.lib,
				c = a.WordArray,
				h = a.Hasher,
				l = s.algo,
				f = [];
			! function() {
				for (var t = 0; t < 64; t++) f[t] = 4294967296 * r.abs(r.sin(t + 1)) | 0
			}();
			var u = l.MD5 = h.extend({
				_doReset: function() {
					this._hash = new c.init([1732584193, 4023233417, 2562383102, 271733878])
				},
				_doProcessBlock: function(t, r) {
					for (var s = 0; s < 16; s++) {
						var a = r + s,
							c = t[a];
						t[a] = 16711935 & (c << 8 | c >>> 24) | 4278255360 & (c << 24 | c >>> 8)
					}
					var h = this._hash.words,
						l = t[r + 0],
						u = t[r + 1],
						d = t[r + 2],
						v = t[r + 3],
						p = t[r + 4],
						_ = t[r + 5],
						y = t[r + 6],
						g = t[r + 7],
						B = t[r + 8],
						w = t[r + 9],
						k = t[r + 10],
						S = t[r + 11],
						m = t[r + 12],
						x = t[r + 13],
						b = t[r + 14],
						H = t[r + 15],
						z = h[0],
						A = h[1],
						C = h[2],
						D = h[3];
					z = e(z, A, C, D, l, 7, f[0]), D = e(D, z, A, C, u, 12, f[1]), C = e(C, D, z, A, d, 17, f[2]), A = e(A, C, D, z, v, 22, f[3]), z = e(z, A, C, D, p, 7, f[4]), D = e(D, z, A, C, _, 12, f[5]), C = e(C, D, z, A, y, 17, f[6]), A = e(A, C, D, z, g, 22, f[7]), z = e(z, A, C, D, B, 7, f[8]), D = e(D, z, A, C, w, 12, f[9]), C = e(C, D, z, A, k, 17, f[10]), A = e(A, C, D, z, S, 22, f[11]), z = e(z, A, C, D, m, 7, f[12]), D = e(D, z, A, C, x, 12, f[13]), C = e(C, D, z, A, b, 17, f[14]), A = e(A, C, D, z, H, 22, f[15]), z = i(z, A, C, D, u, 5, f[16]), D = i(D, z, A, C, y, 9, f[17]), C = i(C, D, z, A, S, 14, f[18]), A = i(A, C, D, z, l, 20, f[19]), z = i(z, A, C, D, _, 5, f[20]), D = i(D, z, A, C, k, 9, f[21]), C = i(C, D, z, A, H, 14, f[22]), A = i(A, C, D, z, p, 20, f[23]), z = i(z, A, C, D, w, 5, f[24]), D = i(D, z, A, C, b, 9, f[25]), C = i(C, D, z, A, v, 14, f[26]), A = i(A, C, D, z, B, 20, f[27]), z = i(z, A, C, D, x, 5, f[28]), D = i(D, z, A, C, d, 9, f[29]), C = i(C, D, z, A, g, 14, f[30]), A = i(A, C, D, z, m, 20, f[31]), z = n(z, A, C, D, _, 4, f[32]), D = n(D, z, A, C, B, 11, f[33]), C = n(C, D, z, A, S, 16, f[34]), A = n(A, C, D, z, b, 23, f[35]), z = n(z, A, C, D, u, 4, f[36]), D = n(D, z, A, C, p, 11, f[37]), C = n(C, D, z, A, g, 16, f[38]), A = n(A, C, D, z, k, 23, f[39]), z = n(z, A, C, D, x, 4, f[40]), D = n(D, z, A, C, l, 11, f[41]), C = n(C, D, z, A, v, 16, f[42]), A = n(A, C, D, z, y, 23, f[43]), z = n(z, A, C, D, w, 4, f[44]), D = n(D, z, A, C, m, 11, f[45]), C = n(C, D, z, A, H, 16, f[46]), A = n(A, C, D, z, d, 23, f[47]), z = o(z, A, C, D, l, 6, f[48]), D = o(D, z, A, C, g, 10, f[49]), C = o(C, D, z, A, b, 15, f[50]), A = o(A, C, D, z, _, 21, f[51]), z = o(z, A, C, D, m, 6, f[52]), D = o(D, z, A, C, v, 10, f[53]), C = o(C, D, z, A, k, 15, f[54]), A = o(A, C, D, z, u, 21, f[55]), z = o(z, A, C, D, B, 6, f[56]), D = o(D, z, A, C, H, 10, f[57]), C = o(C, D, z, A, y, 15, f[58]), A = o(A, C, D, z, x, 21, f[59]), z = o(z, A, C, D, p, 6, f[60]), D = o(D, z, A, C, S, 10, f[61]), C = o(C, D, z, A, d, 15, f[62]), A = o(A, C, D, z, w, 21, f[63]), h[0] = h[0] + z | 0, h[1] = h[1] + A | 0, h[2] = h[2] + C | 0, h[3] = h[3] + D | 0
				},
				_doFinalize: function() {
					var t = this._data,
						e = t.words,
						i = 8 * this._nDataBytes,
						n = 8 * t.sigBytes;
					e[n >>> 5] |= 128 << 24 - n % 32;
					var o = r.floor(i / 4294967296),
						s = i;
					e[(n + 64 >>> 9 << 4) + 15] = 16711935 & (o << 8 | o >>> 24) | 4278255360 & (o << 24 | o >>> 8), e[(n + 64 >>> 9 << 4) + 14] = 16711935 & (s << 8 | s >>> 24) | 4278255360 & (s << 24 | s >>> 8), t.sigBytes = 4 * (e.length + 1), this._process();
					for (var a = this._hash, c = a.words, h = 0; h < 4; h++) {
						var l = c[h];
						c[h] = 16711935 & (l << 8 | l >>> 24) | 4278255360 & (l << 24 | l >>> 8)
					}
					return a
				},
				clone: function() {
					var t = h.clone.call(this);
					return t._hash = this._hash.clone(), t
				}
			});
			s.MD5 = h._createHelper(u), s.HmacMD5 = h._createHmacHelper(u)
		}(Math),
		function() {
			var r = t,
				e = r.lib,
				i = e.WordArray,
				n = e.Hasher,
				o = r.algo,
				s = [],
				a = o.SHA1 = n.extend({
					_doReset: function() {
						this._hash = new i.init([1732584193, 4023233417, 2562383102, 271733878, 3285377520])
					},
					_doProcessBlock: function(t, r) {
						for (var e = this._hash.words, i = e[0], n = e[1], o = e[2], a = e[3], c = e[4], h = 0; h < 80; h++) {
							if (h < 16) s[h] = 0 | t[r + h];
							else {
								var l = s[h - 3] ^ s[h - 8] ^ s[h - 14] ^ s[h - 16];
								s[h] = l << 1 | l >>> 31
							}
							var f = (i << 5 | i >>> 27) + c + s[h];
							f += h < 20 ? (n & o | ~n & a) + 1518500249 : h < 40 ? (n ^ o ^ a) + 1859775393 : h < 60 ? (n & o | n & a | o & a) - 1894007588 : (n ^ o ^ a) - 899497514, c = a, a = o, o = n << 30 | n >>> 2, n = i, i = f
						}
						e[0] = e[0] + i | 0, e[1] = e[1] + n | 0, e[2] = e[2] + o | 0, e[3] = e[3] + a | 0, e[4] = e[4] + c | 0
					},
					_doFinalize: function() {
						var t = this._data,
							r = t.words,
							e = 8 * this._nDataBytes,
							i = 8 * t.sigBytes;
						return r[i >>> 5] |= 128 << 24 - i % 32, r[(i + 64 >>> 9 << 4) + 14] = Math.floor(e / 4294967296), r[(i + 64 >>> 9 << 4) + 15] = e, t.sigBytes = 4 * r.length, this._process(), this._hash
					},
					clone: function() {
						var t = n.clone.call(this);
						return t._hash = this._hash.clone(), t
					}
				});
			r.SHA1 = n._createHelper(a), r.HmacSHA1 = n._createHmacHelper(a)
		}(),
		function(r) {
			var e = t,
				i = e.lib,
				n = i.WordArray,
				o = i.Hasher,
				s = e.algo,
				a = [],
				c = [];
			! function() {
				function t(t) {
					for (var e = r.sqrt(t), i = 2; i <= e; i++)
						if (!(t % i)) return !1;
					return !0
				}

				function e(t) {
					return 4294967296 * (t - (0 | t)) | 0
				}
				for (var i = 2, n = 0; n < 64;) t(i) && (n < 8 && (a[n] = e(r.pow(i, .5))), c[n] = e(r.pow(i, 1 / 3)), n++), i++
			}();
			var h = [],
				l = s.SHA256 = o.extend({
					_doReset: function() {
						this._hash = new n.init(a.slice(0))
					},
					_doProcessBlock: function(t, r) {
						for (var e = this._hash.words, i = e[0], n = e[1], o = e[2], s = e[3], a = e[4], l = e[5], f = e[6], u = e[7], d = 0; d < 64; d++) {
							if (d < 16) h[d] = 0 | t[r + d];
							else {
								var v = h[d - 15],
									p = (v << 25 | v >>> 7) ^ (v << 14 | v >>> 18) ^ v >>> 3,
									_ = h[d - 2],
									y = (_ << 15 | _ >>> 17) ^ (_ << 13 | _ >>> 19) ^ _ >>> 10;
								h[d] = p + h[d - 7] + y + h[d - 16]
							}
							var g = a & l ^ ~a & f,
								B = i & n ^ i & o ^ n & o,
								w = (i << 30 | i >>> 2) ^ (i << 19 | i >>> 13) ^ (i << 10 | i >>> 22),
								k = (a << 26 | a >>> 6) ^ (a << 21 | a >>> 11) ^ (a << 7 | a >>> 25),
								S = u + k + g + c[d] + h[d],
								m = w + B;
							u = f, f = l, l = a, a = s + S | 0, s = o, o = n, n = i, i = S + m | 0
						}
						e[0] = e[0] + i | 0, e[1] = e[1] + n | 0, e[2] = e[2] + o | 0, e[3] = e[3] + s | 0, e[4] = e[4] + a | 0, e[5] = e[5] + l | 0, e[6] = e[6] + f | 0, e[7] = e[7] + u | 0
					},
					_doFinalize: function() {
						var t = this._data,
							e = t.words,
							i = 8 * this._nDataBytes,
							n = 8 * t.sigBytes;
						return e[n >>> 5] |= 128 << 24 - n % 32, e[(n + 64 >>> 9 << 4) + 14] = r.floor(i / 4294967296), e[(n + 64 >>> 9 << 4) + 15] = i, t.sigBytes = 4 * e.length, this._process(), this._hash
					},
					clone: function() {
						var t = o.clone.call(this);
						return t._hash = this._hash.clone(), t
					}
				});
			e.SHA256 = o._createHelper(l), e.HmacSHA256 = o._createHmacHelper(l)
		}(Math),
		function() {
			function r(t) {
				return t << 8 & 4278255360 | t >>> 8 & 16711935
			}
			var e = t,
				i = e.lib,
				n = i.WordArray,
				o = e.enc;
			o.Utf16 = o.Utf16BE = {
				stringify: function(t) {
					for (var r = t.words, e = t.sigBytes, i = [], n = 0; n < e; n += 2) {
						var o = r[n >>> 2] >>> 16 - n % 4 * 8 & 65535;
						i.push(String.fromCharCode(o))
					}
					return i.join("")
				},
				parse: function(t) {
					for (var r = t.length, e = [], i = 0; i < r; i++) e[i >>> 1] |= t.charCodeAt(i) << 16 - i % 2 * 16;
					return n.create(e, 2 * r)
				}
			};
			o.Utf16LE = {
				stringify: function(t) {
					for (var e = t.words, i = t.sigBytes, n = [], o = 0; o < i; o += 2) {
						var s = r(e[o >>> 2] >>> 16 - o % 4 * 8 & 65535);
						n.push(String.fromCharCode(s))
					}
					return n.join("")
				},
				parse: function(t) {
					for (var e = t.length, i = [], o = 0; o < e; o++) i[o >>> 1] |= r(t.charCodeAt(o) << 16 - o % 2 * 16);
					return n.create(i, 2 * e)
				}
			}
		}(),
		function() {
			if ("function" == typeof ArrayBuffer) {
				var r = t,
					e = r.lib,
					i = e.WordArray,
					n = i.init,
					o = i.init = function(t) {
						if (t instanceof ArrayBuffer && (t = new Uint8Array(t)), (t instanceof Int8Array || "undefined" != typeof Uint8ClampedArray && t instanceof Uint8ClampedArray || t instanceof Int16Array || t instanceof Uint16Array || t instanceof Int32Array || t instanceof Uint32Array || t instanceof Float32Array || t instanceof Float64Array) && (t = new Uint8Array(t.buffer, t.byteOffset, t.byteLength)), t instanceof Uint8Array) {
							for (var r = t.byteLength, e = [], i = 0; i < r; i++) e[i >>> 2] |= t[i] << 24 - i % 4 * 8;
							n.call(this, e, r)
						} else n.apply(this, arguments)
					};
				o.prototype = i
			}
		}(),
		function(r) {
			function e(t, r, e) {
				return t ^ r ^ e
			}

			function i(t, r, e) {
				return t & r | ~t & e
			}

			function n(t, r, e) {
				return (t | ~r) ^ e
			}

			function o(t, r, e) {
				return t & e | r & ~e
			}

			function s(t, r, e) {
				return t ^ (r | ~e)
			}

			function a(t, r) {
				return t << r | t >>> 32 - r
			}
			var c = t,
				h = c.lib,
				l = h.WordArray,
				f = h.Hasher,
				u = c.algo,
				d = l.create([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 7, 4, 13, 1, 10, 6, 15, 3, 12, 0, 9, 5, 2, 14, 11, 8, 3, 10, 14, 4, 9, 15, 8, 1, 2, 7, 0, 6, 13, 11, 5, 12, 1, 9, 11, 10, 0, 8, 12, 4, 13, 3, 7, 15, 14, 5, 6, 2, 4, 0, 5, 9, 7, 12, 2, 10, 14, 1, 3, 8, 11, 6, 15, 13]),
				v = l.create([5, 14, 7, 0, 9, 2, 11, 4, 13, 6, 15, 8, 1, 10, 3, 12, 6, 11, 3, 7, 0, 13, 5, 10, 14, 15, 8, 12, 4, 9, 1, 2, 15, 5, 1, 3, 7, 14, 6, 9, 11, 8, 12, 2, 10, 0, 4, 13, 8, 6, 4, 1, 3, 11, 15, 0, 5, 12, 2, 13, 9, 7, 10, 14, 12, 15, 10, 4, 1, 5, 8, 7, 6, 2, 13, 14, 0, 3, 9, 11]),
				p = l.create([11, 14, 15, 12, 5, 8, 7, 9, 11, 13, 14, 15, 6, 7, 9, 8, 7, 6, 8, 13, 11, 9, 7, 15, 7, 12, 15, 9, 11, 7, 13, 12, 11, 13, 6, 7, 14, 9, 13, 15, 14, 8, 13, 6, 5, 12, 7, 5, 11, 12, 14, 15, 14, 15, 9, 8, 9, 14, 5, 6, 8, 6, 5, 12, 9, 15, 5, 11, 6, 8, 13, 12, 5, 12, 13, 14, 11, 8, 5, 6]),
				_ = l.create([8, 9, 9, 11, 13, 15, 15, 5, 7, 7, 8, 11, 14, 14, 12, 6, 9, 13, 15, 7, 12, 8, 9, 11, 7, 7, 12, 7, 6, 15, 13, 11, 9, 7, 15, 11, 8, 6, 6, 14, 12, 13, 5, 14, 13, 13, 7, 5, 15, 5, 8, 11, 14, 14, 6, 14, 6, 9, 12, 9, 12, 5, 15, 8, 8, 5, 12, 9, 12, 5, 14, 6, 8, 13, 6, 5, 15, 13, 11, 11]),
				y = l.create([0, 1518500249, 1859775393, 2400959708, 2840853838]),
				g = l.create([1352829926, 1548603684, 1836072691, 2053994217, 0]),
				B = u.RIPEMD160 = f.extend({
					_doReset: function() {
						this._hash = l.create([1732584193, 4023233417, 2562383102, 271733878, 3285377520])
					},
					_doProcessBlock: function(t, r) {
						for (var c = 0; c < 16; c++) {
							var h = r + c,
								l = t[h];
							t[h] = 16711935 & (l << 8 | l >>> 24) | 4278255360 & (l << 24 | l >>> 8)
						}
						var f, u, B, w, k, S, m, x, b, H, z = this._hash.words,
							A = y.words,
							C = g.words,
							D = d.words,
							R = v.words,
							E = p.words,
							M = _.words;
						S = f = z[0], m = u = z[1], x = B = z[2], b = w = z[3], H = k = z[4];
						for (var F, c = 0; c < 80; c += 1) F = f + t[r + D[c]] | 0, F += c < 16 ? e(u, B, w) + A[0] : c < 32 ? i(u, B, w) + A[1] : c < 48 ? n(u, B, w) + A[2] : c < 64 ? o(u, B, w) + A[3] : s(u, B, w) + A[4], F |= 0, F = a(F, E[c]), F = F + k | 0, f = k, k = w, w = a(B, 10), B = u, u = F, F = S + t[r + R[c]] | 0, F += c < 16 ? s(m, x, b) + C[0] : c < 32 ? o(m, x, b) + C[1] : c < 48 ? n(m, x, b) + C[2] : c < 64 ? i(m, x, b) + C[3] : e(m, x, b) + C[4], F |= 0, F = a(F, M[c]), F = F + H | 0, S = H, H = b, b = a(x, 10), x = m, m = F;
						F = z[1] + B + b | 0, z[1] = z[2] + w + H | 0, z[2] = z[3] + k + S | 0, z[3] = z[4] + f + m | 0, z[4] = z[0] + u + x | 0, z[0] = F
					},
					_doFinalize: function() {
						var t = this._data,
							r = t.words,
							e = 8 * this._nDataBytes,
							i = 8 * t.sigBytes;
						r[i >>> 5] |= 128 << 24 - i % 32, r[(i + 64 >>> 9 << 4) + 14] = 16711935 & (e << 8 | e >>> 24) | 4278255360 & (e << 24 | e >>> 8), t.sigBytes = 4 * (r.length + 1), this._process();
						for (var n = this._hash, o = n.words, s = 0; s < 5; s++) {
							var a = o[s];
							o[s] = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8)
						}
						return n
					},
					clone: function() {
						var t = f.clone.call(this);
						return t._hash = this._hash.clone(), t
					}
				});
			c.RIPEMD160 = f._createHelper(B), c.HmacRIPEMD160 = f._createHmacHelper(B)
		}(Math),
		function() {
			var r = t,
				e = r.lib,
				i = e.Base,
				n = r.enc,
				o = n.Utf8,
				s = r.algo;
			s.HMAC = i.extend({
				init: function(t, r) {
					t = this._hasher = new t.init, "string" == typeof r && (r = o.parse(r));
					var e = t.blockSize,
						i = 4 * e;
					r.sigBytes > i && (r = t.finalize(r)), r.clamp();
					for (var n = this._oKey = r.clone(), s = this._iKey = r.clone(), a = n.words, c = s.words, h = 0; h < e; h++) a[h] ^= 1549556828, c[h] ^= 909522486;
					n.sigBytes = s.sigBytes = i, this.reset()
				},
				reset: function() {
					var t = this._hasher;
					t.reset(), t.update(this._iKey)
				},
				update: function(t) {
					return this._hasher.update(t), this
				},
				finalize: function(t) {
					var r = this._hasher,
						e = r.finalize(t);
					r.reset();
					var i = r.finalize(this._oKey.clone().concat(e));
					return i
				}
			})
		}(),
		function() {
			var r = t,
				e = r.lib,
				i = e.Base,
				n = e.WordArray,
				o = r.algo,
				s = o.SHA1,
				a = o.HMAC,
				c = o.PBKDF2 = i.extend({
					cfg: i.extend({
						keySize: 4,
						hasher: s,
						iterations: 1
					}),
					init: function(t) {
						this.cfg = this.cfg.extend(t)
					},
					compute: function(t, r) {
						for (var e = this.cfg, i = a.create(e.hasher, t), o = n.create(), s = n.create([1]), c = o.words, h = s.words, l = e.keySize, f = e.iterations; c.length < l;) {
							var u = i.update(r).finalize(s);
							i.reset();
							for (var d = u.words, v = d.length, p = u, _ = 1; _ < f; _++) {
								p = i.finalize(p), i.reset();
								for (var y = p.words, g = 0; g < v; g++) d[g] ^= y[g]
							}
							o.concat(u), h[0]++
						}
						return o.sigBytes = 4 * l, o
					}
				});
			r.PBKDF2 = function(t, r, e) {
				return c.create(e).compute(t, r)
			}
		}(),
		function() {
			var r = t,
				e = r.lib,
				i = e.Base,
				n = e.WordArray,
				o = r.algo,
				s = o.MD5,
				a = o.EvpKDF = i.extend({
					cfg: i.extend({
						keySize: 4,
						hasher: s,
						iterations: 1
					}),
					init: function(t) {
						this.cfg = this.cfg.extend(t)
					},
					compute: function(t, r) {
						for (var e = this.cfg, i = e.hasher.create(), o = n.create(), s = o.words, a = e.keySize, c = e.iterations; s.length < a;) {
							h && i.update(h);
							var h = i.update(t).finalize(r);
							i.reset();
							for (var l = 1; l < c; l++) h = i.finalize(h), i.reset();
							o.concat(h)
						}
						return o.sigBytes = 4 * a, o
					}
				});
			r.EvpKDF = function(t, r, e) {
				return a.create(e).compute(t, r)
			}
		}(),
		function() {
			var r = t,
				e = r.lib,
				i = e.WordArray,
				n = r.algo,
				o = n.SHA256,
				s = n.SHA224 = o.extend({
					_doReset: function() {
						this._hash = new i.init([3238371032, 914150663, 812702999, 4144912697, 4290775857, 1750603025, 1694076839, 3204075428])
					},
					_doFinalize: function() {
						var t = o._doFinalize.call(this);
						return t.sigBytes -= 4, t
					}
				});
			r.SHA224 = o._createHelper(s), r.HmacSHA224 = o._createHmacHelper(s)
		}(),
		function(r) {
			var e = t,
				i = e.lib,
				n = i.Base,
				o = i.WordArray,
				s = e.x64 = {};
			s.Word = n.extend({
				init: function(t, r) {
					this.high = t, this.low = r
				}
			}), s.WordArray = n.extend({
				init: function(t, e) {
					t = this.words = t || [], e != r ? this.sigBytes = e : this.sigBytes = 8 * t.length
				},
				toX32: function() {
					for (var t = this.words, r = t.length, e = [], i = 0; i < r; i++) {
						var n = t[i];
						e.push(n.high), e.push(n.low)
					}
					return o.create(e, this.sigBytes)
				},
				clone: function() {
					for (var t = n.clone.call(this), r = t.words = this.words.slice(0), e = r.length, i = 0; i < e; i++) r[i] = r[i].clone();
					return t
				}
			})
		}(),
		function(r) {
			var e = t,
				i = e.lib,
				n = i.WordArray,
				o = i.Hasher,
				s = e.x64,
				a = s.Word,
				c = e.algo,
				h = [],
				l = [],
				f = [];
			! function() {
				for (var t = 1, r = 0, e = 0; e < 24; e++) {
					h[t + 5 * r] = (e + 1) * (e + 2) / 2 % 64;
					var i = r % 5,
						n = (2 * t + 3 * r) % 5;
					t = i, r = n
				}
				for (var t = 0; t < 5; t++)
					for (var r = 0; r < 5; r++) l[t + 5 * r] = r + (2 * t + 3 * r) % 5 * 5;
				for (var o = 1, s = 0; s < 24; s++) {
					for (var c = 0, u = 0, d = 0; d < 7; d++) {
						if (1 & o) {
							var v = (1 << d) - 1;
							v < 32 ? u ^= 1 << v : c ^= 1 << v - 32
						}
						128 & o ? o = o << 1 ^ 113 : o <<= 1
					}
					f[s] = a.create(c, u)
				}
			}();
			var u = [];
			! function() {
				for (var t = 0; t < 25; t++) u[t] = a.create()
			}();
			var d = c.SHA3 = o.extend({
				cfg: o.cfg.extend({
					outputLength: 512
				}),
				_doReset: function() {
					for (var t = this._state = [], r = 0; r < 25; r++) t[r] = new a.init;
					this.blockSize = (1600 - 2 * this.cfg.outputLength) / 32
				},
				_doProcessBlock: function(t, r) {
					for (var e = this._state, i = this.blockSize / 2, n = 0; n < i; n++) {
						var o = t[r + 2 * n],
							s = t[r + 2 * n + 1];
						o = 16711935 & (o << 8 | o >>> 24) | 4278255360 & (o << 24 | o >>> 8), s = 16711935 & (s << 8 | s >>> 24) | 4278255360 & (s << 24 | s >>> 8);
						var a = e[n];
						a.high ^= s, a.low ^= o
					}
					for (var c = 0; c < 24; c++) {
						for (var d = 0; d < 5; d++) {
							for (var v = 0, p = 0, _ = 0; _ < 5; _++) {
								var a = e[d + 5 * _];
								v ^= a.high, p ^= a.low
							}
							var y = u[d];
							y.high = v, y.low = p
						}
						for (var d = 0; d < 5; d++)
							for (var g = u[(d + 4) % 5], B = u[(d + 1) % 5], w = B.high, k = B.low, v = g.high ^ (w << 1 | k >>> 31), p = g.low ^ (k << 1 | w >>> 31), _ = 0; _ < 5; _++) {
								var a = e[d + 5 * _];
								a.high ^= v, a.low ^= p
							}
						for (var S = 1; S < 25; S++) {
							var a = e[S],
								m = a.high,
								x = a.low,
								b = h[S];
							if (b < 32) var v = m << b | x >>> 32 - b,
								p = x << b | m >>> 32 - b;
							else var v = x << b - 32 | m >>> 64 - b,
								p = m << b - 32 | x >>> 64 - b;
							var H = u[l[S]];
							H.high = v, H.low = p
						}
						var z = u[0],
							A = e[0];
						z.high = A.high, z.low = A.low;
						for (var d = 0; d < 5; d++)
							for (var _ = 0; _ < 5; _++) {
								var S = d + 5 * _,
									a = e[S],
									C = u[S],
									D = u[(d + 1) % 5 + 5 * _],
									R = u[(d + 2) % 5 + 5 * _];
								a.high = C.high ^ ~D.high & R.high, a.low = C.low ^ ~D.low & R.low
							}
						var a = e[0],
							E = f[c];
						a.high ^= E.high, a.low ^= E.low
					}
				},
				_doFinalize: function() {
					var t = this._data,
						e = t.words,
						i = (8 * this._nDataBytes, 8 * t.sigBytes),
						o = 32 * this.blockSize;
					e[i >>> 5] |= 1 << 24 - i % 32, e[(r.ceil((i + 1) / o) * o >>> 5) - 1] |= 128, t.sigBytes = 4 * e.length, this._process();
					for (var s = this._state, a = this.cfg.outputLength / 8, c = a / 8, h = [], l = 0; l < c; l++) {
						var f = s[l],
							u = f.high,
							d = f.low;
						u = 16711935 & (u << 8 | u >>> 24) | 4278255360 & (u << 24 | u >>> 8), d = 16711935 & (d << 8 | d >>> 24) | 4278255360 & (d << 24 | d >>> 8), h.push(d), h.push(u)
					}
					return new n.init(h, a)
				},
				clone: function() {
					for (var t = o.clone.call(this), r = t._state = this._state.slice(0), e = 0; e < 25; e++) r[e] = r[e].clone();
					return t
				}
			});
			e.SHA3 = o._createHelper(d), e.HmacSHA3 = o._createHmacHelper(d)
		}(Math),
		function() {
			function r() {
				return s.create.apply(s, arguments)
			}
			var e = t,
				i = e.lib,
				n = i.Hasher,
				o = e.x64,
				s = o.Word,
				a = o.WordArray,
				c = e.algo,
				h = [r(1116352408, 3609767458), r(1899447441, 602891725), r(3049323471, 3964484399), r(3921009573, 2173295548), r(961987163, 4081628472), r(1508970993, 3053834265), r(2453635748, 2937671579), r(2870763221, 3664609560), r(3624381080, 2734883394), r(310598401, 1164996542), r(607225278, 1323610764), r(1426881987, 3590304994), r(1925078388, 4068182383), r(2162078206, 991336113), r(2614888103, 633803317), r(3248222580, 3479774868), r(3835390401, 2666613458), r(4022224774, 944711139), r(264347078, 2341262773), r(604807628, 2007800933), r(770255983, 1495990901), r(1249150122, 1856431235), r(1555081692, 3175218132), r(1996064986, 2198950837), r(2554220882, 3999719339), r(2821834349, 766784016), r(2952996808, 2566594879), r(3210313671, 3203337956), r(3336571891, 1034457026), r(3584528711, 2466948901), r(113926993, 3758326383), r(338241895, 168717936), r(666307205, 1188179964), r(773529912, 1546045734), r(1294757372, 1522805485), r(1396182291, 2643833823), r(1695183700, 2343527390), r(1986661051, 1014477480), r(2177026350, 1206759142), r(2456956037, 344077627), r(2730485921, 1290863460), r(2820302411, 3158454273), r(3259730800, 3505952657), r(3345764771, 106217008), r(3516065817, 3606008344), r(3600352804, 1432725776), r(4094571909, 1467031594), r(275423344, 851169720), r(430227734, 3100823752), r(506948616, 1363258195), r(659060556, 3750685593), r(883997877, 3785050280), r(958139571, 3318307427), r(1322822218, 3812723403), r(1537002063, 2003034995), r(1747873779, 3602036899), r(1955562222, 1575990012), r(2024104815, 1125592928), r(2227730452, 2716904306), r(2361852424, 442776044), r(2428436474, 593698344), r(2756734187, 3733110249), r(3204031479, 2999351573), r(3329325298, 3815920427), r(3391569614, 3928383900), r(3515267271, 566280711), r(3940187606, 3454069534), r(4118630271, 4000239992), r(116418474, 1914138554), r(174292421, 2731055270), r(289380356, 3203993006), r(460393269, 320620315), r(685471733, 587496836), r(852142971, 1086792851), r(1017036298, 365543100), r(1126000580, 2618297676), r(1288033470, 3409855158), r(1501505948, 4234509866), r(1607167915, 987167468), r(1816402316, 1246189591)],
				l = [];
			! function() {
				for (var t = 0; t < 80; t++) l[t] = r()
			}();
			var f = c.SHA512 = n.extend({
				_doReset: function() {
					this._hash = new a.init([new s.init(1779033703, 4089235720), new s.init(3144134277, 2227873595), new s.init(1013904242, 4271175723), new s.init(2773480762, 1595750129), new s.init(1359893119, 2917565137), new s.init(2600822924, 725511199), new s.init(528734635, 4215389547), new s.init(1541459225, 327033209)])
				},
				_doProcessBlock: function(t, r) {
					for (var e = this._hash.words, i = e[0], n = e[1], o = e[2], s = e[3], a = e[4], c = e[5], f = e[6], u = e[7], d = i.high, v = i.low, p = n.high, _ = n.low, y = o.high, g = o.low, B = s.high, w = s.low, k = a.high, S = a.low, m = c.high, x = c.low, b = f.high, H = f.low, z = u.high, A = u.low, C = d, D = v, R = p, E = _, M = y, F = g, P = B, W = w, O = k, U = S, I = m, K = x, X = b, L = H, j = z, N = A, T = 0; T < 80; T++) {
						var Z = l[T];
						if (T < 16) var q = Z.high = 0 | t[r + 2 * T],
							G = Z.low = 0 | t[r + 2 * T + 1];
						else {
							var J = l[T - 15],
								$ = J.high,
								Q = J.low,
								V = ($ >>> 1 | Q << 31) ^ ($ >>> 8 | Q << 24) ^ $ >>> 7,
								Y = (Q >>> 1 | $ << 31) ^ (Q >>> 8 | $ << 24) ^ (Q >>> 7 | $ << 25),
								tt = l[T - 2],
								rt = tt.high,
								et = tt.low,
								it = (rt >>> 19 | et << 13) ^ (rt << 3 | et >>> 29) ^ rt >>> 6,
								nt = (et >>> 19 | rt << 13) ^ (et << 3 | rt >>> 29) ^ (et >>> 6 | rt << 26),
								ot = l[T - 7],
								st = ot.high,
								at = ot.low,
								ct = l[T - 16],
								ht = ct.high,
								lt = ct.low,
								G = Y + at,
								q = V + st + (G >>> 0 < Y >>> 0 ? 1 : 0),
								G = G + nt,
								q = q + it + (G >>> 0 < nt >>> 0 ? 1 : 0),
								G = G + lt,
								q = q + ht + (G >>> 0 < lt >>> 0 ? 1 : 0);
							Z.high = q, Z.low = G
						}
						var ft = O & I ^ ~O & X,
							ut = U & K ^ ~U & L,
							dt = C & R ^ C & M ^ R & M,
							vt = D & E ^ D & F ^ E & F,
							pt = (C >>> 28 | D << 4) ^ (C << 30 | D >>> 2) ^ (C << 25 | D >>> 7),
							_t = (D >>> 28 | C << 4) ^ (D << 30 | C >>> 2) ^ (D << 25 | C >>> 7),
							yt = (O >>> 14 | U << 18) ^ (O >>> 18 | U << 14) ^ (O << 23 | U >>> 9),
							gt = (U >>> 14 | O << 18) ^ (U >>> 18 | O << 14) ^ (U << 23 | O >>> 9),
							Bt = h[T],
							wt = Bt.high,
							kt = Bt.low,
							St = N + gt,
							mt = j + yt + (St >>> 0 < N >>> 0 ? 1 : 0),
							St = St + ut,
							mt = mt + ft + (St >>> 0 < ut >>> 0 ? 1 : 0),
							St = St + kt,
							mt = mt + wt + (St >>> 0 < kt >>> 0 ? 1 : 0),
							St = St + G,
							mt = mt + q + (St >>> 0 < G >>> 0 ? 1 : 0),
							xt = _t + vt,
							bt = pt + dt + (xt >>> 0 < _t >>> 0 ? 1 : 0);
						j = X, N = L, X = I, L = K, I = O, K = U, U = W + St | 0, O = P + mt + (U >>> 0 < W >>> 0 ? 1 : 0) | 0, P = M, W = F, M = R, F = E, R = C, E = D, D = St + xt | 0, C = mt + bt + (D >>> 0 < St >>> 0 ? 1 : 0) | 0
					}
					v = i.low = v + D, i.high = d + C + (v >>> 0 < D >>> 0 ? 1 : 0), _ = n.low = _ + E, n.high = p + R + (_ >>> 0 < E >>> 0 ? 1 : 0), g = o.low = g + F, o.high = y + M + (g >>> 0 < F >>> 0 ? 1 : 0), w = s.low = w + W, s.high = B + P + (w >>> 0 < W >>> 0 ? 1 : 0), S = a.low = S + U, a.high = k + O + (S >>> 0 < U >>> 0 ? 1 : 0), x = c.low = x + K, c.high = m + I + (x >>> 0 < K >>> 0 ? 1 : 0), H = f.low = H + L, f.high = b + X + (H >>> 0 < L >>> 0 ? 1 : 0), A = u.low = A + N, u.high = z + j + (A >>> 0 < N >>> 0 ? 1 : 0)
				},
				_doFinalize: function() {
					var t = this._data,
						r = t.words,
						e = 8 * this._nDataBytes,
						i = 8 * t.sigBytes;
					r[i >>> 5] |= 128 << 24 - i % 32, r[(i + 128 >>> 10 << 5) + 30] = Math.floor(e / 4294967296), r[(i + 128 >>> 10 << 5) + 31] = e, t.sigBytes = 4 * r.length, this._process();
					var n = this._hash.toX32();
					return n
				},
				clone: function() {
					var t = n.clone.call(this);
					return t._hash = this._hash.clone(), t
				},
				blockSize: 32
			});
			e.SHA512 = n._createHelper(f), e.HmacSHA512 = n._createHmacHelper(f)
		}(),
		function() {
			var r = t,
				e = r.x64,
				i = e.Word,
				n = e.WordArray,
				o = r.algo,
				s = o.SHA512,
				a = o.SHA384 = s.extend({
					_doReset: function() {
						this._hash = new n.init([new i.init(3418070365, 3238371032), new i.init(1654270250, 914150663), new i.init(2438529370, 812702999), new i.init(355462360, 4144912697), new i.init(1731405415, 4290775857), new i.init(2394180231, 1750603025), new i.init(3675008525, 1694076839), new i.init(1203062813, 3204075428)])
					},
					_doFinalize: function() {
						var t = s._doFinalize.call(this);
						return t.sigBytes -= 16, t
					}
				});
			r.SHA384 = s._createHelper(a), r.HmacSHA384 = s._createHmacHelper(a)
		}(), t.lib.Cipher || function(r) {
			var e = t,
				i = e.lib,
				n = i.Base,
				o = i.WordArray,
				s = i.BufferedBlockAlgorithm,
				a = e.enc,
				c = (a.Utf8, a.Base64),
				h = e.algo,
				l = h.EvpKDF,
				f = i.Cipher = s.extend({
					cfg: n.extend(),
					createEncryptor: function(t, r) {
						return this.create(this._ENC_XFORM_MODE, t, r)
					},
					createDecryptor: function(t, r) {
						return this.create(this._DEC_XFORM_MODE, t, r)
					},
					init: function(t, r, e) {
						this.cfg = this.cfg.extend(e), this._xformMode = t, this._key = r, this.reset()
					},
					reset: function() {
						s.reset.call(this), this._doReset()
					},
					process: function(t) {
						return this._append(t), this._process()
					},
					finalize: function(t) {
						t && this._append(t);
						var r = this._doFinalize();
						return r
					},
					keySize: 4,
					ivSize: 4,
					_ENC_XFORM_MODE: 1,
					_DEC_XFORM_MODE: 2,
					_createHelper: function() {
						function t(t) {
							return "string" == typeof t ? m : w
						}
						return function(r) {
							return {
								encrypt: function(e, i, n) {
									return t(i).encrypt(r, e, i, n)
								},
								decrypt: function(e, i, n) {
									return t(i).decrypt(r, e, i, n)
								}
							}
						}
					}()
				}),
				u = (i.StreamCipher = f.extend({
					_doFinalize: function() {
						var t = this._process(!0);
						return t
					},
					blockSize: 1
				}), e.mode = {}),
				d = i.BlockCipherMode = n.extend({
					createEncryptor: function(t, r) {
						return this.Encryptor.create(t, r)
					},
					createDecryptor: function(t, r) {
						return this.Decryptor.create(t, r)
					},
					init: function(t, r) {
						this._cipher = t, this._iv = r
					}
				}),
				v = u.CBC = function() {
					function t(t, e, i) {
						var n = this._iv;
						if (n) {
							var o = n;
							this._iv = r
						} else var o = this._prevBlock;
						for (var s = 0; s < i; s++) t[e + s] ^= o[s]
					}
					var e = d.extend();
					return e.Encryptor = e.extend({
						processBlock: function(r, e) {
							var i = this._cipher,
								n = i.blockSize;
							t.call(this, r, e, n), i.encryptBlock(r, e), this._prevBlock = r.slice(e, e + n)
						}
					}), e.Decryptor = e.extend({
						processBlock: function(r, e) {
							var i = this._cipher,
								n = i.blockSize,
								o = r.slice(e, e + n);
							i.decryptBlock(r, e), t.call(this, r, e, n), this._prevBlock = o
						}
					}), e
				}(),
				p = e.pad = {},
				_ = p.Pkcs7 = {
					pad: function(t, r) {
						for (var e = 4 * r, i = e - t.sigBytes % e, n = i << 24 | i << 16 | i << 8 | i, s = [], a = 0; a < i; a += 4) s.push(n);
						var c = o.create(s, i);
						t.concat(c)
					},
					unpad: function(t) {
						var r = 255 & t.words[t.sigBytes - 1 >>> 2];
						t.sigBytes -= r
					}
				},
				y = (i.BlockCipher = f.extend({
					cfg: f.cfg.extend({
						mode: v,
						padding: _
					}),
					reset: function() {
						f.reset.call(this);
						var t = this.cfg,
							r = t.iv,
							e = t.mode;
						if (this._xformMode == this._ENC_XFORM_MODE) var i = e.createEncryptor;
						else {
							var i = e.createDecryptor;
							this._minBufferSize = 1
						}
						this._mode && this._mode.__creator == i ? this._mode.init(this, r && r.words) : (this._mode = i.call(e, this, r && r.words), this._mode.__creator = i)
					},
					_doProcessBlock: function(t, r) {
						this._mode.processBlock(t, r)
					},
					_doFinalize: function() {
						var t = this.cfg.padding;
						if (this._xformMode == this._ENC_XFORM_MODE) {
							t.pad(this._data, this.blockSize);
							var r = this._process(!0)
						} else {
							var r = this._process(!0);
							t.unpad(r)
						}
						return r
					},
					blockSize: 4
				}), i.CipherParams = n.extend({
					init: function(t) {
						this.mixIn(t)
					},
					toString: function(t) {
						return (t || this.formatter).stringify(this)
					}
				})),
				g = e.format = {},
				B = g.OpenSSL = {
					stringify: function(t) {
						var r = t.ciphertext,
							e = t.salt;
						if (e) var i = o.create([1398893684, 1701076831]).concat(e).concat(r);
						else var i = r;
						return i.toString(c)
					},
					parse: function(t) {
						var r = c.parse(t),
							e = r.words;
						if (1398893684 == e[0] && 1701076831 == e[1]) {
							var i = o.create(e.slice(2, 4));
							e.splice(0, 4), r.sigBytes -= 16
						}
						return y.create({
							ciphertext: r,
							salt: i
						})
					}
				},
				w = i.SerializableCipher = n.extend({
					cfg: n.extend({
						format: B
					}),
					encrypt: function(t, r, e, i) {
						i = this.cfg.extend(i);
						var n = t.createEncryptor(e, i),
							o = n.finalize(r),
							s = n.cfg;
						return y.create({
							ciphertext: o,
							key: e,
							iv: s.iv,
							algorithm: t,
							mode: s.mode,
							padding: s.padding,
							blockSize: t.blockSize,
							formatter: i.format
						})
					},
					decrypt: function(t, r, e, i) {
						i = this.cfg.extend(i), r = this._parse(r, i.format);
						var n = t.createDecryptor(e, i).finalize(r.ciphertext);
						return n
					},
					_parse: function(t, r) {
						return "string" == typeof t ? r.parse(t, this) : t
					}
				}),
				k = e.kdf = {},
				S = k.OpenSSL = {
					execute: function(t, r, e, i) {
						i || (i = o.random(8));
						var n = l.create({
								keySize: r + e
							}).compute(t, i),
							s = o.create(n.words.slice(r), 4 * e);
						return n.sigBytes = 4 * r, y.create({
							key: n,
							iv: s,
							salt: i
						})
					}
				},
				m = i.PasswordBasedCipher = w.extend({
					cfg: w.cfg.extend({
						kdf: S
					}),
					encrypt: function(t, r, e, i) {
						i = this.cfg.extend(i);
						var n = i.kdf.execute(e, t.keySize, t.ivSize);
						i.iv = n.iv;
						var o = w.encrypt.call(this, t, r, n.key, i);
						return o.mixIn(n), o
					},
					decrypt: function(t, r, e, i) {
						i = this.cfg.extend(i), r = this._parse(r, i.format);
						var n = i.kdf.execute(e, t.keySize, t.ivSize, r.salt);
						i.iv = n.iv;
						var o = w.decrypt.call(this, t, r, n.key, i);
						return o
					}
				})
		}(), t.mode.CFB = function() {
			function r(t, r, e, i) {
				var n = this._iv;
				if (n) {
					var o = n.slice(0);
					this._iv = void 0
				} else var o = this._prevBlock;
				i.encryptBlock(o, 0);
				for (var s = 0; s < e; s++) t[r + s] ^= o[s]
			}
			var e = t.lib.BlockCipherMode.extend();
			return e.Encryptor = e.extend({
				processBlock: function(t, e) {
					var i = this._cipher,
						n = i.blockSize;
					r.call(this, t, e, n, i), this._prevBlock = t.slice(e, e + n)
				}
			}), e.Decryptor = e.extend({
				processBlock: function(t, e) {
					var i = this._cipher,
						n = i.blockSize,
						o = t.slice(e, e + n);
					r.call(this, t, e, n, i), this._prevBlock = o
				}
			}), e
		}(), t.mode.ECB = function() {
			var r = t.lib.BlockCipherMode.extend();
			return r.Encryptor = r.extend({
				processBlock: function(t, r) {
					this._cipher.encryptBlock(t, r)
				}
			}), r.Decryptor = r.extend({
				processBlock: function(t, r) {
					this._cipher.decryptBlock(t, r)
				}
			}), r
		}(), t.pad.AnsiX923 = {
			pad: function(t, r) {
				var e = t.sigBytes,
					i = 4 * r,
					n = i - e % i,
					o = e + n - 1;
				t.clamp(), t.words[o >>> 2] |= n << 24 - o % 4 * 8, t.sigBytes += n
			},
			unpad: function(t) {
				var r = 255 & t.words[t.sigBytes - 1 >>> 2];
				t.sigBytes -= r
			}
		}, t.pad.Iso10126 = {
			pad: function(r, e) {
				var i = 4 * e,
					n = i - r.sigBytes % i;
				r.concat(t.lib.WordArray.random(n - 1)).concat(t.lib.WordArray.create([n << 24], 1))
			},
			unpad: function(t) {
				var r = 255 & t.words[t.sigBytes - 1 >>> 2];
				t.sigBytes -= r
			}
		}, t.pad.Iso97971 = {
			pad: function(r, e) {
				r.concat(t.lib.WordArray.create([2147483648], 1)), t.pad.ZeroPadding.pad(r, e)
			},
			unpad: function(r) {
				t.pad.ZeroPadding.unpad(r), r.sigBytes--
			}
		}, t.mode.OFB = function() {
			var r = t.lib.BlockCipherMode.extend(),
				e = r.Encryptor = r.extend({
					processBlock: function(t, r) {
						var e = this._cipher,
							i = e.blockSize,
							n = this._iv,
							o = this._keystream;
						n && (o = this._keystream = n.slice(0), this._iv = void 0), e.encryptBlock(o, 0);
						for (var s = 0; s < i; s++) t[r + s] ^= o[s]
					}
				});
			return r.Decryptor = e, r
		}(), t.pad.NoPadding = {
			pad: function() {},
			unpad: function() {}
		},
		function(r) {
			var e = t,
				i = e.lib,
				n = i.CipherParams,
				o = e.enc,
				s = o.Hex,
				a = e.format;
			a.Hex = {
				stringify: function(t) {
					return t.ciphertext.toString(s)
				},
				parse: function(t) {
					var r = s.parse(t);
					return n.create({
						ciphertext: r
					})
				}
			}
		}(),
		function() {
			var r = t,
				e = r.lib,
				i = e.BlockCipher,
				n = r.algo,
				o = [],
				s = [],
				a = [],
				c = [],
				h = [],
				l = [],
				f = [],
				u = [],
				d = [],
				v = [];
			! function() {
				for (var t = [], r = 0; r < 256; r++) r < 128 ? t[r] = r << 1 : t[r] = r << 1 ^ 283;
				for (var e = 0, i = 0, r = 0; r < 256; r++) {
					var n = i ^ i << 1 ^ i << 2 ^ i << 3 ^ i << 4;
					n = n >>> 8 ^ 255 & n ^ 99, o[e] = n, s[n] = e;
					var p = t[e],
						_ = t[p],
						y = t[_],
						g = 257 * t[n] ^ 16843008 * n;
					a[e] = g << 24 | g >>> 8, c[e] = g << 16 | g >>> 16, h[e] = g << 8 | g >>> 24, l[e] = g;
					var g = 16843009 * y ^ 65537 * _ ^ 257 * p ^ 16843008 * e;
					f[n] = g << 24 | g >>> 8, u[n] = g << 16 | g >>> 16, d[n] = g << 8 | g >>> 24, v[n] = g, e ? (e = p ^ t[t[t[y ^ p]]], i ^= t[t[i]]) : e = i = 1
				}
			}();
			var p = [0, 1, 2, 4, 8, 16, 32, 64, 128, 27, 54],
				_ = n.AES = i.extend({
					_doReset: function() {
						if (!this._nRounds || this._keyPriorReset !== this._key) {
							for (var t = this._keyPriorReset = this._key, r = t.words, e = t.sigBytes / 4, i = this._nRounds = e + 6, n = 4 * (i + 1), s = this._keySchedule = [], a = 0; a < n; a++)
								if (a < e) s[a] = r[a];
								else {
									var c = s[a - 1];
									a % e ? e > 6 && a % e == 4 && (c = o[c >>> 24] << 24 | o[c >>> 16 & 255] << 16 | o[c >>> 8 & 255] << 8 | o[255 & c]) : (c = c << 8 | c >>> 24, c = o[c >>> 24] << 24 | o[c >>> 16 & 255] << 16 | o[c >>> 8 & 255] << 8 | o[255 & c], c ^= p[a / e | 0] << 24), s[a] = s[a - e] ^ c
								}
							for (var h = this._invKeySchedule = [], l = 0; l < n; l++) {
								var a = n - l;
								if (l % 4) var c = s[a];
								else var c = s[a - 4];
								l < 4 || a <= 4 ? h[l] = c : h[l] = f[o[c >>> 24]] ^ u[o[c >>> 16 & 255]] ^ d[o[c >>> 8 & 255]] ^ v[o[255 & c]]
							}
						}
					},
					encryptBlock: function(t, r) {
						this._doCryptBlock(t, r, this._keySchedule, a, c, h, l, o)
					},
					decryptBlock: function(t, r) {
						var e = t[r + 1];
						t[r + 1] = t[r + 3], t[r + 3] = e, this._doCryptBlock(t, r, this._invKeySchedule, f, u, d, v, s);
						var e = t[r + 1];
						t[r + 1] = t[r + 3], t[r + 3] = e
					},
					_doCryptBlock: function(t, r, e, i, n, o, s, a) {
						for (var c = this._nRounds, h = t[r] ^ e[0], l = t[r + 1] ^ e[1], f = t[r + 2] ^ e[2], u = t[r + 3] ^ e[3], d = 4, v = 1; v < c; v++) {
							var p = i[h >>> 24] ^ n[l >>> 16 & 255] ^ o[f >>> 8 & 255] ^ s[255 & u] ^ e[d++],
								_ = i[l >>> 24] ^ n[f >>> 16 & 255] ^ o[u >>> 8 & 255] ^ s[255 & h] ^ e[d++],
								y = i[f >>> 24] ^ n[u >>> 16 & 255] ^ o[h >>> 8 & 255] ^ s[255 & l] ^ e[d++],
								g = i[u >>> 24] ^ n[h >>> 16 & 255] ^ o[l >>> 8 & 255] ^ s[255 & f] ^ e[d++];
							h = p, l = _, f = y, u = g
						}
						var p = (a[h >>> 24] << 24 | a[l >>> 16 & 255] << 16 | a[f >>> 8 & 255] << 8 | a[255 & u]) ^ e[d++],
							_ = (a[l >>> 24] << 24 | a[f >>> 16 & 255] << 16 | a[u >>> 8 & 255] << 8 | a[255 & h]) ^ e[d++],
							y = (a[f >>> 24] << 24 | a[u >>> 16 & 255] << 16 | a[h >>> 8 & 255] << 8 | a[255 & l]) ^ e[d++],
							g = (a[u >>> 24] << 24 | a[h >>> 16 & 255] << 16 | a[l >>> 8 & 255] << 8 | a[255 & f]) ^ e[d++];
						t[r] = p, t[r + 1] = _, t[r + 2] = y, t[r + 3] = g
					},
					keySize: 8
				});
			r.AES = i._createHelper(_)
		}(),
		function() {
			function r(t, r) {
				var e = (this._lBlock >>> t ^ this._rBlock) & r;
				this._rBlock ^= e, this._lBlock ^= e << t
			}

			function e(t, r) {
				var e = (this._rBlock >>> t ^ this._lBlock) & r;
				this._lBlock ^= e, this._rBlock ^= e << t;
			}
			var i = t,
				n = i.lib,
				o = n.WordArray,
				s = n.BlockCipher,
				a = i.algo,
				c = [57, 49, 41, 33, 25, 17, 9, 1, 58, 50, 42, 34, 26, 18, 10, 2, 59, 51, 43, 35, 27, 19, 11, 3, 60, 52, 44, 36, 63, 55, 47, 39, 31, 23, 15, 7, 62, 54, 46, 38, 30, 22, 14, 6, 61, 53, 45, 37, 29, 21, 13, 5, 28, 20, 12, 4],
				h = [14, 17, 11, 24, 1, 5, 3, 28, 15, 6, 21, 10, 23, 19, 12, 4, 26, 8, 16, 7, 27, 20, 13, 2, 41, 52, 31, 37, 47, 55, 30, 40, 51, 45, 33, 48, 44, 49, 39, 56, 34, 53, 46, 42, 50, 36, 29, 32],
				l = [1, 2, 4, 6, 8, 10, 12, 14, 15, 17, 19, 21, 23, 25, 27, 28],
				f = [{
					0: 8421888,
					268435456: 32768,
					536870912: 8421378,
					805306368: 2,
					1073741824: 512,
					1342177280: 8421890,
					1610612736: 8389122,
					1879048192: 8388608,
					2147483648: 514,
					2415919104: 8389120,
					2684354560: 33280,
					2952790016: 8421376,
					3221225472: 32770,
					3489660928: 8388610,
					3758096384: 0,
					4026531840: 33282,
					134217728: 0,
					402653184: 8421890,
					671088640: 33282,
					939524096: 32768,
					1207959552: 8421888,
					1476395008: 512,
					1744830464: 8421378,
					2013265920: 2,
					2281701376: 8389120,
					2550136832: 33280,
					2818572288: 8421376,
					3087007744: 8389122,
					3355443200: 8388610,
					3623878656: 32770,
					3892314112: 514,
					4160749568: 8388608,
					1: 32768,
					268435457: 2,
					536870913: 8421888,
					805306369: 8388608,
					1073741825: 8421378,
					1342177281: 33280,
					1610612737: 512,
					1879048193: 8389122,
					2147483649: 8421890,
					2415919105: 8421376,
					2684354561: 8388610,
					2952790017: 33282,
					3221225473: 514,
					3489660929: 8389120,
					3758096385: 32770,
					4026531841: 0,
					134217729: 8421890,
					402653185: 8421376,
					671088641: 8388608,
					939524097: 512,
					1207959553: 32768,
					1476395009: 8388610,
					1744830465: 2,
					2013265921: 33282,
					2281701377: 32770,
					2550136833: 8389122,
					2818572289: 514,
					3087007745: 8421888,
					3355443201: 8389120,
					3623878657: 0,
					3892314113: 33280,
					4160749569: 8421378
				}, {
					0: 1074282512,
					16777216: 16384,
					33554432: 524288,
					50331648: 1074266128,
					67108864: 1073741840,
					83886080: 1074282496,
					100663296: 1073758208,
					117440512: 16,
					134217728: 540672,
					150994944: 1073758224,
					167772160: 1073741824,
					184549376: 540688,
					201326592: 524304,
					218103808: 0,
					234881024: 16400,
					251658240: 1074266112,
					8388608: 1073758208,
					25165824: 540688,
					41943040: 16,
					58720256: 1073758224,
					75497472: 1074282512,
					92274688: 1073741824,
					109051904: 524288,
					125829120: 1074266128,
					142606336: 524304,
					159383552: 0,
					176160768: 16384,
					192937984: 1074266112,
					209715200: 1073741840,
					226492416: 540672,
					243269632: 1074282496,
					260046848: 16400,
					268435456: 0,
					285212672: 1074266128,
					301989888: 1073758224,
					318767104: 1074282496,
					335544320: 1074266112,
					352321536: 16,
					369098752: 540688,
					385875968: 16384,
					402653184: 16400,
					419430400: 524288,
					436207616: 524304,
					452984832: 1073741840,
					469762048: 540672,
					486539264: 1073758208,
					503316480: 1073741824,
					520093696: 1074282512,
					276824064: 540688,
					293601280: 524288,
					310378496: 1074266112,
					327155712: 16384,
					343932928: 1073758208,
					360710144: 1074282512,
					377487360: 16,
					394264576: 1073741824,
					411041792: 1074282496,
					427819008: 1073741840,
					444596224: 1073758224,
					461373440: 524304,
					478150656: 0,
					494927872: 16400,
					511705088: 1074266128,
					528482304: 540672
				}, {
					0: 260,
					1048576: 0,
					2097152: 67109120,
					3145728: 65796,
					4194304: 65540,
					5242880: 67108868,
					6291456: 67174660,
					7340032: 67174400,
					8388608: 67108864,
					9437184: 67174656,
					10485760: 65792,
					11534336: 67174404,
					12582912: 67109124,
					13631488: 65536,
					14680064: 4,
					15728640: 256,
					524288: 67174656,
					1572864: 67174404,
					2621440: 0,
					3670016: 67109120,
					4718592: 67108868,
					5767168: 65536,
					6815744: 65540,
					7864320: 260,
					8912896: 4,
					9961472: 256,
					11010048: 67174400,
					12058624: 65796,
					13107200: 65792,
					14155776: 67109124,
					15204352: 67174660,
					16252928: 67108864,
					16777216: 67174656,
					17825792: 65540,
					18874368: 65536,
					19922944: 67109120,
					20971520: 256,
					22020096: 67174660,
					23068672: 67108868,
					24117248: 0,
					25165824: 67109124,
					26214400: 67108864,
					27262976: 4,
					28311552: 65792,
					29360128: 67174400,
					30408704: 260,
					31457280: 65796,
					32505856: 67174404,
					17301504: 67108864,
					18350080: 260,
					19398656: 67174656,
					20447232: 0,
					21495808: 65540,
					22544384: 67109120,
					23592960: 256,
					24641536: 67174404,
					25690112: 65536,
					26738688: 67174660,
					27787264: 65796,
					28835840: 67108868,
					29884416: 67109124,
					30932992: 67174400,
					31981568: 4,
					33030144: 65792
				}, {
					0: 2151682048,
					65536: 2147487808,
					131072: 4198464,
					196608: 2151677952,
					262144: 0,
					327680: 4198400,
					393216: 2147483712,
					458752: 4194368,
					524288: 2147483648,
					589824: 4194304,
					655360: 64,
					720896: 2147487744,
					786432: 2151678016,
					851968: 4160,
					917504: 4096,
					983040: 2151682112,
					32768: 2147487808,
					98304: 64,
					163840: 2151678016,
					229376: 2147487744,
					294912: 4198400,
					360448: 2151682112,
					425984: 0,
					491520: 2151677952,
					557056: 4096,
					622592: 2151682048,
					688128: 4194304,
					753664: 4160,
					819200: 2147483648,
					884736: 4194368,
					950272: 4198464,
					1015808: 2147483712,
					1048576: 4194368,
					1114112: 4198400,
					1179648: 2147483712,
					1245184: 0,
					1310720: 4160,
					1376256: 2151678016,
					1441792: 2151682048,
					1507328: 2147487808,
					1572864: 2151682112,
					1638400: 2147483648,
					1703936: 2151677952,
					1769472: 4198464,
					1835008: 2147487744,
					1900544: 4194304,
					1966080: 64,
					2031616: 4096,
					1081344: 2151677952,
					1146880: 2151682112,
					1212416: 0,
					1277952: 4198400,
					1343488: 4194368,
					1409024: 2147483648,
					1474560: 2147487808,
					1540096: 64,
					1605632: 2147483712,
					1671168: 4096,
					1736704: 2147487744,
					1802240: 2151678016,
					1867776: 4160,
					1933312: 2151682048,
					1998848: 4194304,
					2064384: 4198464
				}, {
					0: 128,
					4096: 17039360,
					8192: 262144,
					12288: 536870912,
					16384: 537133184,
					20480: 16777344,
					24576: 553648256,
					28672: 262272,
					32768: 16777216,
					36864: 537133056,
					40960: 536871040,
					45056: 553910400,
					49152: 553910272,
					53248: 0,
					57344: 17039488,
					61440: 553648128,
					2048: 17039488,
					6144: 553648256,
					10240: 128,
					14336: 17039360,
					18432: 262144,
					22528: 537133184,
					26624: 553910272,
					30720: 536870912,
					34816: 537133056,
					38912: 0,
					43008: 553910400,
					47104: 16777344,
					51200: 536871040,
					55296: 553648128,
					59392: 16777216,
					63488: 262272,
					65536: 262144,
					69632: 128,
					73728: 536870912,
					77824: 553648256,
					81920: 16777344,
					86016: 553910272,
					90112: 537133184,
					94208: 16777216,
					98304: 553910400,
					102400: 553648128,
					106496: 17039360,
					110592: 537133056,
					114688: 262272,
					118784: 536871040,
					122880: 0,
					126976: 17039488,
					67584: 553648256,
					71680: 16777216,
					75776: 17039360,
					79872: 537133184,
					83968: 536870912,
					88064: 17039488,
					92160: 128,
					96256: 553910272,
					100352: 262272,
					104448: 553910400,
					108544: 0,
					112640: 553648128,
					116736: 16777344,
					120832: 262144,
					124928: 537133056,
					129024: 536871040
				}, {
					0: 268435464,
					256: 8192,
					512: 270532608,
					768: 270540808,
					1024: 268443648,
					1280: 2097152,
					1536: 2097160,
					1792: 268435456,
					2048: 0,
					2304: 268443656,
					2560: 2105344,
					2816: 8,
					3072: 270532616,
					3328: 2105352,
					3584: 8200,
					3840: 270540800,
					128: 270532608,
					384: 270540808,
					640: 8,
					896: 2097152,
					1152: 2105352,
					1408: 268435464,
					1664: 268443648,
					1920: 8200,
					2176: 2097160,
					2432: 8192,
					2688: 268443656,
					2944: 270532616,
					3200: 0,
					3456: 270540800,
					3712: 2105344,
					3968: 268435456,
					4096: 268443648,
					4352: 270532616,
					4608: 270540808,
					4864: 8200,
					5120: 2097152,
					5376: 268435456,
					5632: 268435464,
					5888: 2105344,
					6144: 2105352,
					6400: 0,
					6656: 8,
					6912: 270532608,
					7168: 8192,
					7424: 268443656,
					7680: 270540800,
					7936: 2097160,
					4224: 8,
					4480: 2105344,
					4736: 2097152,
					4992: 268435464,
					5248: 268443648,
					5504: 8200,
					5760: 270540808,
					6016: 270532608,
					6272: 270540800,
					6528: 270532616,
					6784: 8192,
					7040: 2105352,
					7296: 2097160,
					7552: 0,
					7808: 268435456,
					8064: 268443656
				}, {
					0: 1048576,
					16: 33555457,
					32: 1024,
					48: 1049601,
					64: 34604033,
					80: 0,
					96: 1,
					112: 34603009,
					128: 33555456,
					144: 1048577,
					160: 33554433,
					176: 34604032,
					192: 34603008,
					208: 1025,
					224: 1049600,
					240: 33554432,
					8: 34603009,
					24: 0,
					40: 33555457,
					56: 34604032,
					72: 1048576,
					88: 33554433,
					104: 33554432,
					120: 1025,
					136: 1049601,
					152: 33555456,
					168: 34603008,
					184: 1048577,
					200: 1024,
					216: 34604033,
					232: 1,
					248: 1049600,
					256: 33554432,
					272: 1048576,
					288: 33555457,
					304: 34603009,
					320: 1048577,
					336: 33555456,
					352: 34604032,
					368: 1049601,
					384: 1025,
					400: 34604033,
					416: 1049600,
					432: 1,
					448: 0,
					464: 34603008,
					480: 33554433,
					496: 1024,
					264: 1049600,
					280: 33555457,
					296: 34603009,
					312: 1,
					328: 33554432,
					344: 1048576,
					360: 1025,
					376: 34604032,
					392: 33554433,
					408: 34603008,
					424: 0,
					440: 34604033,
					456: 1049601,
					472: 1024,
					488: 33555456,
					504: 1048577
				}, {
					0: 134219808,
					1: 131072,
					2: 134217728,
					3: 32,
					4: 131104,
					5: 134350880,
					6: 134350848,
					7: 2048,
					8: 134348800,
					9: 134219776,
					10: 133120,
					11: 134348832,
					12: 2080,
					13: 0,
					14: 134217760,
					15: 133152,
					2147483648: 2048,
					2147483649: 134350880,
					2147483650: 134219808,
					2147483651: 134217728,
					2147483652: 134348800,
					2147483653: 133120,
					2147483654: 133152,
					2147483655: 32,
					2147483656: 134217760,
					2147483657: 2080,
					2147483658: 131104,
					2147483659: 134350848,
					2147483660: 0,
					2147483661: 134348832,
					2147483662: 134219776,
					2147483663: 131072,
					16: 133152,
					17: 134350848,
					18: 32,
					19: 2048,
					20: 134219776,
					21: 134217760,
					22: 134348832,
					23: 131072,
					24: 0,
					25: 131104,
					26: 134348800,
					27: 134219808,
					28: 134350880,
					29: 133120,
					30: 2080,
					31: 134217728,
					2147483664: 131072,
					2147483665: 2048,
					2147483666: 134348832,
					2147483667: 133152,
					2147483668: 32,
					2147483669: 134348800,
					2147483670: 134217728,
					2147483671: 134219808,
					2147483672: 134350880,
					2147483673: 134217760,
					2147483674: 134219776,
					2147483675: 0,
					2147483676: 133120,
					2147483677: 2080,
					2147483678: 131104,
					2147483679: 134350848
				}],
				u = [4160749569, 528482304, 33030144, 2064384, 129024, 8064, 504, 2147483679],
				d = a.DES = s.extend({
					_doReset: function() {
						for (var t = this._key, r = t.words, e = [], i = 0; i < 56; i++) {
							var n = c[i] - 1;
							e[i] = r[n >>> 5] >>> 31 - n % 32 & 1
						}
						for (var o = this._subKeys = [], s = 0; s < 16; s++) {
							for (var a = o[s] = [], f = l[s], i = 0; i < 24; i++) a[i / 6 | 0] |= e[(h[i] - 1 + f) % 28] << 31 - i % 6, a[4 + (i / 6 | 0)] |= e[28 + (h[i + 24] - 1 + f) % 28] << 31 - i % 6;
							a[0] = a[0] << 1 | a[0] >>> 31;
							for (var i = 1; i < 7; i++) a[i] = a[i] >>> 4 * (i - 1) + 3;
							a[7] = a[7] << 5 | a[7] >>> 27
						}
						for (var u = this._invSubKeys = [], i = 0; i < 16; i++) u[i] = o[15 - i]
					},
					encryptBlock: function(t, r) {
						this._doCryptBlock(t, r, this._subKeys)
					},
					decryptBlock: function(t, r) {
						this._doCryptBlock(t, r, this._invSubKeys)
					},
					_doCryptBlock: function(t, i, n) {
						this._lBlock = t[i], this._rBlock = t[i + 1], r.call(this, 4, 252645135), r.call(this, 16, 65535), e.call(this, 2, 858993459), e.call(this, 8, 16711935), r.call(this, 1, 1431655765);
						for (var o = 0; o < 16; o++) {
							for (var s = n[o], a = this._lBlock, c = this._rBlock, h = 0, l = 0; l < 8; l++) h |= f[l][((c ^ s[l]) & u[l]) >>> 0];
							this._lBlock = c, this._rBlock = a ^ h
						}
						var d = this._lBlock;
						this._lBlock = this._rBlock, this._rBlock = d, r.call(this, 1, 1431655765), e.call(this, 8, 16711935), e.call(this, 2, 858993459), r.call(this, 16, 65535), r.call(this, 4, 252645135), t[i] = this._lBlock, t[i + 1] = this._rBlock
					},
					keySize: 2,
					ivSize: 2,
					blockSize: 2
				});
			i.DES = s._createHelper(d);
			var v = a.TripleDES = s.extend({
				_doReset: function() {
					var t = this._key,
						r = t.words;
					this._des1 = d.createEncryptor(o.create(r.slice(0, 2))), this._des2 = d.createEncryptor(o.create(r.slice(2, 4))), this._des3 = d.createEncryptor(o.create(r.slice(4, 6)))
				},
				encryptBlock: function(t, r) {
					this._des1.encryptBlock(t, r), this._des2.decryptBlock(t, r), this._des3.encryptBlock(t, r)
				},
				decryptBlock: function(t, r) {
					this._des3.decryptBlock(t, r), this._des2.encryptBlock(t, r), this._des1.decryptBlock(t, r)
				},
				keySize: 6,
				ivSize: 2,
				blockSize: 2
			});
			i.TripleDES = s._createHelper(v)
		}(),
		function() {
			function r() {
				for (var t = this._S, r = this._i, e = this._j, i = 0, n = 0; n < 4; n++) {
					r = (r + 1) % 256, e = (e + t[r]) % 256;
					var o = t[r];
					t[r] = t[e], t[e] = o, i |= t[(t[r] + t[e]) % 256] << 24 - 8 * n
				}
				return this._i = r, this._j = e, i
			}
			var e = t,
				i = e.lib,
				n = i.StreamCipher,
				o = e.algo,
				s = o.RC4 = n.extend({
					_doReset: function() {
						for (var t = this._key, r = t.words, e = t.sigBytes, i = this._S = [], n = 0; n < 256; n++) i[n] = n;
						for (var n = 0, o = 0; n < 256; n++) {
							var s = n % e,
								a = r[s >>> 2] >>> 24 - s % 4 * 8 & 255;
							o = (o + i[n] + a) % 256;
							var c = i[n];
							i[n] = i[o], i[o] = c
						}
						this._i = this._j = 0
					},
					_doProcessBlock: function(t, e) {
						t[e] ^= r.call(this)
					},
					keySize: 8,
					ivSize: 0
				});
			e.RC4 = n._createHelper(s);
			var a = o.RC4Drop = s.extend({
				cfg: s.cfg.extend({
					drop: 192
				}),
				_doReset: function() {
					s._doReset.call(this);
					for (var t = this.cfg.drop; t > 0; t--) r.call(this)
				}
			});
			e.RC4Drop = n._createHelper(a)
		}(), t.mode.CTRGladman = function() {
			function r(t) {
				if (255 === (t >> 24 & 255)) {
					var r = t >> 16 & 255,
						e = t >> 8 & 255,
						i = 255 & t;
					255 === r ? (r = 0, 255 === e ? (e = 0, 255 === i ? i = 0 : ++i) : ++e) : ++r, t = 0, t += r << 16, t += e << 8, t += i
				} else t += 1 << 24;
				return t
			}

			function e(t) {
				return 0 === (t[0] = r(t[0])) && (t[1] = r(t[1])), t
			}
			var i = t.lib.BlockCipherMode.extend(),
				n = i.Encryptor = i.extend({
					processBlock: function(t, r) {
						var i = this._cipher,
							n = i.blockSize,
							o = this._iv,
							s = this._counter;
						o && (s = this._counter = o.slice(0), this._iv = void 0), e(s);
						var a = s.slice(0);
						i.encryptBlock(a, 0);
						for (var c = 0; c < n; c++) t[r + c] ^= a[c]
					}
				});
			return i.Decryptor = n, i
		}(),
		function() {
			function r() {
				for (var t = this._X, r = this._C, e = 0; e < 8; e++) a[e] = r[e];
				r[0] = r[0] + 1295307597 + this._b | 0, r[1] = r[1] + 3545052371 + (r[0] >>> 0 < a[0] >>> 0 ? 1 : 0) | 0, r[2] = r[2] + 886263092 + (r[1] >>> 0 < a[1] >>> 0 ? 1 : 0) | 0, r[3] = r[3] + 1295307597 + (r[2] >>> 0 < a[2] >>> 0 ? 1 : 0) | 0, r[4] = r[4] + 3545052371 + (r[3] >>> 0 < a[3] >>> 0 ? 1 : 0) | 0, r[5] = r[5] + 886263092 + (r[4] >>> 0 < a[4] >>> 0 ? 1 : 0) | 0, r[6] = r[6] + 1295307597 + (r[5] >>> 0 < a[5] >>> 0 ? 1 : 0) | 0, r[7] = r[7] + 3545052371 + (r[6] >>> 0 < a[6] >>> 0 ? 1 : 0) | 0, this._b = r[7] >>> 0 < a[7] >>> 0 ? 1 : 0;
				for (var e = 0; e < 8; e++) {
					var i = t[e] + r[e],
						n = 65535 & i,
						o = i >>> 16,
						s = ((n * n >>> 17) + n * o >>> 15) + o * o,
						h = ((4294901760 & i) * i | 0) + ((65535 & i) * i | 0);
					c[e] = s ^ h
				}
				t[0] = c[0] + (c[7] << 16 | c[7] >>> 16) + (c[6] << 16 | c[6] >>> 16) | 0, t[1] = c[1] + (c[0] << 8 | c[0] >>> 24) + c[7] | 0, t[2] = c[2] + (c[1] << 16 | c[1] >>> 16) + (c[0] << 16 | c[0] >>> 16) | 0, t[3] = c[3] + (c[2] << 8 | c[2] >>> 24) + c[1] | 0, t[4] = c[4] + (c[3] << 16 | c[3] >>> 16) + (c[2] << 16 | c[2] >>> 16) | 0, t[5] = c[5] + (c[4] << 8 | c[4] >>> 24) + c[3] | 0, t[6] = c[6] + (c[5] << 16 | c[5] >>> 16) + (c[4] << 16 | c[4] >>> 16) | 0, t[7] = c[7] + (c[6] << 8 | c[6] >>> 24) + c[5] | 0
			}
			var e = t,
				i = e.lib,
				n = i.StreamCipher,
				o = e.algo,
				s = [],
				a = [],
				c = [],
				h = o.Rabbit = n.extend({
					_doReset: function() {
						for (var t = this._key.words, e = this.cfg.iv, i = 0; i < 4; i++) t[i] = 16711935 & (t[i] << 8 | t[i] >>> 24) | 4278255360 & (t[i] << 24 | t[i] >>> 8);
						var n = this._X = [t[0], t[3] << 16 | t[2] >>> 16, t[1], t[0] << 16 | t[3] >>> 16, t[2], t[1] << 16 | t[0] >>> 16, t[3], t[2] << 16 | t[1] >>> 16],
							o = this._C = [t[2] << 16 | t[2] >>> 16, 4294901760 & t[0] | 65535 & t[1], t[3] << 16 | t[3] >>> 16, 4294901760 & t[1] | 65535 & t[2], t[0] << 16 | t[0] >>> 16, 4294901760 & t[2] | 65535 & t[3], t[1] << 16 | t[1] >>> 16, 4294901760 & t[3] | 65535 & t[0]];
						this._b = 0;
						for (var i = 0; i < 4; i++) r.call(this);
						for (var i = 0; i < 8; i++) o[i] ^= n[i + 4 & 7];
						if (e) {
							var s = e.words,
								a = s[0],
								c = s[1],
								h = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8),
								l = 16711935 & (c << 8 | c >>> 24) | 4278255360 & (c << 24 | c >>> 8),
								f = h >>> 16 | 4294901760 & l,
								u = l << 16 | 65535 & h;
							o[0] ^= h, o[1] ^= f, o[2] ^= l, o[3] ^= u, o[4] ^= h, o[5] ^= f, o[6] ^= l, o[7] ^= u;
							for (var i = 0; i < 4; i++) r.call(this)
						}
					},
					_doProcessBlock: function(t, e) {
						var i = this._X;
						r.call(this), s[0] = i[0] ^ i[5] >>> 16 ^ i[3] << 16, s[1] = i[2] ^ i[7] >>> 16 ^ i[5] << 16, s[2] = i[4] ^ i[1] >>> 16 ^ i[7] << 16, s[3] = i[6] ^ i[3] >>> 16 ^ i[1] << 16;
						for (var n = 0; n < 4; n++) s[n] = 16711935 & (s[n] << 8 | s[n] >>> 24) | 4278255360 & (s[n] << 24 | s[n] >>> 8), t[e + n] ^= s[n]
					},
					blockSize: 4,
					ivSize: 2
				});
			e.Rabbit = n._createHelper(h)
		}(), t.mode.CTR = function() {
			var r = t.lib.BlockCipherMode.extend(),
				e = r.Encryptor = r.extend({
					processBlock: function(t, r) {
						var e = this._cipher,
							i = e.blockSize,
							n = this._iv,
							o = this._counter;
						n && (o = this._counter = n.slice(0), this._iv = void 0);
						var s = o.slice(0);
						e.encryptBlock(s, 0), o[i - 1] = o[i - 1] + 1 | 0;
						for (var a = 0; a < i; a++) t[r + a] ^= s[a]
					}
				});
			return r.Decryptor = e, r
		}(),
		function() {
			function r() {
				for (var t = this._X, r = this._C, e = 0; e < 8; e++) a[e] = r[e];
				r[0] = r[0] + 1295307597 + this._b | 0, r[1] = r[1] + 3545052371 + (r[0] >>> 0 < a[0] >>> 0 ? 1 : 0) | 0, r[2] = r[2] + 886263092 + (r[1] >>> 0 < a[1] >>> 0 ? 1 : 0) | 0, r[3] = r[3] + 1295307597 + (r[2] >>> 0 < a[2] >>> 0 ? 1 : 0) | 0, r[4] = r[4] + 3545052371 + (r[3] >>> 0 < a[3] >>> 0 ? 1 : 0) | 0, r[5] = r[5] + 886263092 + (r[4] >>> 0 < a[4] >>> 0 ? 1 : 0) | 0, r[6] = r[6] + 1295307597 + (r[5] >>> 0 < a[5] >>> 0 ? 1 : 0) | 0, r[7] = r[7] + 3545052371 + (r[6] >>> 0 < a[6] >>> 0 ? 1 : 0) | 0, this._b = r[7] >>> 0 < a[7] >>> 0 ? 1 : 0;
				for (var e = 0; e < 8; e++) {
					var i = t[e] + r[e],
						n = 65535 & i,
						o = i >>> 16,
						s = ((n * n >>> 17) + n * o >>> 15) + o * o,
						h = ((4294901760 & i) * i | 0) + ((65535 & i) * i | 0);
					c[e] = s ^ h
				}
				t[0] = c[0] + (c[7] << 16 | c[7] >>> 16) + (c[6] << 16 | c[6] >>> 16) | 0, t[1] = c[1] + (c[0] << 8 | c[0] >>> 24) + c[7] | 0, t[2] = c[2] + (c[1] << 16 | c[1] >>> 16) + (c[0] << 16 | c[0] >>> 16) | 0, t[3] = c[3] + (c[2] << 8 | c[2] >>> 24) + c[1] | 0, t[4] = c[4] + (c[3] << 16 | c[3] >>> 16) + (c[2] << 16 | c[2] >>> 16) | 0, t[5] = c[5] + (c[4] << 8 | c[4] >>> 24) + c[3] | 0, t[6] = c[6] + (c[5] << 16 | c[5] >>> 16) + (c[4] << 16 | c[4] >>> 16) | 0, t[7] = c[7] + (c[6] << 8 | c[6] >>> 24) + c[5] | 0
			}
			var e = t,
				i = e.lib,
				n = i.StreamCipher,
				o = e.algo,
				s = [],
				a = [],
				c = [],
				h = o.RabbitLegacy = n.extend({
					_doReset: function() {
						var t = this._key.words,
							e = this.cfg.iv,
							i = this._X = [t[0], t[3] << 16 | t[2] >>> 16, t[1], t[0] << 16 | t[3] >>> 16, t[2], t[1] << 16 | t[0] >>> 16, t[3], t[2] << 16 | t[1] >>> 16],
							n = this._C = [t[2] << 16 | t[2] >>> 16, 4294901760 & t[0] | 65535 & t[1], t[3] << 16 | t[3] >>> 16, 4294901760 & t[1] | 65535 & t[2], t[0] << 16 | t[0] >>> 16, 4294901760 & t[2] | 65535 & t[3], t[1] << 16 | t[1] >>> 16, 4294901760 & t[3] | 65535 & t[0]];
						this._b = 0;
						for (var o = 0; o < 4; o++) r.call(this);
						for (var o = 0; o < 8; o++) n[o] ^= i[o + 4 & 7];
						if (e) {
							var s = e.words,
								a = s[0],
								c = s[1],
								h = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8),
								l = 16711935 & (c << 8 | c >>> 24) | 4278255360 & (c << 24 | c >>> 8),
								f = h >>> 16 | 4294901760 & l,
								u = l << 16 | 65535 & h;
							n[0] ^= h, n[1] ^= f, n[2] ^= l, n[3] ^= u, n[4] ^= h, n[5] ^= f, n[6] ^= l, n[7] ^= u;
							for (var o = 0; o < 4; o++) r.call(this)
						}
					},
					_doProcessBlock: function(t, e) {
						var i = this._X;
						r.call(this), s[0] = i[0] ^ i[5] >>> 16 ^ i[3] << 16, s[1] = i[2] ^ i[7] >>> 16 ^ i[5] << 16, s[2] = i[4] ^ i[1] >>> 16 ^ i[7] << 16, s[3] = i[6] ^ i[3] >>> 16 ^ i[1] << 16;
						for (var n = 0; n < 4; n++) s[n] = 16711935 & (s[n] << 8 | s[n] >>> 24) | 4278255360 & (s[n] << 24 | s[n] >>> 8), t[e + n] ^= s[n]
					},
					blockSize: 4,
					ivSize: 2
				});
			e.RabbitLegacy = n._createHelper(h)
		}(), t.pad.ZeroPadding = {
			pad: function(t, r) {
				var e = 4 * r;
				t.clamp(), t.sigBytes += e - (t.sigBytes % e || e)
			},
			unpad: function(t) {
				for (var r = t.words, e = t.sigBytes - 1; !(r[e >>> 2] >>> 24 - e % 4 * 8 & 255);) e--;
				t.sigBytes = e + 1
			}
		}, t
});
// # sourceMappingURL=crypto-js.min.js.map
! function(e, r, o) {
	"object" == typeof exports ? module.exports = exports = r(require("./core"), require("./sha256"), require("./hmac")) : "function" == typeof define && define.amd ? define(["./core", "./sha256", "./hmac"], r) : r(e.CryptoJS)
}(this, function(e) {
	return e.HmacSHA256
});
// # sourceMappingURL=hmac-sha256.min.js.map
! function(r, e) {
	"object" == typeof exports ? module.exports = exports = e(require("./core")) : "function" == typeof define && define.amd ? define(["./core"], e) : e(r.CryptoJS)
}(this, function(r) {
	return function() {
		function e(r, e, t) {
			for (var a = [], o = 0, i = 0; i < e; i++)
				if (i % 4) {
					var f = t[r.charCodeAt(i - 1)] << i % 4 * 2,
						c = t[r.charCodeAt(i)] >>> 6 - i % 4 * 2;
					a[o >>> 2] |= (f | c) << 24 - o % 4 * 8, o++
				}
			return n.create(a, o)
		}
		var t = r,
			a = t.lib,
			n = a.WordArray,
			o = t.enc;
		o.Base64 = {
			stringify: function(r) {
				var e = r.words,
					t = r.sigBytes,
					a = this._map;
				r.clamp();
				for (var n = [], o = 0; o < t; o += 3)
					for (var i = e[o >>> 2] >>> 24 - o % 4 * 8 & 255, f = e[o + 1 >>> 2] >>> 24 - (o + 1) % 4 * 8 & 255, c = e[o + 2 >>> 2] >>> 24 - (o + 2) % 4 * 8 & 255, s = i << 16 | f << 8 | c, h = 0; h < 4 && o + .75 * h < t; h++) n.push(a.charAt(s >>> 6 * (3 - h) & 63));
				var p = a.charAt(64);
				if (p)
					for (; n.length % 4;) n.push(p);
				return n.join("")
			},
			parse: function(r) {
				var t = r.length,
					a = this._map,
					n = this._reverseMap;
				if (!n) {
					n = this._reverseMap = [];
					for (var o = 0; o < a.length; o++) n[a.charCodeAt(o)] = o
				}
				var i = a.charAt(64);
				if (i) {
					var f = r.indexOf(i);
					f !== -1 && (t = f)
				}
				return e(r, t, n)
			},
			_map: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="
		}
	}(), r.enc.Base64
});
// # sourceMappingURL=enc-base64.min.js.map
if (GmCXt === undefined) var GmCXt = {};

if (GmCXt.requestHandler === undefined) GmCXt.requestHandler = {};

GmCXt.stopVideoUpload = false;
GmCXt.isPageReloaded = false;


GmCXt.ELEMENT_FOUND = 'elementFound';
GmCXt.ELEMENT_NOT_FOUND = 'elementNotFound';
GmCXt.ELEMENT_PRECISION_MEDIUM = 'Medium';
GmCXt.DOM_CRITERIA_DEFAULT = 'default';
GmCXt.DOM_CRITERIA_TEXT = 'identify_by_text';
GmCXt.DOM_CRITERIA_JQUERY = 'jquery_selector';
GmCXt.DOM_CRITERIA_CUSTOM = 'custom_selector';
GmCXt.ANALYTICS_EVENT_CHAIN_ID = '';
GmCXt.INSIGHTS_EVENT_CHAIN_ID = '';
GmCXt.STEP_TEXT_SLIDE_TYPE = 'textSlide';
GmCXt.isSFDCApp = false;
GmCXt.ONBOARDING_SINGLE_SCREEN = 'single_screen';
GmCXt.ONBOARDING_SIDE_BY = 'side_by_side';
GmCXt.tooltipValidRulesArr = ['value', 'message', 'alignment', 'selectionMode', 'customPosition'];
GmCXt.validImageFiles = ['png', 'jpg', 'jpeg', 'gif'];
GmCXt.unknownError = 'Unknown error';
GmCXt.accessibility = false;
GmCXt.sourceDesktop = 'desktop';
GmCXt.videoFileExtns = ['.webm', '.mpg', '.mp2', '.mpeg', '.mpe', '.mpv', '.ogg', '.mp4', '.m4p', '.m4v', '.avi', '.wmv', '.mov', '.qt', '.flv', '.swf'];
GmCXt.notiTimeOpts = ["1", "2", "3", "4", "5", "7", "10", "12", "15", "18", "20", "24", "36", "48"];
GmCXt.defaultWidgetZindex = '2147483646';

/**
 * Note that following constant values must match to the values of
 *  $scope.playVideoTour = 'video';
 *  $scope.playSlideshow = 'slideshow';
 * defined in angular app
 */
GmCXt.TOUR_PLAYER_SLIDESHOW = 'slideshow';
GmCXt.TOUR_PLAYER_VIDEO = 'video';
GmCXt.TOUR_PLAYER_GIPHY = 'giphy';

GmCXt.ruleTextLimit = 200;

GmCXt.failedImages = [];
GmCXt.creatorInterval = null;
GmCXt.playedTour = [];
GmCXt.isMediaPlayerOn = false;
GmCXt.userPrefLang = false;

// For test Automation
GmCXt.testResultsFromCreator = {};

GmCXt.showPlayer = false;
GmCXt.isMiniPlayer = false;

GmCXt.keyInputGuides = [];

GmCXt.feedbackImgSrc = '';

GmCXt.insightPageRulesData = [];

GmCXt.mgActiveLang = '';

if (!GmCXt.domSelectorTracker) {
    GmCXt.domSelectorTracker = {};
}

if (!Array.prototype.find) {
    Object.defineProperty(Array.prototype, 'find', {
        value: function(predicate) {
            // 1. Let O be ? ToObject(this value).
            if (this == null) {
                throw new TypeError('"this" is null or not defined');
            }

            let o = Object(this);

            // 2. Let len be ? ToLength(? Get(O, "length")).
            let len = o.length >>> 0;

            // 3. If IsCallable(predicate) is false, throw a TypeError exception.
            if (typeof predicate !== 'function') {
                throw new TypeError('predicate must be a function');
            }

            // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
            let thisArg = arguments[1];

            // 5. Let k be 0.
            let k = 0;

            // 6. Repeat, while k < len
            while (k < len) {
                // a. Let Pk be ! ToString(k).
                // b. Let kValue be ? Get(O, Pk).
                // c. Let testResult be ToBoolean(? Call(predicate, T,  kValue, k, O )).
                // d. If testResult is true, return kValue.
                let kValue = o[k];
                if (predicate.call(thisArg, kValue, k, o)) {
                    return kValue;
                }
                // e. Increase k by 1.
                k++;
            }

            // 7. Return undefined.
            return undefined;
        }
    });
}

if (Element.prototype.getAttributeNames == undefined) {
    Element.prototype.getAttributeNames = function() {
        let attributes = this.attributes;
        let length = attributes.length;
        let result = new Array(length);
        for (let i = 0; i < length; i++) {
            result[i] = attributes[i].name;
        }
        return result;
    };
}

if (typeof Object.assign != 'function') {
    Object.assign = function(target) {
        'use strict';
        if (target == null) {
            throw new TypeError('Cannot convert undefined or null to object');
        }

        target = Object(target);
        for (let index = 1; index < arguments.length; index++) {
            let source = arguments[index];
            if (source != null) {
                for (let key in source) {
                    if (Object.prototype.hasOwnProperty.call(source, key)) {
                        target[key] = source[key];
                    }
                }
            }
        }
        return target;
    };
}

// Rules Engine
GmCXt.EXISTS = 'Exists';
GmCXt.NOT_EXISTS = 'Not Exists';
GmCXt.EQUALS = 'Equals';
GmCXt.NOT_EQUAL = 'Not Equals';
GmCXt.TXT_EQUALS = 'Text Is';
GmCXt.NOT_TXT = 'Text Is Not';
GmCXt.CONTAINS = 'Contains';
GmCXt.NOT_CONTAINS = 'Does Not Contain';
GmCXt.STARTS_WITH = 'Starts With';
GmCXt.ENDS_WITH = 'Ends With';
GmCXt.GREAT_THAN = 'Greater Than';
GmCXt.LESS_THAN = 'Less Than';
GmCXt.TXT_MATCHES = 'Text Matches';
GmCXt.TXT_CONTAINS = 'Text Contains';
GmCXt.ATTRIBUTES = 'Has Attribute(s)';
GmCXt.NOT_ATTRIBUTES = 'Excludes Attribute(s)';
GmCXt.CLASSES = 'Has CSS Class(s)';
GmCXt.NOT_CLASSES = 'Excludes CSS Class(s)';
GmCXt.SELECTED = 'Is Selected';
GmCXt.NOT_SELECTED = 'Is Not Selected';
GmCXt.CHECKED = 'Checked';
GmCXt.NOT_CHECKED = 'Unchecked';
GmCXt.DISABLED = 'Is Disabled';
GmCXt.NOT_DISABLED = 'Not Disabled';
GmCXt.DAY_OF_WEEK = 'Day of the Week';
GmCXt.FIX_TIME = 'Fixed Time in the Day';
GmCXt.DATE_RANGE = 'Date Range';
GmCXt.IS_VALID = 'Get Validity';
GmCXt.VISIBLE = 'Visible';
GmCXt.NOT_VISIBLE = 'Not Visible';
GmCXt.iframePorts = GmCXt.iframePorts ?? {};
GmCXt.iframeEls = {};
GmCXt.msgChannel = new MessageChannel();
GmCXt.startMsgChannel = function(initiator) {
    window.top.postMessage(initiator, '*', [GmCXt.msgChannel.port2]);
};
GmCXt.globalMsgData = {};

GmCXt.getHostnameFromUrl = function(url) {
    if (url) {
        if (url.includes('https://')) {
            url = url.split('https://')[1];
        }
        if (url.includes('http://')) {
            url = url.split('http://')[1];
        }
        if (url.includes('/')) {
            url = url.split('/')[0];
        }
    }

    return url;
};

GmCXt.updateStepRequest = function(data) {
    if (!data) return;
    const keysToUpdate = [
        "step_video_url",
        "image_url",
        "thumbnail_url",
        "screen_url",
        "step_audio",
        "step_thumb",
        "step_video_thumbnail",
        "videoUrl"
    ];

    keysToUpdate.forEach((key) => {
        if (data[key]) {
            data[key] = GmCXt.getPathnameFromUrl(data[key]);
        }
    });
};

GmCXt.getPathnameFromUrl = function(url) {
    if (url.startsWith('http://') || url.startsWith('https://')) {
        return new URL(url).pathname.replace(/^\/+/, "");
    }
    return url;
};

GmCXt.getStrippedPath = function(elem, type) {
    let originalSrc = "";
    if (type === "image") {
        originalSrc = elem.src;
    } else if (type === "video") {
        originalSrc = elem.querySelectorAll('source')[0].src;
    } else {
        originalSrc = elem;
    }

    let hostname = GmCXt.getHostnameFromUrl(originalSrc);


    if (GmCXt.isCurrentHost(hostname) && originalSrc.indexOf(GmCXt.organization.bucket) !== -1) {
        originalSrc = originalSrc.replace(GmCXt.urlParts.fullUrl, "");
        originalSrc = originalSrc.split("/").map(word => {
            return location.href.toLowerCase().includes(word.toLowerCase()) ? "" : word;
        }).filter(Boolean).join("/");
    }

    let hasProtocol = originalSrc.startsWith("http://") || originalSrc.startsWith("https://");

    if (hasProtocol && GmCXt.getHostnameFromUrl(originalSrc) !== GmCXt.getHostnameFromUrl(GmCXt.conf.cdn) &&
        originalSrc.indexOf(GmCXt.organization.bucket) === -1) {
        if (type === "image") {
            elem.src = originalSrc;
        } else if (type === "video") {
            elem.querySelectorAll('source')[0].src = originalSrc;
        } else {
            elem = originalSrc;
        }
    } else {
        if (originalSrc) {
            let newSrc = GmCXt.getPathnameFromUrl(originalSrc) || originalSrc; // Use originalSrc if URL is already relative
            if (type === "image") {
                elem.src = newSrc;
            } else if (type === "video") {
                elem.querySelectorAll('source')[0].src = newSrc;
            } else {
                elem = newSrc;
            }
        }
    }

    return elem;
};

GmCXt.stripAssetSrcToPathname = function(htmlString) {
    if (!htmlString) {
        return '';
    }
    let isHtml = /<\/?[a-z][\s\S]*>/i.test(htmlString);

    if (!isHtml) {
        let originalSrc = GmCXt.getStrippedPath(htmlString);
        return originalSrc;
    }

    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');

    let images = doc.querySelectorAll('img');
    let video = doc.querySelectorAll('video');

    images.forEach(img => {
        img = GmCXt.getStrippedPath(img, "image");
    });

    video.forEach(vLink => {
        vLink = GmCXt.getStrippedPath(vLink, "video");
    });

    return doc.body.innerHTML;
};



GmCXt.restoreAssetSrc = function(inputString, prefix = "", suffix = "") {
    if(GmCXt.isEmpty(inputString)) return "";
    // Check if the input contains HTML tags
    let isHtml = /<\/?[a-z][\s\S]*>/i.test(inputString);

    if (isHtml) {
        return GmCXt.handleHtmlAssets(inputString, prefix, suffix);
    } else {
        return GmCXt.handlePlainTextAssets(inputString, GmCXt.conf.cdn, "");
    }
};

GmCXt.getRestorePath = function(elem, type) {
    let originalSrc = "";
    if (type === "image") {
        originalSrc = elem.src;
    } else if (type === "video") {
        originalSrc = elem.querySelectorAll('source')[0].src;
    }

    let hostname = GmCXt.getHostnameFromUrl(originalSrc);


    if (GmCXt.isCurrentHost(hostname) && originalSrc.indexOf(GmCXt.organization.bucket) !== -1) {
        originalSrc = originalSrc.replace(GmCXt.urlParts.fullUrl, "");
        originalSrc = originalSrc.split("/").map(word => {
            return location.href.toLowerCase().includes(word.toLowerCase()) ? "" : word;
        }).filter(Boolean).join("/");
    }

    let hasProtocol = originalSrc.startsWith("http://") || originalSrc.startsWith("https://");

    if (hasProtocol && GmCXt.getHostnameFromUrl(originalSrc) !== GmCXt.getHostnameFromUrl(GmCXt.conf.cdn) &&
        originalSrc.indexOf(GmCXt.organization.bucket) === -1) {
        if (type === "image") {
            elem.src = GmCXt.updateSrcAttribute(originalSrc, "", "");
        } else if (type === "video") {
            elem.querySelectorAll('source')[0].src = GmCXt.updateSrcAttribute(originalSrc, "", "");
        }
    } else {
        if (originalSrc) {
            let newSrc = GmCXt.updateInternalSrcAttribute(originalSrc);
            if (type === "image") {
                elem.src = newSrc;
            } else if (type === "video") {
                elem.querySelectorAll('source')[0].src = newSrc;
            }
        }
    }

    return elem;
};

GmCXt.handleHtmlAssets = function(htmlString, prefix, suffix) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');

    let images = doc.querySelectorAll('img');
    let video = doc.querySelectorAll('video');

    images.forEach(img => {
        img = GmCXt.getRestorePath(img, "image");
    });

    video.forEach(vLink => {
        vLink = GmCXt.getRestorePath(vLink, "video");
    });

    return doc.body.innerHTML;
};

GmCXt.handlePlainTextAssets = function(textString, prefix, suffix) {
    if (!textString || textString.trim() === "") return textString;
    let cleanedPath = textString.replace(/^\/+/, ''); // Remove leading slashes
    let hostname = GmCXt.getHostnameFromUrl(textString);

    let hasProtocol = cleanedPath.startsWith("http://") || cleanedPath.startsWith("https://");

    if (!hasProtocol || hostname === GmCXt.getHostnameFromUrl(GmCXt.conf.cdn) ||
        cleanedPath.indexOf(GmCXt.organization.bucket) !== -1) {
        return GmCXt.updateInternalSrcAttribute(cleanedPath);
    } else {
        return GmCXt.updateSrcAttribute(cleanedPath, prefix, suffix);
    }
};

GmCXt.updateInternalSrcAttribute = function(originalSrc) {
    const originalSrcParts = originalSrc.split(GmCXt.organization.bucket);
    let originalSrcPath = "";
    if (originalSrcParts.length < 2 || GmCXt.isEmpty(originalSrcParts[0])) {
        originalSrcPath = originalSrc;
    } else {
        originalSrcPath = GmCXt.organization.bucket + originalSrcParts[1].split("?")[0];
    }
    return GmCXt.updateSrcAttribute(originalSrcPath, GmCXt.conf.cdn, GmCXt.user.cdn_signature);
};

GmCXt.updateSrcAttribute = function(originalSrc, prefix, suffix) {
    let hasProtocol = originalSrc.startsWith("http://") || originalSrc.startsWith("https://");
    return hasProtocol ? originalSrc + suffix : prefix + originalSrc + suffix;
};

GmCXt.getUrlScheme = function() {
    let scheme = "http";
    let url = GmCXt._location().href;

    if (url.indexOf('https://') !== -1) {
        scheme = "https";
    }

    return scheme;
};

/**
 * @function filter URL scheme
 */
GmCXt.filterUrlScheme = function(url) {
    if (url.length) {
        if (url[url.length - 1] === "#") {
            url = url.substr(0, url.length - 1);
        }
        if (url[url.length - 1] === "/") {
            url = url.substr(0, url.length - 1);
        }
    }

    if (url.indexOf('https://') !== -1) {
        url = url.split('https://')[1];
    }
    if (url.indexOf('http://') !== -1) {
        url = url.split('http://')[1];
    }

    return url;
};

GmCXt.sendMessageToBackgroundService = function(m, cb) {
    if (m.data) {
        m.mgdata = m.data;
        delete m.data;
    }
    if (m && GmCXt.isExtension()) {
        if (GmCXt.browserApp === 'chrome') {
            chrome.runtime.sendMessage(m, cb);
        } else if (GmCXt.browserApp === 'Safari') {
            safari.extension.dispatchMessage(m.action, m.mgdata);
            if (cb) {
                cb(1);
            }
        } else if (typeof browser !== 'undefined') {
            browser.runtime.sendMessage(m, cb);
        }
    } else if (cb) {
        cb(1);
    }
};

GmCXt.loader = function() {
    return GmCXt.getBasePath('common/img/g_new_loader.gif');
};

GmCXt.decodeVersion = function(v) {

    if (!v) return 0;

    let num = [0, 0, 0];
    v = v.split('.');
    num[0] = v[0];
    num[1] = doubleDigit(v[1]);
    num[2] = doubleDigit(v[2]);
    if (v[3]) {
        num.push(doubleDigit(v[3]));
    } else {
        num.push("00");
    }

    return parseInt(num.join(''));

    function doubleDigit(num) {
        if (num && num <= 9 && num.length === 1) {
            num = "0" + num.slice(-2);
        }
        return num;
    }
};

GmCXt.arrayMerge = function(array1, array2) {
    return array1.concat(array2.filter(function(item) {
        return array1.indexOf(item) < 0;
    }));
};

GmCXt.isNotNull = function(val) {
    if (val != null) return true;
    else return false;
};

GmCXt.isNumeric = function(val) {
    if (val !== undefined && mg$.isNumeric(val)) return true;
    else return false;
};

GmCXt.isTagged = function(el) {
    let val = false;
    if (el) {
        let className = el.attr('class');
        let parentClassName = el.parent().attr('class');

        if (className && className.indexOf('mg-ft-tag') !== -1)
            val = className;
        else if (parentClassName && parentClassName.indexOf('mg-ft-tag') !== -1)
            val = parentClassName;
    }

    if (val) GmCXt.log(16, "The clicked element has a feature tag attached to it.");

    return val;
};

GmCXt.getTagStepAndTourId = function(classStr) {
    let classes = classStr.split(' ');
    for (let i = 0; i < classes.length; i++) {
        if (classes[i].indexOf('mgftag') !== -1) {
            let ids = classes[i].split('-');
            return {
                step_id: ids[1],
                tour_id: ids[2],
                group_id: ids[3].replaceAll(':', "-"),
                is_tracking_enabled: ids[4]
            };
        }
    }
};

GmCXt.tagClassName = function(step,tagTour) {
    let tagClassName = 'mgftag-' + step.step_id + '-' + step.tour_id + '-' + step.step_settings.groupId.replaceAll('-', ":");
    let trackingEnable = tagTour.tour_settings.is_tracking_enabled ? 1 : 0;
    tagClassName = tagClassName + '-' + trackingEnable;
    return tagClassName;
};

GmCXt.isGmElement = function(el) {
    let isGmElement = false;

    isGmElement = (
        el &&
        (
            el.parent('wmgPlayerJSProd_').length ||
            el.parent('.mgPlayerJSProd_beacon-icon').length ||
            el.parent('.mgPlayerJSProd_smarttip-icon').length ||
            el.parents('wmgPlayerJSProd_').length
        )
    );

    if (!isGmElement && el) {
        let className = el.attr('class');
        let parentClassName = el.parent().attr('class');

        if ((className && className.indexOf('mgPlayerJSProd_') !== -1) || (parentClassName && parentClassName.indexOf('mgPlayerJSProd_') !== -1))
            isGmElement = true;
    }

    return isGmElement;
};

GmCXt.onImageLoadError = function(obj) {
    let src = obj.attr('src');
    let altImg = obj.attr('alt');

    let isCDNCheck = obj.hasClass('mgPlayerJSProd_cdnChecked');
    let cn, isMyGuideImage, isSrcEmpty;

    let updateSign = function() {
        if (isMyGuideImage && !isSrcEmpty) {

            if (altImg && altImg.length) {
                obj.attr('src', altImg);
            }
            obj.attr('originalSrc', src);
            GmCXt.failedImages.push(obj);

            if (window.self === window.top) {
                GmCXt.getCdnSignature(true);
            } else {
                let m = {
                    action: 'mgPlayerJSProd_action:get_cdn_signature',
                };
                GmCXt.sendToParentWindow(m);
            }
        } else if (obj.hasClass('mgPlayerJSProd_dap-card-image')) {
            obj.attr('src', GmCXt.conf.staticContentPath + 'technology.jpg');
        }
    };

    if (obj && obj.length && (obj[0].tagName === 'IMG' || GmCXt.isGmElement(obj)) && !isCDNCheck) {

        cn = 'mgPlayerJSProd_custom-image'; // Never do this 'gss'
        isMyGuideImage = obj.hasClass(cn);
        if (GmCXt.isGmElement(obj) && obj[0].tagName === 'SOURCE') {
            isMyGuideImage = true;
        }

        isSrcEmpty = (obj.attr('src') && obj.attr('src').length) ? false : true;

        obj.addClass('mgPlayerJSProd_cdnChecked');
        updateSign();
    } else if (isCDNCheck && altImg && altImg.length && GmCXt.isUrlValid(altImg) && altImg !== src) {
        obj.attr('src', altImg);
    }
};

GmCXt.isAutomationStep = function(step) {
    return step && (step.step_type !== GmCXt.STEP_TYPE_TAG && (step.step_type === GmCXt.STEP_TYPE_AUTOMATION ||
        (step.step_settings.creation_type && step.step_settings.creation_type === GmCXt.STEP_TYPE_AUTOMATION)));
};

GmCXt.currentTimeStamp = function() {
    return Math.floor((new Date()).getTime() / 1000);
};

GmCXt.inArray = function(id, array) {
    if (mg$.inArray(parseInt(id), array) !== -1) return true;
    else return false;
};

GmCXt.removeDuplicates = function(iArr) {
    let oArr = [];
    mg$.each(iArr, function(i, el) {
        if (mg$.inArray(el, oArr) === -1) oArr.push(el);
    });
    return oArr;
};

GmCXt.convertToInt = function(arr) {
    return arr.map(function(v) {
        return parseInt(v, 10);
    });
};

GmCXt.migrateMatchAlgoSetting = function(de) {

    let c = mg$.extend(true, {}, de.criteria);
    let m = mg$.extend(true, {}, de.meta);
    let tempde = mg$.extend(true, {}, de);

    if ((c.precision_type === GmCXt.DOM_CRITERIA_JQUERY && c.jquery_selector_builder) ||
        (c.precision_type === GmCXt.DOM_CRITERIA_CUSTOM && !c.jquery_selector)) {
        // Old jQuery selector builder (later renamed as custom selector)
        c.jquery_selector = null;
        delete c.jquery_selector_builder;
        c.precision_type = GmCXt.DOM_CRITERIA_DEFAULT;
    }

    if (c.precision_level === "High" && (GmCXt.decodeVersion(tempde.version) < 2020041502)) {
        c.precision_level = "Medium";
    }

    if (c.precision_type === GmCXt.DOM_CRITERIA_JQUERY) {
        c.precision_type = GmCXt.DOM_CRITERIA_CUSTOM;
        let selectorArray = [c.jquery_selector];
        c.matchAttributes = Object.keys(GmCXt.dom.getAttributes(selectorArray)[0]);
        c.matchAttributes.splice(c.matchAttributes.indexOf('tagName'), 1);
    }

    if (c.precision_type === GmCXt.DOM_CRITERIA_TEXT)
        c.precision_type = GmCXt.DOM_CRITERIA_DEFAULT;

    if (!GmCXt.isEmpty(tempde.selector)) {
        for (var key in tempde.selector) {
            if (GmCXt.isEmpty(tempde.selector[key]))
                delete tempde.selector[key];
        }

        if (tempde.selector.hasOwnProperty('css')) {
            delete tempde.selector.css;
        }

        if (m.attributes && m.attributes.hasOwnProperty('js')) {
            m.selectorAttributes = mg$.extend(true, {}, m.attributes);
            for (key in tempde.selector) {
                if (!m.selectorAttributes.hasOwnProperty(key)) {
                    m.selectorAttributes[key] = [];
                }
            }
            delete m.attributes;
        }

        if (!m.hasOwnProperty('executionPriority')) {
            if (GmCXt.isEmpty(m.selectorAttributes)) {
                m.selectorAttributes = GmCXt.getAttributesFromSelector(tempde.selector);
            }
            m.executionPriority = GmCXt.getSelectorExecutionPriority(m.selectorAttributes);
        }
    } else {
        m.executionPriority = ['text'];
    }

    tempde.criteria = c;
    tempde.meta = m;

    return tempde;
};

GmCXt.getAttributesFromSelector = function(sel) {
    let matchedAttr = {};
    for (let key in sel) {
        matchedAttr[key] = [];

        let selectorAttr = GmCXt.dom.getMatchAttributes(key);
        let jsSelector = sel[key];

        for (let i = 0; i < selectorAttr.length; i++) {
            let attr = selectorAttr[i];

            for (let j = 0; j < jsSelector.length; j++) {

                let present = false;
                if (jsSelector[j].includes("[" + attr + "=")) {
                    present = true;
                } else if (attr === 'text') {
                    if (jsSelector[j].includes("[placeholder=") || jsSelector[j].includes("[value="))
                        present = true;
                }

                if (present) {
                    matchedAttr[key].push(attr);
                    break;
                }
            }
        }
    }
    return matchedAttr;
};

GmCXt.getSelectorExecutionPriority = function(selectorAttributes) {
    let priority = Object.keys(selectorAttributes);
    priority.push('text');

    function getNumberOfAttrs(s) {
        if (s === 'text')
            return 3; // Prioritize text selector above jsSelectors with attribute length < 3
        else if (s === 'custom')
            return 0;
        else
            return selectorAttributes[s].length;
    }

    priority = priority.sort(function(a, b) {
        l1 = getNumberOfAttrs(a);
        l2 = getNumberOfAttrs(b);

        // Sort in desc order of length
        if (l2 > l1) return 1;
        if (l2 < l1) return -1;

        return 0;
    });

    return priority;
};

GmCXt.containBranchStep = function(tour) {
    if (!tour || (tour && !GmCXt.isDefined(tour.steps))) return false;

    let steps = mg$.extend({}, tour.steps);
    for (let ind in steps) {
        let step = steps[ind];
        if (GmCXt.checkForBranchVariationSteps(step)) {
            return true;
        }
    }
    return false;
};

GmCXt.getRuleText = function(el) {
    let elValue = '';
    let elTagName = el.tagName.toLowerCase();

    if (elTagName === 'select') {
        elValue = el.options[el.selectedIndex].textContent;
    } else if (elTagName === 'input' && el.value) {
        elValue = el.value;
    } else {
        elValue = el.textContent.trim();
    }
    return elValue;
};

GmCXt.getElementText = function(el) {

    let elValue = GmCXt.getRuleText(el);

    if (!elValue) {

        let value = el.getAttribute('value');
        let placeholder = el.getAttribute('placeholder');
        let name = el.getAttribute('name');

        if ((el.tagName === 'INPUT' || el.tagName === 'BUTTON') &&
            (el.type === 'submit' || el.type === 'button') &&
            value
        ) {
            elValue = value;
        }

        if (!elValue && el.tagName === 'INPUT' && placeholder) {
            elValue = placeholder;
        }
        if (!elValue && el.tagName === 'INPUT' && name) {
            elValue = name;
        }
    }

    return elValue.trim();
};

GmCXt.getOrgLevelBrandLogoSetting = function() {
    return GmCXt.getStepSettings().hideBrandLogo;
};

GmCXt.convertType = function(value) {
    let v = Number(value);
    return !isNaN(v) ? v :
        value === "undefined" ? undefined :
            value === "null" ? null :
                value === "true" ? true :
                    value === "false" ? false :
                        value;
};

GmCXt.getCurrentStepIndex = function(t, step_id) {
    let index = -1;
    if (t && step_id) {
        t.steps.forEach(function(step, i) {
            if (step.step_id === step_id) {
                index = i;
            }
        });
    } else {
        GmCXt.playerI.tour.steps.forEach(function(step, i) {
            if (step.step_id == GmCXt.playerI.currentStepId) {
                index = i;
            }
        });
    }
    return index;
};

GmCXt.isOne = function(val) {
    if (val && val.length === 1) return true;
    else return false;
};

GmCXt.isZero = function(val) {
    if (val && val.length === 0) return true;
    else return false;
};

GmCXt.isMoreThanOne = function(val) {
    if (val && val.length > 1) return true;
    else return false;
};

GmCXt.isMany = function(val) {
    if (val && val.length > 0) return true;
    else return false;
};

GmCXt.reverse = function(s) {
    return mg$.extend([], s).reverse();
};

GmCXt.getValidationTypes = function(val) {
    return {
        required: val,
        numeric: val,
        date: val,
        time: val,
        email: val,
        url: val,
        phone: val,
        charCount: val,
        bulletCount: val,
        regex: val
    };
};

GmCXt.getDiableEleDefaultVal = function() {
    return {
        opacity: '0.5',
        color: '#C0C0C0'
    };
};

GmCXt.isFalse = function(val) {
    if (val === 0 || val === 'false' || val === false || val === '0' || val === '' || val === "undefined" || val === undefined)
        return true;
    else
        return false;
};

GmCXt.validateText = function(str) {
    str = str.trim();
    return str != '' && str.length > 0 && str.length < 100;
};

GmCXt.getStepInfoLog = function(step) {
    let title = step.step_title;
    if (step.step_type === 'smartTip' && step.step_settings.smartTip) {
        title = step.step_settings.smartTip.guidanceMessage;
        title = GmCXt.restoreAssetSrc(title);
    }

    title = mg$('<span />').html(GmCXt.updateOrgAndAddSignature(title)).text().trim();
    if (title.length > 50) {
        title = title.substr(0, 50);
    }
    return "[" + step.step_type.toUpperCase() + "] [" + step.step_id + "] " + title;
};

GmCXt.isAnonymousUser = function() {
    if (GmCXt.user && !GmCXt.isEmpty(GmCXt.organization)) {
        let anonymous = 'anonymous-' + GmCXt.organization.organization_id;
        let userEmail = GmCXt.user.user_email;

        if ((userEmail.indexOf(anonymous) !== -1 || userEmail === 'End+user@edcast.com') && !GmCXt.user.signin_user_email)
            return true;
        else
            return false;
    } else
        return false;
};

GmCXt.getAttributePriority = function(attr, el) {
    switch (attr) {
    case 'id':
        return 1;
    case 'class':
        return 2;
    case 'text':
    case 'name':
    case 'title':
    case 'placeholder':
        return 3;
    default: {
        if (attr === 'value' && el.tagName !== 'INPUT')
            return 3;

        if (attr.includes('Id') || attr.toLowerCase().indexOf('id') === 0 ||
                attr.toLowerCase().includes('_id') || attr.toLowerCase().includes('-id')) {
            return 1;
        }

        if (attr.indexOf('aria') === 0)
            return 4;

        if (typeof el.getAttribute(attr) === 'boolean')
            return 5;

        return 6;
    }
    }
};

GmCXt.skipMyGuideAttributes = function(attr) {
    attr = attr.filter(function(attr) {
        return (attr.indexOf('gm') !== 0);
    });
    return attr;
};

GmCXt.skipSpecialCharValues = function(attrList, he) {

    let textAttr = ['text', 'placeholder', 'value', 'title', 'name'];

    attrList = attrList.filter(function(attr) {
        if (attr === 'text') return true;

        value = he.getAttribute(attr);
        if (!GmCXt.isEmpty(value)) {
            if (textAttr.includes(attr)) return true;

            if (!value.match(/[[\]{}():*+?.,\\^$|#]/g)) return true;
        }

        return false;
    });

    return attrList;
};

GmCXt.skipMyGuideClasses = function(attrList, meta) {
    if (meta && meta.elAttributes && !meta.elAttributes.class) {
        let index = attrList.indexOf('class');
        if (index > -1) {
            attrList.splice(index, 1);
        }
    }
    return attrList;
};

GmCXt.getCustomMatchAttributes = function(he, meta) {
    let attrList = he.getAttributeNames();

    if (!GmCXt.isEmpty(meta.textPropertyValue) && meta.textPropertyName === 'textContent')
        attrList.push('text');

    attrList = GmCXt.skipMyGuideAttributes(attrList);

    attrList = GmCXt.skipSpecialCharValues(attrList, he);

    attrList = GmCXt.skipMyGuideClasses(attrList, meta);

    return attrList;
};

GmCXt.visibleInViewport = function(pos, winHeight, winWidth) {

    let elHeight = Math.abs(pos.height);
    let elWidth = Math.abs(pos.width);

    let elTop = pos.top;
    let elBottom = pos.top + elHeight;
    let elLeft = pos.left;
    let elRight = pos.left + elWidth;

    let bufferH = Math.round(winHeight * 12 / 100);
    let bufferW = Math.round(winWidth * 12 / 100); // 12% buffer

    bufferH = bufferH > elHeight ? 0 : bufferH;
    bufferW = bufferW > elWidth ? 0 : bufferW; // Do not use buffer for elements smaller than buffer

    if (elTop > (winHeight - bufferH) || elBottom < bufferH ||
        elLeft > (winWidth - bufferW) || elRight < bufferW) { // Completely outside window
        return false;
    }

    if (elHeight > winHeight || elWidth > winWidth) { // Do not check partially-in-viewport for el bigger than viewport
        return true;
    }

    return !(elTop < 0 || elBottom > winHeight ||
        elLeft < 0 || elRight > winWidth); //partially in viewport
};

GmCXt.sendToParentWindow = function(m) {
    if (m.data && typeof m.data === 'object') {
        if (GmCXt.isDefined(GmCXt.isSidePanelApp)) {
            m.data.fromSidePanel = GmCXt.isSidePanelApp;
        }

        if (m.action !== "mgPlayerJSProd_action:payload_event_call"
        ) {
            m.data.user = GmCXt.user;
        }

        if (m.action === "mgPlayerJSProd_action:payload_event_call") {
            delete m.data.fromSidePanel;
        }
    }
    GmCXt.msgChannel.port1.postMessage(GmCXt.formatMsg(m));
};

GmCXt.msgToThisWin = function(m) {
    GmCXt.msgChannel.port1.postMessage(GmCXt.formatMsg(m));
};

GmCXt.handleError = function(apiName) {
    console.dir("There is error in API response: " + apiName);
};

GmCXt.getBrandingSetting = function() {
    let setting = false;
    if (GmCXt.appList) {
        var activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];
    }

    if (activeApp && activeApp.settings) {
        setting = activeApp.settings;
    }
    return setting;
};

GmCXt.getBrandLogo = function() {
    return GmCXt.getBrandingSetting().logo;
};

GmCXt.brandLogo = function() {

    let brandLogo = GmCXt.getDefaultIcon();
    let logo = GmCXt.getBrandLogo();

    if (logo && !GmCXt.isDefaultIcon(logo)) {
        brandLogo = GmCXt.restoreAssetSrc(logo);
    }

    return brandLogo;
};

GmCXt.getPopupLogo = function() {
    let brandLogo = GmCXt.getDefaultIcon();

    let logo = GmCXt.getBrandLogo();
    if (logo && !GmCXt.isDefaultIcon(logo)) {
        brandLogo = GmCXt.restoreAssetSrc(logo);
    }

    return "<img class='mgPlayerJSProd_logo-image' src='" + brandLogo + "' alt='" + GmCXt.label.brandLogo + "' />";
};

GmCXt.seggregateRules = function(ruleGroup) {
    let rules = {
        dom: [],
        url: [],
        api: []
    };
    for (let i = 0; i < ruleGroup.length; i++) {
        let rule = ruleGroup[i];
        if (rule.type.includes('Select ') || rule.type === "Variables") {
            rule.domRule = true;
            rules.dom.push(rule);
            ruleGroup.checkDom = true;
        } else if (rule.condition === 'Get Validity') {
            rule.apiRule = true;
            rules.api.push(rule);
            ruleGroup.checkApi = true;
        } else {
            rules.url.push(rule);
        }
    }
    return rules;
};

GmCXt.numberOfDomRules = function(rules) {
    let count = 0;
    for (let i = 0; i < rules.length; i++) {
        if (rules[i].type === 'Select Element' || rules[i].type === 'Select Table' || rules[i].type === 'Variables') {
            count++;
        }
    }
    return count;
};

GmCXt.buildGuidePlayStructure = function(tour) {
    let steps = tour.steps;
    let playStructure = [];
    for (let i = 0, j = steps.length; i < j; i++) {
        let item = {
            id: steps[i].step_id
        };
        if (steps[i + 1]) item.tail = steps[i + 1].step_id;
        else item.tail = null;

        playStructure.push(item);
    }

    return playStructure;
};

GmCXt.getStepsForPS = function(steps, type) {
    if (GmCXt.playerI && (GmCXt.playerI.automate || GmCXt.playerI.isAutomation) || GmCXt.isAutomationRunning() || type === "doitforme") {
        return steps;
    } else {
        return GmCXt.filterOutAutomationSteps(steps);
    }
};

GmCXt.getGuidePlayStructure = function(tour, type) {

    let playStructure = tour.tour_settings.play_structure;
    tour.steps = GmCXt.getStepsForPS(tour.steps, type);

    if (!GmCXt.containBranchStep(tour)) {
        return GmCXt.buildGuidePlayStructure(tour);

    } else if (mg$.isArray(playStructure) && playStructure.length) {
        playStructure = GmCXt.repairPlayStructure(playStructure, tour.steps);
        return playStructure;
    }
};

GmCXt.reloadFailedImages = function() {
    if (GmCXt.failedImages && GmCXt.failedImages.length) {
        for (let i = 0; i < GmCXt.failedImages.length; i++) {
            let obj = GmCXt.failedImages[i];
            if (obj.length) {
                let src = obj.attr('originalSrc');
                if (src) {
                    src = src.split("?");
                    if (src[0] && src.length > 1) {
                        let newSrc = src[0] + GmCXt.getCdnSign();
                        obj.attr('src', newSrc);
                    }
                }
            }
        }

        GmCXt.failedImages = [];
    }

    GmCXt.waitForCdnSignature = false;
};

GmCXt.getOrgSettings = function() {

    let os = false;

    if (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization)) {
        os = GmCXt.organization.settings;
    }

    return os;
};

GmCXt.getWidgetSettings = function() {

    let ws = false;

    if (GmCXt.appList && GmCXt.activeAppId) {
        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];

        if (activeApp && activeApp.settings) {
            ws = activeApp.settings;
            ws.clientVersion = activeApp.settings.version;
        }
    }
    if (GmCXt.isWestpac()) {
        ws.guide_count_on_widget = false;
    }

    return ws;
};

GmCXt.getStepSettings = function() {

    let appSettings = false;

    if (!GmCXt.isEmpty(GmCXt.appList)) {
        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];

        if (activeApp && activeApp.settings) {
            appSettings = activeApp.settings;
        }
    } else if (window.self !== window.top && !GmCXt.isEmpty(GmCXt.activeAppSettings)) {
        appSettings = GmCXt.activeAppSettings;
    }

    if (GmCXt.isDesktop()) {
        appSettings = (!GmCXt.isEmpty(GmCXt.playerI.tour.steps[0].orgSettings)) ? GmCXt.playerI.tour.steps[0].orgSettings : GmCXt.playerI.tour.steps[0].appSettings;
        appSettings = GmCXt.validateDataModel(appSettings, GmCXt.model.organization.settings._obj);
    }

    return appSettings;
};

GmCXt.getAppSetting = function(opt) {
    let appSettings = false;
    if (!GmCXt.isEmpty(GmCXt.appList) && GmCXt.activeAppId) {

        if (!GmCXt.appList['app:' + GmCXt.activeAppId] && GmCXt.user) {
            GmCXt.logoutUser();
        } else {
            appSettings = GmCXt.appList['app:' + GmCXt.activeAppId].settings;
        }

    } else if (window.self !== window.top && !GmCXt.isEmpty(GmCXt.activeAppSettings)) {
        appSettings = GmCXt.activeAppSettings;
    }

    if (appSettings && opt) {
        return appSettings[opt];
    }

    return appSettings;
};

GmCXt.getCdnSign = function() {
    let sign = '';

    if (GmCXt.user && !GmCXt.isEmpty(GmCXt.user)) {
        sign = GmCXt.user.cdn_signature;
    }

    return sign;
};

GmCXt.getDefaultIcon = function() {
    return GmCXt.conf.staticContentPath + "myguide.png";
};

GmCXt.getChatDefaultIcon = function() {
    return GmCXt.conf.staticContentPath + "chat_bot_icon.png";
};

GmCXt.getDefaultGuideIcon = function() {
    return GmCXt.conf.staticContentPath + 'default_guide.png';
};

GmCXt.isFalseObj = function(o) {
    if (!o || typeof o !== "object") return true;

    let r = true;
    for (let i in o) {
        if (o[i] === true) {
            r = false;
            break;
        }
    }
    return r;
};

GmCXt.getRectObject = function(rect) {
    let obj = {
        top: rect.top,
        left: rect.left,
        bottom: rect.bottom,
        right: rect.right,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
    };
    return obj;
};

GmCXt.redirect = function(to) {
    GmCXt.log(1, "ROUTE to " + to);
    GmCXt.timeout(function() {
        location.replace(to);
    }, 0);
};

GmCXt.getPosition = function(cssPos) {
    if (cssPos) {
        return 'mgPlayerJSProd_fixed-position';
    } else {
        return 'mgPlayerJSProd_absolute-position';
    }
};

GmCXt.isInspectToolON = function() {

    if ((GmCXt.selectorTool && GmCXt.selectorTool.status !== 'inactive') ||
        (GmCXt.selectorToolFill && GmCXt.selectorToolFill.status !== 'inactive') ||
        (GmCXt.selectorToolRules && GmCXt.selectorToolRules.status !== 'inactive')
    ) {
        return true;
    }

    return false;
};

GmCXt.getExtUrl = function(localUrl) {
    let url = GmCXt.getBrowserUrl(localUrl);

    return url;
};

GmCXt.getBaseUrl = function(f) {

    if (GmCXt.isExtension()) {
        return GmCXt.getExtUrl(f);
    } else {
        if (GmCXt.isClientJs() && !GmCXt.conf.baseUrl && GmCXt.conf.clientJsBaseUrl) {
            GmCXt.conf.baseUrl = GmCXt.conf.clientJsBaseUrl;
        }
        return GmCXt.conf.baseUrl + f;
    }
};

GmCXt.capitalizeFirstLetter = function(str) {
    str = str || "";
    return str.charAt(0).toUpperCase() + str.slice(1);
};

GmCXt.encode = function(args) {
    let data = '';
    if (args) {
        let argcount = 0;
        for (let key in args) {
            if (args.hasOwnProperty(key)) {
                if (argcount++) data += '&';
                data += encodeURIComponent(key) + '=' + encodeURIComponent(args[key]);
            }
        }
    }
    return data;
};

GmCXt.returnNavigator = function() {
    return navigator.getUserMedia || navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia || navigator.msGetUserMedia;
};

GmCXt.getDefaultError = function() {
    return {
        code: 403,
        message: [GmCXt.unknownError]
    };
};

GmCXt.getCodeError = function() {
    return {
        code: 405,
        message: [GmCXt.unknownError]
    };
};

GmCXt.externalApiCall = function(url) {
    let params = {
        url: url,
        method: 'GET',
        data: '',
    };
    let promise = GmCXt.xhr(params, true, true);

    return promise;
};

GmCXt.checkFileExist = function(url) {

    let params = {
        url: url,
        method: 'GET',
    };
    let promise = GmCXt.xhr(params, true);

    return promise;
};

/**
 * @function
 * @returns Current webpage url
 */
GmCXt.getUrl = function() {
    let url = GmCXt._location().href;
    return GmCXt.filterUrlScheme(url);
};

GmCXt.checkWorkdayTextfield = function(el, identifier) {
    let customSettings = el.customSettings;
    if (customSettings && customSettings.workday && !customSettings.workday.isTableHeader) {
        let workday = customSettings.workday;
        if (!workday.isWDCustomSelect || identifier !== 'rules-engine-request') {
            return Object.keys(workday).some(function(k) {
                return workday[k];
            });
        }
    }

    return false;
};

GmCXt.filterMyguideClassValue = function(classVal) {
    let classes = [];
    classes = classVal.split(/\s+/);
    classes = classes.filter(function(className) {
        if (className.indexOf("doitforme-") === -1 && className.indexOf("mg-smarttip") === -1) {
            return true;
        }
    });

    classVal = classes.join(' ');
    return classVal.trim();
};

GmCXt.getAttributeValues = function(el, attributes) {

    if (el.nodeType !== 1) {
        return {};
    }

    let attrList = attributes || el.getAttributeNames();

    let attrObj = {
        tagName: el.tagName
    };

    attrList.forEach(function(attr) {
        let value = el.getAttribute(attr);

        if (!GmCXt.isEmpty(value)) {
            attrObj[attr] = value;
        }
    });

    if (attrObj.class) {
        attrObj.class = GmCXt.filterMyguideClassValue(attrObj.class);
        if (GmCXt.isEmpty(attrObj.class)) {
            delete attrObj.class;
        }
    }

    if (el.textContent && el.textContent.length > 500) {
        delete attrObj.text;
    } else if (!GmCXt.isEmpty(el.textContent)) {
        attrObj.text = el.textContent.trim();
    }

    return attrObj;
};

GmCXt.isOnboarding = function(t) {
    if (t && t.tour_type && t.tour_type.indexOf('onboarding') !== -1) return true;
    else return false;
};

GmCXt.isAnnouncement = function(t) {
    if (t && t.tour_settings && GmCXt.isOnboarding(t) && t.tour_settings.tutorial_tour_type &&
        t.tour_settings.tutorial_tour_type === "announcement") {
        return true;
    } else {
        return false;
    }
};

GmCXt.isFeatureTags = function(t) {
    if (t && t.tour_type.indexOf('insights') >= 0) return true;
    else return false;
};

GmCXt.isBotGuide = function(t) {
    if (t && t.tour_type === 'bot') return true;
    else return false;
};

GmCXt.isChatEnable = function() {
    let flag = false;
    if (!GmCXt.isEmpty(GmCXt.appList)) {
        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];
        if (activeApp && activeApp.settings.enable_chatbot) {
            flag = true;
        }
    }
    return flag;
};

GmCXt.isHowToGuide = function(t) {
    if (!GmCXt.isEmpty(t) && t.tour_type.indexOf('howto_tour') !== -1) return true;
    else return false;
};

GmCXt.isGuide = function(t) {

    if (GmCXt.isOnboarding(t))
        return false;
    if (t && (
        t.tour_type.indexOf('walkthrough_tour') !== -1 ||
        t.tour_type.indexOf('videoScreencast') !== -1 ||
        t.tour_type.indexOf('videoCapture') !== -1
    )) {
        return true;
    } else
        return false;
};

GmCXt.initPlayerModeFeatures = function(showPlayer, isMiniPlayer, isPlayerMode) {
    GmCXt.showPlayer = showPlayer;
    GmCXt.isMiniPlayer = isMiniPlayer;
    GmCXt.playerMode = isPlayerMode;
    if (GmCXt.isPlayer()) {
        GmCXt.FT = GmCXt.getPlayerFeatures();
    } else {
        GmCXt.FT = GmCXt.getCreatorAppFeatures();
    }

    if (GmCXt.isMicroPlayer()) {
        mg$(".mgPlayerJSProd_panel").addClass('mgPlayerJSProd_theme-mplayer');
    } else {
        mg$(".mgPlayerJSProd_panel").removeClass('mgPlayerJSProd_theme-mplayer');
    }
};

GmCXt.matchUrlRegEx = function(regExUrl, url2) {
    let match = false;

    let regexString = '';
    let splitArr = regExUrl.split("[*.]");

    for (let i = 0; i < splitArr.length; i++) {

        if (i === splitArr.length - 1) {
            regexString += splitArr[i];
        } else {
            regexString += splitArr[i] + "([a-zA-Z0-9:!+@#$&()?\\-_`.%+,=\\/]*)";
        }
    }
    let regexPattern = new RegExp("^" + regexString + '$');
    match = regexPattern.test(url2);

    return match;
};

GmCXt.trimAndLowerCaseURL = function(url) {
    let newURL = '';
    url = GmCXt.filterUrlScheme(url);
    if (url) {
        newURL = url.toLowerCase();
        if (newURL.indexOf("www.") === 0) {
            newURL = newURL.slice(4, newURL.length);
        }
    }
    return newURL;
};

GmCXt.getTailFromBranchStep = function(branches, e, sId, tour) {
    let bInd = 0;
    let retVal = null;
    let pi = GmCXt.playerI;
    let currentStep = null;
    let getStep = function(stepId, tour) {
        if (stepId) {
            for (let i = 0; i < tour.steps.length; i++) {
                if (parseInt(tour.steps[i].step_id) === parseInt(stepId)) {
                    return tour.steps[i];
                }
            }
        } else {
            return false;
        }
    };

    if (pi) {
        currentStep = getStep(pi.currentStepId, pi.tour);
    } else {
        currentStep = getStep(sId, tour);
    }

    for (bInd = 0; bInd < branches.length; bInd++) {
        if (GmCXt.isStepInlineBranch(currentStep)) {
            if (e) {
                if (bInd === 1) {
                    var b = branches[bInd];
                    if (b.tail) {
                        retVal = b.tail;
                        break;
                    }
                }
            } else {
                var b = branches[bInd];
                if (b.tail) {
                    retVal = b.tail;
                    break;
                }
            }
        } else {
            var b = branches[bInd];
            if (b.tail) {
                retVal = b.tail;
                break;
            }
        }
    }

    return retVal;
};

GmCXt.getTail = function(id, playStructure, e, t) {
    if (!id || !playStructure) return false;

    let tail = null;

    for (let i = 0; i < playStructure.length; i++) {

        if (!GmCXt.isEmpty(playStructure[i]) && parseInt(playStructure[i].id) === parseInt(id)) {

            if (playStructure[i].branch) {
                tail = GmCXt.getTailFromBranchStep(playStructure[i].branch, e, id, t);
            } else {
                tail = playStructure[i].tail;
            }

        }
    }
    let sameTail = GmCXt.numberOfSameTail(tail, playStructure);
    if (sameTail > 1) {
        GmCXt.playerI.mergingFromId = id;
    }
    return tail;
};

GmCXt.getPageDomain = function() {
    let d = (GmCXt._location().host.match(/([^.]+)\.\w{2,3}(?:\.\w{2})?$/) || [])[1];
    if (d)
        return d;
    else
        return GmCXt._location().host;
};

GmCXt.getDomain = function(url) {
    if(!url){
        return url;
    }

    url = url.split("/")[0] || '';
    let d = (url.match(/([^.]+)\.\w{2,3}(?:\.\w{2})?$/) || [])[1];
    if (d)
        return d;
    else
        return url;
};

GmCXt.getUrlParam = function() {
    let param = '';
    let temp = GmCXt.urlParts.href.split("?");
    if (temp[1]) {
        param = '?' + temp[1];
    }

    return param;
};

GmCXt.isFQDN = function() {
    let os = GmCXt.getOrgSettings();
    let as = (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization)) ? GmCXt.organization.admin_settings : {};

    if (!GmCXt.isEmpty(os) && os.fqdn) {
        return true;
    } else if (GmCXt.isPlayer() && as.app_switcher === false) {
        return true;
    } else {
        return false;
    }
};

GmCXt.isDomainInActiveApp = function() {
    if (!GmCXt.isFQDN() || GmRootScope.showGuidesFromDesktopApp) {
        return true;
    }

    let domainMatch = false;
    if (!GmCXt.isEmpty(GmCXt.appList) && GmCXt.activeAppId) {
        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];
        let domains = activeApp && activeApp.settings.domains;

        if (activeApp && activeApp.settings && activeApp.settings.sandbox) {
            domainMatch = true;
        } else if (domains) {

            let matchedDomain = GmCXt.getCurrentDomainApp(domains, GmCXt.urlParts.fullUrl);

            if (!GmCXt.isEmpty(matchedDomain)) {
                domainMatch = true;
            }
        }
    }
    return domainMatch;
};

GmCXt.getActiveAppSetting = function() {
    if (GmCXt.isEmpty(GmCXt.appList)) return {};

    let app = GmCXt.appList['app:' + GmCXt.activeAppId];
    if (app && app.settings) {
        return app.settings;
    } else {
        return {};
    }
};

GmCXt.findDomainMatch = function(domainList, fullUrl, oldPathLength) {

    let match = {};

    let url = GmCXt.getHostnameFromUrl(fullUrl);
    url = GmCXt.trimAndLowerCaseURL(url);

    for (let i = 0; i < domainList.length; i++) {
        let appUrl = domainList[i].url;
        appUrl = GmCXt.trimAndLowerCaseURL(appUrl);
        fullUrl = GmCXt.trimAndLowerCaseURL(fullUrl);
        if (appUrl.indexOf('/') >= 0 && fullUrl.indexOf(appUrl) >= 0) {
            let pathLength = (appUrl.match(/\//g) || []).length;
            if (oldPathLength && oldPathLength > pathLength) {
                continue;
            } else {
                match = domainList[i];
                match.pathMatch = true;
                match.pathLength = pathLength;
            }
        } else if (url === appUrl && !oldPathLength) {
            match = domainList[i];
        } else if (appUrl.indexOf("[*.]") > -1) {
            let regExMatch = GmCXt.matchUrlRegEx(appUrl, url);

            if (regExMatch) {
                match = domainList[i];
            }
        }
    }

    return match;
};

GmCXt.getCurrentDomainApp = function(domainList, currUrl, pathLength) {

    if (!domainList) {
        return {};
    }

    if (GmCXt.isElectron()) {
        return GmCXt.getCurrentMyGuideApp(domainList);
    } else {
        return GmCXt.findDomainMatch(domainList, currUrl, pathLength);
    }
};

GmCXt.getCurrentMyGuideApp = function(domainList) {

    let match = {};
    let hostApp = GmCXt.elAppName.toLowerCase();

    for (let i = 0; i < domainList.length; i++) {
        if (domainList[i].appName && (hostApp === domainList[i].appName.toLowerCase())) {
            match = domainList[i];
            break;
        }
    }

    return match;
};

GmCXt.isMirrorApp = function() {
    let isMirrorApp = false;
    if (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization) && GmCXt.organization.has_mirror_apps &&
        parseInt(GmCXt.organization.has_mirror_apps) !== 0) {
        isMirrorApp = true;
    }
    return isMirrorApp;
};

GmCXt.getBaseAppId = function() {
    let baseAppId = GmCXt.activeAppId;
    if (GmCXt.activeAppId && GmCXt.appList && !GmCXt.inPlayer) {
        for (let key in GmCXt.appList) {
            let app = GmCXt.appList[key];
            if (GmCXt.activeAppId === app.application_id &&
                app.base_app_id && parseInt(app.base_app_id) !== 0) {
                baseAppId = app.base_app_id;
                break;
            }
        }
    }
    return baseAppId;
};

GmCXt.checkDomainInApps = function(url) {

    let ob = {
        domainMatch: false,
        appName: false
    };
    let pathLength = false;

    if(GmRootScope.showGuidesFromDesktopApp && GmCXt.activeAppId){
        let app = GmCXt.appList['app:' + GmCXt.activeAppId];
        ob = {
            domainMatch: true,
            appName: app.title,
            appId: app.application_id,
            baseAppId: app.base_app_id
        };
        return ob;
    }

    for (let key in GmCXt.appList) {
        let app = GmCXt.appList[key];
        let domains = app.settings.domains;
        let matchedDomain = GmCXt.getCurrentDomainApp(domains, url, pathLength);

        if (!GmCXt.isEmpty(matchedDomain)) {

            ob = {
                domainMatch: true,
                appName: app.title,
                appId: app.application_id,
                env: matchedDomain.env,
                app_env: matchedDomain.app_env,
                baseAppId: app.base_app_id
            };
        }
        if (matchedDomain.pathLength) {
            pathLength = matchedDomain.pathLength;
        }
    }
    let str = "DOMAIN CHECK. [" + url + "] " + (ob.domainMatch ? "EXISTS" : "DOES NOT EXIST");
    GmCXt.log(1, str, ob);

    return ob;
};

GmCXt.getAppEnvByDomain = function() {

    let activeDomain = GmCXt.checkDomainInApps(GmCXt.urlParts.fullUrl);
    let env;

    if (!GmCXt.isDefined(activeDomain.app_env)) {
        env = 'env_3';
    } else if (GmCXt.isDefined(activeDomain.app_env)) {
        env = activeDomain.app_env;
    }

    GmCXt.log(1, "DOMAIN ENVIRONMENT: " + env);

    return env;
};

GmCXt.updateOrgAndAddSignature = function(str) {

    if (str && GmCXt.containsMedia(str)) {

        if (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization)) {
            let orgId = GmCXt.organization.organization_id;
            str = str.replace(/[-][0-9]*[/]/g, '-' + orgId + '/');
        }

        str = str.replace(/.mp4(.*?)\"/g, '.mp4' + GmCXt.getCdnSign() + '"');
        str = str.replace(/.gif(.*?)\"/g, '.gif' + GmCXt.getCdnSign() + '"');

        str = str.replace(/.png(.*?)\"/g, '.png' + GmCXt.getCdnSign() + '"');
        str = str.replace(/.html(.*?)\"/g, '.html' + GmCXt.getCdnSign() + '"');
        str = str.replace(/.txt(.*?)\"/g, '.txt' + GmCXt.getCdnSign() + '"');
        str = str.replace(/\.pdf(.*?)\"/g, '.pdf' + GmCXt.getCdnSign() + '"');
    }

    return str;
};

GmCXt.containsMedia = function(str) {
    if (str.indexOf('.png') >= 0 ||
        str.indexOf('.gif') >= 0 ||
        str.indexOf('.mp4') >= 0 ||
        str.indexOf('.html') >= 0 ||
        str.indexOf('.txt') >= 0 ||
        str.indexOf('.pdf') >= 0)
        return true;
    else
        return false;
};

GmCXt.getOnPremJsonURL = function() {
    let retUrl = GmCXt.conf.webServiceUrl;
    return retUrl;
};

GmCXt.branchStepExist = function(t) {
    let isBranch = false;

    if (t && t.tour_settings && t.tour_settings.play_structure) {
        t.tour_settings.play_structure.forEach(function(s, key) {
            if (s.branch) {
                isBranch = true;
            }
        });
    }

    return isBranch;
};

GmCXt.branchStepExistInPS = function() {
    let isBranch = false;

    if (GmCXt.playerI.playStructure) {
        GmCXt.playerI.playStructure.forEach(function(s, key) {
            if (s.branch) {
                isBranch = true;
            }
        });
    }

    return isBranch;
};

GmCXt.restartInParent = function(hideLog) {
    if (!hideLog) {
        GmCXt.log(33, "BACK to parent window");
    }
    GmCXt.storage().set({
        'restartInParent': true
    });
};

GmCXt.getSleepTime = function(lbls) {
    let t = 24;

    let nt = GmCXt.getAppSetting('notificationsTime');

    if (nt) {
        t = parseFloat(nt);
        if (t < 1) t = 1;
    }

    let hourString = t > 1 ? lbls.hours : lbls.hour;
    t = t + ' ' + hourString;

    if ((nt && typeof nt !== 'number') && (nt.includes("week") || nt.includes("hour"))) {
        t = nt;
    }

    return t;
};

GmCXt.getIframeAttributes = function(node) {
    let attrs = {};
    mg$.each(node[0].attributes, function(index, attribute) {
        attrs[attribute.name] = attribute.value;
    });

    attrs.isVisible = GmCXt.getElVisibility(node[0], true) === 'visible';

    return attrs;
};

GmCXt.isDomainMatch = function(startURLDomain, stepDomain) {
    return (GmCXt.getDomain(startURLDomain) === GmCXt.getDomain(stepDomain));
};

GmCXt.getDefaultDomain = function(stepURL, tour) {
    let defaultURL = stepURL;
    if (tour.allDomains.length > 0) {
        let allDomains = tour.allDomains;
        for (let i = 0; i < allDomains.length; i++) {
            if (allDomains[i].isDefault) {
                defaultURL = allDomains[i].url;
                break;
            }
        }
    }
    return GmCXt.getHostnameFromUrl(defaultURL);
};

GmCXt.getRedirectUrlForAuto = function(stepURL, tour, startURLDomain) {
    let stepDomain = GmCXt.getHostnameFromUrl(stepURL);
    if (startURLDomain) {
        if (GmCXt.isDomainMatch(startURLDomain, stepDomain)) {
            stepURL = stepURL.replace(stepDomain, startURLDomain);
        }
    }

    // Change this flag to true when multiple domain support is needed.
    let redirectToDefaultDomain = false;
    if (redirectToDefaultDomain) {
        let appDomain = GmCXt.getDefaultDomain(stepURL, tour);
        if (appDomain) {
            stepURL = stepURL.replace(stepDomain, appDomain);
        }
    }
    let completeURL = '';
    if (!stepURL.startsWith('http')) {
        completeURL = location.protocol + '//' + stepURL;
    } else {
        completeURL = stepURL;
    }
    GmCXt.log(33, "REDIRECTING TO URL - ", {
        URL: completeURL
    });
    return completeURL;
};

GmCXt.showDomainNotConfiguredPopup = function(redirectUrl) {
    GmCXt.cleanPlayer();
    GmCXt.auto.destroyAutomation();
    let option = {
        description: GmCXt.label.missingDomainAppConfig,
        button1: GmCXt.label.ok,
        closeTour: true
    };
    GmCXt.alertV2(option).show();
};

GmCXt.changeUrl = function(stepURL, tour, startURLDomain) {
    let redirectUrl = GmCXt.getRedirectUrlForAuto(stepURL, tour, startURLDomain);

    // When redirected by tour player
    if (!startURLDomain) {
        window.location = redirectUrl;
        return;
    }

    // When triggered by Automation
    let source = GmCXt.checkDomainInApps(stepURL);
    let destination = GmCXt.checkDomainInApps(redirectUrl);
    let os = GmCXt.getOrgSettings();

    if (os.fqdn && (!source.domainMatch || !destination.domainMatch)) {

        if (GmCXt.isAutomationRunning()) {

            let errorDomains = '';
            if (!source.domainMatch) {
                errorDomains += 'Source (' + GmCXt.getHostnameFromUrl(stepURL) + ') domain not configured. ';
            }
            if (!destination.domainMatch) {
                errorDomains += 'Destination (' + GmCXt.getHostnameFromUrl(redirectUrl) + ') domain not configured.';
            }

            GmCXt.auto.fail(null, {
                errorMessage: errorDomains
            });
        } else {
            GmCXt.showDomainNotConfiguredPopup(redirectUrl);
        }
    } else {
        window.location = redirectUrl;
    }
};

GmCXt.validateTargetFrame = function(stepFrame, currentFrame) {
    if (!GmCXt.isEmpty(stepFrame) && !GmCXt.isEmpty(currentFrame)) {

        if (!GmCXt.isEmpty(currentFrame.isVisible) && !currentFrame.isVisible) {
            return false; // Current frame not visible
        }

        return GmCXt.compareObjectsByPercentMatch(stepFrame, currentFrame);

    }
    return false;
};

GmCXt.cleanPlayerI = function() {
    GmCXt.tourPlayerI = null;
    GmCXt.playerI = null;
};

GmCXt.cleanPlayer = function() {

    GmCXt.log(33, 'Player instance cleared.');

    if (GmCXt.playerI) {
        GmCXt.trackGuide();
        window.removeEventListener("mouseup", GmCXt.registerClickListner, true);
        window.removeEventListener("mousedown", GmCXt.registerClickListner, true);
        window.removeEventListener("keyup", GmCXt.registerClickListner, true);
        window.removeEventListener("keydown", GmCXt.registerClickListner, true);
    }

    GmCXt.cleanPlayerI();

    GmCXt.storage().set({
        'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': null
    });

    GmCXt.storage().remove(['mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY']);
};

GmCXt.compareAttributes = function(el, topEl) {

    let topElAttrs = GmCXt.getAttributeValues(topEl);
    let elAttrs = GmCXt.getAttributeValues(el);
    let attrsMatch = GmCXt.compareObjectsByPercentMatch(topElAttrs, elAttrs, 100);

    return attrsMatch;
};

GmCXt.filterParentNodes = function(nodes, text) {

    // filter parent nodes retured by "text contains" query.
    var text = text.trim().toLowerCase();

    nodes = nodes.filter(function(index, node) {
        if (node.innerText && node.innerText.trim().toLowerCase() === text) {
            mg$(node).parents().addClass('mgPlayerJSProd_dummy-class');
            return true;
        }
        return false;
    });

    let childNodes = nodes.filter(function(index, node) {
        return !mg$(node).hasClass('mgPlayerJSProd_dummy-class');
    });

    mg$('.mgPlayerJSProd_dummy-class').removeClass('mgPlayerJSProd_dummy-class');

    if (childNodes.length === 1) {
        GmCXt.l.add('All nodes resulting from the query are hierachichally linked (parent-child)');
        return nodes;
    }

    if (childNodes.length === 2 && GmCXt.compareAttributes(nodes[0], nodes[1])) {
        // LXP header has two identical elements placed on top of each other
        if (GmCXt.getElVisibility(nodes[0]) === 'visible') {
            return nodes.slice(0, 1);
        } else if (GmCXt.getElVisibility(nodes[1]) === 'visible') {
            return nodes.slice(1);
        }
    }

    GmCXt.l.add('Text is present at multiple places on the screen');
    return [];
};

GmCXt.getElectronAppName = function() {
    let app = require('electron').remote.app;
    return app.name || app.getName();
};

GmCXt.getErrObj = function(msg, data, isAnalytics) {
    let code = isAnalytics ? data.code : parseInt(data.code);

    if (msg[0] && msg[0].message) {
        msg = msg[0].message;
    }

    if (typeof data.info === "string") {
        msg += " : " + data.info;
    }

    let eObj = {
        build: GmCXt.conf.appName,
        version: GmCXt.conf.version,
        type: 'CODE ERROR',
        code: code,
        message: msg,
        browser: GmCXt.browserApp
    };

    if (!GmCXt.isBackgroundPage) {
        eObj.current_url = GmCXt.urlParts.fullUrl;
    } else {
        eObj.current_url = '';
    }

    if (data.info.apiUrl) {
        eObj.type = "Insights";
        eObj.message += " , api: " + data.info.apiUrl;

        if (data.apiData)
            eObj.apiData = JSON.stringify(data.apiData);
    }

    if (GmCXt.user && GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization)) {
        eObj.organization_id = GmCXt.organization.organization_id;
        eObj.organization_name = GmCXt.organization.name;
        eObj.application_id = GmCXt.activeAppId;
        eObj.user_id = GmCXt.user.user_id;
        eObj.user_email = GmCXt.user.user_email;
    }
    return eObj;
};

// Elements might have classes like 'mgPlayerJSProd_select-outline' or 'mgPlayerJSProd_dummy-class'
GmCXt.checkMyGuideClass = function(className) {

    let mgClass = false;
    if (className && typeof className === 'string') {
        let arrClass = className.split(/\s+/).filter(Boolean);
        mgClass = arrClass.filter(function(cls) {
            return cls.indexOf('mgPlayerJSProd_') === 0;
        })[0];
    }
    return mgClass;
};

GmCXt.hasMyGuideEl = function(nodes) {
    if (nodes) {
        for (let i = 0; i < nodes.length; i++) {
            if (GmCXt.checkMyGuideClass(nodes[i].className)) {
                return true;
            }
        }
    }
    return false;
};

GmCXt.sortToursByModifcationDate = function(tours) {
    return tours.sort(function(a, b) {
        return parseInt(b.modification_date) - parseInt(a.modification_date);
    });
};

GmCXt.getFontFile = function() {
    let i = 'common/lib/fonts/';
    if (GmCXt.isExtension()) {
        i = GmCXt.getBrowserUrl(i);
    } else {
        i = GmCXt.conf.baseUrl + i;
    }

    return i;
};

GmCXt.getCustomFontStyle = function() {
    let styleElem = document.getElementById('mgPlayerJSProd_nunito-font-style');
    if (!GmCXt.isEmpty(styleElem)) styleElem.remove();

    let newStyle = document.createElement('style');
    newStyle.id = "mgPlayerJSProd_nunito-font-style";
    var FontName = "Nunito";
    var FontUrl = GmCXt.getFontFile() + "Nunito-Regular.woff";
    newStyle.appendChild(document.createTextNode("@font-face { font-family: '" + FontName + "'; src: url('" + FontUrl + "') format('woff');}"));

    var FontName = "Calibri";
    var FontUrl = GmCXt.getFontFile() + "Calibri-Regular.woff";
    newStyle.appendChild(document.createTextNode("@font-face { font-family: '" + FontName + "'; src: url('" + FontUrl + "') format('woff');}"));

    var FontName = "Frutiger";
    var FontUrl = GmCXt.getFontFile() + "Frutiger.woff";
    newStyle.appendChild(document.createTextNode("@font-face { font-family: '" + FontName + "'; src: url('" + FontUrl + "') format('woff');}"));

    return newStyle;
};

GmCXt.isUrlValid = function(userInput) {
    if (GmCXt.isEmpty(userInput)) return true;
    let res = userInput.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);
    if (res == null)
        return false;
    else
        return true;
};

GmCXt.getURLMediaType = function(url) {
    if (!GmCXt.isUrlValid(url)) return false;

    if (url.search(/^http[s]?\:\/\//) === -1) {
        url = 'https://' + url;
    }

    let ext = url.split('/').pop().match(/^[\w\s-,.]+\.([a-zA-Z0-9]{3,4})/);
    if (ext) {
        ext = ext[1];
    }

    url = new URL(url);
    let mediaType = "";
    if (ext && GmCXt.videoFileExtns.indexOf("." + ext) !== -1) {
        mediaType = "video";
    } else if (ext === "pdf") {
        mediaType = "pdf";
    }

    return mediaType;
};

GmCXt.attachDragEvents = function(elmnt, dragEl) {
    let pos1 = 0,
        pos2 = 0,
        pos3 = 0,
        pos4 = 0;
    dragEl.onmousedown = dragMouseDown;
    dragEl.onmouseup = dragMouseUp;

    if (window.matchMedia("(max-width: 480px)").matches) {
        dragEl.ontouchstart = dragMouseDown;
        dragEl.ontouchend = dragMouseUp;
    }

    function resetDragEvents() {
        document.onmouseup = null;
        document.onmousemove = null;
        document.onmouseout = null;

        if (window.matchMedia("(max-width: 480px)").matches) {
            document.ontouchstart = null;
            document.ontouchmove = null;
            document.ontouchend = null;
        }
    }

    function dragMouseUp(e) {
        resetDragEvents();

        if (GmCXt.isMicroPlayer()) {
            mg$("#mgPlayerJSProd_micro_player_drag .mgPlayerJSProd_title-tooltip-wrapper").removeAttr("style");
        }
    }

    function dragOutEvent(e) {
        GmCXt.timeout(function() {
            mg$('.mgPlayerJSProd_slideshow_drag_over').hide();
        }, GmCXt.t.drag);

        if (dragEl.id === 'mgPlayerJSProd_mPlayer-drag') {
            resetDragEvents();
        }
    }

    function dragMouseDown(e) {
        e.preventDefault();
        e = e || window.event;
        // get the mouse cursor position at startup:
        if (window.matchMedia("(max-width: 480px)").matches) {
            e.clientX = e.targetTouches[0].clientX;
            e.clientY = e.targetTouches[0].clientY;
        }

        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmouseout = dragOutEvent;
        // call a function whenever the cursor moves:
        document.onmousemove = elementDrag;

        if (window.matchMedia("(max-width: 480px)").matches) {
            document.ontouchend = closeDragElement;
            document.ontouchcancel = dragOutEvent;
            document.ontouchmove = elementDrag;
        }

        if (GmCXt.isMicroPlayer()) {
            mg$("#mgPlayerJSProd_micro_player_drag .mgPlayerJSProd_title-tooltip-wrapper").css("display", "none");
        }
    }

    function elementDrag(e) {
        mg$('.mgPlayerJSProd_slideshow_drag_over').show();
        e = e || window.event;
        // calculate the new cursor position:
        let wWdth = mg$(window).width();
        let wHgth = mg$(window).height();
        let offset = 50;

        if (window.matchMedia("(max-width: 480px)").matches) {
            e.clientX = e.targetTouches[0].clientX;
            e.clientY = e.targetTouches[0].clientY;
        }

        if (e.clientX > offset && e.clientY > offset && e.clientX < (wWdth - offset) && e.clientY < (wHgth - offset)) {
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";

            if (GmCXt.isMicroPlayer()) {
                elmnt.style.right = "initial";
                elmnt.style.transition = "initial";
            }

            if (!GmCXt.isMicroPlayer()) {
                mg$(elmnt)
                    .removeClass('top-left')
                    .removeClass('top-middle')
                    .removeClass('top-right')
                    .removeClass('right-top')
                    .removeClass('right-middle')
                    .removeClass('right-bottom')
                    .removeClass('bottom-left')
                    .removeClass('bottom-middle')
                    .removeClass('bottom-right')
                    .removeClass('left-top')
                    .removeClass('left-middle')
                    .removeClass('left-bottom');
            }
        }
    }

    function closeDragElement() {
        /* stop moving when mouse button is released:*/
        resetDragEvents();

        mg$('.mgPlayerJSProd_slideshow_drag_over').hide();
    }
};

GmCXt.isDefaultIcon = function(str) {
    if (str &&
        (str.indexOf('edcast.png') >= 0 ||
            str.indexOf('guidemeg.png') >= 0 ||
            str.indexOf('widget_icon.png') >= 0 ||
            str.indexOf('chat_bot_icon.png') >= 0 ||
            str.indexOf('default') >= 0 ||
            str.indexOf('myguide.png') >= 0
        )) {
        return true;
    } else {
        return false;
    }
};

GmCXt.syncPlayerInst = function(m) {
    if (m === "mgPlayerJSProd_action:started;task:select_existing_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:select_existing_dom_element:target_frame_only" ||
        m === "mgPlayerJSProd_action:started;task:select_dom_element_tooltips" ||
        m === "mgPlayerJSProd_action:task:init_new_iframe" ||
        m === "mgPlayerJSProd_action:update_player_instance" ||
        m === "mgPlayerJSProd_action:update_player_instance_app" ||
        m === "mgPlayerJSProd_action:set_audio_mode_off" ||
        m === "mgPlayerJSProd_action:set_audio_mode_on" ||
        m === "mgPlayerJSProd_action:close_guide" ||
        m === "mgPlayerJSProd_action:set_style_audio_icon_response") {
        return true;
    } else {
        return false;
    }
};

GmCXt.syncCreateInst = function(m) {
    if (m === "mgPlayerJSProd_action:started;task:highlight_element" ||
        m === "mgPlayerJSProd_action:started;task:edit_step_select_existing_dom_element" ||
        m === "mgPlayerJSProd_action:completed;task:edit_step_select_existing_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:edit_step_select_existing_dom_element:target_frame_only" ||
        m === "mgPlayerJSProd_action:started;task:select_new_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:select_new_dom_element_for_edit_step" ||
        m === "mgPlayerJSProd_action:started;task:narrow_element_selection" ||
        m === "mgPlayerJSProd_action:started;task:expand_element_selection" ||
        m === "mgPlayerJSProd_action:started;task:select_element_for_message_step" ||
        m === "mgPlayerJSProd_action:started;task:select_element_for_branching_step" ||
        m === "mgPlayerJSProd_action:started;task:select_new_element_for_dom_select_rule" ||
        m === "mgPlayerJSProd_action:started;task:select_new_table_for_dom_select_rule" ||
        m === "mgPlayerJSProd_action:started;task:delete_element_for_message_step" ||
        m === "mgPlayerJSProd_action:started;task:select_dom_element_for_beacon" ||
        m === "mgPlayerJSProd_action:started;task:blackout_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:edit_message_step_select_existing_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:step_blackout_area_existing_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element" ||
        m === "mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element:target_frame_only" ||
        m === "mgPlayerJSProd_action:started:select_new_dom_element_for_smart_tip" ||
        m === "mgPlayerJSProd_action:find_element_to_get_precision" ||
        m === "mgPlayerJSProd_action:find_element_to_get_precision_for_rules" ||
        m === "mgPlayerJSProd_action:started;task:select_dom_element_for_matching_in_rules" ||
        m === "mgPlayerJSProd_action:do;task:enable_jQuery_selector" ||
        m === "mgPlayerJSProd_action:started;task:edit_tag_select_existing_dom_element") {
        return true;
    } else {
        return false;
    }
};

GmCXt.setAutoTour = function(id) {
    if (window.self === window.top) {
        localStorage.setItem(GmCXt.storagePrefix + 'autoLaunchTour', id);
    } else {
        let data = {
            tourId: id
        };
        if (GmCXt.isSidePanelApp) {
            let m = {
                action: "mgPlayerJSProd_action:set_auto_tour"
            };
            m.data = data;
            GmCXt.sendToParentWindow(m);
        } else {
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:set_auto_tour', data);
        }
    }
};

GmCXt.getPreviousStep = function() {
    if (GmCXt.playerI) {
        let previousStepId = GmCXt.getPreviousStepId(GmCXt.playerI.currentStepId);
        if (previousStepId) {
            let step = GmCXt.createDeepCopy(GmCXt.getStepFromPlayerI(previousStepId));
            return step;
        } else {
            return null;
        }
    } else {
        return null;
    }
};

GmCXt.getPreviousStepId = function(id, mode) {
    let previousStepId = null;
    let PS = GmCXt.playerI.playStructure;
    let sameTail = GmCXt.numberOfSameTail(id, PS);
    if (sameTail > 1) {
        previousStepId = GmCXt.playerI.mergingFromId;
    } else {
        if (PS && PS.length) {
            for (let i = 0; i < PS.length; i++) {
                if (PS[i] && parseInt(PS[i].tail) === parseInt(id)) {
                    previousStepId = PS[i].id;
                    break;
                } else if (PS[i] && PS[i].branch) {
                    for (let j = 0; j < PS[i].branch.length; j++) {
                        if (parseInt(PS[i].branch[j].tail) === id) {

                            if (mode === 'slideshow') previousStepId = PS[i].id;
                            else previousStepId = GmCXt.getPreviousStepId(PS[i].id);

                            break;
                        }
                    }
                }
            }
        }
    }
    return previousStepId;
};

GmCXt.getPreviousStepsList = function(id) {
    let previousSteps = [];
    let PS = GmCXt.playerI.tour.tour_settings.play_structure;

    if (PS && PS.length) {
        for (let i = 0; i < PS.length; i++) {
            if (PS[i] && parseInt(PS[i].tail) === parseInt(id)) {
                previousSteps.push(PS[i].id);
            } else if (PS[i] && PS[i].branch) {
                for (let j = 0; j < PS[i].branch.length; j++) {
                    if (parseInt(PS[i].branch[j].tail) === id) {
                        previousSteps.push(PS[i].id);
                    }
                }
            }
        }
    }
    return previousSteps;
};

GmCXt.getFirstStepId = function() {
    let id = null;
    let playStructure = GmCXt.playerI.playStructure;

    if (playStructure && playStructure.length) {
        let firstStepObj = playStructure[0];
        if (firstStepObj && firstStepObj.id) {
            id = firstStepObj.id;
        }
    }
    return id;
};

//Always extract/extend data returned by this function before use.
GmCXt.getStepFromPlayerI = function(step_id) {
    let step = false;
    var steps = [];

    var steps = GmCXt.playerI.tour.steps;

    for (let i = 0; i < steps.length; i++) {
        if (parseInt(steps[i].step_id) === parseInt(step_id)) {
            step = steps[i];
            break;
        }
    }
    return step;
};

GmCXt.getStepFromTourData = function(step_id, tour) {
    let step = false;
    var steps = [];

    var steps = tour.steps;

    for (let i = 0; i < steps.length; i++) {
        if (parseInt(steps[i].step_id) === parseInt(step_id)) {
            step = steps[i];
            break;
        }
    }
    return step;
};

GmCXt.getNextBotStepFromTour = function(step_id, tour) {
    let step = false;
    let steps = tour.steps;

    for (let i = 0; i < steps.length; i++) {
        if (parseInt(steps[i].step_id) === parseInt(step_id)) {
            if ((steps[i].step_settings.automation.enableBot &&
                    steps[i].step_settings.automation.botQuestion) ||
                (steps[i].step_type === GmCXt.STEP_TYPE_GUIDE ||
                    steps[i].step_type === GmCXt.STEP_TYPE_BRANCH ||
                    steps[i].step_type === "textSlide")) {
                step = steps[i];
                break;
            } else {
                step_id = GmCXt.getTail(steps[i].step_id, tour.tour_settings.play_structure, null, tour);
                GmCXt.getNextBotStepFromTour(step_id, tour);
            }
        }
    }
    return step;
};

GmCXt.isGuideAudioDisabled = function() {

    if (!GmCXt.isEmpty(GmCXt.playerI) && !GmCXt.isEmpty(GmCXt.playerI.tour)) {
        let s = GmCXt.playerI.tour.tour_settings;
        let val = s.disableAudio;

        return typeof val === 'undefined' ? false : val;
    } else {
        return false;
    }
};

GmCXt.getGlobalAudioPrference = function() {
    let val = GmCXt.getStepSettings().playAudio;
    return typeof val === 'undefined' ? true : val;
};

GmCXt.getAudioPreference = function(pref) {

    let flag = false;
    let userPref = (pref === undefined || pref === true);

    if (GmCXt.getGlobalAudioPrference()) {

        if (!GmCXt.isGuideAudioDisabled()) {

            if (userPref) flag = true;
        }

    } else if (GmCXt.isGuideAudioEnabled()) {
        if (userPref) flag = true;
    }
    return flag;
};

GmCXt.isGuideAudioEnabled = function() {

    let s = GmCXt.playerI.tour.tour_settings;
    let val = s.enableAudio;

    return typeof val === 'undefined' ? true : val;
};

GmCXt.isLastStep = function(stepId, playStructure) {

    let flag = false;

    if (GmCXt.getTail(stepId, playStructure) === null) {
        flag = true;
    }
    return flag;
};

GmCXt.isFirstStep = function(sid) {

    if (!GmCXt.playerI) return false;

    let stepId = sid || GmCXt.playerI.currentStepId;

    // TODO, need to check behaviour when first step of tour in branch step
    if (stepId && GmCXt.playerI.tour) {
        let PS = GmCXt.getGuidePlayStructure(GmCXt.playerI.tour);

        if (PS && PS[0]) {
            let first = PS[0];

            if (first.id === stepId) {
                return true;
            }
        }
    }

    return false;
};

GmCXt.getFirstNonAutomationStep = function() {
    let id = null;
    let playStructure = GmCXt.getGuidePlayStructure(GmCXt.playerI.tour);
    if (playStructure) {
        for (let i = 0; i < playStructure.length; i++) {
            let stepObj = playStructure[i];
            if (stepObj && stepObj.id) {
                id = stepObj.id;
            }
            let step = GmCXt.getStepFromPlayerI(id);
            if (!GmCXt.isAutomationStep(step)) {
                return step;
            }
        }
    }
};

GmCXt.isFirstNonAutomationStep = function() {
    if (!GmCXt.playerI) return false;

    if (GmCXt.playerI.currentStepId && GmCXt.playerI.tour) {
        let s = GmCXt.getFirstNonAutomationStep();
        if (s && (s.step_id === GmCXt.playerI.currentStepId)) {
            return true;
        }
    }
    return false;
};

GmCXt.filterOutAutomationSteps = function(steps) {
    return steps.filter(function(s) {
        return (!GmCXt.isAutomationStep(s));
    });
};

GmCXt.initGlobals = function(action, data) {

    if (data) {

        if (data.debugMode) GmCXt.debugMode = data.debugMode;

        if (data.urlParts) GmCXt.urlParts = data.urlParts;

        if (GmCXt.syncCreateInst(action)) {
            if (window.self !== window.top) {
                if (data.stepReq || data.stepReq === null) {
                    GmCXt.stepReq = data.stepReq;
                }
            } else {
                if (GmCXt.stepReq && data.syncStepReq) {
                    GmCXt.stepReq = data.stepReq;
                }
            }
        }
        if (GmCXt.syncPlayerInst(action)) {
            if (window.self !== window.top) {
                if (data.playerInstance || data.playerInstance === null) {
                    GmCXt.playerI = data.playerInstance;
                }
            } else if (data.playerInstance && data.fromSidePanel) {
                GmCXt.playerI = data.playerInstance;
            }
        }
    }
};

GmCXt.verifyMsg = function(event) {
    if (mg$(window).width() <= 1 || mg$(window).height() <= 1) {
        return false;
    }

    event.data = GmCXt.parseJSON(event.data);
    event.data = GmCXt.convertMgdata(event.data);

    let message = event.data;
    let action = message ? message.action : '';

    GmCXt.log(3, "VERIFY MESSAGE " + action);
    if (!message || !action) return false;

    if (action && action.indexOf('MyGuideReporting:Ack') !== -1 &&
        message.data === GmCXt.getAppName()) {
        return; //Reject acknowledgement from self
    }

    if (action && action.indexOf('MyGuideReporting') !== -1) {
        GmCXt.saveAppPresence(message);
    }

    let valid = false;
    let data = message.data;

    let fromSelf = (action.indexOf('mgPlayerJSProd_action:') !== -1);

    // for salesforce and service now app backword compatibility
    if (action === "gmPlayerXt_action:init_snow" ||
        action === "myguide_action:find_element_request_from_insight" ||
        action === "myguide_action:paste_tour_from_myguide_library" ||
        action === "gmPlayerXt_action:snow_panel_open") {
        fromSelf = true;
    }

    if (fromSelf) {
        if (message && message.data && message.data.sender === "other") {
            delete message.data.organization;
            delete message.data.user;
        }
        GmCXt.initGlobalUser(message);
        GmCXt.initGlobals(action, data);
        valid = true;
    }

    return valid;
};

GmCXt.initGlobalUser = function(m) {
    if (m.data && (window.self !== window.top || m.data.fromSidePanel)) {
        if (m.data.user && !GmCXt.isEmpty(m.data.user)) {
            GmCXt.updateGlobalUser(m.data.user);
        }
    }
};

GmCXt.toastMsg = function(message) {

    let self = {
        message: message || 'Default message'
    };

    return {
        show: function() {
            mg$("#mgPlayerJSProd_toast_msg").remove();

            let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_toast-msg' id='mgPlayerJSProd_toast_msg'></wmgPlayerJSProd_>";
            if (GmCXt.browserApp === 'ie') {
                mg$("body").append(html);
            } else {
                mg$("html").append(html);
            }

            mg$("#mgPlayerJSProd_toast_msg").html(self.message);
            mg$("#mgPlayerJSProd_toast_msg").fadeIn();
            GmCXt.timeout(function() {
                mg$('#mgPlayerJSProd_toast_msg').fadeOut(500);
            }, GmCXt.t.toastMsg);
        }
    };
};

GmCXt.showToastMsg = function(message) {
    mg$("#mgPlayerJSProd_toast_msg").html(message);
    mg$("#mgPlayerJSProd_toast_msg").fadeIn();
};

GmCXt.hideToastMsg = function() {
    mg$('#mgPlayerJSProd_toast_msg').fadeOut(100);
};

GmCXt.toastMsgPersistent = function(message) {
    return {
        show: function() {
            let htmlstr = "<wmgPlayerJSProd_ class='mgPlayerJSProd_toast-msg-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_toast-msg-close' id='mgPlayerJSProd_toast_msg_close' >x</wmgPlayerJSProd_>";
            htmlstr += "<wmgPlayerJSProd_ id='mgPlayerJSProd_toast_msg_text' class='mgPlayerJSProd_toast-msg-text' >" + message + "</wmgPlayerJSProd_></wmgPlayerJSProd_>";
            mg$("#mgPlayerJSProd_toast_msg").html(htmlstr);
            mg$("#mgPlayerJSProd_toast_msg").fadeIn();

            mg$("#mgPlayerJSProd_toast_msg_close").click(function() {
                GmCXt.toastMsgPersistent().hide();
            });
        },
        hide: function() {
            mg$('#mgPlayerJSProd_toast_msg').fadeOut(500);
        }
    };
};

GmCXt.clearScreen = function() {
    mg$('.mgPlayerJSProd_inline-step-capture-screen').remove();
};

GmCXt.stopEventPropagation = function(e) {
    e.stopPropagation();
    e.stopImmediatePropagation();
};

GmCXt.unlockScroll = function() {
    mg$('html').css('overflow', '');
};

GmCXt.getStepSortedByPS = function(PS, stepId) {

    let steps = [];

    let firstStep;
    if (stepId) {
        firstStep = GmCXt.getStepFromPlayerI(stepId);
    } else {
        firstStep = GmCXt.getStepFromPlayerI(PS[0].id);
    }

    steps.push(firstStep);

    let seedStepID = firstStep.step_id;
    if (firstStep.step_type !== GmCXt.STEP_TYPE_BRANCH || !stepId) {
        for (let i = 0; i < PS.length; i++) {
            let nextStepId = GmCXt.getTail(seedStepID, PS);
            if (nextStepId) {
                stepToPush = GmCXt.getStepFromPlayerI(nextStepId);
                if (stepToPush) {
                    seedStepID = stepToPush.step_id;
                    steps.push(stepToPush);
                    if (stepToPush.step_type === GmCXt.STEP_TYPE_BRANCH &&
                        stepToPush.step_id !== GmCXt.playerI.currentStepId) {
                        break;
                    }
                } else {
                    break;
                }

            } else {
                break;
            }
        }
    }
    return steps;
};

GmCXt.arrayToObjectNot = function(tours) {
    let tempObj = {};
    for (let key in tours) {
        if (tours[key]) tempObj[tours[key]] = 1;
    }
    return tempObj;
};

GmCXt.escapeHtml = function(str) {
    if (str) {
        str = str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    return str;
};

GmCXt.removeNotif = function() {
    mg$(".mgPlayerJSProd_overlay-tours-popup").remove();
    mg$(".mgPlayerJSProd_overlay-container").remove();
};

GmCXt.getObjectSize = function(obj) {
    let size = 0,
        key;
    for (key in obj) {
        if (obj.hasOwnProperty(key))
            size++;
    }
    return size;
};

GmCXt.updatePlayedSteps = function(step) {
    GmRootScope.setPlayedStepsInfo(step);
};

GmCXt.lastCheckWidgetIcon = 0;

GmCXt.getWidgetIcon = function() {

    return new Promise(function(resolve, reject) {

        let i = 'common/img/widget_icon.png';

        i = GmCXt.getBasePath(i);

        let s = GmCXt.getWidgetSettings();

        if (s && s.widget_icon_path && !GmCXt.isDefaultIcon(s.widget_icon_path)) {
            i = GmCXt.restoreAssetSrc(s.widget_icon_path);
        }

        //check if widgetIcon needs to get new signature.
        let isSignExp = (GmCXt.getCurrentTimeInMilSec() - GmCXt.lastCheckWidgetIcon > GmCXt.t.refreshWidget) ? true : false;

        resolve(i);
    });
};

GmCXt.getChatIcon = function() {

    return new Promise(function(resolve, reject) {
        let i = GmCXt.conf.staticContentPath + "chat_bot_icon.png";

        let s = GmCXt.getAppSetting();

        if (s && s.chat_icon_path && !GmCXt.isDefaultIcon(s.chat_icon_path)) {
            i = GmCXt.restoreAssetSrc(s.chat_icon_path);
        }

        //check if widgetIcon needs to get new signature.
        let isSignExp = (GmCXt.getCurrentTimeInMilSec() - GmCXt.lastCheckWidgetIcon > GmCXt.t.refreshWidget) ? true : false;

        resolve(i);
    });
};

GmCXt.getWidgetAlignment = function() {
    let alignment = "right";
    return alignment;
};

GmCXt.visibleWindow = function(data) {
    if (data.checkIframe) {
        if (!GmCXt.isEmpty(data.frame.attributes) &&
            !data.frame.attributes.isVisible) {
            return false;
        }
    }
    return true;
};

GmCXt.getSteps = function(data) {

    return new Promise(function(resolve, reject) {
        GmCXt.api.getDetailTour(data).then(function(_tour) {
            if (GmCXt.inPlayer && GmRootScope.notDefaultLang() && _tour) {
                _tour = GmRootScope.getTranslatedTourAndSteps(_tour, GmRootScope.language);
            }
            resolve(_tour);
        });
    });
};

GmCXt.updatePlayStructureLinkGuide = function(tour, playerInstance, cb) {

    let linkPS = GmCXt.getGuidePlayStructure(tour);

    let pi;
    if (GmCXt.playerI) {
        pi = GmCXt.playerI;
    } else if (playerInstance) {
        pi = playerInstance;
    }

    let tailCurrent = linkPS[0].id;
    let PS = pi.playStructure;
    let isFirstStepLink = false;

    for (let i = 0; i < PS.length; i++) {
        if (PS[i].tail === pi.currentStepId) {
            PS[i].tail = tailCurrent;
        } else if (PS[i].branch) {
            for (let j = 0; j < PS[i].branch.length; j++) {
                if (PS[i].branch[j].tail === pi.currentStepId) {
                    PS[i].branch[j].tail = tailCurrent;
                }
            }
        }
        if (PS[i].id === pi.currentStepId) {
            linkPS = GmCXt.updatePSLastTail(linkPS, PS[i].tail);
            PS[i].tail = null;
            if (i === 0) {
                isFirstStepLink = true;
            }
        }
    }

    pi.linkGuideFS = linkPS[0].id;

    if (isFirstStepLink) {
        PS[0] = linkPS[0];
        linkPS.splice(0, 1);
        pi.startStepId = PS[0].id;
    }

    let finalPS = mg$.extend([], PS.concat(linkPS));
    if (pi.type === GmCXt.TOUR_PLAYER_SLIDESHOW) {
        GmCXt.playerI = pi;
        GmCXt.playerI.playStructure = finalPS;
    } else if (playerInstance && !GmCXt.playerI) {
        if (cb) cb(finalPS);
    } else {
        GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_PS_done'].cb(finalPS);
    }
};

GmCXt.updatePSLastTail = function(PS, tail) {
    for (let i = 0; i < PS.length; i++) {
        if (PS[i].branch) {
            for (let j = 0; j < PS[i].branch.length; j++) {
                if (PS[i].branch[j].tail === null) {
                    PS[i].branch[j].tail = tail;
                }
            }
        } else if (PS[i].tail === null) {
            PS[i].tail = tail;
        }
    }
    return PS;
};

GmCXt.concatLinkGuideSteps = function(newSteps, tour, step_id, cb) {

    let guideStepIndex;
    if (tour && step_id) {
        guideStepIndex = GmCXt.getCurrentStepIndex(tour, step_id);
    } else {
        guideStepIndex = GmCXt.getCurrentStepIndex();
    }

    let steps = [];
    if (tour) {
        steps = mg$.extend([], tour.steps);
    } else {
        steps = mg$.extend([], GmCXt.playerI.tour.steps);
    }

    if (tour && step_id) {
        steps = steps.filter(function(step, i) {
            return step.step_id !== step_id;
        });
    } else {
        steps = steps.filter(function(step, i) {
            return step.step_id !== GmCXt.playerI.currentStepId;
        });
    }

    steps.splice.apply(steps, [guideStepIndex, 0].concat(newSteps));
    if (GmCXt.playerI) {
        if (GmCXt.playerI.type === GmCXt.TOUR_PLAYER_SLIDESHOW) {
            GmCXt.playerI.tour.steps = steps;
        } else {
            GmCXt.sendMessageToParentWindow("mgPlayerJSProd_action:update_PI_steps", steps);
        }
        GmCXt.playerI.totalStepCount = steps.length;
        GmCXt.playerI.tour.step_count = steps.length;
    } else {
        if (cb) cb(steps);
    }
};

GmCXt.stopNotification = function(isPreview) {
    let flag = false;
    let reason = '';

    if (!GmCXt.isPlayer() && !isPreview) {
        reason = "app is not a player";
        flag = true;
    } else if (mg$('.mgPlayerJSProd_image-step-screen').is(':visible') || mg$('.mgPlayerJSProd_preview-step-popup-container').is(':visible')) {
        reason = "step is playing";
        flag = true;
    } else if (mg$('.mgPlayerJSProd_user-guide-container').is(':visible')) {
        reason = "survey is open";
        flag = true;
    } else if (mg$('.mgPlayerJSProd_notifcation-popup').is(':visible')) {
        reason = "org notification";
        flag = true;
    } else if (mg$('.mgPlayerJSProd_slideshow-panel').is(':visible')) {
        reason = "slideshow playing";
        flag = true;
    } else if (mg$('.mgPlayerJSProd_play-pause-toolbar').is(':visible')) {
        reason = "pause guide";
        flag = true;
    } else if (GmCXt.APP_PANEL_OPEN && !isPreview && !GmCXt.getAppSetting('keep_player_panel_open')) {
        reason = "side panel open";
        flag = true;
    } else if (GmCXt.playerI) {
        reason = "tour is active";
        flag = true;
    } else if (!GmCXt.isEmpty(GmCXt.testMe)) {
        reason = "test me active";
        flag = true;
    }

    if (flag) {
        GmCXt.log(10, "STOP notification because " + reason);
    }
    return flag;
};

GmCXt.checkSalesForceSite = function() {
    let url = GmCXt.getUrl();
    if (url.indexOf('salesforce.com') > 0 || url.indexOf('lightning.force.com') > 0)
        return true;
    else
        return false;
};

GmCXt.checkWorkdaySite = function() {
    let url = GmCXt.getUrl();
    if (url.indexOf('workday.com') > 0)
        return true;
    else
        return false;
};

GmCXt.checkUBS = function() {
    let url = GmCXt.getUrl();
    if (url.indexOf('ubs.net') > -1 || url.indexOf('pwj.com') > -1)
        return true;
    else
        return false;
};

GmCXt.checkServiceNow = function() {
    let url = GmCXt.getUrl();
    if (url.indexOf('service-now.com') > -1)
        return true;
    else
        return false;
};

GmCXt.getCurrentStep = function(stepId) {

    let step = mg$.extend({}, GmCXt.getStepFromPlayerI(stepId));

    if (!step.step_description) step.step_description = " ";

    // Map properties
    step.image_url = step.image_url + GmCXt.getCdnSign();
    step.screen_url = step.screen_url + GmCXt.getCdnSign();

    return step;
};

GmCXt.getNextStep = function() {
    if (GmCXt.playerI) {
        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let nextStepId = GmCXt.getTail(step.step_id, GmCXt.playerI.playStructure);

        if (nextStepId) {
            return GmCXt.getStepFromPlayerI(nextStepId);
        } else {
            return null;
        }
    } else {
        return null;
    }
};

GmCXt.getProcessedLang = function(l) {
    let langList = {
        'ar': 'ar-SA',
        'ar-EG': 'ar-EG',
        'ar-SA': 'ar-SA',
        'zh': 'zh-CN',
        'zh-HK': 'zh-HK',
        'zh-CN': 'zh-CN',
        'zh-TW': 'zh-TW',
        'zh-Hant': 'zh-TW',
        'cs': 'cs-CZ',
        'cs-CZ': 'cs-CZ',
        'da': 'da-DK',
        'da-DK': 'da-DK',
        'nl': 'nl-NL',
        'nl-NL': 'nl-NL',
        'en': '',
        'fi': 'fi-FI',
        'fi-FI': 'fi-FI',
        'fr': 'fr-FR',
        'fr-FR': 'fr-FR',
        'fr-CH': 'fr-CH',
        'fr-CA': 'fr-CA',
        'de': 'de-DE',
        'de-AT': 'de-AT',
        'de-DE': 'de-DE',
        'de-CH': 'de-CH',
        'el': 'el-GR',
        'el-GR': 'el-GR',
        'he': 'he-IL',
        'he-IL': 'he-IL',
        'hi': 'hi-IN',
        'hi-IN': 'hi-IN',
        'hu': 'hu-HU',
        'hu-HU': 'hu-HU',
        'id': 'id-ID',
        'id-ID': 'id-ID',
        'it': 'it-IT',
        'it-IT': 'it-IT',
        'ja': 'ja-JP',
        'ja-JP': 'ja-JP',
        'ko': 'ko-KR',
        'ko-KR': 'ko-KR',
        'pl': 'pl-PL',
        'pl-PL': 'pl-PL',
        'pt': 'pt-PT',
        'pt-PT': 'pt-PT',
        'pt-BR': 'pt-BR',
        'ro': 'ro-RO',
        'ro-RO': 'ro-RO',
        'ru': 'ru-RU',
        'ru-RU': 'ru-RU',
        'sk': 'sk-SK',
        'sk-SK': 'sk-SK',
        'es': 'es-ES',
        'es-ES': 'es-ES',
        'es-MX': 'es-MX',
        'sv': 'sv-SE',
        'sv-SE': 'sv-SE',
        'ta': 'ta-IN',
        'ta-IN': 'ta-IN',
        'te': 'te-IN',
        'te-IN': 'te-IN',
        'th': 'th-TH',
        'th-TH': 'th-TH',
        'tr': 'tr-TR',
        'tr-TR': 'tr-TR',
        'vi': 'vi-VN',
        'vi-VN': 'vi-VN'
    };

    let lang = langList[l];

    if (lang)
        return lang;
    else
        return 'en-US';
};

GmCXt.parseMsg = function(e) {

    e = mg$.extend({}, e);
    e.data = GmCXt.parseJSON(e.data);
    GmCXt.log(3, "PARSE MESSAGE " + e.data.action);
    return e.data;
};

GmCXt.browserLang = GmCXt.getProcessedLang(window.navigator.language);

GmCXt.checkLangExist = function(lArr, lang) {
    let retVal = false;

    if (lArr && !GmCXt.isFalse(lang)) {

        for (let i = 0; i < lArr.length; i++) {
            if (lArr[i].language === lang) {
                retVal = true;
                break;
            }
        }
    }

    return retVal;
};

GmCXt.removePreviewFrame = function() {

    mg$('.mgPlayerJSProd_preview-beacon').remove();
    mg$('.mgPlayerJSProd_preview-smarttip').remove();
    mg$('.gssSmarttip-form-submit').removeClass('mgPlayerJSProd_form-submit-preview gssSmarttip-form-submit');
    mg$('.mgPlayerJSProd_duct-tape-invisible-preview').removeClass('mgPlayerJSProd_duct-tape-invisible-preview');

    if (mg$('.mgPlayerJSProd_preview-smarttip-pwr-html').length)
        mg$('.mgPlayerJSProd_preview-smarttip-pwr-html').val('');
};

GmCXt.clearSession = function() {

    if (GmCXt.user) {
        GmCXt.user = false;
    }

    GmCXt.clearBeaconsAndTooltips(true);
    GmCXt.highlighter.clear();

    GmCXt.playedTour = [];
    GmCXt.storage().remove(['playedTour', 'stepsPlayed', 'insightPageRulesData', 'gmSelectedSegment']);

    if (mg$('.mgPlayerJSProd_task-list-button').length > 0) {
        mg$('.mgPlayerJSProd_task-list-button').remove();
    }
};

GmCXt.clearBeaconsAndTooltips = function(isLogout, idList) {

    if (idList) {
        // Clear specific (if parameter is passed)
        if (idList.length) {
            for (let i = 0; i < idList.length; i++) {
                GmCXt.log(43, 'Clearing tooltips for tour: ' + idList[i]);
                mg$('.mgPlayerJSProd_smarttip-tour-' + idList[i]).remove();
                mg$('.mgPlayerJSProd_duct-tape-smarttip-tour-' + idList[i]).removeClass('mgPlayerJSProd_duct-tape-invisible');
                delete GmCXt.onScreenTooltipGuideInfo['tour_' + idList[i]];
            }

            GmCXt.onScreenTooltipGuideIds = GmCXt.onScreenTooltipGuideIds.filter(function(id) {
                return idList.indexOf(id) === -1;
            });

            GmCXt.partialVisibleTooltipsIds = GmCXt.partialVisibleTooltipsIds.filter(function(id) {
                return idList.indexOf(id) === -1;
            });
        }
    } else {
        // Clear all
        mg$('.mgPlayerJSProd_smarttip-icon').remove();
        mg$('.mgPlayerJSProd_smarttip-guidance-msg').remove();
        mg$('.mgPlayerJSProd_smarttip').remove();
        mg$('.mgPlayerJSProd_smarttip-valid').remove();
        mg$('.mgPlayerJSProd_duct-tape').remove();
        mg$('.mgPlayerJSProd_duct-tape-invisible').removeClass('mgPlayerJSProd_duct-tape-invisible');
    }

    mg$(".mgPlayerJSProd_beacon-icon").remove();
    GmCXt.beaconsOnScreen = [];

    if (!isLogout) {
        GmCXt.closePowerForm();
    }

    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:forward;remove_active_smarttip_beacon', {
        idList: idList
    });
};

GmCXt.closeAppPanel = function() {
    GmCXt.APP_PANEL_OPEN = false;
    GmCXt.displayWidget();
    GmCXt.displayChatIcon();
    let alignment = GmCXt.getWidgetAlignment();
    mg$(".mgPlayerJSProd_panel .mgPlayerJSProd_app").css(alignment, "-9550px");
    mg$(".mgPlayerJSProd_panel").css(alignment, "-9550px");
    mg$(".mgPlayerJSProd_panel").css("display", "none");
    mg$(".mgPlayerJSProd_ege-panel").css("display", "none");

    if (alignment === 'right') {
        mg$(".mgPlayerJSProd_panel").css('left', "initial");
    }

    if (GmCXt.isMicroPlayer()) {
        mg$(".mgPlayerJSProd_panel").css("left", "initial");
        mg$(".mgPlayerJSProd_panel").css("top", "50%");
    }

    mg$(".mgPlayerJSProd_panel").attr({
        'aria-hidden': true,
        'tabindex': -1
    });
    mg$("#mgPlayerJSProd_app").attr({
        'aria-hidden': true,
        'tabindex': -1
    });
    mg$(".mgPlayerJSProd_panel").focus();
    GmRootScope.displayChatIcon();
};

GmCXt.legacyWildChar = function(v) {
    return GmCXt.decodeVersion(v) <= 2020063002;
};

GmCXt.getMd5 = function(val) {
    return md5(val);
};

GmCXt.getAppsArray = function(apps) {
    let r = [];

    for (let k in apps) {
        if (apps.hasOwnProperty(k)) {
            r.push(k);
        }
    }
    return r;
};

GmCXt.checkGmailSite = function() {
    let url = GmCXt.getUrl();
    if (url.indexOf('mail.google.com') === 0)
        return true;
    else
        return false;
};

GmCXt.sendMessageToDesktopApp = function(msg, d) {
    GmCXt.log(38, "Send message to Desktop App - ", msg, d);
    let url = '';
    let eventList = {
        "clickNext": 'click',
        "onRightClickNext": 'right-click',
        "onKeyupNext": 'keyup',
        "onChangeNext": 'change',
        "hoverNext": 'hover'
    };

    GmCXt.log(33, "Sending message to CAD");
    GmCXt.log(33, msg);

    switch (msg) {
    case 'step_complete':
        url = "event/step_complete" +
                "?step_id=" + d.step_id + "&step_order" + d.step_order;
        break;

    case 'step_failed':
        url = "event/step_failed" +
                "?step_id=" + d.step_id + "&tour_id=" + GmCXt.deskReq.testCaseId + "&jobId=" + GmCXt.deskReq.jobId;
        break;

    case 'trigger_event':
        var event = d.step_settings.completionEvent;
        var as = d.step_settings.automation;
        var query = '';

        if (as.enableDefaultData) {
            query += 'value=' + escape(as.defaultData);
        }
        query += '&human_interaction=' + escape(as.hasHumanInteraction);

        if (as.element && as.element.dataOptionsType) {
            query += '&type=' + escape(as.element.dataOptionsType);
        }

        if (as.file) {
            query += '&filePath=' + escape(as.file);
        }

        var cname = 'doitforme-' + d.step_id;

        url = "action/" + eventList[event] + "/" + cname + "?" + query;

        break;

    case 'image_comparison':
        var msg = 'Finding image match';
        if (!GmCXt.isEmpty(d.step_title)) {
            msg += (" for step '<b>" + d.step_title + "</b>' ");
        }
        GmCXt.toastMsg(msg).show();

        url = 'image_comparison/doitforme-' + d.step_id + '?';
        break;

    case 'task_complete':
        var query = '';

        if (GmCXt.deskReq) {
            if (GmCXt.deskReq.testCaseId) {
                query += 'tour_id=' + GmCXt.deskReq.testCaseId;
            }
            if (GmCXt.deskReq.jobId) {
                query += '&jobId=' + GmCXt.deskReq.jobId;
            }

            if (GmCXt.deskReq.jobRunId) {
                query += '&jobRunId=' + GmCXt.deskReq.jobRunId;
            }
            if (d && d.isError) {
                query += '&isError=true&errorMessage=' + d.errorMessage;
            }
        }
        if (d && d.entity_code) {
            query += '&entityCode=' + d.entity_code;
        }
        url = "event/task_complete?" + query;
        break;
    }

    if (GmCXt.deskReq && GmCXt.deskReq.driverId) {
        url += "&driver=" + GmCXt.deskReq.driverId;
    }

    GmCXt.log(33, url);

    function cb(tabId) {

        url += '&tabid=' + tabId;

        GmCXt.timeout(function() {
            let params = {
                url: url,
                stepType: (d && d.step_settings) ? d.step_settings.stepType : '',
            };

            if (d && d.step_type === GmCXt.STEP_TYPE_IMAGE) {
                params.info = d;
            }

            GmCXt.api.sendMsgToMyBot(params);
        }, 3000);
    }
    GmCXt.log(37, "msg send to desktop", url);
    if (GmCXt.isBackgroundPage) {
        cb(GmCXt.trackerUtil.tabId);
    } else {
        GmCXt.sendMessageToBackgroundService({
            action: "mgPlayerJSProd_action:get_current_tab_id"
        }, cb);
    }
};

GmCXt.compareArraysByPercentMatch = function(arr1, arr2, val) {
    let similar = arr1.filter(function(n) {
        return this.has(n);
    }, new Set(arr2));

    let pc = 100 * (similar.length * 2) / (arr1.length + arr2.length);

    val = val || 75;
    return pc >= val;
};

GmCXt.compareObjectsByPercentMatch = function(o1, o2, val, keys) {

    if (!GmCXt.isEmpty(o1) && !GmCXt.isEmpty(o2)) {

        let textKeys = ['aria-label'];
        let matched = 0;
        let compared = 0;
        keys = keys || Object.keys(o1);
        let len = keys.length;

        for (let i = 0; i < len; i++) {
            let key = keys[i];
            if (o1.hasOwnProperty(key) && o2.hasOwnProperty(key)) {
                compared++;
                if (typeof o1[key] === 'object') {
                    if (Array.isArray(o1[key])) {
                        if (GmCXt.compareArraysByPercentMatch(o1[key], o2[key], 50)) matched++;
                    } else if (GmCXt.compareObjectsByPercentMatch(o1[key], o2[key], 50)) matched++;
                } else {
                    if (textKeys.includes(key) && o1[key] !== o2[key]) return false;
                    if (o1[key] === o2[key]) matched++;
                }
            }
        }

        if (!compared) return false;

        let currentPc = 100 * matched / compared;
        let pc = val || 75;

        if (currentPc >= pc) {
            return true;
        }
    }

    return false;
};

GmCXt.checkInsightEnabled = function() {
    let org = GmCXt.organization;
    if (org && org.admin_settings.insights.enabled && org.admin_settings.insights.guide) {
        return true;
    }
    return false;
};

GmCXt.getBasePath = function(i) {
    let url = "";
    if (GmCXt.isExtension()) {
        url = GmCXt.getBrowserUrl(i);
    } else {
        if (GmCXt.isDefined(GmCXt.conf.baseUrl)) {
            url = GmCXt.conf.baseUrl + i;
        } else {
            url = GmCXt.conf.clientJsBaseUrl + i;
        }
    }

    return url;
};

// Only applicable after version 2021.01.30.1
GmCXt.checkTourCreatedBefore = function(tourSettings, version) {
    return (!tourSettings.hasOwnProperty('created_version') || GmCXt.decodeVersion(tourSettings.created_version) < version);
};

GmCXt.getTourSegmentDetail = function(tour) {
    let segmentDetails = [];
    let tour_segs = tour.tour_settings.segment_groups;
    tour_segs.forEach(function(s) {
        let sg = GmCXt.getSegmentById(s);
        if (!GmCXt.isEmpty(sg)) {
            segmentDetails.push(sg);
        }
    });
    return segmentDetails;
};

GmCXt.getSegmentById = function(id) {
    if (GmRootScope.allSegments) {
        return GmRootScope.allSegments.filter(function(g) {
            return parseInt(g.group_id) === parseInt(id);
        })[0];
    } else return {};
};

GmCXt.validatedSegments = {};

GmCXt.areUserSegmentsValid = function(segments, segmentId) {
    let userProfileData = GmCXt.user.profile ? JSON.parse(GmCXt.user.profile) : "";
    let isValid = false;

    let userData = [];
    if (userProfileData && Object.prototype.toString.call(userProfileData) !== '[object Array]') {
        for (var i = 0; i < Object.keys(userProfileData).length; i++) {
            key = Object.keys(userProfileData)[i];
            value = userProfileData[key];
            userData.push({
                data: value
            });
        }
    } else {
        userData = userProfileData;
    }

    if (!userData) return isValid;

    if (!segments || !segments.length) return true;

    if (GmCXt.user.role !== "user") return true;

    for (var i = 0; i < segments.length; i++) { // For each segment in the segmentation
        if (!GmCXt.isEmpty(segments[i].data)) {
            isValid = false;
            for (let j = 0; j < userData.length; j++) {
                if (userData[j].id && !GmCXt.isEmpty(userData[j].data) && parseInt(segments[i].id) === parseInt(userData[j].id)) {
                    for (var k = 0; k < segments[i].data.length; k++) {
                        if (userData[j].data.includes(segments[i].data[k])) {
                            isValid = true;
                            break;
                        }
                    }
                } else if (!GmCXt.isDefined(userData[j].id) && !GmCXt.isEmpty(userData[j].data)) {
                    for (var k = 0; k < segments[i].data.length; k++) {
                        if (userData[j].data.includes(segments[i].data[k])) {
                            isValid = true;
                            break;
                        }
                    }
                }
            }
            if (!isValid) break;
        }
    }

    GmCXt.log(68, "Valid User Segments: ", isValid);
    return isValid;
};

GmCXt.getSegmentSetting = function(segmentId) {
    let segment = GmCXt.getSegmentById(segmentId);

    let segmentSettings, segmentSetting;
    if (!GmCXt.isEmpty(segment) && segment.settings) {
        segmentSettings = GmCXt.parseJSON(segment.settings);
        for (let key in segmentSettings) {
            if (segmentSettings.hasOwnProperty(key)) {
                if (segmentSettings[key] === 1) {
                    segmentSetting = key;
                    break;
                }
            }
        }
    }

    return segmentSetting;
};

GmCXt.checkGuidesBasedOnSegment = function(tours, cb, from) {

    if (!tours || !tours.length) {
        cb({});
        return;
    }

    let allSegment = [];
    let totalSegment = 0;
    let toursProcessed = 0;
    let segmentProcessed = 0;
    let validatedTours = [];

    let totalTours = tours.length;

    function checkTourSegment(s_id) {
        tours.forEach(function(tour) {

            GmCXt.log(68, "Check Segments in Tour: " + GmCXt.tourLog(tour));

            let isSegmentValid = false;
            let segments = tour.tour_settings.segment_groups;
            if (GmCXt.inArray(segments, s_id)) {
                for (let i = 0; i < segments.length; i++) { // For each segmentation added
                    if (GmCXt.validatedSegments[segments[i]]) {
                        isSegmentValid = true;
                        break;
                    }
                }
                if (isSegmentValid && !GmCXt.inArray(tour.tour_id, validatedTours)) {

                    validatedTours.push(parseInt(tour.tour_id));

                    toursProcessed++;

                    GmCXt.log(68, "VALID Tour segments: " + GmCXt.tourLog(tour));

                }

                if (segments.length > 0) {

                    let segmentSetting = GmCXt.getSegmentSetting(segments[0]);

                    switch (segmentSetting) {
                    case 'show_guides_user_in_segment':
                        if (isSegmentValid) cb(tour); // Show the guide if user is part of the segment and `activeSegmentSetting` is "show_guides_user_in_segment"
                        break;
                    case 'hide_guides_user_in_segment':
                        if (!isSegmentValid) cb(tour); // Hide the guide if user is part of the segment and `activeSegmentSetting` is "hide_guides_user_in_segment"
                        break;
                    case 'show_guides_user_not_in_segment':
                        if (!isSegmentValid) cb(tour); // Show the guide if user is not part of the segment and `activeSegmentSetting` is "show_guides_user_not_in_segment"
                        break;
                    default:
                        if (isSegmentValid) cb(tour); // Default case
                        break;
                    }
                }
            }
        });
    }

    // segment rules call back
    function segmentRuleCallBack(r) {

        segmentProcessed++;

        if (GmCXt.isTrue(r.valid)) {
            GmCXt.validatedSegments[r.segmentId] = true;
            GmCXt.log(68, "Validat Segment ", r);
        }

        if (toursProcessed !== totalTours) {
            checkTourSegment(r.segmentId);
        }

        // if all segment is validated and no tour is processed
        if (segmentProcessed === totalSegment && toursProcessed === 0) {
            cb({});
        }

    }

    // get all segments from the tour
    tours.forEach(function(tour, i) {
        if (tour.tour_settings.segment_groups.length > 0) {
            allSegment.push(tour.tour_settings.segment_groups);
        } else {
            validatedTours.push(parseInt(tour.tour_id));
            toursProcessed++;
            cb(tour);
        }
    });

    GmCXt.storage().get(['gmSelectedSegment']).then(function(st){
        if(!GmCXt.isEmpty(st) && !GmCXt.isEmpty(st.gmSelectedSegment)){
            let selectedSeg = GmCXt.parseJSON(st.gmSelectedSegment);
            if(!GmCXt.isEmpty(selectedSeg)) {
                allSegment = selectedSeg.map(seg => seg.group_id);
            }
        }

        let flattenAllsegment = allSegment.reduce(function(seg, val) {
            return seg.concat(val);
        }, []);

        allSegment = GmCXt.removeDuplicates(flattenAllsegment);
        totalSegment = allSegment.length;

        allSegment.forEach(function(segmentId, i) {

            GmCXt.log(68, "Validating Segment: ", segmentId);
            let segment = GmCXt.getSegmentById(segmentId);

            //if role based segments inside a segment group are not in user.profile, Invalidate those segment groups
            if (segment && !GmCXt.areUserSegmentsValid(segment.segments, segmentId)) {

                GmCXt.log(68, "Invalid User Segments: ", segmentId);
                segmentRuleCallBack({
                    valid: false,
                    segmentId: segmentId
                });
            } else if (GmCXt.validatedSegments[segmentId] && (segment && !segment.rule_check)) {
                //re-eval seg rules only if On page click option is selected
                segmentRuleCallBack({
                    valid: true,
                    segmentId: segmentId
                });
            } else {
                let rules = (segment && segment.rules && segment.rules.length) ? GmCXt.parseJSON(segment.rules) : [];
                let title = segment ? segment.title : "Segment not found";

                if (GmCXt.validatedSegments[segmentId]) {
                    delete GmCXt.validatedSegments[segmentId];
                }

                let data = {
                    rules: rules,
                    tour: {
                        tour_id: segmentId,
                        tour_settings: {},
                        tour_title: title
                    },
                    timeoutVal: GmCXt.t.ruleTimeOut10s,
                    timeout: GmCXt.t.ruleTimeOut10s,
                    cb: segmentRuleCallBack,
                    isTour: true,
                    initiator: from,
                    segmentId: segmentId
                };

                GmCXt.ruleEngine.queue(data);
            }

        });
    });
};

GmCXt.takeScreenshot = function(xpath) {
    let promise = new Promise(function(resolve, reject) {
        if (GmCXt.isElectron()) {
            let _electron = require('electron').remote;
            _electron.getCurrentWindow().capturePage().then(function(img) {
                resolve(img.toDataURL());
            });
        } else if (GmCXt.isExtension()) {
            let m = {
                action: "mgPlayerJSProd_action:capture_browser_screen",

            };
            if(xpath){
                m.xpath = xpath;
            }
            GmCXt.sendMessageToBackgroundService(m, function(resp) {
                resolve(resp.imgSrc);
            });
        } else {
            resolve(0);
        }
    });
    return promise;
};

GmCXt.triggerForOtherFunctions = function(id, ev) {
    switch (id) {
    case "mgPlayerJSProd_play_step_popup_drag":
    case "mgPlayerJSProd_play-step-popup-drag-icon":

        break;
    case "mgPlayerJSProd_play-step-audio-off":
        if (GmCXt.previewStepPopupInstance) {
            GmCXt.previewStepPopupInstance.setOnAudioMode();
        }
        break;
    case "mgPlayerJSProd_play-step-audio-on":
        if (GmCXt.previewStepPopupInstance) {
            GmCXt.previewStepPopupInstance.setOffAudioMode();
        }
        break;
    }
};

GmCXt.checkAndCallClick = function(target, ev) {
    if (GmCXt.isIDinGuidePlayList(target.id)) {
        if (GmCXt.playerI) {
            GmCXt.playerI.targetElement = target;
        }
        if (ev.type === "mousedown") {
            GmCXt.tourPlayerI.triggerMyGuideClickMouseDown(ev);
        }
        GmCXt.tourPlayerI.triggerMyGuideClick(target.id, ev);
    } else if (GmCXt.isIDinOtherList(target.id)) {
        GmCXt.triggerForOtherFunctions(target.id, ev);
    } else if (GmCXt.checkMyGuideClass(target.className)) {
        GmCXt.checkAndCallClick(target.parentElement, ev);
    }
};

GmCXt.checkForSVGInstance = function(target) {
    let retTarget = target;
    if (target instanceof SVGElement) {
        retTarget = GmCXt.checkForSVGInstance(target.parentNode);
    }
    return retTarget;
};

GmCXt.registerClickListner = function(e) {
    let target = GmCXt.checkForSVGInstance(e.target);
    if (target && GmCXt.checkMyGuideClass(target.className)) {
        GmCXt.checkAndCallClick(target, e);
        if (GmCXt.playerI && GmCXt.playerI.automate) {
            GmCXt.checkSkipStepForTracking();
        }
    }
};

GmCXt.isIDinOtherList = function(id) {
    let retVal = false;
    let idList = ["mgPlayerJSProd_play_step_popup_drag", "mgPlayerJSProd_play-step-popup-drag-icon", "mgPlayerJSProd_play-step-audio-off",
        "mgPlayerJSProd_play-step-audio-on"
    ];

    if (GmCXt.inArrayString(id, idList)) {
        retVal = true;
    }

    return retVal;
};

GmCXt.isIDinGuidePlayList = function(id) {
    let retVal = false;
    let idList = ["mgPlayerJSProd_play_step_pause_classic", "mgPlayerJSProd_play_step_next", "mgPlayerJSProd_play_step_next_classic",
        "mgPlayerJSProd_play_step_prev", "mgPlayerJSProd_play_step_prev_classic", "mgPlayerJSProd_play_step_popup_close",
        "mgPlayerJSProd_play_step_pause", "mgPlayerJSProd_play_step_next_done", "mgPlayerJSProd_play_step_next_done_classic",
        "mgPlayerJSProd_play_step_popup_edit",
        "mgPlayerJSProd_play-step-popup-close-svg", "mgPlayerJSProd_play-step-popup-edit-icon",
        "mgPlayerJSProd_play-step-pause-svg"
    ];

    if (GmCXt.inArrayString(id, idList)) {
        retVal = true;
    }

    return retVal;
};

GmCXt.tooltipTitle = function(os, pEle) {
    let tTitleCss = "<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-title-css'><style type='text/css'>" +
        "." + pEle + " p:first-child {" + "color: " + os.popupDesign.current.stepTitleColor + " !important; " +
        "font-family: " + os.popupDesign.current.stepTitleFontFamily + " !important; " +
        "font-size: " + os.popupDesign.current.stepTitleFontSize + " !important; " +
        "font-weight: " + os.popupDesign.current.stepTitleFontWeight + " !important; " +
        "padding-bottom: 10px !important;" +
        "}" +
        "</style></wmgPlayerJSProd_>";

    return mg$("html").append(tTitleCss);
};

GmCXt.tooltipPopupCss = function(os, customEle, isPreviewMode) {
    let previewPrefix = isPreviewMode || '';

    const popupPositions = [
        "left", "left-middle", "left-top", "left-bottom",
        "right", "right-middle", "right-top", "right-bottom",
        "top", "top-middle", "top-left", "top-right",
        "bottom", "bottom-middle", "bottom-left", "bottom-right",
        "center"
    ];

    // Map position to border side
    const positionToSide = {
        "left": "left",
        "left-middle": "left",
        "left-top": "left",
        "left-bottom": "left",
        "right": "right",
        "right-middle": "right",
        "right-top": "right",
        "right-bottom": "right",
        "top": "top",
        "top-middle": "top",
        "top-left": "top",
        "top-right": "top",
        "bottom": "bottom",
        "bottom-middle": "bottom",
        "bottom-left": "bottom",
        "bottom-right": "bottom",
    };

    let popUpCSS = "<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-popup-css'><style type='text/css'>";

    popupPositions.forEach(function(position) {
        var borderSide = positionToSide[position];
        // Type 1 selector: full class with prefix
        var type1SelectorBefore = customEle + ".mgPlayerJSProd_" + previewPrefix + "smarttip-guidance-msg-" + position + ":before";
        var type1SelectorAfter  = customEle + ".mgPlayerJSProd_" + previewPrefix + "smarttip-guidance-msg-" + position + ":after";
        
        // Type 2 selector: position-only class
        var type2SelectorBefore = customEle + ".mgPlayerJSProd_smarttip-guidance-msg." + position + ":before";
        var type2SelectorAfter  = customEle + ".mgPlayerJSProd_smarttip-guidance-msg." + position + ":after";

        // Combine both in each rule
        popUpCSS += `${type1SelectorBefore},${type2SelectorBefore} {border-${borderSide}-color:${os.popupDesign.current.bgColor} !important;}`;
        popUpCSS += `${type1SelectorAfter},${type2SelectorAfter} {border-${borderSide}-color:${os.popupDesign.current.borderColor} !important;}`;
    });

    popUpCSS += "</style></wmgPlayerJSProd_>";

    return mg$("html").append(popUpCSS);
};

GmCXt.tooltipTheme = function(os, customEle, options, isPreviewMode) {
    let isTooltipTheme = os.tooltipTheme;
    let popupWidth = options && options.popupSize && options.popupSize.popupWidth ? options.popupSize.popupWidth : os.stepPopupWidth;

    let tObj = {
        'tooltipBgColor': '',
        'tooltipDescColor': '',
        'tooltipDescFfamily': '',
        'tooltipDescFsize': '',
        'tooltipBorderC': '',
        'tooltipBorderW': '',
        'tooltipBorderRadius': '',
        'tooltipMwidth': '',
        'tooltipWidth': '',
        'tooltipPaddingTop': '',
        'tooltipPaddingBottom': '',
        'tooltipPaddingLeft': '',
        'tooltipPaddingRight': ''
    };

    if (isTooltipTheme) {
        tObj.tooltipBgColor = "background:" + os.popupDesign.current.bgColor + " !important; box-shadow: rgb(0 0 0 / 50%) 0 0 10px -2px !important;";
        tObj.tooltipDescColor = "color:" + os.popupDesign.current.stepDescColor + " !important; ";
        tObj.tooltipDescFfamily = ("font-family:" + os.popupDesign.current.stepDesFontFamily + " !important; ").replace(/'/g, "\"");
        tObj.tooltipDescFsize = "font-size:" + os.popupDesign.current.stepDesFontSize + " !important; ";
        tObj.tooltipBorderC = "border-color:" + os.popupDesign.current.borderColor + " !important; ";
        tObj.tooltipBorderW = "border-width:" + os.popupDesign.current.borderWidth + "px !important; ";
        tObj.tooltipBorderRadius = "border-radius:" + os.popupDesign.current.borderRadius + "px !important; ";
        tObj.tooltipMwidth = "max-width:" + os.stepPopupWidth + "px !important; ";
        tObj.tooltipWidth = "width:" + popupWidth + "px !important; padding: 15px 15px 5px 15px !important; white-space: normal !important; line-height: initial !important;";
        tObj.tooltipPaddingTop = "padding-top:" + os.popupDesign.current.padding.top + "px !important; ";
        tObj.tooltipPaddingBottom = "padding-bottom:" + os.popupDesign.current.padding.bottom + "px !important; ";
        tObj.tooltipPaddingLeft = "padding-left:" + os.popupDesign.current.padding.left + "px !important; ";
        tObj.tooltipPaddingRight = "padding-right:" + os.popupDesign.current.padding.right + "px !important; ";

        GmCXt.tooltipPopupCss(os, customEle, isPreviewMode);
        GmCXt.tooltipTitle(os, 'mgPlayerJSProd_smarttip-msg-inner');
        GmCXt.tooltipTitle(os, 'mgPlayerJSProd_preview-smarttip-msg-inner');
    } else {
        tObj.tooltipBorderC = "border-color:" + os.tooltipColor + " !important; ";

        mg$(".mgPlayerJSProd_tooltip-popup-css").remove();
        mg$(".mgPlayerJSProd_tooltip-title-css").remove();
    }

    return tObj;
};

GmCXt.stringUsesVariable = function(str) {
    return (str.includes('{{') && str.includes('}}'));
};

GmCXt.replaceVariableWithValue = function(str) {
    let variables = GmCXt.getVariableData();
    if (GmCXt.stringUsesVariable(str)) {
        let isValid = false;
        for (let i = 0; i < variables.length; i++) {
            let regex = new RegExp('\{\{(?:\\s+)?(' + RegExp.escape(variables[i].name) + ')(?:\\s+)?\}\}', "g");
            isValid = regex.test(str);
            if (isValid && variables[i].value) {
                str = str.replace(regex, variables[i].value);
            }
        }
    }
    return str;
};

GmCXt.replaceVariableInText = function(str) {
    let regex = new RegExp('\{\{(?:\\s+)?(.+?)(?:\\s+)?\}\}', "g");
    let isValid = false;
    isValid = regex.test(str);
    if (isValid) {
        str = str.replace(regex, '').replace(/\s\s+/g, ' ');
    }
    return str;
};

GmCXt.variableRuleExistInGuide = function(rules) {
    for (let k = 0, l = rules.length; k < l; k++) {
        if (rules[k].type === 'Variables') {
            return true;
        }
    }
    return false;
};

GmCXt.updateZIndex = function(zIndex, add) {
    if (zIndex) {
        let updateBy = add ? 1 : -1;
        return (parseInt(zIndex) + updateBy).toString();
    }
    return "";
};

GmCXt.skipTags = function(he) {
    if (GmCXt.isSvgTag(he.tagName)) {

        he = he.parentNode;

        while (he && he.parentNode && GmCXt.isSvgTag(he.tagName)) {
            he = he.parentNode;
        }
    }

    if (GmCXt.checkSalesForceSite()) {
        if (he.tagName === 'LIGHTNING-PRIMITIVE-ICON') {
            he = he.parentNode;
        }

        let parent = he.parentNode;
        if (parent && he.tagName === 'BUTTON' &&
            (parent.tagName === 'LIGHTNING-BUTTON-ICON' || parent.tagName === 'LIGHTNING-BUTTON')) {
            he = parent;
        }
    }
    return he;
};

GmCXt.validateUrl = function(url) {

    let expression = /^(?:(?:https?|ftp):\/\/)?(?:[\w-]+\.)+[a-z]{2,}(?::\d{2,5})?(?:\/\S*)?$/i;
    if (expression.test(url)) {
        return true;
    } else {
        return false;
    }
};

GmCXt.trackElNotFound = function(d) {

    GmCXt.log(27, "track Element Not Found");

    return; // Stop "mi_rule_enhancement" events temporary for MG-25171

    // if (window.self === window.top) {
    //     GmCXt.trackerV1.trackElNotFound(d);
    // } else {
    //     GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:track_element_not_found', d);
    // }
};

GmCXt.onPopupRerender = function() {
    if (mg$('#mgPlayerJSProd_popup-reload').length > 0) {
        let forceClose = !GmCXt.playerI.testAutomation;
        GmCXt.confirmTourClose(forceClose);
    }
};

GmCXt.concatHTMLStringWithSpace = function(str) {
    if (GmCXt.isEmpty(str)) return str;
    str = str.split('</p>').join(' ');
    str = str.split('</div>').join(' ');
    str = str.split('</li>').join(' ');
    str = mg$('<span />').html(str).text().trim();
    return str;
};

GmCXt.resetElTracker = function() {
    if (window.self === window.top) {
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:reset_dom_tracker');
    }
};

GmCXt.resetElTrackerVariable = function() {
    if (!GmCXt.isEmpty(GmCXt.domSelectorTracker) && !GmCXt.isEmpty(GmCXt.domSelectorTracker[GmCXt.id])) {
        // Reset tracker
        GmCXt.domSelectorTracker = {};
    }
};

GmCXt.logElTracker = function() {
    if (window.self === window.top) {
        GmCXt.logTrackerData = false;
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:request_dom_tracker_info');
    }
};

GmCXt.shareDomTrackerInfo = function() {
    if (window.self !== window.top) {
        if (GmCXt.isEmpty(GmCXt.domSelectorTracker)) {
            GmCXt.domSelectorTracker[GmCXt.id] = {};
        }
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:send_dom_tracker_info', GmCXt.domSelectorTracker);
    } else {
        GmCXt.combineDomTrackerData();
    }
};

GmCXt.combineDomTrackerData = function(info) {
    if (window.self === window.top) {
        let finder = {};
        let query = {};
        let totalFinder = 0;
        let totalQuery = 0;
        let iFrameTally = 0;

        if (info) {
            GmCXt.domSelectorTracker = Object.assign(GmCXt.domSelectorTracker, info);
        }

        GmCXt.timeout(function() {
            if (!GmCXt.logTrackerData) {
                for (let i in GmCXt.domSelectorTracker) {
                    if (!GmCXt.isEmpty(GmCXt.domSelectorTracker[i])) {
                        iFrameTally++;
                        let iframeInfo = GmCXt.domSelectorTracker[i];
                        for (let key in iframeInfo) {
                            let elInfo = iframeInfo[key];

                            finder[key] = elInfo.finder;
                            totalFinder += elInfo.finder;

                            query[key] = elInfo.query;
                            totalQuery += elInfo.query;
                        }
                    }
                }
                let css = "color:#00a6d9;";
                console.log("%cNo. of iframes Searched ", css, iFrameTally);
                console.log("%cTotal calls to dom.finder() ", css, totalFinder);
                console.log("%cCalls to dom.finder() segregated by element ", css, finder);
                console.log("%cTotal calls to dom.query() ", css, totalQuery);
                console.log("%cCalls to dom.query() segregated by element ", css, query);

                GmCXt.logTrackerData = true;
            }
        }, 1500);
    }
};

GmCXt.handleLinkClickEvent = function(e) {
    let url = e.currentTarget.href;
    let mediaType = GmCXt.getURLMediaType(url);

    if (url && url.toLowerCase().indexOf("mailto:") === 0) {
        GmCXt.mailToClicked = true;
    }

    function isSmarttipLink(linkElem) {
        while (linkElem) {
            if (linkElem.classList.value.indexOf('smarttip') !== -1) return true;
            linkElem = linkElem.parentElement;
        }
        return false;
    }

    if (!GmCXt.isEmpty(e.target.tid) && !GmCXt.isEmpty(e.target.sid) &&
        !GmCXt.isEmpty(e.target.opt) && isSmarttipLink(e.target)) {
        let linkData = GmCXt.parseJSON(e.target.opt);
        linkData.tooltipURL = e.target.href;
        GmCXt.updateTooltipActionInfo(e.target.tid, e.target.sid, linkData, "url_click");
    }

    if (mediaType) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        if (mediaType === "pdf") {
            GmCXt.openPdf(e.target.href);;
        } else {
            GmCXt.openVideoPlayer(e.target.href);
        }
    } else if (GmCXt.isElectron()) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        GmCXt.redirectLinkToBrowser(e);
    }

    GmCXt.storage().set({
        'linkClickOnStep': url
    });
};

GmCXt.isStepInlineBranch = function(s) {
    let retVal = false;
    if (s && s.step_settings && GmCXt.isTrue(s.step_settings.inlineBranch)) {
        retVal = true;
    }
    return retVal;
};

GmCXt.getVariableData = function() {
    let varData = false;

    if (!GmCXt.isEmpty(GmCXt.appList) && GmCXt.activeAppId && GmCXt.appList['app:' + GmCXt.activeAppId]) {
        let appId = GmCXt.getBaseAppId();
        varData = GmCXt.appList['app:' + appId].settings.variables;
    }

    return varData;
};

GmCXt.workdayAutoClick = function(index) {
    if (GmCXt.playerI) {
        let editIcon = "[data-automation-id='actionImage']";
        let el = mg$(editIcon)[index];
        mg$(el).trigger("click");
    }
};

GmCXt.captureScreenForFeedback = function(mailTo) {
    if (mailTo) {
        GmCXt.mailTo = mailTo;
    }

    GmCXt.takeScreenshot().then(function(imageSrc) {

        if (GmCXt.isEmpty(imageSrc)) {
            mg$(".mgPlayerJSProd_feedback-overlay-svg-error").show();
            mg$(".mgPlayerJSProd_feedback-re-edit-btn").hide();
            mg$("#mg-feedback-screenshot-check").removeAttr("checked");
        } else {
            mg$(".mgPlayerJSProd_feedback-overlay-svg-error").hide();
            mg$(".mgPlayerJSProd_feedback-re-edit-btn").show();
        }

        let img = mg$("#mg-feedback-screenshot-image");
        img.attr('src', imageSrc);
        GmCXt.feedbackImgSrc = imageSrc;
        GmCXt.showFeedBackToolbar();
    });
};

GmCXt.showFeedBackToolbar = function() {
    mg$("#mg-feedback-container-wrapper").show();
    GmCXt.showFeedBackPopup();
};

GmCXt.showFeedBackPopup = function() {
    mg$('wmgPlayerJSProd_#mg-feedback-selector-toolbar').hide();
    mg$('wmgPlayerJSProd_#mg-feedback-popup').show();
};

GmCXt.showFeedBackSelectorToolbar = function() {
    mg$('wmgPlayerJSProd_#mg-feedback-popup').hide();
    mg$('wmgPlayerJSProd_#mg-feedback-selector-toolbar').show();
};

GmCXt.onEditScreenshotClick = function() {
    GmCXt.showFeedBackSelectorToolbar();
};

GmCXt.onClickFeedbackHighlightArea = function() {
    let div = document.getElementById('mgPlayerJSProd_highlight');
    GmCXt.feedbackMarkArea(div);
};

GmCXt.onClickFeedbackHideArea = function() {
    let div = document.getElementById('mgPlayerJSProd_blackout');
    GmCXt.feedbackMarkArea(div, true);
};

GmCXt.onClickFeedbackEditDone = function() {
    mg$('wmgPlayerJSProd_#mg-feedback-selector-toolbar').hide();
    GmCXt.captureScreenForFeedback();
};

GmCXt.feedbackMarkArea = function(div, hide) {
    let toolbar = mg$('wmgPlayerJSProd_#mg-feedback-selector-toolbar');
    toolbar.hide();

    let wrapper = document.getElementById("mg-feedback-flex-container");
    wrapper.style.cursor = 'crosshair';
    wrapper.style.background = 'transparent';

    let x1 = 0,
        y1 = 0,
        x2 = 0,
        y2 = 0;

    function reCalc() {
        let x3 = Math.min(x1, x2);
        let x4 = Math.max(x1, x2);
        let y3 = Math.min(y1, y2);
        let y4 = Math.max(y1, y2);
        div.style.left = x3 + 'px';
        div.style.top = y3 + 'px';
        div.style.width = x4 - x3 + 'px';
        div.style.height = y4 - y3 + 'px';
    }

    let onmousedown = function(e) {
        e.preventDefault();
        div.style.display = 'block';
        x1 = e.clientX;
        y1 = e.clientY;
        reCalc();
    };

    let onmousemove = function(e) {
        x2 = e.clientX;
        y2 = e.clientY;
        reCalc();
    };

    let onmouseup = function(e) {
        let el = {
            id: 'r_' + Math.floor(Math.random() * 1000),
            element: {
                position: {
                    top: y1,
                    left: x1,
                    height: y2 - y1,
                    width: x2 - x1
                }
            }
        };
        div.style.display = 'none';
        wrapper.style.cursor = 'default';

        if (hide) {
            if (!GmCXt.sfHideElements) {
                GmCXt.sfHideElements = [];
            }
            GmCXt.sfHideElements.push(el);
            GmCXt.drawArea(GmCXt.sfHideElements, 'blackout-feedback');
        } else {
            if (!GmCXt.sfMarkElements) {
                GmCXt.sfMarkElements = [];
            }
            GmCXt.sfMarkElements.push(el);
            GmCXt.drawArea(GmCXt.sfMarkElements, 'highlight');
        }

        wrapper.style.background = '#26273b33';
        toolbar.show();

        wrapper.removeEventListener('mousedown', onmousedown);
        wrapper.removeEventListener('mouseup', onmouseup);
        wrapper.removeEventListener('mousemove', onmousemove);
    };

    wrapper.addEventListener('mousedown', onmousedown);
    wrapper.addEventListener('mouseup', onmouseup);
    wrapper.addEventListener('mousemove', onmousemove);
    div.onmouseup = onmouseup;
};

GmCXt.drawArea = function(arr, className) {
    let elems = arr;
    mg$('wmgPlayerJSProd_.mgPlayerJSProd_selector-' + className).remove();

    for (let i = 0; i < elems.length && elems[i].id; i++) {
        let el = elems[i].element.position;

        let closeBtn = '<wmgPlayerJSProd_ class="mgPlayerJSProd_close-area mgPlayerJSProd_' + className + '-close" id=' + elems[i].id + '><wmgPlayerJSProd_ class="mgPlayerJSProd_close-text">&times;</wmgPlayerJSProd_></wmgPlayerJSProd_>';
        let blackoutEl = mg$('<wmgPlayerJSProd_ class="mgPlayerJSProd_selector-' + className + '" id="mgPlayerJSProd_selector-' + className + '-' + elems[i].id + '">' +
                closeBtn +
                '</wmgPlayerJSProd_>')
            .appendTo('#mg-feedback-flex-container')
            .css({
                'width': el.width,
                'height': el.height,
                'left': el.left,
                'top': el.top
            });
    }

    mg$("wmgPlayerJSProd_.mgPlayerJSProd_" + className + "-close").on('click', function(e) {
        let oArr = [];
        arr.forEach(function(el, i) {
            if (el.id !== e.currentTarget.id) oArr.push(el);
        });
        arr = oArr;
        mg$("#mgPlayerJSProd_selector-" + className + "-" + e.currentTarget.id).remove();
    });
};

GmCXt.sendFeedback = function() {
    let feedbackText = document.getElementById("mg-feedback").value;
    let emailBody = {};

    if (GmCXt.isEmpty(feedbackText)) {
        let option = {
            description: GmCXt.label.feedbackRequired,
            button1: GmCXt.label.ok
        };
        GmCXt.alertV2(option).show();
        return;
    }

    emailBody.feedbackText = feedbackText;

    if (GmCXt.mailTo) {
        emailBody.mailTo = GmCXt.mailTo;
    }

    if (GmCXt.user) {
        let userInfo = {
            email: GmCXt.user.user_email,
            firstName: GmCXt.user.first_name,
            lastName: GmCXt.user.last_name
        };
        emailBody.userInfo = JSON.stringify(userInfo);
    }

    if (mg$('#mg-feedback-screenshot-check')[0].checked) {
        emailBody.imgSrc = GmCXt.feedbackImgSrc;
    }

    GmCXt.clearFeedBackView();

    GmCXt.api.sendFeedbackEmail(emailBody);
};

GmCXt.clearFeedBackView = function() {
    mg$("#mg-feedback-container-wrapper").remove();
    mg$('.mgPlayerJSProd_selector-highlight').remove();
    GmCXt.sfMarkElements = [];
    mg$('.mgPlayerJSProd_selector-blackout-feedback').remove();
    GmCXt.sfHideElements = [];
    GmCXt.mailTo = '';
    GmCXt.openAppPanel();
};

GmCXt.numberOfSameTail = function(id, ps) {
    let counter = 0;
    if (ps && ps.length) {
        for (let i = 0; i < ps.length; i++) {
            if (parseInt(ps[i].tail) === parseInt(id)) {
                counter++;
            }
        }
    }
    return counter;
};

GmCXt.getExcludedDomainList = function() {
    let excludedDomains = [];
    let os = GmCXt.getOrgSettings();
    if (os && os.excludeDomains && !GmCXt.isEmpty(os.excludeDomains)) {
        excludedDomains = os.excludeDomains;
    }
    return excludedDomains;
};

GmCXt.isExcludeDomain = function() {
    let isEx = false;
    if (GmCXt.urlParts && GmCXt.urlParts.fullUrl && GmCXt.isPlayer()) {
        let url = GmCXt.urlParts.host + GmCXt.urlParts.pathname;
        let excludeDomainList = GmCXt.getExcludedDomainList();

        if (excludeDomainList) {
            for (let x = 0; x < excludeDomainList.length; x++) {
                if (url && url.toLowerCase().includes(GmCXt.trimAndLowerCaseURL(excludeDomainList[x]))) {
                    isEx = true;
                    break;
                }
            }
        }
    }
    return isEx;
};

GmCXt.getStepPosFromPs = function(t, sId) {
    let pos = "";
    let PS = t.tour_settings.play_structure;

    for (let i = 0; i < PS.length; i++) {
        if (PS[i].id === sId) {
            pos = i + 1;
            break;
        }
    }

    return pos;
};

GmCXt.isValueInArray = function(array, keyToFind, valueToFind) {
    return array.some(function(obj) {
        return obj[keyToFind] === valueToFind;
    });
};

GmCXt.checkDomainInPublishedEnv = function(pubEnv) {
    let domainInPublishedEnv = false;
    if (GmCXt.isDefined(pubEnv)) {
        let domainEnv = GmCXt.getAppEnvByDomain();
        if (pubEnv.includes(domainEnv)) {
            domainInPublishedEnv = true;
        }
    } else {
        domainInPublishedEnv = true;
    }
    return domainInPublishedEnv;
};

GmCXt.updateNumericKeys = function(key) {
    let lastKey = key.slice(-1);
    let numKey = parseInt(lastKey);

    let specialCharArr = [")", "!", "@", "#", "$", "%", "^", "&", "*", "("];

    if (!isNaN(numKey)) {
        return key.slice(0, -1) + specialCharArr[numKey];
    } else {
        return key;
    }
};

GmCXt.addHttpIfMissing = function(url) {
    if (!url.trim().startsWith('http://') && !url.trim().startsWith('https://')) {
        url = 'https://' + url;
    }
    return url;
};

GmCXt.checkScheduleTime = function(tour) {
    if (tour.tour_settings && tour.tour_settings.visibilitySettings && tour.tour_settings.visibilitytimestamp) {
        let tourTs = tour.tour_settings.visibilitytimestamp;
        let currentTS = Date.now();
        if (parseInt(currentTS) < tourTs) {
            return false;
        } else {
            return true;
        }
    } else {
        return true;
    }
};

GmCXt.filterScheduleTours = function(tours) {
    var tours = tours.filter(function(tour) {
        if (GmCXt.checkScheduleTime(tour)) {
            return tour;
        }
    });

    return tours;
};

GmCXt.getCombinedDateFromTimestamp = function(timestamp) {
    // Create a new Date object with the timestamp in milliseconds
    let date = new Date(timestamp * 1000);

    // Extract the day, month, and year components from the Date object
    let day = date.getDate().toString().padStart(2, '0');
    let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-based, so we add 1
    let year = date.getFullYear();

    // Combine the components into a date string in the format "YYYY-MM-DD"
    let combinedDate = `${year}-${month}-${day}`;

    // Return the combined date string
    return combinedDate;
};

GmCXt.compareDates = function(dateStr1, dateStr2) {
    // Split the date strings into arrays of year, month, and day components
    let date1Components = dateStr1.split('-').map(Number);
    let date2Components = dateStr2.split('-').map(Number);

    // Compare year first
    if (date1Components[0] < date2Components[0]) {
        return -1;
    } else if (date1Components[0] > date2Components[0]) {
        return 1;
    }

    // If years are equal, compare months
    if (date1Components[1] < date2Components[1]) {
        return -1;
    } else if (date1Components[1] > date2Components[1]) {
        return 1;
    }

    // If months are equal, compare days
    if (date1Components[2] < date2Components[2]) {
        return -1;
    } else if (date1Components[2] > date2Components[2]) {
        return 1;
    }

    // If all components are equal, return 0
    return 0;
};

GmCXt.compareTimes = function(timeStr1, timeStr2) {
    // Split the time strings into hours and minutes
    let hoursMinutes1 = timeStr1.split(':');
    let hoursMinutes2 = timeStr2.split(':');
    let hours1 = parseInt(hoursMinutes1[0], 10);
    let hours2 = parseInt(hoursMinutes2[0], 10);
    let minutes1 = parseInt(hoursMinutes1[1], 10);
    let minutes2 = parseInt(hoursMinutes2[1], 10);

    // Compare hours
    if (hours1 < hours2) {
        return -1;
    } else if (hours1 > hours2) {
        return 1;
    } else {
        // Hours are equal, compare minutes
        if (minutes1 < minutes2) {
            return -1;
        } else if (minutes1 > minutes2) {
            return 1;
        } else {
            // Minutes are equal
            return 0;
        }
    }
};

GmCXt.truncate = function(text, maxlength) {
    if (!text) return '';
    return text.length > maxlength ? text.substring(0, maxlength) + '...' : text;
};

GmCXt.htmlToPlaintext = function(html) {
    return new DOMParser().parseFromString(html, 'text/html').body.textContent;
};

GmCXt.isCurrentHost = function(host) {
    if (GmCXt.urlParts && (GmCXt.urlParts.host.indexOf(host) !== -1 || location.href.indexOf(host) !== -1))
        return true;
    else
        return false;
};

GmCXt.getOrgStepWaitTime = function() {
    return 10000;
};

GmCXt.getInsightPageRulesFromAPI = function() {
    return new Promise(function(resolve, reject) {
        let appCode = "";
        if (GmCXt.externalAppId) {
            appCode = GmCXt.externalAppId;
        } else if (GmCXt.appList && GmCXt.activeAppId) {
            appCode = GmCXt.appList['app:' + GmCXt.activeAppId].external_id;
        }

        if (GmCXt.isEmpty(appCode)) resolve([]);

        GmCXt.api.getInsightPagesRules(appCode).then(function(result) {
            let insightPageRulesData = {
                sync_time: new Date().getTime()
            };
            if (result?.data?.tags && !GmCXt.isEmpty(result.data.tags)) {

                const filterEnableTags = result.data.tags.filter(tag => tag.is_tracking_enabled === true);

                insightPageRulesData = {
                    data: filterEnableTags,
                    sync_time: new Date().getTime()
                };
                GmCXt.insightPageRulesData = filterEnableTags;
            }

            GmCXt.storage().set({
                insightPageRulesData: JSON.stringify(insightPageRulesData)
            }).then(function() {
                resolve(GmCXt.insightPageRulesData);
            });
        }).catch(function(error) {
            resolve([]);
        });

    });
};

GmCXt.getInsightPageRules = function() {
    return new Promise(function(resolve, reject) {
        GmCXt.storage().get(['insightPageRulesData']).then(function(res) {
            if (res?.insightPageRulesData && !GmCXt.isEmpty(res.insightPageRulesData)) {
                let insightPageRulesData = GmCXt.parseJSON(res.insightPageRulesData);
                let syncTime = insightPageRulesData?.sync_time ? parseInt(insightPageRulesData.sync_time) : 0;
                let currentTime = new Date().getTime();
                if (currentTime - syncTime > GmCXt.t_.hr8) {
                    GmCXt.storage().remove(['insightPageRulesData']);
                    GmCXt.getInsightPageRulesFromAPI().then(function() {
                        resolve();
                    });
                } else {
                    GmCXt.insightPageRulesData = insightPageRulesData.data;
                    resolve();
                }

            } else {
                GmCXt.getInsightPageRulesFromAPI().then(function() {
                    resolve();
                });
            }

        }).catch(function(error) {
            reject();
        });
    });
};

GmCXt.getURLPartsFromURL = function(url) {
    var parser = document.createElement('a');
    parser.href = url;

    var urlParts = {};

    var host = parser.host;

    // Remove port number from host name, In IE port number coming with host
    if (host && host.indexOf(':') !== -1) {
        host = host.split(':')[0];
    }
    urlParts.host = host;

    urlParts.pathname = parser.pathname;
    urlParts.search = parser.search;
    urlParts.href = GmCXt.filterUrlScheme(parser.href);
    urlParts.fullUrl = parser.href;
    urlParts.hash = parser.hash;
    urlParts.scheme = GmCXt.getUrlScheme();
    urlParts.port = parser.port;
    urlParts.hostname = parser.hostname.replace("www.","");
    return urlParts;
};

GmCXt.stepPopupWidth = 300;
GmCXt.stepPopupMaxHeight = 400;

GmCXt.tourActivity = {};

GmCXt.validateAlphanumeric = function(str) {
    if (!str || !str.trim()) {
        return false;
    } else if (str.match(".*[a-zA-Z].*")) {
        return true;
    } else {
        return false;
    }
};

GmCXt.validateEmpty = function(str) {
    if (!str || !str.trim()) {
        return false;
    } else if (str.length > 0) {
        return true;
    } else {
        return false;
    }
};

GmCXt.validateLength = function(str, limit) {

    if (str && str.length) {
        str = mg$('<div />').html(str).text().trim();
        if (str.length <= limit) {
            return true;
        } else {
            return false;
        }
    }

    return false;
};

GmCXt.openAppPanel = function(action, source) {

    if (GmCXt.APP_PANEL_OPEN) return;

    if (!GmCXt.isEmpty(GmCXt.tourActivity) && Object.keys(GmCXt.tourActivity)) GmRootScope.refreshCurrentPage();

    GmCXt.removeChatIcon();

    if (GmCXt.initialization && GmCXt.initialization.sidePanel && GmCXt.playerDomainCheck()) {

        GmCXt.hideWidgetIcon();

        if (GmCXt.editStepTout) {
            clearTimeout(GmCXt.editStepTout);
            mg$('.mgPlayerJSProd_edit-step-loader').hide();
        }

        let byPassRoute = (action === "byPassRoute" || action === "playSlideShow") ? true : false;
        if (!byPassRoute) {
            GmCXt.isSidePanelOpen = true;
            if (action === "chatbot") {
                GmRootScope.setActivePage("chatbot");
            } else if (!GmCXt.user || GmCXt.isEmpty(GmCXt.user)) {
                GmRootScope.clearSession();
            }
        }

        if (GmCXt.tourPlayerI && (action !== "playSlideShow")) {
            GmCXt.tourPlayerI.stop(true);
            GmCXt.closePopup();
        } else if (GmCXt.isAutomationRunning()) {
            GmCXt.auto.stop(true);
        }

        if (GmCXt.user && GmCXt.user.user_key && source && !GmCXt.APP_PANEL_OPEN) {
            GmCXt.trackerV1.trackPanelOpen(source, action);
        }

        GmCXt.timeout(function() {
            let alignment = GmCXt.getWidgetAlignment();
            mg$(".mgPlayerJSProd_panel .mgPlayerJSProd_app").css(alignment, "0px");
            mg$(".mgPlayerJSProd_panel").css(alignment, "0px");
            mg$(".mgPlayerJSProd_panel").css("display", "block");
            mg$(".mgPlayerJSProd_ege-panel").css("display", "block");

            if (GmCXt.isMicroPlayer()) {
                mg$(".mgPlayerJSProd_panel .mgPlayerJSProd_app").css("right", "50px");
                mg$(".mgPlayerJSProd_panel").css("right", "50px");
                GmCXt.taskListOpen = false;
            } else {
                mg$(".mgPlayerJSProd_panel").removeClass('mgPlayerJSProd_theme-mplayer');
                mg$(".mgPlayerJSProd_panel").css("top", "0");
                GmCXt.showPanelCloseBtn();
            }

            GmCXt.removePreviewTop();
            mg$(".mgPlayerJSProd_panel").attr({
                'aria-hidden': false,
                'tabindex': 0
            });
            mg$("#mgPlayerJSProd_app").attr({
                'aria-hidden': false,
                'tabindex': 0
            });
            mg$("#mgPlayerJSProd_app")
                .attr({
                    "role": "dialog",
                    "aria-modal": "true",
                    "aria-label": "Extension Panel",
                    "tabindex": "0"
                })
                .focus();
        }, GmCXt.t.appPanel);

        GmCXt.smartTipPreviewOn = false;
        GmCXt.closeNotificationPopupSidePanel(true);
        GmCXt.APP_PANEL_OPEN = true;
    } else {
        GmCXt.showPanelDisabledPopup();
    }

    GmRootScope.setContainerHeight(GmRootScope.containerView);
    GmCXt.unlockScroll();
};

GmCXt.showPanelDisabledPopup = function() {
    if (GmCXt.isExtension()) {
        let m = {
            action: 'mgPlayerJSProd_action:to_background;task:show_panel_disabled_popup'
        };
        GmCXt.sendMessageToBackgroundService(m);
    }
};

GmCXt.hideTips = function() {
    GmCXt.hideBeacons();
    GmCXt.hideSmartTips();
    GmCXt.removePreviewTop();
};

GmCXt.filterApps = function(apps, search) {
    let r = [];
    for (let i = 0; i < apps.length; i++) {
        if (apps[i].indexOf(search) !== -1)
            r.push(apps[i]);
    }
    return r;
};

GmCXt.getByPrecedence = function(apps, p) {
    let r = [];

    for (let i = 0; i < p.length; i++) {
        if (!r.length && p[i])
            r = GmCXt.filterApps(apps, p[i]);
        else
            break;
    }

    return r;
};

GmCXt.appPrecedence = [
    GmCXt.conf.creatorApp,
    GmCXt.conf.playerExtension,
    GmCXt.conf.playerJS
];
GmCXt.envPrecedence = ["Test", "Stage", "Preview", "Prod"];

GmCXt.checkPrecedence = function() {

    let app = "";
    let r = GmCXt.getAppsArray(GmCXt.myGuideApps);

    if (r.length === 0 && GmCXt.user) {
        // First time, after user logins
        return true;
    }

    r = GmCXt.getByPrecedence(r, GmCXt.appPrecedence);

    if (r.length > 1) r = GmCXt.getByPrecedence(r, GmCXt.envPrecedence);

    if (r.length === 1) app = r[0];

    if (GmCXt.getAppName() === app) return true;
    else return false;
};

GmCXt.getChatIconVisibility = function() {
    let s = GmCXt.getAppSetting();

    if (GmCXt.isEmpty(s)) return false;

    let rules = s.chatBotrules || [];
    let match = true;
    if (s.enable_chatbot) {
        if (rules.length > 0 && rules[0].value !== '') {

            let oldRegEx = true;
            if (GmCXt.isDefined(s.clientVersion)) {
                oldRegEx = false;
            }

            match = GmCXt.ruleEngine.evaluateRules(rules, oldRegEx);
        }

        if (!match) {
            GmCXt.log(21, "RULES NOT MATCHED, Hide chat widget");
            return false;
        }
        return true;
    } else {
        return false;
    }
};

GmCXt.getWidgetVisibility = function(forceShowWidget) {

    if (GmCXt.tourPlayerI && !forceShowWidget) {
        GmCXt.log(8, "PLAYER INSTANCE EXIST. HIDE WIDGET " + GmCXt.getAppName());
        return false;
    }

    if (GmCXt.isAutomationRunning()) {
        GmCXt.log(8, "AUTOMATION RUNNING. HIDE WIDGET " + GmCXt.getAppName());
        return false;
    }

    if (!GmCXt.checkPrecedence() && !GmCXt.conf.showWidget) {
        GmCXt.log(8, "NO PREFERENCE. HIDE WIDGET " + GmCXt.getAppName());
        return false;
    }

    if (GmCXt.snowApp) {
        GmCXt.log(8, "HIDE WIDGET on LXP || snowApp");
        return false;
    }

    if (GmCXt.isMcKessonClientJS()) {
        GmCXt.log(8, "HIDE WIDGET on McKesson ClientJS");
        return false;
    }

    let s = GmCXt.getWidgetSettings();

    if (!GmCXt.isEmpty(s) && s) {
        if (GmCXt.isFalse(s.showWidgetIcon)) {
            GmCXt.log(8, "HIDDEN IN ORG SETTINGS");
            return false;
        }

        let rules = s.rules || [];
        let match = true;

        if (rules.length > 0 && rules[0].value !== '') {

            let oldRegEx = true;
            if (GmCXt.isDefined(s.clientVersion)) {
                oldRegEx = false;
            }

            match = GmCXt.ruleEngine.evaluateRules(rules, oldRegEx);
        }

        if (!match) {
            GmCXt.log(8, "RULES NOT MATCHED, hide widget");
            return false;
        }

        if (s.hide_widget_if_noguide && GmCXt.isPlayer()) {
            if (!GmCXt.ifGuidesOnCurrentPage) {
                GmCXt.log(8, "NO GUIDES ON CURRENT PAGE. HIDE WIDGET " + GmCXt.getAppName());
                return false;
            }
        }

    } else if (!GmCXt.conf.showWidget) {
        return false;
    }

    return true;
};

GmCXt.displayWidget = function(forceShowWidget) {
    if (GmCXt.getWidgetVisibility(forceShowWidget)) {
        let widget = GmCXt.getWidgetInstance();
        if (widget.length) {
            GmCXt.getWidgetInstance().show();
            GmCXt.showCurrentPageGuidesIndicator();
        } else {
            GmCXt.showWidget();
        }
    } else {
        GmCXt.hideWidgetIcon();
    }
};

GmCXt.displayChatIcon = function(forceShowWidget) {
    if (!GmCXt.organization) {
        GmCXt.removeChatIcon();
        return;
    }

    if (GmCXt.isPlayer() && GmCXt.isChatEnable()) {
        let chat = GmCXt.getChatIconInstance();
        if (chat.length) {
            GmCXt.getChatIconInstance().show();
        } else {
            GmCXt.showChatIcon();
        }
    } else {
        GmCXt.removeChatIcon();
    }
};

GmCXt.getDocTitle = function() {
    let title = document.title;
    let parts = title.split(' '); // Split the string into words
    let newParts = [];
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        // Check if the part is a potential email address
        if (part.indexOf('@') !== -1 && part.indexOf('.') !== -1 && part.charAt(0) !== '.') {
            newParts.push(''); // Replace with an empty string
        } else {
            newParts.push(part); // Keep the part as is
        }
    }
    title = newParts.join(' '); // Join the parts back into a string
    return title;
};

/** @function Alert function to show message to a user
    * @param {object} options - having properties
    *  title: Popup title.
    *  message: Popup description.
    *  callback: Callback function to call on 'Ok' button click event.
    *  type: Popup type. For 'Confirm' type, 'Cancel' button is shown.
    */
GmCXt.alert = function(options) {
    options = options || {};

    let pub = {};

    let self = {
        title: options.title,
        description: options.description,
        callback: options.callback,
        type: options.type
    };

    pub.show = function() {
        let popupType = 'mgPlayerJSProd_popup-info';
        let popupDescription = "";

        if (self.description) {
            popupDescription = "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-info'>" + self.description + "</wmgPlayerJSProd_>";
        }

        let cancelButton = "";
        let okButton = "<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-ok mgPlayerJSProd_btn-default mgPlayerJSProd_ok-btn mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.ok + "</wmgPlayerJSProd_>";

        if (self.type === "confirm") {
            cancelButton = "<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-cancel mgPlayerJSProd_btn-default mgPlayerJSProd_btn-neutral mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.btnCancel + "</wmgPlayerJSProd_>";

        } else if (self.type === "onboarding") {
            okButton = "<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-ok mgPlayerJSProd_btn-default mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.btnGuideMe + "</wmgPlayerJSProd_>";
            cancelButton = "<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-cancel mgPlayerJSProd_btn-default mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.btnSkip + "</wmgPlayerJSProd_>";
        }

        let html = " <wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-outer'></wmgPlayerJSProd_>" +
            " <wmgPlayerJSProd_ class='mgPlayerJSProd_popup " + popupType + "'>" +
            "    <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
            "	    <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>" +
            "     </wmgPlayerJSProd_>" +
            " 	  <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'>" + self.title + "</wmgPlayerJSProd_>" +
            popupDescription +
            "     <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper'>" +
            okButton +
            cancelButton +
            "    </wmgPlayerJSProd_>" +
            " </wmgPlayerJSProd_>";

        mg$("body").append(html);

        mg$(".mgPlayerJSProd_popup-header-icon").html(GmCXt.svgs.popup_info);

        mg$(".mgPlayerJSProd_panel-popup-outer").css('height', mg$(document).height());

        mg$(".mgPlayerJSProd_panel-popup-ok").on("click", function() {
            if (mg$.isFunction(self.callback))
                self.callback();
            pub.close();
        });

        mg$(".mgPlayerJSProd_panel-popup-cancel").on("click", function() {
            pub.close();
        });
    };

    pub.close = function() {
        mg$(".mgPlayerJSProd_popup").remove();
        mg$(".mgPlayerJSProd_panel-popup-outer").remove();
    };

    return pub;
};

GmCXt.lockScroll = function() {
    mg$('html').css('overflow', 'hidden');
};

GmCXt.getAutoLaunchTourId = function() {
    return localStorage.getItem(GmCXt.storagePrefix + 'autoLaunchTour');
};

GmCXt.isAutoTour = function() {
    let auto = localStorage.getItem(GmCXt.storagePrefix + 'autoLaunchTour');
    auto = parseInt(auto);
    if (!isNaN(auto) && auto > 0) {
        return true;
    } else {
        return false;
    }
};

GmCXt.showForceMode = function() {
    GmCXt.closePopup();
    let popupType = 'mgPlayerJSProd_popup-info';
    let html =
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_overlay-container'></wmgPlayerJSProd_>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup " + popupType + "'>" +
        "   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
        "	   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>" +
        "   </wmgPlayerJSProd_>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'>" + GmCXt.escapeHtml(GmCXt.label.userNotFollowingGuideMessage) + "</wmgPlayerJSProd_>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper'>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_btn-default mgPlayerJSProd_btn-continue-guide mgPlayerJSProd_ok-btn mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.continueGuide + "</wmgPlayerJSProd_>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_btn-default mgPlayerJSProd_btn-neutral mgPlayerJSProd_btn-exit-guide mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.exitGuide + "</wmgPlayerJSProd_>" +
        "</wmgPlayerJSProd_>" +
        "</wmgPlayerJSProd_>";

    mg$("html").append(html);

    GmCXt.stopAudio();

    mg$(".mgPlayerJSProd_popup-header-icon").html(GmCXt.svgs.popup_info);
    GmCXt.enforceGuideMePopup = true;
    GmCXt.pauseAutomation();

    let windowHeight = mg$(window).height();
    let popupTop = (windowHeight - mg$('.mgPlayerJSProd_popup').height()) / 2;
    mg$('.mgPlayerJSProd_popup').css("top", popupTop);

    function close(e) {
        GmCXt.stopPropagation(e);
        GmCXt.closePopup();
        GmCXt.enforceGuideMePopup = false;
        if (GmCXt.playerI) GmCXt.resumeAutomation();
    }

    mg$(".mgPlayerJSProd_btn-continue-guide").on("click", close);

    mg$(".mgPlayerJSProd_btn-exit-guide").on("click", function(e) {
        if (GmCXt.isExitSurvey()) {
            GmCXt.showExitSurvey();
        }
        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.stop();
        }
        close(e);
    });

    mg$(".mgPlayerJSProd_popup-close-button").on("click", close);
};

GmCXt.firstStepAutoLaunch = function() {

    // if user has played first step already than going previously at 1st step
    // don't show the option for the auto launch

    let t = GmCXt.playerI && GmCXt.playerI.tour;
    let viewNot = (GmCXt.user && GmCXt.user.settings.viewed_guide_notifications) || {};
    let result = false;

    if (GmCXt.isAutoTour() && GmCXt.isFirstNonAutomationStep()) {
        if (!GmCXt.isDefined(viewNot[t.tour_id]) || (viewNot[t.tour_id] < parseInt(t.version))) {
            result = true;
        }
    }

    return result;
};

GmCXt.pauseAutomation = function() {
    if (GmCXt.playerI && GmCXt.playerI.automate) {
        GmCXt.playerI.pauseAutomate = true;
        GmCXt.sendMessageToSyncPlayerI();
    }
};

GmCXt.resumeAutomation = function() {
    if (GmCXt.playerI) {
        GmCXt.playerI.pauseAutomate = false;
        GmCXt.sendMessageToSyncPlayerI();
    }
};

GmCXt.sendMessageToSyncPlayerI = function() {
    let msg = "mgPlayerJSProd_action:sync_playerinstance_for_automation";
    let data = {};
    data.playerInstance = GmCXt.playerI;
    GmCXt.sendMessageToAllWindows(msg, data);
};

GmCXt.getUrlParameter = function(sParam) {
    let pageURL = decodeURIComponent(GmCXt._location().search.substring(1));
    return GmCXt.getParameterValue(sParam, pageURL);
};

GmCXt.getParameterValue = function(sParam, url) {
    if (sParam && url) {
        let sURLVariables = url.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    }

    return false;
};

GmCXt.hideTooltipDelay = function(step, options) {

    if (window.self === window.top) {
        GmCXt.hideTooltipTimeout = GmCXt.timeout(function() {
            GmCXt.hideTooltip(step, options);
        }, GmCXt.t.hiteTooltip);
    } else {
        let data = {
            stepId: step.step_id,
            options: options
        };
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:hide_smarttip_delay', data);
    }
};

GmCXt.clearTooltipTimeout = function() {

    if (window.self === window.top) {
        clearTimeout(GmCXt.hideTooltipTimeout);
    } else {
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:clear_smarttip_delay_timeout');
    }
};

GmCXt.hideValidationTooltip = function(step) {
    let data = {
        stepId: step.step_id
    };
    if (window.self === window.top) {
        GmCXt.requestHandler.hideValidationSmarttip(data);
    } else {
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:hide_validation_smarttip', data);
    }

    mg$("#mgPlayerJSProd_smarttip-valid-" + step.step_id).hide();
};

GmCXt.hideTooltip = function(step, options) {
    let data = {
        stepId: step.step_id
    };

    if (window.self === window.top) {
        GmCXt.requestHandler.hideSmartTip(data, options);
    } else {
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:hide_smarttip', data);
    }
};

GmCXt.validateDateFormat = function(str) {
    let matches =
        /^(\d{1,2})[:](\d{1,2})[:](\d{4})$/.exec(str) || // HH:MM:YYYY
        /^(\d{1,2})[-](\d{1,2})[-](\d{4})$/.exec(str) || // DD-MM-YYYY or MM-DD-YYYY
        /^(\d{1,2})[/](\d{1,2})[/](\d{4})$/.exec(str) || // DD/MM/YYYY or MM/DD/YYYY
        /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/.exec(str); // YYYY/MM/DD


    if (matches == null) return false;

    if (matches[1].length === 4) {
        // YYYY/MM/DD
        y = matches[1];
        m = matches[2] - 1;
        d = matches[3];
    } else {
        // DD/MM/YYYY, MM-DD-YYYY, etc.
        d = matches[2];
        m = matches[1] - 1;
        y = matches[3];
    }

    let composedDate = new Date(y, m, d);
    return composedDate.getDate() == d &&
        composedDate.getMonth() == m &&
        composedDate.getFullYear() == y;
};

GmCXt.validateTimeFormat = function(str) {
    let isValid = false;
    if (str.length > 8)
        isValid = false;
    else if (str.length < 6) {
        isValid = /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(str);
    } else {
        isValid = /(?:[01]\d|2[0123]):(?:[012345]\d):(?:[012345]\d)/.test(str);
    }
    return isValid;
};

GmCXt.validateNumeric = function(str) {
    //  check for valid numeric strings
    let strValidChars = "0123456789.-";
    let strChar;
    let blnResult = true;

    if (str.length === 0) return false;

    //  test strString consists of valid characters listed above
    for (i = 0; i < str.length && blnResult === true; i++) {
        strChar = str.charAt(i);
        if (strValidChars.indexOf(strChar) == -1) {
            blnResult = false;
        }
    }
    return blnResult;
};

GmCXt.validatePhonenumber = function(str) {
    let isValid = /^[1-9][0-9]{4,14}$/.test(str);
    return isValid;
};

GmCXt.validateEmail = function(str) {
    let re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(str);
};

GmCXt.validateRegex = function(regex, value) {
    let re = new RegExp(regex);
    return re.test(value);
};

GmCXt.getBulletCount = function(value) {
    return (value.match(/<li/g) || []).length;
};

GmCXt.validateWebUrl = function(str) {
    let re = /^(http[s]?:\/\/){0,1}(www\.){0,1}[a-zA-Z0-9\.\-]+\.[a-zA-Z]{2,5}[\.]{0,1}/;
    return re.test(str);
};

GmCXt.getMatchingFrame = function(frames, event, match) {
    for (let i = 0, len = frames.length; i < len; i++) {
        frame = frames[i];
        // check if frame window matches to the sender window
        if (frame.contentWindow == event.source) {
            match.found = true;
            match.frame = frame;
            break;
        }
    }
    return match;
};

GmCXt.addFrameOffset = function(event, pos) {
    let match = {
        found: false,
        frame: null
    };

    let frames = document.getElementsByTagName('iframe');
    match = GmCXt.getMatchingFrame(frames, event, match);

    if (!match.found) {
        frames = document.getElementsByTagName('frame');
        match = GmCXt.getMatchingFrame(frames, event, match);
    }

    if (!match.found) {
        frames = GmCXt.getIframesFromShadowDom();
        match = GmCXt.getMatchingFrame(frames, event, match);
    }

    if (match.found) {

        const iframe = match.frame;
        const rect = iframe.getBoundingClientRect();
        let nestedRect = { left: 0, top: 0 };

        const querySelector = event?.data?.data?.data?.querySelector;
        const iframeDoc = iframe?.contentDocument;

        if (querySelector && iframeDoc && !iframeDoc.querySelector(querySelector)) {
            let nestedIframes = iframeDoc.querySelectorAll("iframe");
            for (const nestedIframe of nestedIframes) {
                const nestedDoc = nestedIframe?.contentDocument;
                const elementInsideNestedIframe = nestedDoc?.querySelector(querySelector);

                if (elementInsideNestedIframe) {
                    nestedRect = nestedIframe.getBoundingClientRect();
                    break;
                }
            }
        }

        pos.left += rect.left + nestedRect.left;
        pos.top += rect.top + nestedRect.top;
    }

    pos.windowWidth = mg$(window).width();
    pos.windowHeight = mg$(window).height();

    return pos;
};

GmCXt.addScrollOffset = function(position, cssPosition) {
    if (!cssPosition) {
        let top = mg$(window).scrollTop();
        let left = mg$(window).scrollLeft();

        position.left += left;
        position.origTop = position.top;
        position.top += top;
    }

    return position;
};

GmCXt.extractFileName = function(url) {
    let arr = url.split("/");
    if (arr.length > 1) {
        return GmCXt.conf.webServiceUrl + arr[arr.length - 1];
    } else {
        return url;
    }
};

GmCXt.clearPreviewPopupAlignment = function($popup) {
    $popup
        .removeClass('top-left')
        .removeClass('top-middle')
        .removeClass('top-right')
        .removeClass('right-top')
        .removeClass('right-middle')
        .removeClass('right-bottom')
        .removeClass('bottom-left')
        .removeClass('bottom-middle')
        .removeClass('bottom-right')
        .removeClass('left-top')
        .removeClass('left-middle')
        .removeClass('left-bottom');
};

GmCXt.removePreviewTop = function() {
    GmCXt.removePreviewFrame();
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:remove_preview");
};

GmCXt.hideSmartTipsIfOptionON = function() {
    let org = GmCXt.organization;
    if (org && org.admin_settings.show_tooltips_during_workflow_guide) {
        return;
    }
    GmCXt.hideSmartTips();
};

GmCXt.hideSmartTips = function() {
    mg$('.mgPlayerJSProd_smarttip-icon').addClass('tooltip-hidden');
    mg$('.mgPlayerJSProd_smarttip').addClass('tooltip-hidden');
    mg$('.mgPlayerJSProd_smarttip-valid').addClass('tooltip-hidden');
    GmCXt.smarttipAreHidden = true;
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:hide_all_smarttip");
};

GmCXt.showSmartTips = function(forceShow) {

    if ((GmCXt.tourPlayerI && !forceShow) || GmCXt.isSurveyVisible) return;

    mg$('.mgPlayerJSProd_smarttip-icon').removeClass('tooltip-hidden');
    mg$('.mgPlayerJSProd_smarttip').removeClass('tooltip-hidden');
    mg$('.mgPlayerJSProd_smarttip-valid').removeClass('tooltip-hidden');
    GmCXt.smarttipAreHidden = false;
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:show_all_smarttip");
};

GmCXt.previewSmartTips = function(id) {
    mg$('.mgPlayerJSProd_smarttip-icon-wrapper-' + id).removeClass('tooltip-hidden');
    mg$('.mgPlayerJSProd_smarttip-icon-wrapper-' + id).show();
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:show_preview_smarttip", {
        id: id
    });
};

GmCXt.hideBeacons = function() {
    mg$('.mgPlayerJSProd_beacon-icon').addClass('mgPlayerJSProd_hidden');
    mg$('#mgPlayerJSProd_beacon-icon-pos-select').show();
    GmCXt.beaconsAreHidden = true;
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:hide_beacons");
};

GmCXt.showBeacons = function(forceShow) {

    if ((GmCXt.tourPlayerI && !forceShow) || GmCXt.isSurveyVisible) {
        GmCXt.log(48, "STOP showing beacons. player instance || survey on screen");
        return;
    }

    mg$('.mgPlayerJSProd_beacon-icon').removeClass('mgPlayerJSProd_hidden');
    mg$('#mgPlayerJSProd_beacon-icon-pos-select').hide();
    GmCXt.beaconsAreHidden = false;
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:show_beacons");
};

GmCXt.previewBeacons = function(id) {
    mg$('.mgPlayerJSProd_beacon-icon-tour-' + id).removeClass('mgPlayerJSProd_hidden');
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:show_preview_beacons", {
        id: id
    });
};

GmCXt.getScrollParent = function(node) {

    if (node == null || node.nodeType !== 1) return null;

    let tag = node.tagName;
    if (tag) tag = tag.toLowerCase();

    if (tag == 'body' || tag == 'html') return null;

    let overflowY = getComputedStyle(node).overflowY;

    let isScrollable = (overflowY === 'auto' || overflowY === 'scroll');

    if (isScrollable && node.scrollHeight > (node.clientHeight + 5)) {
        return node;
    } else {
        return GmCXt.getScrollParent(node.parentNode);
    }
};

GmCXt.setPopUpForImage = function(description, parentClassName) {
    // Check for image exist if yes then add popup js
    let imgSrc = '';
    GmCXt.setImagePopUp();
    let fsBtn = "<wmgPlayerJSProd_ class='mgPlayerJSProd_full-screen-icon-cont'><button class='mgPlayerJSProd_full-screen-icon'>&#x26F6;</button></wmgPlayerJSProd_>";

    mg$(parentClassName).addClass('mgPlayerJSProd_play-step-popup-loader');

    let stepPopupImgList = mg$(parentClassName + ' img');

    let finalStepPopupContent = "";

    stepPopupImgList.each(function(index, imgEl) {
        let img = mg$(imgEl);
        if (img.parent().hasClass('mgPlayerJSProd_step-img-popup-cont')) return; // Avoid double wrapping

        let imgWidth = img[0].width;
        let imgHeight = img[0].height;

        let showFullScreen = imgWidth >= 90 && imgHeight >= 90; // Only show if image is at least 90x90

        let stepImgOverlay = "<div class='mgPlayerJSProd_step-img-popup-overlay'></div>";
        let newStepImgWrapper = mg$("<div class='mgPlayerJSProd_display-inline-block mgPlayerJSProd_position-relative mgPlayerJSProd_step-img-popup-cont'></div>");
        newStepImgWrapper.append(stepImgOverlay);
        if(showFullScreen) newStepImgWrapper.append(fsBtn);
        img.before(newStepImgWrapper);
        newStepImgWrapper.append(img);
    });

    mg$(parentClassName + ' img').addClass('mgPlayerJSProd_custom-image');

    mg$(".mgPlayerJSProd_full-screen-icon").html(GmCXt.svgs.fullscreen);

    mg$('.mgPlayerJSProd_full-screen-icon').on("click", function(e) {
        e.stopPropagation();
        e.preventDefault();
        var modalImg = document.getElementById("mgPlayerJSProd_img_desc");
        var container = this.closest('.mgPlayerJSProd_step-img-popup-cont');
        var imgElem = container.getElementsByTagName('img')[0];
        imgSrc = imgElem.src;
        var imgWrp = document.getElementsByClassName('mgPlayerJSProd_image-popup')[0];
        GmCXt.stopPropagation(e);
        imgWrp.style.display = "block";
        modalImg.src = imgSrc;
        mg$('.mgPlayerJSProd_preview-step-popup-container').css({
            'z-index': '2147483646'
        });
    });



    mg$(parentClassName + ' img').on("load", function() {
        if (GmCXt.alignPopupI) GmCXt.alignPopupI.redo();
        mg$(parentClassName).removeClass('mgPlayerJSProd_play-step-popup-loader');
    });
};

GmCXt.getText = function(s) {
    if (s) {
        s = mg$('<gssdummy />').html(s).text();
    }
    return s;
};

GmCXt.singleLineTitle = function(t) {
    let c = '';
    if (t && t.length < 28) c = 'mgPlayerJSProd_nowrap-div';
    return c;
};

GmCXt.setLinkClickhandler = function(description, parentClassName) {
    if (description && description.indexOf("<a ") !== -1) {
        mg$(parentClassName + ' a').each(function() {
            let anchorTag = this;
            if (anchorTag.querySelector('img[class$="_custom-image"]')) {
                anchorTag.style.position = 'relative';
            }
            mg$(parentClassName + ' a').on("click", function(e) {
                GmCXt.handleLinkClickEvent(e);
            });
        });
    }
};

GmCXt.setTooltipLinkClickhandler = function(description, parentClassName, linkData) {
    if (description && description.indexOf("<a ") !== -1) {
        mg$(parentClassName + ' a').each(function(linkIndex, linkElement) {
            var linkId = "mgPlayerJSProd_tlink" + linkIndex + "-sid" + linkData.sid;
            if (GmCXt.isEmpty(linkElement.id)) {
                linkElement.id = linkId;
                linkElement.sid = linkData.sid;
                linkElement.tid = linkData.tid;
                linkElement.opt = JSON.stringify(linkData.opt);
            }
            linkElement.style.position = 'relative';

            mg$('#' + linkId).off().on("click", function(e) {
                GmCXt.handleLinkClickEvent(e);
            });
        });
    }
};

GmCXt.getPageHostPathName = function() {
    let hostname = GmCXt._location().hostname;
    let pathname = GmCXt._location().pathname;
    return hostname + pathname;
};

GmCXt.getAppName = function() {
    let a = GmCXt.conf.appName;

    if (GmCXt.isPlayer() && !GmCXt.playerMode) a += GmCXt.conf.appType;

    return a + GmCXt.conf.env;
};

GmCXt.reportPresence = function() {
    let message = {
        action: 'MyGuideReporting',
        data: GmCXt.getAppName()
    };

    GmCXt.log(63, "Broadcast presence of: " + GmCXt.getAppName());
    GmCXt.sendToParentWindow(message);
};

GmCXt.setOnAudioMode = function() {
    let d = {
        user: GmCXt.user
    };
    GmCXt.sendMsgToAudioFrame('mgPlayerJSProd_action:set_audio_mode_on', d);
};

GmCXt.setOffAudioMode = function() {
    let d = {
        user: GmCXt.user
    };
    GmCXt.sendMsgToAudioFrame('mgPlayerJSProd_action:set_audio_mode_off', d);
};

GmCXt.setOnOnBoarAudioMode = function() {
    mg$('.mgPlayerJSProd_tooltip-title-mute').show();
    mg$('.mgPlayerJSProd_tooltip-title-unmute').hide();
    mg$('.mgPlayerJSProd_onboarding-audio-off').hide();
    mg$('.mgPlayerJSProd_onboarding-audio-on').show();
    mg$('.mgPlayerJSProd_onboarding-audio').addClass('playing-audio');
};

GmCXt.setOffOnBoarAudioMode = function() {
    mg$('.mgPlayerJSProd_tooltip-title-mute').hide();
    mg$('.mgPlayerJSProd_tooltip-title-unmute').show();
    mg$('.mgPlayerJSProd_onboarding-audio-on').hide();
    mg$('.mgPlayerJSProd_onboarding-audio-off').show();
    mg$('.mgPlayerJSProd_onboarding-audio').removeClass('playing-audio');
};

GmCXt.getBoundingRect = function(he) {
    try {
        return he.getBoundingClientRect();
    } catch (e) {
        return false;
    }
};

GmCXt.getElVisibility = function(el, isFrame) {
    let display = 'visible';

    if (!isFrame && isUBSDrawerEl(el)) {
        return 'visible';
    }

    if (!el || !isVisibleByElStyle(el, true)) {
        display = 'hidden';
    } else {
        let pos = GmCXt.getBoundingRect(el);
        if (!pos) return 'hidden';

        let xPosMid = pos.left + (pos.width / 2);
        let yPosMid = pos.top + (pos.height / 2);

        if (xPosMid > window.innerWidth) {
            xPosMid = pos.left + (window.innerWidth - pos.left) / 2;
        } else if (xPosMid < 0) {
            xPosMid = (pos.left + pos.width) / 2;
        }

        if (yPosMid > window.innerHeight) {
            yPosMid = pos.top + (window.innerHeight - pos.top) / 2;
        } else if (yPosMid < 0) {
            yPosMid = (pos.top + pos.height) / 2;
        }

        disable('.mgPlayerJSProd_smarttip-icon');
        disable('.mgPlayerJSProd_beacon-icon');

        const doc = el.ownerDocument || document;

        let topEl = doc.elementFromPoint(xPosMid, yPosMid);

        if (!isFrame && isUBSDrawerOpen(topEl)) {
            return 'hidden';
        }

        enable('.mgPlayerJSProd_smarttip-icon');
        enable('.mgPlayerJSProd_beacon-icon');

        if (topEl === null) {
            topEl = document.elementFromPoint(pos.left, pos.top);

            if (topEl === null) {
                topEl = document.elementFromPoint(pos.left + pos.width, pos.top);
            }
            if (topEl === null) {
                topEl = document.elementFromPoint(pos.left, pos.top + pos.height);
            }
            if (topEl === null) {
                topEl = document.elementFromPoint(pos.left + pos.width, pos.top + pos.height);
            }
        }

        if (topEl === null) {
            display = 'hidden';
        } else {

            if (el !== topEl && !GmCXt.isMyGuideEl(topEl)) {
                let containsShadowRoot = (el.getRootNode !== undefined && el.getRootNode() instanceof ShadowRoot);

                if (mg$.contains(topEl, el) || (containsShadowRoot && !isFrame)) {

                    if (!checkParentVisibility(topEl, el, containsShadowRoot) && !GmCXt.checkServiceNow()) {
                        display = 'hidden';
                    }

                } else if (!mg$.contains(topEl, el) && !mg$.contains(el, topEl) &&
                    (el.parentNode && !mg$.contains(el.parentNode, topEl)) &&
                    isElCompletelyCovered(el, topEl)) {

                    display = 'hidden';

                }
            }
        }
    }

    function isUBSDrawerEl(el) {
        if (el && GmCXt.checkUBS()) {
            let temp = el;
            while (temp && temp !== document) {
                if (temp.classList.contains('drawer-dialog') || temp.tagName === 'BRML-DRAWER') {
                    return true;
                }
                temp = findParent(temp);
            }
        }
        return false;
    }

    function isUBSDrawerOpen(topEl) {

        /*
        HTML structure:
        'BR-PLUTUX-RCAP-GEN5' >
            'shadowRoot' >
                'div.rcap-container' > 'BR-PLUTUX-CONTEXT-BASED-DRAWERS-GEN5'
                    3 children '<type>-DRAWER-GEN5' each of which is populated by HTML if either kind of drawer is opened
        */

        if (GmCXt.checkUBS() && topEl && topEl.tagName === 'BR-PLUTUX-RCAP-GEN5') {
            // Element in background; checking if drawer is open
            let temp = topEl.shadowRoot;
            if (temp) {
                temp = mg$(temp).find('BR-PLUTUX-CONTEXT-BASED-DRAWERS-GEN5');
                if (temp.length) {
                    temp = temp[0].shadowRoot;
                    let nodes = mg$(temp).children();
                    for (let i in nodes) {
                        let node = nodes[i];
                        if (node.tagName && node.tagName.includes('-DRAWER-GEN5')) {
                            temp = node.shadowRoot;
                            temp = mg$(temp).find('BRML-DRAWER');
                            if (temp.length) {
                                temp = temp[0].shadowRoot;
                                temp = mg$(temp).find('wmgPlayerJSProd_.drawer-dialog');
                                if (temp.length) return true;
                            }
                        }
                    }
                }
            }
        }
        return false;
    }

    function checkParentVisibility(topEl, el, checkPosition) {
        let visible = true;

        while (el !== topEl && el !== document) {

            if (el && GmCXt.checkUBS() && el.classList.contains('hydrated')) {
                // Custom handling for UBS
                // Skip elements with 'hydrated' class as they return incorrect visibility by style
                el = findParent(el);
                continue;
            }

            if (!el || !isVisibleByElStyle(el, checkPosition)) {
                visible = false;
                break;
            }

            const parent = findParent(el);

            if (parent && parent !== document) {
                const overflowY = getComputedStyle(parent).overflowY;
                if (overflowY === 'auto' || overflowY === 'scroll') {
                    const elRect = el.getBoundingClientRect();
                    const containerRect = parent.getBoundingClientRect();
                    if (
                        elRect.bottom > containerRect.bottom ||
                        elRect.top < containerRect.top
                    ) {
                        visible = false;
                        break;
                    }
                }
            }

            el = parent;
        }

        if (visible) {
            const rect = el.getBoundingClientRect();
            if ( rect.top < 0 || rect.bottom > (window.innerHeight || document.documentElement.clientHeight) ) {
                visible = false;
            }
        }

        return visible;
    }

    function findParent(el) {
        if (el) {
            let temp = el.parentElement || el.getRootNode().host || el.getRootNode();
            if (temp !== el) {
                return temp;
            }
        }
        return null;
    }

    function isVisibleByElStyle(el, checkPosition) {
        if (!mg$(el).is(':visible')) {
            return false;
        }

        let style = getComputedStyle(el);
        if (style.visibility === 'hidden') {
            return false;
        }

        if (parseFloat(style.opacity) <= 0) {
            return false;
        }

        if (checkPosition) {
            if (parseInt(style.height) <= 0 || parseInt(style.width) <= 0) {
                return false;
            }
            if (style.position === 'fixed' && (parseInt(style.left) + parseInt(style.width) <= 0 || parseInt(style.top) + parseInt(style.height) <= 0)) {
                return false;
            }
        }

        return true;
    }

    function isElCompletelyCovered(el, topEl) {

        let pos = GmCXt.getBoundingRect(el);
        let topElPos = topEl.getBoundingClientRect();

        if (topElPos.height < pos.height || topElPos.width < pos.width) {
            let tempTop = topEl;
            while (tempTop !== document && !mg$.contains(tempTop.parentNode, el)) {
                tempTop = tempTop.parentNode;
                if (tempTop.offsetHeight > pos.height && tempTop.offsetWidth > pos.width) {
                    return true;
                }
            }
            if (GmCXt.checkSalesForceSite()) {
                let calender = mg$(topEl).parents("lightning-calendar");
                if (calender.length && GmCXt.dom.levelCheck(calender[0], topEl, 10)) {
                    return true;
                }
            }
            return false;
        }

        let width20pc = (20 / 100) * pos.width;
        let height20pc = (20 / 100) * pos.height;

        let left = pos.left + width20pc;
        let right = pos.right - width20pc;
        let top = pos.top + height20pc;
        let bottom = pos.bottom - height20pc;

        if (topElPos.top <= pos.top && topElPos.bottom >= pos.bottom &&
            topElPos.left <= pos.left && topElPos.right >= pos.right) {
            return true;
        } else if (document.elementFromPoint(left, top) !== el &&
            document.elementFromPoint(right, top) !== el &&
            document.elementFromPoint(left, bottom) !== el &&
            document.elementFromPoint(right, bottom) !== el) {
            return true;
        }

        return false;
    }

    function disable(selector) {
        mg$(selector).css("pointer-events", "none");
    }

    function enable(selector) {
        mg$(selector).css("pointer-events", "initial");
    }

    return display;
};

// Extracts Tag name from GuideMe JS Selector
GmCXt.getTagName = function(selector) {
    let tag = selector.match(/^(.*?)\[/g);
    if (tag === null) {
        tag = selector.match(/^(.*?)(:visible|:eq)/g);
        tag = tag[0].replace(/:visible|:eq/g, '');
        return tag;
    } else {
        tag = tag[0].replace(/\[/g, '');
        return tag;
    }
};

GmCXt.isLooping = function() {

    let PI = GmCXt.playerI;
    let flag = false;

    if (PI.loops - PI.currentLoop > 0) {
        flag = true;
        GmCXt.log(33, "Current loop: " + PI.currentLoop);
    }
    return flag;
};

GmCXt.openPowerForm = function(data) {

    if (window.self === window.top) {
        GmCXt.showPowerForm(data);
    } else {
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:open_power_form', data);
    }
};

GmCXt.rotateGear = function() {
    let c = 1;
    let i = null;

    let id = '#mgPlayerJSProd_auto-progress-';
    let cls = 'mgPlayerJSProd_active-progress';

    i = setInterval(function() {
        if (c === 1 || mg$(id + (c - 1)).hasClass(cls)) { // check for the previous gear
            mg$(id + c).addClass(cls);
        }
        c++;
        if (c > 3) clearInterval(i);
    }, 900);
};

GmCXt.removeTooltips = function(t) {

    GmCXt.log(43, "REMOVE Tooltip" + GmCXt.tourLog(t));

    for (let j = 0; j < t.steps.length; j++) {
        let step = t.steps[j];
        let data = {
            step_id: step.step_id,
            tour_id: t.tour_id
        };

        if (GmCXt.inTopWindow(step.step_settings)) {
            GmCXt.requestHandler.removeToolip(data);
        } else {
            GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:remove_tooltip", data);
        }

        if (t.steps[j].step_settings.smartTip.type === 'injector') {
            GmCXt.removePowerForm();
        }

    }
};

GmCXt.updateBeaconsOnScreen = function(tourId, isValid) {

    if (window.self === window.top) {
        tourId = parseInt(tourId);
        let i = GmCXt.beaconsOnScreen.indexOf(tourId);

        if (isValid && i < 0) {
            GmCXt.beaconsOnScreen.push(tourId);
            GmCXt.log(49, "ADDED on screen: " + tourId);
            GmCXt.auto.setBeaconsAutoDataToStorage(GmCXt.beaconsOnScreen);
            GmCXt.setBeaconsDisplayFrequency(tourId);
        } else if (!isValid) {
            GmCXt.beaconsOnScreen.splice(i, 1);
            GmCXt.log(49, "REMOVED from screen: " + tourId);
        }
    } else {
        let data = {
            jobId: tourId,
            isValid: isValid
        };
        GmCXt.sendMessageToTheTopWindow("mgPlayerJSProd_action:update_beacons_on_screen", data);
    }
};

GmCXt.setOnScreenTooltipGuideInfo = function(tour) {

    GmCXt.log(43, "INFO SET: " + GmCXt.tourLog(tour));

    let tid = "tour_" + tour.tour_id;
    let t = GmCXt.onScreenTooltipGuideInfo[tid];

    if (t) {
        GmCXt.onScreenTooltipGuideInfo[tid].total = tour.steps.length;
    } else {
        GmCXt.onScreenTooltipGuideInfo[tid] = {
            total: tour.steps.length,
            visible: [],
            watchRules: tour.tour_settings.ruleCheckOnClick
        };
    }
    GmCXt.onScreenTooltipGuideInfo[tid].rules = tour.tour_settings.rules.map(function(rule) {
        return rule.type;
    });

    if (GmCXt.isAutomationRunning()) {
        GmCXt.tooltipInfoForAutomation = Object.assign({}, GmCXt.onScreenTooltipGuideInfo);
    }
};

GmCXt.updateOnScreenTooltipGuideIds = function(t, tid) {
    let i = GmCXt.onScreenTooltipGuideIds.indexOf(tid);

    let pid = GmCXt.partialVisibleTooltipsIds.indexOf(tid);

    if (t.total === t.visible.length) {
        // All tooltips visible

        if (i < 0) {
            // Entry not present in 'onScreenTooltipGuideIds'
            GmCXt.onScreenTooltipGuideIds.push(tid);
            GmCXt.log(43, "ADDED on screen: " + tid);

            if (pid >= 0) {
                GmCXt.partialVisibleTooltipsIds.splice(pid, 1);
            }
        }
    } else {
        // One or more tooltips in the guide are hidden

        if (i >= 0) {
            // Entry present in 'onScreenTooltipGuideIds'
            GmCXt.onScreenTooltipGuideIds.splice(i, 1);
            GmCXt.log(43, "REMOVED from screen: " + tid);
        }

        if (t.visible.length === 0) {
            // All tooltips in the guide are hidden
            if (pid >= 0) {
                GmCXt.partialVisibleTooltipsIds.splice(pid, 1);
                GmCXt.log(43, "REMOVED from screen (ALL HIDDEN): " + tid);
            }
        } else {
            if (pid < 0) {
                // Update partially loaded tooltip list
                GmCXt.partialVisibleTooltipsIds.push(tid);
                GmCXt.log(43, "ADDED on screen (PARTIALLY): " + tid);
            }
        }
    }
};

GmCXt.updateOnScreenTooltipGuideInfo = function(tour, tourId, stepId, isValid, smartTip, url) {
    if (window.self === window.top) {
        let t = GmCXt.onScreenTooltipGuideInfo["tour_" + tourId];

        //FOR: tooltip tracking
        //if valid => tooltip rendered
        if (isValid) {
            GmCXt.setTooltipRenderInfo(tour, tourId, stepId, smartTip, url);
        }

        //FOR: on screen tooltip rendering
        if (t) {
            let stepIndex = t.visible.indexOf(stepId);

            if (isValid) {
                if (stepIndex < 0) {
                    t.visible.push(stepId);

                    GmCXt.log(43, "VISIBLE: " + GmCXt.stepLog(stepId, tourId));

                    if (GmCXt.isAutomationRunning()) {
                        GmCXt.tooltipInfoForAutomation["tour_" + tourId].visible.push(stepId);
                    }
                }
            } else {
                if (stepIndex >= 0) {
                    t.visible.splice(stepIndex, 1);

                    GmCXt.log(43, "HIDDEN: " + GmCXt.stepLog(stepId, tourId));
                }
            }

            GmCXt.updateOnScreenTooltipGuideIds(t, tourId);
            GmCXt.auto.setTooltipAutoDataToStorage(GmCXt.tooltipInfoForAutomation);
        }

    } else {
        let data = {
            tour: tour,
            tourId: tourId,
            stepId: stepId,
            isValid: isValid,
            smartTip: smartTip,
            url: url
        };
        GmCXt.sendMessageToTheTopWindow("mgPlayerJSProd_action:update_smarttip_on_screen", data);
    }
};

GmCXt.getTooltipName = function(type) {
    let name = '';
    switch (type) {
    case 'disableElement':
        name = "digital_duct_tape";
        break;

    case 'injector':
        name = "power_html";
        break;

    case 'formSubmit':
        name = "form_submit";
        break;

    case 'both':
        name = "guidance_validation";
        break;

    default:
        name = type;
        break;
    }
    return name;
};

GmCXt.checkIfSurveySubmitted = function(playerInstance, data, isExitSurvey, cb) {
    let flag = false;
    GmCXt.storage().get(['surveyCompleted'])
        .then(function(st) {
            function checkSurveySubmited(version, surveyObj) {
                if (surveyObj[data.tourId]) {
                    if (version > surveyObj[data.tourId]) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return true;
                }
            }

            data.instance = {
                tour: {
                    tour_settings: playerInstance.tour.tour_settings
                }
            };

            if (GmCXt.isAnonymousUser()) {
                if (GmCXt.getObjectSize(st) === 0) st.surveyCompleted = {};
                flag = checkSurveySubmited(parseInt(data.version), st.surveyCompleted);
            } else {
                let userSettings = GmCXt.user.settings || {};
                userSettings.surveyCompleted = userSettings.surveyCompleted || {};
                flag = checkSurveySubmited(parseInt(data.version), userSettings.surveyCompleted);
            }

        }).then(function() {
            if (cb) {
                cb(flag);
            }
        });
};

GmCXt.showSurveyScreen = function(data, isExitSurvey) {
    return new Promise(function(resolve, reject) {
        GmCXt.isSurveyVisible = false;

        if (isExitSurvey) {
            GmCXt.isSurveyVisible = true;
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:exit_survey_start;task:show_survey', data);
            resolve(GmCXt.isSurveyVisible);

        } else if (data.type === "stepPlay") {
            GmCXt.isSurveyVisible = true;
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:survey_start;task:show_survey', data);
            resolve(GmCXt.isSurveyVisible);

        } else {
            let playerInstance = mg$.extend({}, data.playerInstance);

            if (GmCXt.isEmpty(playerInstance)) return;

            GmCXt.checkIfSurveySubmitted(playerInstance, data, isExitSurvey, function(f) {
                if (f) {
                    GmCXt.isSurveyVisible = true;
                    GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:survey_start;task:show_survey', data);
                }
                resolve(GmCXt.isSurveyVisible);
            });
        }

        if (!GmCXt.isSidePanelApp) GmCXt.closeAppPanel();
    });
};

GmCXt.checkCurrentStepSurvey = function(pi) {

    let currentStep = GmCXt.getCurrentStep(pi.currentStepId);
    if (currentStep.step_type === "survey") {
        return true;
    } else {
        return false;
    }
};

GmCXt.getSurveyScreen = function(PI, guideNotCompleted) {
    return new Promise(function(resolve, reject) {
        let f = false;

        if (GmCXt.playerI && GmCXt.isLooping()) {
            resolve(f);

        } else if (PI && PI.tour) {

            let tour = PI.tour;

            let data = {
                tourId: tour.tour_id,
                version: tour.version,
                playerInstance: PI
            };

            if (guideNotCompleted) {
                f = true;

                if (PI && GmCXt.checkCurrentStepSurvey(PI)) {

                    let currentStep = GmCXt.getCurrentStep(PI.currentStepId);
                    let sentiment = currentStep.step_settings.sentiment;
                    data.data = {};
                    data.data.sentimentCode = sentiment.sentiment_code;
                    data.step = currentStep;
                    data.type = 'stepPlay';
                    GmCXt.showSurveyScreen(data, false, guideNotCompleted).then(function() {
                        resolve(f);
                    });

                } else if (GmCXt.isExitSurvey()) {

                    if (GmCXt.isPlayer()) {
                        GmCXt.showSurveyScreen(data, true).then(function() {
                            resolve(f);
                        });

                    } else {
                        let ti = GmCXt.tourPlayerI;
                        if (ti) {
                            ti.closeGuide();
                        }
                        resolve(f);
                    }
                }

            } else if (GmCXt.showSurvey(PI) && GmCXt.isPlayer()) {
                data.type = 'guide';
                GmCXt.showSurveyScreen(data).then(function(f) {
                    resolve(f);
                });
            }
        }
    });
};

GmCXt.showSurvey = function(PI) {

    let tour = PI.tour;

    if (tour.is_published &&
        tour.tour_settings.enableSentiment &&
        PI.completeEventTracked &&
        GmCXt.isLastStep(PI.currentStepId, PI.playStructure))
        return true;
    else if (!GmCXt.playerI && tour && tour.is_published && tour.tour_settings.enableSentiment) {
        return true;
    } else
        return false;
};

GmCXt.getOpacity = function(step) {

    let opacity = 0;
    let setting = step.step_settings;

    if (setting && GmCXt.isNumeric(setting.overlayOpacity)) {
        opacity = parseInt(setting.overlayOpacity);
    }
    return opacity;
};

GmCXt.recordGuideEvents = function() {
    let PI = GmCXt.playerI;

    if (!PI || PI.length === 0) return;

    if (GmCXt.isFirstNonAutomationStep()) PI.firstStepPlayed = true;

    let tour = PI.tour;

    if (!GmCXt.guidePlayTracker["tour:" + tour.tour_id]) {
        GmCXt.setGuidePlayTracker(tour.tour_id);
    }

    if (PI.completeEventTracked !== true &&
        PI.firstStepPlayed === true &&
        GmCXt.isLastStep(PI.currentStepId, PI.playStructure)
    ) {
        PI.completeEventTracked = true;

        //Update Guide tracker
        let completionEventType = 'guide_complete';

        GmCXt.guidePlayTracker["tour:" + tour.tour_id][completionEventType] = 1;

        if (PI.linkedGuides) {
            PI.linkedGuides.forEach(function(tourId) {
                if (!GmCXt.guidePlayTracker["tour:" + tourId]) GmCXt.setGuidePlayTracker(tourId);

                if (GmCXt.guidePlayTracker["tour:" + tourId]) {
                    GmCXt.guidePlayTracker["tour:" + tourId][completionEventType] = 1;
                    GmCXt.guidePlayTracker["tour:" + tourId].play_instance_id = GmCXt.guidePlayTracker["tour:" + tour.tour_id].play_instance_id;
                }
            });
        }
    }

    if (PI.linkedGuides) {
        PI.linkedGuides.forEach(function(tourId) {
            if (GmCXt.guidePlayTracker["tour:" + tourId]) {
                GmCXt.guidePlayTracker["tour:" + tourId].play_instance_id = GmCXt.guidePlayTracker["tour:" + tour.tour_id].play_instance_id;
            }
        });
    }

    if (GmCXt.isLastStep(PI.currentStepId, PI.playStructure) && GmCXt.tourActivity['t:' + PI.tour.tour_id]) {
        delete GmCXt.tourActivity['t:' + PI.tour.tour_id];
    }
};

GmCXt.isClickInStepPopup = function(e) {
    if (mg$(e.target).parents('.mgPlayerJSProd_preview-step-popup-container').length !== 0 ||
        mg$(e.target).hasClass('mgPlayerJSProd_image-popup') ||
        mg$(e.target).parents('.mgPlayerJSProd_image-popup').length !== 0 ||
        mg$(e.target).hasClass('mgPlayerJSProd_icon-image-prev-button') ||
        mg$(e.target).parents('.mgPlayerJSProd_icon-image-prev-button').length !== 0 ||
        mg$(e.target).hasClass('mgPlayerJSProd_image-step-prev') ||
        mg$(e.target).parents('.mgPlayerJSProd_play-pause-toolbar').length !== 0 ||
        mg$(e.target).hasClass('mgPlayerJSProd_popup') ||
        mg$(e.target).parents('.mgPlayerJSProd_popup').length !== 0 ||
        mg$(e.target).hasClass('mgPlayerJSProd_overlay-container') ||
        mg$(e.target).hasClass('mgPlayerJSProd_slideshow-panel') ||
        mg$(e.target).parents('mgPlayerJSProd_slideshow-panel').length !== 0) {

        return true;
    } else {
        return false;
    }
};

GmCXt.isClickInSurveyPopup = function(e) {
    if (mg$(e.target).parents('.mgPlayerJSProd_survey-popup-wrapper').length) {
        return true;
    } else {
        return false;
    }
};

GmCXt.getSingleVisibility = function(el) {

    if (mg$(el).css("display") === "none" || mg$(el).css("visibility") === "hidden" || !mg$(el).is(":visible")) {
        return false;
    } else {
        return true;
    }
};

GmCXt.getVisibilityTillParent = function(el) {

    if (!el || !GmCXt.getSingleVisibility(el)) return false;

    let visible = true;
    let all = mg$(el).add(mg$(el).parents());

    for (let i = 0; i < all.length; i++) {
        if (!GmCXt.getSingleVisibility(all[i])) {
            visible = false;
            break;
        }
    }
    return visible;
};

GmCXt.confirmTourClose = function(forceClose) {
    let pi = GmCXt.playerI;
    let ti = GmCXt.tourPlayerI;
    if (pi && ti) {
        if (pi.currentStepId && pi.playStructure &&
            GmCXt.getTail(pi.currentStepId, pi.playStructure) !== null &&
            GmCXt.isExitSurvey() && GmCXt.isPlayer()) {
            GmCXt.showExitSurvey();
        }
        ti.closeGuide(forceClose);
    }
};

GmCXt.requiredWidth = function() {
    if (mg$(window).width() > 550) return true;
    else return false;
};

GmCXt.getPopupHtml = function(msg, ok, cancel) {
    let popupType = 'mgPlayerJSProd_popup-info';
    let html = " <wmgPlayerJSProd_ class='mgPlayerJSProd_overlay-container'></wmgPlayerJSProd_>" +
        "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup " + popupType + "' id='mgPlayerJSProd_popup-reload'>" +
        "   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
        "	   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>" +
        "   </wmgPlayerJSProd_>" +
        " <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'>" + msg + "</wmgPlayerJSProd_>" +
        " <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper'>" +
        "   <button title='" + ok + "' aria-label='" + ok + "' class='mgPlayerJSProd_popup-ok-btn mgPlayerJSProd_btn-default mgPlayerJSProd_ok-btn mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt mgPlayerJSProd_lbl-btn'>" + ok + "</button>" +
        "   <button title='" + cancel + "' aria-label='" + cancel + "' class='mgPlayerJSProd_popup-cancel-btn mgPlayerJSProd_btn-default mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt mgPlayerJSProd_lbl-btn'>" + cancel + "</button>" +
        " </wmgPlayerJSProd_>" +
        "</wmgPlayerJSProd_>";
    return html;
};

GmCXt.getKeyShortPopupHtml = function(tourList) {
    let tourListStr = "";
    if (tourList && tourList.length) {
        for (let i = 0; i < tourList.length; i++) {
            tourListStr = tourListStr + "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-row-content-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-colmn-content-wrapper mgPlayerJSProd_col-lt' > " + tourList[i].tour_settings.keyboardKeyInput + " : </wmgPlayerJSProd_>" +
                "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-colmn-content-wrapper mgPlayerJSProd_col-rt' > " + tourList[i].tour_title + " </wmgPlayerJSProd_></wmgPlayerJSProd_>";
        }
    } else {
        tourListStr = "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-row-content-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-colmn-content-wrapper' > No shortcuts available </wmgPlayerJSProd_> " +
            "</wmgPlayerJSProd_>";
    }


    let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup mgPlayerJSProd_popup-info mgPlayerJSProd_popup-keyshort' id='mgPlayerJSProd_popup-reload'>" +
        "   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
        "	   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-keyshort-header-title'>Keyboard shortcuts</wmgPlayerJSProd_>" +
        "	   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-keyshort-close'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
        "   </wmgPlayerJSProd_>" +
        " <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'> " +
        " 	<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-main-content-wrapper'>" +
        tourListStr +
        " 	</wmgPlayerJSProd_>" +
        " </wmgPlayerJSProd_>" +
        "</wmgPlayerJSProd_>";
    return html;
};

GmCXt.stopPropagation = function(e) {
    e.stopImmediatePropagation();
};

GmCXt.addPopupEvents = function(onOK, onCancel, onClose) {

    mg$(".mgPlayerJSProd_popup").on("mousedown", GmCXt.stopPropagation);
    mg$(".mgPlayerJSProd_overlay-container").on("mousedown", GmCXt.stopPropagation);

    mg$(".mgPlayerJSProd_popup-ok-btn").on("click", onOK);
    mg$(".mgPlayerJSProd_popup-cancel-btn").on("click", onCancel);
    mg$(".mgPlayerJSProd_popup-close-button").on("click", onClose);
    mg$(".mgPlayerJSProd_popup-keyshort-close").on("click", onOK);
};

GmCXt.closePopup = function() {
    mg$(".mgPlayerJSProd_popup").remove();
    mg$(".mgPlayerJSProd_overlay-container").remove();
};

GmCXt.showExitSurvey = function(opts) {

    let pi = GmCXt.playerI;
    GmCXt.unlockScroll();
    mg$(".mgPlayerJSProd_popup").remove();
    GmCXt.getSurveyScreen(pi, true);
};

GmCXt.zoomImage = function(text, popClass) {

    if (text && text.indexOf("<img ") !== -1 && text.indexOf('src=""') === -1) {
        if (window.self === window.top) {
            GmCXt.setPopUpForImage(text, popClass);
        } else {
            GmCXt.setZoomImageFromIframe(text, popClass);
        }
    }
};

GmCXt.redirectLinkToBrowser = function(e) {
    let url = e.target.href;
    let shell = require('electron').shell;
    shell.openExternal(url);
};

GmCXt.setLinkGuidePlay = function(text, popClass) {
    mg$(popClass + ' a').each(function() {
        let t = mg$(this).attr('target');
        if (t === 'gssPlayGuide') {
            mg$(this).on("click", function(e) {
                let url = mg$(this).attr('href');
                url = url.split('?')[1];
                let tourId = GmCXt.getParameterValue('guideMe-tourId', url);
                let automation = GmCXt.getParameterValue('automation', url);

                if (tourId) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    automation = automation === "true" ? true : false;
                    let initiator = 'urlTour';
                    if (automation) {
                        initiator = 'doitforme';
                    }

                    if (GmCXt.tourPlayerI) {
                        GmCXt.tourPlayerI.stop();
                    }
                    if (window.self === window.top) {
                        GmCXt.getTourAndPlay(tourId, initiator);
                    } else {
                        let data = {
                            tourId: tourId,
                            initiator: initiator
                        };
                        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:play_guide_from_link', data);
                    }
                }
            });
        }
    });
};

GmCXt.saveAppPresence = function(m) {

    m = GmCXt.convertMgdata(m);

    if (!GmCXt.isClientJs()) {
        GmCXt.storage().get(['login_state']).then(function(o) {
            if (o.login_state) {
                saveAndAcknowledge();
            }
        });
    } else {
        saveAndAcknowledge();
    }

    function saveAndAcknowledge() {

        GmCXt.myGuideApps[m.data] = true;

        // Send acknowledgement
        if (m.action === 'MyGuideReporting') {
            let message = {
                action: 'MyGuideReporting:Ack',
                data: GmCXt.getAppName()
            };

            GmCXt.log(63, 'Send acknowledgement of: ' + message.data);

            GmCXt.sendToParentWindow(message);
        }

        GmCXt.log(63, 'MyGuide apps found: ', GmCXt.myGuideApps);
    }
};

GmCXt.isLessThan = function(d, val) {
    if (d === undefined || d === null || d < val)
        return true;
    else
        return false;
};

GmCXt.isGreaterThan = function(d, val) {
    if (d === undefined || d === null || d > val)
        return true;
    else
        return false;
};

GmCXt.updNotifDataSidePanel = function(toursClosed, tourIdArray) {
    let data = {
        toursClosed: toursClosed,
        tourIdArray: ''
    };
    if (GmCXt.isAnonymousUser()) {
        data.tourIdArray = tourIdArray;
    }
    GmCXt.storage().set({
        'toursClosed': data.toursClosed,
        'tourIdArray': data.tourIdArray
    }).then(function() {
        GmRootScope.setNotifTours();
    });
};

GmCXt.updateNotification = function(tours) {
    GmCXt.storage().get(['toursClosed']).then(function(st) {
        let userSettings = GmCXt.user.settings || {};
        userSettings.viewed_guide_notifications = tours;
        GmCXt.user.settings = userSettings;

        if (GmCXt.isAnonymousUser()) {
            GmCXt.storage().set({
                'tourIdArray': tours
            });
        } else {
            let data = {
                settings : {
                    viewed_guide_notifications : tours
                }
            };
            GmCXt.updateUserSettings(data, GmCXt.user);
        }

        GmCXt.updNotifDataSidePanel(GmCXt.parseJSON(st.toursClosed), tours);
    });
};

GmCXt.setDefaultStepSetting = function(data, prop, val) {
    if (!data.step_settings[prop] || data.step_settings[prop] === 'keepNext') {
        data.step_settings[prop] = val;
    }
};

GmCXt.getHostErrorId = function() {

    let errorIds = {
        'workday.com': ['#errorWidgetMessageCount'],
        'coupahost.com': ['#dynamic_errors', '#errorExplanation']
    };

    for (let host in errorIds) {
        if (errorIds.hasOwnProperty(host)) {
            if (GmCXt.isCurrentHost(host)) {
                return errorIds[host];
            }
        }
    }
    return [];
};

GmCXt.checkHostError = function(id) {
    let ids = GmCXt.getHostErrorId();

    for (let i = 0; i < ids.length; i++) {
        var id = ids[i];
        if (id && mg$(id).length > 0) {
            return true;
        }
    }

    return false;
};

GmCXt.checkForErrorOnScreen = function() {

    let err = false;

    if (GmCXt.checkHostError()) {

        err = true;
        GmCXt.log(33, "Error on screen.");

        let msg = GmCXt.label.hostJsError;
        GmCXt.toastMsgPersistent(msg).show();

    } else {
        GmCXt.toastMsgPersistent().hide();
    }

    return err;
};

GmCXt.isParentElementId = function(elem, id) {

    let el = mg$(elem);
    let all = el.add(el.parents());

    let retVal = all.filter(function() {
        return mg$(this).attr("id") === id;
    }).length > 0;

    return retVal;
};

GmCXt.setZoomImageFromIframe = function(desc, parentClassName) {
    GmCXt.initialiseImagePopUp();
    mg$(parentClassName + ' img').each(function() {
        mg$(parentClassName + ' img').on("click", function(e) {
            GmCXt.stopPropagation(e);
            GmCXt.openModalFromTopWindow(this.src);
        });
    });
};

GmCXt.initialiseImagePopUp = function() {
    GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:initialize_image_iframe_popup', {});
};

GmCXt.openModalFromTopWindow = function(src) {
    let data = {};
    data.imageSrc = src;
    GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:open_image_iframe_popup', data);
};

GmCXt.setImagePopUp = function() {
    mg$('#mgPlayerJSProd_image_popup').remove();
    GmCXt.addImagePopHtml();
    let modal = document.getElementById('mgPlayerJSProd_image_popup');

    if (modal) {
        modal.style.display = "none";
        modal.onclick = function(e) {
            GmCXt.stopPropagation(e);
        };
    }
    let closeBtn = document.getElementsByClassName("mgPlayerJSProd_close-img-popup")[0];
    if (closeBtn) {
        closeBtn.onclick = function(e) {
            GmCXt.stopPropagation(e);
            modal.style.display = "none";
            mg$('.mgPlayerJSProd_preview-step-popup-container').css({
                'z-index': '2147483647'
            });
        };
    }
};

GmCXt.openImagePopup = function(data) {
    let modal = document.getElementById('mgPlayerJSProd_image_popup');
    let modalImg = document.getElementById("mgPlayerJSProd_img_desc");
    modal.style.display = "block";
    modalImg.src = data.imageSrc;
};

GmCXt.addEventOnTooltip = function(req) {

    clearTimeout(GmCXt.tooltipTimeout);

    GmCXt.tooltipTimeout = GmCXt.timeout(function() {
        let el = mg$('#mgPlayerJSProd_smarttip-' + req.step.step_id);

        el.off("click").on('click', function(e) {
            if (!req.isPreview) {
                GmCXt.tooltipAction(e, req.settings.smartTip, req.step);
            }
        });

    }, GmCXt.t.addTooltipEvent);
};

GmCXt.isEventToolTip = function(event, stepId) {
    let targetId = event.target.id;
    let cTargetId = event.currentTarget.id;
    let isSmartipEvent = false;

    switch (targetId) {
    case 'mgPlayerJSProd_smarttip-icon-' + stepId:
        isSmartipEvent = true;
        break;
    case 'mgPlayerJSProd_smarttip-' + stepId:
        isSmartipEvent = true;
        break;
    default:
    }

    switch (cTargetId) {
    case 'mgPlayerJSProd_smarttip-icon-' + stepId:
        isSmartipEvent = true;
        break;
    case 'mgPlayerJSProd_smarttip-' + stepId:
        isSmartipEvent = true;
        break;
    default:
        break;
    }

    if (mg$(event.currentTarget).hasClass("mgPlayerJSProd_smarttip-icon-wrapper-" + stepId)) {
        isSmartipEvent = true;
    } else if (mg$(event.target).hasClass("mgPlayerJSProd_smarttip-icon-wrapper-" + stepId)) {
        isSmartipEvent = true;
    }

    return isSmartipEvent;
};

GmCXt.tooltipAction = function(event, tooltip, step) {
    GmCXt.updateTooltipActionInfo(step.tour_id, step.step_id, tooltip, "click");

    if (!GmCXt.isEventToolTip(event, step.step_id)) {
        return;
    }

    if (tooltip.clickAction === 'openCurrentPage') {
        event.preventDefault();
        event.stopImmediatePropagation();
        if (window.self === window.top) {
            GmCXt.openAppPanel('currentPage');
        } else {
            GmCXt.sendMessageToParentWindow("mgPlayerJSProd_action:open_app_panel");
        }

    } else if (tooltip.clickAction === 'openUrl') {
        event.preventDefault();
        event.stopImmediatePropagation();

        let url = tooltip.openUrlText;

        if (url.indexOf('http') !== 0) {
            url = 'https://' + url;
        }

        window.open(url, '_blank');
    } else if (tooltip.clickAction === 'sentiment') {
        event.preventDefault();
        event.stopImmediatePropagation();
        let data = {
            sentiment_code: tooltip.sentimentCode,
            tourId: step.tour_id,
            stepId: step.step_id
        };
        if (window.self === window.top) {
            GmCXt.getSurveyDetailsAndPlay(data);
        } else {
            GmCXt.sendMessageToParentWindow("mgPlayerJSProd_action:get_survey_data", data);
        }

    }
};

GmCXt.clearStepReqObj = function() {
    mg$("[gm_visited='true']").removeAttr('gm_visited');
    delete GmCXt.currentHe;
    delete GmCXt.stepReq;
    GmCXt.captureStepCounter = 0;
    GmCXt.storage().remove(['stepReq','captureStepCounter']);
};

GmCXt.isLastStepPlayed = function() {
    let flag = false;

    if (GmCXt.playerI && (GmCXt.playerI.currentStepId === GmCXt.playerI.lastPlayedStepId))
        flag = true;

    return flag;
};

GmCXt.getNextBtnElem = function() {
    let nxtBtn = document.getElementById("mgPlayerJSProd_play_step_next");
    let doneBtn = document.getElementById("mgPlayerJSProd_play_step_next_done");
    let nxtClassic = document.getElementById("mgPlayerJSProd_play_step_next_classic");
    let doneClassic = document.getElementById("mgPlayerJSProd_play_step_next_done_classic");
    let pauseBtn = document.getElementById("mgPlayerJSProd_play_step_pause");
    let pauseClassic = document.getElementById("mgPlayerJSProd_play_step_pause_classic");
    let btn;

    if (mg$(nxtBtn).is(':visible'))
        btn = nxtBtn;
    else if (mg$(doneBtn).is(':visible'))
        btn = doneBtn;
    else if (mg$(nxtClassic).is(':visible'))
        btn = nxtClassic;
    else if (mg$(doneClassic).is(':visible'))
        btn = doneClassic;
    else if (mg$(pauseBtn).is(':visible'))
        btn = nxtBtn;
    else if (mg$(pauseClassic).is(':visible'))
        btn = nxtBtn;

    return btn;
};

GmCXt.triggerClick = function(he, req) {
    if (!he) return;

    let d = {
        bubbles: true,
        cancelable: true
    };

    let clientRect = GmCXt.getBoundingRect(he);
    if (clientRect) {
        d.clientX = clientRect.x;
        d.clientY = clientRect.y;
    }

    he.focus();
    GmCXt.log(33, "Event trigger: mouseup");
    he.dispatchEvent(new MouseEvent('mouseup', d));
    if (req && req.data) {
        let s = req.data.settings;
    }

    he.dispatchEvent(new MouseEvent('mouseover', d));
    he.dispatchEvent(new MouseEvent('mousedown', d));

    let aTags = mg$(he).find('a');
    if (aTags.length > 0) {
        he = aTags[0];
    }

    GmCXt.log(33, "Event trigger: click");

    he.dispatchEvent(new MouseEvent('click', d));
};

GmCXt.markAutoLaunchTourDoNotShow = function(tour) {
    if (!tour.tour_settings.displayFrequency && GmCXt.firstStepAutoLaunch()) {
        GmCXt.setDoNotShowTours(tour);
    }
};

GmCXt.checkProceedToPlay = function(step, tour) {

    return new Promise(function(resolve, reject) {

        let stepSetting = step.step_settings;
        let stepRuleMatched = false,
            stepRuleExist = false;

        let tourSetting = tour.tour_settings;

        let guideRuleExist = (tourSetting.rules && tourSetting.rules.length);
        let checkRules = false;
        let isVariableExistInGuide = guideRuleExist && GmCXt.variableRuleExistInGuide(tourSetting.rules);

        let stepUrlHost = GmCXt.getDomain(step.step_url);
        let windowHost = GmCXt.getPageDomain();

        if (GmCXt.playerI) {
            checkRules = (GmCXt.playerI.initiator !== "beaconTour" && GmCXt.playerI.initiator !== "Current Page");
            GmCXt.log(33, 'Launched From ' + GmCXt.playerI.initiator);
        }

        function validate(step) {
            if (!step && isVariableExistInGuide) {
                GmCXt.timeout(function() {
                    validateRules();
                }, GmCXt.t.checkVariable);
            } else {
                validateRules(step);
            }
        }

        if (stepSetting.rules && stepSetting.rules.length) {

            stepRuleExist = true;
            let oldRegEx = false;

            if (stepSetting.version) {
                oldRegEx = GmCXt.legacyWildChar(stepSetting.version);
            } else if (stepSetting.element && stepSetting.element.version) {
                oldRegEx = GmCXt.legacyWildChar(stepSetting.element.version);
            }

            stepRuleMatched = GmCXt.ruleEngine.evaluateRules(stepSetting.rules, oldRegEx);
        }

        if (stepRuleExist) {
            if (stepRuleMatched && stepSetting.hasElRule) {
                validate(true);
            } else {
                if (GmCXt.playerI) {
                    GmCXt.playerI.stepRuleMatch = stepRuleMatched;
                }

                if (stepRuleMatched) {
                    GmCXt.log(33, 'MATCHED step rules');
                    resolve(true);
                } else {
                    GmCXt.log(33, 'Step rules did not MATCH');
                    if (GmCXt.playerI.testAutomation) {
                        GmCXt.auto.fail(step, {
                            errorMessage: 'Step Rules Not Matched.'
                        });
                    } else {
                        resolve(false);
                    }
                }
            }
        } else if (guideRuleExist && GmCXt.isFirstNonAutomationStep() && checkRules) {
            if (GmCXt.isAutomationRunning() && GmCXt.isAutomationStep(GmCXt.playerI.tour.steps[0])) {
                // During guide automation, guide rules are executed after all the guide level automation steps.
                // So element capturing for rule validation should be done after guide level automation steps.
                // Ignore any elements captured before it."
                GmCXt.domElStore = [];
            }
            validate();
        } else if (!GmCXt.playerI && guideRuleExist) {
            // Always validate rules for workflow tracking
            validate();
        } else if (!GmCXt.isFQDN() &&
            !guideRuleExist &&
            windowHost && windowHost !== stepUrlHost &&
            step.step_type !== 'video' && step.step_type !== 'image' && step.step_type !== 'guide' && step.step_type !== GmCXt.STEP_TYPE_WEB_INLINE) {

            resolve(false);
        } else {
            resolve(true);
        }

        function onResult(result) {
            let status = result.valid ? true : false;

            let log = 'MATCHED? [' + status + '] guide rules on first step ' + GmCXt.stepLog(step.step_id, tour.tour_title);

            GmCXt.log(33, log);
            GmCXt.log(27, log);

            if (GmCXt.playerI) {
                GmCXt.playerI.guideRuleMatch = status;
            }

            if (GmCXt.isAutomationRunning()) {
                if (status === false) {
                    GmCXt.auto.fail(step, {
                        errorMessage: 'Guide Rules Not Matched.'
                    });
                } else {
                    resolve(status);
                }
            } else {
                resolve(status);
            }
        }

        function onStepElRuleCheck(result) {
            let status = result.valid ? true : false;

            let log = 'MATCHED? [' + status + '] step rules ' + GmCXt.stepLog(step.step_id, tour.tour_title);

            GmCXt.log(33, log);
            GmCXt.log(27, log);

            if (GmCXt.playerI) {
                GmCXt.playerI.stepRuleMatch = status;
            }

            resolve(status);
        }

        function validateRules(step) {
            let waitTime = tourSetting.ruleDelayTime || 0;
            let timeout = GmCXt.t.ruleTimeOut25ms;
            if (GmCXt.checkTourCreatedBefore(tourSetting, 2021013001)) {
                timeout = GmCXt.t.ruleTimeOut10s;
            }
            let obj = {
                rules: tourSetting.rules,
                tour: tour,
                timeoutVal: timeout,
                timeout: timeout,
                cb: onResult,
                isTour: true,
                initiator: 'tourPlay'
            };

            if (step) {
                waitTime = stepSetting.stepDelayTime || 0;
                obj.rules = stepSetting.rules;
                obj.cb = onStepElRuleCheck;
            }

            GmCXt.timeout(function() {
                GmCXt.ruleEngine.queue(obj);
            }, waitTime);
        }
    });
};

GmCXt.reloadElectronApp = function() {
    require('electron').remote.getCurrentWindow().reload();
};

GmCXt.getContainerOffSet = function(container) {
    let d;

    if (container.length > 0) {

        d = container.offset();

        if (d !== undefined) {

            if (d.top < 0) d.top = 0;

            if (d.left < 0) d.left = 0;
        }

        d.width = parseInt(container.width());
        d.height = parseInt(container.height());
    } else {
        d = {
            top: 0,
            left: 0,
            width: mg$(document).width(),
            height: mg$(document).height()
        };
    }

    return d;
};

GmCXt.removeScreenOverlay = function() {
    GmCXt.screenOverlayI = undefined;
    mg$('.mgPlayerJSProd_screen-blackout').hide();
    mg$('.mgPlayerJSProd_screen-blackout').html('');
};

GmCXt.getWidgetInstance = function() {
    return mg$('.mgPlayerJSProd_start-button');
};

GmCXt.getChatIconInstance = function() {
    return mg$('#mgPlayerJSProd_btn-chat-button');
};

GmCXt.hideWidgetIcon = function() {
    GmCXt.log(8, "HIDE WIDGET");

    let widget = GmCXt.getWidgetInstance();
    if (widget.length) {
        widget.hide();
    }
};

GmCXt.getTaskListVisibility = function() {
    if (GmCXt.isTrue(GmCXt.APP_PANEL_OPEN) || !GmCXt.checkPrecedence()) {
        return false;
    }

    if (GmCXt.user && GmCXt.isPlayer() && GmCXt.taskListCount > 0) {
        return true;
    }
    return false;
};

GmCXt.imageSizeStyle = function(selector) {
    let len = mg$(selector).length;

    if (len) {
        for (let i = 0; i < len; i++) {
            let imgW = mg$(selector)[i].getAttribute('width');
            let imgH = mg$(selector)[i].getAttribute('height');

            mg$(selector)[i].style.setProperty('width', imgW + 'px', 'important');
            mg$(selector)[i].style.setProperty('height', imgH + 'px', 'important');
        }
    }
};

GmCXt.updateGuideDisplayFrequency = function(tours) {
    GmCXt.user.settings.display_frequency_guides = tours;
    let data = {
        settings : {
            display_frequency_guides : tours
        }
    };
    GmCXt.updateUserSettings(data, GmCXt.user);
};

GmCXt.markBeaconDisplayFrequency = function (tour) {

    if (tour) {
        let beaconGuides = {};
        if (GmCXt.isDefined(GmCXt.user.settings.display_frequency_beacons)) {
            beaconGuides = GmCXt.createDeepCopy(GmCXt.user.settings.display_frequency_beacons);
        }

        if (beaconGuides[tour.tour_id] && parseInt(tour.version) === parseInt(beaconGuides[tour.tour_id].version)) {
            beaconGuides[tour.tour_id].playedCount++;
        } else {
            beaconGuides[tour.tour_id] = {};
            beaconGuides[tour.tour_id].version = parseInt(tour.version);
            beaconGuides[tour.tour_id].playedCount = 1;
        }

        GmCXt.user.settings.display_frequency_beacons = beaconGuides;

        let data = {
            settings : {
                display_frequency_beacons : beaconGuides
            }
        };

        GmCXt.updateUserSettings(data, GmCXt.user);
    }
};

GmCXt.setBeaconsDisplayFrequency = function(tourId) {
    for (let i = 0; i < GmCXt.beaconTours.length; i++) {
        if (parseInt(GmCXt.beaconTours[i].tour_id) === parseInt(tourId)) {
            let beacSett = GmCXt.beaconTours[i].tour_settings.beacon;
            if (beacSett.displayFrequency) {
                GmCXt.markBeaconDisplayFrequency(GmCXt.beaconTours[i]);
            }
            break;
        }
    }
};

GmCXt.updateSurveyCompletedData = function(data) {
    GmCXt.storage().get(['surveyCompleted']).then(function(st) {
        let userSettings = GmCXt.user.settings || {};
        if (GmCXt.isAnonymousUser()) {
            st.surveyCompleted[data.tourId] = parseInt(data.version);
            GmCXt.storage().set({
                'surveyCompleted': st.surveyCompleted
            });
        } else {
            userSettings.surveyCompleted = userSettings.surveyCompleted || {};
            userSettings.surveyCompleted[data.tourId] = parseInt(data.version);
            GmCXt.user.settings = userSettings;
            let data = {
                settings : {
                    surveyCompleted : userSettings.surveyCompleted
                }
            };
            GmCXt.updateUserSettings(data, GmCXt.user);
        }
    });
};

GmCXt.resetMplayerPos = function() {
    mg$('.mgPlayerJSProd_panel').removeAttr("style");
    mg$('.mgPlayerJSProd_panel').css({
        'left': 'initial',
        'top': '50%',
        'right': '50px'
    });
};

GmCXt.isMyGuideEl = function(el) {

    if (el.nodeName.toLowerCase() === 'wmgPlayerJSProd_over' ||
        mg$(el).closest('wmgPlayerJSProd_').length > 0 ||
        (el.name && el.name.includes('guideme-iframe')) ||
        (typeof el.className === 'string' && (el.className.indexOf("mgPlayerJSProd_") === 0 || el.className.indexOf(" mgPlayerJSProd_") > 0)) ||
        (el.id && el.id.indexOf("mgPlayerJSProd_beacon-icon-") === 0)
    ) {
        return true;
    }
    return false;
};

GmCXt.playerDomainCheck = function() {
    if (GmCXt.isPlayer()) {
        if (GmCXt.isDomainInActiveApp() || GmCXt.user.signedInWithSso) {
            return true;
        } else {
            return false;
        }
    }
    return true;
};

GmCXt.getDoNotShowTours = function(isNotif) {

    return GmCXt.storage().get(['tourIdArray', 'tourIdOnBoardingArray'])
        .then(function(st) {
            return GmCXt.processDoNotShowGuides(st, isNotif);
        });
};

GmCXt.processDoNotShowGuides = function(st, isNotif) {

    let obj = {};
    let tours = [];
    let userSettings = GmCXt.user.settings || {};

    if (GmCXt.isAnonymousUser()) {
        tours = st.tourIdArray || {};
        if (mg$.isArray(st.tourIdOnBoardingArray)) {
            tours = mg$.extend({}, tours, GmCXt.arrayToObjectNot(st.tourIdOnBoardingArray));
            GmCXt.storage().set({
                'tourIdArray': tours
            });
            GmCXt.storage().remove(['tourIdOnBoardingArray']);
        }
    } else {
        tours = userSettings.viewed_guide_notifications || {};
        if (mg$.isArray(userSettings.viewed_onboarding_guide_notifications)) {
            tours = mg$.extend({}, tours, GmCXt.arrayToObjectNot(userSettings.viewed_onboarding_guide_notifications));
            delete userSettings.viewed_onboarding_guide_notifications;
            GmCXt.saveSeenToursInDb(tours, userSettings);
        }
    }

    if (Array.isArray(tours)) {
        obj = GmCXt.arrayToObjectNot(tours);
        if (!GmCXt.isAnonymousUser()) GmCXt.saveSeenToursInDb(obj, userSettings);
    } else {
        obj = tours;
    }

    return obj;
};

GmCXt.saveSeenToursInDb = function(tour, userSettings) {

    if (!GmCXt.isEmpty(tour)) {

        userSettings.viewed_guide_notifications = tour;
        GmCXt.user.settings = userSettings;

        let data = {
            settings : {
                viewed_guide_notifications : tour
            }
        };
        GmCXt.updateUserSettings(data, GmCXt.user);

        GmCXt.storage().remove(['tourIdArray']);
    }
};

GmCXt.updateUserProfileSettings = function(userSettings) {
    GmCXt.user.settings = userSettings;

    if (GmCXt.user.signin_user_email) {
        let data = {
            email_id: GmCXt.user.signin_user_email,
            settings: JSON.stringify(GmCXt.user.settings),
            organization_id: GmCXt.user.organization_id
        };

        GmCXt.setAnonymousUserPrefrence(data);
    } else {
        GmCXt.apiUpdateUserProfile(GmCXt.user);
    }

    GmRootScope.saveUser(GmCXt.user);

    GmRootScope.saveOrganization(GmCXt.organization);
};

GmCXt.updateUserSettings = function(data, user, cb) {

    data.settings = JSON.stringify(data.settings);
    function onSuccess(response) {
        GmCXt.user = {...user};
        GmRootScope.saveUser(GmCXt.user);
        GmRootScope.saveOrganization(GmCXt.organization);
    }

    if (GmCXt.user.signin_user_email) {
        let data = {
            email_id: GmCXt.user.signin_user_email,
            settings: JSON.stringify(GmCXt.user.settings),
            organization_id: GmCXt.user.organization_id
        };

        GmCXt.setAnonymousUserPrefrence(data);

        GmRootScope.saveUser(GmCXt.user);
        GmRootScope.saveOrganization(GmCXt.organization);
    } else {
        if(cb) {
            GmCXt.apiUpdateUserSettings(data, cb);
        } else {
            GmCXt.apiUpdateUserSettings(data, onSuccess);
        }
    }     
};

GmCXt.getAbsoluteRectFromIframe = function(he) {

    let iframeEl = he.ownerDocument.defaultView.frameElement;
    if (!iframeEl || window.self !== window.top) {
        return null;
    }

    let rect = he.getBoundingClientRect();
    let iframeRect = iframeEl.getBoundingClientRect();

    return {
        top: rect.top + iframeRect.top,
        left: rect.left + iframeRect.left,
        width: rect.width,
        height: rect.height
    };
};

// This function returns custom selector parts, if it matches "IFRAME#id BODY#id" get "BODY#id"
GmCXt.getIframeQueryParts = function(selector) {
    if (/iframe/i.test(selector) && selector.indexOf(' ') !== -1) {
        let queryParts = selector.trim().split(/\s+/, 2);
        if (queryParts.length === 2 && queryParts[1].length > 0) {
            return queryParts;
        }
    }
    return [];
};

// This function returns query part of iframe from the custom selector
// eg. From this "IFRAME#id BODY#id" get "BODY#id"
GmCXt.getIframeQuery = function(selector) {
    let queryParts = GmCXt.getIframeQueryParts(selector);
    if (queryParts.length) {
        return queryParts[1];
    } else {
        return selector;
    }
};

// This function returns node from the custom selector jquery for elements inside iframe
GmCXt.getNodeFromIframeQuery = function(selector) {

    let iframeElem = '';
    let nodes = null;
    let shadowRoot = null;

    let queryParts = GmCXt.getIframeQueryParts(selector);
    if (queryParts.length) {
        iframeElem = mg$(queryParts[0]);
    }

    if(iframeElem.length) {
        const iframeDoc = iframeElem[0].contentDocument || iframeElem[0].contentWindow.document;
        nodes = mg$(queryParts[1], iframeDoc);
    }else{
        nodes = mg$(selector);
    }

    if(!nodes.length) {

        let [hostSelector, innerSelector] = selector.split(/ (.+)/);
        let shadowDom;
        try {
            shadowDom = mg$(hostSelector);
        } catch (e) {
            shadowDom = '';
        }
        let shadowHost = shadowDom.length && shadowDom[0] || null;
        shadowRoot = shadowHost && shadowHost.shadowRoot;

        if(shadowRoot && innerSelector) {

            let containsMatch = innerSelector.match(/(.*):contains\(["']?(.*?)["']?\)$/);
            if (containsMatch) {
                let tagSelector = containsMatch[1] || '*';
                let textToFind = containsMatch[2];

                let matched = mg$(shadowRoot.querySelectorAll(tagSelector)).filter(function() {
                    return mg$(this).text().toLowerCase().includes(textToFind.toLowerCase());
                });

                // returns the last matched element
                nodes = matched.length ? mg$(matched[matched.length - 1]) : null;
            } else {
                nodes = mg$(shadowRoot.querySelectorAll(innerSelector));
            }
        }

    }

    return nodes;
};

GmCXt.showTooltipsDuringWorkflowGuide = function() {
    let org = GmCXt.organization;
    if (org && org.admin_settings.show_tooltips_during_workflow_guide) {
        return true;
    }
    return false;
};

GmCXt.lastUserAction = 0;
GmCXt.iframeCount = 0;
GmCXt.prevEnv = [];
GmCXt.storagePrefix = GmCXt.conf.appName + "_";
GmCXt.ruleOpsUILabels = {};
GmCXt.inPlayer = GmCXt.conf.appName === GmCXt.conf.playerApp;
GmCXt.maxInlineStepCreation = 10;
GmCXt.maxFeatureStepCreation = 100;
GmCXt.captureStepCounter = 0;
GmCXt.apiCallCount = 0;
GmCXt.desktopCaptureMode = false;
GmCXt.activeApiCallCount = 0;
GmCXt.loadingAutoHideTimer = null;
GmCXt.creatorRefreshTime = 0;

GmCXt.timeout = function(fn, t) {
    return setTimeout(fn, t);
};

GmCXt.trackerUtil = {
    guidePayload: [],
    trackPI: false,
    enableTracking: false,
    ePayload: {},
    ttPayload: {},
    page_url: "",
    featureTracking: false,
    pageTracking: false
};
GmCXt.guidePlayTracker = {};

GmCXt.STEP_TYPE_INLINE = 'inline';
GmCXt.STEP_TYPE_WEB_INLINE = 'web_inline';
GmCXt.STEP_TYPE_MESSAGE = 'message';
GmCXt.STEP_TYPE_IMAGE = 'image';
GmCXt.STEP_BEACON_TYPE = 'BEACON';
GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION = 'external_automation_step';
GmCXt.CAPTURE_SCREEN_STEP = 'capture-screen-step';
GmCXt.UPLOAD_IMAGE_STEP = 'upload-image-step';
GmCXt.STEP_TYPE_VIDEO = 'video';
GmCXt.STEP_TYPE_SMART_TIP = 'smartTip';
GmCXt.STEP_TYPE_AUTOMATION = 'automation';

GmCXt.STEP_TYPE_GUIDE = 'guide';
GmCXt.STEP_TYPE_BRANCH = 'branch';
GmCXt.STEP_TYPE_SURVEY = 'survey';
GmCXt.STEP_TYPE_TRANSPORT = 'transport';
GmCXt.ANALYTICS_EVENT_CHAIN_ID = '';
GmCXt.INSIGHTS_EVENT_CHAIN_ID = '';
GmCXt.STEP_TEXT_SLIDE_TYPE = 'textSlide';
GmCXt.STEP_TYPE_ERROR_HANDLER = 'errorHandler';

GmCXt.STEP_VIEW_OPERATION = 'view';
GmCXt.STEP_CREATE_OPERATION = 'create';
GmCXt.STEP_EDIT_OPERATION = 'edit';

GmCXt.isLogoutTrackApi = false;


GmCXt.STEP_TYPE_TAG = 'tag';

GmCXt.t_ = {
    hr1: 60 * 60 * 1000,
    hr8: 8 * 60 * 60 * 1000,
    hr24: 24 * 60 * 60 * 1000,
    hr24inSec: 24 * 60 * 60,
    hr12inSec: 12 * 60 * 60,
    min30: 30 * 60 * 1000,
    min15: 15 * 60 * 1000,
    min10_s: 10 * 60,
    min5_s: 5 * 60,
    min3_s: 3 * 60,
    min5: 300000,
    min4: 240000,
    min2_s: 2 * 60,
    min1_s: 60,
    min1: 60000,
    sec30: 30000,
    sec15: 15000,
    sec10: 10000,
    sec5: 5000,
    sec4: 4000,
    sec3: 3000,
    sec2: 2000,
    sec1: 1000,
    ms25: 2500,
    ms15: 1500,
    ms8: 800,
    ms5: 500,
    ms3: 300,
    ms2: 200,
    ms1: 100
};
GmCXt.t = {
    sync24: GmCXt.t_.hr24,
    notifExp24: GmCXt.t_.hr24,
    syncSegment: GmCXt.t_.hr24,
    tracking24hr: GmCXt.t_.hr24inSec,
    tracking12hr: GmCXt.t_.hr12inSec,
    tracking8hr: GmCXt.t_.hr8,

    cdnExp: GmCXt.t_.hr1,
    openSso: GmCXt.t_.hr1,
    openSsoAfterFiveMin: GmCXt.t_.min5,
    snoozeNotif: GmCXt.t_.hr1,
    refreshBrandLogo: GmCXt.t_.hr1,
    refreshWidget: GmCXt.t_.hr1,

    pageTrackWait: GmCXt.t_.min30,

    workflowIdle: GmCXt.t_.min15,
    workflowSync: GmCXt.t_.min15,
    clickSync: GmCXt.t_.min15,

    playerSync: GmCXt.t_.min3_s,

    fileStackExp: GmCXt.t_.min5,
    elLookupTime5m: GmCXt.t_.min5,
    autoRelogin: GmCXt.t_.min5,

    autoWaitTime: GmCXt.t_.min4,
    createStepTimeout: GmCXt.t_.min4,

    trackerSync: GmCXt.t_.min2_s,

    creatorSync: GmCXt.t_.min1_s,
    trackerInt: GmCXt.t_.min1,
    autoEndTime: GmCXt.t_.min1,

    trackerInt2: GmCXt.t_.sec15,
    highlighterDefautWT: GmCXt.t_.sec15,
    tooltipTimeout: GmCXt.t_.sec15,
    elLookupTime15s: GmCXt.t_.sec15,
    elLookupTime10s: GmCXt.t_.sec10,
    stepMTimeout: GmCXt.t_.sec15,
    elLookupTime30s: GmCXt.t_.sec30,

    waitForNotifications: GmCXt.t_.sec10,
    guideAutoWatch: GmCXt.t_.sec10,
    ruleTimeOut10s: GmCXt.t_.sec10,
    stepITimeout: GmCXt.t_.sec10,
    findElTimeout: GmCXt.t_.sec10,
    branchDecision_domRule: GmCXt.t_.sec10,
    branchDecision_domRule_quickBranch: GmCXt.t_.sec4,

    branchDecision: GmCXt.t_.sec2,
    branchDecision_errorHandler: GmCXt.t_.sec1,
    stepComplition: GmCXt.t_.sec4,

    drag: GmCXt.t_.sec2,
    checkVariable: GmCXt.t_.sec2,
    loginEdCast: GmCXt.t_.sec2,

    branchDecisionInterval_domRule: GmCXt.t_.sec1,
    plsWaitMsg: GmCXt.t_.sec1,
    stopRecorder: GmCXt.t_.sec1,

    toastMsg: GmCXt.t_.ms25,
    variableTimeout: GmCXt.t_.ms25,
    ruleTimeOut25ms: GmCXt.t_.ms25,

    eventGuideCompleteAuto: GmCXt.t_.ms15,
    tragetFrameWT: GmCXt.t_.ms15,
    ruleTimeOut15ms: GmCXt.t_.ms15,
    currentPageSpinner: GmCXt.t_.ms15,
    bgmsg: GmCXt.t_.ms15,

    screenrecording: GmCXt.t_.ms8,

    branchDecisionInterval: GmCXt.t_.ms5,
    msgToframes: GmCXt.t_.ms5,
    desktopCapture: GmCXt.t_.ms5,

    appPanel: GmCXt.t_.ms3,
    hiteTooltip: GmCXt.t_.ms2,
    addTooltipEvent: GmCXt.t_.ms1
};

GmCXt._location = function() {
    return window && window.location;
};

GmCXt.isWestpacOneUI = function() {
    if (window &&
		window.location &&
		window.location.href.indexOf('about:blank') !== -1 &&
		parent.window &&
		parent.window.location &&
		parent.window.location.href.indexOf('ui.westpac.com.au') !== -1) {
        return true;
    } else {
        return false;
    }
};

GmCXt.parseJSON__ = function(str) {
    try {
        if (typeof str === 'object') {
            return str;
        } else if (str === '' || str === 'AS' ||
			str === 'na' || str === '[object Object]' ||
			str === undefined || str === 'undefined'
        ) {
            return {};
        } else {
            let ob = JSON.parse(str);
            if (typeof ob === 'string') ob = JSON.parse(ob);

            return ob;
        }

    } catch (e) {
        return null;
    }
};

GmCXt.isObject = function(value) {
    return value !== null && typeof value === 'object';
};

GmCXt.isEmpty = function(val) {
    if (typeof val === "boolean" || typeof val === "number") return false; // for 'false' & zero

    if (!val) return true;

    if (typeof val === "object" && val.constructor === Object) return Object.keys(val).length ? false : true;

    if (typeof val === "object" && val.constructor === Array) return val.length ? false : true;

    if (typeof val === 'string' && !val.trim()) return true;

    return false;
};

GmCXt.isDefined = function(val) {
    if (val === undefined || val === "undefined")
        return false;
    else
        return true;
};

GmCXt.updateGlobalUser = function(user) {
    if (!user) {
        return;
    }

    if (!GmCXt.isBackgroundPage) {
        GmCXt.user = GmCXt.validateDataModel(user, GmCXt.model.user);
    } else {
        GmCXt.user = user;
    }
    if (user.organization) {
        GmCXt.updateGlobalOrg(user.organization);
    }
};

GmCXt.checkTimeStampUpdate = function() {

    let apiUrl = GmCXt.conf.publicTimestampUrl + GmCXt.organization.organization_id + ".json?mg_t=" + new Date().getTime();
    GmCXt.trackApiCalls();

    fetch(apiUrl).then(function(response) {
        if (response.status === 200) {
            response.json()
                .then(function(r) {
                    GmCXt.activeApiCallCount--;
                    if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                    let lastRefresh = r.last_updated_time;
                    if (lastRefresh != GmCXt.refreshTime) {
                        GmCXt.playerIntervalValidator();
                    }
                    GmCXt.lastTimeStampSync = GmCXt.getCurrentTimeInSec();
                    GmCXt.msgToApp('mgPlayerJSProd_action:update_timestamp_sync_time', r, typeof senderTabId !== 'undefined' ? senderTabId : undefined);

                }).catch(function(error) {
                    GmCXt.log(1, "ERROR: Public Timestamp fetch failed", error);
                    GmCXt.activeApiCallCount--;
                    if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                });

        } else {
            GmCXt.log(1, "ERROR: Public Timestamp fetch failed" + response.status);
            GmCXt.activeApiCallCount--;
            if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
        }
    });
};

GmCXt.updateGlobalOrg = function(org) {
    if (!org) {
        return;
    }

    if (!GmCXt.isBackgroundPage) {
        GmCXt.organization = GmCXt.validateDataModel(org, GmCXt.model.organization);
    } else {
        GmCXt.organization = org;
    }
    delete GmCXt.organization.applications;
};

GmCXt.playerIntervalValidator = function() {

    GmCXt.log(70, "GET TIMESTAMP at " + new Date());

    GmCXt.getJsonTimeStamp().then(function(r) {
        let lastRefresh = r.last_updated_time;

        GmCXt.log(70, "LAST REFRESH from server " + lastRefresh);

        if (lastRefresh != GmCXt.refreshTime) {
            GmCXt.log(70, "START PLAYER DATA REFRESH");
            GmCXt.msgToApp('mgPlayerJSProd_action:refresh_player', r, typeof senderTabId !== 'undefined' ? senderTabId : undefined);
        } else {
            GmCXt.log(70, "NO UPDATE FOUND " + new Date());
        }

        GmCXt.refreshTime = r.last_updated_time;
    });
};
GmCXt.creatorIntervalValidator = function() {

    GmCXt.log(70, "GET TIMESTAMP at " + new Date());

    GmCXt.getModifiedObjects().then(function(updates) {
        if (updates === 'Renewed Access Token') {
            GmCXt.creatorIntervalValidator();
        } else if (updates.length) {
            GmCXt.msgToApp('mgPlayerJSProd_action:creator_updates', {
                updates: updates,
                refreshTime: GmCXt.creatorRefreshTime
            }, typeof senderTabId !== 'undefined' ? senderTabId : undefined);
        }
    }).catch(function(err) {
        GmCXt.log(1, "ERROR: Creator sync failed", err);
    });
};

GmCXt.processLastActionTime = function() {

    let cTime = GmCXt.getCurrentTimeInSec();

    if (GmCXt.inPlayer && (cTime - GmCXt.lastTimeStampSync) > GmCXt.t.playerSync) {
        GmCXt.log(70, "TRIGGER PLAYER UPDATE " + new Date());
        GmCXt.checkTimeStampUpdate();
    }

    if (GmCXt.isCreatorExt() && (cTime - GmCXt.creatorRefreshTime) > GmCXt.t.creatorSync) {
        GmCXt.log(70, "TRIGGER CREATOR UPDATE " + new Date());
        GmCXt.creatorIntervalValidator();
    }

    GmCXt.log(45, "SEND Traker event " + new Date());
    GmCXt.trackerV1.sendEvents();

    GmCXt.log(70, "LAST USER ACTION TIME: " + new Date());
};

GmCXt.startCreatorUpdateInterval = function() {

    let callSync = function() {
        GmCXt.getModifiedObjects().then(function(updates) {
            if (updates === 'Renewed Access Token') {
                GmCXt.startCreatorUpdateInterval();
            } else if (updates.length) {
                GmCXt.msgToApp('mgPlayerJSProd_action:creator_updates', {
                    updates: updates,
                    refreshTime: GmCXt.creatorRefreshTime
                }, typeof senderTabId !== 'undefined' ? senderTabId : undefined);
            }
        }).catch(function(err) {
            GmCXt.log(1, "ERROR: Creator sync failed", err);
        });
    };

    GmCXt.creatorRefreshTime = GmCXt.refreshTime || GmCXt.getCurrentTimeInSec();

    if (GmCXt.creatorInterval) {
        return;
    }

    GmCXt.creatorInterval = setInterval(callSync, GmCXt.t.creatorSync);
};

GmCXt.sendMsgToAudioFrame = function(type, data) {
    data = data || {};
    data.config = GmCXt.conf;
    data.user = GmCXt.user;

    if (GmCXt.playerI || GmCXt.playerI === null) {
        data.playerInstance = GmCXt.playerI;
    }
    let w = mg$(".mgPlayerJSProd_play-step-audio-iframe");
    if (w.length) {
        let message = {
            action: type,
            data: data
        };
        message = GmCXt.formatMsg(message);
        w.get(0).contentWindow.postMessage(message, "*");
    }
};

GmCXt.msgToApp = function(action, data, tabId) {
    if (GmCXt.isBackgroundPage === true) {
        GmCXt.sendMessageToPanel(action, data, tabId);
    }  else if (window.top === window.self) {
        let m = {
            action: action,
            data: data
        };
        GmCXt.listenerBackgroud(m);
    }
};

GmCXt.sendMessageToPanel = function(action, data, senderTabId) {

    data = (data === undefined || data === null || !data) ? {} : data;

    let ob = {
        action: action,
        data: data
    };

    chrome.tabs.query({
        active: true,
        highlighted: true
    }, function(tabs) {
        let activeTab = false;
        for (let i = 0; i < tabs.length; i++) {
            var tab = tabs[i];
            if (tab.id === senderTabId) {
                activeTab = true;
            }
        }

        // This below condition to send an message to source tab even it is not highlighted
        // This will solve image loader issue in case of create/update steps
        if (!activeTab && senderTabId) {
            GmCXt.msgToTab(senderTabId, ob);
        }

        if (GmCXt.FT.creatorApp && tabs.length && !activeTab) {
            var tab = tabs[0];
            senderTabId = tab.id;
            GmCXt.updateVideoUploadStatus(senderTabId, {
                data: {
                    operation: "get"
                }
            });
        }

        if (GmCXt.FT.isPlayer && tabs.length && !activeTab) {
            var tab = tabs[0];
            senderTabId = tab.id;
        }

        GmCXt.msgToTab(senderTabId, ob);
    });
};

GmCXt.getCdnSignature = function(sendMessage, fromTimeStamp) {

    if (GmCXt.waitForCdnSignature) return true;

    GmCXt.waitForCdnSignature = true;

    if (sendMessage) {

        GmCXt.msgToApp('mgPlayerJSProd_action:get_cdn_signature_from_app');

    } else { //this is used in Background.js for player and cretor sync
        GmCXt.callGetCdnSignature({
            organization_id: GmCXt.organization.organization_id
        }).then(function(response) {

            let r = response.data;
            if (r && r.cdn_signature && r.cdn_signature_expiry) {

                if (GmCXt.user) {
                    GmCXt.user.cdn_signature = r.cdn_signature;
                    GmCXt.user.cdn_signature_expiry = r.cdn_signature_expiry;
                    GmCXt.updateGlobalUser(GmCXt.user);
                }
            }
            if (fromTimeStamp) {
                GmCXt.checkTimeStampUpdate();
            }
        });
    }
};

GmCXt.getCurrentTimeInMilSec = function() {
    return new Date().getTime();
};

GmCXt.getCurrentTimeInSec = function() {
    return Math.floor(new Date().getTime() / 1000);
};

GmCXt.getModifiedObjects = function(boxUrl) {

    return new Promise(function(resolve, reject) {
        let timestamp = GmCXt.creatorRefreshTime;
        let apiUrl = GmCXt.conf.webServiceUrl + 'organization/modified/objects?';
        GmCXt.log(61, "Check for updates. From timestamp: " + timestamp);

        let data = {
            timestamp: timestamp,
            organization_id: GmCXt.organization.organization_id
        };

        let headers = {
            'accesstoken': GmCXt.user.accesstoken,
            'Content-Type': 'application/json'
        };


        GmCXt.creatorRefreshTime = GmCXt.getCurrentTimeInSec();
        GmCXt.trackApiCalls();

        fetch(apiUrl + new URLSearchParams(data), {
            headers: headers
        }).then(function(response) {
            GmCXt.activeApiCallCount--;
            if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
            if (response.status === 200 || response.status === 401) {

                response.json()
                    .then(function(result) {
                    
                        if (result.error) {

                            GmCXt.creatorRefreshTime = timestamp;

                            if (result.code === 1003 || result.code === 2004) {
                                GmCXt.msgToApp('mgPlayerJSProd_action:logout_user');
                                reject(result);
                            } else if (result.code === 1007) {
                                GmCXt.getAccessToken().then(function(r) {
                                    GmCXt.saveToken(r);
                                    resolve('Renewed Access Token');
                                });
                            } else {
                                reject(result);
                            }
                            
                        } else if (result.data && result.data.objects) {
                            let updates = result.data.objects;
                            resolve(updates);
                        } else {
                            reject();
                        }
                    }).catch(function(error) {
                        reject();
                    });

            } else {
                reject();
            }
        }).catch(function(e) {
            GmCXt.log(1, "Creator could not refresh", e);
            GmCXt.activeApiCallCount--;
            if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
        });
    });
};

GmCXt.getJsonTimeStamp = function(boxUrl) {

    return new Promise(function(resolve, reject) {

        let apiCall = function(url) {
            GmCXt.trackApiCalls();
            fetch(url)
                .then(function(response) {
                    GmCXt.activeApiCallCount--;
                    if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();

                    if (response.status === 200) {
                        response.json()
                            .then(function(d) {
                                resolve(d);
                            }).catch(function(error) {
                                GmCXt.log(1, "ERROR: Timestamp fetch failed", error);
                            });
                    } else {
                        GmCXt.log(1, "ERROR: Timestamp fetch failed" + response.status);
                        GmCXt.waitForCdnSignature = false;
                        GmCXt.getCdnSignature(false, true);
                    }
                });
        };

        let apiUrl = "";

        if (GmCXt.onPrem() && boxUrl) {
            apiUrl = boxUrl + '/json/timestamp.json';
        } else if (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization)) {
            apiUrl = GmCXt.conf.cdn + GmCXt.organization.bucket +
				'/json/timestamp.json' + GmCXt.user.cdn_signature + "&" + new Date();
        }

        if(GmCXt.isEmpty(apiUrl)){
            return;
        }

        apiCall(apiUrl);

    });
};

GmCXt.encode = function(args) {
    let data = '';
    if (args) {
        let argcount = 0;
        for (let key in args) {
            if (args.hasOwnProperty(key)) {
                if (argcount++) data += '&';
                data += encodeURIComponent(key) + '=' + encodeURIComponent(args[key]);
            }
        }
    }
    return data;
};

GmCXt.getOrgKeyFromJwToken = function(myGuideOrgKey) {
    try {

        let splitMyguideKey = myGuideOrgKey.split('.')[1];
        let jwJson = atob(splitMyguideKey);
        let jwOrgKey = jwJson ? GmCXt.parseJSON(jwJson).org_key : "";
        return jwOrgKey;

    } catch (e) {
        return {};
    }
};

GmCXt.parseJSON = function(str) {
    try {
        if (typeof str === 'object') {
            return str;
        } else if (str === '' || str === 'AS' ||
			str === 'na' || str === '[object Object]' ||
			str === undefined || str === 'undefined'
        ) {
            return {};
        } else {
            return JSON.parse(str);
        }

    } catch (e) {
        return {};
    }
};

GmCXt.sendMessageToTabs = function(data) {
    chrome.tabs.query({}, function(tabs) {
        tabs.forEach(function(tab) {
            GmCXt.msgToTab(tab.id, data);
        });
    });
};

GmCXt.msgToTab = function(tabId, m) {
    chrome.tabs.sendMessage(tabId, GmCXt.formatMsg(m));
};

GmCXt.formatMsg = function(message) {

    if ((GmCXt.isWestpac() && message.action.indexOf("MyGuideReporting") !== -1)) {
        return message;
    }

    if (message.data) {
        message.mgdata = message.data;
        delete message.data;
    }
    return JSON.stringify(message);
};

GmCXt.getStepFromSteps = function(stepId, steps) {

    let s = false;
    if (stepId) {
        for (let i = 0; i < steps.length; i++) {
            if (parseInt(steps[i].step_id) === parseInt(stepId)) {
                s = steps[i];
                break;
            }
        }
    }
    return s;
};

GmCXt.getStartpointStepFromSteps = function(stepId, steps) {
    let s = false;
    if (stepId) {
        for (let i = 0; i < steps.length; i++) {
            if (parseInt(steps[i].step_id) === parseInt(stepId) && steps[i].step_settings.startPoint) {
                s = steps[i];
                break;
            }
        }
    }
    return s;
};

GmCXt.removePSStepId = function(stepId, PS, index) {
    for (let i = 0; i < PS.length; i++) {
        if (PS[i].tail === stepId) {
            PS[i].tail = PS[index].tail;
            break;
        }
    }
    PS.splice(index, 1);
    return PS;
};

GmCXt.repairPlayStructure = function(PS, steps) {

    for (let i = 0; i < PS.length; i++) {
        let step = GmCXt.getStepFromSteps(PS[i].id, steps);
        if (step) {
            continue;
        } else {
            PS = GmCXt.removePSStepId(PS[i].id, PS, i);
            PS = GmCXt.repairPlayStructure(PS, steps);
            break;
        }
    }

    return PS;
};

GmCXt.isAutomationRunning = function() {
    return (GmCXt.auto && GmCXt.auto.isAutomationRunning());
};

GmCXt.getAutomatedCurrentTour = function() {
    return (GmCXt.auto && GmCXt.auto.getAutomatedCurrentTour());
};

GmCXt.isAutomationStepRunning = function() {
    if (GmCXt.playerI) {
        let step = GmCXt.getStepFromPlayerI(GmCXt.playerI.currentStepId);
        return GmCXt.isAutomationStep(step);
    }
    return false;
};

GmCXt.convertMgdata = function(m) {
    if (m.action && m.action.indexOf("init_sfdc_env") !== -1) {
        return m;
    } else if (GmCXt.isWestpac() && m.action && m.action.indexOf("MyGuideReporting") !== -1) {
        return m;
    }
    m.data = m.mgdata;
    return m;
};

GmCXt.inArray = function(id, array) {
    if (array.indexOf(parseInt(id)) !== -1) return true;
    else return false;
};

GmCXt.inArrayString = function(str, array) {
    if (array.indexOf(str) !== -1) return true;
    else return false;
};

GmCXt.createDeepCopy = function(data) {
    if (GmCXt.isDefined(data) && !GmCXt.isEmpty(data)) {
        return JSON.parse(JSON.stringify(data));
    }
};

GmCXt.getBrowserUrl = function(i) {

    let url = '';

    if (GmCXt.browserApp === 'Safari') {
        url = safari.extension.baseURI + i;
    } else if (GmCXt.browserApp === 'firefox' || GmCXt.isClientJs()) {
        url = chrome.extension.getURL(i);
    } else {
        url = chrome.runtime.getURL(i);
    }

    return url;
};

GmCXt.getCustomerSpecificURL = function(custUrl) {
    if (GmCXt.inPlayer) {
        if (GmCXt.isSumtotal() || GmCXt.isLXP() || GmCXt.isSbx() || GmCXt.isGalaxy()) {
            custUrl = custUrl + "/" + GmCXt.conf.appConfig.customer;
        }
    }
    return custUrl;
};


GmCXt.getAccessToken = function() {
    let params = {
        url: GmCXt.getCustomerSpecificURL("user/token"),
        headers: {
            "Content-Type": "application/json",
            RefreshToken: GmCXt.user.refreshtoken
        },
        data: {
            force_update: true,
            mg_source_name: GmCXt.conf.appConfig.customer
        },
        method: 'GET'
    };
    return GmCXt.xhr(params);
};

GmCXt.saveToken = function(r) {

    if (r && r.accesstoken) {

        GmCXt.user.accesstoken = r.accesstoken;
        GmCXt.user.refreshtoken = r.refreshtoken;

        if (GmCXt.isDefined(r.app_access)) {
            GmCXt.user.app_access = r.app_access;
        }

        if (GmCXt.isDefined(r.profile)) {
            GmCXt.user.profile = r.profile;
        }

        if (!GmCXt.isBackgroundPage) {

            GmCXt.getWidgetIcon().then(function(wUrl) {
                mg$(".mgPlayerJSProd_start-button img").attr('src', wUrl);
            });
        }

        GmCXt.msgToApp('mgPlayerJSProd_action:update_access_token', r, typeof senderTabId !== 'undefined' ? senderTabId : undefined);
    }
};

GmCXt.addStoragePrefix = function(key) {
    if (key.indexOf(GmCXt.storagePrefix) === -1) {
        key = GmCXt.storagePrefix + key;
    }
    return key;
};

GmCXt.removeStoragePrefix = function(key) {
    if (key.indexOf(GmCXt.storagePrefix) !== -1) {
        key = key.split(GmCXt.storagePrefix)[1];
    }
    return key;
};

GmCXt.getUUID = function() {
    let date = new Date().getTime();
    let uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        let randomNumber = (date + Math.random() * 16) % 16 | 0;
        date = Math.floor(date / 16);
        return (c == 'x' ? randomNumber : (randomNumber & 0x3 | 0x8)).toString(16);
    });
    return uuid;
};

GmCXt.categoryLog = function(c) {
    return "APP: " + c.application_id + " : [" + c.category_id + ", " + c.category_title + "] ";
};

GmCXt.tourLog = function(t) {
    return " [" + t.tour_id + ", " + t.tour_title + "] ";
};

GmCXt.stepLog = function(s, t) {
    return " [ step: " + s + ", tour: " + t + "] ";
};
GmCXt.isTrue = function(prop) {
    if (parseInt(prop) === 1 || prop === true) return true;
    else return false;
};

// Returns false if it could not update tour play structure
GmCXt.updateTourPlayStructure = function(data) {

    let stepObj = data.step;
    let prevStepData = data.prevStepData;

    GmCXt.log(54, "GmCXt.updateTourPlayStructure ", data);

    if (prevStepData && prevStepData.tour && prevStepData.tour.tour_settings &&
		prevStepData.tour.tour_settings.play_structure) {

        GmCXt.log(54, "GmCXt.updateTourPlayStructure check 1");

        let oldTail = null;
        let playStructure = prevStepData.tour.tour_settings.play_structure;

        if (playStructure.length > 0) {

            if (prevStepData.step_id) {

                for (var i = 0; i < playStructure.length; i++) {

                    // Get the prevStepData.step_id from the plus node
                    // Search for the step from that node

                    if (playStructure[i].id === prevStepData.step_id) {

                        if (GmCXt.checkForBranchVariationSteps(prevStepData)) {

                            if (!playStructure[i].branch) {
                                playStructure[i].branch = [];
                            }

                            let branchIndex = prevStepData.branch_index;

                            if (playStructure[i].branch[branchIndex].tail && playStructure[i].branch[branchIndex].tail !== -1) {
                                oldTail = playStructure[i].branch[branchIndex].tail;
                            } else if (playStructure[i].branch[branchIndex].tail === -1) {
                                for (let j = 0; j < playStructure[i].branch.length; j++) {
                                    if (playStructure[i].branch[j].tail === -1) {
                                        playStructure[i].branch[j].tail = stepObj.step_id;
                                    }
                                }
                            }
                            playStructure[i].branch[branchIndex].tail = stepObj.step_id;

                        } else {
                            // Update the tail
                            if (playStructure[i].tail) {
                                oldTail = playStructure[i].tail;
                            }
                            playStructure[i].tail = stepObj.step_id;
                            break;
                        }
                    }
                }
            } else {
                oldTail = playStructure[0].id;
            }

        }

        let obj = {
            id: stepObj.step_id,
            tail: oldTail
        };

        let stepSettings = stepObj.step_settings;

        if (stepObj.step_type === GmCXt.STEP_TYPE_BRANCH) {
            obj.branch = [];
            obj.tail = null;
            for (var i = 0; i < stepSettings.branch.length; i++) {
                if (stepSettings.branch[i].tail) {
                    obj.branch.push({
                        tail: stepSettings.branch[i].tail
                    });
                } else {
                    obj.branch.push({
                        tail: null
                    });
                }
            }
        } else if (GmCXt.isTrue(stepObj.step_settings.inlineBranch) || stepObj.step_type === GmCXt.STEP_TYPE_ERROR_HANDLER) {
            obj.branch = [];
            obj.branch.push({
                tail: oldTail
            }, {
                tail: null
            });
            obj.tail = null;
        }

        if (prevStepData.step_id) {
            playStructure.push(obj);
        } else {
            playStructure.splice(0, 0, obj);
        }
        prevStepData.tour.tour_settings.play_structure = playStructure;

        data.prevStepData = prevStepData;

        return data;
    }

    return false;
};

// These labels are always in english
GmCXt.engLbls = {
    px: "px",
    Guide: "Guide",
    defaultTestMe: "TestMe",
    defaultShowMe: "ShowMe",
    defaultGuideMe: "GuideMe",
    defaultDoItForMe: "DoItForMe",
    testMe: "TestMe",
    showMe: "ShowMe",
    guideMe: "GuideMe",
    doItForMe: "DoItForMe",
    microPlayer: "Mini Player",
    myGuides: "My Guides",
    powerHTML: "Power HTML",
    defaultNext: "Next",
    defaultBtnPrev: "Prev"
};

GmCXt.getPlayerLabels = function(lang) {
    let lab = GmCXt.playerLbls.en_US;

    if (lang) {
        lang = lang.replace("-", "_");

        if (GmCXt.playerLbls[lang]) {
            lab = GmCXt.playerLbls[lang];
        }
    }

    lab = GmCXt.mergeLabels(lab, GmCXt.engLbls);
    return lab;
};

GmCXt.getCreatorLabels = function(lang) {
    let lab = GmCXt.creatorLbls.en_US;

    if (lang) {
        lang = lang.replace("-", "_");

        if (GmCXt.creatorLbls[lang]) {
            lab = GmCXt.creatorLbls[lang];
        }
    }

    return lab;
};

GmCXt.mergeLabels = function(labels, lbs) {
    for (let attr in lbs) {
        labels[attr] = lbs[attr];
    }

    return labels;
};

GmCXt.setRuleOpsUILabels = function() {
    GmCXt.ruleOpsUILabels[GmCXt.EXISTS] = GmCXt.label.opExists;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_EXISTS] = GmCXt.label.opNotExists;
    GmCXt.ruleOpsUILabels[GmCXt.EQUALS] = GmCXt.label.opEquals;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_EQUAL] = GmCXt.label.opNotEquals;
    GmCXt.ruleOpsUILabels[GmCXt.TXT_EQUALS] = GmCXt.label.opTxEquals;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_TXT] = GmCXt.label.opTxNotEquals;
    GmCXt.ruleOpsUILabels[GmCXt.CONTAINS] = GmCXt.label.opContains;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_CONTAINS] = GmCXt.label.opNotContains;
    GmCXt.ruleOpsUILabels[GmCXt.STARTS_WITH] = GmCXt.label.opStWith;
    GmCXt.ruleOpsUILabels[GmCXt.ENDS_WITH] = GmCXt.label.opEndWith;
    GmCXt.ruleOpsUILabels[GmCXt.GREAT_THAN] = GmCXt.label.opGrThan;
    GmCXt.ruleOpsUILabels[GmCXt.LESS_THAN] = GmCXt.label.opLeThan;
    GmCXt.ruleOpsUILabels[GmCXt.TXT_MATCHES] = GmCXt.label.opTxMatch;
    GmCXt.ruleOpsUILabels[GmCXt.TXT_CONTAINS] = GmCXt.label.opTxContains;
    GmCXt.ruleOpsUILabels[GmCXt.ATTRIBUTES] = GmCXt.label.opAttrs;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_ATTRIBUTES] = GmCXt.label.opNoAttrs;
    GmCXt.ruleOpsUILabels[GmCXt.CLASSES] = GmCXt.label.opClasses;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_CLASSES] = GmCXt.label.opNoClasses;
    GmCXt.ruleOpsUILabels[GmCXt.SELECTED] = GmCXt.label.opSelect;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_SELECTED] = GmCXt.label.opNoSelect;
    GmCXt.ruleOpsUILabels[GmCXt.CHECKED] = GmCXt.label.opChecked;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_CHECKED] = GmCXt.label.opNoChecked;
    GmCXt.ruleOpsUILabels[GmCXt.DISABLED] = GmCXt.label.opDisabled;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_DISABLED] = GmCXt.label.opNoDisable;
    GmCXt.ruleOpsUILabels[GmCXt.DAY_OF_WEEK] = GmCXt.label.opDayOfWeek;
    GmCXt.ruleOpsUILabels[GmCXt.FIX_TIME] = GmCXt.label.opFixTime;
    GmCXt.ruleOpsUILabels[GmCXt.DATE_RANGE] = GmCXt.label.opDateRange;
    GmCXt.ruleOpsUILabels[GmCXt.IS_VALID] = GmCXt.label.opIsValid;
    GmCXt.ruleOpsUILabels[GmCXt.VISIBLE] = GmCXt.label.opVisible;
    GmCXt.ruleOpsUILabels[GmCXt.NOT_VISIBLE] = GmCXt.label.opNotVisible;
};

GmCXt.getLanguageLabelsApi = function(url) {
    return new Promise(function(resolve, reject) {
        GmCXt.trackApiCalls();

        fetch(url)
            .then((response) => {
                GmCXt.activeApiCallCount--;
                if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // Parse response body as JSON
            })
            .then((jsonData) => {
                resolve(jsonData);
            })
            .catch((error) => {
                GmCXt.activeApiCallCount--;
                if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                reject(error);
            });
    });
};

GmCXt.addLanguageDataInStorage = async function(url, languageCode, storageLanguageData, isPlayer) {

    if (!GmCXt.isEmpty(storageLanguageData)) {
        isPlayer ? (GmCXt.playerLbls = storageLanguageData) : (GmCXt.creatorLbls = storageLanguageData);
    }

    const targetLbls = isPlayer ? GmCXt.playerLbls : GmCXt.creatorLbls;
    const targetEngLbls = isPlayer ? GmCXt.playerLbls["en_US"] : GmCXt.creatorLbls["en_US"];
    const storageKey = isPlayer ? 'language_labels_player'+"_"+ GmCXt.conf.version : 'language_labels_creator'+ "_" + GmCXt.conf.version;

    try {
        const result = await GmCXt.getLanguageLabelsApi(url);
        const labelsData = GmCXt.parseJSON(result);
        targetLbls[languageCode] = labelsData;
        GmCXt.storage().set({
            [storageKey]: JSON.stringify(targetLbls),
        });
        return result;
    } catch (error) {
        targetLbls[languageCode] = targetEngLbls;
        GmCXt.storage().set({
            [storageKey]: JSON.stringify(targetLbls),
        });
        return;
    }
};

GmCXt.getLanguageLabels = function(languageCode, isPlayer) {
    if (!languageCode || GmCXt.isEmpty(languageCode)) languageCode = 'en_US';
    let appName = isPlayer ? 'player' : 'creator';

    function getLanguageLabelsCb(data) {
        isPlayer
            ?
            (GmCXt.playerLbls[languageCode] = !data ? GmCXt.playerLbls.en_US : data) :
            (GmCXt.creatorLbls[languageCode] = !data ? GmCXt.creatorLbls.en_US : data);
    }

    return new Promise(function(resolve, reject) {
        if (languageCode.indexOf('en_') !== -1 || languageCode.indexOf('en-') !== -1) {
            getLanguageLabelsCb();
            resolve();
        } else {
            var langFileName = languageCode;
            languageCode = languageCode.replace('-', '_');
            let url = GmCXt.conf.staticContentPath + 'json/locale/' + appName + '/' + langFileName + '.json';
            let storageKey = "language_labels" + "_" + appName + "_" + GmCXt.conf.version;
            GmCXt.storage().get([storageKey]).then(function(response) {
                const result = response[storageKey];
                const storageLanguageData = !GmCXt.isEmpty(result) ? GmCXt.parseJSON(result) : [];

                if (GmCXt.isEmpty(storageLanguageData) || GmCXt.isEmpty(storageLanguageData[languageCode])) {
                    GmCXt.addLanguageDataInStorage(url, languageCode, storageLanguageData, isPlayer).then(function() {
                        resolve();
                    });
                } else {
                    getLanguageLabelsCb(storageLanguageData[languageCode]);
                    resolve();
                }
            });
        }
    });
};

GmCXt.getAllLabels = function(lang) {
    GmCXt.label = GmCXt.getPlayerLabels(lang);

    if (GmCXt.FT.creatorApp) {
        GmCXt.label = GmCXt.mergeLabels(GmCXt.label, GmCXt.getCreatorLabels(lang));
    }

    // to replace missing lang labels with eng lang labels
    if (lang !== "en_US" && lang !== "en-US") {
        let enLabels = GmCXt.getEngLabels();

        let lbl = Object.assign({}, enLabels, GmCXt.label);
        GmCXt.label = lbl;
    }

    GmCXt.setRuleOpsUILabels();
    return GmCXt.label;
};

GmCXt.getEngLabels = function() {
    let engLabels = GmCXt.getPlayerLabels('en_US');

    if (GmCXt.FT.creatorApp) {
        engLabels = GmCXt.mergeLabels(engLabels, GmCXt.getCreatorLabels('en_US'));
    }

    return engLabels;
};

GmCXt.checkForBranchVariationSteps = function(step) {
    if (step && (step.step_type === GmCXt.STEP_TYPE_BRANCH ||
			step.step_type === GmCXt.STEP_TYPE_ERROR_HANDLER ||
			GmCXt.isTrue(step.step_settings && step.step_settings.inlineBranch))) {
        return true;
    }
    return false;
};

GmCXt.convertWeeksToHours = function(w) {
    let h = parseFloat(w) * 7 * 24;
    return h;
};

GmCXt.getDatafromPanel = function() {

    return new Promise(function(resolve, reject) {

        function sendResponse(m) {
            if (m && m.action === 'mgPlayerJSProd_action:get_data_from_panel_response') {
                removeEventListener('message', chromeListener);
                resolve(m.data);
            }
        }

        function chromeListener(event) {
            let message = GmCXt.parseJSON(event);
            message = GmCXt.convertMgdata(message);

            sendResponse(message);
        }


        if (GmCXt.isBackgroundPage === true) {
            chrome.runtime.onMessage.addListener(chromeListener);
            GmCXt.sendMessageToPanel('mgPlayerJSProd_action:get_data_from_panel');
        } else {
            resolve(false);
        }

    });
};

GmCXt.isEventTimeValid = function(payloadDate) {
    let isValid = true;
    let currentDate = new Date();
    let currentTimestamp = currentDate.getTime();
    let payloadTimestamp = new Date(payloadDate).getTime();

    let expTimestamp = currentTimestamp - (60 * 60 * 24 * 6 * 1000);
    if (payloadTimestamp < expTimestamp) {
        isValid = false;
    }
    return isValid;
};

GmCXt.checkDefaultLangForTour = function(t, l) {
    let retVal = false;
    if (GmCXt.isFalse(l) || l.indexOf('en-') !== -1)
        retVal = true;
    else if (t && t.languages && t.languages.length) {
        let dl = t.languages[t.languages.length - 1];
        if (dl && dl.language === l) {
            retVal = true;
        }
    }

    return retVal;
};

GmCXt.isGuideInDefaultLang = function(tour, activeLang) {
    let narrator = tour?.narrator;
    let guideLang = "";

    if (!GmCXt.isEmpty(narrator)) {
        guideLang = GmRootScope.parseTourNarrator(tour);
    }

    // If active language is not defined or matches guide language, return true
    if (!activeLang || GmCXt.isEmpty(guideLang)) {
        return true;
    }
    // If active language doesn't match guide language, check if both are English variants
    if (guideLang !== activeLang) {
        return guideLang.indexOf("en-") !== -1 &&
           activeLang.substring(0, 3) === guideLang.substring(0, 3);
    }

    return true;
};

//***************************** page tracking ***************************************//
/*global GmCXt,mg$*/
GmCXt.startPageTracker = function() {

    if (GmCXt.pageVisit) {

        if (GmCXt.pageVisit.url === GmCXt.urlParts.fullUrl) {
            GmCXt.log(2, "Return on same page");
            return;
        } else {
            GmCXt.trackerV1.trackPageVisit();
        }
    }

    GmCXt.pageVisit = {
        url: GmCXt.urlParts.fullUrl,
        timeStarted: new Date().getTime(),
        userKey: GmCXt.user.user_key,
        pageLoadTime: GmCXt.pageLoadTime
    };

    let title = GmCXt.getDocTitle();
    if (title) {
        GmCXt.pageVisit.title = title.trim();
    }
    GmCXt.log(2, "Start new page", GmCXt.pageVisit);
};

//***************************** tooltip tracking ***************************************//
GmCXt.tooltipTrackingList = {};

GmCXt.setTooltipRenderInfo = function(tour, tid, sid, smartTip, url) {
    let stepKey = "step_" + sid;

    let currentTip = {
        tooltip_id: sid,
        tooltip_type: GmCXt.getTooltipName(smartTip.type),
        rendered: true,
        action_type: "",
        tooltip_play_instances: [],
        play_instance_id: GmCXt.getUUID(),
    };

    GmCXt.tooltipTrackingList[stepKey] = {
        track: false,
        tourId: tid,
        url: GmCXt.urlParts.fullUrl,
        ttDetails: currentTip,
        startTime: new Date().getTime(),
        screen_size: GmCXt.trackerV1.getScreenSize(),
        tour: tour
    };
};

GmCXt.updateTooltipActionInfo = function(tid, sid, smartTip, actionName) {

    if (window.self === window.top) {

        let stepKey = "step_" + sid;

        let currentTip = GmCXt.tooltipTrackingList[stepKey].ttDetails;

        var tour = GmCXt.tooltipTrackingList[stepKey].tour;
        //for power form send only 1 action, submit gets precedence over cancel
        if (currentTip.tooltip_type === 'power_html') {

            if (actionName === "cancel" && currentTip.action_type.length === 0) {
                currentTip.action_type = ['cancel'];
                GmCXt.tooltipTrackingList[stepKey].track = true;
            }

            if (actionName === "submit") {
                currentTip.action_type = ['submit'];
                GmCXt.tooltipTrackingList[stepKey].track = true;
            }

        } else if (actionName) {
            currentTip.action_type = [actionName];
            GmCXt.tooltipTrackingList[stepKey].track = true;
        }

        currentTip.tooltip_play_instances = [];
        currentTip.tooltip_play_instances.push({
            event_start_time: GmCXt.getCurrentTimeInMilSec(),
            event_end_time: GmCXt.getCurrentTimeInMilSec()
        });

        if (tour && tour.tour_settings.segment_groups) {
            currentTip.segment_details = GmCXt.getTourSegmentDetail(tour);
        }

        if (actionName === "url_click") {
            currentTip.tooltip_url = smartTip.tooltipURL;
        }

        GmCXt.trackerV1.trackTooltips(currentTip);
    } else {

        let data = {
            tourId: tid,
            stepId: sid,
            smartTip: smartTip,
            actionName: actionName,
            tour: tour
        };
        let msg = "mgPlayerJSProd_action:update_tooltip_action_info";

        if (GmCXt.isSidePanelApp) {

            GmCXt.sendToParentWindow({
                action: msg,
                data: data
            });
        } else {
            GmCXt.sendMessageToTheTopWindow(msg, data);
        }
    }
};

GmCXt.resetTooltipTrackingInfo = function() {
    for (let stepKey in GmCXt.tooltipTrackingList) {
        GmCXt.tooltipTrackingList[stepKey].track = false;
    }
};
//***************************** guide play tracking ***************************************//

GmCXt.trackGuide = function() {

    GmCXt.log(33, 'Track Guide Play');
    GmCXt.trackerV1.trackGuidePlayEvent();
    GmCXt.guidePlayTracker = {};

    GmCXt.storage().set({
        'guide_play_event': {}
    });
};

GmCXt.getSource = function(i) {
    let s;
    switch (i) {
    case 'overlayTourPopup':
        s = 'push_notification';
        break;
    case 'beaconTour':
        s = 'beacon';
        break;
    case 'urlTour':
        s = 'url';
        break;
    case 'task_list':
        s = 'task_list';
        break;
    default:
        s = 'panel';
        break;
    }

    return s;
};

GmCXt.setGuidePlayTracker = function(tid) {
    let playMode = "mi_guide_play";

    if (GmCXt.playerI.automate && GmCXt.playerI.source !== "bot") {
        playMode = "mi_do_it_for_me";
    } else if (GmCXt.playerI.source === "bot") {
        playMode = "mi_bot_play";
    } else if (GmCXt.playerI.mode === "slideshow") {
        playMode = "mi_showme_play";
    }

    let trackerObj = {
        trigger_source: GmCXt.getSource(GmCXt.playerI.origin),
        play_instance_id: GmCXt.getUUID(),
        is_new_user: false,
        event_start_time: new Date().getTime(),
        event_end_time: '',
        url: GmCXt.urlParts.fullUrl,
        steps_details: [],
        mode: playMode
    };

    trackerObj.guide_id = tid;
    trackerObj.guide_complete = 0;
    trackerObj.guide_open = GmCXt.playerI.guideOpened ? 1 : 0;

    if (playMode === "mi_showme_play") {
        trackerObj.audio_muted = GmCXt.stepAudioRunningStatus ? 0 : 1;
        trackerObj.type = "guided";
    }

    if (GmCXt.playerI && GmCXt.playerI.taskObj && GmCXt.playerI.taskObj.taskId) {
        trackerObj.task_list_id = GmCXt.playerI.taskObj.taskId;
    }

    if (GmCXt.playerI && GmCXt.playerI.tour.tour_settings.segment_groups) {
        trackerObj.segment_details = GmCXt.getTourSegmentDetail(GmCXt.playerI.tour);
    }

    GmCXt.guidePlayTracker["tour:" + tid] = trackerObj;
};

GmCXt.isStepExists = function(sid, stepList) {

    let stepIndex;

    stepList.forEach(function(s, key) {
        if (parseInt(s.step_id) === parseInt(sid)) {
            stepIndex = key;
        }
    });

    return stepIndex;
};

GmCXt.encodeStringToBase64 = function(str) {
    if (!GmCXt.isEmpty(str)) {
        str = btoa(unescape(encodeURIComponent(str)));
    }
    return str;
};

GmCXt.trackStepEvent = function(step, error) {
    if (GmCXt.isEmpty(step.tour_id)) return;
	
    if (!GmCXt.guidePlayTracker["tour:" + step.tour_id]) GmCXt.setGuidePlayTracker(step.tour_id);

    let tourDetails = GmCXt.guidePlayTracker["tour:" + step.tour_id];

    let stepExistIndex = GmCXt.isStepExists(step.step_id, tourDetails.steps_details);

    if (stepExistIndex >= 0) {
        tourDetails.steps_details.splice(stepExistIndex, 1);
    }


    if (tourDetails.steps_details.length) {
        let length = tourDetails.steps_details.length;
        tourDetails.steps_details[length - 1].event_end_time = new Date().getTime();
    }

    let step_details = {
        step_id: step.step_id,
        step_index: parseInt(step.step_order),
        step_title: GmCXt.encodeStringToBase64(step.step_title),
        step_type: step.step_type,
        event_start_time: new Date().getTime(),
        event_end_time: new Date().getTime(),
        page_url: GmCXt.urlParts.fullUrl,
        error_type: error || "",
        audio_muted: GmCXt.stepAudioRunningStatus ? 0 : 1
    };

    if (step.step_type === GmCXt.STEP_TYPE_GUIDE) {
        step_details.linked_guide_id = step.step_settings.tour_id;
    }

    if (tourDetails.mode === "mi_do_it_for_me") {
        if (step.step_settings.automation.hasHumanInteraction) {
            step_details.requires_human_intervention = 1;
            step_details.step_skipped = 0;
        } else {
            step_details.requires_human_intervention = 0;
            step_details.step_skipped = 0;
        }
    }

    if (tourDetails.mode === "mi_bot_play" &&
		step.step_settings.automation.enableBot &&
		step.step_settings.automation.botQuestion) {
        step_details.requires_human_intervention = 1;
        step_details.step_skipped = 0;
        if (step_details.defaultData && !GmCXt.isEmpty(step_details.defaultData)) {
            step_details.isAnswered = 1;
        } else {
            step_details.isAnswered = 0;
        }
        step_details.botQuestion = step.step_settings.automation.botQuestion;
    }

    GmCXt.guidePlayTracker["tour:" + step.tour_id].steps_details.push(step_details);
    GmCXt.storage().set({
        'guide_play_event': GmCXt.guidePlayTracker
    });
};

GmCXt.updateAudioStatusForTracking = function() {

    if (GmCXt.isEmpty(GmCXt.playerI)) return;

    let tourSteps = GmCXt.guidePlayTracker["tour:" + GmCXt.playerI.tour.tour_id].steps_details;

    for (let i = 0; i < tourSteps.length; i++) {
        let s = tourSteps[i];

        if (s.step_id === GmCXt.playerI.currentStepId) {
            s.audio_muted = GmCXt.stepAudioRunningStatus ? 0 : 1;
        }
    }
};

GmCXt.checkSkipStepForTracking = function() {

    if (GmCXt.isEmpty(GmCXt.playerI)) return;

    let stepId = GmCXt.playerI.currentStepId;

    let tourId = GmCXt.playerI.tour.tour_id;

    let tourDetails = GmCXt.guidePlayTracker["tour:" + tourId];

    let stepExistIndex = -1;

    if (tourDetails) {
        stepExistIndex = GmCXt.isStepExists(stepId, tourDetails.steps_details);
    }

    if (stepExistIndex >= 0) {
        tourDetails.steps_details[stepExistIndex].step_skipped = 1;
    }
};

GmCXt.getTourSegments = function(tour) {
    //for tours played from side panel
    if (tour.tour_settings.valid_segments) {
        return tour.tour_settings.valid_segments;
    } else {
        let tourSeg = tour.tour_settings.segment_groups;
        let validSegments = tourSeg.filter(function(s) {
            return GmCXt.validatedSegments[s];
        });

        return validSegments;
    }
};

//***************************** workflow tracking ***************************************//

GmCXt.concatLinkGuideStepsForTracking = function(allSteps, stepIndex, currentStepId, newSteps) {

    allSteps = allSteps.filter(function(step, i) {
        return step.step_id !== currentStepId;
    });

    let s = [stepIndex, 0].concat(newSteps);

    return allSteps.splice(s);
};

GmCXt.userActionEvents = function(step) {

    let settings = step.step_settings;

    let flag = false;

    if (settings.clickNext ||
		settings.onRightClickNext ||
		settings.onKeyupNext ||
		settings.onChangeNext
    ) {
        flag = true;
    }

    return flag;

    // Tracking onPageClickNext event
    // Say there are 7 steps, 1, 2, 3, 4, 5, 6, 7 and a pause after step 2.
    // On click => write state in localStorage.
    // In new window => check state => add events on all steps after 2
    // In current window, add events on all steps after 2
};

GmCXt.limitStepAttributes = function(steps) {

    for (let i = 0; i < steps.length; i++) {
        steps[i] = {
            step_id: steps[i].step_id,
            step_title: steps[i].step_title,
            step_url: steps[i].step_url,
            step_settings: {
                element: steps[i].step_settings.element,
                highlightedArea: steps[i].step_settings.highlightedArea,
            }
        };
    }

    return steps;
};

GmCXt.filterInlineSteps = function(steps) {
    return steps.filter(function(step) {
        return GmCXt.limitStepAttributes((step.step_type === 'inline') && GmCXt.userActionEvents(step));
    });
};

GmCXt.isSvgTag = function(t) {
    if (t === 'svg' ||
		t === 'use' ||
		t === 'path' ||
		t === 'g') {
        return true;
    } else
        return false;
};

//*****************************for click tracking ***************************************//

GmCXt.clickedElSelector = function(he, obj) {

    let attr = GmCXt.getAttributeValues(he);
    obj.attributes = [];
    if (!GmCXt.isEmpty(attr)) {
        for (let prop in attr) {
            var value = attr[prop];
            switch (prop) {
            case 'text':
                if (obj.isRoot) {
                    obj.text = attr.text || he.value.trim();
                }
                break;

            case 'class':
                var value = attr.class.split(" ").filter(Boolean);
                obj.class = value;
                break;

            case 'id':
                obj.id = attr.id;
                break;

            case 'tagName':
                obj.tagName = attr.tagName.toLowerCase();
                break;

            default:
                var attrObj = {};
                attrObj[prop] = attr[prop];
                obj.attributes.push(attrObj);
            }
        }
    }

    obj.index = mg$(he).index();

    return obj;
};

GmCXt.getDOMElementClicked = function(he) {

    if (!he) return {};

    he = GmCXt.skipTags(he);

    if (he) {

        let tempHe = he;
        let btnTags = ['A', 'BUTTON', 'INPUT'];

        while (tempHe.parentElement && tempHe.parentElement.childElementCount === 1) {
            // Go up till the outermost layer of an element (For clicks captured within the actual button/element)
            if (tempHe.tagName === 'BODY' || btnTags.includes(tempHe.tagName)) {
                break;
            }
            if ((tempHe.parentElement && tempHe.parentElement.childElementCount > 1) ||
				!tempHe.parentElement) {
                break;
            }
            tempHe = tempHe.parentElement;
            he = tempHe;
        }

        let obj = {
            isRoot: true,
        };

        let target = GmCXt.clickedElSelector(he, obj);

        let elLabel = target.text;
        target.isUniqueText = GmCXt.isUniqueText(he, elLabel);

        GmCXt.selectorTool = GmCXt.selector({
            cb: null,
            frame: {}
        });

        if (target.index > -1) {

            let clickJson = {
                element_object: target,
                element_label: elLabel,
                element_step_obj: '', // TODO: element
                event_start_time: new Date().getTime(),
                url: GmCXt.urlParts.fullUrl
            };

            return clickJson;
        }
    }
};

GmCXt.isUniqueText = function(he, text) {
    if (!text || text.length > 300)
        return false;

    text = text.replace(/\'/g, "\\'").replace(/\"/g, '\\"');

    try {
        var nodes = mg$(he.tagName + ":contains('" + text + "')");
    } catch (e) {
        return false;
    }

    if (!he.value || !he.value.trim()) {
        nodes = GmCXt.filterParentNodes(nodes, text);
    }

    return nodes.length === 1;
};

GmCXt.isVisibilityMutated = function(mutation) {
    if (mutation.attributeName === 'style' &&
		mutation.oldValue &&
		(
		    mutation.oldValue.includes('display: none') ||
			mutation.oldValue.includes('visibility: hidden')
		)
    ) {
        return true;
    } else if (mutation.attributeName === 'aria-expanded' &&
		mutation.oldValue && mutation.oldValue.includes('false')
    ) {
        return true;
    } else if (mutation.attributeName === 'aria-hidden' &&
		mutation.oldValue && mutation.oldValue.includes('true')

    ) {
        return true;
    }
    return false;
};

// TODO: I can see there is always some mutation due to GuideMe classes on the element.
// This fixes the Automation issue but we need more concrete solution for this. [MG-14885]
GmCXt.checkMutation = function(mutationsList, observer) {

    let isMutationInMyGuideEl = function(m) {
        return (GmCXt.hasMyGuideEl(m.removedNodes) || GmCXt.hasMyGuideEl(m.addedNodes));
    };

    let isMutationInMyGuideAttr = function(m) {
        if (m.attributeName.indexOf('gm') === 0) {
            return true;
        }

        if (m.attributeName === 'class') {
            return (GmCXt.checkMyGuideClass(m.target.className) !== GmCXt.checkMyGuideClass(m.oldValue));
        } else if (m.attributeName === 'style') {
            return GmCXt.checkMyGuideClass(m.target.className);
        }

        return false;
    };

    // Use traditional 'for loops' for IE 11
    if (mutationsList.length && !GmCXt.mutationOccured) {
        let len = mutationsList.length;
        for (let i = 0; i < len; i++) {
            let m = mutationsList[i];
            if (m.type === 'attributes' && !isMutationInMyGuideAttr(m)) {
                if (GmCXt.isVisibilityMutated(m)) {
                    GmCXt.mutationOccured = true;
                }
                if (m.oldValue !== m.target.getAttribute(m.attributeName)) {
                    GmCXt.mutationOccured = true;
                }
            } else if (m.type === 'childList' && !isMutationInMyGuideEl(m)) {
                GmCXt.mutationOccured = true;
            }
        }
    }
};

GmCXt.isInputElement = function(he) {
    let inputs = ['INPUT', 'SELECT', 'TEXTAREA'];
    if (inputs.includes(he.tagName)) {
        return true;
    }
    return false;
};

GmCXt.mutationObserver = function(he) {

    let clickJson = GmCXt.getDOMElementClicked(he);

    GmCXt.mutationOccured = false;

    let targetNode = document.body;
    if (targetNode.nodeType !== 1) {
        return;
    }

    // Options for the observer (which mutations to observe)
    let config = {
        attributes: true,
        characterData: true,
        childList: true,
        subtree: true,
        attributeOldValue: true,
        characterDataOldValue: true
    };

    // Create an observer instance linked to the callback function
    let observer = new MutationObserver(GmCXt.checkMutation);

    // Start observing the target node for configured mutations
    observer.observe(targetNode, config);

    // Later, you can stop observing
    let waitTime = 20;
    if (window.top !== window.self) {
        waitTime = 1000;
    }

    GmCXt.timeout(function() {
        observer.disconnect();

        if ((GmCXt.mutationOccured || GmCXt.isInputElement(he)) && !GmCXt.isGmElement(mg$(he))) {
            // TODO: Track click event
        }

    }, waitTime);
};

//***************************** end click tracking ***************************************//

GmCXt.trackApiCalls = function (fromBackground, noLoader) {

    if (GmCXt.conf.appConfig.trackNetwork) {
        if (GmCXt.isBackgroundPage === true) {
            GmCXt.sendMessageToPanel("mgPlayerJSProd_action:trackApiCalls");
        } else{
            GmCXt.apiCallCount++;
            GmCXt.showApiCallCount();
        }
    }

    if (typeof GmRootScope === 'undefined') return;

    if (!GmCXt.isBackgroundPage && !fromBackground) {
        GmCXt.activeApiCallCount++;
        if (GmCXt.activeApiCallCount === 1) {
            // Do not show loader for traking events api calls
            if (!noLoader) GmRootScope.showLoading();
            if (GmCXt.loadingAutoHideTimer) {
                clearTimeout(GmCXt.loadingAutoHideTimer);
            }
            GmCXt.loadingAutoHideTimer = setTimeout(() => {
                GmCXt.activeApiCallCount = 0;
                GmRootScope.hideLoading();
            }, 10000);
        }
    }
};

GmCXt.showApiCallCount = function () {
    mg$('.mgPlayerJSProd_guide_api_count').remove();
    var apiCountHtml = "<wmgPlayerJSProd_ class='mgPlayerJSProd_guide_api_count'>" + GmCXt.apiCallCount + '</wmgPlayerJSProd_>';
    mg$('html').append(apiCountHtml);
    mg$('.mgPlayerJSProd_guide_api_count').show();
};

GmCXt.setElementStyle = function(selector, styles, isImportant) {
    if (!selector || !styles || Object.keys(styles).length === 0) {
        return;
    }

    const keys = Object.keys(styles);

    mg$(selector).each(function () {
        if (keys.length === 1) {
            const property = keys[0];
            this.style.setProperty(property, styles[property], isImportant ? 'important' : '');
        } else if (keys.length > 1) {
            for (const property in styles) {
                this.style.setProperty(property, styles[property], isImportant ? 'important' : '');
            }
        }
    });
};
/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.localforage=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(a){"use strict";function c(){k=!0;for(var a,b,c=l.length;c;){for(b=l,l=[],a=-1;++a<c;)b[a]();c=l.length}k=!1}function d(a){1!==l.push(a)||k||e()}var e,f=a.MutationObserver||a.WebKitMutationObserver;if(f){var g=0,h=new f(c),i=a.document.createTextNode("");h.observe(i,{characterData:!0}),e=function(){i.data=g=++g%2}}else if(a.setImmediate||void 0===a.MessageChannel)e="document"in a&&"onreadystatechange"in a.document.createElement("script")?function(){var b=a.document.createElement("script");b.onreadystatechange=function(){c(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},a.document.documentElement.appendChild(b)}:function(){setTimeout(c,0)};else{var j=new a.MessageChannel;j.port1.onmessage=c,e=function(){j.port2.postMessage(0)}}var k,l=[];b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(a,b,c){"use strict";function d(){}function e(a){if("function"!=typeof a)throw new TypeError("resolver must be a function");this.state=s,this.queue=[],this.outcome=void 0,a!==d&&i(this,a)}function f(a,b,c){this.promise=a,"function"==typeof b&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),"function"==typeof c&&(this.onRejected=c,this.callRejected=this.otherCallRejected)}function g(a,b,c){o(function(){var d;try{d=b(c)}catch(b){return p.reject(a,b)}d===a?p.reject(a,new TypeError("Cannot resolve promise with itself")):p.resolve(a,d)})}function h(a){var b=a&&a.then;if(a&&("object"==typeof a||"function"==typeof a)&&"function"==typeof b)return function(){b.apply(a,arguments)}}function i(a,b){function c(b){f||(f=!0,p.reject(a,b))}function d(b){f||(f=!0,p.resolve(a,b))}function e(){b(d,c)}var f=!1,g=j(e);"error"===g.status&&c(g.value)}function j(a,b){var c={};try{c.value=a(b),c.status="success"}catch(a){c.status="error",c.value=a}return c}function k(a){return a instanceof this?a:p.resolve(new this(d),a)}function l(a){var b=new this(d);return p.reject(b,a)}function m(a){function b(a,b){function d(a){g[b]=a,++h!==e||f||(f=!0,p.resolve(j,g))}c.resolve(a).then(d,function(a){f||(f=!0,p.reject(j,a))})}var c=this;if("[object Array]"!==Object.prototype.toString.call(a))return this.reject(new TypeError("must be an array"));var e=a.length,f=!1;if(!e)return this.resolve([]);for(var g=new Array(e),h=0,i=-1,j=new this(d);++i<e;)b(a[i],i);return j}function n(a){function b(a){c.resolve(a).then(function(a){f||(f=!0,p.resolve(h,a))},function(a){f||(f=!0,p.reject(h,a))})}var c=this;if("[object Array]"!==Object.prototype.toString.call(a))return this.reject(new TypeError("must be an array"));var e=a.length,f=!1;if(!e)return this.resolve([]);for(var g=-1,h=new this(d);++g<e;)b(a[g]);return h}var o=a(1),p={},q=["REJECTED"],r=["FULFILLED"],s=["PENDING"];b.exports=e,e.prototype.catch=function(a){return this.then(null,a)},e.prototype.then=function(a,b){if("function"!=typeof a&&this.state===r||"function"!=typeof b&&this.state===q)return this;var c=new this.constructor(d);if(this.state!==s){g(c,this.state===r?a:b,this.outcome)}else this.queue.push(new f(c,a,b));return c},f.prototype.callFulfilled=function(a){p.resolve(this.promise,a)},f.prototype.otherCallFulfilled=function(a){g(this.promise,this.onFulfilled,a)},f.prototype.callRejected=function(a){p.reject(this.promise,a)},f.prototype.otherCallRejected=function(a){g(this.promise,this.onRejected,a)},p.resolve=function(a,b){var c=j(h,b);if("error"===c.status)return p.reject(a,c.value);var d=c.value;if(d)i(a,d);else{a.state=r,a.outcome=b;for(var e=-1,f=a.queue.length;++e<f;)a.queue[e].callFulfilled(b)}return a},p.reject=function(a,b){a.state=q,a.outcome=b;for(var c=-1,d=a.queue.length;++c<d;)a.queue[c].callRejected(b);return a},e.resolve=k,e.reject=l,e.all=m,e.race=n},{1:1}],3:[function(a,b,c){(function(b){"use strict";"function"!=typeof b.Promise&&(b.Promise=a(2))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(a){return}}function f(){try{if(!ua||!ua.open)return!1;var a="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),b="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!a||b)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(a){return!1}}function g(a,b){a=a||[],b=b||{};try{return new Blob(a,b)}catch(f){if("TypeError"!==f.name)throw f;for(var c="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder,d=new c,e=0;e<a.length;e+=1)d.append(a[e]);return d.getBlob(b.type)}}function h(a,b){b&&a.then(function(a){b(null,a)},function(a){b(a)})}function i(a,b,c){"function"==typeof b&&a.then(b),"function"==typeof c&&a.catch(c)}function j(a){return"string"!=typeof a&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function k(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}function l(a){for(var b=a.length,c=new ArrayBuffer(b),d=new Uint8Array(c),e=0;e<b;e++)d[e]=a.charCodeAt(e);return c}function m(a){return new va(function(b){var c=a.transaction(wa,Ba),d=g([""]);c.objectStore(wa).put(d,"key"),c.onabort=function(a){a.preventDefault(),a.stopPropagation(),b(!1)},c.oncomplete=function(){var a=navigator.userAgent.match(/Chrome\/(\d+)/),c=navigator.userAgent.match(/Edge\//);b(c||!a||parseInt(a[1],10)>=43)}}).catch(function(){return!1})}function n(a){return"boolean"==typeof xa?va.resolve(xa):m(a).then(function(a){return xa=a})}function o(a){var b=ya[a.name],c={};c.promise=new va(function(a,b){c.resolve=a,c.reject=b}),b.deferredOperations.push(c),b.dbReady?b.dbReady=b.dbReady.then(function(){return c.promise}):b.dbReady=c.promise}function p(a){var b=ya[a.name],c=b.deferredOperations.pop();if(c)return c.resolve(),c.promise}function q(a,b){var c=ya[a.name],d=c.deferredOperations.pop();if(d)return d.reject(b),d.promise}function r(a,b){return new va(function(c,d){if(ya[a.name]=ya[a.name]||B(),a.db){if(!b)return c(a.db);o(a),a.db.close()}var e=[a.name];b&&e.push(a.version);var f=ua.open.apply(ua,e);b&&(f.onupgradeneeded=function(b){var c=f.result;try{c.createObjectStore(a.storeName),b.oldVersion<=1&&c.createObjectStore(wa)}catch(c){if("ConstraintError"!==c.name)throw c;console.warn('The database "'+a.name+'" has been upgraded from version '+b.oldVersion+" to version "+b.newVersion+', but the storage "'+a.storeName+'" already exists.')}}),f.onerror=function(a){a.preventDefault(),d(f.error)},f.onsuccess=function(){var b=f.result;b.onversionchange=function(a){a.target.close()},c(b),p(a)}})}function s(a){return r(a,!1)}function t(a){return r(a,!0)}function u(a,b){if(!a.db)return!0;var c=!a.db.objectStoreNames.contains(a.storeName),d=a.version<a.db.version,e=a.version>a.db.version;if(d&&(a.version!==b&&console.warn('The database "'+a.name+"\" can't be downgraded from version "+a.db.version+" to version "+a.version+"."),a.version=a.db.version),e||c){if(c){var f=a.db.version+1;f>a.version&&(a.version=f)}return!0}return!1}function v(a){return new va(function(b,c){var d=new FileReader;d.onerror=c,d.onloadend=function(c){var d=btoa(c.target.result||"");b({__local_forage_encoded_blob:!0,data:d,type:a.type})},d.readAsBinaryString(a)})}function w(a){return g([l(atob(a.data))],{type:a.type})}function x(a){return a&&a.__local_forage_encoded_blob}function y(a){var b=this,c=b._initReady().then(function(){var a=ya[b._dbInfo.name];if(a&&a.dbReady)return a.dbReady});return i(c,a,a),c}function z(a){o(a);for(var b=ya[a.name],c=b.forages,d=0;d<c.length;d++){var e=c[d];e._dbInfo.db&&(e._dbInfo.db.close(),e._dbInfo.db=null)}return a.db=null,s(a).then(function(b){return a.db=b,u(a)?t(a):b}).then(function(d){a.db=b.db=d;for(var e=0;e<c.length;e++)c[e]._dbInfo.db=d}).catch(function(b){throw q(a,b),b})}function A(a,b,c,d){void 0===d&&(d=1);try{var e=a.db.transaction(a.storeName,b);c(null,e)}catch(e){if(d>0&&(!a.db||"InvalidStateError"===e.name||"NotFoundError"===e.name))return va.resolve().then(function(){if(!a.db||"NotFoundError"===e.name&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),t(a)}).then(function(){return z(a).then(function(){A(a,b,c,d-1)})}).catch(c);c(e)}}function B(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function C(a){function b(){return va.resolve()}var c=this,d={db:null};if(a)for(var e in a)d[e]=a[e];var f=ya[d.name];f||(f=B(),ya[d.name]=f),f.forages.push(c),c._initReady||(c._initReady=c.ready,c.ready=y);for(var g=[],h=0;h<f.forages.length;h++){var i=f.forages[h];i!==c&&g.push(i._initReady().catch(b))}var j=f.forages.slice(0);return va.all(g).then(function(){return d.db=f.db,s(d)}).then(function(a){return d.db=a,u(d,c._defaultConfig.version)?t(d):a}).then(function(a){d.db=f.db=a,c._dbInfo=d;for(var b=0;b<j.length;b++){var e=j[b];e!==c&&(e._dbInfo.db=d.db,e._dbInfo.version=d.version)}})}function D(a,b){var c=this;a=j(a);var d=new va(function(b,d){c.ready().then(function(){A(c._dbInfo,Aa,function(e,f){if(e)return d(e);try{var g=f.objectStore(c._dbInfo.storeName),h=g.get(a);h.onsuccess=function(){var a=h.result;void 0===a&&(a=null),x(a)&&(a=w(a)),b(a)},h.onerror=function(){d(h.error)}}catch(a){d(a)}})}).catch(d)});return h(d,b),d}function E(a,b){var c=this,d=new va(function(b,d){c.ready().then(function(){A(c._dbInfo,Aa,function(e,f){if(e)return d(e);try{var g=f.objectStore(c._dbInfo.storeName),h=g.openCursor(),i=1;h.onsuccess=function(){var c=h.result;if(c){var d=c.value;x(d)&&(d=w(d));var e=a(d,c.key,i++);void 0!==e?b(e):c.continue()}else b()},h.onerror=function(){d(h.error)}}catch(a){d(a)}})}).catch(d)});return h(d,b),d}function F(a,b,c){var d=this;a=j(a);var e=new va(function(c,e){var f;d.ready().then(function(){return f=d._dbInfo,"[object Blob]"===za.call(b)?n(f.db).then(function(a){return a?b:v(b)}):b}).then(function(b){A(d._dbInfo,Ba,function(f,g){if(f)return e(f);try{var h=g.objectStore(d._dbInfo.storeName);null===b&&(b=void 0);var i=h.put(b,a);g.oncomplete=function(){void 0===b&&(b=null),c(b)},g.onabort=g.onerror=function(){var a=i.error?i.error:i.transaction.error;e(a)}}catch(a){e(a)}})}).catch(e)});return h(e,c),e}function G(a,b){var c=this;a=j(a);var d=new va(function(b,d){c.ready().then(function(){A(c._dbInfo,Ba,function(e,f){if(e)return d(e);try{var g=f.objectStore(c._dbInfo.storeName),h=g.delete(a);f.oncomplete=function(){b()},f.onerror=function(){d(h.error)},f.onabort=function(){var a=h.error?h.error:h.transaction.error;d(a)}}catch(a){d(a)}})}).catch(d)});return h(d,b),d}function H(a){var b=this,c=new va(function(a,c){b.ready().then(function(){A(b._dbInfo,Ba,function(d,e){if(d)return c(d);try{var f=e.objectStore(b._dbInfo.storeName),g=f.clear();e.oncomplete=function(){a()},e.onabort=e.onerror=function(){var a=g.error?g.error:g.transaction.error;c(a)}}catch(a){c(a)}})}).catch(c)});return h(c,a),c}function I(a){var b=this,c=new va(function(a,c){b.ready().then(function(){A(b._dbInfo,Aa,function(d,e){if(d)return c(d);try{var f=e.objectStore(b._dbInfo.storeName),g=f.count();g.onsuccess=function(){a(g.result)},g.onerror=function(){c(g.error)}}catch(a){c(a)}})}).catch(c)});return h(c,a),c}function J(a,b){var c=this,d=new va(function(b,d){if(a<0)return void b(null);c.ready().then(function(){A(c._dbInfo,Aa,function(e,f){if(e)return d(e);try{var g=f.objectStore(c._dbInfo.storeName),h=!1,i=g.openKeyCursor();i.onsuccess=function(){var c=i.result;if(!c)return void b(null);0===a?b(c.key):h?b(c.key):(h=!0,c.advance(a))},i.onerror=function(){d(i.error)}}catch(a){d(a)}})}).catch(d)});return h(d,b),d}function K(a){var b=this,c=new va(function(a,c){b.ready().then(function(){A(b._dbInfo,Aa,function(d,e){if(d)return c(d);try{var f=e.objectStore(b._dbInfo.storeName),g=f.openKeyCursor(),h=[];g.onsuccess=function(){var b=g.result;if(!b)return void a(h);h.push(b.key),b.continue()},g.onerror=function(){c(g.error)}}catch(a){c(a)}})}).catch(c)});return h(c,a),c}function L(a,b){b=k.apply(this,arguments);var c=this.config();a="function"!=typeof a&&a||{},a.name||(a.name=a.name||c.name,a.storeName=a.storeName||c.storeName);var d,e=this;if(a.name){var f=a.name===c.name&&e._dbInfo.db,g=f?va.resolve(e._dbInfo.db):s(a).then(function(b){var c=ya[a.name],d=c.forages;c.db=b;for(var e=0;e<d.length;e++)d[e]._dbInfo.db=b;return b});d=a.storeName?g.then(function(b){if(b.objectStoreNames.contains(a.storeName)){var c=b.version+1;o(a);var d=ya[a.name],e=d.forages;b.close();for(var f=0;f<e.length;f++){var g=e[f];g._dbInfo.db=null,g._dbInfo.version=c}return new va(function(b,d){var e=ua.open(a.name,c);e.onerror=function(a){e.result.close(),d(a)},e.onupgradeneeded=function(){e.result.deleteObjectStore(a.storeName)},e.onsuccess=function(){var a=e.result;a.close(),b(a)}}).then(function(a){d.db=a;for(var b=0;b<e.length;b++){var c=e[b];c._dbInfo.db=a,p(c._dbInfo)}}).catch(function(b){throw(q(a,b)||va.resolve()).catch(function(){}),b})}}):g.then(function(b){o(a);var c=ya[a.name],d=c.forages;b.close();for(var e=0;e<d.length;e++){d[e]._dbInfo.db=null}return new va(function(b,c){var d=ua.deleteDatabase(a.name);d.onerror=function(){var a=d.result;a&&a.close(),c(d.error)},d.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},d.onsuccess=function(){var a=d.result;a&&a.close(),b(a)}}).then(function(a){c.db=a;for(var b=0;b<d.length;b++)p(d[b]._dbInfo)}).catch(function(b){throw(q(a,b)||va.resolve()).catch(function(){}),b})})}else d=va.reject("Invalid arguments");return h(d,b),d}function M(){return"function"==typeof openDatabase}function N(a){var b,c,d,e,f,g=.75*a.length,h=a.length,i=0;"="===a[a.length-1]&&(g--,"="===a[a.length-2]&&g--);var j=new ArrayBuffer(g),k=new Uint8Array(j);for(b=0;b<h;b+=4)c=Da.indexOf(a[b]),d=Da.indexOf(a[b+1]),e=Da.indexOf(a[b+2]),f=Da.indexOf(a[b+3]),k[i++]=c<<2|d>>4,k[i++]=(15&d)<<4|e>>2,k[i++]=(3&e)<<6|63&f;return j}function O(a){var b,c=new Uint8Array(a),d="";for(b=0;b<c.length;b+=3)d+=Da[c[b]>>2],d+=Da[(3&c[b])<<4|c[b+1]>>4],d+=Da[(15&c[b+1])<<2|c[b+2]>>6],d+=Da[63&c[b+2]];return c.length%3==2?d=d.substring(0,d.length-1)+"=":c.length%3==1&&(d=d.substring(0,d.length-2)+"=="),d}function P(a,b){var c="";if(a&&(c=Ua.call(a)),a&&("[object ArrayBuffer]"===c||a.buffer&&"[object ArrayBuffer]"===Ua.call(a.buffer))){var d,e=Ga;a instanceof ArrayBuffer?(d=a,e+=Ia):(d=a.buffer,"[object Int8Array]"===c?e+=Ka:"[object Uint8Array]"===c?e+=La:"[object Uint8ClampedArray]"===c?e+=Ma:"[object Int16Array]"===c?e+=Na:"[object Uint16Array]"===c?e+=Pa:"[object Int32Array]"===c?e+=Oa:"[object Uint32Array]"===c?e+=Qa:"[object Float32Array]"===c?e+=Ra:"[object Float64Array]"===c?e+=Sa:b(new Error("Failed to get type for BinaryArray"))),b(e+O(d))}else if("[object Blob]"===c){var f=new FileReader;f.onload=function(){var c=Ea+a.type+"~"+O(this.result);b(Ga+Ja+c)},f.readAsArrayBuffer(a)}else try{b(JSON.stringify(a))}catch(c){console.error("Couldn't convert value into a JSON string: ",a),b(null,c)}}function Q(a){if(a.substring(0,Ha)!==Ga)return JSON.parse(a);var b,c=a.substring(Ta),d=a.substring(Ha,Ta);if(d===Ja&&Fa.test(c)){var e=c.match(Fa);b=e[1],c=c.substring(e[0].length)}var f=N(c);switch(d){case Ia:return f;case Ja:return g([f],{type:b});case Ka:return new Int8Array(f);case La:return new Uint8Array(f);case Ma:return new Uint8ClampedArray(f);case Na:return new Int16Array(f);case Pa:return new Uint16Array(f);case Oa:return new Int32Array(f);case Qa:return new Uint32Array(f);case Ra:return new Float32Array(f);case Sa:return new Float64Array(f);default:throw new Error("Unkown type: "+d)}}function R(a,b,c,d){a.executeSql("CREATE TABLE IF NOT EXISTS "+b.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],c,d)}function S(a){var b=this,c={db:null};if(a)for(var d in a)c[d]="string"!=typeof a[d]?a[d].toString():a[d];var e=new va(function(a,d){try{c.db=openDatabase(c.name,String(c.version),c.description,c.size)}catch(a){return d(a)}c.db.transaction(function(e){R(e,c,function(){b._dbInfo=c,a()},function(a,b){d(b)})},d)});return c.serializer=Va,e}function T(a,b,c,d,e,f){a.executeSql(c,d,e,function(a,g){g.code===g.SYNTAX_ERR?a.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[b.storeName],function(a,h){h.rows.length?f(a,g):R(a,b,function(){a.executeSql(c,d,e,f)},f)},f):f(a,g)},f)}function U(a,b){var c=this;a=j(a);var d=new va(function(b,d){c.ready().then(function(){var e=c._dbInfo;e.db.transaction(function(c){T(c,e,"SELECT * FROM "+e.storeName+" WHERE key = ? LIMIT 1",[a],function(a,c){var d=c.rows.length?c.rows.item(0).value:null;d&&(d=e.serializer.deserialize(d)),b(d)},function(a,b){d(b)})})}).catch(d)});return h(d,b),d}function V(a,b){var c=this,d=new va(function(b,d){c.ready().then(function(){var e=c._dbInfo;e.db.transaction(function(c){T(c,e,"SELECT * FROM "+e.storeName,[],function(c,d){for(var f=d.rows,g=f.length,h=0;h<g;h++){var i=f.item(h),j=i.value;if(j&&(j=e.serializer.deserialize(j)),void 0!==(j=a(j,i.key,h+1)))return void b(j)}b()},function(a,b){d(b)})})}).catch(d)});return h(d,b),d}function W(a,b,c,d){var e=this;a=j(a);var f=new va(function(f,g){e.ready().then(function(){void 0===b&&(b=null);var h=b,i=e._dbInfo;i.serializer.serialize(b,function(b,j){j?g(j):i.db.transaction(function(c){T(c,i,"INSERT OR REPLACE INTO "+i.storeName+" (key, value) VALUES (?, ?)",[a,b],function(){f(h)},function(a,b){g(b)})},function(b){if(b.code===b.QUOTA_ERR){if(d>0)return void f(W.apply(e,[a,h,c,d-1]));g(b)}})})}).catch(g)});return h(f,c),f}function X(a,b,c){return W.apply(this,[a,b,c,1])}function Y(a,b){var c=this;a=j(a);var d=new va(function(b,d){c.ready().then(function(){var e=c._dbInfo;e.db.transaction(function(c){T(c,e,"DELETE FROM "+e.storeName+" WHERE key = ?",[a],function(){b()},function(a,b){d(b)})})}).catch(d)});return h(d,b),d}function Z(a){var b=this,c=new va(function(a,c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){T(b,d,"DELETE FROM "+d.storeName,[],function(){a()},function(a,b){c(b)})})}).catch(c)});return h(c,a),c}function $(a){var b=this,c=new va(function(a,c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){T(b,d,"SELECT COUNT(key) as c FROM "+d.storeName,[],function(b,c){var d=c.rows.item(0).c;a(d)},function(a,b){c(b)})})}).catch(c)});return h(c,a),c}function _(a,b){var c=this,d=new va(function(b,d){c.ready().then(function(){var e=c._dbInfo;e.db.transaction(function(c){T(c,e,"SELECT key FROM "+e.storeName+" WHERE id = ? LIMIT 1",[a+1],function(a,c){var d=c.rows.length?c.rows.item(0).key:null;b(d)},function(a,b){d(b)})})}).catch(d)});return h(d,b),d}function aa(a){var b=this,c=new va(function(a,c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){T(b,d,"SELECT key FROM "+d.storeName,[],function(b,c){for(var d=[],e=0;e<c.rows.length;e++)d.push(c.rows.item(e).key);a(d)},function(a,b){c(b)})})}).catch(c)});return h(c,a),c}function ba(a){return new va(function(b,c){a.transaction(function(d){d.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(c,d){for(var e=[],f=0;f<d.rows.length;f++)e.push(d.rows.item(f).name);b({db:a,storeNames:e})},function(a,b){c(b)})},function(a){c(a)})})}function ca(a,b){b=k.apply(this,arguments);var c=this.config();a="function"!=typeof a&&a||{},a.name||(a.name=a.name||c.name,a.storeName=a.storeName||c.storeName);var d,e=this;return d=a.name?new va(function(b){var d;d=a.name===c.name?e._dbInfo.db:openDatabase(a.name,"","",0),b(a.storeName?{db:d,storeNames:[a.storeName]}:ba(d))}).then(function(a){return new va(function(b,c){a.db.transaction(function(d){function e(a){return new va(function(b,c){d.executeSql("DROP TABLE IF EXISTS "+a,[],function(){b()},function(a,b){c(b)})})}for(var f=[],g=0,h=a.storeNames.length;g<h;g++)f.push(e(a.storeNames[g]));va.all(f).then(function(){b()}).catch(function(a){c(a)})},function(a){c(a)})})}):va.reject("Invalid arguments"),h(d,b),d}function da(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(a){return!1}}function ea(a,b){var c=a.name+"/";return a.storeName!==b.storeName&&(c+=a.storeName+"/"),c}function fa(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch(a){return!0}}function ga(){return!fa()||localStorage.length>0}function ha(a){var b=this,c={};if(a)for(var d in a)c[d]=a[d];return c.keyPrefix=ea(a,b._defaultConfig),ga()?(b._dbInfo=c,c.serializer=Va,va.resolve()):va.reject()}function ia(a){var b=this,c=b.ready().then(function(){for(var a=b._dbInfo.keyPrefix,c=localStorage.length-1;c>=0;c--){var d=localStorage.key(c);0===d.indexOf(a)&&localStorage.removeItem(d)}});return h(c,a),c}function ja(a,b){var c=this;a=j(a);var d=c.ready().then(function(){var b=c._dbInfo,d=localStorage.getItem(b.keyPrefix+a);return d&&(d=b.serializer.deserialize(d)),d});return h(d,b),d}function ka(a,b){var c=this,d=c.ready().then(function(){for(var b=c._dbInfo,d=b.keyPrefix,e=d.length,f=localStorage.length,g=1,h=0;h<f;h++){var i=localStorage.key(h);if(0===i.indexOf(d)){var j=localStorage.getItem(i);if(j&&(j=b.serializer.deserialize(j)),void 0!==(j=a(j,i.substring(e),g++)))return j}}});return h(d,b),d}function la(a,b){var c=this,d=c.ready().then(function(){var b,d=c._dbInfo;try{b=localStorage.key(a)}catch(a){b=null}return b&&(b=b.substring(d.keyPrefix.length)),b});return h(d,b),d}function ma(a){var b=this,c=b.ready().then(function(){for(var a=b._dbInfo,c=localStorage.length,d=[],e=0;e<c;e++){var f=localStorage.key(e);0===f.indexOf(a.keyPrefix)&&d.push(f.substring(a.keyPrefix.length))}return d});return h(c,a),c}function na(a){var b=this,c=b.keys().then(function(a){return a.length});return h(c,a),c}function oa(a,b){var c=this;a=j(a);var d=c.ready().then(function(){var b=c._dbInfo;localStorage.removeItem(b.keyPrefix+a)});return h(d,b),d}function pa(a,b,c){var d=this;a=j(a);var e=d.ready().then(function(){void 0===b&&(b=null);var c=b;return new va(function(e,f){var g=d._dbInfo;g.serializer.serialize(b,function(b,d){if(d)f(d);else try{localStorage.setItem(g.keyPrefix+a,b),e(c)}catch(a){"QuotaExceededError"!==a.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==a.name||f(a),f(a)}})})});return h(e,c),e}function qa(a,b){if(b=k.apply(this,arguments),a="function"!=typeof a&&a||{},!a.name){var c=this.config();a.name=a.name||c.name,a.storeName=a.storeName||c.storeName}var d,e=this;return d=a.name?new va(function(b){b(a.storeName?ea(a,e._defaultConfig):a.name+"/")}).then(function(a){for(var b=localStorage.length-1;b>=0;b--){var c=localStorage.key(b);0===c.indexOf(a)&&localStorage.removeItem(c)}}):va.reject("Invalid arguments"),h(d,b),d}function ra(a,b){a[b]=function(){var c=arguments;return a.ready().then(function(){return a[b].apply(a,c)})}}function sa(){for(var a=1;a<arguments.length;a++){var b=arguments[a];if(b)for(var c in b)b.hasOwnProperty(c)&&($a(b[c])?arguments[0][c]=b[c].slice():arguments[0][c]=b[c])}return arguments[0]}var ta="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},ua=e();"undefined"==typeof Promise&&a(3);var va=Promise,wa="local-forage-detect-blob-support",xa=void 0,ya={},za=Object.prototype.toString,Aa="readonly",Ba="readwrite",Ca={_driver:"asyncStorage",_initStorage:C,_support:f(),iterate:E,getItem:D,setItem:F,removeItem:G,clear:H,length:I,key:J,keys:K,dropInstance:L},Da="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ea="~~local_forage_type~",Fa=/^~~local_forage_type~([^~]+)~/,Ga="__lfsc__:",Ha=Ga.length,Ia="arbf",Ja="blob",Ka="si08",La="ui08",Ma="uic8",Na="si16",Oa="si32",Pa="ur16",Qa="ui32",Ra="fl32",Sa="fl64",Ta=Ha+Ia.length,Ua=Object.prototype.toString,Va={serialize:P,deserialize:Q,stringToBuffer:N,bufferToString:O},Wa={_driver:"webSQLStorage",_initStorage:S,_support:M(),iterate:V,getItem:U,setItem:X,removeItem:Y,clear:Z,length:$,key:_,keys:aa,dropInstance:ca},Xa={_driver:"localStorageWrapper",_initStorage:ha,_support:da(),iterate:ka,getItem:ja,setItem:pa,removeItem:oa,clear:ia,length:na,key:la,keys:ma,dropInstance:qa},Ya=function(a,b){return a===b||"number"==typeof a&&"number"==typeof b&&isNaN(a)&&isNaN(b)},Za=function(a,b){for(var c=a.length,d=0;d<c;){if(Ya(a[d],b))return!0;d++}return!1},$a=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},_a={},ab={},bb={INDEXEDDB:Ca,WEBSQL:Wa,LOCALSTORAGE:Xa},cb=[bb.INDEXEDDB._driver,bb.WEBSQL._driver,bb.LOCALSTORAGE._driver],db=["dropInstance"],eb=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(db),fb={description:"",driver:cb.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},gb=function(){function a(b){d(this,a);for(var c in bb)if(bb.hasOwnProperty(c)){var e=bb[c],f=e._driver;this[c]=f,_a[f]||this.defineDriver(e)}this._defaultConfig=sa({},fb),this._config=sa({},this._defaultConfig,b),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(a){if("object"===(void 0===a?"undefined":ta(a))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var b in a){if("storeName"===b&&(a[b]=a[b].replace(/\W/g,"_")),"version"===b&&"number"!=typeof a[b])return new Error("Database version must be a number.");this._config[b]=a[b]}return!("driver"in a&&a.driver)||this.setDriver(this._config.driver)}return"string"==typeof a?this._config[a]:this._config},a.prototype.defineDriver=function(a,b,c){var d=new va(function(b,c){try{var d=a._driver,e=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!a._driver)return void c(e);for(var f=eb.concat("_initStorage"),g=0,i=f.length;g<i;g++){var j=f[g];if((!Za(db,j)||a[j])&&"function"!=typeof a[j])return void c(e)}(function(){for(var b=function(a){return function(){var b=new Error("Method "+a+" is not implemented by the current driver"),c=va.reject(b);return h(c,arguments[arguments.length-1]),c}},c=0,d=db.length;c<d;c++){var e=db[c];a[e]||(a[e]=b(e))}})();var k=function(c){_a[d]&&console.info("Redefining LocalForage driver: "+d),_a[d]=a,ab[d]=c,b()};"_support"in a?a._support&&"function"==typeof a._support?a._support().then(k,c):k(!!a._support):k(!0)}catch(a){c(a)}});return i(d,b,c),d},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(a,b,c){var d=_a[a]?va.resolve(_a[a]):va.reject(new Error("Driver not found."));return i(d,b,c),d},a.prototype.getSerializer=function(a){var b=va.resolve(Va);return i(b,a),b},a.prototype.ready=function(a){var b=this,c=b._driverSet.then(function(){return null===b._ready&&(b._ready=b._initDriver()),b._ready});return i(c,a,a),c},a.prototype.setDriver=function(a,b,c){function d(){g._config.driver=g.driver()}function e(a){return g._extend(a),d(),g._ready=g._initStorage(g._config),g._ready}function f(a){return function(){function b(){for(;c<a.length;){var f=a[c];return c++,g._dbInfo=null,g._ready=null,g.getDriver(f).then(e).catch(b)}d();var h=new Error("No available storage method found.");return g._driverSet=va.reject(h),g._driverSet}var c=0;return b()}}var g=this;$a(a)||(a=[a]);var h=this._getSupportedDrivers(a),j=null!==this._driverSet?this._driverSet.catch(function(){return va.resolve()}):va.resolve();return this._driverSet=j.then(function(){var a=h[0];return g._dbInfo=null,g._ready=null,g.getDriver(a).then(function(a){g._driver=a._driver,d(),g._wrapLibraryMethodsWithReady(),g._initDriver=f(h)})}).catch(function(){d();var a=new Error("No available storage method found.");return g._driverSet=va.reject(a),g._driverSet}),i(this._driverSet,b,c),this._driverSet},a.prototype.supports=function(a){return!!ab[a]},a.prototype._extend=function(a){sa(this,a)},a.prototype._getSupportedDrivers=function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=a[c];this.supports(e)&&b.push(e)}return b},a.prototype._wrapLibraryMethodsWithReady=function(){for(var a=0,b=eb.length;a<b;a++)ra(this,eb[a])},a.prototype.createInstance=function(b){return new a(b)},a}(),hb=new gb;b.exports=hb},{3:3}]},{},[4])(4)});
if (GmCXt === undefined) var GmCXt = {};
if (!GmCXt.l) GmCXt.l = {};

GmCXt.l.resetAll = function() {
    GmCXt.l.logStack = {};
    GmCXt.l.currentStack = [];
    GmCXt.l.primaryInfo = [];
};

GmCXt.l.reset = function() {
    GmCXt.l.currentStack = [];
    GmCXt.l.logStack[GmCXt.id] = GmCXt.l.currentStack;
    GmCXt.l.primaryInfo = [];
};

GmCXt.l.resetAll();

GmCXt.l.addRCA = function(c, meta) {

    let rca = meta.selectorAttributes;
    if (c.precision_type === GmCXt.DOM_CRITERIA_DEFAULT && rca) {

        let attr = [];

        // Concat arrays from all selectors, i.e. js, js1, js2, etc..
        for (let key in rca) {
            attr = attr.concat(rca[key]);
        }

        // Pick unique
        attr = attr.filter(function(value, index, self) {
            return self.indexOf(value) === index;
        }).sort();

        let logStr = "[RCA] HTML structure appears to have changed since element selection. Check for presence and/or values of HTML attributes: " + attr.join(', ');

        if (c.ignoreText) {
            logStr += "\nAlso, could not find text: " + meta.textPropertyValue;
        }
        GmCXt.l.add(logStr, true);

    } else if (c.precision_type === GmCXt.DOM_CRITERIA_CUSTOM) {
        GmCXt.l.add("[RCA] Could not find element by the user provided jQuery selector", true);
    }
};

GmCXt.l.start = function(type, identifier, params, isPrimary) {

    var obj = {
        'calls': [],
        'identifier': type + '_' + identifier
    };

    if (params) {
        obj.params = params;
    }

    if (GmCXt.l.currentStack.length) {

        GmCXt.l.add('START: ' + type + '  ' + identifier, isPrimary);

        GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].calls.push(obj);
    }
    GmCXt.l.currentStack.push(obj);
};

GmCXt.l.end = function(returnValue) {

    if (returnValue) {
        GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].returnValue = returnValue;
    }

    if (returnValue === null || (typeof returnValue === 'object' && returnValue.he === null)) {
        GmCXt.l.add('null value returned by: ' + GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].identifier);
    }

    if (GmCXt.l.currentStack.length > 1) {
        GmCXt.l.currentStack.pop();
    }
};

GmCXt.l.return = function(val) {
    GmCXt.l.end(val);
    return val;
};

GmCXt.l.add = function(message, isPrimary) {

    if (!GmCXt.isEmpty(GmCXt.l.currentStack)) {
        if (GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1]) {
            if (!GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].log) {
                GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].log = [message];
            } else {
                GmCXt.l.currentStack[GmCXt.l.currentStack.length - 1].log.push(message);
            }
        }

        if (isPrimary) {
            GmCXt.l.primaryInfo.push(message);
        }
    }
};

GmCXt.l.getPrimaryLogs = function() {
    return GmCXt.l.primaryInfo;
};

GmCXt.l.getLogStack = function() {

    if (Object.keys(GmCXt.l.logStack).length === 1) {
        return GmCXt.l.currentStack[0];
    }
    return GmCXt.l.logStack;
};

GmCXt.getDebugOptions = function() {
    return {
        1: "Global",
        2: "Page tracking",
        3: "Messages",
        5: "Rules engine",
        6: "Rules engine (Detailed)",
        8: "MyGuide widget",
        10: "Notification",
        12: "Matching algorithm",
        15: "API",
        16: "Features tags",
        17: "Features tags matching",
        21: "Initialisation",
        24: "LXP",
        27: "Workflow Insights",
        28: "Workflow Insights (Detailed)",
        30: "Current Page",
        33: "Workflow guide player",
        36: "Test automation",
        37: "Test automation (Detailed)",
        38: "QA Automator",
        39: "Onboarding guide",
        42: "Tooltips",
        43: "Tooltips (Detailed)",
        45: "Analytics",
        48: "Beacons",
        49: "Beacons (Detailed)",
        51: "Export tasks",
        54: "Step create/edit",
        57: "Click tracking",
        58: "Test Me",
        61: "Creator background sync",
        63: "Precedence",
        67: "Variables",
        68: "Segment Validation",
        70: "Player Background Sync",
        74: "Desktop Creator"
    };
};

GmCXt.getDebugColor = function(m) {
    let colors = {
        1: "",
        2: "#fd5e53",
        3: "#ff0066",
        5: "#21bf73",
        6: "#192965",
        8: "#faafff",
        10: "#d15a7c",
        12: "#af460f",
        15: "#ffb677",
        21: "#40bfc1",
        24: "#0f4c75",
        27: "#3029f2", // Same for 28
        30: "#52de97",
        33: "#07b513",
        36: "#8cba51",
        39: "#fe8761",
        42: "#1c819e", // Same for 43
        45: "#d89cf6",
        48: "#eb8242", // Same for 49
        51: "#9dab86",
        54: "#5f6caf",
        57: "#4681ec",
        58: "#0097a7",
        63: "#ff1a8c",
        67: "#e3564f",
        61: "#ff0066",
        70: "#ff0066",
        74: "#6600cc"
    };

    if (colors[m]) return colors[m];
    else if (colors[m - 1]) return colors[m - 1];
    else return "#010038";
};

GmCXt.debugHelp = function() {
    let str = "Debug logs are feature wise. " +
		"You can enable logs for upto 3 features at a time. Every feature logs come in different colors. " +
		"E.g. Workflow guide logs are colored in blue, while Rules engine logs are colored in yellow. ";

    console.log(str);

    console.log("Call 'GmCXt.debug(op1, op2, op3)' to enable. Where op1, op2, op3 are debug options. E.g. Call 'GmCXt.debug(1)' for global logs. 'GmCXt.debug(33, 27, 54)' for Workflow guide and Rules engine and Matching algo.");
    console.log("Call 'GmCXt.debugStop()' to disable.");	

    console.log("Call 'GmCXt.logElTracker()'  To log matching algo calls counter.");	
    console.log("Call 'GmCXt.resetElTracker()'  To reset counter to zero.");	

    console.log("Filter logs using 'Gm' to see only MyGuide logs.");

    console.log("Debug features list", GmCXt.getDebugOptions());
	
    console.log("ALWAYS remember to disable after use.");
};

GmCXt.getDebugKey = function() {
    return GmCXt.storagePrefix + 'debugMode';
};

GmCXt.initDebugMode = function() {
    GmCXt.debugMode = localStorage.getItem(GmCXt.getDebugKey());
    if (GmCXt.debugMode) {
        GmCXt.debugMode = GmCXt.debugMode.split('"').join('');
    }
    GmCXt.updateDebugMode(GmCXt.debugMode);
};

GmCXt.updateDebugMode = function(mode) {
    GmCXt.debugMode = mode;

    if (!GmCXt.isBackgroundPage) {
        let m = {
            debugMode: GmCXt.debugMode
        };

        if (GmCXt.isDefined(GmCXt.sendMessageToAllWindows)) {
            GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:update_debug_mode", m);
        }

        GmCXt.sendMessageToBackgroundService({
            action: 'mgPlayerJSProd_action:update_debug_mode',
            data: m
        });
    }
};

GmCXt.debugStop = function() {

    if (!GmCXt.isBackgroundPage) {
        localStorage.removeItem(GmCXt.storagePrefix + 'debugMode');
    }
    GmCXt.updateDebugMode('');

    return "Logs disabled";
};

GmCXt.debug = function(m1, m2, m3) {

    let modes = GmCXt.getDebugOptions();
    let str = "";
    let mode = "";
    let invalid = "";

    if (m1) {
        if (!modes.hasOwnProperty(m1)) {
            invalid += m1;
        } else {
            mode += m1;
            str += modes[m1];
        }
    }

    if (m2) {
        if (!modes.hasOwnProperty(m2)) {
            invalid += "," + m2;
        } else {
            mode += ":" + m2;
            str += ", " + modes[m2];
        }
    }

    if (m3) {
        if (!modes.hasOwnProperty(m3)) {
            invalid += "," + m3;
        } else {
            mode += ":" + m3;
            str += ", " + modes[m3];
        }
    }

    if (invalid) {
        return 'Invalid debug mode: ' + invalid;

    } else if (mode) {

        if (!GmCXt.isBackgroundPage) {
            localStorage.setItem(GmCXt.storagePrefix + 'debugMode', mode);
        }

        GmCXt.updateDebugMode(mode);

        return "Logs enabled: " + str;
    } else {
        return "Please provide debug mode";
    }
};

GmCXt.showLogs = function(m) {

    if (!GmCXt.debugMode)
        return false;

    if (m === 1)
        return true;

    let modes = (GmCXt.debugMode + "").split(":");
    let m1 = m + 1;

    if (modes.indexOf(m + "") !== -1 || modes.indexOf(m1 + "") !== -1)
        return true;

    return false;
};

GmCXt.updateLogMetadata = function(str) {

    if (GmCXt.id)
        str = str + " [" + GmCXt.id + "]";

    return str + "[" + GmCXt.logtime() + "]";
};

GmCXt.log = function(mode, str, opt) {
    if (GmCXt.showLogs(mode)) {
        GmCXt.printLog(mode, str, opt);
    }
};

GmCXt.sendMessageToPrintLog = function(m, s, o) {
    let data= {
        mode: m,
        str: s,
        opt: o
    };
    GmCXt.requestHandler.printDebugLog(data);
};

GmCXt.printLog = function(mode, str, opt) {

    let css = "color:" + GmCXt.getDebugColor(mode) + ";";
    let data = null;

    if (mode === 1 || opt === 1) {
        css += 'font-weight: bold;';
    }
    // opt is either bold or data object to print
    if (opt !== 1) {
        data = opt;
    }

    str = GmCXt.updateLogMetadata(str);
    str = '%c' + str;

    if (data)
        console.log(str, css, GmCXt.createDeepCopy(data));
    else
        console.log(str, css);
};

GmCXt.logArrayProp = function(mode, tours, prop) {
    if (GmCXt.showLogs(mode)) {
        for (let i = 0, len = tours.length; i < len; i++) {
            let str = (i + 1) + ") " + tours[i][prop];
            str = GmCXt.updateLogMetadata(str);
            str = '%c' + str;

            let css = "color:" + GmCXt.getDebugColor(mode) + ";";
            console.log(str, css);
        }
    }
};

GmCXt.logtime = function() {
    return (Date.now() + "").substring(7);
};

GmCXt.printMatchingAlgoLogs = function() {

    GmCXt.log(12, "Detailed logs", GmCXt.l.getLogStack());
    GmCXt.log(12, "Primary debug info", {
        logs: GmCXt.l.getPrimaryLogs()
    });
};

GmCXt.primaryErrorReport = function() {
    let str = GmCXt.l.primaryInfo.join("<br>");
    return str;
};

GmCXt.debugErrorReport = function() {
    //var str = JSON.stringify(GmCXt.l.getLogStack());
    //return str;
};
/*global mg$*/
GmCXt.sendMessageToAllWindows = function(type, data, directCall) {
    var data = mg$.extend({}, data || {});
    let iframeIdentifier;

    if (GmCXt.syncPlayerInst(type)) {
        if (GmCXt.playerI || GmCXt.playerI === null) {
            data.playerInstance = GmCXt.playerI;
        }
    }

    if (GmCXt.syncCreateInst(type)) {
        if (GmCXt.stepReq || GmCXt.stepReq === null) {
            data.stepReq = GmCXt.stepReq;
        }
    }

    if (type !== "mgPlayerJSProd_action:clear_rule_jobs" || type !== "mgPlayerJSProd_action:remove_tooltip") {
        data.user = GmCXt.user;
        data.organization = GmCXt.organization;
    }

    let message = {
        action: type,
        data: data
    };

    if (message.data) {
        let f = {};
        message.data.frame = mg$.extend({}, f);
    }

    if (GmCXt.inTopWindow(data.settings)) {

        if (type === "mgPlayerJSProd_action:started;task:select_existing_dom_element") {
            GmCXt.requestHandler.selectExistingDomElement(message.data);
            return;
        }

        if (type === "mgPlayerJSProd_action:started;task:edit_step_select_existing_dom_element") {
            GmCXt.requestHandler.selectDomElementEditStep(message);
            return;
        }

        if (type === "mgPlayerJSProd_action:started;task:edit_tag_select_existing_dom_element") {
            GmCXt.requestHandler.selectDomElementEditTag(message);
            return;
        }

        if (type === "mgPlayerJSProd_action:started;task:select_dom_element_tooltips") {
            GmCXt.requestHandler.selectDomElement(message);
            return;
        }

        if (type === "mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element") {
            GmCXt.selectorTool = null;
            GmCXt.requestHandler.selectDomElementBeaconEdit(message);
            return;
        }

        if (type === "mgPlayerJSProd_action:started;task:search_next_step") {
            GmCXt.requestHandler.searchDomElement(message.data);
            return;
        }

    } else if (GmCXt.inTopWindow(data.beaconSettings)) {
        if (type === "mgPlayerJSProd_action:show_beacon_on_dom_element") {
            GmCXt.highlighter.queueBeacon(message);
            return;
        }
    }

    if (type === "mgPlayerJSProd_action:started;task:select_dom_element_for_rules") {

        if (data.rule && data.rule.element && data.rule.element.meta) {
            var el = data.rule.element;

            if (el.meta.inTopWindow === true) {
                GmCXt.requestHandler.findElementToCheckDomRule(data);
                return;
            } else {
                GmCXt.rulesIframeQueue.push(mg$.extend({}, data));
            }
        }
    }

    if (type === "mgPlayerJSProd_action:started;task:select_dom_element_for_matching_in_rules") {
        if (data.element && data.element.meta) {
            var el = data.element;
            if (el.meta.inTopWindow === true) {
                GmCXt.requestHandler.findElementToCheckMatchingAlgo(data);
                return;
            }
        }
    }

    if (type === "mgPlayerJSProd_action:update_session_info") {
        GmCXt.sessionInfo = data.sessionInfo;
    }

    GmCXt.timeout(function() {
        GmCXt.sendToIframes(message, iframeIdentifier);
    }, GmCXt.t.msgToframes);

    if (!iframeIdentifier) GmCXt.msgToThisWin(message);
};

GmCXt.inTopWindow = function(s) {
    if (s) {
        if (s.element) {
            var el = s.element;
        } else if (s.selectedDOMElement) {
            var el = s.selectedDOMElement;
        }

        if (el) {
            if (el.version && GmCXt.decodeVersion(el.version) >= 10000) {
                if (el.meta.inTopWindow === true)
                    return true;
            } else if (el.isTopWindow === true) {
                return true;
            }
        }
    }

    return false;
};

GmCXt.sendToIframes = function(m, targetIframeId) {

    for (let iframeId in GmCXt.iframePorts) {
        if (GmCXt.iframePorts.hasOwnProperty(iframeId)) {

            let frame = GmCXt.iframeEls[iframeId];

            if (m.mgdata && m.mgdata.frame && !GmCXt.isEmpty(m.mgdata.frame)) {
                m.mgdata.frame.iframeTitle = frame.frameElement.getAttribute("title");
                m.mgdata.frame.attributes = GmCXt.getIframeAttributes(mg$(frame));
                m.mgdata.frame.pos = frame.frameElement.getBoundingClientRect();
            }

            // Send to target iframe only, if target iframe ID exists; else send to all iframes
            if (targetIframeId) {
                if (iframeId === targetIframeId) {
                    GmCXt.iframePorts[iframeId].postMessage(GmCXt.formatMsg(m));
                    break;
                }
            } else {
                GmCXt.iframePorts[iframeId].postMessage(GmCXt.formatMsg(m));
            }
        }
    }
};

/**
 * @file Defines string constants for player
 * @author Nilesh Pachpande
 */

if (GmCXt === undefined) var GmCXt = {};
if (GmCXt.playerLbls === undefined) GmCXt.playerLbls = {};


GmCXt.playerLbls.en_US = {
    currentPage: "Current Page",
    myChat: "MyChat",
    import: "Import",
    export: "Export",
    redirectLivetour: "Play Live",
    guideNotAvailable: "Guide not available on current URL. Do you want to go to the Guide URL?",
    downloadPPT: "Download PPT",
    btnYes: "Yes",
    btnNo: "No",
    inApp: "In-App",
    live: "Live",
    resume: "Resume",
    tourCloseConfirm: "Do you really want to close this Guide?",
    notifSnoozeDonotMsg: "Please tell us if you want to watch this later or never show the notification?",
    surveyThanksMessage: "Thanks for providing your response",
    testMePassedMessage: "Congratulations! You Passed",
    testMeFailedMessage: "Oops! You Failed",
    testMeGuideEfficiency: "Test efficiency:",
    testMeGuideEffectiveness: "Test effectiveness:",
    testMeTestTime: "Test Time",
    testMeExpectedTime: "Expected Time",
    testMeStepsTaken: "Steps Taken",
    testMeExpectedSteps: "Expected Steps",
    testMeRetakeTestBtn: "Retake Test",
    testMeResultTitle: "MyTest Result",
    ConfirmIfTestMeModeRidirect: "Guide not available on current URL. Do you want to redirect to the Guide URL?",
    feedCmt: "Your feedback is valuable to us!<br> Please share your thoughts in 500 characters or less",
    doNotShowAgain: "Do not show again",
    neverShowAgain: "Never Show Again",
    skipGuide: "Skip Guide",
    surveyErrorMsg: "Please answer at least one question",
    redirect: "Redirect",
    liveGuide: "Live Guide",
    question: "Question",
    exitGuide: "Exit Guide",
    continueGuide: "Continue Guide",
    stop: "Stop",
    characters: "Characters:",
    survey: "Survey",
    testMeStopMessage: "You are in TestMe mode, click STOP to exit",
    testMeFailedErrorMessage: "You could not reach the goal step.<br>You got {CORRECT_STEPS} steps correct out of {TOTAL_STEPS}.",
    surveyCommentPlaceholder: "Type here! Max 500 characters",
    pushTourSnoozeMsg: "This Auto Launch Tour will be snoozed for",
    of: "of",
    dontShowEdResult: "I don't want to see this",
    mPlayerHeaderTitle: "Micro Player",
    closePreview: "Close Preview",
    elmNotFound: "It seems we can't find the element for the step:",
    elmNotFoundInfo: "Ensure you're on the correct page to play this step. Also check if you can see the selected element",
    notExists: "Not Exists",
    elmNotFoundHeader: "Step element not found",
    goToStep: "Go to step",
    notFoundStep: "We couldn't find the element for step #",
    pleaseReselect: "Please try to reselect the element.",
    stepRuleMatchErr: "Configuration error: Step rules do not match",
    guideRuleMatchErr: "Configuration error: Guide rules do not match",
    stepNotFoundRedirect: "Step not found on this page. Do you wish to redirect?",
    doitForMeWarning: "DoItForMe is not available for image, video and survey steps.",
    branchStepMessagePopup: "Please select one of the tasks below to proceed",
    btnSkip: "Skip",
    kindlyHoverPopup: "Kindly hover over this element to open the popup",
    stepPlayIsdefinedPopover: "The step you are going to play is defined on the popover",
    elmNotFoundWestpac: "Step not found  This Guide will end",
    findingElementMessage: "Trying to find step. . .",
    badDomain: "Current domain and URL are not authorized to run MyGuide. Please contact your Admin for help.",
    hostJsError: "There seems to be an error on webpage. MyGuide cannot continue",
    remember: "Remember Me",
    forgotPass: "Forgot Password?",
    dontHavAcc: "Do not have an account?",
    loginTitle: "Login",
    loginOtpScreenTitle: "Verify OTP to Sign In",
    forgetPassTitl: "Reset Password",
    placeholderEmail: "Email ID",
    placeholderPassword: "Password",
    placeholderNewPassword: "New Password",
    placeholderCurrentPassword: "Current Password",
    placeholderFirstname: "First name",
    placeholderLastname: "Last name",
    placeholderPasswordC: "Confirm Password",
    btnCancel: "Cancel",
    btnPayment: "Upgrade plan",
    btnSubmit: "Submit",
    btnLogin: "Login",
    termsOfUse: "Terms of Use",
    andLabel: "and",
    policyPrivacy: "Privacy Policy",
    passwordError: "Password must be 8 digit long",
    confirmPasswordError: "Password and confirm password must be same",
    firstnameError: "Please enter a valid first name",
    lastnameError: "Please enter a valid last name",
    emailError: "Please enter a valid Email ID",
    orgError: "Please enter a valid Organization URL",
    otpError: "Please enter valid OTP",
    placeholderOtp: "Enter your OTP here",
    otpSentDesc: "If a valid email address has been provided, a reset link will be sent to you.<br>If you do not see the email in a few minutes, please check your spam folder for an email from",
    btnOtpVerify: "Verify OTP",
    alreadyHavAcc: "Already have an account?",
    smartbiteMessageError: "Please enter message",
    smartbiteLinkError: "Please enter a valid link",
    noGuidesOnThisPage: "No Guides Available on this page!",
    clickOn: "Click on ",
    contactUs: "Contact Us",
    search: "Search",
    noRecordFound: "No records found",
    category: "Folder",
    subCategory: "Sub Folder",
    confirmPasswordRequired: "Confirm Password Required",
    logInWithSSO: "Login with SSO",
    inputPlaceHolderSearch: "Search for any Guide",
    noGuideAvailableFor: "No Guide(s) were found to match your search",
    tryModifyingYourSearch: "Try modifying your search criteria",
    signInVerifyYourEmail: "This Email ID has not been verified. Please check your email for details",
    signInVerifyYourAccount: "We have sent you an email with an OTP. Please verify your account to complete the Sign In process",
    maintenanceMessage: "Maintenance in progress. Please contact us via support@csod.com",
    back: "Back",
    changePassword: "Change Password",
    startTestAuto: "Start Automation Testing",
    msgPasswordChangedSuccess: "Your password has been changed successfully. <br><br> Login again to continue.",
    msgConfirmNewPasswordError: "Confirm Password must be the same as New Password",
    enterUrl: 'Enter team URL',
    dragPlaceholderDropThis: "Drop this ",
    dragPlaceholderHere: " here",
    termsOfService: "Terms",
    versionText: "Version",
    videoStepSuccessMessage: "Your step was created successfully",
    importSuccessMessage: "Guide uploaded successfully. Go to Task Status to check import status",
    helpSupport: "Help & Support",
    page: "page",
    selectAnApplication: "Select an Application",
    refresh: "Refresh",
    loginBtn: "Login",
    account: "Account",
    taskStatus: "Task Status",
    logoutBtn: "Logout",
    app: "App:",
    firstStep: "First Step",
    lastStep: "Last Step",
    startTest: "Start Test",
    noInappStepInGuide: "TestMe cannot proceed since there is no inline step in this guide",
    settingBtn: "Advanced Settings",
    orgSetting: "Organization settings",
    close: "Close",
    pdf: "PDF",
    downloadPptx: "PPT",
    giphy: "GIF",
    downloadWord: "Document",
    downloadBlog: "Blog",
    downloadTxt: "Plain text",
    serviceErrorMessage: "Oops! An error occurred. Please try again after some time. You can also email us at support@csod.com for any assistance",
    guidesTab: "Guides",
    noGuideCreatedYet: "No Guide created yet!",
    noCategoryCreatedYet: "No Folder created yet!",
    chatbot: "MyChat",
    notAutorised: "You do not have the required access, please contact the Admin",
    ok: "OK",
    apiError: "Configuration error. Please contact the Admin",
    select: "Select",
    mute_unmute: "Mute/Un-Mute",
    privacyPolicy: "Privacy & Cookies",
    privacyPolicyText: "MyGuide uses cookies. If you continue, you are agreeing to our Terms and Privacy Policy and giving us consent to use cookies",
    terms: "Terms",
    westPecErrorMessage: "You are not authorised to access this application. Please sign into Westpac's network",
    noApp: "No Applications found",
    role: "Role:",
    all: "All",
    video: "Video",
    course: "Course",
    article: "Article",
    image: "Image",
    pathways: "Pathways",
    preview: "Preview",
    more: "More",
    history: "History",
    publish: "Publish",
    selectGuideLink: "Please select Guide to link",
    selectGuideBeforeSubmit: "Please select a Guide before submit",
    change: "Change",
    checkNow: "Check Now",
    minutes: "minutes",
    clickHere: "click here",
    youAlmostDone: "You're almost done!",
    setOrg: "to set up your Organization",
    apps: "Apps",
    me: "Me",
    playStep: "Play Step",
    miniPlayerHelp: "Help",
    defaultMiniPlayerHelp: "Help",
    defaultConfirmIfSlideshowOrRedirect: "Step not available on current URL.<br>Do you want to go to the Step URL or play slideshow?",
    defaultServiceErrorMessage: "Oops! An error occurred. Please try again after some time. You can also email us at support@csod.com for any assistance",
    defaultMaintenanceMessage: "Maintenance in progress. Please contact us via support@csod.com",
    userNotFollowingGuideMessage: "It looks like you're performing steps that are not part of this Guide. If you no longer wish to follow the Guide, click on Exit Guide",
    defaultUserNotFollowingGuideMessage: "It looks like you're performing steps that are not part of this Guide. If you no longer wish to follow the Guide, click on Exit Guide",
    resumeGuide: "Resume Guide",
    defaultResumeGuideMessage: "Resume Guide",
    backToLogin: "Back to Login",
    filters: "Filters",
    thisApp: "This App",
    thisWebsite: "This Website",
    maxFreeTourLimit: "Max limit of tours reached",
    passwordRegexCheck: "The password must contain a minimum of 8 characters, including at least one uppercase, one lowercase and one numeric value",
    countLimit: "99+",
    microsoftServiceKey: "Please enter your Microsoft Cognitive Services Speech subscription key",
    numberOfImgFile: "The number of image files and text files should be the same",
    availableOn: "Available on",
    tooltipUnpubWorkflowTitle: "Unpublished Workflow",
    tooltipUnpubParentWorkflowTitle: "Published Workflow, Unpublished Parent Folder(s)",
    tooltipPubParentWorkflowTitle: "Published Workflow, Published Folder",
    tooltipUnpubTooltipTitle: "Unpublished Tooltip",
    tooltipUnpubParentTooltipTitle: "Published Tooltip, Unpublished Parent Folder(s)",
    tooltipPubParentTooltipTitle: "Published Tooltip, Published Folder",
    tooltipUnpubTutorialTitle: "Unpublished Tutorial",
    tooltipUnpubParentTutorialTitle: "Published Tutorial, Unpublished Parent Folder(s)",
    tooltipPubParentTutorialTitle: "Published Tutorial, Published Folder",
    tooltipUnpubSubFolderTitle: "Unpublished Sub-folder",
    tooltipUnpubSubFolderDesc: "Use sub-folders to organize Guides",
    tooltipUnpubParentSubFolderTitle: "Published Sub-folder, Unpublished Parent Folder(s)",
    tooltipPubParentSubFolderTitle: "Published Sub-folder, Published Folder",
    tooltipPubParentSubFolderDesc: "Organizes Guides",
    exitSurvey: 'Exit Survey',
    disable: "Disable",
    instructionExitSurvey: "Exit Survey is shown when a user exits a guide before completion",
    msgVideoNotFound: "Uploading your video, please try after some time",
    msgGiphyNotFound: "Uploading your GIF, please try after some time",
    userPref: "My Preferences",
    manageAccount: "Admin Portal",
    analyticsPortal: "Insights Portal",
    errorInvalidUrl: "Not a valid URL",
    navigationMenu: "Navigation Menu",
    clearHistory: "Clear History",
    userDeniedMessage: "User denied Camera and Microphone access permissions",
    pushNotification: "Push Notifications",
    viewDetail: "View Detail",
    contactAdmin: "Please contact support@csod.com or your Admin for further assistance",
    noAppOnDomain: "Application is not assigned for current domain ",
    noGuidesOnDomain: "No Guides found",
    apply: "Apply",
    invalidLoginCred: "Invalid login credentials. Your account will be locked after multiple unsuccessful attempts, you will receive an email to unlock your account, or you may reset your password",
    resendOTP: "Resend OTP",
    sendFeedback: 'Send Feedback',
    guideNotExist: "This Guide is not available on this page (Error: Domain mismatch) ",
    cdnAccess: "<b>We're sorry</b> <br><br>It seems there is problem with our servers.<br> We've been notified of the error and will correct it as soon as possible",
    tourPlayError: "Guide can not be played. Error while retrieving Guide details",
    playerMode: "Player Mode",
    closePanel: "Close Panel",
    switchCreatorMode: "Switch to Creator Mode",
    extensionContextError: "Extension context is invalidated. Please reload the page to continue",
    otpSent: "OTP has been re-sent to your email, please check your inbox",
    startOver: "Start Again",
    yesResume: "Resume",
    dontShowAgain: "Don't show again",
    notificationHeader: "You've got a notification!",
    watchLater: "Watch later",
    pushSnoozeMsg: "This notification will be snoozed for",
    showAgain: "Show again",
    noGuidesOnThisTab: "There are no notifications on this page",
    iAgree: "I Agree",
    viewMore: "View More",
    lostInternetConnection: "Lost connection to the server. Please reconnect and try again",
    next: "Next",
    recent: "Recent",
    older: "Older",
    atoz: "A - Z",
    ztoa: "Z - A",
    clear: "Clear",
    tooltipDontShowAgain: "Notifications won't appear anymore. To enable a notification now, hover over it and click on 'Show Again'",
    tooltipWatchLater1: "Notifications are snoozed for",
    tooltipWatchLater2: "and will appear after that. To enable a notification now, hover over it and click on 'Show Again'",
    hour: "hour",
    hours: "hours",
    insightsTracker: "Insights Tracker",
    slideshow: "SlideShow",
    autoplay: "AUTOPLAY",
    powerFormOldData: "Existing data",
    powerFormNewData: "Use this form to enter new data",
    powerFormNewDataMore: "If your existing data is not visible, please click on the arrow in the top left to view your data. The data then needs to be copied across into the permitted bulleted format.",
    powerFormTitle: "Data Entry Assistant",
    powerFormMandatory: "This is a mandatory field, max character limit ",
    belongToOtherApp: "This Guide is created on {TOURURL}, which belongs to the {APPNAME} app. Please copy this Guide in that app and try again",
    setDomain: "If you are sure that the {TOURURL} should be added in the current application domain settings, please add and try again",
    on: "ON",
    off: "OFF",
    btnPrev: "Prev",
    btnPrevious: "Previous",
    taskList: "Task List",
    unprocessedVideo: "Please wait while your video is being processed.",
    searchResult: "Search Result",
    pleaseWait: "Please Wait!",
    mediaDownloadMsg: "While we prepare your files for download",
    mediaFileNotFound: "Media file not found",
    searchInFolder: "Search in folder",
    currentPageSearchPlaceholder: "Search for Guide(s) available on current page",
    brandLogo: "Brand Logo",
    accessibility: "Accessibility",
    replay: "Replay",
    defaultGreetingMessage: "Hey! Welcome to MyGuide. How can I help you? Please keep in mind that I am a bot.",
    defaultErrorMessage: "I'm sorry, I did not understand that. Could you be more specific? ",
    greetingMessage: "Hey! Welcome to MyGuide. How can I help you? Please keep in mind that I am a bot.",
    errorMessage: "I'm sorry, I did not understand that. Could you be more specific? ",
    guideLnkToRedirect: "Use the following link to redirect to the page and play the guide",
    otpTimer: "You can try again in ",
    seconds: " seconds",
    limitWarning: "You have reached the maximum limit of unsuccessful attempts",
    403: "We ran into a problem with this request. Please try this again. If the problem persists, report to us at support@csod.com",
    405: "We ran into a problem while processing this request. Please try this again. If the problem persists, report to us at support@csod.com",
    429: "Too many requests",
    1003: "We ran into a problem during authentication. Please re-login and try again. If the problem persists, refresh the page and try again",
    1007: "We ran into a problem during authentication. Please try again. If the problem persists, report to us at support@csod.com",
    1005: "<b>We're sorry</b> <br><br>It seems there is a problem with the request or with our servers.<br> We've been notified of the error and will correct it as soon as possible",
    1009: "User email is not verified",
    1014: "Maintenance in progress. Please contact us via support@csod.com",
    1017: "We ran into a problem during authentication. Please re-login and try again. If the problem persists, report to us at support@csod.com",
    1018: "You have reached the maximum limit to creating steps",
    2000: "We ran into a problem with this request. We have been notified. Please try this again. If the problem persists, report to us at support@csod.com",
    2001: "Invalid login credentials. Your account will be locked after multiple unsuccessful attempts, you will receive an email to unlock your account, or you may reset your password",
    2002: "Invalid or expired OTP",
    2003: "Uploaded file is not a valid image (JPG and PNG files are supported)",
    2004: "Session expired",
    2005: "We could not track this user. Please refresh and try again. If the problem persists, report to us at support@csod.com",
    2006: "Email Address is incorrect. Please try again",
    2007: "User Role invalid. Please try again",
    2008: "You must specify a correct Task type",
    2009: "The given Application is invalid; it could have been deleted or never existed",
    2010: "Invalid input parameters. Please refresh and try again. If the problem persists, report to us at support@csod.com",
    2011: "The given Organization is invalid; it could have been deleted or never existed",
    2012: "There was a missing or invalid parameter in the request. Please re-check and try again. If the problem persists, report to us at support@csod.com",
    2013: "There was a missing or invalid parameter in the request. Please re-check and try again. If the problem persists, report to us at support@csod.com",
    2014: "Parameter required for Super Admin[organization_id]",
    2015: "Image Data content provided is invalid. Please re-check and try again. If the problem persists report to us at support@csod.com",
    2016: "Invalid Domain",
    2017: "There was a missing or invalid parameter in the request",
    2018: "There was a missing or invalid parameter in the request",
    2019: "What you are looking for does not exist or might have been deleted",
    2020: "There was a missing or invalid parameter in the request",
    2021: "The Authentication server encountered an unexpected error while trying to process this request. Please report the problem to support@csod.com",
    2022: "There was a missing or invalid parameter in the request. Please enter a valid Team URL",
    2023: "The Authentication server encountered an unexpected error while trying to process this request. Please report the problem to support@csod.com",
    2024: "File size should be less than 5 MB",
    2025: "There was a missing or invalid parameter in the request. Please enter a valid URL",
    2026: "The password must contain a minimum of 8 characters, including at least one uppercase, one lowercase and one numeric value",
    2027: "Invalid Password",
    2028: "There was a missing or invalid parameter in the request",
    2029: "The City you have provided is not supported",
    2030: "There was a missing or invalid parameter in the request",
    2031: "The Authentication server encountered an unexpected error while trying to process this parameter. Please report the problem to support@csod.com",
    2032: "Invalid parameter[file_id]",
    2033: "Invalid URL. Please re-check and try again",
    2034: "The Authentication server encountered an unexpected error while processing these parameters. Please report the problem to support@csod.com",
    2035: "The Authentication server encountered an unexpected error while processing this AppKey. Please report the problem to support@csod.com",
    2036: "The Authentication server encountered an unexpected error. Please refresh this page. If the problem persists, report the problem to support@csod.com",
    2044: "We seem to have misplaced the translation for this step. Please switch to Default Language and re-translate the step, or contact our customer support for further details.",
    2200: "We ran into a problem while accessing audio/video controls. Please check your browser settings and try this again. If the problem persists report to us at support@csod.com",
    3061: "You can pin up to 5 Guide(s) only",
    4000: "Sub-category cannot be created inside a Folder, if a Guide is already created",
    4001: "If a user is already a Super Admin, you cannot change the User Role",
    4002: "This action is not allowed on a published Guide",
    4003: "Locked Guide cannot be published",
    4004: "This action is not allowed on a published Folder. Please unpublish it",
    4006: "Application must belong to the given organization",
    4007: "You are not authorised to perform this action",
    4008: "Action is not allowed for this sub-category",
    4009: "Guide must be published",
    4010: "Guide cannot be created inside a folder with a sub-category",
    4011: "To create step(s), you need to unlock this Guide",
    4012: "To edit step(s), you need to unlock this Guide",
    4013: "To delete step(s), you need to unlock this Guide",
    4014: "To copy and paste step(s), you need to unlock this Guide",
    3001: "Guide will be available for export soon. To check the status, go to 'Task Status' under account menu",
    3002: "Upload started. Please do not refresh or close the browser until the upload is completed. You can check the import status once it is completed",
    3003: "User already exists",
    3004: "Email ID is already verified",
    3005: "This URL conflicts with other application configuration, please try to add any other URL",
    3006: "Folder must belong to the same application",
    3007: "Domain already exists",
    3008: "You have reached the maximum limit of created Guide(s)",
    3009: "Survey already exists in the given Guide",
    3010: "The Step must belong to the same Guide",
    3011: "This Organization is suspended. Please contact your Admin",
    3012: "Guide(s) must belong to the same folder",
    3013: "This Guide already exists with the given pair of objects and field name",
    3014: "User suspended",
    3015: "User already verified",
    3017: "OTP has been sent successfully to your email address",
    3018: "Role already exists",
    3019: "Country already exists",
    3020: "City already exists",
    3023: "Your organization is not verified. For help, please contact support@csod.com",
    3024: "JSON file is not available for this organization",
    3025: "We ran into a problem during authentication. Please try this again. If the problem persists refresh the page and try again",
    3026: "JSON file is not available for this Guide",
    3027: "No step available. Create at least one step to publish the Guide",
    3028: "Maximum tour publish limit reached",
    3047: "Your account has been temporarily locked due to excessive login failures. We have sent you an email with steps to unlock it. For more assistance, please contact us at support@csod.com",
    3033: "Invalid credentials. Please contact support@csod.com or your Admin for further assistance.",
    4020: "A draft of this Guide already exists; multiple drafts of a Guide are not permitted.",
    4021: "Invalid values of parameter [envs]",
    2054: "An old and new password can not be the same",
    playNextBotTour: "Play next bot tour",
    defaultBotEndingMessage: "We are done, thank you so much! Anything else before I kick it off?",
    startBotLbl: "Start Bot",
    includeScreen: "Include Screenshot",
    feedbackPlaceholder: "Have feedback? Wed love to hear it!",
    feedbackOptBtn: "Click to highlight or hide info",
    highlight: "Highlight",
    send: "Send",
    done: "Done",
    hide: "Hide",
    multiSelectOptionError: "Please select atleast one option",
    loginNext: "Next",
    3068: "Your old password has expired set new password for login.",
    captchaLbl: "Captcha",
    placeholderEnterCaptcha: "Enter Captcha",
    captchaError: "Please enter valid captcha",
    allGuides: "All Guides",
    helpCenter: "Help Center",
    applicationJsonError: "Application JSON file is not available for this application.",
    feedbackRequired: "Please enter your feedback.",
    default: "Default",
    feedbackImgErrorMsg: "The screenshot was unable to attached to your feedback due to a browser related issue. Please reload the page, click and open the Guide Extension from the Chrome action bar and recapture the screenshot for feedback.",
    tranportURlRedirectionConfirm: "Redirect to transport step url",
    guideContinueConfirm: "Continue with guide",
    focus: "Focus",
    autoplay: "Autoplay",
    zoomOut: "You Can not decrease more Zoom Level",
    zoomIn: "You Can not increase more Zoom Level",
    charM: "m",
    charS : "s",
    focusTooltip: "This button is functional only when the image is zoomed in.",
    startYoursmartWalkthrough: "Start adding steps!",
    displayGuidesFrom: "Display guides from",
    web: "Web",
    desktop: "Desktop",
    selectLanguage: "Select language",
    btnExportCsvTask: "Automation (CSV)",
    chooseFile: "Choose File"
};

GmCXt.playerSvgs = {
    iconPopupDrag: '<svg width="17" height="17" viewBox="0 0 17 17" fill="none">' +
		'<path d="M13.9443 7.55643H9.4991C9.18045 7.55643 8.93013 7.81896 8.93013 8.13378C8.93013 8.45074 9.18256 8.70806 9.4991 8.70806H13.9435L13.0248 9.64754C12.8048 9.87252 12.8048 10.2329 13.0248 10.4579C13.1353 10.5709 13.2802 10.6285 13.4288 10.6285C13.5774 10.6285 13.7224 10.5709 13.8328 10.4579L15.7107 8.53744C15.9307 8.31246 15.9307 7.95203 15.7107 7.72705L13.8328 5.80656C13.6104 5.57906 13.2503 5.57906 13.0278 5.80656C12.8079 6.03152 12.8078 6.39192 13.0278 6.6169L13.0277 6.61678L13.1708 6.47716L13.0278 6.61695L13.9443 7.55643Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M2.84286 10.4579C2.9533 10.5709 3.09821 10.6285 3.24684 10.6285C3.39547 10.6285 3.54038 10.5709 3.65082 10.4579C3.87081 10.2329 3.87081 9.87252 3.65082 9.64754L2.73219 8.70806H7.17656C7.49416 8.70806 7.74553 8.4466 7.74553 8.13378C7.74553 7.8231 7.49625 7.55643 7.17656 7.55643H2.7314L3.64782 6.61695L3.50482 6.47712L3.64799 6.61678L3.64787 6.6169C3.86781 6.39192 3.8678 6.03152 3.64782 5.80656C3.42538 5.57906 3.0653 5.57906 2.84286 5.80656L0.964993 7.72705C0.745002 7.95203 0.745002 8.31246 0.964993 8.53744L2.84286 10.4579Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M6.06066 3.32867C6.27841 3.55932 6.64328 3.55681 6.86178 3.32955L7.76905 2.40168V6.94241C7.76905 7.25723 8.01938 7.51976 8.33803 7.51976C8.65668 7.51976 8.907 7.25723 8.907 6.94241V2.40168L9.81493 3.33021C9.92537 3.44316 10.0703 3.50083 10.2189 3.50083C10.3675 3.50083 10.5124 3.44316 10.6229 3.33021C10.8429 3.10523 10.8429 2.7448 10.6229 2.51981L8.74501 0.599317C8.52857 0.377962 8.15649 0.377962 7.94004 0.599317L6.06216 2.51981C5.84267 2.74429 5.84217 3.10358 6.06066 3.32867Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M7.76917 13.86L6.86126 12.9314C6.63882 12.7039 6.27874 12.7039 6.0563 12.9314C5.83631 13.1564 5.83631 13.5168 6.0563 13.7418L7.93417 15.6623C8.04012 15.7707 8.18439 15.8329 8.33815 15.8329C8.48804 15.8329 8.63556 15.7713 8.74213 15.6623L10.62 13.7418C10.84 13.5168 10.84 13.1564 10.62 12.9314C10.3976 12.7039 10.0375 12.7039 9.81503 12.9314L8.90712 13.86V9.31924H8.90714L8.9071 9.31637C8.90264 9.00646 8.65933 8.74189 8.33815 8.74189C8.0195 8.74189 7.76917 9.00443 7.76917 9.31924V13.86Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'</svg>',
    iconStepAutoGear: '<svg width="35px" height="35px" viewBox="0 0 35 35" version="1.1" >' +
		'<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g transform="translate(-235.000000, -594.000000)" fill-rule="nonzero">' +
		'<g transform="translate(186.000000, 576.000000)">' +
		'<g class="mgPlayerJSProd_Group-3" transform="translate(49.000000, 18.000000)">' +
		'<path d="M35,19.3074463 L35,15.6868582 L32.3417597,14.7818585 C32.1983895,13.9709332 31.9833343,13.1875035 31.7172156,12.425874 L33.5633522,10.314208 L31.7533528,7.18284608 L28.9951462,7.72136805 C28.7225464,7.41223837 28.4495539,7.1105718 28.1690983,6.83050895 C27.8819651,6.54337579 27.5802985,6.26390214 27.2715616,5.99797991 L27.8175467,3.24684361 L24.6852029,1.43743337 L22.5670557,3.28219516 C21.8119073,3.01077381 21.0300488,2.80161046 20.2181415,2.65116997 L19.3131418,0 L15.6860726,0 L14.7800909,2.65116997 C13.9691656,2.80141406 13.1863251,3.01057741 12.4256776,3.28219516 L10.3134224,1.43743337 L7.1816677,3.24684361 L7.72765277,5.99797991 C7.41852309,6.26350934 7.10978621,6.54357219 6.82972336,6.83050895 C6.53551989,7.1186241 6.25604624,7.42736098 5.98953482,7.74356097 L5.99660513,7.72195724 L3.24645082,7.18343527 L1.43546939,10.3147971 L3.28160597,12.4264632 C3.01607654,13.1880927 2.80102127,13.9780035 2.65018798,14.7824477 L-1.42108547e-14,15.6874474 L-1.42108547e-14,19.3080355 L2.65018798,20.2130352 C2.80102127,21.0239605 3.01666573,21.8148533 3.28160597,22.5690197 L1.43546939,24.6806857 L3.24645082,27.8185287 L5.99660513,27.2725436 C6.26311655,27.5812805 6.5425902,27.8833399 6.82972336,28.170473 C7.11685652,28.4585882 7.42657539,28.738651 7.73472308,29.0035913 L7.1816677,31.7482465 L10.3204927,33.564727 L12.4260704,31.7189832 C13.1867179,31.9849054 13.9772179,32.2001571 14.7804837,32.3439201 L15.6864654,35 L19.3135346,35 L20.2185343,32.3439201 C21.0304416,32.2001571 21.8123001,31.9849054 22.5745188,31.7103417 L24.6855956,33.5645306 L27.8179395,31.7480501 L27.2719544,28.9959318 C27.5806913,28.7300095 27.8823579,28.4515179 28.169491,28.1698838 C28.4499467,27.8827507 28.7296167,27.5806913 28.995539,27.2719544 L31.7537456,27.8179395 L33.563745,24.6800965 L31.7176084,22.5684305 C31.9835307,21.8142641 32.1987823,21.0239605 32.3421525,20.212446 L35,19.3074463 Z M17.5033388,22.5821783 C14.6883733,22.5821783 12.4111442,20.3065204 12.4111442,17.4986252 C12.4111442,14.6885697 14.6881769,12.4131081 17.5033388,12.4131081 C20.3114303,12.4131081 22.5888558,14.6887661 22.5888558,17.4986252 C22.588463,20.3065204 20.3112339,22.5821783 17.5033388,22.5821783 Z" class="mgPlayerJSProd_shape" fill="#454560"></path>' +
		'<path d="M17.5032383,9.77477477 C13.2315636,9.77477477 9.77477477,13.2323075 9.77477477,17.4975465 C9.77477477,21.7621966 13.2315636,25.2252252 17.5032383,25.2252252 C21.7678476,25.2252252 25.2252252,21.7621966 25.2252252,17.4975465 C25.2246364,13.2319149 21.7678476,9.77477477 17.5032383,9.77477477 Z M17.5032383,21.5831861 C15.2407129,21.5831861 13.4103596,19.7536282 13.4103596,17.4975465 C13.4103596,15.2408758 15.2407129,13.4097477 17.5032383,13.4097477 C19.7596797,13.4097477 21.5884628,15.2408758 21.5884628,17.4975465 C21.5884628,19.7536282 19.7590909,21.5831861 17.5032383,21.5831861 Z" class="mgPlayerJSProd_shape" fill="#454560"></path>' +
		'<path d="M17.6621871,7.25225225 C12.0838459,7.25225225 7.56756757,11.7679398 7.56756757,17.3387975 C7.56756757,22.9096553 12.083649,27.4324324 17.6621871,27.4324324 C23.2330449,27.4324324 27.7477477,22.9092614 27.7477477,17.3387975 C27.7477477,11.767349 23.2330449,7.25225225 17.6621871,7.25225225 Z M17.6621871,23.1485358 C14.4452767,23.1485358 11.8443746,20.5470429 11.8443746,17.3387975 C11.8443746,14.1313399 14.4452767,11.5284685 17.6621871,11.5284685 C20.8700386,11.5284685 23.4715315,14.1313399 23.4715315,17.3387975 C23.4715315,20.5472398 20.8702355,23.1485358 17.6621871,23.1485358 Z" class="mgPlayerJSProd_shape" fill="#56E7CE"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    iconPopupEdit: '<svg width="15" height="15" viewBox="0 0 15 15" fill="none" >' +
		'<path d="M12.9655 1.65245C12.1867 0.873663 10.9241 0.873663 10.1453 1.65245L2.23938 9.55838C2.18519 9.61256 2.14607 9.67973 2.12565 9.75347L1.08599 13.5068C1.04324 13.6607 1.08669 13.8255 1.19955 13.9386C1.31259 14.0514 1.47738 14.0949 1.63127 14.0523L5.38465 13.0125C5.45839 12.992 5.52555 12.9529 5.57973 12.8987L13.4855 4.99263C14.2631 4.21333 14.2631 2.95176 13.4855 2.17245L12.9655 1.65245ZM3.20494 9.84642L9.67533 3.37586L11.7621 5.46261L5.29152 11.9332L3.20494 9.84642ZM2.78811 10.6829L4.45526 12.3502L2.14919 12.9891L2.78811 10.6829ZM12.8589 4.366L12.3889 4.83598L10.302 2.74905L10.7721 2.27908C11.2047 1.8465 11.9061 1.8465 12.3387 2.27908L12.8589 2.79908C13.2907 3.23218 13.2907 3.93307 12.8589 4.366Z" fill="#757575" stroke="#757575" stroke-width="0.5" />' +
		'</svg>',
    iconClosePopup: '<svg width="12" height="12" viewBox="0 0 12 13" fill="none" > ' +
		'<path d = "M6.90481 6.67981L11.5191 1.96076C11.8058 1.66783 11.8058 1.19252 11.5191 0.89958C11.2324 0.60639 10.7682 0.60639 10.4815 0.89958L5.86718 5.61863L1.25264 0.89958C0.965959 0.60639 0.501692 0.60639 0.215011 0.89958C-0.0716703 1.19252 -0.0716703 1.66783 0.215011 1.96076L4.82955 6.67981L0.215011 11.3989C-0.0716703 11.6918 -0.0716703 12.1671 0.215011 12.46C0.358352 12.6064 0.546211 12.6797 0.733826 12.6797C0.92144 12.6797 1.1093 12.6064 1.25264 12.4598L5.86718 7.74075L10.4815 12.4598C10.6248 12.6064 10.8127 12.6797 11.0003 12.6797C11.1879 12.6797 11.3758 12.6064 11.5191 12.4598C11.8058 12.1669 11.8058 11.6915 11.5191 11.3986L6.90481 6.67981Z"' +
		'fill = "#666666"' +
		' fill-opacity="0.9"  />' +
		'</svg>',
    iconPause: '<svg width="15px" height="21px" viewBox="0 0 15 21" version="1.1" >' +
		'<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g transform="translate(-765.000000, -999.000000)" fill="#FFFFFE">' +
		'<g transform="translate(198.000000, 736.000000)">' +
		'<path d="M580.5,263 L577.5,263 C576.672,263 576,263.672 576,264.5 L576,282.5 C576,283.328 576.672,284 577.5,284 L580.5,284 C581.328,284 582,283.328 582,282.5 L582,264.5 C582,263.672 581.328,263 580.5,263 L580.5,263 Z M571.5,263 L568.5,263 C567.672,263 567,263.672 567,264.5 L567,282.5 C567,283.328 567.672,284 568.5,284 L571.5,284 C572.328,284 573,283.328 573,282.5 L573,264.5 C573,263.672 572.328,263 571.5,263 L571.5,263 Z"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    iconClassicNavNext: '<svg  width="12px" height="12px" version="1.1" x="0px" y="0px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">' +
		'<g><g><path d="M37.3,27.1L17.2,45.1c-1.3,1.2-3.3,1.2-4.6,0c-1.3-1.2-1.3-3,0-4.1l17.8-16L12.6,9c-1.3-1.2-1.3-3,0-4.1' +
		'c1.3-1.2,3.3-1.2,4.6,0l20.1,18.1c0.7,0.5,1,1.3,1,2.1S38,26.5,37.3,27.1z"/>' +
		'</g></g>' +
		'</svg>',
    iconClassicNavPrev: '<svg  width="12px" height="12px" version="1.1" x="0px" y="0px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">' +
		'<g><g>' +
		'<path d="M11.7,25c0-0.7,0.3-1.5,1-2.1L32.8,4.9c1.3-1.2,3.3-1.2,4.6,0s1.3,3,0,4.1L19.6,25l17.8,16c1.3,1.2,1.3,3,0,4.1' +
		'c-1.3,1.2-3.3,1.2-4.6,0L12.7,27.1C12,26.5,11.7,25.7,11.7,25z"/> </g></g>' +
		'</svg>',
    iconPlayStepNext: '<svg  width="12px" height="12px" version="1.1" x="0px" y="0px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">' +
		'<g> <g><path d="M29.2,27.3L9.1,47.4c-1.3,1.3-3.4,1.3-4.6,0c-1.3-1.3-1.3-3.3,0-4.6L22.2,25L4.5,7.2c-1.3-1.3-1.3-3.3,0-4.6' +
		'c1.3-1.3,3.3-1.3,4.6,0l20.1,20.1c0.6,0.6,1,1.5,1,2.3C30.1,25.8,29.8,26.7,29.2,27.3z"/></g><g>' +
		'<path d="M45.5,27.3L25.4,47.4c-1.3,1.3-3.4,1.3-4.6,0c-1.3-1.3-1.3-3.3,0-4.6L38.6,25L20.8,7.2c-1.3-1.3-1.3-3.3,0-4.6' +
		'c1.3-1.3,3.3-1.3,4.6,0l20.1,20.1c0.6,0.6,1,1.5,1,2.3C46.5,25.8,46.2,26.7,45.5,27.3z"/> </g></g>' +
		'</svg>',
    iconStepPlayAudioOn: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none">' +
		'<mask id="mgPlayerJSProd_path-1-outside-1" maskUnits="userSpaceOnUse" x="0" y="-0.366699" width="19" height="17" fill="black">' +
		'<rect fill="white" y="-0.366699" width="19" height="17"/>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.2682 15.6333C10.2007 15.6333 10.1334 15.613 10.0755 15.5729C8.89613 14.7576 7.87115 13.976 6.87993 13.2202L6.87919 13.2197C5.91912 12.4876 4.92723 11.7312 3.79765 10.9467H1.34404C1.15403 10.9467 1 10.7892 1 10.5949V5.67172C1 5.47743 1.15403 5.31987 1.34404 5.31987H3.79778C6.12166 3.70627 10.0229 0.733296 10.0625 0.703072C10.1669 0.623485 10.3062 0.611029 10.4224 0.670632C10.5388 0.730341 10.6122 0.852045 10.6122 0.985114V15.2815C10.6122 15.4116 10.542 15.5312 10.4295 15.5922C10.3789 15.6197 10.3235 15.6333 10.2682 15.6333ZM1.68808 10.2431H3.90323C3.9719 10.2431 4.03902 10.2641 4.09593 10.3034C5.27491 11.1186 6.29956 11.8999 7.29049 12.6555C8.12158 13.2893 8.97669 13.9413 9.92413 14.6139V1.68434C8.7392 2.58106 5.90625 4.7116 4.09603 5.96323C4.03916 6.00256 3.97204 6.02361 3.90333 6.02361H1.68808V10.2431ZM13.2438 10.9244C13.155 10.9244 13.0663 10.8895 12.999 10.8197C12.8655 10.6814 12.8668 10.4587 13.0021 10.3221C13.5813 9.73721 13.9003 8.95988 13.9003 8.13331C13.9003 7.30668 13.5813 6.52938 13.002 5.94458C12.8668 5.80806 12.8654 5.58527 12.9989 5.44696C13.1324 5.30865 13.3501 5.30724 13.4854 5.44372C14.1967 6.16181 14.5884 7.117 14.5884 8.13328C14.5884 9.14952 14.1967 10.1047 13.4855 10.8228C13.4184 10.8906 13.3311 10.9244 13.2438 10.9244ZM15.601 12.4459C15.6683 12.5157 15.7571 12.5506 15.8458 12.5506C15.9331 12.5506 16.0205 12.5168 16.0875 12.4491C17.229 11.2966 17.8576 9.76397 17.8576 8.13354C17.8576 6.50315 17.229 4.97047 16.0875 3.81778C15.9523 3.68126 15.7344 3.68267 15.6009 3.82095C15.4674 3.95926 15.4688 4.18201 15.604 4.31856C16.6136 5.33797 17.1696 6.69283 17.1696 8.13354C17.1696 9.57429 16.6136 10.9291 15.6041 11.9483C15.4689 12.0849 15.4675 12.3076 15.601 12.4459Z"/>' +
		'</mask>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.2682 15.6333C10.2007 15.6333 10.1334 15.613 10.0755 15.5729C8.89613 14.7576 7.87115 13.976 6.87993 13.2202L6.87919 13.2197C5.91912 12.4876 4.92723 11.7312 3.79765 10.9467H1.34404C1.15403 10.9467 1 10.7892 1 10.5949V5.67172C1 5.47743 1.15403 5.31987 1.34404 5.31987H3.79778C6.12166 3.70627 10.0229 0.733296 10.0625 0.703072C10.1669 0.623485 10.3062 0.611029 10.4224 0.670632C10.5388 0.730341 10.6122 0.852045 10.6122 0.985114V15.2815C10.6122 15.4116 10.542 15.5312 10.4295 15.5922C10.3789 15.6197 10.3235 15.6333 10.2682 15.6333ZM1.68808 10.2431H3.90323C3.9719 10.2431 4.03902 10.2641 4.09593 10.3034C5.27491 11.1186 6.29956 11.8999 7.29049 12.6555C8.12158 13.2893 8.97669 13.9413 9.92413 14.6139V1.68434C8.7392 2.58106 5.90625 4.7116 4.09603 5.96323C4.03916 6.00256 3.97204 6.02361 3.90333 6.02361H1.68808V10.2431ZM13.2438 10.9244C13.155 10.9244 13.0663 10.8895 12.999 10.8197C12.8655 10.6814 12.8668 10.4587 13.0021 10.3221C13.5813 9.73721 13.9003 8.95988 13.9003 8.13331C13.9003 7.30668 13.5813 6.52938 13.002 5.94458C12.8668 5.80806 12.8654 5.58527 12.9989 5.44696C13.1324 5.30865 13.3501 5.30724 13.4854 5.44372C14.1967 6.16181 14.5884 7.117 14.5884 8.13328C14.5884 9.14952 14.1967 10.1047 13.4855 10.8228C13.4184 10.8906 13.3311 10.9244 13.2438 10.9244ZM15.601 12.4459C15.6683 12.5157 15.7571 12.5506 15.8458 12.5506C15.9331 12.5506 16.0205 12.5168 16.0875 12.4491C17.229 11.2966 17.8576 9.76397 17.8576 8.13354C17.8576 6.50315 17.229 4.97047 16.0875 3.81778C15.9523 3.68126 15.7344 3.68267 15.6009 3.82095C15.4674 3.95926 15.4688 4.18201 15.604 4.31856C16.6136 5.33797 17.1696 6.69283 17.1696 8.13354C17.1696 9.57429 16.6136 10.9291 15.6041 11.9483C15.4689 12.0849 15.4675 12.3076 15.601 12.4459Z" fill="#757575"/>' +
		'<path d="M10.0755 15.5729L10.36 15.1617L10.3598 15.1616L10.0755 15.5729ZM6.87993 13.2202L7.1831 12.8226L7.183 12.8225L6.87993 13.2202ZM6.87919 13.2197L6.57601 13.6173L6.57612 13.6173L6.87919 13.2197ZM3.79765 10.9467L4.08287 10.5361L3.95424 10.4467H3.79765V10.9467ZM3.79778 5.31987V5.81987H3.95435L4.08296 5.73058L3.79778 5.31987ZM10.0625 0.703072L10.3657 1.10066L10.3657 1.10063L10.0625 0.703072ZM10.4224 0.670632L10.6508 0.225813L10.6505 0.225677L10.4224 0.670632ZM10.4295 15.5922L10.1909 15.1528L10.1908 15.1529L10.4295 15.5922ZM1.68808 10.2431H1.18808V10.7431H1.68808V10.2431ZM4.09593 10.3034L4.38028 9.89217L4.38025 9.89215L4.09593 10.3034ZM7.29049 12.6555L7.59367 12.258L7.59367 12.258L7.29049 12.6555ZM9.92413 14.6139L9.6347 15.0216L10.4241 15.582V14.6139H9.92413ZM9.92413 1.68434H10.4241V0.678921L9.62241 1.28564L9.92413 1.68434ZM4.09603 5.96323L3.81167 5.55196L3.8116 5.55201L4.09603 5.96323ZM1.68808 6.02361V5.52361H1.18808V6.02361H1.68808ZM12.999 10.8197L12.6392 11.167L12.6392 11.167L12.999 10.8197ZM13.0021 10.3221L13.3573 10.674L13.3574 10.674L13.0021 10.3221ZM13.002 5.94458L13.3572 5.5927L13.3572 5.59269L13.002 5.94458ZM12.9989 5.44696L12.6392 5.09964L12.6391 5.09974L12.9989 5.44696ZM13.4854 5.44372L13.8407 5.09185L13.8405 5.09174L13.4854 5.44372ZM13.4855 10.8228L13.1302 10.471L13.1301 10.4712L13.4855 10.8228ZM15.601 12.4459L15.9608 12.0987L15.9607 12.0987L15.601 12.4459ZM16.0875 12.4491L15.7323 12.0973L15.7322 12.0974L16.0875 12.4491ZM16.0875 3.81778L16.4427 3.46595L16.4427 3.46593L16.0875 3.81778ZM15.6009 3.82095L15.2412 3.47368L15.2412 3.47372L15.6009 3.82095ZM15.604 4.31856L15.2487 4.67036L15.2488 4.6704L15.604 4.31856ZM15.6041 11.9483L15.9593 12.3002L15.9594 12.3002L15.6041 11.9483ZM9.79098 15.9841C9.93362 16.0828 10.1004 16.1333 10.2682 16.1333V15.1333C10.3011 15.1333 10.3333 15.1433 10.36 15.1617L9.79098 15.9841ZM6.57676 13.6178C7.56726 14.3731 8.60092 15.1613 9.79114 15.9842L10.3598 15.1616C9.19134 14.3538 8.17504 13.579 7.1831 12.8226L6.57676 13.6178ZM6.57612 13.6173L6.57686 13.6179L7.183 12.8225L7.18226 12.822L6.57612 13.6173ZM3.51243 11.3574C4.63163 12.1347 5.6152 12.8846 6.57601 13.6173L7.18237 12.8221C6.22304 12.0905 5.22283 11.3278 4.08287 10.5361L3.51243 11.3574ZM1.34404 11.4467H3.79765V10.4467H1.34404V11.4467ZM0.5 10.5949C0.5 11.0546 0.86733 11.4467 1.34404 11.4467V10.4467C1.44072 10.4467 1.5 10.5237 1.5 10.5949H0.5ZM0.5 5.67172V10.5949H1.5V5.67172H0.5ZM1.34404 4.81987C0.86733 4.81987 0.5 5.21196 0.5 5.67172H1.5C1.5 5.7429 1.44072 5.81987 1.34404 5.81987V4.81987ZM3.79778 4.81987H1.34404V5.81987H3.79778V4.81987ZM9.75931 0.305489C9.71744 0.337422 5.82555 3.30316 3.51261 4.90917L4.08296 5.73058C6.41776 4.10938 10.3283 1.12917 10.3657 1.10066L9.75931 0.305489ZM10.6505 0.225677C10.3623 0.0779435 10.0164 0.109434 9.75928 0.305513L10.3657 1.10063C10.3173 1.13753 10.25 1.14412 10.1944 1.11559L10.6505 0.225677ZM11.1122 0.985114C11.1122 0.668733 10.9376 0.373023 10.6508 0.225813L10.1941 1.11545C10.14 1.08766 10.1122 1.03536 10.1122 0.985114H11.1122ZM11.1122 15.2815V0.985114H10.1122V15.2815H11.1122ZM10.6681 16.0316C10.9452 15.8811 11.1122 15.5908 11.1122 15.2815H10.1122C10.1122 15.2324 10.1387 15.1812 10.1909 15.1528L10.6681 16.0316ZM10.2682 16.1333C10.4056 16.1333 10.5433 16.0994 10.6682 16.0315L10.1908 15.1529C10.2145 15.14 10.2413 15.1333 10.2682 15.1333V16.1333ZM3.90323 9.74307H1.68808V10.7431H3.90323V9.74307ZM4.38025 9.89215C4.2405 9.79554 4.07435 9.74307 3.90323 9.74307V10.7431C3.86945 10.7431 3.83755 10.7327 3.8116 10.7147L4.38025 9.89215ZM7.59367 12.258C6.60345 11.5029 5.57013 10.7148 4.38028 9.89217L3.81157 10.7147C4.97969 11.5224 5.99566 12.297 6.98731 13.0531L7.59367 12.258ZM10.2136 14.2062C9.27408 13.5392 8.42544 12.8922 7.59367 12.258L6.98731 13.0531C7.81773 13.6864 8.6793 14.3434 9.6347 15.0216L10.2136 14.2062ZM9.42413 1.68434V14.6139H10.4241V1.68434H9.42413ZM4.38039 6.37449C6.2009 5.11576 9.04234 2.97869 10.2259 2.08304L9.62241 1.28564C8.43606 2.18343 5.61161 4.30744 3.81167 5.55196L4.38039 6.37449ZM3.90333 6.52361C4.07444 6.52361 4.24065 6.47115 4.38046 6.37444L3.8116 5.55201C3.83767 5.53398 3.86963 5.52361 3.90333 5.52361V6.52361ZM1.68808 6.52361H3.90333V5.52361H1.68808V6.52361ZM2.18808 10.2431V6.02361H1.18808V10.2431H2.18808ZM12.6392 11.167C12.8034 11.3371 13.0232 11.4244 13.2438 11.4244V10.4244C13.2868 10.4244 13.3292 10.4419 13.3587 10.4725L12.6392 11.167ZM12.6468 9.97028C12.3202 10.3 12.3171 10.8333 12.6392 11.167L13.3587 10.4725C13.4138 10.5296 13.4135 10.6173 13.3573 10.674L12.6468 9.97028ZM13.4003 8.13331C13.4003 8.82872 13.1329 9.47944 12.6468 9.97029L13.3574 10.674C14.0298 9.99498 14.4003 9.09103 14.4003 8.13331H13.4003ZM12.6468 6.29645C13.1329 6.78718 13.4003 7.43784 13.4003 8.13331H14.4003C14.4003 7.17552 14.0297 6.27158 13.3572 5.5927L12.6468 6.29645ZM12.6391 5.09974C12.317 5.43348 12.3202 5.96676 12.6468 6.29647L13.3572 5.59269C13.4134 5.64936 13.4138 5.73706 13.3586 5.79418L12.6391 5.09974ZM13.8405 5.09174C13.5078 4.75604 12.9675 4.75964 12.6392 5.09964L13.3585 5.79427C13.2973 5.85765 13.1925 5.85844 13.1303 5.7957L13.8405 5.09174ZM15.0884 8.13328C15.0884 6.98605 14.6453 5.90416 13.8407 5.09185L13.1302 5.79559C13.7482 6.41946 14.0884 7.24796 14.0884 8.13328H15.0884ZM13.8408 11.1747C14.6453 10.3623 15.0884 9.28048 15.0884 8.13328H14.0884C14.0884 9.01856 13.7482 9.84704 13.1302 10.471L13.8408 11.1747ZM13.2438 11.4244C13.4608 11.4244 13.6773 11.3398 13.8409 11.1745L13.1301 10.4712C13.1596 10.4414 13.2013 10.4244 13.2438 10.4244V11.4244ZM15.8458 12.0506C15.8889 12.0506 15.9312 12.0681 15.9608 12.0987L15.2412 12.7931C15.4053 12.9632 15.6252 13.0506 15.8458 13.0506V12.0506ZM15.7322 12.0974C15.7618 12.0675 15.8035 12.0506 15.8458 12.0506V13.0506C16.0628 13.0506 16.2793 12.9661 16.4429 12.8009L15.7322 12.0974ZM17.3576 8.13354C17.3576 9.63294 16.7805 11.0389 15.7323 12.0973L16.4428 12.801C17.6775 11.5543 18.3576 9.89499 18.3576 8.13354H17.3576ZM15.7322 4.16961C16.7805 5.22815 17.3576 6.63418 17.3576 8.13354H18.3576C18.3576 6.37212 17.6775 4.71279 16.4427 3.46595L15.7322 4.16961ZM15.9607 4.16822C15.8994 4.23171 15.7945 4.23249 15.7322 4.16963L16.4427 3.46593C16.11 3.13003 15.5695 3.13363 15.2412 3.47368L15.9607 4.16822ZM15.9593 3.96676C16.0154 4.02343 16.0158 4.1111 15.9607 4.16817L15.2412 3.47372C14.9191 3.80742 14.9222 4.3406 15.2487 4.67036L15.9593 3.96676ZM17.6696 8.13354C17.6696 6.56169 17.062 5.0802 15.9593 3.96673L15.2488 4.6704C16.1652 5.59574 16.6696 6.82397 16.6696 8.13354H17.6696ZM15.9594 12.3002C17.062 11.1868 17.6696 9.70542 17.6696 8.13354H16.6696C16.6696 9.44315 16.1652 10.6713 15.2489 11.5965L15.9594 12.3002ZM15.9607 12.0987C16.0159 12.1558 16.0155 12.2435 15.9593 12.3002L15.2489 11.5964C14.9223 11.9262 14.9191 12.4595 15.2413 12.7932L15.9607 12.0987Z" fill="#757575" mask="url(#mgPlayerJSProd_path-1-outside-1)"/>' +
		'</svg>',
    iconStepPlayAudioOff: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none">' +
		'<mask id="mgPlayerJSProd_path-1-outside-1" maskUnits="userSpaceOnUse" x="0" y="-0.366699" width="19" height="17" fill="black">' +
		'<rect fill="white" y="-0.366699" width="19" height="17" />' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.0755 15.5729C10.1334 15.613 10.2007 15.6333 10.2682 15.6333C10.3235 15.6333 10.3789 15.6197 10.4295 15.5922C10.542 15.5312 10.6122 15.4116 10.6122 15.2815V0.985114C10.6122 0.852045 10.5388 0.730341 10.4224 0.670632C10.3062 0.611029 10.1669 0.623485 10.0625 0.703072C10.0229 0.733296 6.12166 3.70627 3.79778 5.31987H1.34404C1.15403 5.31987 1 5.47743 1 5.67172V10.5949C1 10.7892 1.15403 10.9467 1.34404 10.9467H3.79765C4.92723 11.7312 5.91912 12.4876 6.87919 13.2197L6.87993 13.2202C7.87115 13.976 8.89613 14.7576 10.0755 15.5729ZM3.90323 10.2431H1.68808V6.02361H3.90333C3.97204 6.02361 4.03916 6.00256 4.09603 5.96323C5.90625 4.7116 8.7392 2.58106 9.92413 1.68434V14.6139C8.97669 13.9413 8.12158 13.2893 7.29049 12.6555C6.29956 11.8999 5.27491 11.1186 4.09593 10.3034C4.03902 10.2641 3.9719 10.2431 3.90323 10.2431ZM17.9084 6.53378L15.9422 8.50005L17.9084 10.4662C18.0305 10.5883 18.0305 10.7863 17.9084 10.9084C17.8473 10.9695 17.7673 11 17.6873 11C17.6074 11 17.5273 10.9695 17.4662 10.9084L15.5001 8.94211L13.5338 10.9084C13.4727 10.9695 13.3926 11 13.3127 11C13.2327 11 13.1527 10.9695 13.0916 10.9085C12.9695 10.7864 12.9695 10.5884 13.0916 10.4663L15.0579 8.50005L13.0916 6.53378C12.9695 6.41172 12.9695 6.21368 13.0916 6.09162C13.2138 5.96946 13.4116 5.96946 13.5338 6.09162L15.5001 8.05789L17.4662 6.09162C17.5884 5.96946 17.7862 5.96946 17.9084 6.09162C18.0305 6.21368 18.0305 6.41172 17.9084 6.53378Z" />' +
		'</mask>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.0755 15.5729C10.1334 15.613 10.2007 15.6333 10.2682 15.6333C10.3235 15.6333 10.3789 15.6197 10.4295 15.5922C10.542 15.5312 10.6122 15.4116 10.6122 15.2815V0.985114C10.6122 0.852045 10.5388 0.730341 10.4224 0.670632C10.3062 0.611029 10.1669 0.623485 10.0625 0.703072C10.0229 0.733296 6.12166 3.70627 3.79778 5.31987H1.34404C1.15403 5.31987 1 5.47743 1 5.67172V10.5949C1 10.7892 1.15403 10.9467 1.34404 10.9467H3.79765C4.92723 11.7312 5.91912 12.4876 6.87919 13.2197L6.87993 13.2202C7.87115 13.976 8.89613 14.7576 10.0755 15.5729ZM3.90323 10.2431H1.68808V6.02361H3.90333C3.97204 6.02361 4.03916 6.00256 4.09603 5.96323C5.90625 4.7116 8.7392 2.58106 9.92413 1.68434V14.6139C8.97669 13.9413 8.12158 13.2893 7.29049 12.6555C6.29956 11.8999 5.27491 11.1186 4.09593 10.3034C4.03902 10.2641 3.9719 10.2431 3.90323 10.2431ZM17.9084 6.53378L15.9422 8.50005L17.9084 10.4662C18.0305 10.5883 18.0305 10.7863 17.9084 10.9084C17.8473 10.9695 17.7673 11 17.6873 11C17.6074 11 17.5273 10.9695 17.4662 10.9084L15.5001 8.94211L13.5338 10.9084C13.4727 10.9695 13.3926 11 13.3127 11C13.2327 11 13.1527 10.9695 13.0916 10.9085C12.9695 10.7864 12.9695 10.5884 13.0916 10.4663L15.0579 8.50005L13.0916 6.53378C12.9695 6.41172 12.9695 6.21368 13.0916 6.09162C13.2138 5.96946 13.4116 5.96946 13.5338 6.09162L15.5001 8.05789L17.4662 6.09162C17.5884 5.96946 17.7862 5.96946 17.9084 6.09162C18.0305 6.21368 18.0305 6.41172 17.9084 6.53378Z" fill="#757575" />' +
		'<path d="M10.0755 15.5729L10.36 15.1617L10.3598 15.1616L10.0755 15.5729ZM10.4295 15.5922L10.1909 15.1528L10.1908 15.1529L10.4295 15.5922ZM10.4224 0.670632L10.6508 0.225813L10.6505 0.225677L10.4224 0.670632ZM10.0625 0.703072L10.3657 1.10066L10.3657 1.10063L10.0625 0.703072ZM3.79778 5.31987V5.81987H3.95435L4.08296 5.73058L3.79778 5.31987ZM3.79765 10.9467L4.08287 10.5361L3.95424 10.4467H3.79765V10.9467ZM6.87919 13.2197L6.57601 13.6173L6.57612 13.6173L6.87919 13.2197ZM6.87993 13.2202L7.1831 12.8226L7.183 12.8225L6.87993 13.2202ZM1.68808 10.2431H1.18808V10.7431H1.68808V10.2431ZM1.68808 6.02361V5.52361H1.18808V6.02361H1.68808ZM4.09603 5.96323L3.81167 5.55196L3.8116 5.55201L4.09603 5.96323ZM9.92413 1.68434H10.4241V0.678921L9.62241 1.28564L9.92413 1.68434ZM9.92413 14.6139L9.6347 15.0216L10.4241 15.582V14.6139H9.92413ZM7.29049 12.6555L7.59367 12.258L7.59367 12.258L7.29049 12.6555ZM4.09593 10.3034L4.38028 9.89217L4.38025 9.89215L4.09593 10.3034ZM15.9422 8.50005L15.5886 8.14651L15.2351 8.50006L15.5886 8.85361L15.9422 8.50005ZM17.9084 6.53378L17.555 6.18009L17.5548 6.18024L17.9084 6.53378ZM17.9084 10.4662L17.5548 10.8198L17.555 10.8199L17.9084 10.4662ZM17.9084 10.9084L17.555 10.5547L17.5548 10.5548L17.9084 10.9084ZM17.4662 10.9084L17.8198 10.5548L17.8198 10.5548L17.4662 10.9084ZM15.5001 8.94211L15.8536 8.58856L15.5001 8.235L15.1465 8.58855L15.5001 8.94211ZM13.5338 10.9084L13.1802 10.5548L13.1802 10.5548L13.5338 10.9084ZM13.0916 10.9085L12.7382 11.2622L12.7384 11.2623L13.0916 10.9085ZM13.0916 10.4663L13.445 10.82L13.4452 10.8199L13.0916 10.4663ZM15.0579 8.50005L15.4115 8.85361L15.765 8.50005L15.4115 8.1465L15.0579 8.50005ZM13.0916 6.53378L13.4452 6.18023L13.445 6.18009L13.0916 6.53378ZM13.0916 6.09162L13.445 6.44532L13.4452 6.44517L13.0916 6.09162ZM13.5338 6.09162L13.1802 6.44517L13.1802 6.44518L13.5338 6.09162ZM15.5001 8.05789L15.1465 8.41145L15.5001 8.765L15.8536 8.41144L15.5001 8.05789ZM17.4662 6.09162L17.1127 5.73807L17.1127 5.73808L17.4662 6.09162ZM17.9084 6.09162L17.5548 6.44517L17.555 6.44532L17.9084 6.09162ZM10.2682 15.1333C10.3011 15.1333 10.3333 15.1433 10.36 15.1617L9.79098 15.9841C9.93362 16.0828 10.1004 16.1333 10.2682 16.1333V15.1333ZM10.1908 15.1529C10.2145 15.14 10.2413 15.1333 10.2682 15.1333V16.1333C10.4056 16.1333 10.5433 16.0994 10.6682 16.0315L10.1908 15.1529ZM10.1122 15.2815C10.1122 15.2324 10.1387 15.1812 10.1909 15.1528L10.6681 16.0316C10.9452 15.8811 11.1122 15.5908 11.1122 15.2815H10.1122ZM10.1122 0.985114V15.2815H11.1122V0.985114H10.1122ZM10.1941 1.11545C10.14 1.08766 10.1122 1.03536 10.1122 0.985114H11.1122C11.1122 0.668733 10.9376 0.373023 10.6508 0.225813L10.1941 1.11545ZM10.3657 1.10063C10.3173 1.13753 10.25 1.14412 10.1944 1.11559L10.6505 0.225677C10.3623 0.0779435 10.0164 0.109434 9.75928 0.305513L10.3657 1.10063ZM4.08296 5.73058C6.41776 4.10938 10.3283 1.12917 10.3657 1.10066L9.75931 0.305489C9.71744 0.337422 5.82555 3.30316 3.51261 4.90917L4.08296 5.73058ZM1.34404 5.81987H3.79778V4.81987H1.34404V5.81987ZM1.5 5.67172C1.5 5.7429 1.44072 5.81987 1.34404 5.81987V4.81987C0.86733 4.81987 0.5 5.21196 0.5 5.67172H1.5ZM1.5 10.5949V5.67172H0.5V10.5949H1.5ZM1.34404 10.4467C1.44072 10.4467 1.5 10.5237 1.5 10.5949H0.5C0.5 11.0546 0.86733 11.4467 1.34404 11.4467V10.4467ZM3.79765 10.4467H1.34404V11.4467H3.79765V10.4467ZM7.18237 12.8221C6.22304 12.0905 5.22283 11.3278 4.08287 10.5361L3.51243 11.3574C4.63163 12.1347 5.6152 12.8846 6.57601 13.6173L7.18237 12.8221ZM7.183 12.8225L7.18226 12.822L6.57612 13.6173L6.57686 13.6179L7.183 12.8225ZM10.3598 15.1616C9.19134 14.3538 8.17504 13.579 7.1831 12.8226L6.57676 13.6178C7.56726 14.3731 8.60092 15.1613 9.79114 15.9842L10.3598 15.1616ZM1.68808 10.7431H3.90323V9.74307H1.68808V10.7431ZM1.18808 6.02361V10.2431H2.18808V6.02361H1.18808ZM3.90333 5.52361H1.68808V6.52361H3.90333V5.52361ZM3.8116 5.55201C3.83767 5.53398 3.86963 5.52361 3.90333 5.52361V6.52361C4.07444 6.52361 4.24065 6.47115 4.38046 6.37444L3.8116 5.55201ZM9.62241 1.28564C8.43606 2.18343 5.61161 4.30744 3.81167 5.55196L4.38039 6.37449C6.2009 5.11576 9.04234 2.97869 10.2259 2.08304L9.62241 1.28564ZM10.4241 14.6139V1.68434H9.42413V14.6139H10.4241ZM6.98731 13.0531C7.81773 13.6864 8.6793 14.3434 9.6347 15.0216L10.2136 14.2062C9.27408 13.5392 8.42544 12.8922 7.59367 12.258L6.98731 13.0531ZM3.81157 10.7147C4.97969 11.5224 5.99566 12.297 6.98731 13.0531L7.59367 12.258C6.60345 11.5029 5.57013 10.7148 4.38028 9.89217L3.81157 10.7147ZM3.90323 10.7431C3.86945 10.7431 3.83755 10.7327 3.8116 10.7147L4.38025 9.89215C4.2405 9.79554 4.07435 9.74307 3.90323 9.74307V10.7431ZM16.2958 8.8536L18.2619 6.88733L17.5548 6.18024L15.5886 8.14651L16.2958 8.8536ZM18.2619 10.1127L16.2957 8.1465L15.5886 8.85361L17.5548 10.8198L18.2619 10.1127ZM18.2618 11.2621C18.5794 10.9447 18.5794 10.4299 18.2618 10.1125L17.555 10.8199C17.4817 10.7467 17.4817 10.6279 17.555 10.5547L18.2618 11.2621ZM17.6873 11.5C17.8946 11.5 18.1034 11.4205 18.2619 11.2619L17.5548 10.5548C17.5912 10.5184 17.64 10.5 17.6873 10.5V11.5ZM17.1127 11.2619C17.2712 11.4205 17.4801 11.5 17.6873 11.5V10.5C17.7347 10.5 17.7834 10.5184 17.8198 10.5548L17.1127 11.2619ZM15.1465 9.29565L17.1127 11.2619L17.8198 10.5548L15.8536 8.58856L15.1465 9.29565ZM13.8873 11.2619L15.8536 9.29566L15.1465 8.58855L13.1802 10.5548L13.8873 11.2619ZM13.3127 11.5C13.5199 11.5 13.7288 11.4205 13.8873 11.2619L13.1802 10.5548C13.2166 10.5184 13.2653 10.5 13.3127 10.5V11.5ZM12.7384 11.2623C12.8968 11.4205 13.1055 11.5 13.3127 11.5V10.5C13.36 10.5 13.4086 10.5184 13.4449 10.5546L12.7384 11.2623ZM12.7382 10.1126C12.4206 10.43 12.4206 10.9448 12.7382 11.2622L13.445 10.5548C13.5183 10.628 13.5183 10.7468 13.445 10.82L12.7382 10.1126ZM14.7044 8.1465L12.7381 10.1128L13.4452 10.8199L15.4115 8.85361L14.7044 8.1465ZM12.7381 6.88734L14.7044 8.85361L15.4115 8.1465L13.4452 6.18023L12.7381 6.88734ZM12.7382 5.73792C12.4206 6.05528 12.4206 6.57013 12.7382 6.88748L13.445 6.18009C13.5183 6.25332 13.5183 6.37208 13.445 6.44532L12.7382 5.73792ZM13.8873 5.73808C13.5699 5.42064 13.0555 5.42064 12.7381 5.73808L13.4452 6.44517C13.3721 6.51828 13.2533 6.51828 13.1802 6.44517L13.8873 5.73808ZM15.8536 7.70434L13.8873 5.73807L13.1802 6.44518L15.1465 8.41145L15.8536 7.70434ZM17.1127 5.73808L15.1465 7.70435L15.8536 8.41144L17.8198 6.44517L17.1127 5.73808ZM18.2619 5.73807C17.9445 5.42064 17.4301 5.42064 17.1127 5.73807L17.8198 6.44517C17.7467 6.51828 17.6279 6.51828 17.5548 6.44517L18.2619 5.73807ZM18.2618 6.88748C18.5794 6.57013 18.5794 6.05528 18.2618 5.73793L17.555 6.44532C17.4817 6.37208 17.4817 6.25332 17.555 6.18009L18.2618 6.88748Z" fill="#757575" mask="url(#mgPlayerJSProd_path-1-outside-1)" />' +
		'</svg>',
    popup_info: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none">' +
		'<circle cx="12" cy="12" r="11.1" stroke="white" stroke-width="1.8"/>' +
		'<rect x="11" y="11" width="2" height="9" rx="1" fill="white"/>' +
		'<circle cx="12" cy="7.5" r="1.5" fill="white"/>' +
		'</svg>',
    fullscreen: '<svg version="1.1" class="mgPlayerJSProd_Capa_1" x="0px" y="0px" viewBox="0 0 28.361 28.361" style="enable-background:new 0 0 28.361 28.361;" xml:space="preserve">' +
		'<g>' +
		'<g class="mgPlayerJSProd_c115_arrows">' +
		'<path d="M28.36,19.595c0-0.868-0.665-1.57-1.491-1.57c-0.819,0.002-1.492,0.702-1.492,1.57v3.25l-6.018-6.021 c-0.582-0.583-1.524-0.583-2.106,0c-0.582,0.582-0.582,1.527,0,2.109l5.989,5.987h-3.235c-0.881,0.002-1.591,0.669-1.591,1.491 c0,0.824,0.71,1.49,1.591,1.49h6.761c0.881,0,1.59-0.665,1.593-1.49c-0.003-0.022-0.006-0.039-0.009-0.061 c0.003-0.028,0.009-0.058,0.009-0.087v-6.668H28.36z"/>' +
		'<path d="M9,16.824l-6.015,6.021v-3.25c0-0.868-0.672-1.568-1.493-1.57c-0.824,0-1.49,0.702-1.49,1.57L0,26.264 c0,0.029,0.008,0.059,0.01,0.087c-0.002,0.021-0.006,0.038-0.008,0.061c0.002,0.825,0.712,1.49,1.592,1.49h6.762 c0.879,0,1.59-0.666,1.59-1.49c0-0.822-0.711-1.489-1.59-1.491H5.121l5.989-5.987c0.58-0.582,0.58-1.527,0-2.109 C10.527,16.241,9.584,16.241,9,16.824z"/>' +
		'<path d="M19.359,11.535l6.018-6.017v3.25c0,0.865,0.673,1.565,1.492,1.568c0.826,0,1.491-0.703,1.491-1.568V2.097 c0-0.029-0.006-0.059-0.009-0.085c0.003-0.021,0.006-0.041,0.009-0.062c-0.003-0.826-0.712-1.491-1.592-1.491h-6.761 c-0.881,0-1.591,0.665-1.591,1.491c0,0.821,0.71,1.49,1.591,1.492h3.235l-5.989,5.987c-0.582,0.581-0.582,1.524,0,2.105 C17.835,12.12,18.777,12.12,19.359,11.535z"/>' +
		'<path d="M5.121,3.442h3.234c0.879-0.002,1.59-0.671,1.59-1.492c0-0.826-0.711-1.491-1.59-1.491H1.594 c-0.88,0-1.59,0.665-1.592,1.491C0.004,1.971,0.008,1.991,0.01,2.012C0.008,2.038,0,2.067,0,2.097l0.002,6.672 c0,0.865,0.666,1.568,1.49,1.568c0.821-0.003,1.493-0.703,1.493-1.568v-3.25L9,11.535c0.584,0.585,1.527,0.585,2.11,0 c0.58-0.581,0.58-1.524,0-2.105L5.121,3.442z"/>' +
		'</g>' +
		'<g class="mgPlayerJSProd_Capa_1_253_">' +
		'</g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'</svg>',
    close_btn: '<svg width="10px" height="10px" viewBox="0 0 14 14" version="1.1" >' +
		'<defs></defs>' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_step-action-icons" transform="translate(-6.000000, -6.000000)" fill-rule="nonzero" fill="#FFFFFF">' +
		'<g class="mgPlayerJSProd_down-arrow-copy" transform="translate(5.000000, 5.000000)">' +
		'<g class="mgPlayerJSProd_download-arrow" transform="translate(1.000000, 1.000000)">' +
		'<path d="M6.81388436,5.99990412 L11.8314316,0.982437076 C12.0561895,0.757682781 12.0561895,0.393320016 11.8314316,0.168565721 C11.6066737,-0.0561885737 11.2423051,-0.0561885737 11.0175472,0.168565721 L6,5.18603276 L0.982452776,0.169332801 C0.757694889,-0.0554214942 0.393326302,-0.0554214942 0.168568415,0.169332801 C-0.0561894717,0.394087095 -0.0561894717,0.75844986 0.168568415,0.983204155 L5.18611564,6.00067119 L0.169335507,11.0173712 C-0.0554223799,11.2421254 -0.0554223799,11.6064882 0.169335507,11.8312425 C0.282097996,11.9432361 0.428612523,12 0.575894141,12 C0.72317576,12 0.870457378,11.9440032 0.982452776,11.8312425 L6,6.81377547 L11.0175472,11.8312425 C11.1303097,11.9432361 11.2768242,12 11.4241059,12 C11.5713875,12 11.7186691,11.9440032 11.8306645,11.8312425 C12.0554224,11.6064882 12.0554224,11.2421254 11.8306645,11.0173712 L6.81388436,5.99990412 Z" class="mgPlayerJSProd_shape"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    down_arrow: '<svg width="16" height="20" viewBox="0 0 16 20" fill="none" >' +
		'<path d="M7.35176 19.0648C7.35193 19.065 7.3521 19.0651 7.35227 19.0653C7.37346 19.0865 7.39576 19.1065 7.41892 19.1256C7.42953 19.1343 7.44075 19.1418 7.45166 19.15C7.46468 19.1598 7.47744 19.1699 7.49098 19.179C7.50404 19.1877 7.51757 19.1952 7.53098 19.2032C7.54327 19.2106 7.55526 19.2183 7.56789 19.225C7.58156 19.2323 7.59561 19.2385 7.60957 19.2451C7.62272 19.2513 7.6357 19.2579 7.64919 19.2635C7.66272 19.2691 7.67656 19.2736 7.69031 19.2785C7.70479 19.2837 7.71906 19.2893 7.73384 19.2937C7.74759 19.2979 7.76155 19.301 7.77547 19.3044C7.79056 19.3083 7.80547 19.3125 7.82085 19.3155C7.83696 19.3187 7.8532 19.3206 7.8694 19.3229C7.88277 19.3248 7.89596 19.3274 7.90949 19.3287C7.96965 19.3346 8.03028 19.3346 8.09043 19.3287C8.10397 19.3274 8.11716 19.3248 8.13052 19.3229C8.14672 19.3206 8.16297 19.3187 8.17908 19.3155C8.19446 19.3125 8.20937 19.3083 8.22445 19.3044C8.23833 19.301 8.25234 19.2979 8.26609 19.2937C8.28087 19.2893 8.29518 19.2837 8.30962 19.2785C8.32337 19.2736 8.3372 19.2691 8.35074 19.2635C8.36423 19.2579 8.37721 19.2513 8.39036 19.2451C8.40432 19.2385 8.41837 19.2323 8.43204 19.225C8.44467 19.2183 8.45666 19.2105 8.46895 19.2032C8.48235 19.1952 8.49589 19.1877 8.50895 19.179C8.52249 19.1699 8.53525 19.1598 8.54827 19.15C8.55918 19.1419 8.5704 19.1343 8.58101 19.1256C8.60417 19.1065 8.62647 19.0865 8.64765 19.0653C8.64782 19.0651 8.648 19.065 8.64817 19.0648L15.0648 12.6482C15.4228 12.2902 15.4228 11.7098 15.0648 11.3518C14.7068 10.9938 14.1264 10.9938 13.7685 11.3518L8.91659 16.2036V1.91665C8.91659 1.41039 8.5062 1 7.99994 1C7.49368 1 7.08329 1.41039 7.08329 1.91665V16.2036L2.23147 11.3518C1.8735 10.9938 1.29308 10.9938 0.935105 11.3518C0.577133 11.7098 0.577133 12.2902 0.935105 12.6482L7.35176 19.0648Z" fill="#ffffff" stroke="#ffffff" stroke-width="0.7" />' +
		'</svg>',
    close_resume: '<svg width="15" height="15" viewBox="0 0 15 15" fill="none" >' +
		'<path d="M8.97536 7.53536L14.9293 13.4893L13.4893 14.9293L7.53536 8.97536L7.5 8.94L7.46464 8.97536L1.51071 14.9293L0.0707109 13.4893L6.02464 7.53536L6.06 7.5L6.02464 7.46464L0.0707107 1.51071L1.51071 0.0707107L7.46464 6.02464L7.5 6.06L7.53536 6.02464L13.4893 0.0707109L14.9293 1.51071L8.97536 7.46464L8.94 7.5L8.97536 7.53536Z" fill="white" stroke="white" stroke-width="0.1" />' +
		'</svg>',
    resume: '<svg width="30" height="30" viewBox="0 0 30 30" fill="none" >' +
		'<circle cx="15" cy="15" r="15" fill="#26273b" />' +
		'<path d="M12 8L22.3846 15.5L12 23V8Z" fill="white" />' +
		'</svg>',
    popup_close: '<svg viewBox="0 0 11 11" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.800000012">' +
		'<g class="mgPlayerJSProd_Desktop" transform="translate(-598.000000, -109.000000)" fill="#333333">' +
		'<g class="mgPlayerJSProd_Group-3" transform="translate(546.000000, 108.000000)">' +
		'<path d="M58.3537478,6.51267909 L62.8600942,1.9175241 C63.0539691,1.70602684 63.0453206,1.37891815 62.8405407,1.1779615 C62.6357608,0.97700485 62.3085543,0.974528998 62.1007571,1.17236383 L57.6015073,5.76042205 L52.9177457,1.16526706 C52.7836541,1.02441675 52.5834203,0.967912822 52.3954816,1.01788948 C52.2075429,1.06786613 52.0618215,1.21636649 52.0154005,1.40521871 C51.9689795,1.59407093 52.0292498,1.79320748 52.1726018,1.92462086 L56.8492668,6.51267909 L52.1726018,11.1007373 C51.9747713,11.3085392 51.9772471,11.6357528 52.1781993,11.8405372 C52.3791516,12.0453216 52.7062531,12.0539703 52.9177457,11.8600911 L57.6015073,7.26493612 L62.1007571,11.8529943 C62.3085543,12.0508292 62.6357608,12.0483533 62.8405407,11.8473967 C63.0453206,11.64644 63.0539691,11.3193313 62.8600942,11.1078341 L58.3537478,6.51267909 Z" class="mgPlayerJSProd_shape"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    micro_drag: '<svg viewBox="0 0 23 23" fill="none" >' +
		'<path d="M8.67297 4.91634L10.6347 2.95457V8.34838C10.6347 8.57787 10.7259 8.79796 10.8882 8.96023C11.0504 9.1225 11.2705 9.21367 11.5 9.21367C11.7295 9.21367 11.9496 9.1225 12.1119 8.96023C12.2741 8.79796 12.3653 8.57787 12.3653 8.34838V2.95388L14.3278 4.91634C14.49 5.07863 14.7102 5.16981 14.9397 5.16981C15.1692 5.16981 15.3893 5.07863 15.5516 4.91634C15.7139 4.75404 15.8051 4.53393 15.8051 4.30441C15.8051 4.07489 15.7139 3.85478 15.5516 3.69249L12.1119 0.253516C12.0316 0.173143 11.9362 0.109386 11.8312 0.0658876C11.7262 0.0223889 11.6137 0 11.5 0C11.3864 0 11.2738 0.0223889 11.1688 0.0658876C11.0638 0.109386 10.9684 0.173143 10.8881 0.253516L7.44912 3.69249C7.29146 3.85564 7.20418 4.07418 7.20609 4.30106C7.20799 4.52793 7.29893 4.74498 7.45932 4.90545C7.6197 5.06593 7.8367 5.15699 8.06357 5.15903C8.29045 5.16106 8.50904 5.07391 8.67228 4.91634H8.67297Z" fill="white" />' +
		'<path d="M14.3277 18.0832L12.3653 20.0456V14.6511C12.3653 14.4216 12.2741 14.2015 12.1118 14.0393C11.9496 13.877 11.7295 13.7858 11.5 13.7858C11.2705 13.7858 11.0504 13.877 10.8882 14.0393C10.7259 14.2015 10.6347 14.4216 10.6347 14.6511V20.0449L8.67295 18.0825C8.50918 17.9281 8.2917 17.8436 8.06665 17.8469C7.8416 17.8502 7.6267 17.9411 7.46755 18.1002C7.3084 18.2594 7.21752 18.4743 7.21421 18.6993C7.21089 18.9244 7.2954 19.1419 7.44979 19.3056L10.8888 22.7453C10.9691 22.8257 11.0645 22.8894 11.1695 22.9329C11.2745 22.9764 11.387 22.9988 11.5007 22.9988C11.6143 22.9988 11.7269 22.9764 11.8319 22.9329C11.9369 22.8894 12.0323 22.8257 12.1126 22.7453L15.5523 19.3056C15.7098 19.1424 15.797 18.9238 15.795 18.6969C15.7929 18.47 15.7019 18.253 15.5414 18.0927C15.3809 17.9323 15.1639 17.8413 14.937 17.8394C14.7101 17.8375 14.4916 17.9248 14.3284 18.0825L14.3277 18.0832Z" fill="white" />' +
		'<path d="M2.95457 12.3647H8.34838C8.57787 12.3647 8.79796 12.2735 8.96023 12.1112C9.1225 11.949 9.21367 11.7289 9.21367 11.4994C9.21367 11.2699 9.1225 11.0498 8.96023 10.8875C8.79796 10.7253 8.57787 10.6341 8.34838 10.6341H2.95457L4.91634 8.67234C5.07391 8.50911 5.16106 8.29051 5.15903 8.06363C5.15699 7.83676 5.06593 7.61976 4.90545 7.45938C4.74498 7.29899 4.52793 7.20805 4.30106 7.20615C4.07418 7.20424 3.85564 7.29152 3.69249 7.44918L0.253515 10.8882C0.173142 10.9685 0.109385 11.0639 0.0658863 11.1689C0.0223876 11.2739 0 11.3864 0 11.5001C0 11.6137 0.0223876 11.7263 0.0658863 11.8313C0.109385 11.9363 0.173142 12.0317 0.253515 12.112L3.69249 15.5517C3.77285 15.632 3.86825 15.6958 3.97324 15.7393C4.07823 15.7828 4.19077 15.8051 4.30441 15.8051C4.41806 15.8051 4.53059 15.7828 4.63558 15.7393C4.74058 15.6958 4.83598 15.632 4.91634 15.5517C4.9967 15.4713 5.06044 15.3759 5.10393 15.2709C5.14742 15.1659 5.16981 15.0534 5.16981 14.9397C5.16981 14.8261 5.14742 14.7136 5.10393 14.6086C5.06044 14.5036 4.9967 14.4082 4.91634 14.3278L2.95457 12.3647Z" fill="white" />' +
		'<path d="M22.9999 11.4994C22.9999 11.3858 22.9775 11.2732 22.9341 11.1682C22.8906 11.0632 22.8269 10.9678 22.7465 10.8875L19.3069 7.44851C19.1431 7.29412 18.9256 7.20961 18.7006 7.21292C18.4755 7.21624 18.2606 7.30711 18.1015 7.46627C17.9423 7.62542 17.8514 7.84032 17.8481 8.06537C17.8448 8.29042 17.9293 8.5079 18.0837 8.67167L20.0462 10.6334H14.6517C14.4222 10.6334 14.2021 10.7246 14.0398 10.8869C13.8775 11.0491 13.7864 11.2692 13.7864 11.4987C13.7864 11.7282 13.8775 11.9483 14.0398 12.1106C14.2021 12.2728 14.4222 12.364 14.6517 12.364H20.0455L18.083 14.3265C18.0003 14.4062 17.9344 14.5017 17.889 14.6073C17.8436 14.7128 17.8197 14.8264 17.8187 14.9412C17.8177 15.0561 17.8395 15.1701 17.883 15.2764C17.9265 15.3828 17.9907 15.4794 18.0719 15.5607C18.1532 15.6419 18.2498 15.7062 18.3561 15.7498C18.4624 15.7933 18.5763 15.8152 18.6912 15.8143C18.8061 15.8133 18.9197 15.7895 19.0253 15.7441C19.1308 15.6988 19.2263 15.6329 19.3062 15.5503L22.7458 12.1106C22.9082 11.9486 22.9996 11.7288 22.9999 11.4994Z" fill="white" />' +
		'</svg>',
    mplayer_close: '<svg class="mgPlayerJSProd_position-center mgPlayerJSProd_width-height-100" viewBox="0 0 22 22" fill="none" >' +
		'<path d="M3.32401 3.32414C7.55657 -0.908416 14.4435 -0.908 18.6756 3.32414C22.9077 7.55627 22.9077 14.4432 18.6756 18.6757C14.443 22.9083 7.55615 22.9083 3.32402 18.6757C-0.908127 14.4432 -0.908535 7.55669 3.32401 3.32414ZM14.0365 15.4458C14.4257 15.835 15.0565 15.835 15.4457 15.4458C15.8348 15.0567 15.8348 14.4258 15.4457 14.0367L12.409 10.9999L15.2958 8.11304C15.685 7.72388 15.685 7.09305 15.2958 6.70389C14.9067 6.31474 14.2759 6.31474 13.8867 6.70389L10.9998 9.59079L7.96308 6.55405C7.57392 6.1649 6.94309 6.1649 6.55393 6.55405C6.16472 6.94284 6.16484 7.57411 6.55393 7.9632L9.59066 10.9999L6.40452 14.1861C6.01536 14.5752 6.01536 15.2061 6.40452 15.5952C6.79367 15.9844 7.42451 15.9844 7.81366 15.5952L10.9998 12.4091L14.0365 15.4458Z" fill="white" stroke="#7BA827" stroke-width="0.3" />' +
		'</svg>',

    close: '<svg height="15px" width="15px" version="1.1" class="mgPlayerJSProd_Capa_1" x="0px" y="0px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve"><g><g><path d="M46,4C44.9,3,43.2,3,42.1,4L25,21.2L7.9,4C6.8,3,5.1,3,4,4S3,6.8,4,7.9L21.2,25L4,42.1C3,43.2,3,44.9,4,46c0.5,0.5,1.2,0.8,1.9,0.8s1.4-0.3,1.9-0.8L25,28.8L42.1,46c0.5,0.5,1.2,0.8,1.9,0.8c0.7,0,1.4-0.3,1.9-0.8c1.1-1.1,1.1-2.8,0-3.8L28.8,25L46,7.9C47,6.8,47,5.1,46,4z"></path></g></g></svg>',

    slideshow_drag: '<svg width="16" height="16" viewBox="0 0 16 16">' +
		'<g fill="#FFFFFE" fill-rule="evenodd">' +
		'<path d="M10.8 11.825l-2.071 2.06V1.638l2.07 2.06c.191.194.5.194.691 0a.486.486 0 0 0 0-.688L8.61.14a.47.47 0 0 0-.37-.136.47.47 0 0 0-.37.136L4.992 3.01c-.19.194-.19.5 0 .689.19.193.5.193.69 0l2.072-2.061v12.247l-2.071-2.06a.482.482 0 0 0-.69 0 .486.486 0 0 0 0 .688l2.879 2.87a.47.47 0 0 0 .37.136.47.47 0 0 0 .37-.136l2.88-2.87c.19-.194.19-.5 0-.688a.482.482 0 0 0-.691 0"/>' +
		'<path d="M4.178 10.32l-2.06-2.07h12.246l-2.06 2.07a.482.482 0 0 0 0 .691c.189.19.494.19.688 0l2.87-2.88a.47.47 0 0 0 .136-.37.47.47 0 0 0-.135-.37l-2.87-2.879a.486.486 0 0 0-.69 0 .482.482 0 0 0 0 .69l2.061 2.071H2.117l2.06-2.07a.482.482 0 0 0 0-.69.486.486 0 0 0-.688 0L.62 7.391a.47.47 0 0 0-.136.369.47.47 0 0 0 .136.37l2.87 2.88c.194.19.5.19.689 0a.482.482 0 0 0 0-.69"/>' +
		'</g>' +
		'</svg>',
    close_popup: '<svg width="12" height="12" viewBox="0 0 12 13" fill="none" >' +
		'<path d="M6.90481 6.67981L11.5191 1.96076C11.8058 1.66783 11.8058 1.19252 11.5191 0.89958C11.2324 0.60639 10.7682 0.60639 10.4815 0.89958L5.86718 5.61863L1.25264 0.89958C0.965959 0.60639 0.501692 0.60639 0.215011 0.89958C-0.0716703 1.19252 -0.0716703 1.66783 0.215011 1.96076L4.82955 6.67981L0.215011 11.3989C-0.0716703 11.6918 -0.0716703 12.1671 0.215011 12.46C0.358352 12.6064 0.546211 12.6797 0.733826 12.6797C0.92144 12.6797 1.1093 12.6064 1.25264 12.4598L5.86718 7.74075L10.4815 12.4598C10.6248 12.6064 10.8127 12.6797 11.0003 12.6797C11.1879 12.6797 11.3758 12.6064 11.5191 12.4598C11.8058 12.1669 11.8058 11.6915 11.5191 11.3986L6.90481 6.67981Z" fill="#666666" fill-opacity="0.9" />' +
		'</svg>',
    external_link: '<svg class="mgPlayerJSProd_position-center mgPlayerJSProd_width-height-100" viewBox="0 0 17 18" fill="none" >' +
		'<g clip-path="url(#clip)">' +
		'<path d="M13.0266 5.10103C13.1992 5.13132 13.3496 5.22781 13.4505 5.37282C13.5517 5.51647 13.5909 5.69066 13.5604 5.86336L13.4619 5.84599C13.4877 5.69966 13.4547 5.55242 13.3687 5.4304L13.3684 5.42995C13.2825 5.30656 13.1554 5.22515 13.0094 5.19952L13.0093 5.19951L6.98281 4.13688C6.98279 4.13688 6.98278 4.13687 6.98277 4.13687C6.8371 4.11126 6.69018 4.14394 6.56783 4.22962C6.44567 4.31515 6.36472 4.44211 6.33891 4.58775C6.33891 4.58776 6.33891 4.58777 6.3389 4.58778L6.24258 5.13487L6.24255 5.13501C6.21672 5.28049 6.24947 5.4274 6.33513 5.54973C6.4199 5.6708 6.54116 5.74565 6.68823 5.77146L10.2384 6.39115L10.4768 6.43276L10.2786 6.57157L3.68558 11.1881C3.43578 11.363 3.37455 11.7299 3.55106 11.982L3.86985 12.4372C4.0391 12.679 4.38546 12.7337 4.63939 12.568L4.63756 12.5646L11.2152 7.9589L11.4127 7.82064L11.3711 8.05807L10.7544 11.5783L10.7543 11.5784C10.7287 11.7237 10.7626 11.8729 10.8485 11.9955C10.9343 12.118 11.0621 12.2002 11.2079 12.226L11.755 12.3226C11.755 12.3226 11.755 12.3226 11.755 12.3226C11.9009 12.3483 12.048 12.3158 12.17 12.2304C12.2923 12.1447 12.3734 12.0178 12.3991 11.8722L12.3991 11.8722L13.4619 5.84599L13.0266 5.10103ZM13.0266 5.10103L7.00013 4.03839L13.0266 5.10103Z" fill="#666666" stroke="white" stroke-width="0.2" />' +
		'</g>' +
		'<defs>' +
		'<clipPath class="mgPlayerJSProd_clip">' +
		'<rect width="12" height="12" fill="white" transform="translate(16.8906 10.2871) rotate(145)" />' +
		'</clipPath>' +
		'</defs>' +
		'</svg>',
    testme_result_passed: '<svg width="33px" height="37px" viewBox="0 0 33 37" version="1.1" >' +
		'<defs></defs>' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_Test-Result-for-TestMe-01" transform="translate(-654.000000, -232.000000)" fill-rule="nonzero" fill="#59A847">' +
		'<g class="mgPlayerJSProd_Group-35" transform="translate(407.000000, 180.000000)">' +
		'<g class="mgPlayerJSProd_Group-34" transform="translate(14.000000, 41.000000)">' +
		'<g class="mgPlayerJSProd_like-(2)" transform="translate(229.000000, 9.000000)">' +
		'<path d="M36.1574,25.1045131 C36.681,24.5365796 37,23.7869359 37,22.9667458 C37,21.1988124 35.5194,19.760095 33.7,19.760095 L27.2950667,19.760095 C27.9294,17.8895487 28.2,15.407601 28.2,14.3437055 L28.2,13.2755344 C28.2,10.9182898 26.2258667,9 23.8,9 L22.7,9 C22.1954667,9 21.7554667,9.33349169 21.633,9.80950119 L21.0338667,12.1389549 C20.1942,15.4011876 17.5285333,19.0004751 14.7697333,19.6546318 C14.2864667,18.4660333 13.0933333,17.6223278 11.7,17.6223278 L5.1,17.6223278 C4.4928,17.6223278 4,18.1011876 4,18.6912114 L4,37.9311164 C4,38.5211401 4.4928,39 5.1,39 L11.7,39 C13.0119333,39 14.1471333,38.2524941 14.6788,37.172209 L18.4584,38.3964371 C19.6940667,38.7969121 20.9818,39 22.2849333,39 L31.5,39 C33.3194,39 34.8,37.5612827 34.8,35.7933492 C34.8,35.3764846 34.7178667,34.9774347 34.5682667,34.6118765 C35.9674667,34.2406176 37,32.9942993 37,31.5178147 C37,30.6976247 36.681,29.947981 36.1574,29.3800475 C36.681,28.812114 37,28.0624703 37,27.2422803 C37,26.4220903 36.681,25.6724466 36.1574,25.1045131 Z M12.8,35.7933492 C12.8,36.3826603 12.3064667,36.8622328 11.7,36.8622328 L6.2,36.8622328 L6.2,19.760095 L11.7,19.760095 C12.3064667,19.760095 12.8,20.2396675 12.8,20.8289786 L12.8,35.7933492 Z M31.5,26.1733967 L33.7,26.1733967 C34.3064667,26.1733967 34.8,26.6529691 34.8,27.2422803 C34.8,27.8315914 34.3064667,28.3111639 33.7,28.3111639 L31.5,28.3111639 C30.8928,28.3111639 30.4,28.7900238 30.4,29.3800475 C30.4,29.9700713 30.8928,30.4489311 31.5,30.4489311 L33.7,30.4489311 C34.3064667,30.4489311 34.8,30.9285036 34.8,31.5178147 C34.8,32.1071259 34.3064667,32.5866983 33.7,32.5866983 L31.5,32.5866983 C30.8928,32.5866983 30.4,33.0655582 30.4,33.6555819 C30.4,34.2456057 30.8928,34.7244656 31.5,34.7244656 C32.1064667,34.7244656 32.6,35.204038 32.6,35.7933492 C32.6,36.3826603 32.1064667,36.8622328 31.5,36.8622328 L22.2849333,36.8622328 C21.2186667,36.8622328 20.1648667,36.6961995 19.1536,36.3684086 L15,35.0230404 L15,21.7966746 C16.7255333,21.4781473 18.4144,20.4163895 19.939,18.6783848 C21.4276667,16.9809976 22.6347333,14.7306413 23.1678667,12.6577197 L23.5587333,11.1377672 L23.8,11.1377672 C25.0129333,11.1377672 26,12.0969121 26,13.2755344 L26,14.3437055 C26,15.7788599 25.538,18.5315914 24.9469333,19.760095 L22.7,19.760095 C22.0928,19.760095 21.6,20.2389549 21.6,20.8289786 C21.6,21.4190024 22.0928,21.8978622 22.7,21.8978622 L33.7,21.8978622 C34.3064667,21.8978622 34.8,22.3774347 34.8,22.9667458 C34.8,23.556057 34.3064667,24.0356295 33.7,24.0356295 L31.5,24.0356295 C30.8928,24.0356295 30.4,24.5144893 30.4,25.1045131 C30.4,25.6945368 30.8928,26.1733967 31.5,26.1733967 Z" class="mgPlayerJSProd_shape"></path>' +
		'<circle class="mgPlayerJSProd_Oval" cx="9" cy="33" r="1"></circle>' +
		'<path d="M24,2 C23.4477333,2 23,2.44039344 23,2.98360656 L23,5.01639344 C23,5.55960656 23.4477333,6 24,6 C24.5522667,6 25,5.55960656 25,5.01639344 L25,2.98360656 C25,2.44039344 24.5522667,2 24,2 Z" class="mgPlayerJSProd_shape"></path>' +
		'<path d="M19.7426337,6.50001098 L18.5,5.25736818 C18.1569035,4.91421061 17.6005214,4.91421061 17.2573663,5.25736818 C16.9142112,5.60052575 16.9142112,6.15685341 17.2573663,6.50001098 L18.5,7.74265379 C18.8430965,8.08575278 19.3995372,8.08581136 19.7426337,7.74265379 C20.0857888,7.39949622 20.0857888,6.84316855 19.7426337,6.50001098 Z" class="mgPlayerJSProd_shape"></path>' +
		'<path d="M31.7426337,5.25736881 C31.3995372,4.9142104 30.8431551,4.9142104 30.5,5.25736881 L29.2573663,6.49995606 C28.9142112,6.84311447 28.9142112,7.39944349 29.2573663,7.7426019 C29.6004628,8.08576031 30.1568449,8.08581889 30.5,7.74266048 L31.7426337,6.50001464 C32.0857888,6.15685624 32.0857888,5.60052721 31.7426337,5.25736881 Z" class="mgPlayerJSProd_shape"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    testme_result_failed: '<svg width="33px" height="30px" viewBox="0 0 33 30" version="1.1" >' +
		'<defs></defs>' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_Test-Result-for-TestMe-02" transform="translate(-654.000000, -239.000000)" fill-rule="nonzero" fill="#F04A5F">' +
		'<g class="mgPlayerJSProd_Group-35" transform="translate(407.000000, 180.000000)">' +
		'<g class="mgPlayerJSProd_Group-34" transform="translate(14.000000, 41.000000)">' +
		'<g class="mgPlayerJSProd_like-(2)" transform="translate(249.000000, 31.000000) scale(1, -1) translate(-249.000000, -31.000000) translate(230.000000, 11.000000)">' +
		'<path d="M35.1574,19.1045131 C35.681,18.5365796 36,17.7869359 36,16.9667458 C36,15.1988124 34.5194,13.760095 32.7,13.760095 L26.2950667,13.760095 C26.9294,11.8895487 27.2,9.40760095 27.2,8.34370546 L27.2,7.27553444 C27.2,4.91828979 25.2258667,3 22.8,3 L21.7,3 C21.1954667,3 20.7554667,3.33349169 20.633,3.80950119 L20.0338667,6.13895487 C19.1942,9.40118765 16.5285333,13.0004751 13.7697333,13.6546318 C13.2864667,12.4660333 12.0933333,11.6223278 10.7,11.6223278 L4.1,11.6223278 C3.4928,11.6223278 3,12.1011876 3,12.6912114 L3,31.9311164 C3,32.5211401 3.4928,33 4.1,33 L10.7,33 C12.0119333,33 13.1471333,32.2524941 13.6788,31.172209 L17.4584,32.3964371 C18.6940667,32.7969121 19.9818,33 21.2849333,33 L30.5,33 C32.3194,33 33.8,31.5612827 33.8,29.7933492 C33.8,29.3764846 33.7178667,28.9774347 33.5682667,28.6118765 C34.9674667,28.2406176 36,26.9942993 36,25.5178147 C36,24.6976247 35.681,23.947981 35.1574,23.3800475 C35.681,22.812114 36,22.0624703 36,21.2422803 C36,20.4220903 35.681,19.6724466 35.1574,19.1045131 Z M11.8,29.7933492 C11.8,30.3826603 11.3064667,30.8622328 10.7,30.8622328 L5.2,30.8622328 L5.2,13.760095 L10.7,13.760095 C11.3064667,13.760095 11.8,14.2396675 11.8,14.8289786 L11.8,29.7933492 Z M30.5,20.1733967 L32.7,20.1733967 C33.3064667,20.1733967 33.8,20.6529691 33.8,21.2422803 C33.8,21.8315914 33.3064667,22.3111639 32.7,22.3111639 L30.5,22.3111639 C29.8928,22.3111639 29.4,22.7900238 29.4,23.3800475 C29.4,23.9700713 29.8928,24.4489311 30.5,24.4489311 L32.7,24.4489311 C33.3064667,24.4489311 33.8,24.9285036 33.8,25.5178147 C33.8,26.1071259 33.3064667,26.5866983 32.7,26.5866983 L30.5,26.5866983 C29.8928,26.5866983 29.4,27.0655582 29.4,27.6555819 C29.4,28.2456057 29.8928,28.7244656 30.5,28.7244656 C31.1064667,28.7244656 31.6,29.204038 31.6,29.7933492 C31.6,30.3826603 31.1064667,30.8622328 30.5,30.8622328 L21.2849333,30.8622328 C20.2186667,30.8622328 19.1648667,30.6961995 18.1536,30.3684086 L14,29.0230404 L14,15.7966746 C15.7255333,15.4781473 17.4144,14.4163895 18.939,12.6783848 C20.4276667,10.9809976 21.6347333,8.73064133 22.1678667,6.65771971 L22.5587333,5.13776722 L22.8,5.13776722 C24.0129333,5.13776722 25,6.09691211 25,7.27553444 L25,8.34370546 C25,9.77885986 24.538,12.5315914 23.9469333,13.760095 L21.7,13.760095 C21.0928,13.760095 20.6,14.2389549 20.6,14.8289786 C20.6,15.4190024 21.0928,15.8978622 21.7,15.8978622 L32.7,15.8978622 C33.3064667,15.8978622 33.8,16.3774347 33.8,16.9667458 C33.8,17.556057 33.3064667,18.0356295 32.7,18.0356295 L30.5,18.0356295 C29.8928,18.0356295 29.4,18.5144893 29.4,19.1045131 C29.4,19.6945368 29.8928,20.1733967 30.5,20.1733967 Z" class="mgPlayerJSProd_shape"></path>' +
		'<circle class="mgPlayerJSProd_Oval" cx="8" cy="27" r="1"></circle>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    popup_drag: '<svg width="17" height="17" viewBox="0 0 17 17" fill="none">' +
		'<path d="M13.9443 7.55643H9.4991C9.18045 7.55643 8.93013 7.81896 8.93013 8.13378C8.93013 8.45074 9.18256 8.70806 9.4991 8.70806H13.9435L13.0248 9.64754C12.8048 9.87252 12.8048 10.2329 13.0248 10.4579C13.1353 10.5709 13.2802 10.6285 13.4288 10.6285C13.5774 10.6285 13.7224 10.5709 13.8328 10.4579L15.7107 8.53744C15.9307 8.31246 15.9307 7.95203 15.7107 7.72705L13.8328 5.80656C13.6104 5.57906 13.2503 5.57906 13.0278 5.80656C12.8079 6.03152 12.8078 6.39192 13.0278 6.6169L13.0277 6.61678L13.1708 6.47716L13.0278 6.61695L13.9443 7.55643Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M2.84286 10.4579C2.9533 10.5709 3.09821 10.6285 3.24684 10.6285C3.39547 10.6285 3.54038 10.5709 3.65082 10.4579C3.87081 10.2329 3.87081 9.87252 3.65082 9.64754L2.73219 8.70806H7.17656C7.49416 8.70806 7.74553 8.4466 7.74553 8.13378C7.74553 7.8231 7.49625 7.55643 7.17656 7.55643H2.7314L3.64782 6.61695L3.50482 6.47712L3.64799 6.61678L3.64787 6.6169C3.86781 6.39192 3.8678 6.03152 3.64782 5.80656C3.42538 5.57906 3.0653 5.57906 2.84286 5.80656L0.964993 7.72705C0.745002 7.95203 0.745002 8.31246 0.964993 8.53744L2.84286 10.4579Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M6.06066 3.32867C6.27841 3.55932 6.64328 3.55681 6.86178 3.32955L7.76905 2.40168V6.94241C7.76905 7.25723 8.01938 7.51976 8.33803 7.51976C8.65668 7.51976 8.907 7.25723 8.907 6.94241V2.40168L9.81493 3.33021C9.92537 3.44316 10.0703 3.50083 10.2189 3.50083C10.3675 3.50083 10.5124 3.44316 10.6229 3.33021C10.8429 3.10523 10.8429 2.7448 10.6229 2.51981L8.74501 0.599317C8.52857 0.377962 8.15649 0.377962 7.94004 0.599317L6.06216 2.51981C5.84267 2.74429 5.84217 3.10358 6.06066 3.32867Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'<path d="M7.76917 13.86L6.86126 12.9314C6.63882 12.7039 6.27874 12.7039 6.0563 12.9314C5.83631 13.1564 5.83631 13.5168 6.0563 13.7418L7.93417 15.6623C8.04012 15.7707 8.18439 15.8329 8.33815 15.8329C8.48804 15.8329 8.63556 15.7713 8.74213 15.6623L10.62 13.7418C10.84 13.5168 10.84 13.1564 10.62 12.9314C10.3976 12.7039 10.0375 12.7039 9.81503 12.9314L8.90712 13.86V9.31924H8.90714L8.9071 9.31637C8.90264 9.00646 8.65933 8.74189 8.33815 8.74189C8.0195 8.74189 7.76917 9.00443 7.76917 9.31924V13.86Z" fill="#757575" stroke="#757575" stroke-width="0.4"/>' +
		'</svg>',
    close_slideshow: '<svg width="12" height="12" viewBox="0 0 12 12">' +
		'<path fill="#FFF" fill-rule="nonzero" d="M6.69 5.98L11.814.858a.503.503 0 0 0-.711-.71L5.98 5.268.858.147a.502.502 0 1 0-.71.71L5.268 5.98.148 11.1a.503.503 0 0 0 .71.712L5.98 6.69l5.122 5.122a.503.503 0 1 0 .71-.712L6.692 5.98z"/>' +
		'</svg>',
    slideshow_next_button: '<svg width="33"  height="33"  viewBox="0 0 33 33">' +
  '<path fill-rule="evenodd" clip-rule="evenodd" d="M11.2547 16.568C11.2547 16.588 11.2587 16.6053 11.26 16.6253C11.2717 16.8879 11.381 17.1366 11.5667 17.3227L11.5693 17.3267L19.0987 24.856C19.1977 24.9557 19.3155 25.0349 19.4452 25.0891C19.5749 25.1433 19.714 25.1714 19.8545 25.1717C19.9951 25.1721 20.1343 25.1448 20.2643 25.0913C20.3943 25.0378 20.5124 24.9592 20.612 24.86L20.988 24.4827C21.1881 24.2818 21.3002 24.0096 21.2997 23.7261C21.2992 23.4426 21.1862 23.1708 20.9853 22.9707L14.5827 16.5693L20.9827 10.168C21.0825 10.069 21.1618 9.95136 21.2161 9.82171C21.2704 9.69207 21.2986 9.55299 21.2991 9.41243C21.2996 9.27188 21.2724 9.13261 21.219 9.00258C21.1656 8.87256 21.0871 8.75433 20.988 8.65466L20.6107 8.27733C20.4094 8.07758 20.1371 7.96593 19.8536 7.96693C19.57 7.96793 19.2985 8.0815 19.0987 8.28266L11.9427 15.4373L11.5653 15.8147C11.3653 16.0147 11.264 16.2747 11.2587 16.5387C11.2587 16.5493 11.2547 16.5587 11.2547 16.568Z" fill="#555555"/>' +
'</svg>',
    slideshow_prev_button: '<svg width="33" height="33" viewBox="0 0 33 33" fill="none" xmlns="http://www.w3.org/2000/svg">' +
  '<path fill-rule="evenodd" clip-rule="evenodd" d="M11.4774 16.5707C11.4774 16.5507 11.4814 16.5333 11.4827 16.5133C11.4944 16.2508 11.6038 16.0021 11.7894 15.816L11.7921 15.812L19.3214 8.28268C19.4204 8.18296 19.5382 8.10374 19.6679 8.04957C19.7976 7.99539 19.9367 7.96731 20.0772 7.96694C20.2178 7.96657 20.357 7.99391 20.487 8.0474C20.617 8.10089 20.7351 8.17948 20.8347 8.27868L21.2107 8.65601C21.4108 8.85689 21.523 9.12902 21.5225 9.41256C21.522 9.6961 21.4089 9.96783 21.2081 10.168L14.8054 16.5693L21.2054 22.9707C21.3052 23.0696 21.3845 23.1873 21.4388 23.317C21.4931 23.4466 21.5213 23.5857 21.5218 23.7262C21.5223 23.8668 21.4951 24.0061 21.4417 24.1361C21.3883 24.2661 21.3098 24.3843 21.2107 24.484L20.8334 24.8613C20.6322 25.0611 20.3598 25.1727 20.0763 25.1717C19.7927 25.1707 19.5212 25.0572 19.3214 24.856L12.1654 17.7013L11.7881 17.324C11.5881 17.124 11.4867 16.864 11.4801 16.6L11.4774 16.5707Z" fill="#555555"/>' +
  '</svg>'
    ,
    notification_guide_play: '<svg width="74px" height="75px" viewBox="0 0 74 75" version="1.1" >' +
		'<defs>' +
		'<filter x="-21.6%" y="-14.7%" width="143.1%" height="143.1%" filterUnits="objectBoundingBox" class="mgPlayerJSProd_filter-np1">' +
		'<feOffset dx="0" dy="2" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>' +
		'<feGaussianBlur stdDeviation="1.5" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>' +
		'<feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.210484601 0" type="matrix" in="shadowBlurOuter1" result="shadowMatrixOuter1"></feColorMatrix>' +
		'<feMerge>' +
		'<feMergeNode in="shadowMatrixOuter1"></feMergeNode>' +
		'<feMergeNode in="SourceGraphic"></feMergeNode>' +
		'</feMerge>' +
		'</filter>' +
		'<path d="M29,0 C12.992,0 0,12.992 0,29 C0,45.008 12.992,58 29,58 C45.008,58 58,45.008 58,29 C58,12.992 45.008,0 29,0 L29,0 Z" class="mgPlayerJSProd_path-np2"></path>' +
		'<filter x="-16.4%" y="-12.9%" width="132.8%" height="132.8%" filterUnits="objectBoundingBox" class="mgPlayerJSProd_filter-np3">' +
		'<feMorphology radius="2.5" operator="dilate" in="SourceAlpha" result="shadowSpreadOuter1"></feMorphology>' +
		'<feOffset dx="0" dy="2" in="shadowSpreadOuter1" result="shadowOffsetOuter1"></feOffset>' +
		'<feMorphology radius="2.5" operator="erode" in="SourceAlpha" result="shadowInner"></feMorphology>' +
		'<feOffset dx="0" dy="2" in="shadowInner" result="shadowInner"></feOffset>' +
		'<feComposite in="shadowOffsetOuter1" in2="shadowInner" operator="out" result="shadowOffsetOuter1"></feComposite>' +
		'<feGaussianBlur stdDeviation="2" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>' +
		'<feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.211447011 0" type="matrix" in="shadowBlurOuter1"></feColorMatrix>' +
		'</filter>' +
		'<path d="M29,6 C41.696,6 52,16.304 52,29 C52,41.696 41.696,52 29,52 C16.304,52 6,41.696 6,29 C6,16.304 16.304,6 29,6 Z M37.394022,29.7044835 C38.2809792,29.0392656 38.2864907,27.964868 37.394022,27.2955165 L26.605978,19.2044835 C25.7190208,18.5392656 25,18.9023438 25,19.9945615 L25,37.0054385 C25,38.1070044 25.7135093,38.464868 26.605978,37.7955165 L37.394022,29.7044835 Z" class="mgPlayerJSProd_path-np4"></path>' +
		'<filter x="-15.2%" y="-10.9%" width="130.4%" height="130.4%" filterUnits="objectBoundingBox" class="mgPlayerJSProd_filter-np5">' +
		'<feOffset dx="0" dy="2" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>' +
		'<feGaussianBlur stdDeviation="2" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>' +
		'<feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.211447011 0" type="matrix" in="shadowBlurOuter1"></feColorMatrix>' +
		'</filter>' +
		'</defs>' +
		'<g class="mgPlayerJSProd_Page-np1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.854520089">' +
		'<g class="mgPlayerJSProd_03-slideshow-mode-copy-2" transform="translate(-1161.000000, -436.000000)">' +
		'<g class="mgPlayerJSProd_Group-np-21" filter="url(#filter-np1)" transform="translate(1169.000000, 441.000000)">' +
		'<g class="mgPlayerJSProd_Shape-Copy-np-3">' +
		'<use fill="black" fill-opacity="1" filter="url(#filter-np3)" xlink:href="#path-np2"></use>' +
		'<use stroke="#ffffff" stroke-width="5" xlink:href="#path-np2"></use>' +
		'</g>' +
		'<g class="mgPlayerJSProd_combined-shape">' +
		'<use fill="black" fill-opacity="1" filter="url(#filter-np5)" xlink:href="#path-np4"></use>' +
		'<use fill="#ffffff" class="mgPlayerJSProd_shape-combined-np" fill-rule="evenodd" xlink:href="#path-np4"></use>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    push_not_single_play: '<svg width="9" height="13" viewBox="0 0 9 13" fill="none">' +
		'<path opacity="0.3" d="M0 0L9 6.5L0 13V0Z" fill="black" />' +
		'</svg>',
    push_prev: '<svg width="30" height="30" version="1.1" class="mgPlayerJSProd_Layer_1" x="0px" y="0px" viewBox="0 0 30 30" style="enable-background:new 0 0 30 30;" xml:space="preserve">' +
		'<style type="text/css">' +
		'.mgPlayerJSProd_st0{fill:#FFFFFF;}' +
		'.mgPlayerJSProd_st1{fill:#666666;}' +
		'</style>' +
		'<g>' +
		'<path class="mgPlayerJSProd_st0" d="M15,2.8C8.3,2.8,2.8,8.3,2.8,15S8.3,27.2,15,27.2S27.2,21.7,27.2,15S21.7,2.8,15,2.8z"/>' +
		'</g>' +
		'<g>' +
		'<path class="mgPlayerJSProd_st1" d="M15,0C6.7,0,0,6.7,0,15s6.7,15,15,15s15-6.7,15-15S23.3,0,15,0z M18.5,21.6c0.5,0.4,0.5,1.2,0,1.6 c-0.2,0.2-0.5,0.4-0.8,0.4s-0.6-0.1-0.8-0.3l-7.5-7.2C9.1,15.8,9,15.5,9,15.2s0.1-0.6,0.4-0.8l7.5-7.2c0.5-0.4,1.2-0.4,1.6,0 c0.4,0.5,0.4,1.2,0,1.6l-6.7,6.4L18.5,21.6z"/>' +
		'</g>' +
		'</svg>',
    overlay_tour_popup_close: '<svg  width="16px" height="16px" version="1.1" class="mgPlayerJSProd_Capa_1" x="0px" y="0px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;" xml:space="preserve">' +
		'<g>' +
		'<g class="mgPlayerJSProd_close">' +
		'<polygon points="23.3,3 21,0.7 12,9.7 3,0.7 0.7,3 9.7,12 0.7,21 3,23.3 12,14.3 21,23.3 23.3,21 14.3,12"/>' +
		'</g>' +
		'</g>' +
		'</svg>',
    tutorial: '<svg width="32" height="32" viewBox="0 0 32 32" fill="none">' +
		'<circle cx="16" cy="16" r="16" fill="#45465F"/>' +
		'<path d="M20.9755 8H11.3879C10.2677 8.00051 9.3596 8.90847 9.35922 10.0287V11.8293H8.40574C8.18157 11.8293 8 12.011 8 12.2351C8 12.4591 8.18157 12.6408 8.40574 12.6408H9.35504V14.3782H8.40574C8.18157 14.3782 8 14.5598 8 14.7839C8 15.008 8.18157 15.1897 8.40574 15.1897H9.35504V17.8513H8.40574C8.18157 17.8513 8 18.033 8 18.2571C8 18.4812 8.18157 18.6628 8.40574 18.6628H9.35504V21.3244H8.40574C8.18157 21.3244 8 21.5061 8 21.7302C8 21.9542 8.18157 22.1359 8.40574 22.1359H9.35504V23.0123C9.35554 24.1325 10.2635 25.0405 11.3837 25.041H20.9713C22.0915 25.0405 22.9997 24.1325 23 23.0123V10.0287C23.0016 8.90923 22.0949 8.00076 20.9755 8ZM22.1927 23.0123C22.1907 23.6837 21.6469 24.2276 20.9755 24.2295H11.3879C10.7165 24.2276 10.1726 23.6837 10.1707 23.0123V22.1359H11.12C11.3442 22.1359 11.5257 21.9542 11.5257 21.7302C11.5257 21.5061 11.3442 21.3244 11.12 21.3244H10.1707V18.6628H11.12C11.3442 18.6628 11.5257 18.4812 11.5257 18.2571C11.5257 18.033 11.3442 17.8513 11.12 17.8513H10.1707V15.1897H11.12C11.3442 15.1897 11.5257 15.008 11.5257 14.7839C11.5257 14.5598 11.3442 14.3782 11.12 14.3782H10.1707V12.6408H11.12C11.3442 12.6408 11.5257 12.4591 11.5257 12.2351C11.5257 12.011 11.3442 11.8293 11.12 11.8293H10.1707V10.0287C10.1726 9.35732 10.7165 8.81338 11.3879 8.81148H20.9755C21.6469 8.81338 22.1907 9.35732 22.1927 10.0287V23.0123Z" fill="white" stroke="white" stroke-width="0.5"/>' +
		'<rect x="13.5449" y="11.697" width="6.4698" height="1.38639" fill="white"/>' +
		'<rect x="13.5449" y="15.394" width="6.4698" height="1.38639" fill="white"/>' +
		'<rect x="13.5449" y="19.0911" width="6.4698" height="1.38639" fill="white"/>' +
		'</svg>',
    white_myguide_logo: '<svg width="82" height="27" viewBox="0 0 82 27" fill="none">' +
		'<path d="M55.2148 18.8794C55.2127 18.8247 55.1993 18.7709 55.1756 18.7213C55.1519 18.6717 55.1184 18.6272 55.0768 18.5905C55.0353 18.5537 54.9867 18.5255 54.9339 18.5074C54.8811 18.4893 54.8251 18.4818 54.7693 18.4852C53.2776 18.5788 51.8711 19.1986 50.8107 20.2298C50.7399 20.3095 50.7024 20.4125 50.7058 20.5181C50.7092 20.6237 50.7531 20.7242 50.8289 20.7994C50.9047 20.8746 51.0067 20.9191 51.1145 20.9239C51.2223 20.9287 51.328 20.8935 51.4105 20.8253C52.3247 19.9234 53.5429 19.3778 54.8378 19.2904C54.9416 19.28 55.0377 19.2321 55.1074 19.1561C55.1771 19.0802 55.2154 18.9815 55.2148 18.8794Z" fill="#76C9BE" />' +
		'<path d="M54.7595 20.0531C53.6997 20.1452 52.7059 20.5961 51.949 21.328C51.9091 21.3662 51.8774 21.4119 51.8558 21.4623C51.8341 21.5127 51.823 21.5669 51.823 21.6216C51.823 21.6762 51.8341 21.7304 51.8558 21.7808C51.8774 21.8312 51.9091 21.8769 51.949 21.9151C52.0307 21.9954 52.1417 22.0407 52.2575 22.0409C52.3123 22.041 52.3665 22.0298 52.4167 22.0081C52.4669 21.9864 52.5119 21.9548 52.5488 21.9151C53.1688 21.3258 53.9761 20.9617 54.8366 20.8834C54.8926 20.8792 54.9471 20.8641 54.9971 20.8389C55.047 20.8137 55.0912 20.779 55.1272 20.7367C55.1631 20.6945 55.1901 20.6456 55.2064 20.593C55.2227 20.5404 55.2281 20.4852 55.2222 20.4305C55.2179 20.3757 55.2024 20.3223 55.1767 20.2734C55.151 20.2245 55.1155 20.1812 55.0723 20.146C55.0292 20.1108 54.9793 20.0845 54.9255 20.0685C54.8718 20.0525 54.8153 20.0473 54.7595 20.0531Z" fill="#76C9BE" />' +
		'<path d="M63.1583 20.5427C63.0764 20.4628 62.9654 20.418 62.8498 20.418C62.7342 20.418 62.6232 20.4628 62.5413 20.5427C62.5021 20.5812 62.4713 20.6271 62.4507 20.6775C62.4301 20.728 62.4201 20.782 62.4214 20.8363V22.6481C62.23 22.4867 62.0235 22.3434 61.8045 22.2203C61.4944 22.0407 61.1444 21.9377 60.7847 21.9202C60.4249 21.9026 60.0662 21.9711 59.7395 22.1196C59.44 22.2531 59.1673 22.4377 58.934 22.6648C58.7 22.8947 58.5112 23.1648 58.3771 23.4617C58.2392 23.7681 58.1691 24.0997 58.1714 24.4346C58.1693 24.7668 58.2394 25.0956 58.3771 25.3992C58.5073 25.6916 58.6901 25.9587 58.9169 26.1877C59.1505 26.4161 59.4269 26.5984 59.7309 26.7245C60.3677 26.9808 61.082 26.9808 61.7188 26.7245C61.9737 26.6211 62.2108 26.4797 62.4214 26.3051V26.4896C62.4202 26.5454 62.4305 26.6008 62.4515 26.6527C62.4725 26.7045 62.5039 26.7518 62.5438 26.7916C62.5837 26.8314 62.6313 26.8631 62.6838 26.8847C62.7364 26.9063 62.7928 26.9174 62.8498 26.9174C62.9073 26.9187 62.9645 26.9082 63.0177 26.8865C63.0708 26.8649 63.1187 26.8325 63.1583 26.7916C63.201 26.7535 63.2346 26.7068 63.2568 26.6546C63.279 26.6024 63.2893 26.5461 63.2868 26.4896V20.8363C63.2886 20.7812 63.278 20.7263 63.2558 20.6756C63.2336 20.6248 63.2003 20.5795 63.1583 20.5427ZM62.3014 25.1056C62.216 25.2996 62.0939 25.4761 61.9415 25.6257C61.7852 25.7767 61.6024 25.8989 61.4017 25.9864C60.982 26.1564 60.5105 26.1564 60.0908 25.9864C59.8888 25.905 59.7054 25.7852 59.551 25.6341C59.3166 25.3996 59.1576 25.103 59.0936 24.781C59.0296 24.459 59.0635 24.1257 59.1911 23.8223C59.3489 23.4309 59.6562 23.115 60.0479 22.9416C60.2572 22.8575 60.4814 22.8147 60.7077 22.8158C60.9275 22.8158 61.1453 22.8556 61.3503 22.9332C61.547 23.015 61.7248 23.1348 61.873 23.2855C62.0284 23.4344 62.1534 23.6109 62.2414 23.8056C62.3289 24.0169 62.381 24.2406 62.3957 24.4682C62.4052 24.686 62.3672 24.9033 62.2843 25.1056H62.3014Z" fill="white" />' +
		'<path d="M56.9546 22.6483C56.7235 22.4207 56.4501 22.2385 56.1491 22.1115C55.8445 21.9783 55.5145 21.9097 55.1809 21.9102C54.8296 21.9227 54.4837 21.9996 54.1612 22.1366C53.8432 22.2602 53.5523 22.4425 53.3044 22.6734C53.075 22.9004 52.8918 23.1679 52.7646 23.4619C52.6303 23.7723 52.561 24.1061 52.561 24.4432C52.561 24.7804 52.6303 25.1141 52.7646 25.4246C52.8904 25.7214 53.077 25.9897 53.313 26.213C53.5488 26.4345 53.8249 26.6109 54.127 26.7331C54.4405 26.8553 54.7749 26.9179 55.1123 26.9176C55.4536 26.9249 55.7934 26.8709 56.1148 26.7582C56.422 26.643 56.6956 26.4558 56.9117 26.213C56.9933 26.1329 57.0392 26.0243 57.0392 25.9111C57.0392 25.7979 56.9933 25.6893 56.9117 25.6091C56.8302 25.5318 56.7211 25.4885 56.6075 25.4885C56.494 25.4885 56.3849 25.5318 56.3033 25.6091C56.1434 25.7514 55.9612 25.8675 55.7635 25.953C55.364 26.1052 54.9207 26.1052 54.5211 25.953C54.1541 25.8204 53.8493 25.5608 53.6643 25.2233C53.6615 25.2038 53.6615 25.1841 53.6643 25.1646C53.5434 24.9337 53.4817 24.6775 53.4843 24.4181C53.4853 24.2174 53.523 24.0186 53.5957 23.8309C53.6269 23.7406 53.6671 23.6535 53.7157 23.5709C53.8106 23.4098 53.9322 23.2652 54.0756 23.1431C54.2285 23.0239 54.3989 22.9277 54.5811 22.858C54.9576 22.7247 55.3699 22.7247 55.7464 22.858C55.9285 22.9277 56.099 23.0239 56.2519 23.1431C56.3975 23.2654 56.5219 23.4099 56.6204 23.5709C56.6969 23.6934 56.7546 23.8262 56.7917 23.9651H54.6411C54.5421 23.9846 54.4531 24.037 54.3891 24.1135C54.3251 24.1899 54.2902 24.2857 54.2902 24.3845C54.2902 24.4833 54.3251 24.5791 54.3891 24.6556C54.4531 24.732 54.5421 24.7844 54.6411 24.8039H57.2887C57.3957 24.801 57.4984 24.7625 57.58 24.6949C57.6282 24.6567 57.6665 24.6079 57.6918 24.5526C57.7171 24.4972 57.7287 24.4367 57.7257 24.3761C57.717 24.0686 57.6441 23.766 57.5115 23.487C57.3831 23.1748 57.1939 22.8899 56.9546 22.6483Z" fill="white" />' +
		'<path d="M72.2655 13.4968C72.7827 14.0016 73.3973 14.4008 74.0735 14.671C74.7651 14.9556 75.5082 15.1011 76.2584 15.0988C77.0235 15.1105 77.7842 14.9854 78.5034 14.7297C79.1883 14.4622 79.7969 14.0363 80.2771 13.4884C80.4578 13.3014 80.5586 13.0538 80.5586 12.7964C80.5586 12.539 80.4578 12.2913 80.2771 12.1044C80.1871 12.0161 80.0803 11.9461 79.9626 11.8983C79.845 11.8506 79.7189 11.826 79.5916 11.826C79.4642 11.826 79.3381 11.8506 79.2205 11.8983C79.1029 11.9461 78.996 12.0161 78.9061 12.1044C78.5616 12.4401 78.1544 12.7078 77.7065 12.8928C76.8246 13.2584 75.8319 13.2734 74.9389 12.9348C74.5269 12.7822 74.1466 12.5577 73.8164 12.2722C73.478 11.9866 73.1886 11.6496 72.9596 11.274L72.8825 11.123C72.6202 10.6009 72.4825 10.0273 72.4797 9.44549C72.4807 8.98379 72.5678 8.52614 72.7368 8.09507C72.8097 7.89564 72.8985 7.70213 73.0024 7.51632C73.2214 7.141 73.5123 6.81062 73.8593 6.54335C74.1944 6.26242 74.5734 6.03588 74.9817 5.87233C75.8097 5.56413 76.7244 5.56413 77.5523 5.87233C77.9627 6.02813 78.3425 6.25232 78.6747 6.53496C79.0187 6.80858 79.3091 7.1411 79.5316 7.51632C79.7011 7.78909 79.8336 8.08234 79.9257 8.38864H75.1274C74.8638 8.38864 74.611 8.49115 74.4246 8.67362C74.2382 8.85609 74.1335 9.10357 74.1335 9.36162C74.1335 9.61967 74.2382 9.86715 74.4246 10.0496C74.611 10.2321 74.8638 10.3346 75.1274 10.3346H81.0311C81.2703 10.3295 81.5004 10.2436 81.6823 10.0913C81.7867 10.0001 81.8693 9.88732 81.9241 9.76117C81.9789 9.63503 82.0046 9.4986 81.9993 9.36162C81.9984 8.59075 81.8351 7.82835 81.5195 7.1221C81.2129 6.4543 80.7895 5.84402 80.2685 5.31875C79.7513 4.80283 79.1413 4.38483 78.4691 4.08575C77.7935 3.78614 77.0601 3.6317 76.3184 3.63282C75.5315 3.6742 74.7603 3.86507 74.0478 4.19479C73.3723 4.4785 72.7564 4.88234 72.2313 5.38585C71.7132 5.90485 71.3029 6.51727 71.0231 7.1892C70.7245 7.89357 70.573 8.64934 70.5776 9.41194C70.5716 10.1918 70.7261 10.9648 71.0317 11.685C71.3184 12.3619 71.7375 12.9774 72.2655 13.4968Z" fill="white" />' +
		'<path d="M13.3069 4.77153C12.9189 4.41655 12.4691 4.13247 11.9788 3.93276C11.4636 3.7204 10.9098 3.61199 10.3508 3.61402C9.67692 3.60539 9.01143 3.76104 8.41433 4.06696C7.97961 4.27903 7.58542 4.56276 7.24902 4.90573C6.91833 4.56369 6.52993 4.27995 6.10085 4.06696C5.50452 3.75813 4.83899 3.59958 4.16438 3.60564C3.6489 3.60777 3.14114 3.72844 2.68204 3.95792C2.47325 4.06206 2.27019 4.17685 2.07368 4.30181C2.01767 4.17771 1.93598 4.06633 1.83376 3.97469C1.63287 3.78075 1.3619 3.67223 1.07974 3.67274C0.939606 3.66963 0.80032 3.69484 0.670585 3.7468C0.540849 3.79875 0.42345 3.87633 0.325719 3.97469C0.221894 4.0705 0.139388 4.18624 0.0833615 4.3147C0.0273355 4.44315 -0.00100356 4.58153 0.000117865 4.7212V14.107C-0.0020539 14.2469 0.0258084 14.3856 0.0818992 14.5142C0.13799 14.6428 0.221058 14.7584 0.325719 14.8535C0.424645 14.9503 0.542265 15.0269 0.67172 15.0787C0.801175 15.1306 0.939878 15.1567 1.07974 15.1555C1.21974 15.1576 1.35873 15.132 1.48832 15.0801C1.61791 15.0282 1.73542 14.9511 1.83376 14.8535C1.93843 14.7584 2.02149 14.6428 2.07758 14.5142C2.13367 14.3856 2.16154 14.2469 2.15937 14.107V7.54785C2.1662 7.30303 2.22276 7.06199 2.32573 6.83878C2.42871 6.61557 2.57605 6.41466 2.75916 6.24776C2.94378 6.0689 3.16343 5.92841 3.40491 5.83472C3.64639 5.74104 3.90471 5.69608 4.16438 5.70256C4.42472 5.69669 4.68356 5.74274 4.92514 5.83791C5.16672 5.93308 5.38599 6.07538 5.56961 6.25615C5.75814 6.43044 5.90969 6.63944 6.01555 6.87117C6.12142 7.10291 6.17952 7.35281 6.18653 7.60657V14.1154C6.18436 14.2552 6.21222 14.3939 6.26831 14.5225C6.32441 14.6511 6.40747 14.7668 6.51213 14.8619C6.61106 14.9587 6.72868 15.0353 6.85814 15.0871C6.98759 15.139 7.12629 15.1651 7.26616 15.1639C7.40616 15.166 7.54514 15.1403 7.67474 15.0884C7.80433 15.0365 7.92184 14.9595 8.02018 14.8619C8.12484 14.7668 8.20791 14.6511 8.264 14.5225C8.32009 14.3939 8.34795 14.2552 8.34578 14.1154V7.59818C8.34491 7.3498 8.39746 7.10403 8.50001 6.87684C8.59825 6.64811 8.74083 6.44018 8.91987 6.26454C9.10384 6.09504 9.319 5.96127 9.55393 5.87031C10.0615 5.66481 10.6316 5.66481 11.1391 5.87031C11.3821 5.96706 11.6033 6.10955 11.7903 6.2897C11.9718 6.46184 12.1173 6.66697 12.2187 6.89361C12.3213 7.1208 12.3738 7.36658 12.3729 7.61496V14.1238C12.3708 14.2636 12.3986 14.4023 12.4547 14.5309C12.5108 14.6595 12.5939 14.7752 12.6986 14.8703C12.7975 14.9671 12.9151 15.0437 13.0446 15.0955C13.174 15.1473 13.3127 15.1734 13.4526 15.1723C13.5926 15.1744 13.7316 15.1487 13.8612 15.0968C13.9907 15.0449 14.1083 14.9679 14.2066 14.8703C14.3113 14.7752 14.3943 14.6595 14.4504 14.5309C14.5065 14.4023 14.5344 14.2636 14.5322 14.1238V7.59818C14.5361 7.05984 14.4191 6.52724 14.1895 6.03807C13.9974 5.55571 13.6956 5.12255 13.3069 4.77153Z" fill="white" />' +
		'<path d="M23.9405 3.63011C23.7348 3.62826 23.5328 3.68352 23.3579 3.78948C23.1733 3.89704 23.0314 4.0626 22.9552 4.25919L20.1361 11.2713L17.4285 4.25919C17.3489 4.062 17.2041 3.89661 17.0172 3.78948C16.829 3.67793 16.6116 3.62255 16.3917 3.63011C16.2498 3.62313 16.1081 3.64653 15.9764 3.69868C15.8447 3.75083 15.7262 3.83048 15.6291 3.93207C15.4476 4.1298 15.3496 4.38763 15.3549 4.65341C15.3547 4.80638 15.3867 4.95774 15.4492 5.09796C15.4492 5.18184 15.5263 5.31604 15.6377 5.60122C15.7491 5.8864 15.9633 6.43999 16.2461 7.16972C16.5288 7.89945 16.8973 8.84726 17.3428 9.99638C17.7884 11.1455 18.3196 12.5127 18.9537 14.1902L17.5999 17.6963C17.5999 17.755 17.5999 17.8137 17.5485 17.864C17.5393 17.9308 17.5393 17.9985 17.5485 18.0653C17.5483 18.3349 17.656 18.5938 17.8484 18.7867C17.9722 18.9147 18.127 19.01 18.2984 19.0639C18.4698 19.1178 18.6524 19.1286 18.8292 19.0951C19.006 19.0617 19.1713 18.9851 19.3099 18.8726C19.4485 18.76 19.5558 18.6151 19.622 18.4512L24.9259 5.08119C24.9932 4.9512 25.0284 4.80755 25.0287 4.6618C25.024 4.40061 24.9166 4.15125 24.7288 3.96562C24.6289 3.85862 24.507 3.77343 24.3712 3.71562C24.2354 3.65781 24.0886 3.62868 23.9405 3.63011Z" fill="white" />' +
		'<path d="M52.5503 3.63328C52.4101 3.63017 52.2708 3.65538 52.1411 3.70734C52.0114 3.75929 51.894 3.83687 51.7962 3.93524C51.6924 4.03104 51.6099 4.14679 51.5539 4.27524C51.4979 4.40369 51.4695 4.54208 51.4706 4.68174V10.8383C51.4598 11.1295 51.3868 11.4152 51.2564 11.6771C51.1314 11.9321 50.9634 12.1646 50.7595 12.3649C50.5383 12.5615 50.2829 12.7177 50.0054 12.8262C49.4119 13.0612 48.7482 13.0612 48.1547 12.8262C47.8715 12.7162 47.6126 12.5539 47.3921 12.3481C47.1725 12.1392 46.9952 11.8916 46.8694 11.6184C46.7506 11.354 46.6893 11.0684 46.6895 10.7796V4.68174C46.6906 4.54208 46.6622 4.40369 46.6062 4.27524C46.5502 4.14679 46.4677 4.03104 46.3638 3.93524C46.1619 3.74281 45.8916 3.63456 45.6098 3.63328C45.3287 3.63768 45.0607 3.75009 44.8635 3.94624C44.6664 4.14239 44.5559 4.40656 44.5559 4.68174V10.746C44.5575 11.3226 44.6769 11.893 44.9072 12.4236C45.1429 12.9399 45.4741 13.4091 45.884 13.8076C46.5173 14.3995 47.3086 14.8042 48.1667 14.9749C49.0248 15.1456 49.9147 15.0753 50.7338 14.7721C51.032 14.6688 51.319 14.5367 51.5906 14.3779C51.6485 14.5244 51.7393 14.6562 51.8562 14.7638C51.9551 14.8605 52.0728 14.9371 52.2022 14.9889C52.3317 15.0408 52.4704 15.0669 52.6102 15.0657C52.7502 15.0678 52.8892 15.0422 53.0188 14.9903C53.1484 14.9384 53.2659 14.8613 53.3643 14.7638C53.4689 14.6686 53.552 14.553 53.6081 14.4244C53.6642 14.2958 53.692 14.1571 53.6899 14.0172V4.68174C53.691 4.54208 53.6626 4.40369 53.6066 4.27524C53.5506 4.14679 53.4681 4.03104 53.3643 3.93524C53.2613 3.82724 53.1343 3.74385 52.9932 3.6915C52.852 3.63914 52.7005 3.61923 52.5503 3.63328Z" fill="white" />' +
		'<path d="M55.695 3.60561C55.5537 3.60332 55.4134 3.62887 55.2824 3.68075C55.1514 3.73262 55.0323 3.80976 54.9324 3.90757C54.8286 4.00337 54.7461 4.11912 54.6901 4.24757C54.634 4.37602 54.6057 4.51441 54.6068 4.65407V14.0399C54.6046 14.1797 54.6325 14.3184 54.6886 14.447C54.7447 14.5756 54.8277 14.6912 54.9324 14.7864C55.0316 14.8857 55.1503 14.9644 55.2814 15.0178C55.4124 15.0711 55.5531 15.098 55.695 15.0968C55.835 15.0989 55.974 15.0732 56.1036 15.0213C56.2332 14.9694 56.3507 14.8924 56.449 14.7948C56.5537 14.6996 56.6367 14.584 56.6928 14.4554C56.7489 14.3268 56.7768 14.1881 56.7746 14.0483V4.65407C56.7724 4.37523 56.6576 4.10857 56.4554 3.91218C56.2532 3.7158 55.9798 3.6056 55.695 3.60561Z" fill="white" />' +
		'<path d="M67.6396 13.7047V13.9563C67.6369 14.0962 67.6645 14.2351 67.7206 14.3638C67.7767 14.4924 67.8601 14.608 67.9652 14.7028C68.0638 14.8 68.1814 14.8768 68.3109 14.9287C68.4404 14.9805 68.5793 15.0064 68.7192 15.0048C68.8593 15.0079 68.9986 14.9827 69.1284 14.9307C69.2581 14.8788 69.3755 14.8012 69.4732 14.7028C69.5783 14.608 69.6617 14.4924 69.7178 14.3638C69.7739 14.2351 69.8015 14.0962 69.7988 13.9563V1.19024C69.8015 1.05035 69.7739 0.911491 69.7178 0.782814C69.6617 0.654137 69.5783 0.538571 69.4732 0.443739C69.2741 0.249615 69.0045 0.140625 68.7235 0.140625C68.4425 0.140625 68.1729 0.249615 67.9737 0.443739C67.8687 0.538571 67.7853 0.654137 67.7292 0.782814C67.673 0.911491 67.6454 1.05035 67.6481 1.19024V5.13246C67.2384 4.80985 66.7963 4.52882 66.3286 4.29369C65.541 3.86586 64.6586 3.63264 63.7581 3.61429C62.9742 3.61506 62.1988 3.77202 61.4789 4.07561C60.0663 4.65464 58.9221 5.724 58.2657 7.07841C57.9492 7.77552 57.7856 8.5299 57.7856 9.29276C57.7856 10.0556 57.9492 10.81 58.2657 11.5071C58.5804 12.1787 59.0158 12.7895 59.551 13.3105C60.0994 13.8338 60.7451 14.2495 61.4532 14.5351C62.2011 14.8334 63.0018 14.9845 63.8095 14.9796C64.5978 14.9817 65.3795 14.8394 66.1144 14.5602C66.6637 14.3514 67.1778 14.063 67.6396 13.7047ZM63.8181 12.9079C63.301 12.9123 62.7882 12.8153 62.31 12.6227C61.8526 12.4452 61.436 12.18 61.0847 11.8426C60.7343 11.5192 60.4548 11.1293 60.2633 10.6967C60.0718 10.2641 59.9723 9.7978 59.9708 9.32631C59.9706 8.84496 60.0697 8.36851 60.2622 7.92557C60.4689 7.4893 60.7599 7.09626 61.119 6.76806C61.477 6.43909 61.8919 6.17497 62.3443 5.98801C62.8225 5.79535 63.3352 5.69838 63.8523 5.70283C64.349 5.69972 64.8414 5.79383 65.3004 5.97962C65.7454 6.1548 66.1524 6.41095 66.5 6.73451C66.8531 7.06461 67.1433 7.45374 67.3568 7.88363C67.56 8.34297 67.6762 8.83467 67.6996 9.3347C67.7 9.80882 67.5978 10.2777 67.3997 10.7103C67.1988 11.1475 66.9069 11.5388 66.5428 11.8594C66.193 12.1985 65.7761 12.464 65.3175 12.6395C64.8422 12.83 64.3315 12.9214 63.8181 12.9079Z" fill="white" />' +
		'<path d="M34.8052 0C32.3977 0.0331607 30.1018 0.998956 28.4203 2.68585C26.7388 4.37274 25.8088 6.64323 25.834 9C25.834 15.165 33.8626 24.2069 34.2054 24.5927C34.2809 24.6752 34.3734 24.7412 34.4767 24.7864C34.5801 24.8316 34.692 24.8549 34.8052 24.8549C34.9183 24.8549 35.0303 24.8316 35.1336 24.7864C35.2369 24.7412 35.3294 24.6752 35.4049 24.5927C35.7391 24.2069 43.7677 15.165 43.7677 9C43.7952 6.64401 42.8671 4.3735 41.187 2.68636C39.5069 0.999224 37.2118 0.0331569 34.8052 0Z" fill="#76C9BE" />' +
		'<path d="M40.3249 10.4584C40.1966 11.1045 39.953 11.7235 39.6052 12.2869C39.2784 12.8363 38.8515 13.3225 38.3456 13.7212C37.8497 14.1284 37.284 14.4465 36.6748 14.6606C36.05 14.8892 35.3882 15.0057 34.7212 15.0045C33.957 15.0093 33.2005 14.8549 32.502 14.5516C31.8339 14.29 31.2231 13.9056 30.7026 13.4192C30.1856 12.8945 29.773 12.2801 29.4859 11.6075C29.1861 10.9003 29.0317 10.1421 29.0317 9.37637C29.0317 8.61066 29.1861 7.85248 29.4859 7.14524C29.769 6.45558 30.1817 5.82398 30.7026 5.28318C31.2178 4.76127 31.8319 4.34249 32.5105 4.05018C33.2829 3.72073 34.1217 3.56764 34.9634 3.60252C35.8051 3.6374 36.6277 3.85932 37.3688 4.25149C38.157 4.66176 38.8329 5.25148 39.3396 5.97097C39.456 6.13991 39.5214 6.33762 39.5281 6.54133C39.5251 6.75232 39.4496 6.95619 39.3139 7.12008C39.1927 7.25941 39.0283 7.35614 38.8458 7.39551C38.6632 7.43488 38.4726 7.41474 38.3028 7.33816C38.1445 7.27255 38.008 7.16509 37.9086 7.02782C37.4762 6.51205 36.9394 6.08941 36.3321 5.78644C35.849 5.55292 35.3197 5.42521 34.7811 5.41217C34.2425 5.39914 33.7074 5.50109 33.2131 5.71095C32.7489 5.90728 32.3294 6.19246 31.9793 6.54972C31.6171 6.91398 31.3266 7.3405 31.1224 7.80787C30.9227 8.293 30.8209 8.8114 30.8225 9.33443C30.8144 10.364 31.2207 11.3554 31.9536 12.094C32.3056 12.4491 32.7246 12.7339 33.1874 12.9328C33.6687 13.1374 34.1879 13.243 34.7126 13.2431C35.1235 13.2446 35.5317 13.1794 35.9208 13.0502C36.2931 12.9211 36.6472 12.7463 36.9747 12.5301C37.3041 12.2969 37.5933 12.0138 37.8315 11.6914C37.9606 11.5326 38.0726 11.3611 38.1657 11.1797H36.452C36.3331 11.1805 36.2153 11.1571 36.1061 11.1108C35.997 11.0646 35.8988 10.9967 35.8179 10.9113C35.733 10.8274 35.6658 10.7279 35.6202 10.6185C35.5746 10.5091 35.5516 10.392 35.5523 10.2739C35.5504 10.0327 35.6459 9.80057 35.8179 9.628C35.8996 9.54416 35.998 9.47777 36.1072 9.43301C36.2163 9.38826 36.3337 9.36612 36.452 9.36798H39.4681C39.5947 9.36552 39.7204 9.39056 39.8359 9.44133C39.9515 9.49209 40.0541 9.5673 40.1364 9.66155C40.2867 9.83759 40.3659 10.0613 40.3592 10.2906C40.3531 10.3475 40.3417 10.4036 40.3249 10.4584Z" fill="white" />' +
		'<path d="M68.1366 25.6495C67.9767 25.7918 67.7944 25.9079 67.5968 25.9934C67.1796 26.1612 66.7116 26.1612 66.2944 25.9934C66.0937 25.906 65.9109 25.7838 65.7546 25.6328C65.6004 25.4846 65.478 25.3078 65.3947 25.1127C65.3085 24.9109 65.2648 24.694 65.2662 24.4753C65.265 24.2538 65.3087 24.0343 65.3947 23.8294C65.4757 23.6306 65.5983 23.4506 65.7546 23.301C65.9092 23.148 66.0925 23.0255 66.2944 22.9403C66.7116 22.7725 67.1796 22.7725 67.5968 22.9403C67.7894 23.0194 67.9686 23.1269 68.128 23.259C68.2067 23.3354 68.3129 23.3782 68.4237 23.3782C68.5344 23.3782 68.6406 23.3354 68.7193 23.259C68.7611 23.2253 68.795 23.1831 68.8187 23.1353C68.8423 23.0875 68.8552 23.0353 68.8564 22.9822C68.8401 22.8678 68.7859 22.7617 68.7021 22.6803C68.5916 22.55 68.4616 22.4369 68.3165 22.3448C68.1323 22.2314 67.9371 22.1359 67.7339 22.0596C67.4866 21.973 67.2254 21.9304 66.9627 21.9338C66.6114 21.9464 66.2656 22.0232 65.9431 22.1603C65.6402 22.2885 65.3642 22.4705 65.1291 22.6971C64.8976 22.9223 64.7142 23.1903 64.5893 23.4855C64.4583 23.7938 64.3913 24.1246 64.3922 24.4585C64.3892 24.7988 64.4593 25.136 64.5978 25.4482C64.7236 25.745 64.9102 26.0133 65.1462 26.2367C65.3948 26.4626 65.6858 26.6393 66.0031 26.7567C66.3153 26.8829 66.6506 26.9457 66.9884 26.9412C67.2782 26.9506 67.5676 26.9138 67.8453 26.8322C68.0545 26.7671 68.2535 26.674 68.4365 26.5554C68.5846 26.4706 68.7153 26.3597 68.8221 26.2283C68.8977 26.1434 68.9454 26.0382 68.9592 25.9263C68.9595 25.8694 68.9474 25.813 68.9237 25.7609C68.9001 25.7089 68.8655 25.6623 68.8221 25.6244C68.7802 25.5737 68.7269 25.5333 68.6663 25.5063C68.6056 25.4793 68.5394 25.4666 68.4729 25.469C68.4064 25.4714 68.3413 25.489 68.283 25.5204C68.2246 25.5517 68.1745 25.5959 68.1366 25.6495Z" fill="white" />' +
		'<path d="M73.5945 22.688C73.3741 22.4648 73.1161 22.2804 72.8319 22.1428C72.5159 22.0125 72.1765 21.9453 71.8337 21.9453C71.4908 21.9453 71.1514 22.0125 70.8354 22.1428C70.5161 22.2641 70.2248 22.4466 69.9786 22.6796C69.7326 22.9064 69.5371 23.1805 69.4045 23.4848C69.2735 23.7931 69.2065 24.1239 69.2074 24.4578C69.2035 24.801 69.2736 25.1411 69.4131 25.4559C69.5389 25.7527 69.7255 26.0211 69.9615 26.2444C70.21 26.4704 70.501 26.647 70.8183 26.7644C71.1318 26.8866 71.4662 26.9493 71.8037 26.9489C72.165 26.9445 72.519 26.8492 72.8319 26.6722C73.0572 26.5482 73.2672 26.399 73.4574 26.2276V26.5463C73.4592 26.6291 73.4855 26.7096 73.5331 26.778C73.5807 26.8464 73.6475 26.8999 73.7255 26.9318C73.8035 26.9638 73.8894 26.9729 73.9726 26.9581C74.0558 26.9433 74.1328 26.9051 74.1943 26.8483C74.2357 26.8093 74.2684 26.7623 74.2905 26.7104C74.3127 26.6584 74.3236 26.6026 74.3228 26.5463V24.4578C74.336 24.1253 74.2776 23.7938 74.1514 23.4848C74.0174 23.188 73.8285 22.9179 73.5945 22.688ZM73.3289 25.1624C73.2403 25.3547 73.1186 25.5306 72.969 25.6824C72.8119 25.8282 72.6289 25.9447 72.4292 26.0263C72.006 26.1884 71.5345 26.1793 71.1182 26.0011C70.9176 25.9137 70.7347 25.7915 70.5784 25.6405C70.3477 25.4 70.1946 25.0982 70.1383 24.773C70.0819 24.4478 70.1247 24.1135 70.2614 23.8119C70.4192 23.4205 70.7265 23.1046 71.1182 22.9312C71.3242 22.8462 71.5458 22.8034 71.7694 22.8054C71.9957 22.8043 72.2199 22.8471 72.4292 22.9312C72.8209 23.1046 73.1282 23.4205 73.286 23.8119C73.3749 24.0162 73.4215 24.2358 73.4231 24.4578C73.4378 24.6964 73.4058 24.9355 73.3289 25.1624Z" fill="white" />' +
		'<path d="M76.7726 23.8967C75.9158 23.8045 75.7101 23.729 75.6587 23.3851C75.6587 23.3012 75.6073 23.0412 76.0443 22.8734C76.3695 22.7611 76.7217 22.7475 77.055 22.8343C77.3883 22.9211 77.687 23.1043 77.9122 23.3599C77.9777 23.4492 78.0763 23.5097 78.1868 23.5285C78.2974 23.5473 78.4111 23.5229 78.5034 23.4606C78.5495 23.4296 78.5887 23.3899 78.6189 23.3438C78.6491 23.2978 78.6696 23.2463 78.6791 23.1924C78.6887 23.1385 78.6872 23.0832 78.6747 23.0299C78.6622 22.9766 78.6389 22.9262 78.6062 22.8818C78.2692 22.4744 77.8105 22.1803 77.2944 22.0404C76.7782 21.9005 76.2303 21.922 75.7272 22.1018C75.4314 22.1873 75.1768 22.3742 75.0101 22.6283C74.8433 22.8824 74.7755 23.1868 74.819 23.4857C74.9647 24.5258 75.95 24.6349 76.6783 24.7187C77.4067 24.8026 77.8779 24.8949 77.9551 25.3814C78.015 25.6917 77.8351 25.9182 77.4409 26.0356C77.13 26.1369 76.7937 26.1351 76.4839 26.0305C76.1742 25.9259 75.9082 25.7243 75.7272 25.4569C75.6745 25.3674 75.5899 25.3001 75.4896 25.268C75.3893 25.2358 75.2804 25.241 75.1838 25.2826C75.0872 25.3241 75.0096 25.3991 74.966 25.4932C74.9224 25.5873 74.9158 25.6938 74.9475 25.7924C75.1404 26.1535 75.435 26.4529 75.7965 26.6551C76.1579 26.8573 76.571 26.9538 76.9868 26.9331C77.2333 26.9339 77.4785 26.9 77.7151 26.8324C78.0735 26.7593 78.3893 26.5537 78.5968 26.2584C78.8043 25.9632 78.8875 25.601 78.829 25.2472C78.5977 24.1064 77.5438 23.989 76.7726 23.8967Z" fill="white" />' +
		'<path d="M81.3993 21.9267H80.8509V20.8363C80.8527 20.7812 80.8421 20.7263 80.8199 20.6756C80.7977 20.6248 80.7644 20.5795 80.7224 20.5427C80.6405 20.4628 80.5296 20.418 80.4139 20.418C80.2983 20.418 80.1874 20.4628 80.1055 20.5427C80.0634 20.5795 80.0301 20.6248 80.0079 20.6756C79.9857 20.7263 79.9751 20.7812 79.9769 20.8363V21.9267H79.4371C79.3796 21.9259 79.3226 21.9366 79.2695 21.9583C79.2165 21.9799 79.1685 22.012 79.1286 22.0525C79.0866 22.0893 79.0533 22.1346 79.0311 22.1853C79.0089 22.2361 78.9983 22.2909 79.0001 22.3461C78.9976 22.4026 79.0079 22.4589 79.0301 22.5111C79.0523 22.5632 79.0859 22.61 79.1286 22.6481C79.1685 22.6886 79.2165 22.7207 79.2695 22.7423C79.3226 22.7639 79.3796 22.7747 79.4371 22.7739H79.9855V24.8708C79.9863 24.8848 79.9863 24.8988 79.9855 24.9127V25.6928C79.9642 25.8526 79.9787 26.0149 80.0281 26.1686C80.0776 26.3223 80.1607 26.4636 80.2716 26.5826C80.3826 26.7016 80.5187 26.7955 80.6706 26.8576C80.8225 26.9198 80.9863 26.9488 81.1508 26.9426C81.2644 26.9426 81.3734 26.8984 81.4537 26.8197C81.5341 26.7411 81.5792 26.6344 81.5792 26.5232C81.5792 26.4119 81.5341 26.3053 81.4537 26.2266C81.3734 26.148 81.2644 26.1038 81.1508 26.1038C81.0051 26.1038 80.8338 26.1038 80.8338 25.6844V24.9127C80.8338 24.9127 80.8338 24.9127 80.8338 24.8708V22.7739H81.3993C81.4568 22.7747 81.5138 22.7639 81.5669 22.7423C81.6199 22.7207 81.6679 22.6886 81.7078 22.6481C81.7505 22.61 81.7841 22.5632 81.8063 22.5111C81.8285 22.4589 81.8388 22.4026 81.8363 22.3461C81.8381 22.2909 81.8275 22.2361 81.8053 22.1853C81.7831 22.1346 81.7498 22.0893 81.7078 22.0525C81.6679 22.012 81.6199 21.9799 81.5669 21.9583C81.5138 21.9366 81.4568 21.9259 81.3993 21.9267Z" fill="white" />' +
		'<path d="M47.6924 23.4856C47.554 23.3572 47.3947 23.2523 47.2211 23.1753C47.0414 23.0939 46.845 23.0537 46.647 23.0578C46.4269 23.0577 46.2109 23.1157 46.0215 23.2256C45.8993 23.2921 45.7845 23.3708 45.6788 23.4604V22.4288C45.6801 22.3636 45.6555 22.3004 45.6102 22.2526C45.5856 22.2283 45.5562 22.2089 45.5238 22.1958C45.4915 22.1826 45.4568 22.1758 45.4217 22.1758C45.3867 22.1758 45.352 22.1826 45.3196 22.1958C45.2873 22.2089 45.2579 22.2283 45.2332 22.2526C45.208 22.2747 45.188 22.3019 45.1747 22.3323C45.1614 22.3627 45.155 22.3957 45.1561 22.4288V25.7167C45.1559 25.7509 45.1627 25.7849 45.1759 25.8165C45.1891 25.8482 45.2086 25.877 45.2332 25.9013C45.2851 25.9467 45.3522 25.9717 45.4217 25.9717C45.4913 25.9717 45.5584 25.9467 45.6102 25.9013C45.6541 25.8493 45.6783 25.7841 45.6788 25.7167V25.6412C45.7862 25.7256 45.9043 25.7961 46.0301 25.8509C46.2219 25.9324 46.4294 25.9724 46.6385 25.9684C46.8363 25.9738 47.0331 25.9386 47.2161 25.8649C47.3991 25.7912 47.5643 25.6807 47.7009 25.5406C47.8307 25.4089 47.9351 25.2555 48.0094 25.0877C48.0917 24.9114 48.1327 24.7194 48.1294 24.5257C48.1294 24.3296 48.0886 24.1355 48.0094 23.9553C47.933 23.7816 47.8257 23.6225 47.6924 23.4856ZM46.27 25.3896C46.1595 25.3463 46.0579 25.2838 45.9701 25.2051C45.8846 25.121 45.8124 25.0249 45.7559 24.9199C45.7055 24.8086 45.6764 24.6892 45.6702 24.5676V24.5257C45.6763 24.396 45.7053 24.2683 45.7559 24.1482C45.8102 24.0369 45.8825 23.9349 45.9701 23.8463C46.0551 23.762 46.1573 23.6962 46.27 23.6534C46.5066 23.5609 46.7703 23.5609 47.0069 23.6534C47.122 23.7004 47.2268 23.7687 47.3154 23.8547C47.4012 23.943 47.4708 24.0451 47.521 24.1566C47.5719 24.2733 47.5981 24.3988 47.5981 24.5257C47.6 24.65 47.5737 24.7732 47.521 24.8863C47.4736 24.9994 47.4038 25.1021 47.3155 25.1885C47.2273 25.2749 47.1224 25.3432 47.0069 25.3896C46.8908 25.4395 46.7653 25.4653 46.6385 25.4653C46.5116 25.4653 46.3862 25.4395 46.27 25.3896Z" fill="white" />' +
		'<path d="M55.7108 2.60773C56.3307 2.60773 56.8333 2.11579 56.8333 1.50894C56.8333 0.9021 56.3307 0.410156 55.7108 0.410156C55.0909 0.410156 54.5884 0.9021 54.5884 1.50894C54.5884 2.11579 55.0909 2.60773 55.7108 2.60773Z" fill="white" />' +
		'<path d="M50.6049 22.6058C50.5516 22.6053 50.4993 22.6196 50.454 22.647C50.4063 22.6748 50.3695 22.7176 50.3498 22.7685L49.6199 24.5819L48.9188 22.7685C48.8982 22.7175 48.8607 22.6747 48.8123 22.647C48.7636 22.6181 48.7073 22.6038 48.6503 22.6058C48.6136 22.604 48.5769 22.61 48.5428 22.6235C48.5087 22.637 48.478 22.6576 48.4529 22.6839C48.4059 22.735 48.3805 22.8017 48.3819 22.8704C48.3818 22.91 48.3901 22.9491 48.4063 22.9854C48.4063 23.0071 48.4263 23.0418 48.4551 23.1155C48.4839 23.1893 48.5394 23.3325 48.6126 23.5212C48.6858 23.7099 48.7812 23.955 48.8966 24.2522C49.012 24.5494 49.1495 24.903 49.3137 25.3368L48.9632 26.2436C48.9632 26.2587 48.9632 26.2739 48.9498 26.2869C48.9475 26.3042 48.9475 26.3217 48.9498 26.339C48.9498 26.4087 48.9777 26.4757 49.0275 26.5256C49.0596 26.5587 49.0996 26.5833 49.144 26.5973C49.1884 26.6112 49.2357 26.614 49.2815 26.6053C49.3272 26.5967 49.37 26.5769 49.4059 26.5478C49.4418 26.5187 49.4696 26.4812 49.4867 26.4388L50.86 22.9811C50.8775 22.9474 50.8866 22.9103 50.8867 22.8726C50.8854 22.805 50.8576 22.7406 50.809 22.6925C50.7831 22.6649 50.7516 22.6428 50.7164 22.6279C50.6813 22.6129 50.6433 22.6054 50.6049 22.6058Z" fill="white"/>' +
		'</svg>',
    expand_power_form: '<svg width="21px" height="22px" viewBox="0 0 21 22" version="1.1" >' +
		'<g class="mgPlayerJSProd_Org-Settings" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_Group-21" transform="translate(0.759765, 0.499911)" fill="#33424E" fill-rule="nonzero">' +
		'<path d="M10.1624834,2.27541981 L3.04766596,10.8253949 L10.152206,19.156286 C10.6255219,19.7113033 10.5592897,20.544932 10.0042724,21.0182478 C9.44925516,21.4915636 8.61562647,21.4253315 8.14231066,20.8703142 L0.315807121,11.6928378 C-0.101354441,11.2036679 -0.105693382,10.485182 0.305529767,9.99100945 L8.1320333,0.585791292 C8.59861134,0.0250979825 9.4313793,-0.0511975253 9.99207261,0.415380506 C10.5527659,0.881958537 10.6290614,1.7147265 10.1624834,2.27541981 Z M19.4984209,2.16560259 L12.3836035,10.7155777 L19.4881435,19.0464688 C19.9614594,19.6014861 19.8952272,20.4351148 19.3402099,20.9084306 C18.7851927,21.3817464 17.951564,21.3155143 17.4782482,20.760497 L9.65174462,11.5830206 C9.23458306,11.0938506 9.23024412,10.3753648 9.64146727,9.88119224 L17.4679708,0.475974075 C17.9345488,-0.0847192344 18.7673168,-0.161014742 19.3280101,0.305563289 C19.8887034,0.77214132 19.9649989,1.60490928 19.4984209,2.16560259 Z" class="mgPlayerJSProd_combined-shape"></path>' +
		'</g>' +
		'</g>' +
		'</svg>',
    slideshow_maximize: '<svg width="13" height="13" viewBox="0 0 13 13">' +
		'<path fill="#FFFFFE" fill-rule="evenodd" d="M12.443 0h-4.86a.541.541 0 1 0 0 1.083h3.591L7.491 4.766l.766.766 3.676-3.676-.016 3.56a.541.541 0 1 0 1.083 0V.543c0-.16-.066-.29-.17-.379A.538.538 0 0 0 12.442 0zM5.417 11.917H1.826l3.683-3.683-.766-.766-3.676 3.677.016-3.562a.541.541 0 1 0-1.083 0v4.875c0 .161.066.29.17.379.1.1.236.163.387.163h4.86a.541.541 0 1 0 0-1.083z"/>' +
		'</svg>',
    slideshow_minimize: '<svg width="20px" height="20px" viewBox="0 0 23 22" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_02-branching-Steps-in-Slideshow" transform="translate(-1425.000000, -157.000000)" fill="#FFFFFF" fill-rule="nonzero" stroke="#FFFFFF">' +
		'<g class="mgPlayerJSProd_Group" transform="translate(1372.000000, 158.000000)">' +
		'<g class="mgPlayerJSProd_Group-13" transform="translate(54.000000, 0.000000)">' +
		'<path d="M6.47313953,15.1523381 L0.915079615,20.7103981 L6.21813712e-12,19.7953184 L5.53024234,14.2650761 L2.58626288,14.2351782 L2.59940477,12.9411273 L7.76576717,12.9935949 L7.76930426,18.1171178 L6.47518692,18.1180112 L6.47313953,15.1523381 Z" class="mgPlayerJSProd_combined-shape"></path>' +
		'<path d="M15.1545626,6.47094784 L18.1222454,6.47094784 L18.1222454,7.76506548 L12.9493121,7.76506548 L12.945775,2.58903707 L14.2398923,2.58815272 L14.2419187,5.55343307 L19.7955164,2.52700421e-15 L20.7105958,0.915079364 L15.1545626,6.47094784 Z" class="mgPlayerJSProd_combined-shape"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    playerbar_prev_button: '<svg width="12px" height="12px" viewBox="0 0 12 12" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_GuideMe-Player_slideshow-03-_new" transform="translate(-331.000000, -936.000000)" fill="#FFFFFF">' +
		'<g class="mgPlayerJSProd_play--pssh-" transform="translate(315.000000, 925.000000)">' +
		'<polygon class="mgPlayerJSProd_shape" points="18.8725 16.25 23.065 12.0575 22 11 16 17 22 23 23.0575 21.9425 18.8725 17.75 28 17.75 28 16.25"></polygon>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    playerbar_next_button: '<svg width="12px" height="12px" viewBox="0 0 12 12" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_GuideMe-Player_slideshow-03-_new" transform="translate(-423.000000, -936.000000)" fill="#FFFFFF">' +
		'<g class="mgPlayerJSProd_play--pssh-" transform="translate(315.000000, 925.000000)">' +
		'<g class="mgPlayerJSProd_ic_skip_previous-copy" transform="translate(114.000000, 17.000000) scale(-1, 1) translate(-114.000000, -17.000000) translate(102.000000, 5.000000)">' +
		'<polygon class="mgPlayerJSProd_shape" points="18 11.25 8.8725 11.25 13.065 7.0575 12 6 6 12 12 18 13.0575 16.9425 8.8725 12.75 18 12.75"></polygon>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    slideshow_unmute: '<svg width="33" height="33" viewBox="0 0 33 33" fill="none" xmlns="http://www.w3.org/2000/svg">' +
    '<path d="M21.0738 13.7253C20.7266 13.5565 20.296 13.704 20.1253 14.0587C19.956 14.4129 20.1058 14.8378 20.46 15.0071C21.0875 15.3089 21.4778 15.8805 21.4778 16.5C21.4778 17.1196 21.0875 17.6911 20.46 17.9925C20.1058 18.1618 19.956 18.5871 20.1253 18.9409C20.2969 19.2987 20.7271 19.4427 21.0738 19.2742C22.2 18.7347 22.9 17.6716 22.9 16.5C22.9 15.3285 22.2 14.2649 21.0738 13.7253ZM16.136 7.96667C15.8733 7.96667 15.6062 8.06356 15.3902 8.28001L11.436 12.2333H6.89998C6.31065 12.2333 5.83331 12.7107 5.83331 13.3V19.7C5.83331 20.2889 6.31065 20.7667 6.89998 20.7667H11.436L15.3902 24.72C15.6066 24.9365 15.8738 25.0333 16.136 25.0333C16.684 25.0333 17.2111 24.6102 17.2111 23.9658V9.03423C17.2111 8.38934 16.6835 7.96667 16.136 7.96667ZM15.7889 23.1076L12.0249 19.3445H7.25554V13.6556H12.0249L15.7889 9.89245V23.1076ZM27.1666 16.4996C27.1666 13.5609 25.6546 10.872 23.2195 9.48312C22.8778 9.28845 22.4378 9.40401 22.24 9.7449C22.0422 10.0853 22.1613 10.52 22.5049 10.7165C24.4946 11.852 25.732 14.0676 25.732 16.4996C25.732 18.9316 24.4946 21.1476 22.5049 22.2827C22.1618 22.4791 22.0426 22.9138 22.24 23.2542C22.4311 23.5822 22.8649 23.7182 23.2195 23.516C25.6546 22.1276 27.1666 19.4387 27.1666 16.4996Z" fill="#555555">' +
    '</svg>',
    slideshow_mute: '<svg width="32" height="32" viewBox="0 0 32 32"><g fill="#555" fillrule="evenodd">' +
      '<path d="M11.864 17.654l-2.996-4.286 2.996-2.996v7.282zm8.488-15.771L18.79.32 0 19.11l1.563 1.562 5.716-5.715 2.896 4.139a2.15 2.15 0 0 0 1.688.795 2.205 2.205 0 0 0 2.21-2.21V8.162l6.28-6.28zM4.125 11.858V7.734h3.892l3.845-5.497v1.885l2.172-2.172c-.093-.79-.58-1.477-1.327-1.785a2.229 2.229 0 0 0-2.408.48L6.865 5.522h-2.74c-1.219 0-2.21.992-2.21 2.21v4.422c0 .534.198 1.017.514 1.4l1.696-1.697z">' +
      '</g>' +
      '</svg>',
    slideshow_video_mode: '<svg width="20px" height="14px" viewBox="0 0 20 14" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_GuideMe-Player_video02_new" transform="translate(-1138.000000, -936.000000)" fill="#FFFFFF">' +
		'<g class="mgPlayerJSProd_Group-3-Copy-15" transform="translate(1130.000000, 925.000000)">' +
		'<g class="mgPlayerJSProd_Group-3" transform="translate(8.000000, 8.000000)">' +
		'<path d="M14.4827586,6.29411765 L14.4827586,4.23529412 C14.4827586,3.55258824 14.02,3 13.4482759,3 L1.72413793,3 C0.771724138,3 0,6.13435294 0,10 C0,13.8656471 0.771724138,17 1.72413793,17 L13.4482759,17 C14.02,17 14.4827586,16.4474118 14.4827586,15.7647059 L14.4827586,13.7058824 L20,17 L20,3 L14.4827586,6.29411765 Z" class="mgPlayerJSProd_Stroke-732"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    add_icon: '<svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">' +
  '<path fill-rule="evenodd" clip-rule="evenodd" d="M19.2 13.3H12.8V19.7C12.8 19.9122 12.7157 20.1157 12.5657 20.2657C12.4157 20.4157 12.2122 20.5 12 20.5C11.7878 20.5 11.5843 20.4157 11.4343 20.2657C11.2843 20.1157 11.2 19.9122 11.2 19.7V13.3H4.8C4.58783 13.3 4.38434 13.2157 4.23431 13.0657C4.08429 12.9157 4 12.7122 4 12.5C4 12.2878 4.08429 12.0843 4.23431 11.9343C4.38434 11.7843 4.58783 11.7 4.8 11.7H11.2V5.3C11.2 5.19494 11.2207 5.09091 11.2609 4.99385C11.3011 4.89679 11.36 4.8086 11.4343 4.73431C11.5086 4.66003 11.5968 4.6011 11.6939 4.5609C11.7909 4.52069 11.8949 4.5 12 4.5C12.1051 4.5 12.2091 4.52069 12.3061 4.5609C12.4032 4.6011 12.4914 4.66003 12.5657 4.73431C12.64 4.8086 12.6989 4.89679 12.7391 4.99385C12.7793 5.09091 12.8 5.19494 12.8 5.3V11.7H19.2C19.4122 11.7 19.6157 11.7843 19.7657 11.9343C19.9157 12.0843 20 12.2878 20 12.5C20 12.7122 19.9157 12.9157 19.7657 13.0657C19.6157 13.2157 19.4122 13.3 19.2 13.3Z" fill="#555555"/>'+
 '</svg>',
    subtract_icon: '<svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">' +
 '<path fill-rule="evenodd" clip-rule="evenodd" d="M19.2 11.5C19.642 11.5 20 11.948 20 12.5C20 13.052 19.642 13.5 19.2 13.5H4.8C4.358 13.5 4 13.052 4 12.5C4 11.948 4.358 11.5 4.8 11.5H19.2Z" fill="#555555"/>'+
 '</svg>',
    slideshow_giphy_mode: '<svg width="14" height="11" viewBox="0 0 14 11">' +
		'<g fill="none" fill-rule="nonzero">' +
		'<circle cx="3.26" cy="6.802" r="3.255" fill="#FFF"/>' +
		'<circle cx="6.82" cy="5.028" r="3.255" fill="#003054" stroke="#175280" stroke-opacity=".612" stroke-width=".25"/>' +
		'<path fill="#FFF" d="M10.381 6.38a3.124 3.124 0 1 1 3.124-3.124 3.128 3.128 0 0 1-3.124 3.124z"/>' +
		'<path fill="#FFF9F9" d="M10.381.262a2.993 2.993 0 1 1-2.993 2.993A2.997 2.997 0 0 1 10.381.262zm0-.262a3.255 3.255 0 1 0 0 6.51 3.255 3.255 0 0 0 0-6.51z"/>' +
		'</g>' +
		'</svg>',
    slideshow_mode: '<svg width="15" height="14" viewBox="0 0 15 14">' +
		'<path fill="#FEFFFF" fill-rule="evenodd" d="M13.086 9.02c0 .53-.353.862-.89.862H3.284c-.537 0-.891-.332-.891-.862L2.387.824h10.706l-.007 8.196zM.74 0v.875h.875v8.313c0 1.036.72 1.75 1.75 1.75H5.99L4.24 14l1.318-.006 1.745-3.056h.875l1.744 3.056L11.24 14l-1.75-3.063h2.625c1.031 0 1.75-.713 1.75-1.75V.876h.875V0h-14zm4.294 3.294h5.412a1 1 0 0 1 1 1v2.941a1 1 0 0 1-1 1H5.034a1 1 0 0 1-1-1v-2.94a1 1 0 0 1 1-1zm-.176 4.118h5.765v-2.47l-2.306 2.47-1.153-1.853-2.306 1.853zm3.706-3.294a.412.412 0 1 0 0-.824.412.412 0 0 0 0 .824z"/>' +
		'</svg>',
    playerbar_close: '<svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_GuideMe-Player_video02_new" transform="translate(-1546.000000, -932.000000)" fill="#EFEFF5">' +
		'<path d="M1559.53562,944.65 C1559.78,944.89375 1559.78,945.29375 1559.53562,945.5375 C1559.29188,945.78125 1558.89563,945.78125 1558.65125,945.5375 L1556.00375,942.8875 L1553.3375,945.55625 C1553.09125,945.8 1552.6925,945.8 1552.44625,945.55625 C1552.20062,945.30625 1552.20062,944.90625 1552.44625,944.6625 L1555.1125,941.99375 L1552.465,939.35 C1552.22062,939.10625 1552.22062,938.70625 1552.465,938.4625 C1552.70813,938.21875 1553.10437,938.21875 1553.34875,938.4625 L1555.99625,941.1125 L1558.6825,938.425 C1558.92875,938.18125 1559.32687,938.18125 1559.57312,938.425 C1559.81875,938.675 1559.81875,939.06875 1559.57312,939.31875 L1556.8875,942.00625 L1559.53562,944.65 L1559.53562,944.65 Z M1556,932 C1550.47688,932 1546,936.475 1546,942 C1546,947.525 1550.47688,952 1556,952 C1561.52312,952 1566,947.525 1566,942 C1566,936.475 1561.52312,932 1556,932 L1556,932 Z" class="mgPlayerJSProd_Fill-23"></path>' +
		'</g>' +
		'</g>' +
		'</svg>',
    branch_slideshow: '<svg width="26px" height="19px" viewBox="0 0 26 19" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.5">' +
		'<g class="mgPlayerJSProd_02-branching-Steps-in-Slideshow" transform="translate(-708.000000, -287.000000)" fill="#FFFFFF" fill-rule="nonzero">' +
		'<g class="mgPlayerJSProd_Group-17" transform="translate(721.000000, 296.375000) scale(1, -1) rotate(90.000000) translate(-721.000000, -296.375000) translate(712.000000, 284.000000)">' +
		'<path d="M17.9743355,3.54499151 C17.9743355,5.50285655 16.387209,7.08998302 14.429344,7.08998302 C12.4714789,7.08998302 10.8843525,5.50285655 10.8843525,3.54499151 C10.8843525,1.58714746 12.4714885,-1.50990331e-14 14.429344,-1.50990331e-14 C16.3871994,-1.50990331e-14 17.9743355,1.58714746 17.9743355,3.54499151 Z M16.7519246,3.54499151 C16.7519246,2.26226437 15.7120786,1.22241087 14.429344,1.22241087 C13.1466093,1.22241087 12.1067633,2.26226437 12.1067633,3.54499151 C12.1067633,4.82773767 13.1465978,5.86757216 14.429344,5.86757216 C15.7120901,5.86757216 16.7519246,4.82773767 16.7519246,3.54499151 Z" class="mgPlayerJSProd_Stroke-1"></path>' +
		'<polygon class="mgPlayerJSProd_Stroke-3" points="2.93378608 6.47877759 4.15619694 6.47877759 4.15619694 18.2444822 2.93378608 18.2444822"></polygon>' +
		'<path d="M7.08998302,3.54499151 C7.08998302,5.50285655 5.50285655,7.08998302 3.54499151,7.08998302 C1.58712647,7.08998302 -1.03828057e-12,5.50285655 -1.03828057e-12,3.54499151 C-1.03828057e-12,1.58714746 1.58713604,-1.50990331e-14 3.54499151,-1.50990331e-14 C5.50284698,-1.50990331e-14 7.08998302,1.58714746 7.08998302,3.54499151 Z M5.86757216,3.54499151 C5.86757216,2.26226437 4.82772614,1.22241087 3.54499151,1.22241087 C2.26225689,1.22241087 1.22241087,2.26226437 1.22241087,3.54499151 C1.22241087,4.82773767 2.26224535,5.86757216 3.54499151,5.86757216 C4.82773767,5.86757216 5.86757216,4.82773767 5.86757216,3.54499151 Z" class="mgPlayerJSProd_Stroke-5"></path>' +
		'<path d="M7.08998302,21.1782835 C7.08998302,23.1361276 5.50284698,24.723275 3.54499151,24.723275 C1.58713604,24.723275 -1.03828057e-12,23.1361276 -1.03828057e-12,21.1782835 C-1.03828057e-12,19.2204185 1.58712647,17.633292 3.54499151,17.633292 C5.50285655,17.633292 7.08998302,19.2204185 7.08998302,21.1782835 Z M5.86757216,21.1782835 C5.86757216,19.8955374 4.82773767,18.8557029 3.54499151,18.8557029 C2.26224535,18.8557029 1.22241087,19.8955374 1.22241087,21.1782835 C1.22241087,22.4610107 2.26225689,23.5008642 3.54499151,23.5008642 C4.82772614,23.5008642 5.86757216,22.4610107 5.86757216,21.1782835 Z" class="mgPlayerJSProd_Stroke-7"></path>' +
		'<path d="M13.8181385,8.63838031 L13.8181385,6.47877759 L15.0405494,6.47877759 L15.0405494,8.63838031 C15.0405494,10.5962244 13.4534134,12.1833718 11.4955579,12.1833718 L6.4787837,12.1833718 L6.4787837,10.960961 L11.4955579,10.960961 C12.7782925,10.960961 13.8181385,9.92110745 13.8181385,8.63838031 Z M6.47877759,10.960961 L6.47877759,12.1833718 C5.19603143,12.1833718 4.15619694,13.2232063 4.15619694,14.5059525 L2.93378608,14.5059525 C2.93378608,12.5480874 4.52091255,10.960961 6.47877759,10.960961 Z" class="mgPlayerJSProd_combined-shape"></path>" +' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    icon_play_step: '<svg width="38px" height="43px" viewBox="0 0 38 43" version="1.1" >' +
		'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_Mobile" transform="translate(-129.000000, -142.000000)" fill="#ffffff">' +
		'<g class="mgPlayerJSProd_Group-3" transform="translate(129.000000, 142.000000)">' +
		'<path d="M35.9019,23.8148 L4.3299,42.0428 C1.9489,43.4178 -0.0001,42.2928 -0.0001,39.5428 L-0.0001,3.0868 C-0.0001,0.3368 1.9489,-0.7882 4.3299,0.5868 L35.9019,18.8148 C38.2829,20.1898 38.2829,22.4398 35.9019,23.8148" class="mgPlayerJSProd_Fill-1"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    icon_pause_step: '<svg width="15px" height="21px" viewBox="0 0 15 21" version="1.1" >' +
		'<g class="mgPlayerJSProd_Popup-Design" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
		'<g class="mgPlayerJSProd_Automation-Setp-POPUP" transform="translate(-765.000000, -999.000000)" fill="#FFFFFE">' +
		'<g class="mgPlayerJSProd_automation-step-popup-copy" transform="translate(198.000000, 736.000000)">' +
		'<path d="M580.5,263 L577.5,263 C576.672,263 576,263.672 576,264.5 L576,282.5 C576,283.328 576.672,284 577.5,284 L580.5,284 C581.328,284 582,283.328 582,282.5 L582,264.5 C582,263.672 581.328,263 580.5,263 L580.5,263 Z M571.5,263 L568.5,263 C567.672,263 567,263.672 567,264.5 L567,282.5 C567,283.328 567.672,284 568.5,284 L571.5,284 C572.328,284 573,283.328 573,282.5 L573,264.5 C573,263.672 572.328,263 571.5,263 L571.5,263 Z" class="mgPlayerJSProd_Fill-125"></path>' +
		'</g>' +
		'</g>' +
		'</g>' +
		'</svg>',
    smallscreen: '<svg version="1.1" class="mgPlayerJSProd_Capa_1" x="0px" y="0px" viewBox="0 0 28.359 28.359" style="enable-background:new 0 0 28.359 28.359;" xml:space="preserve">' +
		'<g>' +
		'<g class="mgPlayerJSProd_c116_arrows">' +
		'<path d="M21.935,19.368h3.235c0.878-0.003,1.589-0.67,1.589-1.492c0-0.824-0.711-1.492-1.589-1.492h-6.764 c-0.879,0-1.59,0.668-1.591,1.492c0.001,0.019,0.007,0.041,0.007,0.061c0,0.027-0.007,0.057-0.007,0.086v6.673 c0,0.864,0.666,1.566,1.49,1.566c0.822-0.002,1.492-0.702,1.492-1.566v-3.252l6.018,6.02c0.582,0.583,1.525,0.583,2.108,0 c0.58-0.582,0.58-1.526,0-2.108L21.935,19.368z"/>' +
		'<path d="M11.543,17.876c-0.002-0.824-0.712-1.492-1.592-1.492H3.189c-0.877,0-1.593,0.668-1.593,1.492 c0,0.822,0.716,1.489,1.593,1.492h3.235l-5.991,5.986c-0.577,0.582-0.577,1.526,0,2.108c0.584,0.583,1.527,0.583,2.108,0 l6.019-6.02v3.252c0,0.864,0.67,1.564,1.491,1.566c0.826,0,1.491-0.702,1.491-1.566v-6.673c0-0.029-0.008-0.059-0.008-0.086 C11.535,17.917,11.541,17.895,11.543,17.876z"/>' +
		'<path d="M16.815,10.479c0.001,0.824,0.712,1.491,1.591,1.491h6.764c0.878,0,1.589-0.667,1.589-1.491 c0-0.822-0.711-1.487-1.589-1.489h-3.235l5.989-5.987c0.58-0.584,0.58-1.528,0-2.109c-0.583-0.582-1.526-0.582-2.108,0 l-6.018,6.02V3.662c0-0.867-0.67-1.568-1.492-1.568c-0.824,0-1.49,0.701-1.49,1.568v6.671c0,0.03,0.007,0.057,0.007,0.087 C16.822,10.44,16.816,10.456,16.815,10.479z"/>' +
		'<path d="M10.052,2.094c-0.821,0-1.491,0.701-1.491,1.568v3.251l-6.019-6.02c-0.581-0.582-1.524-0.582-2.108,0 c-0.577,0.581-0.577,1.525,0,2.109l5.991,5.987H3.189c-0.876,0.003-1.592,0.668-1.592,1.49c0,0.824,0.716,1.491,1.593,1.491h6.761 c0.88,0,1.59-0.667,1.592-1.491c-0.002-0.023-0.008-0.039-0.008-0.06c0-0.03,0.008-0.057,0.008-0.087v-6.67 C11.543,2.795,10.878,2.094,10.052,2.094z"/>' +
		'</g>' +
		'<g class="mgPlayerJSProd_Capa_1_156_">' +
		'</g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'<g>' +
		'</g>' +
		'</svg>',
    play_step_audio_off: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none">' +
		'<mask class="mgPlayerJSProd_path-1-outside-1" maskUnits="userSpaceOnUse" x="0" y="-0.366699" width="19" height="17" fill="black">' +
		'<rect fill="white" y="-0.366699" width="19" height="17"/>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.0755 15.5729C10.1334 15.613 10.2007 15.6333 10.2682 15.6333C10.3235 15.6333 10.3789 15.6197 10.4295 15.5922C10.542 15.5312 10.6122 15.4116 10.6122 15.2815V0.985114C10.6122 0.852045 10.5388 0.730341 10.4224 0.670632C10.3062 0.611029 10.1669 0.623485 10.0625 0.703072C10.0229 0.733296 6.12166 3.70627 3.79778 5.31987H1.34404C1.15403 5.31987 1 5.47743 1 5.67172V10.5949C1 10.7892 1.15403 10.9467 1.34404 10.9467H3.79765C4.92723 11.7312 5.91912 12.4876 6.87919 13.2197L6.87993 13.2202C7.87115 13.976 8.89613 14.7576 10.0755 15.5729ZM3.90323 10.2431H1.68808V6.02361H3.90333C3.97204 6.02361 4.03916 6.00256 4.09603 5.96323C5.90625 4.7116 8.7392 2.58106 9.92413 1.68434V14.6139C8.97669 13.9413 8.12158 13.2893 7.29049 12.6555C6.29956 11.8999 5.27491 11.1186 4.09593 10.3034C4.03902 10.2641 3.9719 10.2431 3.90323 10.2431ZM17.9084 6.53378L15.9422 8.50005L17.9084 10.4662C18.0305 10.5883 18.0305 10.7863 17.9084 10.9084C17.8473 10.9695 17.7673 11 17.6873 11C17.6074 11 17.5273 10.9695 17.4662 10.9084L15.5001 8.94211L13.5338 10.9084C13.4727 10.9695 13.3926 11 13.3127 11C13.2327 11 13.1527 10.9695 13.0916 10.9085C12.9695 10.7864 12.9695 10.5884 13.0916 10.4663L15.0579 8.50005L13.0916 6.53378C12.9695 6.41172 12.9695 6.21368 13.0916 6.09162C13.2138 5.96946 13.4116 5.96946 13.5338 6.09162L15.5001 8.05789L17.4662 6.09162C17.5884 5.96946 17.7862 5.96946 17.9084 6.09162C18.0305 6.21368 18.0305 6.41172 17.9084 6.53378Z"/>' +
		'</mask>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.0755 15.5729C10.1334 15.613 10.2007 15.6333 10.2682 15.6333C10.3235 15.6333 10.3789 15.6197 10.4295 15.5922C10.542 15.5312 10.6122 15.4116 10.6122 15.2815V0.985114C10.6122 0.852045 10.5388 0.730341 10.4224 0.670632C10.3062 0.611029 10.1669 0.623485 10.0625 0.703072C10.0229 0.733296 6.12166 3.70627 3.79778 5.31987H1.34404C1.15403 5.31987 1 5.47743 1 5.67172V10.5949C1 10.7892 1.15403 10.9467 1.34404 10.9467H3.79765C4.92723 11.7312 5.91912 12.4876 6.87919 13.2197L6.87993 13.2202C7.87115 13.976 8.89613 14.7576 10.0755 15.5729ZM3.90323 10.2431H1.68808V6.02361H3.90333C3.97204 6.02361 4.03916 6.00256 4.09603 5.96323C5.90625 4.7116 8.7392 2.58106 9.92413 1.68434V14.6139C8.97669 13.9413 8.12158 13.2893 7.29049 12.6555C6.29956 11.8999 5.27491 11.1186 4.09593 10.3034C4.03902 10.2641 3.9719 10.2431 3.90323 10.2431ZM17.9084 6.53378L15.9422 8.50005L17.9084 10.4662C18.0305 10.5883 18.0305 10.7863 17.9084 10.9084C17.8473 10.9695 17.7673 11 17.6873 11C17.6074 11 17.5273 10.9695 17.4662 10.9084L15.5001 8.94211L13.5338 10.9084C13.4727 10.9695 13.3926 11 13.3127 11C13.2327 11 13.1527 10.9695 13.0916 10.9085C12.9695 10.7864 12.9695 10.5884 13.0916 10.4663L15.0579 8.50005L13.0916 6.53378C12.9695 6.41172 12.9695 6.21368 13.0916 6.09162C13.2138 5.96946 13.4116 5.96946 13.5338 6.09162L15.5001 8.05789L17.4662 6.09162C17.5884 5.96946 17.7862 5.96946 17.9084 6.09162C18.0305 6.21368 18.0305 6.41172 17.9084 6.53378Z" fill="#757575"/>' +
		'<path d="M10.0755 15.5729L10.36 15.1617L10.3598 15.1616L10.0755 15.5729ZM10.4295 15.5922L10.1909 15.1528L10.1908 15.1529L10.4295 15.5922ZM10.4224 0.670632L10.6508 0.225813L10.6505 0.225677L10.4224 0.670632ZM10.0625 0.703072L10.3657 1.10066L10.3657 1.10063L10.0625 0.703072ZM3.79778 5.31987V5.81987H3.95435L4.08296 5.73058L3.79778 5.31987ZM3.79765 10.9467L4.08287 10.5361L3.95424 10.4467H3.79765V10.9467ZM6.87919 13.2197L6.57601 13.6173L6.57612 13.6173L6.87919 13.2197ZM6.87993 13.2202L7.1831 12.8226L7.183 12.8225L6.87993 13.2202ZM1.68808 10.2431H1.18808V10.7431H1.68808V10.2431ZM1.68808 6.02361V5.52361H1.18808V6.02361H1.68808ZM4.09603 5.96323L3.81167 5.55196L3.8116 5.55201L4.09603 5.96323ZM9.92413 1.68434H10.4241V0.678921L9.62241 1.28564L9.92413 1.68434ZM9.92413 14.6139L9.6347 15.0216L10.4241 15.582V14.6139H9.92413ZM7.29049 12.6555L7.59367 12.258L7.59367 12.258L7.29049 12.6555ZM4.09593 10.3034L4.38028 9.89217L4.38025 9.89215L4.09593 10.3034ZM15.9422 8.50005L15.5886 8.14651L15.2351 8.50006L15.5886 8.85361L15.9422 8.50005ZM17.9084 6.53378L17.555 6.18009L17.5548 6.18024L17.9084 6.53378ZM17.9084 10.4662L17.5548 10.8198L17.555 10.8199L17.9084 10.4662ZM17.9084 10.9084L17.555 10.5547L17.5548 10.5548L17.9084 10.9084ZM17.4662 10.9084L17.8198 10.5548L17.8198 10.5548L17.4662 10.9084ZM15.5001 8.94211L15.8536 8.58856L15.5001 8.235L15.1465 8.58855L15.5001 8.94211ZM13.5338 10.9084L13.1802 10.5548L13.1802 10.5548L13.5338 10.9084ZM13.0916 10.9085L12.7382 11.2622L12.7384 11.2623L13.0916 10.9085ZM13.0916 10.4663L13.445 10.82L13.4452 10.8199L13.0916 10.4663ZM15.0579 8.50005L15.4115 8.85361L15.765 8.50005L15.4115 8.1465L15.0579 8.50005ZM13.0916 6.53378L13.4452 6.18023L13.445 6.18009L13.0916 6.53378ZM13.0916 6.09162L13.445 6.44532L13.4452 6.44517L13.0916 6.09162ZM13.5338 6.09162L13.1802 6.44517L13.1802 6.44518L13.5338 6.09162ZM15.5001 8.05789L15.1465 8.41145L15.5001 8.765L15.8536 8.41144L15.5001 8.05789ZM17.4662 6.09162L17.1127 5.73807L17.1127 5.73808L17.4662 6.09162ZM17.9084 6.09162L17.5548 6.44517L17.555 6.44532L17.9084 6.09162ZM10.2682 15.1333C10.3011 15.1333 10.3333 15.1433 10.36 15.1617L9.79098 15.9841C9.93362 16.0828 10.1004 16.1333 10.2682 16.1333V15.1333ZM10.1908 15.1529C10.2145 15.14 10.2413 15.1333 10.2682 15.1333V16.1333C10.4056 16.1333 10.5433 16.0994 10.6682 16.0315L10.1908 15.1529ZM10.1122 15.2815C10.1122 15.2324 10.1387 15.1812 10.1909 15.1528L10.6681 16.0316C10.9452 15.8811 11.1122 15.5908 11.1122 15.2815H10.1122ZM10.1122 0.985114V15.2815H11.1122V0.985114H10.1122ZM10.1941 1.11545C10.14 1.08766 10.1122 1.03536 10.1122 0.985114H11.1122C11.1122 0.668733 10.9376 0.373023 10.6508 0.225813L10.1941 1.11545ZM10.3657 1.10063C10.3173 1.13753 10.25 1.14412 10.1944 1.11559L10.6505 0.225677C10.3623 0.0779435 10.0164 0.109434 9.75928 0.305513L10.3657 1.10063ZM4.08296 5.73058C6.41776 4.10938 10.3283 1.12917 10.3657 1.10066L9.75931 0.305489C9.71744 0.337422 5.82555 3.30316 3.51261 4.90917L4.08296 5.73058ZM1.34404 5.81987H3.79778V4.81987H1.34404V5.81987ZM1.5 5.67172C1.5 5.7429 1.44072 5.81987 1.34404 5.81987V4.81987C0.86733 4.81987 0.5 5.21196 0.5 5.67172H1.5ZM1.5 10.5949V5.67172H0.5V10.5949H1.5ZM1.34404 10.4467C1.44072 10.4467 1.5 10.5237 1.5 10.5949H0.5C0.5 11.0546 0.86733 11.4467 1.34404 11.4467V10.4467ZM3.79765 10.4467H1.34404V11.4467H3.79765V10.4467ZM7.18237 12.8221C6.22304 12.0905 5.22283 11.3278 4.08287 10.5361L3.51243 11.3574C4.63163 12.1347 5.6152 12.8846 6.57601 13.6173L7.18237 12.8221ZM7.183 12.8225L7.18226 12.822L6.57612 13.6173L6.57686 13.6179L7.183 12.8225ZM10.3598 15.1616C9.19134 14.3538 8.17504 13.579 7.1831 12.8226L6.57676 13.6178C7.56726 14.3731 8.60092 15.1613 9.79114 15.9842L10.3598 15.1616ZM1.68808 10.7431H3.90323V9.74307H1.68808V10.7431ZM1.18808 6.02361V10.2431H2.18808V6.02361H1.18808ZM3.90333 5.52361H1.68808V6.52361H3.90333V5.52361ZM3.8116 5.55201C3.83767 5.53398 3.86963 5.52361 3.90333 5.52361V6.52361C4.07444 6.52361 4.24065 6.47115 4.38046 6.37444L3.8116 5.55201ZM9.62241 1.28564C8.43606 2.18343 5.61161 4.30744 3.81167 5.55196L4.38039 6.37449C6.2009 5.11576 9.04234 2.97869 10.2259 2.08304L9.62241 1.28564ZM10.4241 14.6139V1.68434H9.42413V14.6139H10.4241ZM6.98731 13.0531C7.81773 13.6864 8.6793 14.3434 9.6347 15.0216L10.2136 14.2062C9.27408 13.5392 8.42544 12.8922 7.59367 12.258L6.98731 13.0531ZM3.81157 10.7147C4.97969 11.5224 5.99566 12.297 6.98731 13.0531L7.59367 12.258C6.60345 11.5029 5.57013 10.7148 4.38028 9.89217L3.81157 10.7147ZM3.90323 10.7431C3.86945 10.7431 3.83755 10.7327 3.8116 10.7147L4.38025 9.89215C4.2405 9.79554 4.07435 9.74307 3.90323 9.74307V10.7431ZM16.2958 8.8536L18.2619 6.88733L17.5548 6.18024L15.5886 8.14651L16.2958 8.8536ZM18.2619 10.1127L16.2957 8.1465L15.5886 8.85361L17.5548 10.8198L18.2619 10.1127ZM18.2618 11.2621C18.5794 10.9447 18.5794 10.4299 18.2618 10.1125L17.555 10.8199C17.4817 10.7467 17.4817 10.6279 17.555 10.5547L18.2618 11.2621ZM17.6873 11.5C17.8946 11.5 18.1034 11.4205 18.2619 11.2619L17.5548 10.5548C17.5912 10.5184 17.64 10.5 17.6873 10.5V11.5ZM17.1127 11.2619C17.2712 11.4205 17.4801 11.5 17.6873 11.5V10.5C17.7347 10.5 17.7834 10.5184 17.8198 10.5548L17.1127 11.2619ZM15.1465 9.29565L17.1127 11.2619L17.8198 10.5548L15.8536 8.58856L15.1465 9.29565ZM13.8873 11.2619L15.8536 9.29566L15.1465 8.58855L13.1802 10.5548L13.8873 11.2619ZM13.3127 11.5C13.5199 11.5 13.7288 11.4205 13.8873 11.2619L13.1802 10.5548C13.2166 10.5184 13.2653 10.5 13.3127 10.5V11.5ZM12.7384 11.2623C12.8968 11.4205 13.1055 11.5 13.3127 11.5V10.5C13.36 10.5 13.4086 10.5184 13.4449 10.5546L12.7384 11.2623ZM12.7382 10.1126C12.4206 10.43 12.4206 10.9448 12.7382 11.2622L13.445 10.5548C13.5183 10.628 13.5183 10.7468 13.445 10.82L12.7382 10.1126ZM14.7044 8.1465L12.7381 10.1128L13.4452 10.8199L15.4115 8.85361L14.7044 8.1465ZM12.7381 6.88734L14.7044 8.85361L15.4115 8.1465L13.4452 6.18023L12.7381 6.88734ZM12.7382 5.73792C12.4206 6.05528 12.4206 6.57013 12.7382 6.88748L13.445 6.18009C13.5183 6.25332 13.5183 6.37208 13.445 6.44532L12.7382 5.73792ZM13.8873 5.73808C13.5699 5.42064 13.0555 5.42064 12.7381 5.73808L13.4452 6.44517C13.3721 6.51828 13.2533 6.51828 13.1802 6.44517L13.8873 5.73808ZM15.8536 7.70434L13.8873 5.73807L13.1802 6.44518L15.1465 8.41145L15.8536 7.70434ZM17.1127 5.73808L15.1465 7.70435L15.8536 8.41144L17.8198 6.44517L17.1127 5.73808ZM18.2619 5.73807C17.9445 5.42064 17.4301 5.42064 17.1127 5.73807L17.8198 6.44517C17.7467 6.51828 17.6279 6.51828 17.5548 6.44517L18.2619 5.73807ZM18.2618 6.88748C18.5794 6.57013 18.5794 6.05528 18.2618 5.73793L17.555 6.44532C17.4817 6.37208 17.4817 6.25332 17.555 6.18009L18.2618 6.88748Z" fill="#757575" mask="url(#mgPlayerJSProd_path-1-outside-1)"/>' +
		'</svg>',
    play_step_audio_on: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none">' +
		'<mask class="mgPlayerJSProd_path-1-outside-1" maskUnits="userSpaceOnUse" x="0" y="-0.366699" width="19" height="17" fill="black">' +
		'<rect fill="white" y="-0.366699" width="19" height="17"/>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.2682 15.6333C10.2007 15.6333 10.1334 15.613 10.0755 15.5729C8.89613 14.7576 7.87115 13.976 6.87993 13.2202L6.87919 13.2197C5.91912 12.4876 4.92723 11.7312 3.79765 10.9467H1.34404C1.15403 10.9467 1 10.7892 1 10.5949V5.67172C1 5.47743 1.15403 5.31987 1.34404 5.31987H3.79778C6.12166 3.70627 10.0229 0.733296 10.0625 0.703072C10.1669 0.623485 10.3062 0.611029 10.4224 0.670632C10.5388 0.730341 10.6122 0.852045 10.6122 0.985114V15.2815C10.6122 15.4116 10.542 15.5312 10.4295 15.5922C10.3789 15.6197 10.3235 15.6333 10.2682 15.6333ZM1.68808 10.2431H3.90323C3.9719 10.2431 4.03902 10.2641 4.09593 10.3034C5.27491 11.1186 6.29956 11.8999 7.29049 12.6555C8.12158 13.2893 8.97669 13.9413 9.92413 14.6139V1.68434C8.7392 2.58106 5.90625 4.7116 4.09603 5.96323C4.03916 6.00256 3.97204 6.02361 3.90333 6.02361H1.68808V10.2431ZM13.2438 10.9244C13.155 10.9244 13.0663 10.8895 12.999 10.8197C12.8655 10.6814 12.8668 10.4587 13.0021 10.3221C13.5813 9.73721 13.9003 8.95988 13.9003 8.13331C13.9003 7.30668 13.5813 6.52938 13.002 5.94458C12.8668 5.80806 12.8654 5.58527 12.9989 5.44696C13.1324 5.30865 13.3501 5.30724 13.4854 5.44372C14.1967 6.16181 14.5884 7.117 14.5884 8.13328C14.5884 9.14952 14.1967 10.1047 13.4855 10.8228C13.4184 10.8906 13.3311 10.9244 13.2438 10.9244ZM15.601 12.4459C15.6683 12.5157 15.7571 12.5506 15.8458 12.5506C15.9331 12.5506 16.0205 12.5168 16.0875 12.4491C17.229 11.2966 17.8576 9.76397 17.8576 8.13354C17.8576 6.50315 17.229 4.97047 16.0875 3.81778C15.9523 3.68126 15.7344 3.68267 15.6009 3.82095C15.4674 3.95926 15.4688 4.18201 15.604 4.31856C16.6136 5.33797 17.1696 6.69283 17.1696 8.13354C17.1696 9.57429 16.6136 10.9291 15.6041 11.9483C15.4689 12.0849 15.4675 12.3076 15.601 12.4459Z"/>' +
		'</mask>' +
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M10.2682 15.6333C10.2007 15.6333 10.1334 15.613 10.0755 15.5729C8.89613 14.7576 7.87115 13.976 6.87993 13.2202L6.87919 13.2197C5.91912 12.4876 4.92723 11.7312 3.79765 10.9467H1.34404C1.15403 10.9467 1 10.7892 1 10.5949V5.67172C1 5.47743 1.15403 5.31987 1.34404 5.31987H3.79778C6.12166 3.70627 10.0229 0.733296 10.0625 0.703072C10.1669 0.623485 10.3062 0.611029 10.4224 0.670632C10.5388 0.730341 10.6122 0.852045 10.6122 0.985114V15.2815C10.6122 15.4116 10.542 15.5312 10.4295 15.5922C10.3789 15.6197 10.3235 15.6333 10.2682 15.6333ZM1.68808 10.2431H3.90323C3.9719 10.2431 4.03902 10.2641 4.09593 10.3034C5.27491 11.1186 6.29956 11.8999 7.29049 12.6555C8.12158 13.2893 8.97669 13.9413 9.92413 14.6139V1.68434C8.7392 2.58106 5.90625 4.7116 4.09603 5.96323C4.03916 6.00256 3.97204 6.02361 3.90333 6.02361H1.68808V10.2431ZM13.2438 10.9244C13.155 10.9244 13.0663 10.8895 12.999 10.8197C12.8655 10.6814 12.8668 10.4587 13.0021 10.3221C13.5813 9.73721 13.9003 8.95988 13.9003 8.13331C13.9003 7.30668 13.5813 6.52938 13.002 5.94458C12.8668 5.80806 12.8654 5.58527 12.9989 5.44696C13.1324 5.30865 13.3501 5.30724 13.4854 5.44372C14.1967 6.16181 14.5884 7.117 14.5884 8.13328C14.5884 9.14952 14.1967 10.1047 13.4855 10.8228C13.4184 10.8906 13.3311 10.9244 13.2438 10.9244ZM15.601 12.4459C15.6683 12.5157 15.7571 12.5506 15.8458 12.5506C15.9331 12.5506 16.0205 12.5168 16.0875 12.4491C17.229 11.2966 17.8576 9.76397 17.8576 8.13354C17.8576 6.50315 17.229 4.97047 16.0875 3.81778C15.9523 3.68126 15.7344 3.68267 15.6009 3.82095C15.4674 3.95926 15.4688 4.18201 15.604 4.31856C16.6136 5.33797 17.1696 6.69283 17.1696 8.13354C17.1696 9.57429 16.6136 10.9291 15.6041 11.9483C15.4689 12.0849 15.4675 12.3076 15.601 12.4459Z" fill="#757575"/>' +
		'<path d="M10.0755 15.5729L10.36 15.1617L10.3598 15.1616L10.0755 15.5729ZM6.87993 13.2202L7.1831 12.8226L7.183 12.8225L6.87993 13.2202ZM6.87919 13.2197L6.57601 13.6173L6.57612 13.6173L6.87919 13.2197ZM3.79765 10.9467L4.08287 10.5361L3.95424 10.4467H3.79765V10.9467ZM3.79778 5.31987V5.81987H3.95435L4.08296 5.73058L3.79778 5.31987ZM10.0625 0.703072L10.3657 1.10066L10.3657 1.10063L10.0625 0.703072ZM10.4224 0.670632L10.6508 0.225813L10.6505 0.225677L10.4224 0.670632ZM10.4295 15.5922L10.1909 15.1528L10.1908 15.1529L10.4295 15.5922ZM1.68808 10.2431H1.18808V10.7431H1.68808V10.2431ZM4.09593 10.3034L4.38028 9.89217L4.38025 9.89215L4.09593 10.3034ZM7.29049 12.6555L7.59367 12.258L7.59367 12.258L7.29049 12.6555ZM9.92413 14.6139L9.6347 15.0216L10.4241 15.582V14.6139H9.92413ZM9.92413 1.68434H10.4241V0.678921L9.62241 1.28564L9.92413 1.68434ZM4.09603 5.96323L3.81167 5.55196L3.8116 5.55201L4.09603 5.96323ZM1.68808 6.02361V5.52361H1.18808V6.02361H1.68808ZM12.999 10.8197L12.6392 11.167L12.6392 11.167L12.999 10.8197ZM13.0021 10.3221L13.3573 10.674L13.3574 10.674L13.0021 10.3221ZM13.002 5.94458L13.3572 5.5927L13.3572 5.59269L13.002 5.94458ZM12.9989 5.44696L12.6392 5.09964L12.6391 5.09974L12.9989 5.44696ZM13.4854 5.44372L13.8407 5.09185L13.8405 5.09174L13.4854 5.44372ZM13.4855 10.8228L13.1302 10.471L13.1301 10.4712L13.4855 10.8228ZM15.601 12.4459L15.9608 12.0987L15.9607 12.0987L15.601 12.4459ZM16.0875 12.4491L15.7323 12.0973L15.7322 12.0974L16.0875 12.4491ZM16.0875 3.81778L16.4427 3.46595L16.4427 3.46593L16.0875 3.81778ZM15.6009 3.82095L15.2412 3.47368L15.2412 3.47372L15.6009 3.82095ZM15.604 4.31856L15.2487 4.67036L15.2488 4.6704L15.604 4.31856ZM15.6041 11.9483L15.9593 12.3002L15.9594 12.3002L15.6041 11.9483ZM9.79098 15.9841C9.93362 16.0828 10.1004 16.1333 10.2682 16.1333V15.1333C10.3011 15.1333 10.3333 15.1433 10.36 15.1617L9.79098 15.9841ZM6.57676 13.6178C7.56726 14.3731 8.60092 15.1613 9.79114 15.9842L10.3598 15.1616C9.19134 14.3538 8.17504 13.579 7.1831 12.8226L6.57676 13.6178ZM6.57612 13.6173L6.57686 13.6179L7.183 12.8225L7.18226 12.822L6.57612 13.6173ZM3.51243 11.3574C4.63163 12.1347 5.6152 12.8846 6.57601 13.6173L7.18237 12.8221C6.22304 12.0905 5.22283 11.3278 4.08287 10.5361L3.51243 11.3574ZM1.34404 11.4467H3.79765V10.4467H1.34404V11.4467ZM0.5 10.5949C0.5 11.0546 0.86733 11.4467 1.34404 11.4467V10.4467C1.44072 10.4467 1.5 10.5237 1.5 10.5949H0.5ZM0.5 5.67172V10.5949H1.5V5.67172H0.5ZM1.34404 4.81987C0.86733 4.81987 0.5 5.21196 0.5 5.67172H1.5C1.5 5.7429 1.44072 5.81987 1.34404 5.81987V4.81987ZM3.79778 4.81987H1.34404V5.81987H3.79778V4.81987ZM9.75931 0.305489C9.71744 0.337422 5.82555 3.30316 3.51261 4.90917L4.08296 5.73058C6.41776 4.10938 10.3283 1.12917 10.3657 1.10066L9.75931 0.305489ZM10.6505 0.225677C10.3623 0.0779435 10.0164 0.109434 9.75928 0.305513L10.3657 1.10063C10.3173 1.13753 10.25 1.14412 10.1944 1.11559L10.6505 0.225677ZM11.1122 0.985114C11.1122 0.668733 10.9376 0.373023 10.6508 0.225813L10.1941 1.11545C10.14 1.08766 10.1122 1.03536 10.1122 0.985114H11.1122ZM11.1122 15.2815V0.985114H10.1122V15.2815H11.1122ZM10.6681 16.0316C10.9452 15.8811 11.1122 15.5908 11.1122 15.2815H10.1122C10.1122 15.2324 10.1387 15.1812 10.1909 15.1528L10.6681 16.0316ZM10.2682 16.1333C10.4056 16.1333 10.5433 16.0994 10.6682 16.0315L10.1908 15.1529C10.2145 15.14 10.2413 15.1333 10.2682 15.1333V16.1333ZM3.90323 9.74307H1.68808V10.7431H3.90323V9.74307ZM4.38025 9.89215C4.2405 9.79554 4.07435 9.74307 3.90323 9.74307V10.7431C3.86945 10.7431 3.83755 10.7327 3.8116 10.7147L4.38025 9.89215ZM7.59367 12.258C6.60345 11.5029 5.57013 10.7148 4.38028 9.89217L3.81157 10.7147C4.97969 11.5224 5.99566 12.297 6.98731 13.0531L7.59367 12.258ZM10.2136 14.2062C9.27408 13.5392 8.42544 12.8922 7.59367 12.258L6.98731 13.0531C7.81773 13.6864 8.6793 14.3434 9.6347 15.0216L10.2136 14.2062ZM9.42413 1.68434V14.6139H10.4241V1.68434H9.42413ZM4.38039 6.37449C6.2009 5.11576 9.04234 2.97869 10.2259 2.08304L9.62241 1.28564C8.43606 2.18343 5.61161 4.30744 3.81167 5.55196L4.38039 6.37449ZM3.90333 6.52361C4.07444 6.52361 4.24065 6.47115 4.38046 6.37444L3.8116 5.55201C3.83767 5.53398 3.86963 5.52361 3.90333 5.52361V6.52361ZM1.68808 6.52361H3.90333V5.52361H1.68808V6.52361ZM2.18808 10.2431V6.02361H1.18808V10.2431H2.18808ZM12.6392 11.167C12.8034 11.3371 13.0232 11.4244 13.2438 11.4244V10.4244C13.2868 10.4244 13.3292 10.4419 13.3587 10.4725L12.6392 11.167ZM12.6468 9.97028C12.3202 10.3 12.3171 10.8333 12.6392 11.167L13.3587 10.4725C13.4138 10.5296 13.4135 10.6173 13.3573 10.674L12.6468 9.97028ZM13.4003 8.13331C13.4003 8.82872 13.1329 9.47944 12.6468 9.97029L13.3574 10.674C14.0298 9.99498 14.4003 9.09103 14.4003 8.13331H13.4003ZM12.6468 6.29645C13.1329 6.78718 13.4003 7.43784 13.4003 8.13331H14.4003C14.4003 7.17552 14.0297 6.27158 13.3572 5.5927L12.6468 6.29645ZM12.6391 5.09974C12.317 5.43348 12.3202 5.96676 12.6468 6.29647L13.3572 5.59269C13.4134 5.64936 13.4138 5.73706 13.3586 5.79418L12.6391 5.09974ZM13.8405 5.09174C13.5078 4.75604 12.9675 4.75964 12.6392 5.09964L13.3585 5.79427C13.2973 5.85765 13.1925 5.85844 13.1303 5.7957L13.8405 5.09174ZM15.0884 8.13328C15.0884 6.98605 14.6453 5.90416 13.8407 5.09185L13.1302 5.79559C13.7482 6.41946 14.0884 7.24796 14.0884 8.13328H15.0884ZM13.8408 11.1747C14.6453 10.3623 15.0884 9.28048 15.0884 8.13328H14.0884C14.0884 9.01856 13.7482 9.84704 13.1302 10.471L13.8408 11.1747ZM13.2438 11.4244C13.4608 11.4244 13.6773 11.3398 13.8409 11.1745L13.1301 10.4712C13.1596 10.4414 13.2013 10.4244 13.2438 10.4244V11.4244ZM15.8458 12.0506C15.8889 12.0506 15.9312 12.0681 15.9608 12.0987L15.2412 12.7931C15.4053 12.9632 15.6252 13.0506 15.8458 13.0506V12.0506ZM15.7322 12.0974C15.7618 12.0675 15.8035 12.0506 15.8458 12.0506V13.0506C16.0628 13.0506 16.2793 12.9661 16.4429 12.8009L15.7322 12.0974ZM17.3576 8.13354C17.3576 9.63294 16.7805 11.0389 15.7323 12.0973L16.4428 12.801C17.6775 11.5543 18.3576 9.89499 18.3576 8.13354H17.3576ZM15.7322 4.16961C16.7805 5.22815 17.3576 6.63418 17.3576 8.13354H18.3576C18.3576 6.37212 17.6775 4.71279 16.4427 3.46595L15.7322 4.16961ZM15.9607 4.16822C15.8994 4.23171 15.7945 4.23249 15.7322 4.16963L16.4427 3.46593C16.11 3.13003 15.5695 3.13363 15.2412 3.47368L15.9607 4.16822ZM15.9593 3.96676C16.0154 4.02343 16.0158 4.1111 15.9607 4.16817L15.2412 3.47372C14.9191 3.80742 14.9222 4.3406 15.2487 4.67036L15.9593 3.96676ZM17.6696 8.13354C17.6696 6.56169 17.062 5.0802 15.9593 3.96673L15.2488 4.6704C16.1652 5.59574 16.6696 6.82397 16.6696 8.13354H17.6696ZM15.9594 12.3002C17.062 11.1868 17.6696 9.70542 17.6696 8.13354H16.6696C16.6696 9.44315 16.1652 10.6713 15.2489 11.5965L15.9594 12.3002ZM15.9607 12.0987C16.0159 12.1558 16.0155 12.2435 15.9593 12.3002L15.2489 11.5964C14.9223 11.9262 14.9191 12.4595 15.2413 12.7932L15.9607 12.0987Z" fill="#757575" mask="url(#mgPlayerJSProd_path-1-outside-1)"/>' +
		'</svg>',
    external_link_white: '<svg  fill="white" viewBox="0 0 30 30" width="24px" height="24px">' +
		'<path d="M 25.980469 2.9902344 A 1.0001 1.0001 0 0 0 25.869141 3 L 20 3 A 1.0001 1.0001 0 1 0 20 5 L 23.585938 5 L 13.292969 15.292969 A 1.0001 1.0001 0 1 0 14.707031 16.707031 L 25 6.4140625 L 25 10 A 1.0001 1.0001 0 1 0 27 10 L 27 4.1269531 A 1.0001 1.0001 0 0 0 25.980469 2.9902344 z M 6 7 C 4.9069372 7 4 7.9069372 4 9 L 4 24 C 4 25.093063 4.9069372 26 6 26 L 21 26 C 22.093063 26 23 25.093063 23 24 L 23 14 L 23 11.421875 L 21 13.421875 L 21 16 L 21 24 L 6 24 L 6 9 L 14 9 L 16 9 L 16.578125 9 L 18.578125 7 L 16 7 L 14 7 L 6 7 z"/>' +
		'</svg>',
    close_media_popup: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 24 24" width="24" height="24">' +
		'<g>' +
		'<path xmlns:default="http://www.w3.org/2000/svg" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" style="fill: rgb(255, 255, 255);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'</svg>',
    print_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 24 24" width="24" height="24">' +
		'<g>' +
		'<path xmlns:default="http://www.w3.org/2000/svg" d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" style="fill: rgb(255, 255, 255);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'</svg>',
    min_pdf_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 514 514" xml:space="preserve" y="0px" x="0px" class="mgPlayerJSProd_Layer_1_1621441515254" width="20" height="20">' +
		'<g transform="translate(1, 1)">' +
		'<style type="text/css">' +
		'.mgPlayerJSProd_st0_1621441515254 {' +
			'fill: #394042;' +
		'}' +
		'</style>' +
		'<path d="M140,274c-6.6,0-12-5.4-12-12v-12c0-6.6,5.4-12,12-12h232c6.6,0,12,5.4,12,12v12c0,6.6-5.4,12-12,12H140z   M504,256c0,137-111,248-248,248S8,393,8,256S119,8,256,8S504,119,504,256z M472,256c0-119.9-97.3-216-216-216  C136.1,40,40,137.3,40,256c0,119.9,97.3,216,216,216C375.9,472,472,374.7,472,256z" class="mgPlayerJSProd_st0_1621441515254" vector-effect="non-scaling-stroke" style="fill: rgba(255, 255, 255, 0.8);" />' +
		'</g>' +
		'</svg>',
    max_pdf_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 19.375 19.375" width="19.375" height="19.375">' +
		'<g transform="translate(0, 0)">' +
		'<g transform="translate(0, 0) rotate(0)">' +
		'<path d="M14.6875,9.45313v0.46875c0,0.25781 -0.21094,0.46875 -0.46875,0.46875h-3.82812v3.82813c0,0.25781 -0.21094,0.46875 -0.46875,0.46875h-0.46875c-0.25781,0 -0.46875,-0.21094 -0.46875,-0.46875v-3.82812h-3.82812c-0.25781,0 -0.46875,-0.21094 -0.46875,-0.46875v-0.46875c0,-0.25781 0.21094,-0.46875 0.46875,-0.46875h3.82813v-3.82812c0,-0.25781 0.21094,-0.46875 0.46875,-0.46875h0.46875c0.25781,0 0.46875,0.21094 0.46875,0.46875v3.82813h3.82813c0.25781,0 0.46875,0.21094 0.46875,0.46875zM19.375,9.6875c0,5.35156 -4.33594,9.6875 -9.6875,9.6875c-5.35156,0 -9.6875,-4.33594 -9.6875,-9.6875c0,-5.35156 4.33594,-9.6875 9.6875,-9.6875c5.35156,0 9.6875,4.33594 9.6875,9.6875zM18.125,9.6875c0,-4.68359 -3.80078,-8.4375 -8.4375,-8.4375c-4.68359,0 -8.4375,3.80078 -8.4375,8.4375c0,4.68359 3.80078,8.4375 8.4375,8.4375c4.68359,0 8.4375,-3.80078 8.4375,-8.4375z" style="stroke-width: 0; stroke-linecap: butt; stroke-linejoin: miter; fill: rgba(255, 255, 255, 0.8);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'<defs>' +
		'<path class="mgPlayerJSProd_path-162254104429736" d="M14.6875,9.45313v0.46875c0,0.25781 -0.21094,0.46875 -0.46875,0.46875h-3.82812v3.82813c0,0.25781 -0.21094,0.46875 -0.46875,0.46875h-0.46875c-0.25781,0 -0.46875,-0.21094 -0.46875,-0.46875v-3.82812h-3.82812c-0.25781,0 -0.46875,-0.21094 -0.46875,-0.46875v-0.46875c0,-0.25781 0.21094,-0.46875 0.46875,-0.46875h3.82813v-3.82812c0,-0.25781 0.21094,-0.46875 0.46875,-0.46875h0.46875c0.25781,0 0.46875,0.21094 0.46875,0.46875v3.82813h3.82813c0.25781,0 0.46875,0.21094 0.46875,0.46875zM19.375,9.6875c0,5.35156 -4.33594,9.6875 -9.6875,9.6875c-5.35156,0 -9.6875,-4.33594 -9.6875,-9.6875c0,-5.35156 4.33594,-9.6875 9.6875,-9.6875c5.35156,0 9.6875,4.33594 9.6875,9.6875zM18.125,9.6875c0,-4.68359 -3.80078,-8.4375 -8.4375,-8.4375c-4.68359,0 -8.4375,3.80078 -8.4375,8.4375c0,4.68359 3.80078,8.4375 8.4375,8.4375c4.68359,0 8.4375,-3.80078 8.4375,-8.4375z" vector-effect="non-scaling-stroke" />' +
		'</defs>' +
		'</g>' +
		'</svg>',
    page_down_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 24 24" width="20" height="20">' +
		'<g>' +
		'<path xmlns:default="http://www.w3.org/2000/svg" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z" fill="#010101" style="fill: rgba(255, 255, 255, 0.8);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'</svg>',
    page_up_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 24 24" width="20" height="20">' +
		'<g>' +
		'<path xmlns:default="http://www.w3.org/2000/svg" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z" fill="#010101" style="fill: rgba(255, 255, 255, 0.8);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'</svg>',
    pdf_download_icon: '<svg version="1.2" overflow="visible" preserveAspectRatio="none" viewBox="0 0 18.77415 17.33333" width="18.77415" height="17.33333">' +
		'<g transform="translate(0, 0)">' +
		'<g transform="translate(-0.000020000000001241247, -2.220446049250313e-16) rotate(0)">' +
		'<path d="M14.22417,15.67583c-0.28167,0.27083 -0.72583,0.26 -0.99667,-0.02167c-0.27083,-0.28167 -0.26,-0.72583 0.02167,-0.99667c0.28167,-0.27083 0.72583,-0.26 0.99667,0.02167c0.13,0.13 0.195,0.30333 0.195,0.4875c0,0.195 -0.08667,0.37917 -0.21667,0.50917zM17.10583,15.67583c-0.28167,0.27083 -0.72583,0.26 -0.99667,-0.02167c-0.27083,-0.28167 -0.26,-0.72583 0.02167,-0.99667c0.28167,-0.27083 0.72583,-0.26 0.99667,0.02167c0.13,0.13 0.195,0.30333 0.195,0.4875c0,0.195 -0.07583,0.37917 -0.21667,0.50917zM18.77417,12.6425c0,-0.59583 -0.4875,-1.08333 -1.08333,-1.08333h-5.24333l-1.53833,1.53833c-0.845,0.845 -2.22083,0.845 -3.06583,0v0l-1.51667,-1.53833h-5.24333c-0.59583,0 -1.08333,0.4875 -1.08333,1.08333v3.6075c0,0.59583 0.4875,1.08333 1.08333,1.08333h16.59667c0.59583,0 1.08333,-0.4875 1.08333,-1.08333v-3.61833v0zM14.44083,5.785h-2.8925v-5.05917c-0.01083,-0.40083 -0.33583,-0.715 -0.73667,-0.72583h-2.88167c-0.39,0.01083 -0.715,0.325 -0.72583,0.72583v5.04833h-2.87083c-0.30333,-0.01083 -0.56333,0.1625 -0.67167,0.44417c-0.14083,0.27083 -0.065,0.59583 0.1625,0.79083l5.04833,5.04833c0.27083,0.28167 0.715,0.2925 0.99667,0.02167c0.01083,-0.01083 0.01083,-0.01083 0.02167,-0.02167l5.04833,-5.04833c0.2275,-0.195 0.30333,-0.52 0.1625,-0.79083c-0.0975,-0.28167 -0.37917,-0.46583 -0.6825,-0.44417z" style="stroke-width: 0; stroke-linecap: butt; stroke-linejoin: miter; fill: rgb(255, 255, 255);" vector-effect="non-scaling-stroke" />' +
		'</g>' +
		'<defs>' +
		'<path class="mgPlayerJSProd_path-162254104427026" d="M14.22417,15.67583c-0.28167,0.27083 -0.72583,0.26 -0.99667,-0.02167c-0.27083,-0.28167 -0.26,-0.72583 0.02167,-0.99667c0.28167,-0.27083 0.72583,-0.26 0.99667,0.02167c0.13,0.13 0.195,0.30333 0.195,0.4875c0,0.195 -0.08667,0.37917 -0.21667,0.50917zM17.10583,15.67583c-0.28167,0.27083 -0.72583,0.26 -0.99667,-0.02167c-0.27083,-0.28167 -0.26,-0.72583 0.02167,-0.99667c0.28167,-0.27083 0.72583,-0.26 0.99667,0.02167c0.13,0.13 0.195,0.30333 0.195,0.4875c0,0.195 -0.07583,0.37917 -0.21667,0.50917zM18.77417,12.6425c0,-0.59583 -0.4875,-1.08333 -1.08333,-1.08333h-5.24333l-1.53833,1.53833c-0.845,0.845 -2.22083,0.845 -3.06583,0v0l-1.51667,-1.53833h-5.24333c-0.59583,0 -1.08333,0.4875 -1.08333,1.08333v3.6075c0,0.59583 0.4875,1.08333 1.08333,1.08333h16.59667c0.59583,0 1.08333,-0.4875 1.08333,-1.08333v-3.61833v0zM14.44083,5.785h-2.8925v-5.05917c-0.01083,-0.40083 -0.33583,-0.715 -0.73667,-0.72583h-2.88167c-0.39,0.01083 -0.715,0.325 -0.72583,0.72583v5.04833h-2.87083c-0.30333,-0.01083 -0.56333,0.1625 -0.67167,0.44417c-0.14083,0.27083 -0.065,0.59583 0.1625,0.79083l5.04833,5.04833c0.27083,0.28167 0.715,0.2925 0.99667,0.02167c0.01083,-0.01083 0.01083,-0.01083 0.02167,-0.02167l5.04833,-5.04833c0.2275,-0.195 0.30333,-0.52 0.1625,-0.79083c-0.0975,-0.28167 -0.37917,-0.46583 -0.6825,-0.44417z" vector-effect="non-scaling-stroke" />' +
		'</defs>' +
		'</g>' +
		'</svg>',

    iconExternalLink: '<svg  class="mgPlayerJSProd_width-height-100" viewBox="0 0 24 25" fill="none">'+
		'<path fill-rule="evenodd" clip-rule="evenodd" d="M19.3521 5.68455C19.3891 5.77155 19.4091 5.91455 19.4091 5.91455H19.3901V10.8506C19.3901 11.2506 19.0761 11.4736 18.6751 11.4736H18.6851C18.2841 11.4736 17.9411 11.2506 17.9411 10.8506V7.76755L11.6751 14.0686C11.3921 14.3526 10.9331 14.3456 10.6921 14.0626V14.0496C10.4501 13.7666 10.3851 13.2816 10.6691 12.9996L16.9531 6.63955H13.8701C13.4701 6.63955 13.1081 6.34155 13.1081 5.94055V5.96655C13.1081 5.56655 13.4701 5.19055 13.8701 5.19055H18.7021H18.6661V5.24055C18.9071 5.24055 19.2421 5.42355 19.3521 5.68455ZM16.1901 12.3766L17.6401 13.8266V18.3996C17.6401 19.1996 17.0101 19.8096 16.2101 19.8096H6.05906C5.25906 19.8096 4.59106 19.1996 4.59106 18.3996V8.25055C4.59106 7.45055 5.25906 6.76055 6.06006 6.76055H10.6321L12.0821 8.21055H6.04206V18.3605H16.1901V12.3766Z" fill="#555555"/>'+
		'</svg>',

    taskCompleted: '<svg width="10px" height="7px" viewBox="0 0 10 7" version="1.1"  >' +
			'<g class="mgPlayerJSProd_Guide-Settings-3" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
				'<g class="mgPlayerJSProd_Widget-settings-06" transform="translate(-667.000000, -387.000000)" fill="#09B002" fill-rule="nonzero">' +
					'<g class="mgPlayerJSProd_Group-15" transform="translate(295.000000, 335.000000)">' +
						'<g class="mgPlayerJSProd_Create-Rules">' +
							'<g class="mgPlayerJSProd_Group-13" transform="translate(366.000000, 45.000000)">' +
								'<path d="M14.4641065,7.17913453 L9.05523893,12.5531704 L7.03997546,10.527955 C6.80112943,10.289109 6.41798057,10.289109 6.17913453,10.527955 C5.94028849,10.7668011 5.94028849,11.1499499 6.17913453,11.388796 L8.62233048,13.8469198 C8.73677754,13.9613669 8.89103227,14.0260543 9.05523893,14.0260543 L9.05523893,14.0260543 C9.21446962,14.0260543 9.36872435,13.9613669 9.48317141,13.8469198 L15.3249475,8.03997546 C15.5637935,7.80112943 15.5637935,7.41798057 15.3249475,7.17913453 C15.0861014,6.94028849 14.7029526,6.94028849 14.4641065,7.17913453 Z" class="mgPlayerJSProd_shape">' +'</path>' +
							'</g>' +
						'</g>' +
					'</g>' +
				'</g>' +
			'</g>' +
		'</svg>',
    doubleTick: '<svg width="32px" height="32px" viewBox="0 0 32 32" version="1.1"  >' +
			'<g class="mgPlayerJSProd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">' +
				'<g class="mgPlayerJSProd_verified" fill="green" fill-rule="nonzero">' +
					'<path d="M27.3136875,4.68625 C24.2916875,1.6643125 20.27375,0 16,0 C11.7261875,0 7.70825,1.6643125 4.68625,4.68625 C1.6643125,7.70825 0,11.72625 0,16 C0,20.27375 1.6643125,24.2916875 4.68625,27.3136875 C7.70825,30.3356875 11.72625,32 16,32 C20.27375,32 24.2916875,30.3356875 27.3136875,27.31375 C30.3356875,24.2916875 32,20.27375 32,16 C32,11.72625 30.3356875,7.7083125 27.3136875,4.68625 Z M23.644125,12.1920625 L14.7025625,21.1336875 C14.5195,21.31675 14.2795625,21.40825 14.0396875,21.40825 C13.79975,21.40825 13.5598125,21.31675 13.37675,21.1336875 L8.355875,16.112875 C7.98975,15.7468125 7.98975,15.15325 8.355875,14.7870625 C8.7219375,14.4209375 9.3155625,14.4209375 9.6816875,14.7870625 L14.0396875,19.145 L22.3183125,10.86625 C22.684375,10.500125 23.278,10.500125 23.644125,10.86625 C24.01025,11.232375 24.01025,11.8259375 23.644125,12.1920625 Z" class="mgPlayerJSProd_shape"></path>' +
				'</g>' +
			'</g>' +
		'</svg>',
};

GmCXt.svgs = Object.assign({},GmCXt.svgs,GmCXt.playerSvgs);

/*global GmCXt*/
GmCXt.getCreatorAppFeatures = function() {

    return {
        quickFilters: true,
        hasEmbedMenu: true,
        tourDownload: true,
        publish: true,
        copyTour: true,
        toolTips: true,
        branchStep: true,
        inlineStep: true,
        messageStep: true,
        imageStep: true,
        creatorApp: true,
        guideApp: true,
        onboardingGuide: true,
        showMe: true,
        audio: true,
        testme: GmCXt.conf.appConfig.testme,
        addSubCat: true,
        addTour: true,
        importTour: true,
        uploadTour: true,
        advancedFilter: true,
        tourUserInfo: true,
        manageAccount: true,
        analytics: true,
        userSettings: true,
        taskStatus: true,
        userDetails: true,
        defaultDomain: true
    };
};

GmCXt.getPlayerFeatures = function() {

    return {
        publishedGuides: true,
        publishedCat: true,
        isPlayer: true,
        showMe: true,
        audio: true,
        testme: GmCXt.conf.appConfig.testme
    };
};

GmCXt.isWestpac = function() {
    if (GmCXt.conf.appConfig.customer === 'westpac') return true;
    else return false;
};

GmCXt.isMyGuide = function() {
    if (GmCXt.conf.appConfig.customer === 'myguide') return true;
    else return false;
};

GmCXt.isPlayer = function() {
    if (GmCXt.conf.appName === GmCXt.conf.playerApp || GmCXt.showPlayer)
        return true;
    else
        return false;
};

GmCXt.isExtension = function() {
    if (GmCXt.conf.appType === GmCXt.conf.appTypeExt)
        return true;
    else
        return false;
};

GmCXt.isClientJs = function() {
    if (GmCXt.conf.appType === GmCXt.conf.appTypeScript)
        return true;
    else
        return false;
};

GmCXt.isMicroPlayer = function() {
    if (GmCXt.isPlayer() && GmCXt.isMiniPlayer) {
        return true;
    } else {
        return false;
    }
};

GmCXt.isCreatorExt = function() {
    if (GmCXt.conf.appName === GmCXt.conf.creatorApp)
        return true;
    else
        return false;
};

GmCXt.onPrem = function() {
    if (GmCXt.conf.env === "OnPremise")
        return true;
    else
        return false;
};

GmCXt.isElectron = function() {
    if (GmCXt.conf.runEnv === GmCXt.conf.appTypeElectron)
        return true;
    else
        return false;
};

GmCXt.isHumana = function() {
    if (GmCXt.isPlayer() && GmCXt.conf.appConfig.customer === 'humana') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isMcKesson = function() {
    if (GmCXt.conf.appConfig.customer === 'mckesson') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isMcKessonClientJS = function() {
    if (GmCXt.isClientJs() && GmCXt.conf.appConfig.customer === 'mckesson') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isSalesForcePopOutSide = function() {
    let url = GmCXt.getUrl();
    if (GmCXt.checkSalesForceSite() && url.indexOf('lightning/popout') !== -1)
        return true;
    else
        return false;
};

if (GmCXt.isCreatorExt()) {
    GmCXt.FT = GmCXt.getCreatorAppFeatures();
} else {
    GmCXt.FT = GmCXt.getPlayerFeatures(); // Default is guide app
}

GmCXt.isAbbvie = function() {
    if (GmCXt.conf.appConfig.customer === 'abbvie') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isLXP = function() {
    if (GmCXt.conf.appConfig.customer === 'lxp')
        return true;
    else
        return false;
};

GmCXt.isAWS = function() {
    if (GmCXt.conf.infra === "aws") {
        return true;
    } else {
        return false;
    }
};

GmCXt.isSumtotal = function() {
    if (GmCXt.conf.appConfig.customer === 'sumtotal') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isGalaxy = function() {
    if (GmCXt.conf.appConfig.customer === 'galaxy') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isSbx = function() {
    if (GmCXt.conf.appConfig.customer === 'sbx') {
        return true;
    } else {
        return false;
    }
};

GmCXt.myGuideInternalCustomers = function() {
    if (GmCXt.conf.appConfig.customer === 'myguide' || GmCXt.conf.appConfig.customer === 'sumtotal' || GmCXt.conf.appConfig.customer === 'galaxy' || GmCXt.conf.appConfig.customer === 'sbx'|| GmCXt.conf.appConfig.customer === 'charter' || GmCXt.conf.appConfig.customer === 'mckesson') {
        return true;
    } else {
        return false;
    }
};

GmCXt.isDesktop = function() {
    if (GmCXt.playerI && GmCXt.playerI.source === GmCXt.sourceDesktop) {
        return true;
    } else {
        return false;
    }
};

/*global mg$*/
GmCXt.getAppStorage = function (keys) {
    return new Promise(function (resolve, reject) {
        let items = {};
        for (let i = 0; i < keys.length; i++) {
            let key;
            if (GmCXt.isLXP()) {
                key = 'mgLxp' + keys[i];
            } else {
                key = GmCXt.addStoragePrefix(keys[i]);
            }
            let data = localStorage.getItem(key);

            if (data && data !== 'undefined') {
                data = GmCXt.parseJSON(data);
                items[keys[i]] = data;
            }
        }
        resolve(items);
    });
};

GmCXt.setAppStorage = function (data) {
    return new Promise(function (resolve, reject) {
        mg$.each(data, function (key, value) {
            if (GmCXt.isLXP()) {
                key = 'mgLxp' + key;
            } else {
                key = GmCXt.addStoragePrefix(key);
            }
            localStorage.setItem(key, JSON.stringify(value));
        });
        resolve();
    });
};

GmCXt.removeAppStorage = function (keys) {
    return new Promise(function (resolve, reject) {
        for (let i = 0; i < keys.length; i++) {
            let key;
            if (GmCXt.isLXP()) {
                key = 'mgLxp' + keys[i];
            } else {
                key = GmCXt.addStoragePrefix(keys[i]);
            }
            localStorage.removeItem(key);
        }
        resolve();
    });
};

GmCXt.getChromeStorage = function (keys) {
    let promise = new Promise(function (resolve, reject) {
        try {
            for (let i = 0; i < keys.length; i++) {
                keys[i] = GmCXt.addStoragePrefix(keys[i]);
            }

            chrome.storage.local.get(keys).then(function (items) {
                let d = {};
                for (let i in items) {
                    let key = GmCXt.removeStoragePrefix(i);
                    d[key] = items[i];
                }

                resolve(d);
            });
        } catch (e) {
            console.log(e);
        }
    });
    return promise;
};

GmCXt.setChromeStorage = function (data) {
    let promise = new Promise(function (resolve, reject) {
        if (data) {
            let keys = {};
            for (let d in data) {
                let key = GmCXt.addStoragePrefix(d);
                keys[key] = data[d];
            }

            try {
                chrome.storage.local.set(keys).then(function (items) {
                    resolve();
                });
            } catch (e) {}
        }
    });
    return promise;
};

GmCXt.removeChromeStorage = function (data) {
    let promise = new Promise(function (resolve, reject) {
        try {
            if (data) {
                for (let i = 0; i < data.length; i++) {
                    data[i] = GmCXt.addStoragePrefix(data[i]);
                }
                chrome.storage.local.remove(data, function () {
                    resolve();
                });
            }
        } catch (e) {}
    });

    return promise;
};

GmCXt.storage = function (options) {
    options = options || {};
    let pub = {};

    if (GmCXt.conf && GmCXt.isExtension() && GmCXt.browserApp !== 'Safari') {
        pub.get = GmCXt.getChromeStorage;
        pub.set = GmCXt.setChromeStorage;
        pub.remove = GmCXt.removeChromeStorage;
    } else {
        pub.get = GmCXt.getAppStorage;
        pub.set = GmCXt.setAppStorage;
        pub.remove = GmCXt.removeAppStorage;
    }

    return pub;
};

GmCXt.dapStore = {};
if (GmCXt.isBackgroundPage || GmCXt.isClientJs()) {
    GmCXt.removeFromDapStorage = function (key) {
        return new Promise(function (resolve, reject) {
            GmCXt.dapStore.removeItem(key).then(function () {
                resolve(true);
            });
        });
    };
    let dbName = GmCXt.conf.appName + GmCXt.conf.env + 'DB';
    if (GmCXt.isClientJs()) {
        let currentURL;

        if (GmCXt.isLXP() && document.referrer) {
            currentURL = GmCXt.filterUrlScheme(document.referrer).replaceAll('.', '');
            dbName += currentURL;
        }
    }

    let getIndexedDbInstance = function () {
        if (typeof localforage !== 'undefined') {
            return localforage.createInstance({
                name: dbName,
                storeName: 'mgStore',
            });
        } else {
            return {};
        }
    };

    GmCXt.dapStore = getIndexedDbInstance();
}

GmCXt.initialiseDapStore = function () {
    let cb = function (data) {
        GmCXt.dapStore = data;
        GmCXt.onDapStoreInstanceReceived();
    };

    if (GmCXt.isExtension()) {
        GmCXt.sendMessageToBackgroundService(
            {
                action: 'mgPlayerJSProd_action:init_dap_store',
            },
            cb,
        );
    }
};

/*global GmCXt,mg$*/
GmCXt.ruleEngine = (function() {
    let pub = {};
    let jobs = {};
    let _queue = [];

    let queue = function(d) {

        if (d && d.rules && d.tour) {

            let tourId = d.tour.tour_id;
            let initiator = d.initiator ? d.initiator : 'init';
            let idStr = "rule_" + tourId + "_" + initiator;
            let jobId = idStr + "_" + GmCXt.getUUID();

            if (!GmCXt.isEmpty(d.rules)) {
                d.rules = updateVariableRule(d.rules);
            }
            // Check is only for guide level rules; does not apply for step level rules
            if (d.isTour && initiator !== 'currentPage' && initiator !== 'currPageSeg') {
                jobId = idStr;
                if (GmCXt.inArrayString(jobId, _queue)) unqueue(jobId);
            }

            GmCXt.log(5, "QUEUED " + initiator + " : " + GmCXt.tourLog(d.tour));
            _queue.push(jobId);

            d.jobId = jobId;
            jobs[jobId] = d;

            if (!d.rules.length) {
                sendResponse(true, jobId);
            } else {
                validate(jobId);
            }
        }
    };

    var unqueue = function(jobId) {
        if (_unqueue(jobId)) {
            delete jobs[jobId];
        }
    };

    function _unqueue(jid) {
        let i = _queue.indexOf(parseInt(jid));
        if (i >= 0) {
            _queue.splice(i, 1);
            return true;
        }
        return false;
    }

    let clearJobs = function(i) {
        GmCXt.log(5, "CLEARD RULES JOBS");
        let inits;
        if (i) {
            inits = [i];
        } else {
            inits = ['currentPage', 'beacon', 'smartTip', 'notif'];
        }

        for (let jobId in jobs) {
            if (GmCXt.inArrayString(jobs[jobId].initiator, inits)) {
                unqueue(jobId);
            }
        }
    };

    let updateVariableRule = function(rules) {
        let varData = GmCXt.getVariableData();

        for (let r = 0; r < rules.length; r++) {
            if (rules[r].type === "Variables") {
                for (let i = 0; i < varData.length; i++) {
                    if (varData[i].name === rules[r].variableData) {
                        rules[r].domRule = true;
                        rules[r].element = varData[i].element;
                        if (!GmCXt.isEmpty(varData[i].rules)) {
                            for (let j = 0; j < varData[i].rules.length; j++) {
                                let varRule = varData[i].rules[j];
                                varRule.logical_condition = "&&";
                                rules.push(varRule);
                            }
                        }
                    }
                }

            }
        }
        return rules;
    };

    var validate = function(jobId) {

        let job = jobs[jobId];
        var rules = job.rules;
        let flag = false;

        job.domRuleRequests = [];

        if (rules) {
            let groups = getGroupedRules(rules);

            GmCXt.log(6, "VALIDATING, all groups" + GmCXt.tourLog(job.tour), groups);

            let tour = job.tour;
            let oldRegEx = false;

            if (tour) {
                let ts = tour.tour_settings;
                if (ts && GmCXt.legacyWildChar(ts.version)) {
                    oldRegEx = true;
                }
            }

            let domGroups = [];
            let apiGroups = [];

            // Rules are valid if there is a group having
            // all URL and Page title rules true
            for (let i = 0; i < groups.length; i++) {

                var group = groups[i];
                var rules = GmCXt.seggregateRules(group);

                let validGroup = false;

                if (rules.url.length) {
                    validGroup = evaluateRuleGroup(group, oldRegEx);

                    GmCXt.log(6, "URL rules status: " + validGroup);
                }

                if (validGroup || !rules.url.length) {

                    if (!group.checkDom && !group.checkApi) {
                        GmCXt.log(6, "GROUP MATCH", group);
                        flag = true;
                        break;
                        // Since groups are validated with "OR" operator, any ONE group getting validated would satisfy the rules
                    }

                    group.index = i;
                    if (group.checkDom) {
                        domGroups.push(group);
                    }
                    if (group.checkApi) {
                        apiGroups.push(group);
                    }
                }
            }

            if (flag) {

                sendResponse(true, jobId);

            } else if (apiGroups.length) { // Validate rule groups having API rules and with URL rules true

                GmCXt.log(6, "Validating groups with API RULES" + GmCXt.tourLog(job.tour), domGroups);

                for (let j = 0; j < apiGroups.length; j++) {
                    var group = apiGroups[j];
                    let ruleIndex = group.findIndex(function(rule) {
                        return rule.apiRule;
                    });

                    let rule = group[ruleIndex];

                    if (rule.type !== 'Variables') {
                        evaluateAPIRules(jobId, group, group.index, apiGroups.length, rule);
                    } else {
                        sendResponse(false, jobId);
                    }
                }

            } else if (domGroups.length) { // Validate rule groups having DOM rules and with other rules true

                GmCXt.log(6, "Validating groups with DOM RULES" + GmCXt.tourLog(job.tour), domGroups);

                for (let k = 0; k < domGroups.length; k++) {
                    var group = domGroups[k];
                    evaluateElRules(jobId, group, group.index);
                }

            } else {
                sendResponse(false, jobId);
            }
        }
    };

    var checkUserCreationDate = function(condition, val) {
        let creationDateSeconds = val / 1000;
        let getCreationDate = GmCXt.getCombinedDateFromTimestamp(parseInt(creationDateSeconds));
        let getUserCreationDate = GmCXt.getCombinedDateFromTimestamp(parseInt(GmCXt.user.creation_date));
        let comparisonResult = GmCXt.compareDates(getUserCreationDate, getCreationDate);

        switch (condition.toLowerCase()) {

        case GmCXt.EQUALS.toLowerCase():
            return comparisonResult === 0;

        case GmCXt.GREAT_THAN.toLowerCase():
            return comparisonResult > 0;

        case GmCXt.LESS_THAN.toLowerCase():
            return comparisonResult < 0;

        default:
            return false;
        }
    };

    var checkDate = function(condition, val) {
        let dateSeconds = val / 1000;
        let getDate = GmCXt.getCombinedDateFromTimestamp(parseInt(dateSeconds));
        let getCurrentDate = GmCXt.getCombinedDateFromTimestamp(parseInt(Date.now() / 1000));
        let comparisonResult = GmCXt.compareDates(getCurrentDate, getDate);

        switch (condition.toLowerCase()) {

        case GmCXt.EQUALS.toLowerCase():
            return comparisonResult === 0;

        case GmCXt.GREAT_THAN.toLowerCase():
            return comparisonResult > 0;

        case GmCXt.LESS_THAN.toLowerCase():
            return comparisonResult < 0;

        default:
            return false;
        }
    };

    var checkTime = function(condition, val) {
        let currentTime = new Date();
        let currentHours = currentTime.getHours().toString().padStart(2, '0');
        let currentMinutes = currentTime.getMinutes().toString().padStart(2, '0');
        let formattedCurrentTime = currentHours + ":" + currentMinutes;
        let comparisonResult = GmCXt.compareTimes(formattedCurrentTime, val);

        switch (condition.toLowerCase()) {

        case GmCXt.EQUALS.toLowerCase():
            return comparisonResult === 0;

        case GmCXt.GREAT_THAN.toLowerCase():
            return comparisonResult > 0;

        case GmCXt.LESS_THAN.toLowerCase():
            return comparisonResult < 0;

        default:
            return false;
        }
    };

    var getGroupedRules = function(rules) {

        let groups = [];
        let rulesKey = -1;

        rules.forEach(function(rule, key) {
            if (key === 0 || (rule.logical_condition === '||')) {
                groups[++rulesKey] = [];
                groups[rulesKey].push(rule);

            } else if (rule.logical_condition === '&&') {
                groups[rulesKey].push(rule);
            }
        });

        return groups;
    };

    let evaluateRules = function(rules, oldRegEx, urlParts) {

        if (rules) {
            // Flat to group structure
            let groups = getGroupedRules(rules);
            GmCXt.log(5, "RULE GROUPS", groups);

            for (let index = 0; index < groups.length; index++) {
                let group = groups[index];
                let valid = evaluateRuleGroup(group, oldRegEx, urlParts);

                if (valid) {
                    GmCXt.log(5, "MATCHED group", group);
                    return true;
                }
            }
        }
        return false;
    };

    var evaluateRuleGroup = function(group, oldRegEx, urlParts) {
        let validGroup;

        for (let i = 0; i < group.length; i++) {
            let rule = group[i];

            // Skip element & api rules
            if (rule.domRule || rule.apiRule) continue;

            let isValid = evaluateNonElRules(rule, oldRegEx, urlParts);

            group[i].isValid = isValid;

            if (validGroup === undefined) {
                validGroup = isValid;
            }

            validGroup = evaluateOperator(rule.logical_condition, isValid, validGroup);
        }

        return validGroup;
    };

    let validateRuleGroup = function(rules) {

        let valid = false;

        if (rules.length > 1) {
            for (let i = 0; i < rules.length; i++) {
                valid = evaluateOperator(rules[i].logical_condition, rules[i].isValid, valid);
                if (!valid) return valid;
            }
        } else if (rules.length === 1) {
            valid = rules[0].isValid;
        }

        return valid;
    };

    var evaluateOperator = function(operator, val1, val2) {
        if (operator === '') {
            return val1;
        } else {
            if (operator === '&&') {
                return val1 && val2;
            } else {
                return val1 || val2;
            }
        }
    };

    var evaluateNonElRules = function(rule, oldRegEx, urlParts) {

        urlParts = urlParts ? urlParts : GmCXt.urlParts;

        switch (rule.type) {

        case "URL Path":

            if (urlParts) var pathname = urlParts.pathname;

            if (GmCXt.browserApp === 'ie' && pathname) {
                let pathnameFirstCharactor = pathname.substring(0, 1);
                if (pathnameFirstCharactor.indexOf('/') !== 0) pathname = '/' + pathname;
            }

            return evaluateURLRule(rule.condition, rule.value, pathname, oldRegEx);

        case "URL":
            return evaluateURLRule(rule.condition, GmCXt.filterUrlScheme(rule.value), urlParts.href, oldRegEx);

        case "URL Hostname":
            return evaluateURLRule(rule.condition, rule.value, urlParts.host, oldRegEx);

        case "URL Parameters":
            return evaluateURLRule(rule.condition, rule.value, GmCXt.getUrlParam(), oldRegEx);

        case "URL Hash":
            return evaluateURLRule(rule.condition, rule.value, urlParts.hash, oldRegEx);

        case "Page Title":
            return evaluateURLRule(rule.condition, rule.value, GmCXt.pageTitle, oldRegEx);

        case "Display Frequency":
            return validateFrequencyRule(rule.condition, rule.value);

        case "Creation Date":
            return checkUserCreationDate(rule.condition, rule.value);

        case "Date":
            return checkDate(rule.condition, rule.value);

        case "Time":
            return checkTime(rule.condition, rule.value);

        default:
            return true;
        }
    };

    var evaluateURLRule = function(condition, value, url, oldRegEx) {

        let retVal = false;

        let regexPattern = getRegex(GmCXt.filterUrlScheme(value), condition, oldRegEx);

        if (regexPattern) {
            retVal = validateURLRuleWithRegex(condition, regexPattern, url);
        } else {
            retVal = validateURLRule(condition, value, url);
        }

        return retVal;
    };

    var validateURLRuleWithRegex = function(condition, regexPattern, url) {

        if (regexPattern) {
            let regExValid = regexPattern.test(url);

            let retVal = false;

            switch (condition) {
            case GmCXt.EQUALS:
            case GmCXt.CONTAINS:
            case GmCXt.STARTS_WITH:
            case GmCXt.ENDS_WITH: {
                if (regExValid) {
                    retVal = true;
                }
                break;
            }

            case GmCXt.NOT_EQUAL:
            case GmCXt.NOT_CONTAINS:
            case "Not Contains": {
                if (!regExValid) {
                    retVal = true;
                }
                break;
            }
            }
            return retVal;
        } else {
            return false;

        }
    };

    var validateURLRule = function(condition, value, url) {

        let retval = false;

        try {
            var valueLo = decodeURIComponent(value).toLowerCase();
        } catch (e) {
            var valueLo = value.toLowerCase();
        }

        try {
            var urlLo = decodeURIComponent(url).toLowerCase();
        } catch (e) {
            var urlLo = url.toLowerCase();
        }

        switch (condition) {

        case GmCXt.EQUALS:
            if (valueLo === urlLo) {
                retval = true;
            }
            break;

        case GmCXt.NOT_EQUAL:
            if (valueLo !== urlLo) {
                retval = true;
            }
            break;

        case GmCXt.CONTAINS:
            if (urlLo.indexOf(valueLo) !== -1) {
                retval = true;
            }
            break;

        case GmCXt.NOT_CONTAINS:
        case "Not Contains":
            if (urlLo.indexOf(valueLo) === -1) {
                retval = true;
            }
            break;

        case GmCXt.STARTS_WITH:
            if (urlLo.indexOf(valueLo) === 0) {
                retval = true;
            }
            break;

        case GmCXt.ENDS_WITH:
            valueLo = RegExp.escape(valueLo);
            retval = new RegExp(valueLo + "$").test(urlLo);
            break;
        }

        return retval;
    };

    let validateElRule = function(condition, value, element, elText, oldRegEx, varName) {
        let retval = false;

        let elExists = element && mg$(element).length;
        let elTagNameInput = elExists && mg$(element)[0].tagName === 'INPUT';
        let elTypeRadio = elTagNameInput && mg$(element).attr('type') === 'radio';
        let elTypeCheckbox = elTagNameInput && mg$(element).attr('type') === 'checkbox';

        try {
            var valueLo = decodeURIComponent(value).toLowerCase();
        } catch (e) {
            var valueLo = value.toLowerCase();
        }

        var elText = (elExists || varName) ? elText : '';
        elText = elText.substring(0, GmCXt.ruleTextLimit).trim().toLowerCase();

        let elAttrs = elExists ? GmCXt.createDeepCopy(GmCXt.getAttributeValues(element)) : {};
        if (elAttrs) {
            delete elAttrs.tagName;
        }

        switch (condition) {
        case GmCXt.EXISTS:
            if (elExists) {
                retval = true;
            }
            break;

        case GmCXt.NOT_EXISTS:
            if (!elExists) {
                retval = true;
            }
            break;

        case GmCXt.VISIBLE:
        case "Is Visible":
            if (elExists && GmCXt.getElVisibility(element) === 'visible') {
                retval = true;
            }
            break;

        case GmCXt.NOT_VISIBLE:
        case "Is Not Visible":
            if ((elExists && GmCXt.getElVisibility(element) === 'hidden') || !elExists) {
                retval = true;
            }
            break;

        case GmCXt.SELECTED:
            if (elTypeRadio && mg$(element).is(":checked")) {
                retval = true;
            }
            break;

        case GmCXt.NOT_SELECTED:
            if (elTypeRadio && !mg$(element).is(":checked")) {
                retval = true;
            }
            break;

        case GmCXt.CHECKED:
            if (elTypeCheckbox && mg$(element).is(":checked")) {
                retval = true;
            }
            break;

        case GmCXt.NOT_CHECKED:
            if (elTypeCheckbox && !mg$(element).is(":checked")) {
                retval = true;
            }
            break;

        case GmCXt.TXT_EQUALS:
        case GmCXt.EQUALS:
            if (elText) {
                if (elText === valueLo) {
                    retval = true;
                } else {
                    retval = compareForOlderVersion(element, oldRegEx, true, valueLo);
                }
            }
            break;

        case GmCXt.NOT_TXT:
        case GmCXt.NOT_EQUAL:
            if (elText) {
                if (elText !== valueLo) {
                    retval = true;
                } else {
                    retval = compareForOlderVersion(element, oldRegEx, false, valueLo);
                }
            } else {
                retval = true;
            }
            break;

        case GmCXt.TXT_CONTAINS:
            if (elText && elText.includes(valueLo)) {
                retval = true;
            }
            break;

        case GmCXt.NOT_CONTAINS:
            if (elText.indexOf(valueLo) === -1) {
                retval = true;
            }
            break;

        case GmCXt.TXT_MATCHES:
            if (elText) {
                var elNum = elText.match(/\d+/g);
                if (elNum && valueLo.includes(':')) {
                    elNum = parseFloat(elNum);
                    var valArr = valueLo.split(':');
                    let lower = parseFloat(valArr[0].match(/\d+/g));
                    let upper = parseFloat(valArr[1].match(/\d+/g));
                    if (lower <= elNum && upper >= elNum) {
                        retval = true;
                    }
                } else if (valueLo.includes('|')) {
                    var valArr = valueLo.match(/(?=\S)[^|]+?(?=\s*(\||$))/g);
                    if (valArr.includes(elText)) {
                        retval = true;
                    }
                }
            }
            break;

        case GmCXt.GREAT_THAN:
            if (elText) {
                var elNum = elText.match(/\d+/g);
                if (elNum) {
                    elNum = parseFloat(elNum);
                    valNum = parseFloat(valueLo.match(/\d+/g));
                    if (elNum > valNum) {
                        retval = true;
                    }
                }
            }
            break;

        case GmCXt.LESS_THAN:
            if (elText) {
                var elNum = elText.match(/\d+/g);
                if (elNum) {
                    elNum = parseFloat(elNum);
                    valNum = parseFloat(valueLo.match(/\d+/g));
                    if (elNum < valNum) {
                        retval = true;
                    }
                }
            }
            break;

        case GmCXt.CLASSES:
        case 'Must have Class(s)':
            if (elAttrs.class) {
                var valArr = value.split("|");
                for (var i = 0; i < valArr.length; i++) {
                    var clsArr = valArr[i].split(",");
                    var length = clsArr.length;
                    var match = 0;
                    for (var j = 0; j < length; j++) {
                        var cls = clsArr[j].trim();
                        if (elAttrs.class.includes(cls)) {
                            match++;
                        }
                    }
                    if (match === length) {
                        retval = true;
                        break;
                    }
                }
            }
            break;

        case GmCXt.NOT_CLASSES:
            retval = true; // True if no classes present & true till any class matched
            if (!GmCXt.isEmpty(elAttrs.class)) {
                var clsArr = value.split(",");
                for (var i = 0; i < clsArr.length; i++) {
                    var cls = clsArr[i].trim();
                    if (elAttrs.class.includes(cls)) {
                        retval = false;
                        break;
                    }
                }
            }
            break;

        case GmCXt.ATTRIBUTES:
        case 'Must have Attribute(s)':
            var attrs = Object.keys(elAttrs);
            if (attrs.length) {
                var valArr = value.split("|");
                for (var i = 0; i < valArr.length; i++) {
                    var attributesArr = valArr[i].split(",");
                    var length = attributesArr.length;
                    var match = 0;
                    for (var j = 0; j < length; j++) {
                        var name = attributesArr[j].trim();
                        if (attrs.includes(name)) {
                            match++;
                        }
                    }
                    if (match === length) {
                        retval = true;
                        break;
                    }
                }
            }
            break;

        case GmCXt.NOT_ATTRIBUTES:
            retval = true; // True if no attributes present & true till any attribute matched
            var attrs = Object.keys(elAttrs);
            if (!GmCXt.isEmpty(attrs)) {
                var attributesArr = value.split(",");
                for (var i = 0; i < attributesArr.length; i++) {
                    var name = attributesArr[i].trim();
                    if (attrs.includes(name)) {
                        retval = false;
                        break;
                    }
                }
            }
            break;

        case GmCXt.DISABLED:
            retval = element.disabled;
            break;

        case GmCXt.NOT_DISABLED:
            retval = !element.disabled;
            break;

        }

        return retval;
    };

    var validateFrequencyRule = function(condition, value) {
        let retVal = false;

        if (value) {
            let date = new Date();

            switch (condition) {
            case GmCXt.DAY_OF_WEEK:

                var day = date.getDay();

                var dayOfWeekMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

                var valArr = value.replace(/\s/g, '').toLowerCase().split('|');
                for (var i = 0; i < valArr.length; i++) {
                    var range = valArr[i].split('-');
                    if (range.length === 1) {
                        let val = range[0].slice(0, 3);
                        if (dayOfWeekMap.indexOf(val) === day) {
                            retVal = true;
                            break;
                        }
                    } else if (range.length === 2) {
                        var lower = range[0].slice(0, 3);
                        var upper = range[1].slice(0, 3);
                        if (dayOfWeekMap.indexOf(lower) <= day && day <= dayOfWeekMap.indexOf(upper)) {
                            retVal = true;
                            break;
                        }
                    }
                }
                break;

            case GmCXt.FIX_TIME:
                var time = parseInt(date.toTimeString().slice(0, 5).replace(':', ''));

                var valArr = value.replace(/\s/g, '').split('|');
                for (var i = 0; i < valArr.length; i++) {
                    var range = valArr[i].split('-');
                    var lower = range[0];
                    if (lower.length === 5) { // 24-hour format time; eg: '11:30'
                        lower = parseInt(lower.slice(0, 5).replace(':', ''));

                        var upper = range[1];
                        if (upper && upper.length === 5) {
                            upper = parseInt(upper.slice(0, 5).replace(':', ''));
                        } else {
                            upper = 2359; // 23:59 - End of day
                        }

                        if ((lower <= time) && (time <= upper)) {
                            retVal = true;
                            break;
                        }
                    }
                }

                break;
            case GmCXt.DATE_RANGE:
                var valArr = value.split('-');
                var today = new Date(date.toDateString());
                var startDate = valArr[0].length ? new Date(valArr[0]) : null;
                if (startDate && startDate <= today) {
                    let endDate = valArr[1].length ? new Date(valArr[1]) : null;
                    if (endDate && startDate <= endDate && endDate >= today) {
                        retVal = true;
                    }
                }
                break;
            }
        }
        return retVal;
    };

    var evaluateAPIRules = function(jobId, group, groupIndex, noOfApiGroups, rule) {

        rule.isValid = false;

        let sendResponseIfJobValid = function(res, jobId) {
            let job = jobs[jobId];
            if (job && job.cb && job.tour) {
                if (res) {
                    sendResponse(true, jobId);
                } else {
                    if (!job.hasOwnProperty('failedApiRules')) {
                        job.failedApiRules = 1;
                    } else {
                        job.failedApiRules++;
                    }

                    if (job.failedApiRules === noOfApiGroups) {
                        // All API rules have been checked
                        // each Group can have only One API rule
                        sendResponse(false, jobId);
                    }
                }
            }
        };

        let cb = function(res) {
            if (res) {
                rule.isValid = true;
                GmCXt.log(6, "API response: true");
                if (group.checkDom) {
                    GmCXt.log(6, "Evaluating DOM rules in the group. . .", group);
                    evaluateElRules(jobId, group, groupIndex);
                } else {
                    GmCXt.log(6, "GROUP MATCH", group);
                    sendResponseIfJobValid(true, jobId);
                }
            } else {
                GmCXt.log(6, "API response: false");
                GmCXt.log(6, "GROUP NOT MATCHED.", group);
                sendResponseIfJobValid(false, jobId);
            }
        };

        let url = rule.value;

        let promise = GmCXt.externalApiCall(url);
        promise.then(function(res) {
            cb(res);
        }).catch(function(e) {
            console.log("Error from Variable Validation API: " + e);
            cb(false);
        });
    };

    var evaluateElRules = function(jobId, group, groupIndex) {
        for (let i = 0; i < group.length; i++) {
            let rule = group[i];
            if (rule.domRule) {
                rule.isValid = false;
                sendSelectElementRequest(jobId, rule, i, groupIndex);
            }
        }
    };

    var sendSelectElementRequest = function(jobId, rule, rIndex, gIndex) {

        job = jobs[jobId];

        rule.ruleId = rIndex;
        rule.groupId = gIndex;

        let message = {
            data: {
                rule: rule,
                jobId: jobId,
                job: job,
                fromSidePanel: GmCXt.isSidePanelApp
            }
        };

        // From side panel, sends to the top/parent window
        // From top window, sends to the same window

        if (GmCXt.isSidePanelApp) {
            message.action = 'mgPlayerJSProd_action:init;task:select_dom_element_for_rules';
            GmCXt.sendToParentWindow(message);

        } else {
            GmCXt.sendMessageToAllWindows(
                'mgPlayerJSProd_action:started;task:select_dom_element_for_rules',
                message.data);
        }
    };

    let onSuccessDOMRuleMatch = function(data) {
        let jobId = data.jobId;
        let valid = data.valid;
        let job = jobs[jobId];
        let ruleId = data.ruleId;
        let groupId = data.groupId;

        if (job && job.cb && job.tour) {
            if(job.domRuleRequests[groupId]) {
                job.domRuleRequests[groupId]++;
            } else {
                job.domRuleRequests[groupId] = 1;
            }
			
            let groupedRules = getGroupedRules(job.rules);
            let count = GmCXt.numberOfDomRules(groupedRules[groupId]);
            let isValidGroup = false;

            if (groupedRules.length) {
                groupedRules[groupId][ruleId].isValid = valid;
                isValidGroup = validateRuleGroup(groupedRules[groupId]);
            }

            let printlog = "DOM rules checked.\nRule: " + valid + "; Group: " + isValidGroup;
            GmCXt.log(6, printlog, groupedRules[groupId]);

            if (isValidGroup || job.domRuleRequests[groupId] === count) {
                let isValid = isValidGroup || validateAllGroups(groupedRules);
                sendResponse(isValid, jobId);
            }
        }
    };

    function validateAllGroups(groupedRule) {

        let valid = false;
        for (let i = 0; i < groupedRule.length; i++) {
            valid = validateRuleGroup(groupedRule[i]);
            if (valid) {
                break;
            }
        }

        return valid;

    }

    let getStringPlusRegex = function(val, parentLen, oldRegEx) {
        let retStr = val;
        let splitArr = val.split(oldRegEx ? "+" : "{+}");

        if (splitArr.length === 1 && parentLen > 1) {
            retStr = RegExp.escape(retStr);
        } else {
            retStr = '';
            for (let i = 0; i < splitArr.length; i++) {

                retStr = retStr + RegExp.escape(splitArr[i]);

                if (i !== splitArr.length - 1)
                    retStr = retStr + "([a-zA-Z0-9:!+@#$&()?\\-_`.%+,=\\/]+)";
            }
        }

        return retStr;
    };

    let getStringStarRegex = function(splitArr, oldRegEx) {

        let retStr = '';
        for (let i = 0; i < splitArr.length; i++) {

            retStr = retStr + getStringPlusRegex(splitArr[i], splitArr.length, oldRegEx);

            if (i !== splitArr.length - 1)
                retStr = retStr + "([a-zA-Z0-9:!+@#$&()?\\-_`.%+,=\\/]*)";
        }

        return retStr;
    };

    let getRegexString = function(val, oldRegEx) {

        let retStr = val;
        let splitArr = val.split(oldRegEx ? "*" : "{*}");

        if (splitArr.length === 1) {
            retStr = getStringPlusRegex(val, 1, oldRegEx);
        } else {
            retStr = getStringStarRegex(splitArr, oldRegEx);
        }
        return retStr;
    };

    var getRegex = function(val, condition, oldRegEx) {

        let indexOfStar = val.indexOf(oldRegEx ? "*" : "{*}");
        let indexOfPlus = val.indexOf(oldRegEx ? "+" : "{+}");
        let regexPattern = null;

        if ((indexOfStar !== -1) || (indexOfPlus !== -1)) {

            let regexStr = getRegexString(val, oldRegEx);
            let regPattern = "([a-zA-Z0-9:!+@#$&()?\\-_`.%+,=\\/]*)";

            switch (condition) {
            case GmCXt.CONTAINS:
                regexStr = regPattern + regexStr + regPattern;
                break;
            case GmCXt.STARTS_WITH:
                regexStr = regPattern + regexStr;
                break;
            case GmCXt.ENDS_WITH:
                regexStr = regexStr + regPattern;
                break;
            }

            regexPattern = new RegExp("^" + regexStr + '$');
        }

        return regexPattern;
    };

    RegExp.escape = function(s) {
        return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    };

    function getValueForOldRules(el) {
        let valArr = [];

        let value = el.getAttribute('value');
        let placeholder = el.getAttribute('placeholder');
        if (value) {
            valArr.push(el.value);
        }
        if (placeholder) {
            valArr.push(placeholder);
        }
        if (el.textContent) {
            valArr.push(el.textContent);
        }
        if (el.tagName === 'SELECT') {
            valArr.push(el.options[el.selectedIndex].textContent);
        }

        return valArr.map(function(v) {
            return v.substring(0, GmCXt.ruleTextLimit).trim().toLowerCase();
        });
    }

    function compareForOlderVersion(el, oldRegEx, checkEquals, value) {
        if (oldRegEx) {
            let elValues = getValueForOldRules(el);
            if (checkEquals) {
                return elValues.indexOf(value) !== -1;
            } else {
                return elValues.indexOf(value) === -1;
            }
        }
        return false;
    }

    function sendResponse(valid, jobId) {

        let job = jobs[jobId];
        let cb = job.cb;

        let result = {
            valid: valid,
            tour: job.tour,
            branchIndex: job.branchIndex
        };

        if (job.segmentId) {
            result.segmentId = job.segmentId;
        }

        GmCXt.log(5, (valid ? "VALID" : "INVALID") + " " + job.initiator + " : " + GmCXt.tourLog(job.tour));

        pub.unqueue(jobId);
        cb(result);
    }

    GmCXt.isSidePanelFrame = (GmCXt._location() && GmCXt._location().href &&
        GmCXt._location().href.indexOf("side_panel") !== -1) ? true : false;

    // Following functions needed only in main content script not inside iframe
    if (window.self === window.top || GmCXt.isSidePanelFrame) {
        pub.queue = queue;
        pub.unqueue = unqueue;
        pub.clearJobs = clearJobs;
        pub.onSuccessDOMRuleMatch = onSuccessDOMRuleMatch;
    }

    pub.evaluateRules = evaluateRules;
    pub.evaluateURLRule = evaluateURLRule;
    pub.validateElRule = validateElRule;
    pub.getGroupedRules = getGroupedRules;
    pub.evaluateNonElRules = evaluateNonElRules;

    pub.hasRuleType = function(rules, type) {

        if (rules) {

            let ruleGroups = getGroupedRules(rules);

            for (let i in ruleGroups) {
                let group = ruleGroups[i];
                for (let j in group) {
                    let rule = group[j];
                    if (type.includes(rule.type) || type.includes(rule.condition)) {
                        return true;
                    }
                }
            }
        }
        return false;
    };

    return pub;

})();

String.prototype.replaceAll = function(search, replacement) {
    let target = this;
    return target.split(search).join(replacement);
};  
GmCXt.AUTOMATION_SUITE_PLAY = 'mi_suite_play';

GmCXt.lastTrakerSync = 0;

GmCXt.trackerV1 = {

    getScreenSize: function() {
        let screen = window.screen;
        return {
            width: (screen && screen.width) ? screen.width : '',
            height: (screen && screen.height) ? screen.height : ''
        };
    },

    v1Payload: function(e, date, url, user, eventTime) {

        let objectId = e.objectId;
        if (typeof(objectId) === 'number') objectId = objectId.toString();

        return {
            "user_id": user.user_id,
            "org_id": user.organization_id,
            "app_code": e.app_code,
            "client_code": GmCXt.conf.appName + '_v' + GmCXt.conf.version,
            "role_id": "",
            "entity_code": objectId,
            "event_time": eventTime,
            "event_type": e.eventName,
            "url": url,
            "user_agent": GmCXt.browserApp || 'chrome',
            "screen_size": e.screen_size,
            "miscellaneous": e.miscellaneous
        };
    },

    track: function(gPayload) {

        GmCXt.log(38, "Fn. Track");

        if (GmCXt.onPrem()) return;

        if (!GmCXt.user) {

            if (GmCXt.isBackgroundPage) {
                GmCXt.sendMessageToPanel('mgPlayerJSProd_action:fetch_user');
            }
            GmCXt.log(45, "Events not Sent, User not found");
            return;
        }

        function updateSecret(keys) {
            if (keys && keys.registerClientId) {
                GmCXt.trackerUtil.secrets = keys;
                let jsonData = {
                    "app_client_id": keys.registerClientId,
                    "payload": [],
                    "signature": ''
                };
                if (gPayload.length) {
                    jsonData.payload = gPayload;
                    GmCXt.trackerV1.sendPayload(jsonData);
                }

            } else {
                let msg = 'mgPlayerJSProd_action:update_registration_secret';
                if (GmCXt.isBackgroundPage) {
                    GmCXt.sendMessageToPanel(msg);
                } else {
                    GmRootScope.trackerSecrets = {};
                    GmRootScope.registerClientInsights();
                }

                GmCXt.log(45, 'Secret keys are not present. Unable to track events');
            }
        }

        if (!GmCXt.trackerUtil.secrets) {
            GmCXt.storage().get([
                'tracker_secrets'
            ]).then(function(res) {
                let keys = res.tracker_secrets;
                if (!keys.registerClientId) {
                    keys = GmCXt.parseJSON(keys);
                }
                updateSecret(keys);
            });
        } else {
            let keys = GmCXt.trackerUtil.secrets;
            updateSecret(keys);
        }
    },

    sendClientVisit: function() {
        GmCXt.trackerV1.trackClientVisit();
        GmCXt.clientVisitSync = GmCXt.getCurrentTimeInSec();
        GmCXt.storage().set({
            'clientVisitSync': JSON.stringify(GmCXt.clientVisitSync)
        });
    },

    sendPayload: function(jsonData) {

        GmCXt.log(38, "Fn. SendPayload");
        let keys = GmCXt.trackerUtil.secrets;

        let date = new Date();
        let currentTimestamp = date.getTime();

        jsonData.event_chain_id = GmCXt.ANALYTICS_EVENT_CHAIN_ID;

        let trackClientTimestamp = currentTimestamp;
        if (keys && keys.track_client_timestamp) {
            trackClientTimestamp = parseInt(keys.track_client_timestamp);
        }
        let clientSecretAge = parseInt((currentTimestamp - trackClientTimestamp) / 1000);

        keys.track_client_timestamp = currentTimestamp;

        /*
		 In Push Event we do not have the 'keys.track_client_timestamp' first time.
		 That time we need to register the client event.
		*/
        // event sent without delay
        /*GmCXt.storage().get(['clientVisitSync']).then(function(res) {
			if (res.clientVisitSync) {
				if (GmCXt.getCurrentTimeInSec() - res.clientVisitSync > GmCXt.t.tracking12hr) {
					GmCXt.trackerV1.sendClientVisit();
				}
			} else {
				GmCXt.trackerV1.sendClientVisit();
			}
		});*/

        if (keys.registerClientId) {

            if (jsonData.payload[0].event_type === 'mi_mybot_run') {

                jsonData.signature = md5(md5(JSON.stringify(jsonData.payload)) +
					keys.app_client_secret).toString();

                // We call an additional API as fallback if the save results API fail.
                GmCXt.trackerV1.sendGuideAutomationEvent(jsonData);
                return;
            }

            let sentimentEvents = jsonData.payload.filter(function(event) {
                return event && event.event_type === 'mi_sentiment_response';
            });

            if (sentimentEvents.length) {

                sentimentEvents.forEach(function(p) {

                    GmCXt.trackerV1.apiTrackSentiment(p);

                    let index = jsonData.payload.indexOf(p);
                    if (index !== -1) {
                        jsonData.payload.splice(index, 1);
                    }
                });
            }

            if (jsonData.payload.length) {

                jsonData.signature = md5(md5(JSON.stringify(jsonData.payload)) +
					keys.app_client_secret).toString();

                GmCXt.log(45, 'SENDING events', jsonData.payload);

                GmCXt.trackerV1.apiV1(jsonData);
            }
        }
    },

    apiV1: function(data) {
        return GmCXt.api.trackEventV1(data)
            .then(function(response) {
                GmCXt.log(45, 'SENT events');
            })
            .catch(function(error) {
                GmCXt.trackerV1.updateTooltipTrackInfo(data);
            });
    },

    apiTrackSentiment: function(data) {

        GmCXt.api.trackSentiment(data)
            .then(function(response) {
                GmCXt.log(45, 'SENT events');
            })
            .catch(function(error) {
                GmCXt.log(45, 'ERROR, events restored', data);
                GmCXt.trackerV1.sendPayloadEventCall(data);
            });
    },

    apiTrackConversation: function(data) {

        GmCXt.api.trackConversation(data)
            .then(function(response) {
                GmCXt.log(45, 'SENT events');
            })
            .catch(function(error) {
                GmCXt.log(45, 'ERROR, events restored', data);
                GmCXt.trackerV1.sendPayloadEventCall(data);
            });
    },

    updateTooltipTrackInfo: function(data) {
        data.payload.forEach(function(p) {
            if (p && p.event_type === "mi_tooltip_shown") {
                sid = "step_" + p.miscellaneous.tooltips_details[0].tooltip_id;
                GmCXt.tooltipTrackingList[sid].track = true;
            }
        });
    },

    setPayLoad: function(e) {

        if (GmCXt.isAutomationRunning() && e.eventName !== "mi_mybot_run") {
            GmCXt.log(45, "Tracker is currently stopped", e);
            return;
        }

        // Track events only after login
        if (!GmCXt.user) {
            GmCXt.log(45, 'SKIP EVENT, no user found ' + e.eventName);
            return;
        }

        if (!e.app_code) {
            return;
        }

        if (!e) e = {};

        let url = e.url || e.miscellaneous.url;

        if (GmCXt.trackerUtil && GmCXt.trackerUtil.page_url) {
            if (!url) url = GmCXt.urlParts ? GmCXt.urlParts.fullUrl : GmCXt.trackerUtil.page_url;
        } else {
            if (!url) url = GmCXt.urlParts ? GmCXt.urlParts.fullUrl : GmCXt._location().href;
        }

        let date = new Date();

        if (e.eventName === 'mi_page_visit') {
            url = GmCXt.pageVisit.url;
        }

        if (e.eventName === 'mi_page_feature_sequence') {
            date = new Date(e.miscellaneous.event_start_time);
        }

        if (!e.miscellaneous.env_code &&
			e.eventName !== 'mi_tooltip_shown' &&
			e.eventName !== 'mi_workflow_play') {
            e.miscellaneous.env_code = GmCXt.trackerV1.getEnvCode(url);
        }

        let eventTime = "";
        if (e.eventName === 'mi_user_pulse') {
            eventTime = date.getUTCFullYear() + "-" +
				('0' + (date.getUTCMonth() + 1)).slice(-2) + "-" +
				('0' + date.getUTCDate()).slice(-2) + " " +
				'00:00:00';
        } else {
            eventTime = date.getUTCFullYear() + "-" +
				('0' + (date.getUTCMonth() + 1)).slice(-2) + "-" +
				('0' + date.getUTCDate()).slice(-2) + " " +
				('0' + date.getUTCHours()).slice(-2) + ":" +
				('0' + date.getUTCMinutes()).slice(-2) + ":" +
				('0' + date.getUTCSeconds()).slice(-2);
        }

        let user = false;

        if (GmCXt.user) user = GmCXt.user;

        let payload = GmCXt.trackerV1.v1Payload(e, date, url, user, eventTime);

        if (GmCXt.trackerUtil.trackPI) {
            payload.miscellaneous.unique_user_id = user.user_email;
            payload.miscellaneous.display_name = user.first_name + ' ' + user.last_name;
        }

        if (payload.event_type !== 'mi_tooltip_shown' && payload.event_type !== 'mi_workflow_play' &&
			payload.event_type !== "mi_mybot_run") {
            payload.miscellaneous.env_code = GmCXt.trackerV1.getEnvCode(payload.url);
        }

        payload.miscellaneous.user_timezone = GmCXt.trackerV1.getTimeZone();

        return payload;
    },

    sendGuideAutomationEvent: function(data) {

        let onSave = function() {
            GmCXt.auto.reportSaved();
            GmCXt.log(37, "Automation Report saved. Init the tracker again.");
            GmCXt.storage().get(['desktopReq']).then(function(st) {
                if (st.desktopReq) {
                    GmCXt.deskReq = st.desktopReq;
                    GmCXt.sendMessageToDesktopApp('task_complete', {
                        entity_code: data.payload[0].entity_code
                    });
                }
            });
        };

        GmCXt.api.saveMyBotReport(data)
            .then(function(response) {
                GmCXt.log(45, 'SENT events');


                onSave();
            })
            .catch(function(result) {

                GmCXt.log(45, 'ERROR, events restored');

                GmCXt.trackerV1.apiV1(data).finally(onSave);
            });
    },

    getEnvCode: function(url) {

        let env_code = GmCXt.checkDomainInApps(url).app_env;

        if (!env_code) env_code = "";

        return env_code;
    },

    getTimeZone: function() {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
    },

    getAppCode: function() {

        if (GmCXt.externalAppId) {
            return GmCXt.externalAppId;
        } else if (GmCXt.appList && GmCXt.activeAppId  && GmCXt.appList['app:' + GmCXt.activeAppId]) {
            return GmCXt.appList['app:' + GmCXt.activeAppId].external_id;
        }
    },

    getAppSettings: function() {
        if (GmCXt.appList && GmCXt.activeAppId) {
            return GmCXt.appList['app:' + GmCXt.activeAppId].settings;
        }
    },

    trackPanelOpen: function(s, a) {

        if (GmCXt.trackingDisabled()) return;
        let eventName = "mi_panel_open";
        if (a === "chatbot") eventName = "mi_bot_panel_open";

        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: eventName,
            objectId: GmCXt.user.user_key,
            miscellaneous: {
                source: s,
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                url: GmCXt.urlParts.fullUrl
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    getPayloadForPlayEvent: function(e) {
        let returnedPayload = GmCXt.trackerV1.setPayLoad(e);
        if (returnedPayload) {
            GmCXt.trackerV1.sendPayloadEventCall(returnedPayload);
        }
    },

    sendPayloadEventCall: function(payload) {
        if (!payload) return;
        GmCXt.eventApiCall(payload);
    },

    trackGuidePlayEvent: function() {
        GmCXt.log(38, "Fn. trackGuidePlayEvent");
        if (GmCXt.trackingDisabled()) return;

        for (let key in GmCXt.guidePlayTracker) {

            let g = GmCXt.guidePlayTracker[key];

            let completeEventTracked = 0;
            if (GmCXt.playerI && g.guide_id === GmCXt.playerI.tour.tour_id && GmCXt.playerI.completeEventTracked) {
                completeEventTracked = 1;
            }

            g.guide_complete = completeEventTracked;

            if (g.steps_details && g.steps_details.length) {

                g.event_end_time = new Date().getTime();

                let length = g.steps_details.length;
                g.steps_details[length - 1].event_end_time = new Date().getTime();

                let e = {
                    app_code: GmCXt.trackerV1.getAppCode(),
                    eventName: g.mode,
                    objectId: g.guide_id,
                    miscellaneous: g,
                    screen_size: GmCXt.trackerV1.getScreenSize()
                };

                GmCXt.trackerV1.getPayloadForPlayEvent(e);
            }
        }
    },

    trackGuideSearch: function(o) {

        if (GmCXt.trackingDisabled()) return;

        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_search',
            objectType: 'global',
            objectId: GmCXt.user.user_key,
            miscellaneous: {
                search_keyword: o.search_text,
                results_returned: o.results_returned,
                search_result_clicked: o.search_result_clicked,
                event_start_time: o.startTime,
                event_end_time: new Date().getTime(),
                url: GmCXt.urlParts.fullUrl
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    trackGuideDownload: function(tour, type) {

        if (GmCXt.trackingDisabled()) return;

        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_guide_download',
            objectId: tour.tour_id,
            miscellaneous: {
                guide_id: tour.tour_id,
                type: type,
                play_instance_id: GmCXt.getUUID(),
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                url: GmCXt.urlParts.fullUrl
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    trackBotInteraction: function(tours) {

        if (GmCXt.trackingDisabled()) return;
        if (tours && tours.length) {
            for (let i = 0; i < tours.length; i++) {
                let e = {
                    app_code: GmCXt.trackerV1.getAppCode(),
                    eventName: 'mi_bot_interaction',
                    objectId: tours[i].tour_id,
                    miscellaneous: {
                        guide_id: tours[i].tour_id,
                        play_instance_id: GmCXt.getUUID(),
                        event_start_time: new Date().getTime(),
                        event_end_time: new Date().getTime(),
                        url: GmCXt.urlParts.fullUrl
                    },
                    screen_size: GmCXt.trackerV1.getScreenSize()
                };

                let steps_details = [];
                for (let j = 0; j < tours[i].steps.length; j++) {
                    let sd = {
                        step_id: tours[i].steps[j].step_id,
                        step_index: parseInt(tours[i].steps[j].step_order),
                        step_title: GmCXt.encodeStringToBase64(tours[i].steps[j].step_title),
                        event_start_time: new Date().getTime(),
                        event_end_time: new Date().getTime(),
                        page_url: GmCXt.urlParts.fullUrl,
                        error_type: "",
                        audio_muted: GmCXt.stepAudioRunningStatus ? 0 : 1
                    };

                    if (tours[i].steps[j].step_settings.automation.enableBot &&
						tours[i].steps[j].step_settings.automation.botQuestion) {
                        sd.requires_human_intervention = 1;
                        sd.step_skipped = 0;
                        let ans = tours[i].steps[j].step_settings.automation.defaultData;
                        if (ans) {
                            sd.isAnswered = true;
                        } else {
                            sd.isAnswered = false;
                        }
                        sd.botQuestion = tours[i].steps[j].step_settings.automation.botQuestion;
                    } else {
                        sd.requires_human_intervention = 0;
                        sd.step_skipped = 0;
                    }
                    steps_details.push(sd);
                }

                e.miscellaneous.steps_details = steps_details;

                let payload = GmCXt.trackerV1.setPayLoad(e);
                GmCXt.trackerV1.sendPayloadEventCall(payload);
            }
        }
    },

    trackGuideShowMe: function(tour, type, i, isAudio, segs, taskId) {

        if (GmCXt.trackingDisabled()) return;

        let url = (tour.tour_url.indexOf('://') === -1) ? 'https://' + tour.tour_url : tour.tour_url;
        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_showme_play',
            objectId: tour.tour_id,
            miscellaneous: {
                guide_id: tour.tour_id,
                type: type,
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                url: url,
                trigger_source: GmCXt.getSource(i),
                audio_muted: isAudio ? 0 : 1,
                segment_group_id: segs
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        if (taskId) {
            e.miscellaneous.task_list_id = taskId;
        }

        e.miscellaneous.play_instance_id = GmCXt.getUUID(tour.tour_id);
        if (GmCXt.isLastStepPlayedOnShowme) {
            e.miscellaneous.guide_complete = 1;
        } else {
            e.miscellaneous.guide_complete = 0;
        }

        if (GmCXt.isVideoEndedOnShowme) {
            e.miscellaneous.guide_complete = 1;
        }

        if (GmCXt.isGiphyPlayedOnShowme) {
            e.miscellaneous.guide_complete = 1;
        }

        GmCXt.trackerV1.getPayloadForPlayEvent(e);

    },

    trackTutGuide: function(tour, type, source, taskid) {

        if (GmCXt.trackingDisabled()) return;
        let url = (tour.tour_url.indexOf('://') === -1) ? 'https://' + tour.tour_url : tour.tour_url;
        let segs = [];
        if (!GmCXt.isEmpty(tour.tour_settings.segment_groups)) {
            segs = GmCXt.getTourSegmentDetail(tour);
        }
        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_tutorial_guide_play',
            objectId: tour.tour_id,
            miscellaneous: {
                guide_id: tour.tour_id,
                type: type,
                trigger_source: source,
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                url: url,
                guide_open: 1,
                segment_details: segs
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        if (source === "task_list") {
            e.miscellaneous.task_list_id = taskid;
        }

        if (GmCXt.isLastStepPlayedOnCreateTutGuide) {
            e.miscellaneous.guide_complete = 1;
        } else {
            e.miscellaneous.guide_complete = 0;
        }

        if (GmCXt.pdfPlayedOnUploadTut && GmCXt.fullPdfPlayedOnUploadTutGuide) {
            e.miscellaneous.guide_complete = 1;
        }

        if (GmCXt.pdfPlayedOnUploadTutNewTab) {
            e.miscellaneous.guide_complete = 1;
        }

        e.miscellaneous.play_instance_id = GmCXt.getUUID(tour.tour_id);

        if (type === 'create_tutorial_guide') {

            GmCXt.storage().get(['tutorial_steps']).then(function(st) {
                let steps_details = [];

                if (GmCXt.isEmpty(st) && source === "bot") {
                    st = {};
                    st.tutorial_steps = tour.steps;
                }
                st.tutorial_steps.forEach(function(step) {
                    let step_details = {
                        step_id: step.step_id,
                        step_index: parseInt(step.step_order),
                        step_title: GmCXt.encodeStringToBase64(step.step_description),
                        event_start_time: new Date().getTime(),
                        event_end_time: new Date().getTime(),
                        page_url: GmCXt.urlParts.fullUrl,
                        error_type: "",
                        audio_muted: GmCXt.stepAudioRunningStatus ? 0 : 1
                    };
                    steps_details.push(step_details);
                });
                e.miscellaneous.steps_details = steps_details;
                e.miscellaneous.tutorial_rendered = 'inline';
                GmCXt.trackerV1.getPayloadForPlayEvent(e);
            });

        } else if (type === 'upload_tutorial_guide_same_tab' ||
			type === 'upload_tutorial_guide_new_tab') {
            e.miscellaneous.tutorial_rendered = 'pdf';
            let step_details = [{
                step_id: tour.steps[0].step_id,
                step_index: parseInt(tour.steps[0].step_order),
                step_title: GmCXt.encodeStringToBase64(tour.steps[0].step_title),
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                page_url: GmCXt.urlParts.fullUrl,
                error_type: "",
                audio_muted: GmCXt.stepAudioRunningStatus ? 0 : 1
            }];
            e.miscellaneous.steps_details = step_details;
            GmCXt.trackerV1.getPayloadForPlayEvent(e);
        }
    },

    trackClientVisit: function() {

        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_client_visit',
            objectId: GmCXt.user.user_key,
            miscellaneous: {
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                url: GmCXt.trackerUtil.page_url,
                is_new_user: false
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    //test me tracker
    trackTestMe: function(testMe) {

        if (GmCXt.trackingDisabled()) return;

        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_test',
            objectId: testMe.tourId,
            miscellaneous: {
                guide_id: testMe.tourId,
                test_result: testMe.testResult.toLowerCase(),
                test_duration: testMe.userTime,
                test_effectiveness: testMe.testEffectiveness || 0,
                test_expected_steps: testMe.stepCount,
                test_steps_performed: testMe.eventCount,
                test_expected_time: testMe.expectedTime,
                play_instance_id: GmCXt.getUUID(testMe.tourId),
                event_start_time: testMe.startTime,
                event_end_time: new Date().getTime(),
                url: testMe.url
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    trackFeatureSeqPayload: function(payloadArr) {

        if (GmCXt.isEmpty(payloadArr)) return;

        if (!GmCXt.trackerUtil.featureTracking) return;

        const entityCodes = payloadArr.map(p => p.entity_code).join("_");
        // Flatten all timearray values into one array
        const allTimes = payloadArr.flatMap(pobj => pobj.miscellaneous.sequence.flatMap(seq => seq.event_time));
        // Get lowest and highest values
        const startTime = Math.min(...allTimes);
        const endTime = Math.max(...allTimes);

        const combinedSequence = payloadArr.flatMap(pitem => pitem.miscellaneous.sequence);


        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_page_feature_sequence',
            objectId: entityCodes,
            miscellaneous: {
                event_start_time: startTime,
                event_end_time: endTime,
                sequence: combinedSequence,
                page_url: GmCXt.urlParts.fullUrl,
                play_instance_id: GmCXt.getUUID(),
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);

        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    getFeatureTagPayload: function(tag) {
        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_feature_click',
            objectId: tag.tour_id,
            miscellaneous: {
                group_id: tag.group_id,
                event_start_time: new Date().getTime(),
                event_end_time: new Date().getTime(),
                page_url: GmCXt.urlParts.fullUrl,
                play_instance_id: GmCXt.getUUID(),
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        return payload;
    },

    trackFeatureClick: function(tag) {

        if (!GmCXt.trackerUtil.featureTracking) return;

        GmCXt.log(16, 'Feature tags payload pushed ', tag);

        GmCXt.trackerV1.sendPayloadEventCall(tag);
    },

    getTagCodeOfValidPageRules: function(data) {
        let validTagCodes = [];

        const matchingTagcodes = data.filter(entry =>
            entry.rules.some(group =>
                group.some(rule => GmCXt.ruleEngine.evaluateNonElRules(rule, false, GmCXt.getURLPartsFromURL(GmCXt.pageVisit.url)))
            )
        ).map(entry => entry.tag_code);

        validTagCodes = matchingTagcodes;

        return validTagCodes;
    },

    trackPageVisit: function(onPageUnload) {
        return new Promise(function(resolve, reject) {
            if (!GmCXt.trackerUtil.pageTracking) {
            	resolve();
            	return;
            } 

            if (!GmCXt.pageVisit) {
            	resolve();
            	return;
            }

            var timeSpentOnPage = GmCXt.pageVisit.timeSpent ? GmCXt.pageVisit.timeSpent : (new Date().getTime() - GmCXt.pageVisit.timeStarted);

            if (timeSpentOnPage < GmCXt.t_.sec5) return;

            let payloads = [];

            GmCXt.getInsightPageRules().then(function() {
            	if (GmCXt.isEmpty(GmCXt.insightPageRulesData)){
            		resolve();
            		return;
            	} else {

            		let tags = GmCXt.trackerV1.getTagCodeOfValidPageRules(GmCXt.insightPageRulesData);

	                if (!GmCXt.isEmpty(tags)) {
	                    tags.forEach((tag, index) => {
	                        let e = {
	                            app_code: GmCXt.trackerV1.getAppCode(),
	                            eventName: 'mi_page_visit',
	                            objectId: tag, //tagcode
	                            miscellaneous: {
	                                time_spend_on_page: timeSpentOnPage,
	                                page_url: GmCXt.pageVisit.url,
	                                page_title: GmCXt.pageVisit.title,
	                                page_load_time: GmCXt.pageVisit.pageLoadTime || 0,
	                                referrer_url: document.referrer,
	                                event_time: new Date().getTime(),
	                                play_instance_id: GmCXt.getUUID()
	                            },
	                            screen_size: GmCXt.trackerV1.getScreenSize()
	                        };

	                        GmCXt.log(2, "Page track event saved", e);

	                        let payload = GmCXt.trackerV1.setPayLoad(e);

	                        if (!GmCXt.isEmpty(payload)) payloads.push(payload);
	                    });

	                    if(!GmCXt.isEmpty(payloads)){
	                    	GmCXt.trackerV1.sendPayloadEventCall(payloads);
	                	}
	                    resolve();
	                } else {
	                    resolve();
	                }
            	}
            });
        });


    },

    trackUserPulse: function() {
        if (GmCXt.trackingDisabled() || GmCXt.isSumtotal() || GmCXt.isSbx() || GmCXt.isLXP()) return;

        let date = new Date();
        let currentTimestamp = date.getTime();

        let currentPulsePayloadTime = {
            time: currentTimestamp,
            app_code: GmCXt.trackerV1.getAppCode()
        };

        let triggerPulseTrack = function() {
            let e = {

                app_code: GmCXt.trackerV1.getAppCode(),
                eventName: 'mi_user_pulse',
                objectId: GmCXt.user.user_key,
                miscellaneous: {},
                screen_size: GmCXt.trackerV1.getScreenSize()
            };

            let payload = GmCXt.trackerV1.setPayLoad(e);
            GmCXt.trackerV1.sendPayloadEventCall(payload);
        };

        let getAppIndexIfExist = function(d, appCode) {
            let ind = -1;
            d.filter(function(value, index) {
                if (appCode === value.app_code) {
                    ind = index;
                    return ind;
                }

            });
            return ind;
        };

        GmCXt.storage().get([
            'userPulsePayloadTime'
        ]).then(function(res) {
            let pulselist = [];
            if (GmCXt.isEmpty(res)) {
                triggerPulseTrack();
                pulselist.push(currentPulsePayloadTime);
            } else {
                if (!GmCXt.isEmpty(res) && res.userPulsePayloadTime) {

                    pulselist = GmCXt.parseJSON(res.userPulsePayloadTime);

                    let appIndex = getAppIndexIfExist(pulselist, GmCXt.trackerV1.getAppCode());

                    if (appIndex !== -1) {
                        if (pulselist[appIndex].app_code === GmCXt.trackerV1.getAppCode() &&
							(currentTimestamp - pulselist[appIndex].time) > GmCXt.t.tracking8hr) {
                            triggerPulseTrack();
                            pulselist[appIndex].time = currentTimestamp;
                        }
                    } else {
                        triggerPulseTrack();
                        pulselist.push(currentPulsePayloadTime);
                    }
                } else {
                    triggerPulseTrack();
                    pulselist.push(currentPulsePayloadTime);
                }
            }

            GmCXt.storage().set({
                'userPulsePayloadTime': JSON.stringify(pulselist)
            });
        });
    },

    trackTooltips: function(currentTooltip) {
        if (GmCXt.trackingDisabled()) return;

        if (GmCXt.isEmpty(GmCXt.tooltipTrackingList)) {
            return;
        }

        let getCurrTTIndex = function(arr, stepId, actionType) {
            let ind = -1;
            arr.filter(function(value, index) {
                if (stepId === value.ttStepId && actionType === value.ttActionType) {
                    ind = index;
                    return ind;
                }

            });
            return ind;
        };

        let triggerTooltipTrack = function(tt, id) {
            let e = {};
            if (tt.track) {

                if (GmCXt.isEmpty(currentTooltip.tooltip_play_instances)) {
                    currentTooltip.tooltip_play_instances.push({
                        event_start_time: GmCXt.getCurrentTimeInMilSec(),
                        event_end_time: GmCXt.getCurrentTimeInMilSec()
                    });
                }

                currentTooltip.play_instance_id = GmCXt.getUUID();

                let segDet = [];
                if (currentTooltip.segment_details) {
                    segDet = currentTooltip.segment_details;
                    delete currentTooltip.segment_details;
                }

                e = {
                    app_code: GmCXt.trackerV1.getAppCode(),
                    eventName: 'mi_tooltip_shown',
                    objectId: tt.tourId,
                    miscellaneous: {
                        url: tt.url,
                        event_start_time: GmCXt.getCurrentTimeInMilSec(),
                        event_end_time: GmCXt.getCurrentTimeInMilSec(),
                        tooltips_details: [currentTooltip],
                        env_code: GmCXt.trackerV1.getEnvCode(tt.url),
                        segment_details: segDet
                    },
                    url: GmCXt.trackerUtil.page_url || GmCXt.urlParts.fullUrl || tt.url,
                    screen_size: tt.screen_size
                };


                GmCXt.trackerUtil.ttPayload["tt_" + tt.tourId] = e;
                let payload = GmCXt.trackerV1.setPayLoad(e);
                GmCXt.trackerV1.sendPayloadEventCall(payload);


                GmCXt.tooltipTrackingList[id].ttDetails.tooltip_play_instances = [];
                GmCXt.tooltipTrackingList[id].track = false;
            }
        };

        let cb = function() {

            let list = [];
            let step_id = "step_" + currentTooltip.tooltip_id;
            let currentTTData = {
                ttStepId: step_id,
                ttTime: GmCXt.getCurrentTimeInMilSec(),
                ttActionType: currentTooltip.action_type[0]
            };

            if (GmCXt.tooltipTrackingList[step_id].track) {
                if (GmCXt.tooltipTrackData && !GmCXt.isEmpty(GmCXt.tooltipTrackData)) {
                    list = GmCXt.parseJSON(GmCXt.tooltipTrackData);
                    let ind = getCurrTTIndex(list, step_id, currentTooltip.action_type[0]);
                    if (ind !== -1) {
                        let timeDiff = GmCXt.getCurrentTimeInMilSec() - list[ind].ttTime;
                        if (list[ind].ttStepId === step_id &&
							list[ind].ttActionType === currentTooltip.action_type[0] &&
							timeDiff > GmCXt.t.tracking8hr) {
                            triggerTooltipTrack(GmCXt.tooltipTrackingList[step_id], step_id);
                            list[ind].ttTime = GmCXt.getCurrentTimeInMilSec();
                        }
                    } else {
                        triggerTooltipTrack(GmCXt.tooltipTrackingList[step_id], step_id);
                        list.push(currentTTData);
                    }
                } else {
                    triggerTooltipTrack(GmCXt.tooltipTrackingList[step_id], step_id);
                    list.push(currentTTData);
                }

                GmCXt.tooltipTrackData = list;
                GmCXt.storage().set({
                    'tooltipTrackData': JSON.stringify(list)
                });
            }
        };

        cb();

    },

    trackBeacons: function(currentBeaconTour, actionType) {
        if (GmCXt.trackingDisabled()) return;

        let bTrackList = [];

        let bTrackData = {
            beacon: currentBeaconTour.tour_id + "_" + actionType,
            bTime: GmCXt.getCurrentTimeInMilSec(),
        };

        let segs = [];
        if (!GmCXt.isEmpty(currentBeaconTour.tour_settings.segment_groups)) {
            segs = GmCXt.getTourSegmentDetail(currentBeaconTour);
        }

        let beaconUrl = (currentBeaconTour.tour_url.indexOf('://') === -1) ? 'https://' + currentBeaconTour.tour_url : currentBeaconTour.tour_url;

        GmCXt.storage().get(['beaconTrackData']).then(function(result) {
            let blist = [];
            if (!GmCXt.isEmpty(result)) blist = GmCXt.parseJSON(result.beaconTrackData);

            if (GmCXt.isEmpty(blist)) {
                bTrackList.push(bTrackData);
                trackBeaconCB();
            } else {
                let currentBIndx = blist.findIndex(function(item) {
                    return item.beacon === bTrackData.beacon;
                });
                if (currentBIndx === -1) {
                    bTrackList = blist;
                    bTrackList.push(bTrackData);
                    trackBeaconCB();
                } else {
                    let timeDiff = GmCXt.getCurrentTimeInMilSec() - blist[currentBIndx].bTime;
                    if (timeDiff > GmCXt.t.tracking8hr) {
                        blist[currentBIndx].bTime = GmCXt.getCurrentTimeInMilSec();
                        trackBeaconCB();
                    }
                }
            }
        });

        function trackBeaconCB() {
            e = {
                app_code: GmCXt.trackerV1.getAppCode(),
                eventName: 'mi_beacon_shown',
                objectId: currentBeaconTour.tour_id,
                miscellaneous: {
                    env_code: GmCXt.trackerV1.getEnvCode(currentBeaconTour.tour_url),
                    url: beaconUrl,
                    play_instance_id: GmCXt.getUUID(),
                    action_type: [actionType],
                    segment_details: segs,
                    is_new_user: false,
                    event_start_time: GmCXt.getCurrentTimeInMilSec(),
                    event_end_time: GmCXt.getCurrentTimeInMilSec(),
                },
                url: GmCXt.trackerUtil.page_url || GmCXt.urlParts.fullUrl || currentBeaconTour.tour_url,
                screen_size: GmCXt.trackerV1.getScreenSize()
            };

            let payload = GmCXt.trackerV1.setPayLoad(e);
            GmCXt.trackerV1.sendPayloadEventCall(payload);

            GmCXt.storage().set({
                'beaconTrackData': JSON.stringify(bTrackList)
            });
        }

    },

    trackPushNotification: function(pTour, actionType) {
        if (GmCXt.trackingDisabled()) return;


        let segs = [];
        if (!GmCXt.isEmpty(pTour.tour_settings.segment_groups)) {
            segs = GmCXt.getTourSegmentDetail(pTour);
        }

        let pushUrl = (pTour.tour_url.indexOf('://') === -1) ? 'https://' + pTour.tour_url : pTour.tour_url;

        e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_push_notification_shown',
            objectId: pTour.tour_id,
            miscellaneous: {
                env_code: GmCXt.trackerV1.getEnvCode(pTour.tour_url),
                url: pushUrl,
                play_instance_id: GmCXt.getUUID(),
                action_type: [actionType],
                segment_details: segs,
                is_new_user: false,
                event_start_time: GmCXt.getCurrentTimeInMilSec(),
                event_end_time: GmCXt.getCurrentTimeInMilSec(),
            },
            url: GmCXt.trackerUtil.page_url || GmCXt.urlParts.fullUrl || pTour.tour_url,
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.sendPayloadEventCall(payload);
    },

    trackSurveyInstantResponse: function(surveyAnswer, d) {
        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_sentiment_response',
            objectType: 'guide',
            objectId: d.sentimentCode,
            miscellaneous: {
                response_code: GmCXt.getUUID(),
                trigger_source_type: d.trigger_source_type,
                trigger_source_id: d.trigger_source_id,
                answers: surveyAnswer,
                source_url: GmCXt.urlParts.fullUrl,
                source_page_title: GmCXt.pageTitle
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.apiTrackSentiment(payload);
    },

    trackConversationResponse: function(convAnswer, d) {
        let e = {
            app_code: GmCXt.trackerV1.getAppCode(),
            eventName: 'mi_conversation_response',
            objectType: 'bot',
            objectId: d.conversationCode,
            miscellaneous: {
                response_code: GmCXt.getUUID(),
                trigger_source_type: d.trigger_source_type,
                trigger_source_id: d.trigger_source_id,
                answers: convAnswer,
                source_url: GmCXt.urlParts.fullUrl,
                source_page_title: GmCXt.pageTitle
            },
            screen_size: GmCXt.trackerV1.getScreenSize()
        };

        let payload = GmCXt.trackerV1.setPayLoad(e);
        GmCXt.trackerV1.apiTrackConversation(payload);
    },

    trackMyBotEvents: function(data) {

        if (data) {
            let eventType = 'mi_mybot_run';
            let e = {
                app_code: GmCXt.trackerV1.getAppCode(),
                eventName: eventType,
                objectId: data.testCode,
                miscellaneous: {
                    "run_type": data.runType,
                    "status": data.status,
                    "resultStatus": data.resultStatus,
                    "result_sequence": data.resultSequence
                },
                screen_size: GmCXt.trackerV1.getScreenSize()
            };

            let payload = GmCXt.trackerV1.setPayLoad(e);
            GmCXt.trackerV1.sendGuideAutomationEvent(payload);
        }
    },

    trackElNotFound: function(data) {

        if (data) {

            let p = {
                page_url: GmCXt.urlParts.fullUrl,
                page_title: GmCXt.pageTitle,
                event_start_time: GmCXt.getCurrentTimeInMilSec(),
                event_end_time: GmCXt.getCurrentTimeInMilSec(),
                step_id: data.step_id || null,
            };

            let e = {
                app_code: GmCXt.trackerV1.getAppCode(),
                eventName: "mi_rule_enhancement",
                objectId: data.tour_id,
                miscellaneous: {
                    source: data.source,
                    play_instance_id: GmCXt.getUUID(),
                    element_player_instance: [p]
                },
                url: GmCXt.urlParts.fullUrl,
                screen_size: GmCXt.trackerV1.getScreenSize()
            };

            GmCXt.trackerUtil.ePayload["el_" + data.tour_id] = e;
            let payload = GmCXt.trackerV1.setPayLoad(e);
            GmCXt.trackerV1.sendPayloadEventCall(payload);
        }
    },

    sendEvents: function(forcePush) {
        if (GmCXt.trackerUtil.guidePayload.length) {
            GmCXt.trackerV1.track(GmCXt.trackerUtil.guidePayload);
        }
    }
};

GmCXt.trackingDisabled = function() {
    if (GmCXt.trackerUtil.enableTracking)
        return false;
    else
        return true;
};

GmCXt.trackerV1.startMyBotTracking = function() {
    GmCXt.log(37, "Stop tracking events");
    clearInterval(GmCXt.trackerV1.interval);
    GmCXt.trackerV1.sendEvents();
};
if (GmCXt === undefined) var GmCXt = {};
let stepAudio = {};
let userPrefAudio = false;

// Starts message channel only inside audio iframe
if (!GmCXt.msgChannel) {
    GmCXt.msgChannel = new MessageChannel();
}
if (document.querySelectorAll('.mgPlayerJSProd_audio-iframe-icons').length > 0) {
    window.top.postMessage('Guide:audioIframe', '*', [GmCXt.msgChannel.port2]);
}

GmCXt.modifyElements = function(elements, operation, className) {
    elements.forEach(element => {
        switch (operation) {
        case 'show':
            element.style.display = 'block';
            break;

        case 'hide':
            element.style.display = 'none';
            break;

        case 'addClass':
            element.classList.add(className);
            break;

        case 'removeClass':
            element.classList.remove(className);
            break;
        }
    });
};

GmCXt.setAudioModeOn = function() {
    if (document.getElementsByClassName('mgPlayerJSProd_play-step-audio-on') &&
		document.getElementsByClassName('mgPlayerJSProd_play-step-audio-on').length) {
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio-on'), 'show');
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio-off'), 'hide');
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio'), 'addClass', 'playing-audio');

        if (userPrefAudio) {

            let action = "mgPlayerJSProd_action:set_audio_storage";
            let data = {
                'stepAudioRunningStatus': true
            };
            GmCXt.formatAndSendToParentWindow(action, data);
        }
    } else {
        GmCXt.formatAndSendToParentWindow("mgPlayerJSProd_action:set_audio_mode_on", {});
    }
};

GmCXt.setAudioModeOff = function() {
    if (document.getElementsByClassName('mgPlayerJSProd_play-step-audio-off') &&
		document.getElementsByClassName('mgPlayerJSProd_play-step-audio-off').length) {
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio-on'), 'hide');
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio-off'), 'show');
        GmCXt.modifyElements(document.querySelectorAll('.mgPlayerJSProd_play-step-audio'), 'removeClass', 'playing-audio');

        if (userPrefAudio) {

            let action = "mgPlayerJSProd_action:set_audio_storage";
            let data = {
                'stepAudioRunningStatus': false
            };
            GmCXt.formatAndSendToParentWindow(action, data);
        }
    } else {
        GmCXt.formatAndSendToParentWindow("mgPlayerJSProd_action:set_audio_mode_off", {});
    }
};

if (GmCXt.requestHandler === undefined) {
    GmCXt.requestHandler = {};
}

GmCXt.requestHandler.playAudioTrack = function(message) {
    GmCXt.playStepAudio(message);
};

GmCXt.isEmpty = function(val) {
    if (typeof val === "boolean" || typeof val === "number") return false; // for 'false' & zero

    if (!val) return true;

    if (typeof val === "object" && val.constructor === Object) return Object.keys(val).length ? false : true;

    if (typeof val === "object" && val.constructor === Array) return val.length ? false : true;

    if (typeof val === 'string' && !val.trim()) return true;

    return false;
};

GmCXt.getCdnSign = function() {
    let sign = '';
    if (GmCXt.user && !GmCXt.isEmpty(GmCXt.user)) {
        sign = GmCXt.user.cdn_signature;
    } 

    return sign;
};

GmCXt.convertMgdata = function(m) {
    if (m.action && m.action.indexOf("init_sfdc_env") !== -1) {
        return m;
    } else if (m.data && m.data.config && m.data.config.appConfig &&
		m.data.config.appConfig.customer === 'westpac' && m.action && m.action.indexOf("MyGuideReporting") !== -1) {
        return m;
    }
    m.data = m.mgdata;
    return m;
};

GmCXt.syncPlayerInst = function(m) {
    if (m === "mgPlayerJSProd_action:started;task:select_existing_dom_element" ||
		m === "mgPlayerJSProd_action:started;task:select_existing_dom_element:target_frame_only" ||
		m === "mgPlayerJSProd_action:started;task:select_dom_element_tooltips" ||
		m === "mgPlayerJSProd_action:task:init_new_iframe" ||
		m === "mgPlayerJSProd_action:update_player_instance" ||
		m === "mgPlayerJSProd_action:update_player_instance_app" ||
		m === "mgPlayerJSProd_action:set_audio_mode_off" ||
		m === "mgPlayerJSProd_action:set_audio_mode_on" ||
		m === "mgPlayerJSProd_action:close_guide" ||
		m === "mgPlayerJSProd_action:set_style_audio_icon_response") {
        return true;
    } else {
        return false;
    }
};

// This listener is only in Guide iframe
window.addEventListener('message', function(event) {
    if (!GmCXt) {
        GmCXt = event.target.GmCXt;
    }

    function parseJSON(str) {
        try {
            if (typeof str === 'object') {
                return str;
            } else if (str === '' || str === 'AS' ||
                str === 'na' || str === '[object Object]' ||
                str === undefined || str === 'undefined'
            ) {
                return {};
            } else {
                return JSON.parse(str);
            }

        } catch (e) {
            return {};
        }
    };

    function parseMsg(e) {
        let copiedE = e;
        let cData = parseJSON(copiedE.data);
        return cData;
    };

    let message = parseMsg(event);

    if (!message) return;
    if (!message.action || message.action.indexOf('mgPlayerJSProd_action:') !== 0) return;
    message = GmCXt.convertMgdata(message);

    if (message.data) {

        if (message.data.config) {
            GmCXt.conf = message.data.config;
        }

        if (message.data.user && Object.keys(message.data.user).length) {
            GmCXt.user = message.data.user;
        }

        if (GmCXt.syncPlayerInst(message.action)) {
            if (message.data.playerInstance) {
                GmCXt.playerI = message.data.playerInstance;
            }
        }
    }

    switch (message.action) {

    case 'mgPlayerJSProd_action:set_audio_mode_on':
        GmCXt.setAudioModeOn();
        break;

    case 'mgPlayerJSProd_action:set_audio_mode_off':
        GmCXt.setAudioModeOff();
        break;

    case 'mgPlayerJSProd_action:set_style_audio_icon_response':
        document.documentElement.insertAdjacentHTML('beforeend', message.data.data);
        document.querySelectorAll('.mgPlayerJSProd_audio-iframe-icons').forEach(element => {
            element.removeAttribute('style');
        });
        GmCXt.formatAndSendToParentWindow('mgPlayerJSProd_action:hide_pop_audio_ctrl', {});
        break;
    }

}, false);

GmCXt.pauseAudio = function() {
    if (GmCXt.audioObject) {
        GmCXt.audioObject.pause();
    }
};

GmCXt.checkAssetUrl = function(tempUrl, url, cb) {
    if (tempUrl === url) {
        cb(tempUrl);
    } else {
        let promise = GmCXt.checkFileExist(tempUrl);
        promise.then(function() {
            cb(tempUrl);
        }).catch(function(e) {
            cb(url);
        });
    }
};

GmCXt.playStepAudio = function(message) {
    GmCXt.isPageReloaded = false;
    GmCXt.setAudioModeOn();
    if (!message || !message.data) {
        if (GmCXt.playerI) {
            let step = GmCXt.stepFromPlayerI(GmCXt.playerI.currentStepId);
            message = {
                audioTrack: step.step_audio,
                step: step
            };
        }
    }

    let audioTrack = message.audioTrack;

    let play = function(url) {
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.blob();
            })
            .then(blob => {

                const blobUrl = URL.createObjectURL(blob); 
        
                let stepObj = message.step;

                if (GmCXt.audioObject) {
                    GmCXt.audioObject.pause();
                }

                GmCXt.audioObject = new Audio(blobUrl);

                let action = "mgPlayerJSProd_action:start_step_completion_timeout";
                let data = {
                    step: stepObj
                };

                GmCXt.audioObject.onended = function() {
                    // Set Complete step timeout after audio is finished
                    URL.revokeObjectURL(blobUrl);
                    GmCXt.formatAndSendToParentWindow(action, data);
                };

                let promise = GmCXt.audioObject.play();
                if (promise !== undefined) {
                    promise.then(function() {
                        // Autoplay started!
                    }).catch(function(e) {
                        // Autoplay was prevented.
                        // disbaled audio button
                        console.log("Audio Track Fail", e);
                        URL.revokeObjectURL(blobUrl);
                        GmCXt.formatAndSendToParentWindow(action, data);
                        GmCXt.setAudioModeOff();
                    });
                }
            });
    };

    if (audioTrack && audioTrack.indexOf(GmCXt.user.cdn_signature.split("=")[0]) === -1) {
        audioTrack = audioTrack + GmCXt.getCdnSign();
    }

    GmCXt.checkAssetUrl(audioTrack, audioTrack, play);

};

GmCXt.stopAudio = function() {
    if (GmCXt.audioObject) GmCXt.audioObject.pause();
};

GmCXt.stepFromPlayerI = function(step_id) {
    let step = false;
    var steps = [];

    var steps = GmCXt.playerI.tour.steps;

    for (let i = 0; i < steps.length; i++) {
        if (parseInt(steps[i].step_id) === parseInt(step_id)) {
            step = steps[i];
            break;
        }
    }
    if (!step.step_description) step.step_description = " ";

    // Map properties
    step.image_url = step.image_url + GmCXt.getCdnSign();
    step.screen_url = step.screen_url + GmCXt.getCdnSign();
    return step;
};


GmCXt.formatAndSendToParentWindow = function(action, data) {

    let m = {};
    m.action = action;
    m.data = data || {};

    if (GmCXt.playerI || GmCXt.playerI === null) {
        m.data.playerInstance = GmCXt.playerI;
    }

    if (m.data && typeof m.data === 'object') {
        if (GmCXt.isSidePanelApp) {
            m.data.fromSidePanel = GmCXt.isSidePanelApp;
        }

        if (m.action !== "mgPlayerJSProd_action:payload_event_call") {
            m.data.user = GmCXt.user;
        }

        if (m.action === "mgPlayerJSProd_action:payload_event_call") {
            delete m.data.fromSidePanel;
        }
    }

    if (m.data && m.data.config && m.data.config.appConfig &&
		m.data.config.appConfig.customer === 'westpac' && m.action.indexOf("MyGuideReporting") !== -1) {
        GmCXt.msgChannel.port1.postMessage(m);
    } else {

        if (m.data) {
            m.mgdata = m.data;
            delete m.data;
        }

        GmCXt.msgChannel.port1.postMessage(JSON.stringify(m));
    }
};


// Select all elements with the class 'mgPlayerJSProd_play-step-audio-on'
document.querySelectorAll('.mgPlayerJSProd_play-step-audio-on').forEach(element => {
    // Remove all click event listeners (if any) by setting up the event listener again
    element.removeEventListener('click', GmCXt.audioOnBtnClick);
    // Add a new click event listener
    element.addEventListener('click', function() {
        GmCXt.audioOnBtnClick();
    });
});


// Select all elements with the class 'mgPlayerJSProd_play-step-audio-off'
document.querySelectorAll('.mgPlayerJSProd_play-step-audio-off').forEach(element => {
    // Remove all click event listeners (if any) by setting up the event listener again
    element.removeEventListener('click', GmCXt.audioOffBtnClick);
    // Add a new click event listener
    element.addEventListener('click', function() {
        GmCXt.audioOffBtnClick();
    });
});


GmCXt.audioOnBtnClick = function() {
    userPrefAudio = true;
    GmCXt.stopAudio();
    GmCXt.setAudioModeOff();
    GmCXt.formatAndSendToParentWindow('mgPlayerJSProd_action:pause_playing_audio', {});
};

GmCXt.audioOffBtnClick = function() {
    userPrefAudio = true;
    if (GmCXt.playerI) {
        let step = GmCXt.stepFromPlayerI(GmCXt.playerI.currentStepId);
        message = {
            audioTrack: step.step_audio,
            step: step
        };
        GmCXt.isPageReloaded = false;
        GmCXt.playStepAudio(message);
    }
};

document.addEventListener('DOMContentLoaded', function() {
    GmCXt.formatAndSendToParentWindow('mgPlayerJSProd_action:set_style_audio_icon', {});
});
/*global GmCXt, mg$ */
let SMARTTIP_WAIT_TIME_TO_RENDER = 5000;

GmCXt.auto = (function() {

    let pub = {};
    let self = {};
    let FAILED = "Failed";
    let PASSED = "Passed";
    let SKIPPED = "Skipped";
    let UNKNOWN = "UNKNOWN";
    let isTourPlayingOnAnotherTab = false;

    pub.init = function(app) {

        GmCXt.log(36, 'START MYBOT', {
            app: app
        });
        self = {};
        self.tours = [];
        self.ignoreTours = [];
        self.current = 0;
        self.app = app;
        self.app.external_id = GmCXt.appList['app:' + self.app.application_id].external_id;
        self.app.settings = {
            domains: GmCXt.appList['app:' + self.app.application_id].settings.domains
        };
        self.startURLDomain = window.location.host;
        self.testResultsDataArray = [];
        self.apiPayloadResultSequence = [];
        self.trackerObj = {};
        self.shouldRedirectToTourPage = true;
        self.smartTipSteps = [];
        self.showDetailedProgressbar = false;

        pub.setEndTime();
        pub.startWatcher();

        if (!self.app.categories || self.app.categories.length < 1) {
            GmCXt.log(36, 'NO DATA FOUND TO RUN MYBOT', 1);
        }
        getTours();

        self.totalTours = self.tours.length;

        if (self.totalTours < 1) {
            GmCXt.log(36, 'NO GUIDE FOUND', 1);
        }

        GmCXt.testResultsFromCreator = {
            show: false,
        };

        pub.showProgress();
        resetStorageData(function() {
            redirectToTourPage();
        });

    };

    var resetStorageData = function(cb) {
        if (GmCXt.onScreenTooltipGuideInfo) {
            pub.setTooltipAutoDataToStorage(GmCXt.onScreenTooltipGuideInfo);
        }
        let notificationData = getNotificationData();
        self.automationInProgress = true;
        GmCXt.storage().set({
            'testAuto': self,
            'testNotificationAuto': notificationData,
            'testAutoResultsFromCreator': GmCXt.testResultsFromCreator
        }).then(function() {
            cb();
        });
    };

    pub.isAutomationRunning = function() {
        if (self) {
            return self.automationInProgress;
        }
        return false;
    };

    pub.getAutomatedCurrentTour = function() {
        if (self && self.tours.length > 0) {
            return self.tours[self.current];
        }
        return false;
    };

    pub.fail = function(step, message) {
        if (!step) {
            step = {};
        }

        GmCXt.log(36, "FAILED: STEP TEST AUTOMATION", {
            stepTitle: step.step_title
        });

        let errorMessage = message ? message.errorMessage : '';
        pub.get(function() {
            if (!self) {
                return;
            }
            let stepTitle = cleanCommasAndHTMLTagsFromString(step.step_title);
            self.tours[self.current].test = {
                status: FAILED,
                stepTitle: stepTitle ? stepTitle : '',
                stepOrder: step.step_order ? step.step_order : '',
                errorMessage: errorMessage
            };
            self.smartTipSteps = [];
            step.errorMessage = errorMessage;
            pub.updateTrackerObj(self.tours[self.current].tour_id, FAILED, step, function() {
                pub.next();
            });
        });
    };

    pub.newTabStepFound = function(option, isNextStep) {
        if (option === "new_tab") {
            isTourPlayingOnAnotherTab = true;
            mg$('.mgPlayerJSProd_auto-prog-wrapper').remove();
        } else {
            isTourPlayingOnAnotherTab = false;
            pub.showProgress();
            if (!isNextStep && option === "reload") {
                GmCXt.playerI.isPageReloadByLastStep = true;

                GmCXt.storage().set({
                    'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
                    'guide_play_event': GmCXt.guidePlayTracker
                });
            }
        }
    };

    pub.setCurrentBranchDetail = function(stepId, branchIndex, branchName, branchStepId, cb) {
        GmCXt.log(36, "SET CURRENTLY PLAYING BRANCH DETAIL");
        let branchTestData = self.tours[self.current].branchTest;
        if (!branchTestData || branchTestData.length === 0) {
            branchTestData = [];
        }
        branchTestData.push({
            branchName: branchName,
            branchStepId: branchStepId,
            branchIndex: branchIndex,
            stepId: stepId
        });
        self.branchStack.push({
            branchName: branchName,
            branchStepId: branchStepId,
            branchIndex: branchIndex,
            stepId: stepId
        });
        self.tours[self.current].branchTest = branchTestData;
        pub.set(cb);
    };

    pub.branchPlaySuccess = function(stepId, cb) {
        GmCXt.log(36, "TOUR BRANCH PLAYED SUCCESS");
        let autoBranchTestStatus = self.tours[self.current].branchTest;
        for (let i = 0; i < autoBranchTestStatus.length; i++) {
            if (autoBranchTestStatus[i].stepId === stepId) {
                autoBranchTestStatus[i].status = PASSED;
                break;
            }
        }
        self.branchStack.pop();
        pub.set(cb);
    };

    pub.branchPlayFailed = function(step) {
        GmCXt.log(36, "TOUR BRANCH PLAYED FAILED");
        let autoBranchTestStatus = self.tours[self.current].branchTest;
        for (let i = 0; i < autoBranchTestStatus.length; i++) {
            if (autoBranchTestStatus[i].stepId === step.step_id) {
                autoBranchTestStatus[i].status = FAILED;
                pub.fail(step, {
                    errorMessage: 'Failed at branch - ' + autoBranchTestStatus[i].branchName
                });
                break;
            }
        }
    };
    pub.getPreviousBranch = function() {
        let previousBranch = {};
        if (self.branchStack && self.branchStack.length > 0) {
            previousBranch.index = self.branchStack[self.branchStack.length - 1].branchIndex;
            previousBranch.step = GmCXt.getCurrentStep(self.branchStack[self.branchStack.length - 1].branchStepId);
        }
        return previousBranch;
    };

    /*
		*	Both params are optional
		*/
    pub.succeed = function() {
        GmCXt.log(36, "TOUR PLAY SUCCESS");
        self.tours[self.current].test = {
            status: PASSED
        };
        self.smartTipSteps = [];
        self.playNext = true;
        GmCXt.log(37, "Tour Marked as Success");
        pub.updateTrackerObj(self.tours[self.current].tour_id, PASSED, null, function() {
            GmCXt.log(37, "Automation - Play Next");
            pub.next();
        });
    };

    pub.skipped = function(step) {
        GmCXt.log(36, "STEP PLAY SKIPPED");
        pub.get(function() {
            self.tours[self.current].test = {
                status: SKIPPED,
                stepTitle: step.step_title
            };
            self.smartTipSteps = [];
            pub.updateTrackerObj(self.tours[self.current].tour_id, SKIPPED, step, function() {
                pub.next();
            });
        });
    };

    pub.updateTrackerObj = function(tour_id, status, step, cb) {
        if (!cb) {
            cb = function() {};
        }
        tour_id = Number(tour_id);

        let errorMessage = step ? (step.errorMessage || '') : '';

        let trackerCurrentTour = self.trackerObj[tour_id];

        if (!trackerCurrentTour) {
            GmCXt.log(37, 'INCORRECT GUIDE - This step might open in a new tab/window.' +
				' Please make sure you have the right option selected while step creation.', 1);
            return;
        }

        let totalSteps = trackerCurrentTour.totalSteps;
        let statusText = status;

        let stepOrder = step ? step.step_order : 0;
        let stepTitle = step ? cleanCommasAndHTMLTagsFromString(step.step_title) : '';

        if (status === FAILED && stepOrder) {
            statusText = "Failed at step [" + stepOrder + "). " + stepTitle + "]";
        } else if (status === SKIPPED) {
            statusText = "Skipped at step [" + stepOrder + "). " + stepTitle + "]";
        } else if (status === PASSED) {
            statusText = (totalSteps + "/" + totalSteps + " Step(s) " + status);
            if (self.tours[self.current].branchTest && self.tours[self.current].branchTest.length > 0) {
                let noOfBranchPassed = getNoOfBranchPassed();
                statusText += '[Played ' + noOfBranchPassed + ' branches in this guide]';
            }
            if (self.message) {
                errorMessage += ' ' + self.message;
            }
        } else if (status === UNKNOWN) {
            statusText = '';
        }

        self.trackerObj[tour_id].index = self.current;
        self.trackerObj[tour_id].test = {
            statusText: statusText,
            status: status,
            stepTitle: stepTitle,
            stepOrder: stepOrder,
            errorMessage: errorMessage
        };

        GmCXt.log(37, "TRACKER OBJ UPDATED", self.trackerObj);
        if (GmCXt.playerI) {
            let jobId = GmCXt.playerI.currentStepId;
            GmCXt.tourPlayerI.closeStep(jobId, false);
            GmCXt.cleanPlayer();
        }

        // Set to storage so that it can be later hydrated on next pages.
        pub.set(cb);
    };

    pub.updateAutomationMessage = function(message, cb) {
        if (self.message && self.message.includes(message)) {
            pub.set(cb);
            return;
        }
        if (!self.message) {
            self.message = "";
        } else if (self.message !== "") {
            self.message += ", ";
        }
        self.message += message;
        pub.set(cb);
    };

    var getNoOfBranchPassed = function() {
        let autoBranchTestStatus = self.tours[self.current].branchTest;
        let noOfBranchPassed = 0;
        for (let i = 0; i < autoBranchTestStatus.length; i++) {
            if (autoBranchTestStatus[i].status === PASSED) {
                noOfBranchPassed += 1;
            }
        }
        return noOfBranchPassed;
    };

    pub.pushCurrentTourToTrackerObj = function(tour, steps, index, cb) {

        GmCXt.log(36, "PUSH CURRENT TOUR TO TRACKER OBJECT");

        self.branchStack = [];
        let totalSteps = 0;
        if (steps && steps.length > 0) {
            steps = GmCXt.filterOutAutomationSteps(steps);
            totalSteps = steps ? steps.length : 0;
        }

        self.trackerObj[tour.tour_id] = {
            index: index,
            totalSteps: totalSteps,
            test: {
                status: UNKNOWN
            }
        };
        self.message = "";
        // Set to storage so that it can be later hydrated on next pages.
        pub.set(cb);

        GmCXt.log(37, "PUSHED TO TRACKER OBJ", self.trackerObj);
    };

    pub.playNextAfterRedirection = function() {
        if (!self.automationInProgress) {
            return;
        }
        pub.set(function() {
            if (self.current < self.totalTours) {
                GmCXt.log(36, "PLAY NEXT TOUR AFTER REDIRECTION");
                let oldTour = self.tours[self.current - 1];
                testTour(oldTour.tour_type);
            } else {
                pub.stop();
            }
        });
    };

    pub.next = function() {
        if (!self.automationInProgress) {
            return;
        }
        pub.set(function() {
            if (self.current < self.totalTours && !isTourPlayingOnAnotherTab) {
                GmCXt.log(36, "TOUR PLAY NEXT");
                self.current = self.current + 1;

                redirectToTourPage();

            } else {
                pub.stop();
            }
        });
    };

    pub.stop = function(isInterrupted) {
        GmCXt.log(36, "STOP MYBOT");
        if (!isTourPlayingOnAnotherTab && GmCXt.isAutomationRunning()) {
            if (GmCXt.playerI) GmCXt.cleanPlayer();
            pub.get(function() {
                pub.printReport(isInterrupted);
                GmCXt.storage().remove(['testAuto']);
            });
        }
    };

    pub.set = function(cb, testAuto) {
        GmCXt.storage().set({
            'testAuto': self || testAuto
        }).then(function() {
            if (cb) {
                cb();
            }
        });
    };

    pub.get = function(cb) {
        GmCXt.storage().get(['testAuto'])
            .then(function(st) {
                self = st.testAuto;
                if (cb) {
                    cb(self);
                }
            });
    };

    pub.setTooltipAutoDataToStorage = function(tooltips) {
        GmCXt.log(43, "STORE TOOLTIPS", tooltips);
        pub.getTooltipAutoDataFromStorage(function(tData) {
            tData = Object.assign(tData, tooltips);

            GmCXt.storage().set({
                'testTooltipAuto': tData
            });
        });
    };

    pub.getTooltipAutoDataFromStorage = function(cb) {
        GmCXt.storage().get(['testTooltipAuto'])
            .then(function(st) {
                cb(st.testTooltipAuto || {});
            });
    };

    pub.setBeaconsAutoDataToStorage = function(beacons) {
        GmCXt.log(49, "STORE BEACONS", beacons);
        getBeaconsAutoDataFromStorage(function(data) {
            if (!data) {
                data = [];
            }
            data = data.concat(beacons);
            GmCXt.storage().set({
                'testBeaconsAuto': data
            });
        });
    };

    pub.trackDoNotShowNotificationsForAutomation = function(doNotShowTours, testNotificationAuto, self) {
        if (!doNotShowTours) {
            return;
        }
        Object.keys(doNotShowTours).forEach(function(tId) {
            if (self.tours[self.current].tour_id == tId) {
                testNotificationAuto.all[tId] = {
                    status: PASSED,
                    statusText: 'Notification marked as DO NOT SHOW'
                };
                GmCXt.auto.setNotificationAutoDataToStorage(testNotificationAuto);
            }
        });
    };

    pub.trackNotificationForAutomation = function(data) {

        pub.get(function(self) {
            if (data.isVisible) {
                pub.trackRenderedNotificationsForAutomation(data.tours, self);
            } else {
                pub.getNotificationAutoDataFromStorage(function(testNoti) {
                    let snoozedTours = getSnoozedTours(data.tours, self.tours);
                    GmCXt.auto.trackSnoozedNotificationsForAutomation(snoozedTours, testNoti, self);
                    GmCXt.auto.trackDoNotShowNotificationsForAutomation(data.doNotShowTours, testNoti, self);
                });
            }
        });
    };

    function getSnoozedTours(toursClosedByUser, tours) {
        return tours.filter(function(t) {
            if (toursClosedByUser[parseInt(t.tour_id)]) {
                return t;
            }
        });
    }

    pub.trackSnoozedNotificationsForAutomation = function(snoozedTours, testNotificationAuto, self) {
        if (snoozedTours && snoozedTours.length > 0) {
            snoozedTours.forEach(function(t) {
                if (self.tours[self.current].tour_id == t.tour_id) {
                    testNotificationAuto.all[t.tour_id] = {
                        status: PASSED,
                        statusText: 'Notification Snoozed'
                    };
                    GmCXt.auto.setNotificationAutoDataToStorage(testNotificationAuto);
                }
            });
        }
    };

    pub.trackRenderedNotificationsForAutomation = function(tours, self) {
        pub.getNotificationAutoDataFromStorage(function(data) {
            if (tours && tours.length > 0) {
                tours.forEach(function(t) {
                    if (self.tours[self.current].tour_id == t.tour_id) {
                        data.all[t.tour_id] = {
                            status: PASSED,
                            statusText: 'Notification Rendered'
                        };
                        GmCXt.auto.setNotificationAutoDataToStorage(data);
                    }
                });
            }
        });

    };

    pub.setNotificationAutoDataToStorage = function(notAutoData, cb) {
        pub.getNotificationAutoDataFromStorage(function(d) {
            if (notAutoData && notAutoData.all) {
                d.all = Object.assign(d.all || {}, notAutoData.all || {});
            }
            GmCXt.storage().set({
                'testNotificationAuto': d
            }).then(function() {
                if (cb) {
                    cb();
                }
            });
        });
    };

    pub.getNotificationAutoDataFromStorage = function(cb) {
        GmCXt.storage().get(['testNotificationAuto'])
            .then(function(st) {
                if (cb) {
                    cb(st.testNotificationAuto || {});
                }
            });
    };

    pub.resetBeaconsAutoDataToStorage = function() {
        GmCXt.storage().set({
            'testBeaconsAuto': []
        });
    };

    pub.resetTooltipAutoDataToStorage = function() {
        GmCXt.storage().set({
            'testTooltipAuto': {}
        });
    };

    pub.resetNotificationAutoDataToStorage = function() {
        GmCXt.storage().set({
            'testNotificationAuto': {
                all: {}
            }
        });
    };

    pub.onCloseTour = function() {
        pub.get(function(self) {
            let tourType = self.tours[self.current].tour_type;
            if (tourType.includes("smartTip")) {
                pub.trackTooltipStep(self.smartTipSteps);
            } else if (tourType.includes("onboarding_tour")) {
                pub.trackTutorialGuide();
            } else {
                pub.succeed();
            }
        });
    };

    pub.trackTutorialGuide = function() {
        // Wait for the notifications to render when Automation is running.
        GmCXt.timeout(function() {
            pub.succeed();
        }, GmCXt.t.waitForNotifications);
    };

    pub.trackTooltipStep = function(steps) {
        // Wait for the tooltips to render when Automation is running.
        GmCXt.timeout(function() {
            GmCXt.auto.getTooltipAutoDataFromStorage(function(tooltipAutoData) {
                for (let i = 0; i < steps.length; i++) {
                    let step = steps[i];

                    var status = FAILED;
                    if (tooltipAutoData) {
                        let tooltipGuidesStatus = tooltipAutoData['tour_' + step.tour_id];
                        if (tooltipGuidesStatus) {
                            if (tooltipGuidesStatus.visible.indexOf(step.step_id.toString()) !== -1) {
                                status = PASSED;
                            } else {
                                status = FAILED;
                            }
                        }
                    }
                    if (status === FAILED) {
                        pub.fail(step, {
                            errorMessage: 'Tooltip Failed'
                        });
                        break;
                    }
                }
                if (status === PASSED) {
                    pub.succeed();
                }
            });
        }, SMARTTIP_WAIT_TIME_TO_RENDER);
    };

    function getBeaconsAutoDataFromStorage(cb) {
        GmCXt.storage().get(['testBeaconsAuto'])
            .then(function(st) {
                cb(st.testBeaconsAuto || []);
            });
    }

    pub.getBranchTestStatus = function() {
        return self.tours[self.current].branchTest || [];
    };

    function getContextAutoDataFromStorage(cb) {
        GmCXt.storage().get(['testTooltipAuto', 'testBeaconsAuto', 'testNotificationAuto'])
            .then(function(st) {
                cb(st.testTooltipAuto || {}, st.testBeaconsAuto || [], st.testNotificationAuto || {});
            });
    }

    function setTestResultsToStorage(data, cb) {
        GmCXt.storage().set({
            'testAutoResultsFromCreator': data
        }).then(cb || function() {});
    }

    pub.getTestResultsFromStorage = function(cb) {
        GmCXt.storage().get(['testAutoResultsFromCreator', 'testAuto'])
            .then(function(st) {
                // Rehydrate the object state from storage on page refresh
                self = st.testAuto;
                cb(st.testAutoResultsFromCreator);
            });
    };

    pub.onRedirectToTourPage = function() {
        self.shouldRedirectToTourPage = false;
        if (self.current === 0) {
            testTour();
        } else {
            pub.playNextAfterRedirection();
        }
    };

    function redirectToTourPage(linkedTourId, originalTour) {
        if (!linkedTourId) {
            var t = self.tours[self.current];
        } else {
            var t = {
                tour_id: linkedTourId,
            };
        }

        if (!t) {
            pub.next();
            return;
        }
        GmCXt.getTourDetails({
            tour_id: t.tour_id,
            category_id: t.category_id,
            isPublic: false
        }).then(function(tour) {
            if (!tour || !tour.is_published) {

                GmCXt.log(37, "Tour is not published or might have been deleted");
                self.ignoreTours.push(t.tour_id); // Ignore Tours if they are not Published or deleted
                self.totalTours = self.totalTours - 1;
                self.tours.splice(self.current, 1);
                redirectToTourPage();
                return;
            }
            if (!originalTour) {
                originalTour = tour;
            }

            let firstStepId = tour.tour_settings.play_structure[0].id;
            let firstStep = GmCXt.getStepFromSteps(firstStepId, tour.steps);
            if (firstStep.step_type === "guide") {
                redirectToTourPage(firstStep.step_settings.tour_id.toString(), originalTour);
                return;
            }
            self.shouldRedirectToTourPage = true;
            self.playNext = false;
            pub.pushCurrentTourToTrackerObj(originalTour, originalTour.steps, self.current, function() {
                tour.allDomains = self.app.settings.domains;
                GmCXt.changeUrl(firstStep.step_url, tour, self.startURLDomain);
            });
        });
    }

    function testTour(previousTourType) {
        let t = self.tours[self.current];

        if (!t) {
            pub.next();
            return;
        }

        GmCXt.log(36, "START TOUR", {
            tourTitle: t.tour_title,
            tour_type: t.tour_type
        });

        function getAutomationSteps(steps) {
            return steps.filter(function(s) {
                return (GmCXt.isAutomationStep(s));
            });
        }

        pub.setEndTime();

        GmCXt.getTourDetails({
            tour_id: t.tour_id,
            category_id: t.category_id,
            isPublic: false
        }).then(function(tour) {

            if (tour.tour_type.includes("smartTip")) {
                self.smartTipSteps = GmCXt.filterOutAutomationSteps(tour.steps);
            }
            tour.previousTourType = previousTourType;
            let delay = 8000;
            var automationSteps = getAutomationSteps(tour.steps);

            if (!(tour.tour_type.includes("smartTip")) && !(tour.tour_type.includes("onboarding_tour"))) {
                GmCXt.timeout(function() {
                    if (self.automationInProgress) {
                        GmCXt.getTourDetailsCallback(tour, self.app.settings.domains, 'automation', 'live');
                    }
                }, delay);
            } else {
                var automationSteps = getAutomationSteps(tour.steps);
                let ruleMatchDelayTime = tour.tour_settings.ruleDelayTime;
                if (automationSteps.length > 0) {
                    tour.steps = automationSteps;
                    GmCXt.timeout(function() {
                        GmCXt.getTourDetailsCallback(tour, self.app.settings.domains, 'automation', 'live');
                    }, ruleMatchDelayTime + delay);
                } else if (tour.tour_type.includes("smartTip")) {
                    pub.showProgress();
                    GmCXt.timeout(function() {
                        pub.trackTooltipStep(self.smartTipSteps);
                    }, ruleMatchDelayTime);
                } else {
                    pub.trackTutorialGuide();
                }
                pub.set();
            }
        });

    }

    /*
		* Set timeout for automation and increment it on every step played.
		* So that results are always shown even if due to some reasons automation hangs in between
		*/
    pub.setEndTime = function() {
        GmCXt.log(37, "Automation: Set End Time: ", GmCXt.t.autoWaitTime);
        let t = GmCXt.t.autoWaitTime + GmCXt.t.autoEndTime;
        self.endTime = new Date().getTime() + t;
        pub.set();
    };

    /* 
		* Watch every 10 seconds for endTime and stop automation for current guide if time exceeds
		*/
    pub.startWatcher = function() {
        let itr = function() {
            if (!self.automationInProgress) {
                return;
            }
            if ((new Date()).valueOf() < self.endTime) {
                if (!isTourPlayingOnAnotherTab) {
                    pub.showProgress();
                }
                setTimeout(itr, GmCXt.t.guideAutoWatch);
            } else {
                GmCXt.log(37, "Stop automation for current guide due to timeout");
                if (isTourPlayingOnAnotherTab) {
                    return;
                }
                pub.setEndTime();
                let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
                pub.fail(step, {
                    errorMessage: "Stop automation for current guide due to timeout"
                });
            }
        };
        itr();
    };

    pub.getDetailedProgressBar = function() {
        let html =
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-prog-wrapper mgPlayerJSProd_inline-block-vm'>" +
			getProgressBarHeader() +
			"  	<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-prog-container-label'>" + GmCXt.label.active + "</wmgPlayerJSProd_>" +
			" 	<wmgPlayerJSProd_ class='mgPlayerJSProd_active-progress-bar-container'>" +
			"   	<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-progress-bar-loader'></wmgPlayerJSProd_>" +
			" 		<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_padding-l-10 mgPlayerJSProd_margin-t-5'>" + GmCXt.label.guide + (self.current + 1) + " : " + self.tours[self.current].tour_title + "</wmgPlayerJSProd_>" +
			"	</wmgPlayerJSProd_>" +
			"  	<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-prog-container-label'>" + GmCXt.label.completed + "</wmgPlayerJSProd_>" +
			"  	<wmgPlayerJSProd_ class='mgPlayerJSProd_completed-progress-bar-container'>";
        for (let i = 1; i < self.current + 1; i++) {
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_progr-bar-guide-item mgPlayerJSProd_padding-5'>";
            if (self.tours[i - 1].test.status === "Passed") {
                html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_span'>&#9989;</wmgPlayerJSProd_>";
            } else {
                html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_span'>&#10060;</wmgPlayerJSProd_>";
            }
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_padding-l-10'>" + GmCXt.label.guide + i + " : " + self.tours[i - 1].tour_title + "</wmgPlayerJSProd_> ";
            html += "</wmgPlayerJSProd_>";
        }
        html += "</wmgPlayerJSProd_>" +
			getProgressBarFooter(true) +
			"</wmgPlayerJSProd_>";

        return html;
    };

    pub.getShortProgressBar = function() {
        return "<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-prog-wrapper mgPlayerJSProd_inline-block-vm mgPlayerJSProd_height-90px'>" +
			getProgressBarHeader() +
			getProgressBarFooter(false) +
			"</wmgPlayerJSProd_>";
    };

    var getProgressBarHeader = function() {
        return "" +
			"  <wmgPlayerJSProd_ class='mgPlayerJSProd_auto-progress-bar-container'>" +
			"	 <wmgPlayerJSProd_ class='mgPlayerJSProd_prog-count mgPlayerJSProd_inline-block-vm'>" +
			GmCXt.label.running + " " + (self.current + 1) + "/" + self.totalTours +
			"	 </wmgPlayerJSProd_>" +
			"    <wmgPlayerJSProd_ class='mgPlayerJSProd_auto-progress-bar-loader'></wmgPlayerJSProd_>" +
			"  </wmgPlayerJSProd_>";
    };

    var getProgressBarFooter = function(showLess) {
        let html = "" +
			"  <wmgPlayerJSProd_ class='mgPlayerJSProd_display-flex mgPlayerJSProd_flex-direction-row mgPlayerJSProd_justify-content-space-between mgPlayerJSProd_margin-t-5 mgPlayerJSProd_padding-10 mgPlayerJSProd_height-38px'>";

        if (showLess) {
            html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_btn-showless' class='mgPlayerJSProd_auto-prog-expand-options'><a>" + GmCXt.label.lessDetails + "</a></wmgPlayerJSProd_>";
        } else {
            html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_btn-showmore' class='mgPlayerJSProd_auto-prog-expand-options'><a>" + GmCXt.label.viewMoreDetails + "</a></wmgPlayerJSProd_>";
        }
        html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_btn-default' class='mgPlayerJSProd_action-btn mgPlayerJSProd_auto-prog-btn'>" + GmCXt.label.stop + "</wmgPlayerJSProd_></wmgPlayerJSProd_>";
        return html;
    };

    pub.showProgress = function() {

        if (!self.automationInProgress) {
            return;
        }

        // First remove any previously existing element
        mg$(".mgPlayerJSProd_auto-prog-wrapper").remove();

        if (self.showDetailedProgressbar) {
            var progressBar = pub.getDetailedProgressBar();

            mg$("body").append(progressBar);
            document.getElementById("mgPlayerJSProd_btn-showless").onmouseup = function() {
                self.showDetailedProgressbar = false;
                pub.showProgress();
            };

        } else {
            progressBar = pub.getShortProgressBar();

            mg$("body").append(progressBar);
            document.getElementById("mgPlayerJSProd_btn-showmore").onmouseup = function() {
                self.showDetailedProgressbar = true;
                pub.showProgress();
            };
        }
        pub.set();

        document.getElementById("mgPlayerJSProd_btn-default").onmouseup = function() {
            mg$('.mgPlayerJSProd_auto-prog-wrapper').remove();
            pub.set();
            if (GmCXt.tourPlayerI) {
                GmCXt.tourPlayerI.closeGuide(true);
            } else {
                pub.stop(true);
            }
        };
    };

    let onCloseResultPopup = function(e) {
        mg$('.mgPlayerJSProd_auto-results-wrapper').remove();
        pub.destroyAutomation();
    };

    pub.renderResults = function(data, url) {

        if (data) {
            GmCXt.testResultsFromCreator = data;
        }

        // Hydrate the state, so that we can rehydrate it when page is refreshed.
        // Ideally it should be there already, but it got removed somewhere. So let's add it back.
        pub.set();

        if (GmCXt.testResultsFromCreator && GmCXt.testResultsFromCreator.show) {

            let showLoader = function() {
                mg$('#mgPlayerJSProd_auto-results-loader').show();
                mg$('#mgPlayerJSProd_insights_link').hide();
            };

            let hideLoader = function() {
                mg$('#mgPlayerJSProd_auto-results-loader').hide();
            };

            let onClickInsightsLink = function() {

                showLoader();

                let testCode = GmCXt.testResultsFromCreator.testCode;
                GmCXt.api.getHandOffToken().then(function(response) {

                    if (!response.error && response.data && response.data['handoff-token']) {
                        let token = response.data['handoff-token'];
                        let appCode = self.app.external_id;

                        let url = GmCXt.conf.analyticsPortalUrl.replace('v4', 'v3') + '#/automation-insights/automation-detail/' + testCode +
							'?app_id=' + GmCXt.activeAppId + '&app_code=' + appCode + '&handoff-token=' + token;

                        hideLoader();
                        onCloseResultPopup();
                        window.open(url, '_blank');
                    }
                }).catch(function(e) {
                    GmCXt.log(36, "Unable to get onetime access token for Insights portal");
                    console.error(e);
                    hideLoader();
                });

            };

            // Remove if already exists
            mg$('.mgPlayerJSProd_auto-results-wrapper').remove();
            mg$('.mgPlayerJSProd_auto-prog-wrapper').remove();

            let resultMessage = (data.testResultsDataArray[0].status === 'fail') ? GmCXt.label.automationFail : GmCXt.label.automationSuccess;
            let errorMessage = data.testResultsDataArray[0].message_text ? data.testResultsDataArray[0].message_text : '';

            let html =
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-results-wrapper mgPlayerJSProd_inline-block-vm'>" +
				"	<wmgPlayerJSProd_ class='mgPlayerJSProd_auto-results-header'>" +
				"      <wmgPlayerJSProd_ class='mgPlayerJSProd_auto-results-header-title'>" + GmCXt.label.testResults + "</wmgPlayerJSProd_>" +
				"	   <wmgPlayerJSProd_ class='mgPlayerJSProd_auto-results-close-btn'>" +
				"         <wmgPlayerJSProd_ id='mgPlayerJSProd_auto-test-result-close-btn'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
				"      </wmgPlayerJSProd_>" +
				"   </wmgPlayerJSProd_>" +
				"   <wmgPlayerJSProd_ id='mgPlayerJSProd_auto-results-loader' class='mgPlayerJSProd_auto-insights-link-loader-wrapper'>" +
				"       <wmgPlayerJSProd_ class='mgPlayerJSProd_auto-progress-bar-loader mgPlayerJSProd_auto-insights-link-loader'></wmgPlayerJSProd_>" +
				"   </wmgPlayerJSProd_>" +
				"   <wmgPlayerJSProd_ id='mgPlayerJSProd_insights_link' class='mgPlayerJSProd_insights-link-wrapper'>" +
				"       <wmgPlayerJSProd_ class='mgPlayerJSProd_automation-success-img-wrapper'>" +
				"           <img src='" + GmCXt.getExtUrl('common/img/test-success.png') + "' alt='success'/>" +
				"       </wmgPlayerJSProd_>" +
				"       <wmgPlayerJSProd_ class='mgPlayerJSProd_automation-success-link-wrapper'>" +
				"           <wmgPlayerJSProd_>" + resultMessage + "</wmgPlayerJSProd_>" +
				(errorMessage ? 
				    "           <wmgPlayerJSProd_>" + errorMessage + "</wmgPlayerJSProd_>" : 
				    ""
				) +
				"           <wmgPlayerJSProd_>" + GmCXt.label.viewResult + "</wmgPlayerJSProd_>" +
				"           <a>" + GmCXt.label.autoTestResult + "</a>" +
				"       </wmgPlayerJSProd_>" +
				"   </wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";

            // Remove any previously existing element
            mg$(".mgPlayerJSProd_auto-results-wrapper").remove();
            mg$("body").append(html);
            mg$('.mgPlayerJSProd_result-table-wrapper').hide();
            mg$('#mgPlayerJSProd_auto-export').hide();
            hideLoader();
            mg$('#mgPlayerJSProd_insights_link').on('click', 'a', onClickInsightsLink);
            document.getElementById("mgPlayerJSProd_auto-test-result-close-btn").onmouseup = onCloseResultPopup;
        }
    };

    pub.reportSaved = function() {
        GmCXt.testResultsFromCreator.show = true;
        setTestResultsToStorage(GmCXt.testResultsFromCreator, function() {
            pub.showResults(GmCXt.testResultsFromCreator);
        });
    };

    function getNotificationData() {
        let data = {
            all: {}
        };
        self.tours.forEach(function(t) {
            if (t.tour_type.indexOf('overlay_tour') > -1) {
                data.all[String(t.tour_id)] = {
                    status: "Failed",
                    statusText: 'Notification Failed'
                };
            }
        });
        return data;
    }

    function getTours() {
        loopCategories(self.app.categories);
    }

    function loopCategories(categories) {

        for (let i = 0, j = categories.length; i < j; i++) {
            let cat = categories[i];
            cat = GmCXt.validateDataModel(cat, GmCXt.model.category);

            if (cat.sub_categories && cat.sub_categories.length > 0) {
                loopCategories(cat.sub_categories);
            } else {
                self.tours = self.tours.concat(getReducedTour(cat.tours));
            }
        }
    }

    function getReducedTour(tours) {
        let reducedTour = [];
        tours.forEach(function(t) {
            reducedTour.push({
                tour_id: t.tour_id,
                tour_type: t.tour_type,
                tour_title: t.tour_title,
                category_id: t.category_id
            });
        });
        return reducedTour;
    }

    pub.showResults = function(testResultsFromCreator) {
        pub.renderResults(testResultsFromCreator);
    };

    pub.printReport = function(isInterrupted) {
        console.dir("**************** Test automation report ****************");
        getContextAutoDataFromStorage(function(TooltipAutoData, beaconsAutoData, testNotificationAuto) {

            GmCXt.log(37, "From Storage: Tooltip data         : ", TooltipAutoData);
            GmCXt.log(37, "From Storage: Beacons data         : ", beaconsAutoData);
            GmCXt.log(37, "From Storage: Notification data    : ", testNotificationAuto);

            if (!self || !self.app) {
                GmCXt.log(37, "Automation data not available");
                return;
            }
            self.automationInProgress = false;

            let finalResult = {
                status: 'pass'
            };
            let categoryInsights = printCategories(
                self.app.categories,
                0,
                TooltipAutoData,
                beaconsAutoData,
                testNotificationAuto, [],
                finalResult
            );
            self.apiPayloadResultSequence = categoryInsights;

            console.dir("-----------------End of test results---------------------");

            // Hide the progress bar
            mg$('.mgPlayerJSProd_auto-prog-wrapper').remove();

            if (GmCXt.isEmpty(GmCXt.conf.analyticsPath)) {
                GmCXt.log(36, "Analytic Path is not configured.");

                GmCXt.storage().remove(['testAutoResultsFromCreator']);
                pub.destroyAutomation();
                return;
            }

            let eventStartTime = formatDateObjForInsights(new Date());
            let testCode = GmCXt.getUUID();
			
            let data = {
                resultSequence: categoryInsights,
                url: window.location.protocol + "//" + window.location.hostname,
                eventStartTime: eventStartTime,
                runType: 'manual',
                status: isInterrupted ? 'interrupted' : 'complete',
                resultStatus: isInterrupted ? '' : finalResult.status,
                testCode: testCode
            };
            GmCXt.trackerV1.trackMyBotEvents(data);

            GmCXt.testResultsFromCreator.testCode = testCode;
            setTestResultsToStorage(GmCXt.testResultsFromCreator);

            GmCXt.closeNotificationPopupSidePanel();
            GmCXt.clearBeaconsAndTooltips();
            GmCXt.showWidget();
        });
    };

    // Format the date object to "YYYY-MM-DD HH-MM-SS"
    var formatDateObjForInsights = function(date) {
        let prependZero = function(d) {
            if (d < 10) {
                return "0" + d;
            }
            return d;
        };
        return date.getFullYear() +
			"-" + prependZero(date.getMonth() + 1) +
			"-" + prependZero(date.getDate()) +
			" " + prependZero(date.getHours()) +
			"-" + prependZero(date.getMinutes()) +
			"-" + prependZero(date.getSeconds());
    };

    function printCategories(categories, level, TooltipAutoData, beaconsAutoData,
        testNotificationAuto, categoryInsights, finalResult) {
        for (let i = 0, j = categories.length; i < j; i++) {
            let cat = categories[i];
            cat = GmCXt.validateDataModel(cat, GmCXt.model.category);
            let categoryId = cat.category_id;
            let resultObj = {
                "catgory_id": categoryId,
                "catgory_title": cat.category_title,
                "guides_tested": [],
                "children_categories": []
            };

            if (cat.sub_categories && cat.sub_categories.length > 0) {
                let childrenInsights = [];
                childrenInsights = printCategories(cat.sub_categories, level + 1, TooltipAutoData,
                    beaconsAutoData, testNotificationAuto, childrenInsights, finalResult);
                resultObj.children_categories = childrenInsights;
            } else if (cat.tours && cat.tours.length > 0) {
                console.dir("Category: " + cat.category_title);
                printTours(cat, level, TooltipAutoData, beaconsAutoData, testNotificationAuto, finalResult);
                let catFilter = function(categoryId, t) {
                    return (t.category_id === categoryId);
                };
                catFilter = catFilter.bind(null, categoryId);
                resultObj.guides_tested = self.testResultsDataArray.filter(catFilter);
            }
            categoryInsights.push(resultObj);
        }
        return categoryInsights;
    }

    function getTour(id) {
        for (let i = 0, j = self.tours.length; i < j; i++) {
            if (self.tours[i].tour_id === id) {
                return self.tours[i];
            }
        }
        return null;
    }

    function getOriginalTour(tours, id) {
        for (let i = 0, j = tours.length; i < j; i++) {
            if (tours[i].tour_id === id) {
                return tours[i];
            }
        }
        return null;
    }

    function getTestStatus(id, tourType, currentTourTracker, TooltipAutoData, beaconsAutoData, testNotificationAuto) {

        id = String(id);

        if (!currentTourTracker) {
            return {
                status: FAILED,
                statusText: ''
            };
        }

        let test = currentTourTracker.test;
        let status = test.status;
        let statusText = test.statusText;

        if (beaconsAutoData && GmCXt.inArray(Number(id), beaconsAutoData)) {
            statusText += " [Beacon Passed]";
        } else if (tourType.includes("beacon_tour")) {
            statusText += " [Beacon Failed]";
            status = FAILED;
        }

        if (testNotificationAuto && testNotificationAuto.all &&
			testNotificationAuto.all[id]) {
            let notificationTourResult = testNotificationAuto.all[id];
            if (notificationTourResult.status !== PASSED) {
                status = notificationTourResult.status;
            }
            statusText += " [" + notificationTourResult.statusText + "]";
        }

        return {
            status: status || FAILED,
            statusText: statusText || ''
        };
    }

    function printTours(category, level, TooltipAutoData, beaconsAutoData, testNotificationAuto, finalResult) {

        let tours = category.tours;
        for (let i = 0, j = tours.length; i < j; i++) {
            let currentTour = tours[i];
            if (self.ignoreTours.includes(currentTour.tour_id)) {
                continue;
            }
            let title = currentTour.tour_title;
            let tourType = currentTour.tour_type;
            if (title) {
                title = title.replaceAll(",", " ");
                // Clean HTML tags from the string
                title = mg$('<wmgPlayerJSProd_>' + title + '</wmgPlayerJSProd_>').text();
            }
            let id = currentTour.tour_id;
            let currentTourTracker = self.trackerObj[Number(id)];

            let message = '';
            if (currentTourTracker) {
                let test = currentTourTracker.test;
                if (test) {
                    message = test.errorMessage || '';
                }
            }
            let statusObj = getTestStatus(id, tourType, currentTourTracker, TooltipAutoData, beaconsAutoData, testNotificationAuto);
            let sts = statusObj.status === PASSED ? 'pass' : 'fail';

            if (sts === 'fail') {
                finalResult.status = sts;
            }
            console.dir("Status: " + sts + " | Title: " + title + " | StatusText: " + statusObj.statusText + " | Message: " + message);

            self.testResultsDataArray.push({
                'category_id': category.category_id,
                'guide_id': id,
                'guide_title': title,
                'status': sts,
                'status_text': statusObj.statusText,
                'message_text': message
            });
        }

        GmCXt.testResultsFromCreator = {
            show: false,
            testResultsDataArray: self.testResultsDataArray
        };
        setTestResultsToStorage(GmCXt.testResultsFromCreator);
    }

    var cleanCommasAndHTMLTagsFromString = function(str) {
        // Clean HTML tags from the string
        str = mg$('<wmgPlayerJSProd_>' + str + '</wmgPlayerJSProd_>').text();
        str = str.replaceAll(",", " ");
        return str;
    };

    pub.resumeState = function(d) {
        self = d;
    };

    pub.destroyAutomation = function() {
        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.closeGuide(true);
        }
        setTestResultsToStorage({
            show: false,
        });

        pub.resetBeaconsAutoDataToStorage();
        pub.resetNotificationAutoDataToStorage();
        pub.resetTooltipAutoDataToStorage();

        GmCXt.cleanPlayer();
        self = {};
        pub.cleanAllStorageDataForGuideAutomation();
    };

    pub.cleanAllStorageDataForGuideAutomation = function() {
        GmCXt.storage().remove(['testAuto']);
    };

    return pub;
})();
/*global GmCXt*/
GmCXt.model = {};

GmCXt.model.api = {
    code: {
        _type: "number",
        _required: true
    },
    data: {
        _type: "object",
        _required: true,
        _obj: {}
    },
    error: {
        _type: "bool",
        _required: true
    },
    message: {
        _type: "array",
        _required: true
    },
    version: {
        _type: "string"
    }
};

GmCXt.model.rule = {
    type: {
        _type: "string"
    },
    name: {
        _type: "string"
    },
    condition: {
        _type: "string"
    },
    value: {
        _type: "string"
    },
    logical_condition: {
        _type: "string"
    },
    showValueField: {
        _type: "bool"
    },
    isValid: {
        _type: "bool"
    }
};

GmCXt.model.langOption = {
    language: {
        _type: "string",
        _default: "en-US"
    },
    name: {
        _type: "string",
        _default: "English (United States)"
    },
    voice: {
        _type: "string",
        _default: "AriaNeural"
    }
};

GmCXt.model.segment = {
    id: {
        _type: "string"
    },
    key_name: {
        _type: "string"
    },
    data: {
        _type: "array",
        _obj: {
            _arrOf: 'string'
        },
    }
};

GmCXt.model.segmentGroup = {
    group_id: {
        _type: "string"
    },
    rules: {
        _type: "array",
        _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
    },
    segments: {
        _type: "array",
        _obj: GmCXt.createDeepCopy(GmCXt.model.segment)
    },
    title: {
        _type: "string"
    },
    rule_check: {
        _type: "bool",
        _default: false
    }
};

GmCXt.model.segmentGroups = {
    _type: "array",
    _obj: GmCXt.createDeepCopy(GmCXt.model.segmentGroup)
};

GmCXt.validate = function(data, prop, validation) {

    let input = data[prop];
    let val = 'a(1f2'; // added val as random string

    switch (validation._type) {
    case "array":
        input = GmCXt.validateModelArray(input, validation._obj);
        if (input) val = input;
        break;

    case "object":
        input = GmCXt.validateObject(input, validation);
        if (input) val = input;
        break;

    case "bool":
        if (typeof input === 'boolean') val = input;
        else {
            let i = parseInt(input);
            if (i === 1 || input === 'true') val = true;
            else val = false;
        }
        break;

    case "number":
        if (!input) val = 0;
        else if (!isNaN(input)) val = input;
        else if (isNaN(input)) val = 1; //For any value, convert it to number, default 1
        break;

    case "string":
        if (typeof input === 'string' && GmCXt.isEmpty(input) && GmCXt.isDefined(validation._default)) val = validation._default;
        else if (typeof input === 'string') val = input;
        else if (!input) val = "";
        else if (validation._default) val = validation._default;
        else if (!isNaN(input)) val = String(input);
        break;

    case "number_or_null":
        if (!isNaN(input)) val = input;
        else val = null;
        break;
    }

    return val;
};

GmCXt.getDefault = function(type, _default) {

    let def = {
        "array": [],
        //"object": {}, 
        //Do not initialise object. Because simply checking if(obj) is true. 
        //It has to be if(GmCXt.isEmpty(obj)). In code, at all places this change 
        //must be done, before initiating to default object.
        "bool": false,
        "number": 0,
        "string": ""
    };

    if (type) return (typeof _default !== "undefined") ? _default : def[type];
    else return null;
};

GmCXt.validateObject = function(data, validation) {
    data = GmCXt.parseJSON__(data);

    if (typeof data !== 'object') return false;

    if (validation._obj)
        return GmCXt.validateDataModel(data, validation._obj);
    else
        return true;
};

GmCXt.validateModelArray = function(data, model) {
    data = GmCXt.parseJSON__(data);

    if (!Array.isArray(data)) return false;

    for (let i = 0, j = data.length; i < j; i++) {
        let valid = true;
        if (model) {

            if (model._arrOf === 'string') {
                valid = data[i];
            } else {
                if (typeof data[i] === 'string') {
                    data[i] = GmCXt.parseJSON__(data[i]);
                }
                valid = GmCXt.validateDataModel(data[i], model);
            }
        }

        if (!valid) return false;
        else data[i] = valid;
    }

    return data;
};

GmCXt.cloneObject = function(model) {
    let obj = {};

    if (!GmCXt.isEmpty(model)) {
        for (let prop in model) {
            if (model.hasOwnProperty(prop)) {
                obj[prop] = GmCXt.getDefault(model[prop]._type, model[prop]._default);
            }
        }
    }

    return obj;
};

GmCXt.validateLanguageData = function(data, model) {
    data = GmCXt.parseJSON__(data);
    for (let prop in data) {
        data[prop] = GmCXt.validateDataModel(data[prop], model._obj);
    }
    return data;
};

GmCXt.validateDataModel = function(data, model) {

    let isValid = true;

    if (!GmCXt.isEmpty(data)) {
        for (let prop in model) {

            if (model.hasOwnProperty(prop)) {

                if ((model[prop]._type === 'object' || model[prop]._type === 'array') && typeof data[prop] === 'string') {
                    data[prop] = GmCXt.parseJSON__(data[prop]);
                    if (data[prop] === null) {
                        if (model[prop]._type === 'array') {
                            data[prop] = [];
                        } else {
                            data[prop] = {};
                        }
                    }
                }

                if (prop === 'widget_icon_zindex' && !GmCXt.isEmpty(data[prop]) && typeof data[prop] !== 'string') {
                    data[prop] = data[prop].toString();
                }

                if (prop === 'stepTitleFontWeight' && GmCXt.isEmpty(data[prop]) && !GmCXt.isEmpty(model[prop])) {
                    if (model[prop]._type !== 'object') {
                        data[prop] = GmCXt.getDefault(model[prop]._type, model[prop]._default);
                    }
                }

                if (prop === 'language_data') {
                    data[prop] = GmCXt.validateLanguageData(data[prop], model[prop]);
                } else if (typeof data[prop] === 'undefined' ||
					(typeof data[prop] !== 'boolean' && !data[prop] && model[prop]._inherit === true) ||
					(typeof data[prop] !== 'object' && model[prop]._type == 'object' && !GmCXt.isEmpty(data[prop])) ||
					(data[prop] && typeof data[prop] === 'object' && !Object.keys(data[prop]).length && model[prop]._clone)) {

                    if (model[prop]._inherit === true) {
                        if (model === GmCXt.model.application.settings._obj) {
                            data[prop] = GmCXt.organization.settings[prop];

                        } else if (model === GmCXt.model.application.settings._obj.popupDesign._obj) {
                            data[prop] = GmCXt.organization.settings.popupDesign[prop];

                        } else if (model === GmCXt.model.application.settings._obj.widget_icon_pos._obj) {
                            data[prop] = GmCXt.organization.settings.widget_icon_pos[prop];

                        } else if (model === GmCXt.model.application.settings._obj.selectorStyle._obj) {
                            data[prop] = GmCXt.organization.settings.selectorStyle[prop];

                        } else if (model === GmCXt.model.application.settings._obj.widgetIconSize._obj) {
                            data[prop] = GmCXt.organization.settings.widgetIconSize[prop];

                        } else if (model === GmCXt.model.application.settings._obj.notifications._obj) {
                            data[prop] = GmCXt.organization.settings.notifications[prop];

                        } else if (model === GmCXt.model.application.settings._obj.userLabels._obj) {
                            data[prop] = GmCXt.organization.settings.userLabels[prop];
                        }
						
                    } else if (model[prop]._type !== 'object') {
                        data[prop] = GmCXt.getDefault(model[prop]._type, model[prop]._default);
					
                    } else if (model[prop]._type == 'object' && model[prop]._clone) {
                        data[prop] = GmCXt.cloneObject(model[prop]._obj);
                        GmCXt.validateDataModel(data[prop], model[prop]._obj);
                    }

                } else if ((data[prop] === null || data[prop] === 'na' || data[prop] === '') && model[prop]._type === 'object') {
                    data[prop] = {};

                } else if ((data[prop] === null || data[prop] === 'na' || data[prop] === '' || data[prop] === 0) && model[prop]._type === 'array') {
                    data[prop] = [];
                } else {

                    let valid = GmCXt.validate(data, prop, model[prop]);

                    if (valid === 'a(1f2') {

                        if (model[prop]._type == 'object' && model[prop]._clone) {
                            data[prop] = GmCXt.cloneObject(model[prop]._obj);
                            GmCXt.validateDataModel(data[prop], model[prop]._obj);
                        } else {
                            GmCXt.log(15, "Validation failed for prop: " + prop + "; invalid value: ", data[prop]);
                            isValid = false;
                        }

                    } else {
                        data[prop] = valid;
                    }
                }

            }
        }
    }

    if (isValid) return data;
    else return false;

};

GmCXt.validateApiResp = function(cb, apiName, data, model, pin_tours) {

    if (Array.isArray(data))
        var valid = GmCXt.validateModelArray(data, model._obj);
    else
        var valid = GmCXt.validateDataModel(data, model);

    if (valid) {
        if (cb && pin_tours) cb(valid, pin_tours);
        else if (cb) cb(valid);
    } else {
        GmCXt.handleError(apiName);
    }
};
GmCXt.model.popupDesign_default = {
    bgColor: {
        _type: "string",
        _default: '#ffffff',
        _inherit: true
    },
    stepCountColor: {
        _type: "string",
        _default: "#505050",
        _inherit: true
    },
    borderColor: {
        _type: "string",
        _default: "#dfe0e7",
        _inherit: true
    },
    borderWidth: {
        _type: "number",
        _default: 1,
        _inherit: true
    },
    borderRadius: {
        _type: "number",
        _default: 3,
        _inherit: true
    },
    nextBtnBackground: {
        _type: "string",
        _default: "#005BF0",
        _inherit: true
    },
    nextBtnColor: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    prevBtnBackground: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    prevBtnColor: {
        _type: "string",
        _default: "#8e8fa6",
        _inherit: true
    },
    stepTitleColor: {
        _type: "string",
        _default: "#26273b",
        _inherit: true
    },
    stepDescColor: {
        _type: "string",
        _default: "#8e8fa6",
        _inherit: true
    },
    audioIconColor: {
        _type: "string",
        _default: "#acadc1",
        _inherit: true
    },
    closeIconColor: {
        _type: "string",
        _default: "#acadc1",
        _inherit: true
    },
    stepDesFontSize: {
        _type: "string",
        _default: "medium",
        _inherit: true
    },
    stepDesFontFamily: {
        _type: "string",
        _default: "arial, sans-serif",
        _inherit: true
    },
    stepTitleFontSize: {
        _type: "string",
        _default: "medium",
        _inherit: true
    },
    stepTitleFontFamily: {
        _type: "string",
        _default: "arial, sans-serif",
        _inherit: true
    },
    stepTitleFontWeight: {
        _type: "string",
        _default: "600",
        _inherit: true
    },
    padding: {
	    _type: "object",
	    _clone: true,
	    _obj: {
	        bottom: {
	            _type: "number",
	            _default: 0
	        },
	        left: {
	            _type: "number",
	            _default: 0
	        },
	        right: {
	            _type: "number",
	            _default: 0
	        },
	        top: {
	            _type: "number",
	            _default: 0
	        }
	    }
    }
};

GmCXt.model.userLabels = {
    guideMe: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    showMe: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    testMe: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    doItForMe: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    miniPlayerHelp: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    next: {
        _type: "string",
        _default: "",
        _inherit: true
    },
    btnPrev: {
        _type: "string",
        _default: "",
        _inherit: true
    }
};

GmCXt.model.defaultColorArray = {
    0: {
        _type: 'string',
        _default: '#FBEEB8'
    },
    1: {
        _type: 'string',
        _default: '#F8CAC6'
    },
    2: {
        _type: 'string',
        _default: '#ECCAFA'
    },
    3: {
        _type: 'string',
        _default: '#C2E0F4'
    },
    4: {
        _type: 'string',
        _default: '#2DC26B'
    },
    5: {
        _type: 'string',
        _default: '#F1C40F'
    },
    6: {
        _type: 'string',
        _default: '#E03E2D'
    },
    7: {
        _type: 'string',
        _default: '#B96AD9'
    },
    8: {
        _type: 'string',
        _default: '#3598DB'
    },
    9: {
        _type: 'string',
        _default: '#169179'
    }
};

GmCXt.model.popupDesign_classic = {
    bgColor: {
        _type: "string",
        _default: "#454560",
        _inherit: true
    },
    stepCountColor: {
        _type: "string",
        _default: "#505050",
        _inherit: true
    },
    borderColor: {
        _type: "string",
        _default: "#454560",
        _inherit: true
    },
    borderWidth: {
        _type: "number",
        _default: 1,
        _inherit: true
    },
    borderRadius: {
        _type: "number",
        _default: 0,
        _inherit: true
    },
    nextBtnBackground: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    nextBtnColor: {
        _type: "string",
        _default: "#26273b",
        _inherit: true
    },
    prevBtnBackground: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    prevBtnColor: {
        _type: "string",
        _default: "#26273b",
        _inherit: true
    },
    stepTitleColor: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    stepDescColor: {
        _type: "string",
        _default: "#ffffff",
        _inherit: true
    },
    audioIconColor: {
        _type: "string",
        _default: "#cfd0dd",
        _inherit: true
    },
    closeIconColor: {
        _type: "string",
        _default: "#cfd0dd",
        _inherit: true
    },
    stepDesFontSize: {
        _type: "string",
        _default: "medium",
        _inherit: true
    },
    stepDesFontFamily: {
        _type: "string",
        _default: "arial, sans-serif",
        _inherit: true
    },
    stepTitleFontSize: {
        _type: "string",
        _default: "medium",
        _inherit: true
    },
    stepTitleFontFamily: {
        _type: "string",
        _default: "arial, sans-serif",
        _inherit: true
    },
    stepTitleFontWeight: {
        _type: "string",
        _default: "600",
        _inherit: true
    },
    padding: {
	    _type: "object",
	    _clone: true,
	    _obj: {
	        bottom: {
	            _type: "number",
	            _default: 0
	        },
	        left: {
	            _type: "number",
	            _default: 0
	        },
	        right: {
	            _type: "number",
	            _default: 0
	        },
	        top: {
	            _type: "number",
	            _default: 0
	        }
	    }
    }
};

GmCXt.model.tutorial_guide_default = {
    nextBtn: {
        _type: "object",
        _clone: true,
        _obj: {
            bgColor: {
                _type: "string",
                _default: "#005BF0"
            },
            border_color: {
                _type: "string",
                _default: "#005BF0"
            },
            border_radius: {
                _type: "number",
                _default: 4
            },
            border_width: {
                _type: "number",
                _default: 1
            },
            color: {
                _type: "string",
                _default: "#ffffff"
            },
            font_size: {
                _type: "string",
                _default: "medium"
            },
            padding: {
                _type: "object",
                _clone: true,
                _obj: {
                    bottom: {
                        _type: "number",
                        _default: 5
                    },
                    left: {
                        _type: "number",
                        _default: 5
                    },
                    right: {
                        _type: "number",
                        _default: 5
                    },
                    top: {
                        _type: "number",
                        _default: 5
                    }
                }
            }
        }
    },
    outerBox: {
        _type: "object",
        _clone: true,
        _obj: {
            border_color: {
                _type: "string",
                _default: "#454560"
            },
            border_radius: {
                _type: "number",
                _default: 0
            },
            border_width: {
                _type: "number",
                _default: 1
            },
            shadow: {
                _type: "object",
                _clone: true,
                _obj: {
                    blur: {
                        _type: "number",
                        _default: 5				
                    },
                    color: {
                        _type: "string",
                        _default: "#00000080"				
                    },
                    horizontal: {
                        _type: "number",
                        _default: 2				
                    },
                    inset: {
                        _type: "bool",
                        _default: false				
                    },
                    spreadRadius: {
                        _type: "number",
                        _default: 0				
                    },
                    vertical: {
                        _type: "number",
                        _default: 2				
                    }
                }
            }
        }
    },
    prevBtn: {
        _type: "object",
        _clone: true,
        _obj: {
            bgColor: {
                _type: "string",
                _default: "#005BF0"			
            },
            border_color: {
                _type: "string",
                _default: "#005BF0"			
            },
            border_radius: {
                _type: "number",
                _default: 4			
            },
            border_width: {
                _type: "number",
                _default: 1		
            },
            color: {
                _type: "string",
                _default: "#ffffff"			
            },
            font_size: {
                _type: "string",
                _default: "medium"				
            },
            padding: {
                _type: "object",
                _clone: true,
                _obj: {
                    bottom: {
                        _type: "number",
                        _default: 5
                    },
                    left: {
                        _type: "number",
                        _default: 5
                    },
                    right: {
                        _type: "number",
                        _default: 5
                    },
                    top: {
                        _type: "number",
                        _default: 5				
                    }
                }
            }
        }
    },
    titleBgColor: {
        _type: "string",
        _default: "#26273b"	
    }
};

GmCXt.model.notificationTheme_default = {
    width: {
        _type: "string",
        _default: "600"
    },
    height: {
        _type: "string",
        _default: "300"	
    },
    header: {
        _type: "object",
        _clone: true,
        _obj: {
            background: {
                _type: "string",
                _default: "#FF240A"			
            },
            color: {
                _type: "string",
                _default: "#FFFFFF"			
            },
            font: {
                _type: "string",
                _default: "Lato"			
            }
        }
    },
    body: {
        _type: "object",
        _clone: true,
        _obj: {
            action_button_background: {
                _type: "string",
                _default: "#005BF0"
            },
            action_button_border_color: {
                _type: "string",
                _default: "#FFFFFF"
            },
            action_button_font: {
                _type: "string",
                _default: "Lato"
            },
            action_button_text_color: {
                _type: "string",
                _default: "#FFFFFF"
            },
            action_button_url: {
                _type: "string",
                _default: ""
            },
            background_color: {
                _type: "string",
                _default: "#FFFFFF"
            },
            desc_color: {
                _type: "string",
                _default: "#555555"
            },
            desc_font_family: {
                _type: "string",
                _default: "Lato"
            },
            desc_font_size: {
                _type: "string",
                _default: "medium"
            },
            fill: {
                _type: "string",
                _default: "#707070"
            },
            padding_bottom: {
                _type: "string",
                _default: "20"
            },
            padding_left: {
                _type: "string",
                _default: "20"
            },
            padding_right: {
                _type: "string",
                _default: "20"
            },
            padding_top: {
                _type: "string",
                _default: "20"
            },
            title_color: {
                _type: "string",
                _default: "#000000"
            },
            title_font_family: {
                _type: "string",
                _default: "Lato"
            },
            title_font_size: {
                _type: "string",
                _default: "medium"
            }
        }
    },
    footer: {
        _type: "object",
        _clone: true,
        _obj: {
            primaryBtnTextColor: {
                _type: "string",
                _default: "#FFFFFF"
            },
            primaryBtnTextSize: {
                _type: "string",
                _default: "medium"
            },
            primaryBtnFont: {
                _type: "string",
                _default: "#Lato"
            },
            primaryBtnBackground : {
                _type: "string",
                _default: "#005BF0"
            },
            primaryBtnBorderColor: {
                _type: "string",
                _default: "#005BF0"
            },
            secondaryBtnTextColor: {
                _type: "string",
                _default: "#555555"
            },
            secondaryBtnTextSize: {
                _type: "string",
                _default: "#medium"
            },
            secondaryBtnFont: {
                _type: "string",
                _default: "#Lato"
            },
            secondaryBtnBackground : {
                _type: "string",
                _default: "#E6E6E6"
            },
            secondaryBtnBorderColor: {
                _type: "string",
                _default: "#555555"
            }
        }
    }
};

GmCXt.model.playerThemeDefault = {
    font: {
        _type: "string",
        _default: "Arial, sans-serif"
    },
    header: {
        _type: "object",
        _clone: true,
        _obj: {
            text_color: {
                _type: "string",
                _default: "#555555"			
            },
            icon_color: {
                _type: "string",
                _default: "#555555"			
            },
            color: {
                _type: "string",
                _default: "#FFFFFF"			
            }
        }
    },
    body: {
        _type: "object",
        _clone: true,
        _obj: {
            background: {
                _type: "string",
                _default: "#FFFFFF"
            },
            icon_color: {
                _type: "string",
                _default: "#005BF0"
            },
            text_color: {
                _type: "string",
                _default: "#000000"
            },
            title_font_size: {
                _type: "string",
                _default: "small"
            },
            desc_font_size: {
                _type: "string",
                _default: "small"
            }
        }
    }
};

GmCXt.model.organization = {
    about: {
        _type: "string",
        _default: "About"
    },
    admin_settings: {
        _type: "object",
        _clone: true,
        _obj: {
            language_settings: {
                _type: "object",
                _clone: true,
                _obj: {
                    default: {
                        _type: "object",
                        _obj: GmCXt.createDeepCopy(GmCXt.model.langOption)
                    },
                    translations: {
                        _type: "array",
                        _obj: GmCXt.createDeepCopy(GmCXt.model.langOption)
                    }
                }
            },
            insights: {
                _type: "object",
                _required: true,
                _clone: true,
                _obj: {
                    enabled: {
                        _type: "bool",
                        _default: false
                    },
                    guide: {
                        _type: "bool",
                        _default: false
                    }
                }
            },
            doitforme: {
                _type: "bool",
                _default: false
            },
            chatbot: {
                _type: "bool",
                _default: false
            },
            lms: {
                _type: "bool",
                _default: false
            },
            display_accept_cookie_popup: {
                _type: "bool",
                _default: true
            },
            api_player: {
                _type: "bool",
                _default: true
            },
            app_switcher: {
                _type: "bool",
                _default: false
            },
            cdn_player: {
                _type: "bool",
                _default: false
            },
            current_page: {
                _type: "bool"
            },
            current_page_beacon: {
                _type: "bool",
                _default: false
            },
            myteacher: {
                _type: "bool",
                _default: false
            },
            guide_segmentation: {
                _type: "bool",
                _default: false
            },
            guide_translation: {
                _type: "bool",
                _default: false
            },
            isPITrackingEnabled: {
                _type: "bool",
                _default: false
            },
            mediafile_creation: {
                _type: "bool",
                _default: true
            },
            create_tooltip_media_file: {
                _type: "bool",
                _default: false
            },
            maintenance_mode: {
                _type: "bool",
                _default: false
            },
            myBotEnabled: {
                _type: "bool",
                _default: false
            },
            task_list: {
                _type: "bool",
                _default: false
            },
            efficient_rule_mode: {
                _type: "bool",
                _default: false
            },
            enable_guideme_as_secondary_option: {
                _type: "bool",
                _default: false
            },
            show_tooltips_during_workflow_guide: {
                _type: "bool",
                _default: false
            },
            html_inspector: {
                _type: "bool",
                _default: false
            },
            keyboard_shortcuts: {
                _type: "bool",
                _default: false
            }
        }
    },
    bucket: {
        _type: "string"
    },
    creation_date: {
        _type: "number"
    },
    domains: {
        _type: "string"
    },
    image_id: {
        _type: "number"
    },
    image_path: {
        _type: "string"
    },
    image_url: {
        _type: "string"
    },
    is_active: {
        _type: "bool"
    },
    is_suspend: {
        _type: "bool"
    },
    is_sync_complete: {
        _type: "bool"
    },
    is_verified: {
        _type: "bool"
    },
    modification_date: {
        _type: "number"
    },
    name: {
        _type: "string"
    },
    organization_id: {
        _type: "number"
    },
    orgkey: {
        _type: "string"
    },
    role: {
        _type: "string"
    },
    settings: {
        _type: "object",
        _clone: true,
        _obj: {
            popupDesign: {
                _type: "object",
                _clone: true,
                _obj: {
                    type: {
                        _type: "string",
                        _default: 'default'
                    },
                    default: {
                        _type: "object",
                        _clone: true,
                        _obj: GmCXt.createDeepCopy(GmCXt.model.popupDesign_default)
                    },
                    classic: {
                        _type: "object",
                        _clone: true,
                        _obj: GmCXt.createDeepCopy(GmCXt.model.popupDesign_classic)
                    },
                    current: {
                        _type: "object",
                        _clone: true,
                        _obj: GmCXt.createDeepCopy(GmCXt.model.popupDesign_default)
                    }
                }
            },
            tutorialBgColor: {
                _type: "string",
                _default: "#45465F"
            },
            feedback_type: {
                _type: "string",
                _default: "email"
            },
            feedback_email: {
                _type: "string",
                _default: "support@csod.com"
            },
            feedback_url: {
                _type: "string",
                _default: ""
            },
            showWidgetIcon: {
                _type: "bool",
                _clone: true,
                _default: true
            },
            rules: {
                _type: "array",
                _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
            },
            widgetIconPos: {
                _type: "string",
                _default: 'bottom-right'
            },
            showWidgetIconRight: {
                _type: "bool",
                _default: true
            },
            showWidgetIconBottom: {
                _type: "bool",
                _default: true
            },
            widget_icon_pos: {
                _type: "object",
                _clone: true,
                _obj: {
                    widget_icon_top_pos: {
                        _type: "number",
                        _default: 5
                    },
                    widget_icon_bottom_pos: {
                        _type: "number",
                        _default: 150
                    },
                    widget_icon_left_pos: {
                        _type: "number",
                        _default: 5
                    },
                    widget_icon_right_pos: {
                        _type: "number",
                        _default: 5
                    },
                    widget_icon_id: {
                        _type: "number"
                    },
                    widget_icon_top_pos_unit: {
                        _type: "string",
                        _default: "px"
                    },
                    widget_icon_bottom_pos_unit: {
                        _type: "string",
                        _default: "px"
                    },
                    widget_icon_left_pos_unit: {
                        _type: "string",
                        _default: "px"
                    },
                    widget_icon_right_pos_unit: {
                        _type: "string",
                        _default: "px"
                    }
                }
            },
            widget_icon_path: {
                _type: "string",
                _default: GmCXt.conf.staticContentPath + "myguide.png"
            },
            hide_widget_if_noguide: {
                _type: "bool",
                _default: false
            },
            widget_icon_zindex: {
                _type: "string",
                _default: "Default"
            },
            notificationDelay: {
                _type: "number",
                _default: 0
            },
            guide_count_on_widget: {
                _type: "bool",
                _default: true
            },
            keep_player_panel_open: {
                _type: "bool",
                _default: false
            },
            defaultGuideView: {
                _type: "bool",
                _default: false
            },
            enable_send_feedback: {
                _type: "bool",
                _default: true
            },
            guide_count_widget_color: {
                _type: "string",
                _default: '#FF0000'
            },
            notificationsTime: {
                _type: "string",
                _default: "24 hours"
            },
            playAudio: {
                _type: "bool",
                _default: true
            },
            hideBrandLogo: {
                _type: "bool",
                _default: false
            },
            hideBrandLogo: {
                _type: "bool",
                _default: false
            },
            first_slide_text: {
                _type: "string",
                _default: 'Welcome'
            },
            last_slide_text: {
                _type: "string",
                _default: 'Thank you'
            },
            userLabels: {
                _type: "object",
                _obj: GmCXt.createDeepCopy(mg$.extend(GmCXt.model.userLabels, {
                    userNotFollowingGuideMessage: {
                        _type: "string",
                        _default: ""
                    },
                    maintenanceMessage: {
                        _type: "string",
                        _default: ""
                    },
                    serviceErrorMessage: {
                        _type: "string",
                        _default: ""
                    },
                    resumeGuideMessage: {
                        _type: "string",
                        _default: ""
                    }
                })),
                _clone: true
            },
            selectorStyle: {
                _type: "object",
                _clone: true,
                _obj: {
                    borderColor: {
                        _type: "string",
                        _default: '#00a6d9'
                    },
                    borderWidth: {
                        _type: "number",
                        _default: 2
                    }
                }
            },
            tooltipColor: {
                _type: "string",
                _default: "#005BF0"
            },
            stepPopupWidth: {
                _type: "number",
                _default: 300
            },
            logo_id: {
                _type: "number"
            },
            logo: {
                _type: "string"
            },
            guideMeSetting: {
                _type: "bool",
                _default: true
            },
            showMeSetting: {
                _type: "bool",
                _default: true
            },
            testMeSetting: {
                _type: "bool",
                _default: true
            },
            doitforme: {
                _type: "bool",
                _default: false
            },
            giphy: {
                _type: "bool",
                _default: true
            },
            video: {
                _type: "bool",
                _default: true
            },
            slideshow: {
                _type: "bool",
                _default: true
            },
            dual_auth: {
                _type: "bool"
            },
            first_slide: {
                _type: "string",
                _default: GmCXt.conf.staticContentPath + "default_first_slide.png"
            },
            last_slide: {
                _type: "string",
                _default: GmCXt.conf.staticContentPath + "default_last_slide.png"
            },
            fqdn: {
                _type: "bool",
                _default: false
            },
            notifications: {
                _type: "object",
                _clone: true,
                _obj: {
                    content: {
                        _type: "string"
                    },
                    enable: {
                        _type: "bool",
                        _default: false
                    },
                    enforce: {
                        _type: "bool",
                        _default: false
                    },
                    rules: {
                        _type: "array",
                        _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
                    },
                    notifThemeColor: {
                        _type: "string",
                        _default: "#26273b"
                    }
                }
            },
            exitSurvey: {
                _type: "bool",
                _default: false
            },
            survey: {
                _type: "array",
                _obj: []
            },
            defaultPlayAction: {
                _type: "string",
                _default: "guideMe"
            },
            isMiniPlayer: {
                _type: "bool",
                _default: false
            },
            add_watermark: {
                _type: "bool",
                _default: true
            },
            stepDefaultColorArray: {
                _type: "object",
                _obj: GmCXt.createDeepCopy(GmCXt.model.defaultColorArray),
                _clone: true
            },
            sentiment: {
                _type: "object",
                _clone: true,
                _obj: {
                    sentimentCode: {
                        _type: "string"
                    }
                }
            },
            tooltipTheme: {
                _type: "bool",
                _default: false
            },
            widgetIconType: {
                _type: "string",
                _default: 'circular'
            },
            widgetIconSize: {
                _type: "object",
                _clone: true,
                _obj: {
                    widgetIconWidth: {
                        _type: "number",
                        _default: 50
                    },
                    widgetIconHeight: {
                        _type: "number",
                        _default: 50
                    }
                }
            },
            all_guide: {
                _type: "bool",
                _default: false
            },
            tutorial_guide: {
                _type: "object",
                _clone: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.tutorial_guide_default)
            },
            helpUrl: {
                _type: "string",
                _default: "https://help.csod.com/MyGuide/"
            },
            autoProceedStep: {
                _type: "bool",
                _default: false
            },
            autoStepDelay: {
                _type: "number",
                default: 4
            },
            notificationTheme: {
                _type: "object",
                _clone: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.notificationTheme_default)
            },
            tooltip_img: {
                _type: "string",
                _clone: true,
                _default: "gstart_tour2_old.png"
            },
            playerTheme: {
                _type: "object",
                _clone: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.playerThemeDefault)
            },
            privacyPolicy: {
                _type: "string",
                _clone: true,
                _default: GmCXt.conf.privacyPolicyUrl
            }
        }
    },
    segment_groups: GmCXt.model.segmentGroups
};
/*global GmCXt*/
GmCXt.model.stepSettings = {
    screenBlackout: {
        _type: "bool",
        _default: true
    },
    displayPreview: {
        _type: "bool",
        _default: true
    },
    mandatoryStep: {
        _type: "bool",
        _default: false
    },
    optional: {
        _type: "bool",
        _default: false
    },
    removeElement: {
        _type: "bool",
        _default: false
    },
    headerNext: {
        _type: "bool",
        _default: false
    },
    onCopyNext: {
        _type: "bool",
        _default: false
    },
    keepNext: {
        _type: "bool",
        _default: false
    },
    hoverNext: {
        _type: "bool",
        _default: false
    },
    clickNext: {
        _type: "bool",
        _default: false
    },
    onRightClickNext: {
        _type: "bool",
        _default: false
    },
    onKeyupNext: {
        _type: "bool",
        _default: false
    },
    onEnterPressNext: {
        _type: "bool",
        _default: false
    },
    onChangeNext: {
        _type: "bool",
        _default: false
    },
    closeAfterDelay: {
        _type: "bool",
        _default: false
    },
    onClickAnywhere: {
        _type: "bool",
        _default: false
    },
    inlineBranch: {
        _type: "bool",
        _default: false
    },
    customAudioText: {
        _type: "bool",
        _default: false
    },
    recordedAudio: {
        _type: "bool",
        _default: false
    },
    triggerEvent: {
        _type: "bool",
        _default: false
    },
    overlayOpacity: {
        _type: "number",
        _default: 0
    },
    smartTip: {
        _type: "object",
        _obj: {},
        _clone: true
    },
    completionTime: {
        _type: "number",
        _default: 4
    },
    completionEvent: {
        _type: "string"
    },
    stepPopupWidth: {
        _type: "number",
        _default: 300
    },
    stepPopupHeight: {
        _type: "number",
        _default: 0
    },
    stepDelayTime: {
        _type: "number",
        _default: 0
    },
    pageReloadOption: {
        _type: "string",
        _default: 'neither'
    },
    autoPlayStep: {
        _type: "bool",
        _default: false
    },
    stickTargetElement: {
        _type: "bool",
        _default: false
    },
    element: {
        _type: "object",
        _required: false,
        _obj: {
            //version: { _type: "string" },
            //selector: {
            // js, js1, js2, js3 are either array or null
            // hence require no validation
            //},
            meta: {
                _type: "object",
                _required: false,
                _obj: {
                    elAttributes: {
                        _type: "object",
                        _obj: {}
                    },
                    inTopWindow: {
                        _type: "bool"
                    },
                    iframeUrl: {
                        _type: "string"
                    },
                    iframePath: {
                        _type: "string"
                    },
                    iframeScheme: {
                        _type: "string",
                        _val: ["http", "https"]
                    },
                    jqueryInfo: {
                        _type: "object",
                        _obj: {}
                    },
                    path: {
                        _type: "object",
                        _required: false,
                        _obj: {
                            fromDocument: {
                                _type: "array"
                            },
                            fromParent: {
                                _type: "array"
                            },
                            parentId: {
                                _type: "string"
                            }
                        }
                    },
                    score: {
                        _type: "number"
                    },
                    selectorAttributes: {
                        _type: "object",
                        _obj: {}
                    },
                    textPropertyValue: {
                        _type: "string"
                    },
                    textPropertyName: {
                        _type: "string"
                    },
                    isUniqueText: {
                        _type: "bool"
                    }
                }
            },
            criteria: {
                _type: "object",
                _required: false,
                _obj: {
                    precision_type: {
                        _type: "string"
                    },
                    enforce_identify_by_text: {
                        _type: "bool"
                    },
                    ignoreText: {
                        _type: "bool"
                    },
                    jquery_selector: {
                        _type: "string"
                    },
                    precision_level: {
                        _type: "string"
                    }
                }
            },
            position: {
                _type: "object",
                _required: false,
                _obj: {
                    left: {
                        _type: "number"
                    },
                    top: {
                        _type: "number"
                    },
                    width: {
                        _type: "number"
                    },
                    height: {
                        _type: "number"
                    },
                    windowWidth: {
                        _type: "number"
                    },
                    windowHeight: {
                        _type: "number"
                    }
                }
            },
            cssPosition: {
                _type: "bool"
            },
            appName: {
                _type: "string"
            },
            xpath: {
                _type: "string"
            },
            elOptions: {
                _type: "array",
                _obj: {}
            }
        }
    },
    alignment: {
        _type: "string"
    },
    onPageClickNext: {
        _type: "bool",
        _default: false
    },
    onPageRefresh: {
        _type: "bool"
    },
    rules: {
        _type: "array",
        _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
    },
    area_of_interest: {
        _type: "object",
        _clone: true,
        _obj: {
            left: {
                _type: "number"
            },
            top: {
                _type: "number"
            },
            width: {
                _type: "number"
            },
            height: {
                _type: "number"
            }
        }
    },
    automation: {
        _type: "object",
        _clone: true,
        _obj: {
            enableDefaultData: {
                _type: "bool",
                _default: false
            },
            enableAutomationWindow: {
                _type: "bool",
                _default: false
            },
            hasHumanInteraction: {
                _type: "bool",
                _default: false
            },
            xpath: {
                _type: "string"
            },
            muteNarration: {
                _type: "bool",
                _default: false
            },
            afterXSeconds: {
                _type: "number",
                _default: 4
            },
            manualAutoTimer: {
                _type: "bool",
                _default: false
            },
            enableBot: {
                _type: "bool",
                _default: false
            },
            botQuestion: {
                _type: "string",
                _default: ""
            }
        }
    },
    scheme: {
        _type: "string",
        _val: ["http", "https"]
    },
    showPreviousStep: {
        _type: "bool",
        _default: false
    },
    hidePreviousStep: {
        _type: "bool",
        _default: false
    },
    tutorialHeight: {
        _type: "number",
        _default: 80
    },
    tutorialWidth: {
        _type: "number",
        _default: 40
    },
    tutorialUploadMode: {
        _type: "string",
        _default: 'new_tab'
    },
    tutorialUploadUrl: {
        _type: "string"
    },
    transportStepMode: {
        _type: "string",
        _default: 'same_tab'
    },
    branch: {
        _type: "array",
        _required: false,
        _obj: {
            tail: {
                _type: "string"
            },
            branchName: {
                _type: "string"
            },
            isDefault: {
                _type: "bool"
            },
            rulesEngine: {
                _type: "array",
                _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
            }
        }
    },
    branch_type: {
        _type: "string",
        _required: false,
        _default: "Rule Based"
    },
    matchByText: {
        _type: "bool",
        _default: false
    },
    matchVertically: {
        _type: "bool",
        _default: false
    },
    matchHorizontally: {
        _type: "bool",
        _default: false
    },
    matchPositionSetting: {
        _type: "string",
        _default: "Both"
    },
    groupTitle: {
        _type: "string",
        _required: false
    },
    showFullScreen: {
        _type: "bool",
        _default: false
    },
    dynamicPositioning: {
        _type: "bool",
        _default: false
    },
    transport_url : {
        _type: "string",
        _required: true
    },
};

GmCXt.model.step = {
    application_id: {
        _type: "number",
        _required: true
    },
    creation_date: {
        _type: "number",
        _required: false
    },
    image_path: {
        _type: "string",
        _required: true
    },
    image_url: {
        _type: "string",
        _required: true
    },
    is_active: {
        _type: "bool",
        _required: true
    },
    is_image_processed: {
        _type: "bool",
        _required: true
    },
    is_screen_url_processed: {
        _type: "bool",
        _required: true
    },
    is_thumbnail_processed: {
        _type: "bool",
        _required: true
    },
    modification_date: {
        _type: "number",
        _required: false
    },
    organization_id: {
        _type: "number",
        _required: true
    },
    screen_path: {
        _type: "string",
        _required: true
    },
    screen_url: {
        _type: "string",
        _required: true
    },
    step_audio: {
        _type: "string",
        _required: true,
        _val: ".mp3"
    },
    step_audio_text: {
        _type: "string",
        _required: true,
        _default: " "
    },
    step_description: {
        _type: "string",
        _required: true
    },
    step_id: {
        _type: "string",
        _required: true
    },
    step_image: {
        _type: "number",
        _required: true,
        _default: 0
    },
    step_order: {
        _type: "number",
        _required: true
    },
    step_screen: {
        _type: "string",
        _required: true,
        _default: 0
    },
    step_settings: {
        _type: "object",
        _clone: true,
        _obj: GmCXt.createDeepCopy(GmCXt.model.stepSettings)
    },
    step_thumbnail: {
        _type: "number",
        _required: true
    },
    step_title: {
        _type: "string",
        _required: true
    },
    step_type: {
        _type: "string",
        _required: true
    },
    step_url: {
        _type: "string",
        _required: true
    },
    step_video: {
        _type: "number",
        _required: true
    },
    step_video_url: {
        _type: "string",
        _required: true
    },
    thumbnail_path: {
        _type: "string",
        _required: true
    },
    thumbnail_url: {
        _type: "string",
        _required: true
    },
    tour_id: {
        _type: "string",
        _required: true
    },
    video_path: {
        _type: "string",
        _required: true
    },
    language_data: {
        _type: "object",
        _required: false,
        _obj: {
            step_title: {
                _type: "string"
            },
            voice: {
                _type: "string"
            },
            name: {
                _type: "string"
            },
            step_description: {
                _type: "string"
            }
        }
    }
};

GmCXt.model.steps = {
    _type: "array",
    _obj: GmCXt.createDeepCopy(GmCXt.model.step)
};
/*global GmCXt*/
GmCXt.model.token = {
    token: {
        _type: "string"
    }
};

GmCXt.model.userToken = {
    refreshtoken: {
        _type: "string",
        _required: true
    },
    accesstoken: {
        _type: "string",
        _required: true
    },
    app_access: {
        _type: "array",
        _obj: {}
    }
};

GmCXt.model.user = {
    accesstoken: {
        _type: "string",
        _required: true
    },
    app_access: {
        _type: "array",
        _obj: {}
    },
    cdn_signature: {
        _type: "string",
        _required: true
    },
    cdn_signature_expiry: {
        _type: "number"
    },
    creation_date: {
        _type: "number"
    },
    first_name: {
        _type: "string",
        _required: true
    },
    image_id: {
        _type: "number"
    },
    image_url: {
        _type: "string",
        _required: true
    },
    is_paid: {
        _type: "bool"
    },
    is_suspend: {
        _type: "bool"
    },
    is_verified: {
        _type: "bool"
    },
    keep_login: {
        _type: "bool"
    },
    last_name: {
        _type: "string"
    },
    mandatory_pass_change: {
        _type: "bool"
    },
    modification_date: {
        _type: "number"
    },
    org_role_id: {
        _type: "number"
    },
    organization_id: {
        _type: "number",
        _required: true
    },
    profile: {
        _type: "string",
        _default: "{}"
    },
    refreshtoken: {
        _type: "string",
        _required: true
    },
    relation_id: {
        _type: "number"
    },
    role: {
        _type: "string"
    },
    settings: {
        _type: "object",
        _clone: true,
        _obj: {
            showToolbarTooltip: {
                _type: "bool",
                _default: true
            },
            showCaptureTagsInfo: {
                _type: "bool",
                _default: true
            },
            toolbarPosition: {
                _type: "string"
            },
            edcastTermsAccepted: {
                _type: "bool"
            },
            viewed_guide_notifications: {
                _type: "object",
                _obj: {},
            },
            surveyCompleted: {
                _type: "object",
                _obj: {},
            },
            guide_view: {
                _type: "object",
                _obj: {}
            },
        }
    },
    user_email: {
        _type: "string",
        _required: true
    },
    user_id: {
        _type: "number",
        _required: true
    },
    user_key: {
        _type: "string"
    }
};

GmCXt.model.users = {
    _type: "array",
    _obj: GmCXt.createDeepCopy(GmCXt.model.user)
};
/*global GmCXt*/
GmCXt.model.guide = {
    application_id: {
        _type: "number",
        _required: true
    },
    category_id: {
        _type: "number",
        _required: true
    },
    category_title: {
        _type: "string",
        _required: true
    },
    creation_date: {
        _type: "number",
        _required: true
    },
    creator_id: {
        _type: "number",
        _required: true
    },
    image_path: {
        _type: "string",
        _required: true
    },
    image_url: {
        _type: "string",
        _required: true
    },
    is_active: {
        _type: "bool",
        _required: true
    },
    is_locked: {
        _type: "bool",
        _required: true
    },
    is_private: {
        _type: "bool",
        _required: true
    },
    is_published: {
        _type: "bool",
        _required: true,
        _default: false
    },
    media_files: {
        _type: "array",
        _obj: {
            gify: {
                _type: "string"
            },
            pdf: {
                _type: "string"
            },
            ppt: {
                _type: "string"
            },
            video: {
                _type: "string"
            },
            blog: {
                _type: "string"
            },
            doc: {
                _type: "string"
            },
            text: {
                _type: "string"
            }
        }
    },
    modification_date: {
        _type: "number",
        _required: true
    },
    narrator : {
        _type: "string"
    },
    organization_id: {
        _type: "number",
        _required: true
    },
    step_count: {
        _type: "number",
        _required: true
    },
    steps: {
        _type: "array",
        _obj: GmCXt.createDeepCopy(GmCXt.model.step)
    },
    thumbnail_path: {
        _type: "string",
        _required: true
    },
    thumbnail_url: {
        _type: "string",
        _required: true
    },
    tour_description: {
        _type: "string",
        _required: true
    },
    tour_id: {
        _type: "number",
        _required: true
    },
    tour_image: {
        _type: "number",
        _required: true,
        _default: "0"
    },
    tour_order: {
        _type: "number",
        _required: true
    },
    tour_settings: {
        _type: "object",
        _clone: true,
        _obj: {
            ruleCheckOnClick: {
                _type: "bool",
                default: false
            },
            beacon: {
                _type: "object",
                _clone: true,
                _obj: {
                    beaconPreviewImagePath: {
                        _type: "string"
                    },
                    beaconIcon: {
                        _type: "string"
                    },
                    stickTargetElement: {
                        _type: "bool",
                        default: false
                    }
                }
            },
            process_ppt: {
                _type: "object",
                _clone: true,
                _obj: {
                    file_id: {
                        _type: "number"
                    },
                    url: {
                        _type: "string"
                    }
                }
            },
            slideshow_mode: {
                _type: "bool"
            },
            enableBot: {
                _type: "bool",
                default: false
            },
            isAutolaunch: {
                _type: "bool",
                default: false
            },
            videoNotification: {
                _type: "bool",
                default: false
            },
            oneTimeNotification: {
                _type: "bool",
                default: false
            },
            stepDelayTime: {
                _type: "number",
                _default: 0
            },
            ruleDelayTime: {
                _type: "number",
                _default: 0
            },
            defaultPlayAction: {
                _type: "string",
                _default: 'Default'
            },
            rules: {
                _type: "array",
                _obj: GmCXt.createDeepCopy(GmCXt.model.rule)
            },
            overlay_rules: {
                _type: "array",
                _obj: {}
            },
            enableKeyboardInput: {
                _type: "bool",
                default: false
            },
            keyboardKeyInput: {
                _type: "string",
                _default: ''
            },
            pushNotificationAlignment: {
                _type: "string",
                _default: 'center'
            },
            video_settings: {
                _type: "object",
                _required: "false",
                _clone: true,
                _obj: {
                    first_slide_text: {
                        _type: "string"
                    },
                    first_slide_recorded_audio: {
                        _type: "bool",
                        _default: false
                    },
                    first_slide_recorded_audio_url: {
                        _type: "string"
                    },
                    first_slide_id: {
                        _type: "number"
                    },
                    first_slide_img: {
                        _type: "string",
                        _default: GmCXt.conf.staticContentPath + "default_first_slide.png"
                    },
                    last_slide_text: {
                        _type: "string"
                    },
                    last_slide_recorded_audio: {
                        _type: "bool",
                        _default: false
                    },
                    last_slide_recorded_audio_url: {
                        _type: "string"
                    },
                    last_slide_id: {
                        _type: "number"
                    },
                    last_slide_img: {
                        _type: "string",
                        _default: GmCXt.conf.staticContentPath + "default_last_slide.png"
                    }
                }
            },
            show_title_slide: {
                _type: "bool",
                _default: true
            },
            show_slide: {
                _type: "bool",
                _default: true
            },
            show_video_subtitle: {
                _type: "bool",
                _default: true
            },
            add_video_animation: {
                _type: "string",
                _default: ''
            },
            translationEnable: {
                _type: "bool",
                _default: true
            },
            disableRedirect: {
                _type: "bool",
                _default: false
            },
            step_settings: {
                _type: "object",
                _required: false,
                _clone: true,
                _obj: {
                    hideStepIcon: {
                        _type: "bool",
                        _default: false
                    },
                    doNotShowPopup: {
                        _type: "bool",
                        _default: false
                    },
                    forceGuideMe: {
                        _type: "bool",
                        _default: false
                    }
                }
            },
            play_structure: {
                _type: "array",
                _obj: {
                    "id": {
                        _type: "number"
                    },
                    "tail": {
                        _type: "number_or_null"
                    }
                }
            },
            downloadGuideFiles: {
                _type: "object",
                _required: false,
                _clone: true,
                _obj: {
                    video_file: {
                        _type: "bool",
                        _default: true
                    },
                    pdf_file: {
                        _type: "bool",
                        _default: true
                    },
                    pptx_file: {
                        _type: "bool",
                        _default: true
                    },
                    gif_file: {
                        _type: "bool",
                        _default: true
                    },
                    text_file: {
                        _type: "bool",
                        _default: true
                    },
                    word_file: {
                        _type: "bool",
                        _default: true
                    },
                    blog_file: {
                        _type: "bool",
                        _default: true
                    }
                }
            },
            tour_type: {
                _type: "string",
                _default: 'default'
            },
            version: {
                _type: "string"
            },
            enableAudio: {
                _type: "bool",
                default: false
            },
            disableAudio: {
                _type: "bool",
                default: false
            },
            hidePrevBtn: {
                _type: "bool",
                default: false
            },
            guideHideForP: {
                _type: "bool",
                default: false
            },
            watchRulesElement: {
                _type: "bool",
                default: false
            },
            segments: {
                _type: "array",
                _obj: GmCXt.createDeepCopy(GmCXt.model.segment)
            },
            removeBeaconRulesInvalid: {
                _type: "bool",
                default: false
            },
            segment_groups: {
                _type: "array",
                _obj: {
                    _arrOf: 'string'
                }
            },
            tutorial_tour_type: {
                _type: "string",
                _default: 'tutorial'
            },
            sentiment: {
                _type: "object",
                _clone: true,
                _obj: {
                    sentimentCode: {
                        _type: "string"
                    }
                }
            },
            conversation: {
                _type: "object",
                _clone: true,
                _obj: {
                    conversationCode: {
                        _type: "string"
                    }
                }
            },
            is_tracking_enabled: {
                _type: "bool",
                _default: true
            }

            // publish_env: {
            // 	_type: "array",
            // 	_obj: {}
            // },
        }
    },
    tour_thumbnail: {
        _type: "number",
        _required: true
    },
    tour_title: {
        _type: "string",
        _required: true
    },
    tour_type: {
        _type: "string",
        _required: true
    },
    tour_url: {
        _type: "string",
        _required: true
    },
    user_email: {
        _type: "string",
        _required: true
    },
    user_first_name: {
        _type: "string",
        _required: true
    },
    user_id: {
        _type: "number",
        _required: true
    },
    user_last_name: {
        _type: "string",
        _required: true
    },
    keywords: {
        _type: "string",
        _required: true
    },
    language_data: {
        _type: "object",
        _obj: {
            tour_title: {
                _type: "string"
            },
            voice: {
                _type: "string"
            },
            name: {
                _type: "string"
            },
            tour_description: {
                _type: "string"
            }
        }
    },
    version: {
        _type: "number",
        _required: true
    }
};

GmCXt.model.guides = {
    _type: "array",
    _obj: GmCXt.createDeepCopy(GmCXt.model.guide)
};
/*global GmCXt*/
GmCXt.model.category = {
    application_id: {
        _type: "number",
        _required: true
    },
    category_description: {
        _type: "string",
        _required: true
    },
    category_id: {
        _type: "number",
        _required: true
    },
    category_image: {
        _type: "number",
        _required: true
    },
    category_order: {
        _type: "number",
        _required: true
    },
    category_title: {
        _type: "string",
        _required: true
    },
    creation_date: {
        _type: "number",
        _required: true
    },
    has_child: {
        _type: "bool",
        _required: true
    },
    has_tour: {
        _type: "bool",
        _required: true
    },
    image_path: {
        _type: "string",
        _required: true
    },
    image_url: {
        _type: "string",
        _required: true
    },
    is_active: {
        _type: "bool",
        _required: true
    },
    is_published: {
        _type: "bool",
        _required: true
    },
    modification_date: {
        _type: "number",
        _required: true
    },
    organization_id: {
        _type: "number",
        _required: true
    },
    parent_id: {
        _type: "number",
        _required: true
    },
    settings: {
        _type: "string",
        _required: true
    },
    total_publish_tour: {
        _type: "number",
        _required: true
    },
    total_sub_category: {
        _type: "number",
        _required: true
    },
    total_unpublish_tour: {
        _type: "number",
        _required: true
    },
    user_id: {
        _type: "number",
        _required: true
    },
    language_data: {
        _type: "object",
        _required: "false",
        _obj: {
            category_title: {
                _type: "string"
            },
            voice: {
                _type: "string"
            },
            name: {
                _type: "string"
            },
            category_description: {
                _type: "string"
            }
        }
    }
};

GmCXt.model.categories = {
    _type: "array",
    _obj: GmCXt.createDeepCopy(GmCXt.model.category)
};
/*global GmCXt,mg$*/
GmCXt.model.domain = {
    id: {
        _type: "string"
    },
    url: {
        _type: "string"
    },
    isDefault: {
        _type: "bool"
    },
    env: {
        _type: "string",
        _default: "prod"
    },
    appName: {
        _type: "string"
    }
};

GmCXt.model.application = {
    application_id: {
        _type: "number",
        _required: true
    },
    creation_date: {
        _type: "number",
        _required: true
    },
    description: {
        _type: "string",
        _required: true
    },
    image_id: {
        _type: "number",
        _required: true
    },
    image_path: {
        _type: "string",
        _required: true
    },
    image_url: {
        _type: "string",
        _required: true
    },
    is_active: {
        _type: "bool",
        _required: true
    },
    is_default: {
        _type: "bool",
        _required: true
    },
    modification_date: {
        _type: "number",
        _required: true
    },
    name: {
        _type: "string",
        _required: true
    },
    organization_id: {
        _type: "number",
        _required: true
    },
    app_url: {
        _type: "array",
        _required: true
    },
    categories: {
        _type: "array",
        _obj: mg$.extend({}, GmCXt.model.category)
    },
    settings: {
        _type: "object",
        _obj: {
            domains: {
                _type: "array",
                _obj: mg$.extend({}, GmCXt.model.domain)
            },
            first_slide_text: {
                _type: "string",
                _inherit: true
            },
            last_slide_text: {
                _type: "string",
                _inherit: true
            },
            copyright_text: {
                _type: "string",
                _inherit: true
            },
            first_slide: {
                _type: "string",
                _inherit: true
            },
            last_slide: {
                _type: "string",
                _inherit: true
            },
            widget_icon: {
                _type: "number",
                _inherit: true
            },
            fqdn: {
                _type: "bool",
                _inherit: true
            },
            popupDesign: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    type: {
                        _type: "string",
                        _inherit: true
                    },
                    default: {
                        _type: "object",
                        _clone: true,
                        _obj: mg$.extend({}, GmCXt.model.popupDesign_default)
                    },
                    classic: {
                        _type: "object",
                        _clone: true,
                        _obj: mg$.extend({}, GmCXt.model.popupDesign_classic)
                    },
                    current: {
                        _type: "object",
                        _clone: true,
                        _obj: mg$.extend({}, GmCXt.model.popupDesign_default)
                    }
                }
            },
            tutorialBgColor: {
                _type: "string",
                _inherit: true
            },
            showWidgetIcon: {
                _type: "bool",
                _clone: true,
                _inherit: true
            },
            rules: {
                _type: "array",
                _obj: mg$.extend({}, GmCXt.model.rule)
            },
            widgetIconPos: {
                _type: "string",
                _inherit: true
            },
            showWidgetIconRight: {
                _type: "bool",
                _inherit: true
            },
            keep_player_panel_open: {
                _type: "bool",
                _inherit: true
            },
            defaultGuideView: {
                _type: "bool",
                _inherit: true
            },
            enable_send_feedback: {
                _type: "bool",
                _inherit: true
            },
            showWidgetIconBottom: {
                _type: "bool",
                _inherit: true
            },
            feedback_type: {
                _type: "string",
                _inherit: true
            },
            feedback_email: {
                _type: "string",
                _inherit: true
            },
            feedback_url: {
                _type: "string",
                _inherit: true
            },
            enable_chatbot: {
                _type: "bool",
                _inherit: true
            },
            chatIconPos: {
                _type: "string",
                _inherit: true
            },
            chat_icon_pos: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    chat_icon_top_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    chat_icon_bottom_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    chat_icon_left_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    chat_icon_right_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    chat_icon_id: {
                        _type: "number"
                    },
                    chat_icon_top_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    chat_icon_bottom_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    chat_icon_left_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    chat_icon_right_pos_unit: {
                        _type: "string",
                        _inherit: true
                    }
                }
            },
            chat_icon_path: {
                _type: "string",
                _inherit: true
            },
            chatIconType: {
                _type: "string",
                _inherit: true
            },
            chatIconSize: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    chatIconWidth: {
                        _type: "number",
                        _inherit: true
                    },
                    chatIconHeight: {
                        _type: "number",
                        _inherit: true
                    }
                }
            },
            showChatIconRight: {
                _type: "bool",
                _inherit: true
            },
            showChatIconBottom: {
                _type: "bool",
                _inherit: true
            },
            widget_icon_pos: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    widget_icon_top_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    widget_icon_bottom_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    widget_icon_left_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    widget_icon_right_pos: {
                        _type: "number",
                        _inherit: true
                    },
                    widget_icon_id: {
                        _type: "number"
                    },
                    widget_icon_top_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    widget_icon_bottom_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    widget_icon_left_pos_unit: {
                        _type: "string",
                        _inherit: true
                    },
                    widget_icon_right_pos_unit: {
                        _type: "string",
                        _inherit: true
                    }
                }
            },
            widget_icon_path: {
                _type: "string",
                _inherit: true
            },
            hide_widget_if_noguide: {
                _type: "bool",
                _inherit: true
            },
            widget_icon_zindex: {
                _type: "string",
                _inherit: true
            },
            guide_count_on_widget: {
                _type: "bool",
                _inherit: true
            },
            guide_count_widget_color: {
                _type: "string",
                _inherit: true
            },
            selectorStyle: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    borderColor: {
                        _type: "string",
                        _inherit: true
                    },
                    borderWidth: {
                        _type: "number",
                        _inherit: true
                    }
                }
            },
            stepPopupWidth: {
                _type: "number",
                _inherit: true
            },
            hideBrandLogo: {
                _type: "bool",
                _inherit: true
            },
            logo_id: {
                _type: "number",
                _inherit: true
            },
            logo: {
                _type: "string",
                _inherit: true
            },
            variables: {
                _type: "array",
                _obj: mg$.extend({}, GmCXt.model.variables)
            },
            widgetIconType: {
                _type: "string",
                _inherit: true
            },
            guideMeSetting: {
                _type: "bool",
                _inherit: true
            },
            showMeSetting: {
                _type: "bool",
                _inherit: true
            },
            testMeSetting: {
                _type: "bool",
                _inherit: true
            },
            doitforme: {
                _type: "bool",
                _inherit: true
            },
            giphy: {
                _type: "bool",
                _inherit: true
            },
            video: {
                _type: "bool",
                _inherit: true
            },
            slideshow: {
                _type: "bool",
                _inherit: true
            },
            defaultPlayAction: {
                _type: "string",
                _inherit: true
            },
            isMiniPlayer: {
                _type: "bool",
                _inherit: true
            },
            widgetIconSize: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    widgetIconWidth: {
                        _type: "number",
                        _inherit: true
                    },
                    widgetIconHeight: {
                        _type: "number",
                        _inherit: true
                    }
                }
            },
            notificationDelay: {
                _type: "number",
                _inherit: true
            },
            notificationsTime: {
                _type: "string",
                _inherit: true
            },
            userLabels: {
                _type: "object",
                _obj: mg$.extend({}, GmCXt.model.userLabels),
                _clone: true,
                _inherit: true
            },

            chatLabels: {
                _type: "object",
                _obj: mg$.extend({}, GmCXt.model.chatLabels),
                _clone: true
            },
            notifications: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: {
                    notifThemeColor: {
                        _type: "string",
                        _inherit: true
                    }
                }
            },
            all_guide: {
                _type: "bool",
                _default: false,
                _inherit: true
            },
            playAudio: {
                _type: "bool",
                _inherit: true
            },
            tutorial_guide: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.tutorial_guide_default)
            },
            tooltipTheme: {
                _type: "bool",
                _inherit: true
            },
            tooltipColor: {
                _type: "string",
                _inherit: true
            },
            autoProceedStep: {
                _type: "bool",
                _inherit: true
            },
            autoStepDelay: {
                _type: "number",
                _inherit: true
            },
            notificationTheme: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.notificationTheme_default)
            },
            tooltip_img: {
                _type: "string",
                _inherit: true
            },
            playerTheme: {
                _type: "object",
                _clone: true,
                _inherit: true,
                _obj: GmCXt.createDeepCopy(GmCXt.model.playerThemeDefault)
            }
        },
        _clone: true
    },
    title: {
        _type: "string",
        _required: true
    }
};

GmCXt.model.chatLabels = {
    greetingMessage: {
        _type: "string",
        _default: ""
    },
    botEndingMessage: {
        _type: "string",
        _default: ""
    },
    errorMessage: {
        _type: "string",
        _default: ""
    }
};

GmCXt.model.variables = {
    name: {
        _type: "string",
    },
    element: {
        _type: "object",
        _obj: mg$.extend({}, GmCXt.model.stepSettings.element)
    },
    value: {
        _type: "string"
    },
    previewImage: {
        _type: "string"
    },
    url: {
        _type: "string"
    },
    rules: {
        _type: "array",
        _obj: mg$.extend({}, GmCXt.model.rule)
    }
};

GmCXt.model.applications = {
    _type: "array",
    _obj: mg$.extend({}, GmCXt.model.application)
};
/**
 * @file Guideme blackout viewport module
 * @author Nilesh Pachpande
 */

/**
 * @function Blackout remaining area outside of highlighted elements,
 * we will call it only 'elements'.
 * Remaining area contains many rectangles that need to blackout, we
 * call it 'rectangles' in comments inside the function.
 * @param {object} data - array of Elements highlighted inside DOM
 * @param {object} container - Jquery container object
 */


GmCXt.screenOverlay = function(options) {
    let pub = {};
    options = options || {};

    let data = options.data,
        myContainer = options.containerOffset,
        stepType = options.stepType,
        blackoutElement = options.element || '.mgPlayerJSProd_screen-blackout';

    pub.start = function() {

        if (!Array.isArray(data) || !myContainer || typeof myContainer.width !== 'number' || typeof myContainer.height !== 'number') {
            return;
        }

        /**
		 * Array of rectangles to blackout.
		 */
        let rectangles = [];

        /**
		 * Array of 0's and 1's. It is a matrix myContainer.width X myContainer.height
		 * Initialization:
		 * Elements corresponding to highlighted area are 1's and remaining elements are all 0's
		 * After initialization, elements are set to 1 when they are occupied by a rectangle.
		 */
        let containerMatrix = [];

        /**
		 * @function
		 * @param {number} left - x coordinate while traversing container
		 * @param {number} top - y coordinate
		 * @returns true if (x, y) coordinate is occupied,
		 * false if (x, y) coordinate is outside of highlighted area
		 */

        let checkIfOccupied = function(top, left) {

            let decrementBy = 1;

            for (let i = 0, j = data.length; i < j; i++) {
                if (data[i] && top > (data[i].top - decrementBy) &&
					top <= (data[i].top + data[i].height - decrementBy) &&
					left > (data[i].left - decrementBy) &&
					left <= (data[i].left + data[i].width - decrementBy)
                ) {
                    return true;
                }
            }
            return false;
        };

        /**
		 * @function Saves rectangle
		 * @param {object} top
		 * @param {object} left
		 */
        let saveRectangle = function(top, left) {

            let countX = 0,
                countY = 0,
                width = 0;
            let decrementWidth = false;
            for (let i = top; i < myContainer.height; i++) {
                countX = 0;
                for (var j = left; j < myContainer.width; j++) {
                    countX++;
                    if (containerMatrix[i][j] == 1 || j == (myContainer.width - 1)) {
                        // Initialize width
                        if (width === 0) {
                            if (containerMatrix[i][j] == 1) {
                                decrementWidth = true;
                            }
                            width = countX;
                        }
                        break;
                    }
                }

                // If width is set and is changed
                if (width > 0 && width != countX) {
                    break;
                } else {
                    // Start from left until j
                    for (let m = left; m < j; m++) {
                        // Set 1 for cells occupied by the rectangle
                        containerMatrix[i][m] = 1;
                    }
                }
                countY++;
            }

            if (decrementWidth === true) {
                width = width - 1;
            }

            let rect = {
                top: top,
                left: left,
                width: width,
                height: countY
            };

            if (myContainer !== undefined) {
                rect.top += myContainer.top;
                rect.left += myContainer.left;
            }

            let windowScrollTop = mg$('.mgPlayerJSProd_screen').scrollTop();
            if (windowScrollTop > 0) {
                rect.top -= windowScrollTop;
            }
            let windowScrollLeft = mg$('.mgPlayerJSProd_screen').scrollLeft();
            if (windowScrollLeft > 0) {
                rect.left -= windowScrollLeft;
            }

            if (!(rect.width === 0 || rect.height === 0)) {
                adjustPixels(rect);
                rectangles.push(rect);
            }
        };

        function adjustPixels(rect) {
            if (GmCXt.browserApp === 'ie') {
                let ratio = window.devicePixelRatio;
                let deviceWidth = rect.width * ratio;
                var diff = deviceWidth - Math.floor(deviceWidth);
                if (diff >= 0.5) {
                    rect.width = rect.width + 0.5;
                }

                let deviceHeight = rect.height * ratio;
                var diff = deviceHeight - Math.floor(deviceHeight);
                if (diff >= 0.5) {
                    rect.height = rect.height + 0.5;
                }
            }
        }

        /**
		 * i is traversing from top to bottom. So it represents the top coordinate of any point.
		 * j is traversing from left to right. So it represents the left coordinate of any point.
		 */

        function multipleAreaHighlight() {
            for (var i = 0; i < myContainer.height; i++) {
                containerMatrix[i] = [];
                for (var j = 0; j < myContainer.width; j++) {
                    if (checkIfOccupied(i, j)) {
                        containerMatrix[i][j] = 1;
                    } else {
                        containerMatrix[i][j] = 0;
                    }
                }
            }

            for (var i = 0; i < myContainer.height; i++) {
                for (var j = 0; j < (myContainer.width - 1); j++) {
                    /**
					 * If element is 0, initialize rectangle from the elements
					 * (x, y) coordinate as rectangle's top, left coordinates.
					 */
                    if (containerMatrix[i][j] === 0) {
                        saveRectangle(i, j);
                    }
                }
            }
        }

        function singleAreaHighlight(){
            let el =  data[0];

            let rect1 = {
                top: 0,
                left: 0,
                width: mg$(window).width(),
                height: el.top
            };
            let rect2 = {
                top: el.top,
                left: 0,
                width: el.left,
                height: el.height
            };
            let rect3 = {
                top: el.top,
                left: el.left+el.width,
                width: (mg$(window).width() - (el.left + el.width)),
                height: el.height
            };
            let rect4 = {
                top: el.top+el.height,
                left: 0,
                width: mg$(window).width(),
                height: (mg$(document).height() - (el.height + el.top))
            };

            rectangles.push(rect1, rect2, rect3, rect4);
        }

        if(data.length === 1){
            singleAreaHighlight();
        }else{
            multipleAreaHighlight();
        }

        let overlayObj = mg$(blackoutElement);
        let html = '';
        let wmgPlayerJSProd_OverPosition = '';
        if (stepType === GmCXt.STEP_TYPE_IMAGE) {
            wmgPlayerJSProd_OverPosition = 'fixed';
        }
        for (let i = 0; i < rectangles.length; i++) {
            html = html + "<wmgPlayerJSProd_over style='position:" + wmgPlayerJSProd_OverPosition + ";top: " + rectangles[i].top + "px;" +
				"left: " + rectangles[i].left + "px; width: " + rectangles[i].width + "px;" +
				" height: " + rectangles[i].height + "px;'></wmgPlayerJSProd_over>";
        }
        if (overlayObj && typeof overlayObj.html === 'function') {
            overlayObj.html(html);
        }

        let cssPosition = "absolute";
        if (options && options.cssPosition) {
            cssPosition = "fixed";
        }

        mg$(blackoutElement).css({
            'top': 0,
            'left': 0,
            'position': cssPosition
        });
        mg$(blackoutElement).show();

        if (myContainer !== undefined) {
            mg$(blackoutElement).css({
                'top': myContainer.top,
                'left': myContainer.left
            });
        }

        /* Add overlay opacity while playing step*/

        // TODO:- Tested
        if (GmCXt.playerI && GmCXt.playerI.tour) {
            let stepCurrentlyPlaying = GmCXt.getStepFromPlayerI(GmCXt.playerI.currentStepId);
            if (stepCurrentlyPlaying) {
                let stepSettings = stepCurrentlyPlaying.step_settings;
                let overlayOpacity = -1;
                if (GmCXt.isNumeric(stepSettings.overlayOpacity)) {
                    overlayOpacity = parseInt(stepSettings.overlayOpacity);
                    overlayOpacity = (overlayOpacity * 10) / 100;
                    mg$('wmgPlayerJSProd_over').css('opacity', overlayOpacity);
                }
            }
        }

    };

    return pub;
};

/**
 * @file Guideme Popup align module
 * @author Nilesh Pachpande
 */

/** @function
 * Sets up a popup alignment with respect to highlighted area, if an alignment (see below
 * for supported alignment types) is known. By default, it sets up alignment which fits
 * first in the order.
 * If none of the supported alignment is set then it aligns popup in the center.
 *
 * @param {object} options - having properties
 *  1. popup: popup jquery object (used to fetch properties (such as width and height) and
 *      to set up its css properties)
 *  2. highlightedArea: has properties, left, top, width and height
 *  3. alignment: any one of the supported alignment types namely left-top, left-bottom,
 *      right-top, right-bottom, top-left, top-right, bottom-left, bottom-right
 *  4. containerOffset: container offset in which popup should be aligned. for example
 *      image canvas for image type step
 *  5. hardApply: If input alignment should be applied. If not possible then, do nothing.
 *      By default, it is false, tries to set a default alignment if it is not possible
 *      to set the input alignment.
 */

GmCXt.alignPopup = function(options) {
    options = options || {};

    let pub = {};
    let self = {
        popup: options.popup,
        highlightedArea: options.highlightedArea || {},
        containerOffset: options.containerOffest || {
            left: 0,
            top: 0
        },
        alignment: options.alignment || '',
        hardApply: options.hardApply || false,
        doNotApplyArrow: options.doNotApplyArrow || false,
        arrowClass: '',
        left: null,
        top: null,
        isSet: false,
        arrowId: options.tooltipArrowId || "",
        arrowWidth: options.isBeacon ? 5 : 12, // true after alignment is set
        isGuidance: options.isGuidance,
        customPos: options.customPos,
        isBeacon: options.isBeacon,
        dynamicPositioning: options.dynamicPositioning
    };

    if (!self.arrowId) {
        self.doNotApplyArrow = true;
    }

    // This value gets set in tour player only
    // Hence assigning whenever it's not set
    if (!self.highlightedArea.origTop) {
        self.highlightedArea.origTop = self.highlightedArea.top;
    }

    /**
	 * Verify popup should be a valid jquery selector object
	 */
    if (self.popup.length === 0) {
        return;
    }

    if (self.arrowId && mg$('#' + self.arrowId).length) {
        mg$('#' + self.arrowId).remove();
    }

    if (self.isGuidance && (self.alignment === "top" || self.alignment === "bottom")) {
        self.arrowWidth = 8;
    }

    self.popupWidth = self.popup.outerWidth() || 310;
    self.popupHeight = self.popup.outerHeight() || 50;

    self.highlightedArea.width = self.highlightedArea.width ? self.highlightedArea.width : 0;
    self.highlightedArea.height = self.highlightedArea.height ? self.highlightedArea.height : 0;
    self.highlightedArea.left = self.highlightedArea.left ? self.highlightedArea.left : 0;
    self.highlightedArea.top = self.highlightedArea.top ? self.highlightedArea.top : 0;

    let winHeight = mg$(window).height();
    let winWidth = mg$(window).width();

    // Available space surrounding highlighted area
    if (self.highlightedArea.width > 0 && self.highlightedArea.height > 0) {
        self.availableSpace = {
            top: self.highlightedArea.origTop,
            left: self.highlightedArea.left,
            right: winWidth - (self.highlightedArea.left + self.highlightedArea.width),
            bottom: winHeight - (self.highlightedArea.origTop + self.highlightedArea.height)
        };
    } else {
        self.availableSpace = {
            top: 0,
            left: 0,
            right: 0,
            bottom: 0
        };
    }

    if (!self.highlightedArea.left && !self.highlightedArea.top) {
        self.availableSpace.top = (self.availableSpace.top) ? self.availableSpace.top : 0;
        self.availableSpace.left = (self.availableSpace.left) ? self.availableSpace.left : 0;
        self.availableSpace.right = (self.availableSpace.right) ? self.availableSpace.right : 0;
        self.availableSpace.bottom = (self.availableSpace.bottom) ? self.availableSpace.bottom : 0;
    }

    if (self.containerOffset !== undefined) {
        if (self.containerOffset.top < 0) {
            self.containerOffset.top = 0;
        }
        if (self.containerOffset.left < 0) {
            self.containerOffset.left = 0;
        }
        self.availableSpace.top += self.containerOffset.top;
        self.availableSpace.left += self.containerOffset.left;
        self.availableSpace.right -= self.containerOffset.left;
        self.availableSpace.bottom -= self.containerOffset.top;
    }

    if (options.playingTour) {
        GmCXt.log(33, "SURROUNDING SPACE of element", self.availableSpace);
    } else {
        GmCXt.log(43, "SURROUNDING SPACE of element", self.availableSpace);
    }

    if (self.availableSpace.top >= 0) {
        self.totalHeightMinusTop = winHeight - self.availableSpace.top;
    }
    if (self.availableSpace.left >= 0) {
        self.totalWidthMinusLeft = winWidth - self.availableSpace.left;
    }
    if (self.availableSpace.bottom >= 0) {
        self.totalHeightMinusBottom = winHeight - self.availableSpace.bottom;
    }
    if (self.availableSpace.right >= 0) {
        self.totalWidthMinusRight = winWidth - self.availableSpace.right;
    }

    function checkLeftMiddle() {
        if(self.dynamicPositioning){
            if (Math.abs(self.availableSpace.left) > self.popupWidth && self.highlightedArea.height / 2 < screen.height) {
                if ((Math.abs(self.availableSpace.top) + self.highlightedArea.height / 2 > self.popupHeight / 2) &&
					(Math.abs(self.availableSpace.bottom) + self.highlightedArea.height / 2 > self.popupHeight / 2)
                ) {
                    return true;

                } else {
                    return false;
                }
            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignLeftMiddle() {
        if (checkLeftMiddle()) {
            self.left = self.highlightedArea.left - self.popupWidth - self.arrowWidth;
            self.top = (self.highlightedArea.top + self.highlightedArea.height / 2) - (self.popupHeight / 2);
            self.arrowClass = 'mgPlayerJSProd_arrow-right';
            self.arrowLeft = self.highlightedArea.left - 12;
            self.arrowTop = self.top + (self.popupHeight / 2) - 10;
            self.isSet = true;
            self.alignment = 'left-middle';
        }
    }

    function checkLeftTop() {
        if(self.dynamicPositioning){
            if (Math.abs(self.availableSpace.left) > self.popupWidth && self.totalHeightMinusTop > self.popupHeight) {
                return true;
            } else {
                return false;
            }
        } else {
            return true;
        }

    }

    function alignLeftTop() {
        if (checkLeftTop()) {
            self.left = self.highlightedArea.left - self.popupWidth - self.arrowWidth;
            self.top = self.highlightedArea.top;
            self.arrowClass = 'mgPlayerJSProd_arrow-right';
            self.arrowLeft = self.highlightedArea.left - 12;
            self.arrowTop = self.top + 7;
            self.isSet = true;
            self.alignment = 'left-top';
        }
    }

    function checkLeftBottom() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.left) > self.popupWidth && self.totalHeightMinusBottom > self.popupHeight) {
                return true;
            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignLeftBottom() {
        if (checkLeftBottom()) {
            self.left = self.highlightedArea.left - self.popupWidth - self.arrowWidth;
            self.top = (self.highlightedArea.top + self.highlightedArea.height) - self.popupHeight;
            self.arrowClass = 'mgPlayerJSProd_arrow-right';
            self.arrowLeft = self.highlightedArea.left - 12;
            self.arrowTop = self.top + (self.popupHeight - 30);
            self.isSet = true;
            self.alignment = 'left-bottom';
        }
    }

    function checkRightMiddle() {
        if(self.dynamicPositioning) {
            if (self.availableSpace.right > self.popupWidth && self.highlightedArea.height / 2 < screen.height) {
                if ((Math.abs(self.availableSpace.top) + self.highlightedArea.height / 2 > self.popupHeight / 2) &&
					(Math.abs(self.availableSpace.bottom) + self.highlightedArea.height / 2 > self.popupHeight / 2)
                ) {
                    return true;

                } else {
                    return false;
                }

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignRightMiddle() {
        if (checkRightMiddle()) {
            self.left = self.highlightedArea.left + self.highlightedArea.width + self.arrowWidth;
            self.top = (self.highlightedArea.top + self.highlightedArea.height / 2) - (self.popupHeight / 2);
            self.arrowClass = 'mgPlayerJSProd_arrow-left';
            self.arrowLeft = self.left - 10;
            self.arrowTop = self.top + (self.popupHeight / 2) - 10;
            self.isSet = true;
            self.alignment = 'right-middle';
        }
    }

    function checkRightTop() {
        if(self.dynamicPositioning) {
            if (self.availableSpace.right > self.popupWidth && self.totalHeightMinusTop > self.popupHeight) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignRightTop() {
        if (checkRightTop()) {
            self.left = self.highlightedArea.left + self.highlightedArea.width + self.arrowWidth;
            self.top = self.highlightedArea.top;
            self.arrowClass = 'mgPlayerJSProd_arrow-left';
            self.arrowLeft = self.left - 10;
            self.arrowTop = self.top + 7;
            self.isSet = true;
            self.alignment = 'right-top';
        }
    }

    function checkRightBottom() {
        if(self.dynamicPositioning) {
            if (self.availableSpace.right > self.popupWidth && self.totalHeightMinusBottom > self.popupHeight) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignRightBottom() {
        if (checkRightBottom()) {
            self.left = self.highlightedArea.left + self.highlightedArea.width + self.arrowWidth;
            self.top = (self.highlightedArea.top + self.highlightedArea.height) - self.popupHeight;
            self.arrowClass = 'mgPlayerJSProd_arrow-left';
            self.arrowLeft = self.left - 10;
            self.arrowTop = self.top + (self.popupHeight - 30);
            self.isSet = true;
            self.alignment = 'right-bottom';
        }
    }

    function checkTopMiddle() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.top) > (self.popupHeight + 15) && self.totalWidthMinusLeft > self.popupWidth / 2) {
                if ((Math.abs(self.availableSpace.left) + self.highlightedArea.width / 2 > self.popupWidth / 2) &&
					(self.availableSpace.right + self.highlightedArea.width / 2 > self.popupWidth / 2)
                ) {
                    return true;

                } else {
                    return false;
                }

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignTopMiddle() {
        if (checkTopMiddle()) {
            self.left = (self.highlightedArea.left + self.highlightedArea.width / 2) - self.popupWidth / 2;
            self.top = self.highlightedArea.top - self.popupHeight - self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-down';
            self.arrowLeft = (self.highlightedArea.left + self.highlightedArea.width / 2) - 8;
            self.arrowTop = self.highlightedArea.top - 12;
            self.isSet = true;
            self.alignment = 'top-middle';
        }
    }

    function checkTopLeft() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.top) > (self.popupHeight + 15) && self.totalWidthMinusLeft > self.popupWidth) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignTopLeft() {
        if (checkTopLeft()) {
            self.left = self.highlightedArea.left;
            self.top = self.highlightedArea.top - self.popupHeight - self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-down';
            self.arrowLeft = self.highlightedArea.left + 7;
            self.arrowTop = self.highlightedArea.top - 12;
            self.isSet = true;
            self.alignment = 'top-left';
        }
    }

    function checkTopRight() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.top) > (self.popupHeight + 15) && self.totalWidthMinusRight > self.popupWidth) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignTopRight() {
        if (checkTopRight()) {
            self.left = (self.highlightedArea.left + self.highlightedArea.width) - self.popupWidth;
            self.top = self.highlightedArea.top - self.popupHeight - self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-down';
            self.arrowLeft = (self.highlightedArea.left + self.highlightedArea.width) - (20 + 7); // 20 is arrow width
            self.arrowTop = self.highlightedArea.top - 12;
            self.isSet = true;
            self.alignment = 'top-right';
        }
    }

    function checkBottomMiddle() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.bottom) > self.popupHeight && self.totalWidthMinusLeft > self.popupWidth / 2) {
                if ((Math.abs(self.availableSpace.left) + self.highlightedArea.width / 2 > self.popupWidth / 2) &&
					(self.availableSpace.right + self.highlightedArea.width / 2 > self.popupWidth / 2)
                ) {
                    return true;

                } else {
                    return false;
                }

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignBottomMiddle() {
        if (checkBottomMiddle()) {
            self.left = (self.highlightedArea.left + self.highlightedArea.width / 2) - self.popupWidth / 2;
            self.top = self.highlightedArea.top + self.highlightedArea.height + self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-up';
            self.arrowLeft = (self.highlightedArea.left + self.highlightedArea.width / 2) - 8;
            self.arrowTop = self.highlightedArea.top + self.highlightedArea.height + 2;
            self.isSet = true;
            self.alignment = 'bottom-middle';
        }
    }

    function checkBottomLeft() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.bottom) > self.popupHeight && self.totalWidthMinusLeft > self.popupWidth) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignBottomLeft() {
        if (checkBottomLeft()) {
            self.left = self.highlightedArea.left;
            self.top = self.highlightedArea.top + self.highlightedArea.height + self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-up';
            self.arrowLeft = self.highlightedArea.left + 7;
            self.arrowTop = self.highlightedArea.top + self.highlightedArea.height + 2;
            self.isSet = true;
            self.alignment = 'bottom-left';
        }
    }

    function checkBottomRight() {
        if(self.dynamicPositioning) {
            if (Math.abs(self.availableSpace.bottom) > self.popupHeight && self.totalWidthMinusRight > self.popupWidth) {
                return true;

            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    function alignBottomRight() {
        if (checkBottomRight()) {
            self.left = (self.highlightedArea.left + self.highlightedArea.width) - self.popupWidth;
            self.top = self.highlightedArea.top + self.highlightedArea.height + self.arrowWidth;
            self.arrowClass = 'mgPlayerJSProd_arrow-up';
            self.arrowLeft = (self.highlightedArea.left + self.highlightedArea.width) - (20 + 7); // 20 is arrow width
            self.arrowTop = self.highlightedArea.top + self.highlightedArea.height + 2;
            self.isSet = true;
            self.alignment = 'bottom-right';
        }
    }

    function alignCenter() {
        self.left = (winWidth - self.popupWidth) / 2;
        self.left += mg$(window).scrollLeft();

        self.top = (winHeight - self.popupHeight) / 2;
        self.top += mg$(window).scrollTop();

        self.isSet = true;
        self.alignment = 'center';
    }

    function alignCustom() {
        if(self.customPos.left_pos === "px") {
            self.left = self.highlightedArea.left + self.customPos.left;
        } else if(self.customPos.left_pos === "%") {
            self.left = (self.highlightedArea.left + ((self.highlightedArea.width * self.customPos.left) / 100));
            if(self.isBeacon) {
                self.left = self.left - (self.popupWidth/2);
            }
        }
        if(self.customPos.top_pos === "px") {
            self.top = self.highlightedArea.top + self.customPos.top;
        } else if(self.customPos.top_pos === "%") {
            self.top = (self.highlightedArea.top + ((self.highlightedArea.height * self.customPos.top) / 100));
            if(self.isBeacon) {
                self.top = self.top - (self.popupHeight/2);
            }
        }

        self.isSet = true;
        self.alignment = 'custom';
    }

    pub.getAvailablePositions = function() {
        return {
            'left-middle': checkLeftMiddle(),
            'left-top': checkLeftTop(),
            'left-bottom': checkLeftBottom(),

            'right-middle': checkRightMiddle(),
            'right-top': checkRightTop(),
            'right-bottom': checkRightBottom(),

            'top-middle': checkTopMiddle(),
            'top-left': checkTopLeft(),
            'top-right': checkTopRight(),

            'bottom-middle': checkBottomMiddle(),
            'bottom-left': checkBottomLeft(),
            'bottom-right': checkBottomRight()
        };
    };

    pub.start = function() {

        switch (self.alignment) {
        case 'left':
            alignLeftMiddle();
            if (!self.isSet) alignLeftTop();
            if (!self.isSet) alignLeftBottom();
            break;

        case 'left-middle':
            alignLeftMiddle();
            if (!self.isSet) alignLeftTop();
            if (!self.isSet) alignLeftBottom();
            break;

        case 'left-top':
            alignLeftTop();
            if (!self.isSet) alignLeftBottom();
            break;

        case 'left-bottom':
            alignLeftBottom();
            if (!self.isSet) alignLeftTop();
            break;

        case 'right':
            alignRightMiddle();
            if (!self.isSet) alignRightTop();
            if (!self.isSet) alignRightBottom();

            break;

        case 'right-middle':
            alignRightMiddle();
            if (!self.isSet) alignRightTop();
            if (!self.isSet) alignRightBottom();
            break;

        case 'right-top':
            alignRightTop();
            if (!self.isSet) alignRightBottom();
            break;

        case 'right-bottom':
            alignRightBottom();
            if (!self.isSet) alignRightTop();
            break;

        case 'top':
            alignTopMiddle();
            if (!self.isSet) alignTopLeft();
            if (!self.isSet) alignTopRight();
            break;

        case 'top-middle':
            alignTopMiddle();
            break;

        case 'top-left':
            alignTopLeft();
            break;

        case 'top-right':
            alignTopRight();
            break;

        case 'bottom':
            alignBottomMiddle();
            if (!self.isSet) alignBottomLeft();
            if (!self.isSet) alignBottomRight();
            break;

        case 'bottom-middle':
            alignBottomMiddle();
            break;

        case 'bottom-left':
            alignBottomLeft();
            break;

        case 'bottom-right':
            alignBottomRight();
            break;

        case 'center':
            alignCenter();
            break;

        case 'custom':
            alignCustom();
            break;
        default:
        }

        if (self.hardApply === false) {

            if (!self.isSet) alignRightMiddle();

            if (!self.isSet) alignRightTop();

            if (!self.isSet) alignRightBottom();

            if (!self.isSet) alignLeftMiddle();

            if (!self.isSet) alignLeftTop();

            if (!self.isSet) alignLeftBottom();

            if (!self.isSet) alignTopMiddle();

            if (!self.isSet) alignTopLeft();

            if (!self.isSet) alignTopRight();

            if (!self.isSet) alignBottomMiddle();

            if (!self.isSet) alignBottomLeft();

            if (!self.isSet) alignBottomRight();

            if (!self.isSet) alignCenter();
        }

        if (self.left !== null && self.top !== null) {

            if (self.top < 0) self.top = 10;

            let windowScrollTop = mg$('.mgPlayerJSProd_screen').scrollTop();
            if (windowScrollTop > 0) {
                self.top -= windowScrollTop;
            }
            let windowScrollLeft = mg$('.mgPlayerJSProd_screen').scrollLeft();
            if (windowScrollLeft > 0) {
                self.left -= windowScrollLeft;
            }

            self.popup.css({
                'left': self.left + self.containerOffset.left,
                'top': self.top + self.containerOffset.top
            });
        }

        if (self.arrowId) {
            self.arrowClass = self.arrowClass + " mgPlayerJSProd_tooltip-arrow";
        }

        mg$(".mgPlayerJSProd_arrow-down").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-up").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-left").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-right").not(".mgPlayerJSProd_tooltip-arrow").remove();

        self.arrowLeft += self.containerOffset.left;
        self.arrowLeft += mg$(window).scrollLeft();

        self.arrowTop += self.containerOffset.top;
        self.arrowTop += mg$(window).scrollTop();

        if (!self.doNotApplyArrow) {
            mg$('html').append('<wmgPlayerJSProd_ id= "' + self.arrowId + '" class="' + self.arrowClass + '" style="left:' + self.arrowLeft + 'px;top:' + self.arrowTop + 'px;"></wmgPlayerJSProd_>');
        }

        if (self.isSet) return self.alignment;
        else return false;
    };

    pub.checkHeight = function() {
        let popupHeightNew = self.popup.outerHeight();

        if (self.popupHeight !== popupHeightNew)
            pub.redo();
    };

    pub.redo = function() {
        if (self.isGuidance) {
            self.arrowWidth = 8;
        }
        self.popupWidth = self.popup.outerWidth();
        self.popupHeight = self.popup.outerHeight();
        pub.start();
    };

    pub.clear = function() {

        GmCXt.clearPreviewPopupAlignment(self.popup);
        mg$(".mgPlayerJSProd_arrow-down").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-up").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-left").not(".mgPlayerJSProd_tooltip-arrow").remove();
        mg$(".mgPlayerJSProd_arrow-right").not(".mgPlayerJSProd_tooltip-arrow").remove();

        self.popup.css({
            'left': 0,
            'top': 0
        });
    };

    return pub;
};

/**
	* @file Guideme preview step popup
	* @author Nilesh Pachpande
	*/

GmCXt.previewStepPopup = function(options) {
    options = options || {};
    let pub = {};

    let self = {
        id: options.step.step_id,
        type: options.step.step_type,
        title: GmCXt.replaceVariableWithValue(options.step.step_title),
        description: GmCXt.replaceVariableWithValue(options.step.step_description),
        audioTrack: options.step.step_audio,
        highlightedArea: options.step.highlightedArea,
        settings: options.step.step_settings,
        serialNumber: options.step.order || 0,
        container: options.container,
        containerOffest: options.containerOffest || {
            left: 0,
            top: 0
        },
        totalStepCount: options.totalStepCount,
        playingTour: options.playingTour || false
    };

    if (self.playingTour && options.tour) {
        self.tour = options.tour;
    } else {
        self.tour = false;
    }

    pub.load = function() {
        GmCXt.addStepPreviewHtml(self);

        applyMediaPlayerStyles();
        GmCXt.addDragPopUpFunction();

        let promise = new Promise(function(resolve, reject) {

            GmCXt.hideWidgetIcon();
            handlePlayerSpecificUI();

            let os = getStepSettings();
            let popupDesign = os.popupDesign;

            handlePopupDesign(popupDesign);

            setPopupPosition();
            updatePopupContent();
            setPopupDimensions();

            attachDOMEvents();

            if (!self.playingTour) {
                setDefaultFontSizes();
            }
            /**
            * Blackout area surrounding step DOM element for inline step
            * and surrounding highlighted areas for image steps.
            */

            handleScreenBlackout();


            configureAudioAndStepUIForTourPlay();

            updatePopupAlignment();

            stopMouseOutEvent();
            resolve();
        });
        GmCXt.onPopupRerender();

        return promise;
    };


    function applyMediaPlayerStyles() {
        if (GmCXt.isMediaPlayerOn) {
            mg$(".mgPlayerJSProd_preview-step-popup-container").addClass("mgPlayerJSProd_preview-step-popup-container-mp");
        }
    }

    function handlePlayerSpecificUI() {
        if (GmCXt.isPlayer()) {
            GmCXt.hideBeacons();
            GmCXt.hideSmartTipsIfOptionON();
        }
    }

    function getStepSettings() {
        let os = GmCXt.getStepSettings();
        if (options.step.type === GmCXt.STEP_TYPE_WEB_INLINE) {
            os = options.step.orgSettings;
        }
        return os;
    }

    function handlePopupDesign(popupDesign) {
        if (!popupDesign) return;

        applyDesignType(popupDesign.type);
        if (popupDesign.popupActiveSettings) {
            popupDesign.current = popupDesign.popupActiveSettings;
        }

        const themeColors = getThemeColors(popupDesign);
        applyAccessibilityStyles(popupDesign);
        applyPopupStyles(popupDesign, themeColors);

    }

    function applyDesignType(type) {
        if (type === 'default') {
            mg$('.mgPlayerJSProd_preview-step-popup-navigation-wrapper').css({ 'display': 'none' });
            mg$('.mgPlayerJSProd_preview-step-popup-container').removeClass('mgPlayerJSProd_preview-step-popup-classic-design');
            mg$('.mgPlayerJSProd_play-step-popup-logo').css({ 'display': '' });
            mg$('.mgPlayerJSProd_play-total-step-cont').css({ 'display': '' });
            mg$('.mgPlayerJSProd_play-step-navigation').css({ 'display': '' });
            mg$(".mgPlayerJSProd_play-step-popup-footer").css("height", "auto");
        } else if (type === 'classic') {
            mg$('.mgPlayerJSProd_preview-step-popup-navigation-wrapper').css({ 'display': '' });
            mg$('.mgPlayerJSProd_preview-step-popup-container').addClass('mgPlayerJSProd_preview-step-popup-classic-design');
            mg$('.mgPlayerJSProd_play-step-popup-logo').css({ 'display': 'none' });
            mg$('.mgPlayerJSProd_play-total-step-cont').css({ 'display': 'none' });
            mg$('.mgPlayerJSProd_play-step-navigation').css({ 'display': 'none' });
            mg$(".mgPlayerJSProd_play-step-popup-footer").css("height", "42px");
        }
    }


    function getThemeColors(popupDesign) {
        const current = popupDesign.current;
        let themeColors = {
            bgColor: current.bgColor,
            borderColor: current.borderColor,
            closeIconColor: current.closeIconColor,
            prevBtnColor: current.prevBtnColor,
            nextBtnColor: current.nextBtnColor,
            nextBtnBackground: current.nextBtnBackground,
            stepTitleColor: current.stepTitleColor,
            stepDescColor: current.stepDescColor
        };

        if (GmCXt.accessibility) {
            themeColors = {
                bgColor: "#ffffff",
                prevBtnColor: "#ffffff",
                nextBtnColor: "#ffffff",
                nextBtnBackground: '#276157',
                borderColor: '#276157',
                stepTitleColor: '#276157',
                closeIconColor: '#26273B',
                stepDescColor: '#a6a6a6'
            };
        }

        return themeColors;
    }

    function applyAccessibilityStyles(popupDesign) {
        if (GmCXt.accessibility) {
            mg$(".mgPlayerJSProd_play-step-navigation").addClass("mgPlayerJSProd_accessibility-theme");
            mg$('.mgPlayerJSProd_play-step-prev').addClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_play-step-next').addClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_play-step-pause').addClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-design-navigation-prev').addClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-navigation-next').addClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-navigation-pause').addClass("mgPlayerJSProd_ass-default-btn");
        } else {
            mg$(".mgPlayerJSProd_play-step-navigation").removeClass("mgPlayerJSProd_accessibility-theme");
            mg$('.mgPlayerJSProd_play-step-prev').removeClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_play-step-next').removeClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_play-step-pause').removeClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-design-navigation-prev').removeClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-navigation-next').removeClass("mgPlayerJSProd_ass-default-btn");
            mg$('.mgPlayerJSProd_popup-classic-navigation-pause').removeClass("mgPlayerJSProd_ass-default-btn");
            setButtonStyles(popupDesign.current);
        }
    }

    function setButtonStyles(current) {
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-prev', {
            "background-color": current.prevBtnBackground,
            "color": current.prevBtnColor,
            "border-color": current.prevBtnColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-next', {
            "background-color": current.nextBtnBackground,
            "color": current.nextBtnColor,
            "border-color": current.nextBtnColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-pause', {
            "background-color": current.nextBtnBackground,
            "color": current.nextBtnColor,
            "border-color": current.nextBtnColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-design-navigation-prev', {
            "background-color": current.prevBtnBackground,
            "color": current.prevBtnColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-next', {
            "background-color": current.nextBtnBackground,
            "color": current.nextBtnColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-pause', {
            "background-color": current.nextBtnBackground,
            "color": current.nextBtnColor
        }, true);
    }

    function applyPopupStyles(popupDesign,themeColors) {
        // const themeColors = getThemeColors(popupDesign);

        // Apply general styles to the popup
        GmCXt.setElementStyle('.mgPlayerJSProd_preview-step-popup-container', {
            "background-color": themeColors.bgColor,
            "border-radius": popupDesign.current.borderRadius + 'px',
            "border-color": themeColors.borderColor,
            "border-width": popupDesign.current.borderWidth + 'px',
            "border-style": "solid",
            "padding-top": popupDesign.current.padding.top + 'px',
            "padding-bottom": popupDesign.current.padding.bottom + 'px',
            "padding-left": popupDesign.current.padding.left + 'px',
            "padding-right": popupDesign.current.padding.right + 'px'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-popup', {
            "border-radius": popupDesign.current.borderRadius + 'px'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-popup-s-title', {
            "color": themeColors.stepTitleColor,
            "font-size": popupDesign.current.stepTitleFontSize,
            "font-family": popupDesign.current.stepTitleFontFamily,
            "font-weight": popupDesign.current.stepTitleFontWeight
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step-popup-description', {
            "color": themeColors.stepDescColor,
            "font-size": popupDesign.current.stepDesFontSize,
            "font-family": popupDesign.current.stepDesFontFamily
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-total-step-cont', {
            "background-color": themeColors.bgColor,
            "color": themeColors.stepTitleColor
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-total-step', {
            "color": popupDesign.current.stepCountColor
        }, true);

        if (mg$('#mgPlayerJSProd_popup-arrow').length) {
            mg$('#mgPlayerJSProd_popup-arrow').remove();
        }
        let popUpCSS = "<style id='mgPlayerJSProd_popup-arrow' type='text/css'>" +
    ".mgPlayerJSProd_preview-step-popup-container.right-top:after,.mgPlayerJSProd_preview-step-popup-container.right-middle:after,.mgPlayerJSProd_preview-step-popup-container.right-bottom:after {" +
    "border-right-color:" + themeColors.bgColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.right-top:before,.mgPlayerJSProd_preview-step-popup-container.right-middle:before, .mgPlayerJSProd_preview-step-popup-container.right-bottom:before {" +
    "border-right-color:" + themeColors.borderColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.left-top:after,.mgPlayerJSProd_preview-step-popup-container.left-middle:after,.mgPlayerJSProd_preview-step-popup-container.left-bottom:after {" +
    "border-left-color:" + themeColors.bgColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.left-top:before,.mgPlayerJSProd_preview-step-popup-container.left-middle:before, .mgPlayerJSProd_preview-step-popup-container.left-bottom:before {" +
    "border-left-color:" + themeColors.borderColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.top-left:after,.mgPlayerJSProd_preview-step-popup-container.top-middle:after,.mgPlayerJSProd_preview-step-popup-container.top-right:after {" +
    "border-top-color:" + themeColors.bgColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.top-left:before,.mgPlayerJSProd_preview-step-popup-container.top-middle:before, .mgPlayerJSProd_preview-step-popup-container.top-right:before {" +
    "border-top-color:" + themeColors.borderColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.bottom-left:after,.mgPlayerJSProd_preview-step-popup-container.bottom-middle:after,.mgPlayerJSProd_preview-step-popup-container.bottom-right:after {" +
    "border-bottom-color:" + themeColors.bgColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_preview-step-popup-container.bottom-left:before,.mgPlayerJSProd_preview-step-popup-container.bottom-middle:before, .mgPlayerJSProd_preview-step-popup-container.bottom-right:before {" +
    "border-bottom-color:" + themeColors.borderColor + " !important;" +
    "} " +
    ".mgPlayerJSProd_play-step-audio i {" +
    "color:" + themeColors.closeIconColor + " !important;" +
    "}" +
    ".mgPlayerJSProd_play-step-audio svg path {" +
    "fill:" + themeColors.closeIconColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-popup-close i {" +
    "color:" + themeColors.closeIconColor + "!important;" +
    "-webkit-text-stroke-color:" + themeColors.bgColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-popup-close svg path {" +
    "fill:" + themeColors.closeIconColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-popup-drag svg path {" +
    "fill:" + themeColors.closeIconColor + "!important;" +
    "stroke:" + themeColors.closeIconColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-popup-edit svg path{" +
    "fill:" + themeColors.closeIconColor + "!important;" +
    "stroke:" + themeColors.closeIconColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-prev svg path {" +
    "fill:" + themeColors.prevBtnColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-next svg path {" +
    "fill:" + themeColors.nextBtnColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_play-step-pause svg path{" +
    "fill:" + themeColors.nextBtnColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_popup-classic-design-navigation-prev svg path {" +
    "fill:" + themeColors.prevBtnColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_popup-classic-navigation-next svg path {" +
    "fill:" + themeColors.nextBtnColor + "!important;" +
    "}" +
    ".mgPlayerJSProd_popup-classic-navigation-pause svg path {" +
    "fill:" + themeColors.nextBtnColor + "!important;" +
    "}" +
    "</style>";

        mg$("html:first").append(popUpCSS);
    }


    function setPopupPosition() {
        let tipPosition = "absolute";
        if (GmCXt.tourPlayerI && GmCXt.tourPlayerI.cssPosition && self.type !== GmCXt.STEP_TYPE_MESSAGE) {
            tipPosition = "fixed";
        }
        mg$('.mgPlayerJSProd_preview-step-popup-container, wmgPlayerJSProd_over').css({'position': tipPosition});
        mg$(".mgPlayerJSProd_preview-step-popup-container").show();
    }

    function updatePopupContent() {
        mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-step-popup-s-num').html(self.serialNumber);

        self.title = GmCXt.handleHtmlAssets(self.title);
        mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_step-title').html(self.title);

        if (!GmCXt.replaceVariableInText(self.title).trim()) {
            mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_step-title').remove();
        }

        if (self.tour.tour_type === 'howto_tour') {
            self.description = "<p>"+self.description+"</p>";
        } 
        self.description = GmCXt.restoreAssetSrc(self.description);
        
        mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-step-popup-description').html(self.description);
        mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-curr-step').html(self.serialNumber);
        mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-total-step').html(self.totalStepCount);

        handleBrandLogo();
        fixDescriptionImages();

        if (GmCXt.enforceGuideMePopup) {
            mg$('.mgPlayerJSProd_preview-step-popup-container').css({
                'z-index': '2147483646'
            });
        }
        GmCXt.zoomImage(self.description, ".mgPlayerJSProd_play-step-popup-description");
        GmCXt.setLinkClickhandler(self.title, ".mgPlayerJSProd_step-title");
        GmCXt.setLinkClickhandler(self.description, ".mgPlayerJSProd_play-step-popup-description");
        setLinkGuidePlay();
    }

    function handleBrandLogo() {
        let hideStepIcon = false;
        if (GmCXt.getOrgLevelBrandLogoSetting()) {
            hideStepIcon = true;
        }
        let brandLogoEl = mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-step-popup-logo img');
        brandLogoEl.attr('src', GmCXt.brandLogo());
        let os = GmCXt.getOrgSettings();
        let cdnSign = GmCXt.getCdnSign();

        if ((os.logo && cdnSign) && !hideStepIcon) {
            brandLogoEl.show();
        } else {
            brandLogoEl.hide();
        }

    }

    function fixDescriptionImages() {
        let len = mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-step-popup-description img').length;
        if (len) {
            for (let i = 0; i < len; i++) {
                let img = mg$('.mgPlayerJSProd_preview-step-popup-container .mgPlayerJSProd_play-step-popup-description img')[i];
                let imgW = img.getAttribute('width');
                let imgH = img.getAttribute('height');
                img.style.setProperty('width', imgW + 'px', 'important');
                img.style.setProperty('height', imgH + 'px', 'important');
            }
        }
    }

    function setLinkGuidePlay() {
        if (self.description && self.description.indexOf('target = "gssPlayGuide"' !== -1)) {
            GmCXt.setLinkGuidePlay(self.description, ".mgPlayerJSProd_play-step-popup-description");
        }
        if (self.title && self.title.indexOf('target = "gssPlayGuide"' !== -1)) {
            GmCXt.setLinkGuidePlay(self.title, ".mgPlayerJSProd_step-title");
        }
    }

    function setPopupDimensions() {
        let popupWrapper = mg$('.mgPlayerJSProd_play-step-popup-content-wrapper');
        if (self.settings.stepPopupWidth) {
            popupWrapper.css({"width": self.settings.stepPopupWidth});
        } else {
            popupWrapper.css({"width": GmCXt.stepPopupWidth + "px"});
        }
        if (self.settings.stepPopupHeight) {
            popupWrapper.css({"max-height": self.settings.stepPopupHeight});
        } else {
            popupWrapper.css({"max-height": GmCXt.stepPopupMaxHeight + "px"});
        }
    }

    function setDefaultFontSizes() {
        mg$('.mgPlayerJSProd_play-step-popup-description').css({'font-size': '16px', 'line-height': '19px;'});
        mg$('.mgPlayerJSProd_play-step-prev').css({'font-size': '15px'});
        mg$('.mgPlayerJSProd_play-step-next').css({'font-size': '15px'});
    }

    function handleScreenBlackout() {
        if (self.settings.screenBlackout === true) {
            let hideIEOverlay = false;
            if ((self.type == GmCXt.STEP_TYPE_MESSAGE || self.type == GmCXt.STEP_TYPE_IMAGE) && !self.highlightedArea) {
                self.highlightedArea = [{left: 0, top: 0, height: 0, width: 0}];
                hideIEOverlay = true;
            }
            if (self.highlightedArea) {

                let opts = {
                    data: self.highlightedArea,
                    containerOffset: GmCXt.getContainerOffSet(false),
                    stepType: self.type,
                    overlay: true,
                    tour: self.tour,
                    stepIndex: self.serialNumber
                };

                if (self.type == GmCXt.STEP_TYPE_IMAGE) {

                    opts.containerOffset = GmCXt.getContainerOffSet(mg$('#mgPlayerJSProd_image-canvas'));

                    if (self.container) {
                        opts.container = self.container;
                        opts.containerOffset = GmCXt.getContainerOffSet(self.container);
                    }
                }

                if (self.playingTour === true) {
                    opts.overlay = false;
                }

                GmCXt.removeScreenOverlay();

                opts.cssPosition = GmCXt.tourPlayerI.cssPosition;

                if (GmCXt.playerI && GmCXt.playerI.tour) {

                    let step_ = GmCXt.getStepFromPlayerI(GmCXt.playerI.currentStepId);

                    let overlayOpacity = GmCXt.getOpacity(step_);

                    if (step_) {
                        let stepSettings = step_.step_settings;

                        // Add overlay if force guide mode is ON
                        if (GmCXt.playerI.forceGuideMe === true &&
                  stepSettings.doNotForceGuide !== true &&
                  !stepSettings.onClickAnywhere &&
                  !stepSettings.onPageClickNext &&
                  overlayOpacity === 0
                        ) {
                            opts.overlay = true;
                            overlayOpacity = 0.1;
                            opts = forSalesforceCol(stepSettings, opts, true);
                        }
                    }

                    if (overlayOpacity) {
                        if (GmCXt.browserApp === 'ie') {
                            if (!hideIEOverlay) {
                                blackoutIEViewPort(self.highlightedArea, overlayOpacity, opts.cssPosition);
                            }
                        } else {
                            GmCXt.screenOverlayI = GmCXt.screenOverlay(opts);
                            GmCXt.screenOverlayI.start();
                        }
                    }
                } else {
                    GmCXt.screenOverlayI = GmCXt.screenOverlay(opts);
                    GmCXt.screenOverlayI.start();
                }
            }
        }
    }

    function configureAudioAndStepUIForTourPlay() {
     	/**
				* Audio button, step serial number is not available
				* when preview is shown after step is saved.
				* Availale in tour play is active.
				*/

        if (self.playingTour === true) {
            mg$('.mgPlayerJSProd_play-step-popup-s-title').show();
        } else {
            mg$('#mgPlayerJSProd_play_step_audio').hide();
            mg$('.mgPlayerJSProd_play-total-step-cont').hide();
            mg$('.mgPlayerJSProd_play-step-popup-s-num').hide();
            mg$('.mgPlayerJSProd_play-step-navigation').hide();
            mg$('.mgPlayerJSProd_play-step-popup-close').hide();
            mg$('.mgPlayerJSProd_play-step-audio-loader').hide();
            mg$('.popup-classic-design-navigation').hide();
            /*mg$('.mgPlayerJSProd_play-step-popup-description').css({'font-size': '18px', 'line-height': '21px;'});
				//mg$('.mgPlayerJSProd_play-step-popup-s-title').css({'font-size': '22px'});
				mg$('.mgPlayerJSProd_play-step-prev').css({'font-size': '18px'});
				mg$('.mgPlayerJSProd_play-step-next').css({'font-size': '18px'});*/
        }
    }

    function updatePopupAlignment() {
        let $popup = mg$(".mgPlayerJSProd_step-popup");
        let doAlign = false;

        if (self.type === GmCXt.STEP_TYPE_INLINE ||
          self.type === GmCXt.STEP_TYPE_WEB_INLINE ||
          self.type === GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION) {

            doAlign = true;
            if (self.settings.headerNext && GmCXt.playerI.forceGuideMe) {
                options = forSalesforceCol(self.settings, options, false);
            }

        } else if (self.type == GmCXt.STEP_TYPE_MESSAGE || self.type == GmCXt.STEP_TYPE_IMAGE) {
            GmCXt.alignMessagePreview($popup, mg$(window), self.settings.alignment, self.settings);
        }

        if (doAlign) {
            GmCXt.alignPopupI = GmCXt.alignPopup({
                popup: $popup,
                highlightedArea: self.highlightedArea[0],
                containerOffest: self.containerOffest,
                alignment: self.settings.alignment,
                playingTour: self.playingTour,
                dynamicPositioning: self.settings.dynamicPositioning
            });

            GmCXt.alignPopupI.clear();

            let alignment = GmCXt.alignPopupI.start();

            if (alignment) {
                $popup.addClass(alignment);
            }
            if (GmCXt.alignPopupI) {
                GmCXt.timeout(GmCXt.alignPopupI.checkHeight, 1000);
            }
        }
    }


    var forSalesforceCol = function(settings, opt, flag) {
        if (settings.headerNext) {
            let customSettings = settings.element.customSettings;
            if (flag && customSettings.salesforce.tableHeight) {
                let tableHeight = customSettings.salesforce.tableHeight;
                opt.data[0].height = tableHeight;
            } else if (customSettings.salesforce.tableHeight) {
                opt.data[0].height = settings.element.position.height;
            }
        }
        return opt;
    };

    var stopMouseOutEvent = function() {

        if (GmCXt.playerI && GmCXt.playerI.tour) {
            let previousStepId = GmCXt.playerI.lastPlayedStepId;
            if (previousStepId) {
                let prevStep = GmCXt.createDeepCopy(GmCXt.getStepFromPlayerI(previousStepId));
                if (prevStep) {
                    let settings = prevStep.step_settings;
                    if (settings && (settings.hoverNext === true)) {
                        window.addEventListener('mouseout', stopEventPropagation, true);
                    }
                }
            }
        }
    };

    var stopEventPropagation = function(e) {
        GmCXt.stopEventPropagation(e);
    };

    pub.close = function() {

        GmCXt.previewStepPopupInstance = null;

        window.removeEventListener('mouseout', stopEventPropagation, true);
        mg$('.mgPlayerJSProd_play-step-audio-iframe').remove();
        mg$('#mgPlayerJSProd_preview_step_popup_container').remove();

        mg$('.mgPlayerJSProd_play-step-audio').show();
        mg$('.mgPlayerJSProd_play-step-popup-close').show();
        mg$('.mgPlayerJSProd_play-total-step-cont').show();
        mg$('.mgPlayerJSProd_play-step-popup-s-num').show();

        //show start button
        GmCXt.displayWidget();

        if (GmCXt.alignPopupI) {
            GmCXt.alignPopupI.clear();
            GmCXt.alignPopupI = null;
        }
    };

    var attachDOMEvents = function() {
        if (self.playingTour === true) {
            if (document.getElementById('mgPlayerJSProd_play_step_popup_drag')) {
                document.getElementById('mgPlayerJSProd_play_step_popup_drag').addEventListener('touchmove', dragElementOnTouch);
            }
        }
    };

    var dragElementOnTouch = function(e) {
        let elmnt = document.getElementById("mgPlayerJSProd_preview-step-popup-container");

        let touch = event.targetTouches[0];

        // set the element's new position:
        elmnt.style.top = (touch.pageY - 24) + 'px';
        elmnt.style.left = (touch.pageX - (document.getElementById("mgPlayerJSProd_preview-step-popup-container").offsetWidth - 76)) + 'px';
        mg$(elmnt)
            .removeClass('top-left')
            .removeClass('top-middle')
            .removeClass('top-right')
            .removeClass('right-top')
            .removeClass('right-middle')
            .removeClass('right-bottom')
            .removeClass('bottom-left')
            .removeClass('bottom-middle')
            .removeClass('bottom-right')
            .removeClass('left-top')
            .removeClass('left-middle')
            .removeClass('left-bottom');
    };

    var blackoutIEViewPort = function(rect, opacity, cssPos) {
        if (!rect || !rect.length) return;
        if (opacity) opacity = opacity / 10;

        let cssPosition = "absolute";
        if (cssPos) {
            cssPosition = "fixed";
        }

        let overlayObj = mg$('.mgPlayerJSProd_screen-blackout');

        let html = "<wmgPlayerJSProd_over style='top:0px; " +
			"left:0px;" +
			"width:100%;" +
			"height: " + rect[0].top + "px;'>" +
			"</wmgPlayerJSProd_over>" +
			"<wmgPlayerJSProd_over style='top:" + rect[0].top + "px;" +
			"left: 0px;" +
			"width: " + rect[0].left + "px;" +
			"height: " + rect[0].height + "px;'>" +
			"</wmgPlayerJSProd_over>" +
			"<wmgPlayerJSProd_over style='top:" + rect[0].top + "px;" +
			"left: " + (rect[0].left + rect[0].width) + "px;" +
			"width: " + (mg$(window).width() - (rect[0].left + rect[0].width)) + "px;" +
			"height: " + rect[0].height + "px;'>" +
			"</wmgPlayerJSProd_over>" +
			"<wmgPlayerJSProd_over style='top:" + (rect[0].top + rect[0].height) + "px;" +
			"left:0px;" +
			"width:100%;" +
			"height: " + (mg$(document).height() - (rect[0].height + rect[0].top)) + "px;'>" +
			"</wmgPlayerJSProd_over>";

        overlayObj.html(html);

        mg$('.mgPlayerJSProd_screen-blackout').css({
            'top': 0,
            'left': 0,
            'width': '100%',
            'position': cssPosition
        }).show();
        mg$('wmgPlayerJSProd_over').css('opacity', opacity);
    };

    let setOnAudioMode = function() {
        GmCXt.playAudioTrack({
            audioTrack: self.audioTrack
        });
        GmCXt.setOnAudioMode();

        GmCXt.stepAudioRunningStatus = true;
        GmCXt.storage().set({
            'stepAudioRunningStatus': true
        });
    };

    let setOffAudioMode = function() {
        GmCXt.stopAudio();
        GmCXt.setOffAudioMode();
        GmCXt.stepAudioRunningStatus = false;
        GmCXt.storage().set({
            'stepAudioRunningStatus': false
        });
    };

    pub.forSalesforceCol = forSalesforceCol;
    pub.stopMouseOutEvent = stopMouseOutEvent;
    pub.stopEventPropagation = stopEventPropagation;
    pub.attachDOMEvents = attachDOMEvents;
    pub.dragElementOnTouch = dragElementOnTouch;
    pub.blackoutIEViewPort = blackoutIEViewPort;
    pub.setOnAudioMode = setOnAudioMode;
    pub.setOffAudioMode = setOffAudioMode;

    return pub;
};

/**
 * @file Guideme User guide module
 * @author Nilesh Pachpande
 */

GmCXt.userGuide = function(options) {

    options = options || {};
    let pub = {};

    let self = {
        highlightedArea: options.highlightedArea,
        type: options.type
    };

    function stepNotFound(stepTitle, stepImage, processedImage) {
        let popupType = 'mgPlayerJSProd_popup-info';
        let popupHeaderIcon = '<svg  width="24" height="24" viewBox="0 0 24 24" fill="none">' +
			'<circle cx="12" cy="12" r="11.1" stroke="white" stroke-width="1.8"/>' +
			'<rect x="11" y="11" width="2" height="9" rx="1" fill="white"/>' +
			'<circle cx="12" cy="7.5" r="1.5" fill="white"/>' +
			'</svg>';

        let popupTitle = GmCXt.label.elmNotFound;
        let info = "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-info'>" + GmCXt.label.elmNotFoundInfo + "</wmgPlayerJSProd_>";

        if (GmCXt.isWestpac()) {
            stepTitle = null;
            popupTitle = GmCXt.label.elmNotFoundWestpac;
            info = (processedImage) ?
                "<img class='mgPlayerJSProd_step-not-found-image' src='" + stepImage.split(".png")[0] + "_cropped.png" + GmCXt.getCdnSign() + "'>" :
                "<img class='mgPlayerJSProd_step-not-found-image' src='" + stepImage + "'>";
        }
        let str =
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_step-not-found-notification mgPlayerJSProd_popup mgPlayerJSProd_display-block " + popupType + "'> " +
			"       <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
			"	       	<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon'>" + popupHeaderIcon +
			"		   	</wmgPlayerJSProd_>" +
			"			</wmgPlayerJSProd_>" +
			"       </wmgPlayerJSProd_>" +
			"		<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper mgPlayerJSProd_font-size-17'>" + popupTitle + "</wmgPlayerJSProd_>" +
			(stepTitle ? ('   <wmgPlayerJSProd_ class="mgPlayerJSProd_no-element-guide-title">' + stepTitle + '</wmgPlayerJSProd_>') : '') + info +
			"		<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper mgPlayerJSProd_step-not-found-close-btn'>" +
			"			<wmgPlayerJSProd_ class='mgPlayerJSProd_btn-default mgPlayerJSProd_no-element-guide-ok mgPlayerJSProd_ok-btn mgPlayerJSProd_inline-block-vt'>" + GmCXt.label.close +
			"			</wmgPlayerJSProd_>" +
			"		</wmgPlayerJSProd_>" +
			" </wmgPlayerJSProd_> ";

        return str;
    }

    function attachDOMEvents() {
        mg$('.mgPlayerJSProd_no-element-guide-ok').on('click', function(e) {
            pub.close();
            e.stopPropagation();
        });

        mg$('.mgPlayerJSProd_overlay-container').on('click', function(e) {
            pub.close();
            e.stopPropagation();
        });

        mg$('.mgPlayerJSProd_step-not-found-notification').on('click', function(e) {
            e.stopPropagation();
        });
    }

    function hoverTipPlayStepGuide() {
        return "<ul>" +
			"<li>" + GmCXt.label.stepPlayIsdefinedPopover + "</li>" +
			"<li>" + GmCXt.label.kindlyHoverPopup + "</li>" +
			"</ul>";
    }

    function hoverTipEditStepGuide() {
        return "<ul>" +
			"<li>" + GmCXt.label.stepDefinedPopover + "</li>" +
			"<li>" + GmCXt.label.kindlyHoverPopup + "</li>" +
			"</ul>";
    }

    pub.open = function(stepTitle, stepImage, processedImage, number, stepId, rca, elAttributes) {
        if (self.type === 'step_not_found') {
            if (mg$("body").find('.mgPlayerJSProd_overlay-container').length === 0) {
                mg$("<wmgPlayerJSProd_></wmgPlayerJSProd_>").addClass('mgPlayerJSProd_overlay-container').appendTo('body');
            }
            let overlay = mg$(".mgPlayerJSProd_overlay-container").empty();
            overlay.append(stepNotFound(stepTitle, stepImage, processedImage)).show();

        } else if (self.type === 'hoverTipEditStepGuide') {
            if (mg$("body").find('.mgPlayerJSProd_user-tip-guide-container').length === 0) {
                mg$("<wmgPlayerJSProd_></wmgPlayerJSProd_>").addClass('mgPlayerJSProd_user-tip-guide-container').appendTo('body');
            }
            mg$(".mgPlayerJSProd_user-tip-guide-container").empty().append(hoverTipEditStepGuide()).show();

            /**
			 * Align popup
			 */
            GmCXt.alignPopup({
                popup: mg$(".mgPlayerJSProd_user-tip-guide-container"),
                highlightedArea: self.highlightedArea[0]
            }).start();

        } else if (self.type === 'hoverTipPlayStepGuide') {
            if (mg$("body").find('.mgPlayerJSProd_user-tip-guide-container').length === 0) {
                mg$("<wmgPlayerJSProd_></wmgPlayerJSProd_>").addClass('mgPlayerJSProd_user-tip-guide-container').appendTo('body');
            }
            mg$(".mgPlayerJSProd_user-tip-guide-container").empty().append(hoverTipPlayStepGuide()).show();

            /**
			 * Align popup
			 */
            GmCXt.alignPopup({
                popup: mg$(".mgPlayerJSProd_user-tip-guide-container"),
                highlightedArea: self.highlightedArea[0]
            }).start();
        }

        attachDOMEvents();
    };

    pub.close = function() {
        mg$('.mgPlayerJSProd_overlay-container').hide().empty();
        mg$('.mgPlayerJSProd_user-guide-container').hide().empty();
        mg$('.mgPlayerJSProd_user-tip-guide-container').hide().empty();
        if (self.type === 'hoverTipPlayStepGuide') {
            GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:stop_dom_highlighter", {});
        }
    };

    return pub;
};
/**
	* @file Guideme tour player module
	* @author Nilesh Pachpande
	*/
GmCXt.playedPreviousSteps = [];
GmCXt.elLookupTime = GmCXt.isWestpac() ? GmCXt.t.elLookupTime10s : GmCXt.t.elLookupTime30s;

GmCXt.tourPlayer = function(data) {

    let pub = {};

    GmCXt.playerI.mode = GmCXt.playerI.mode || 'live';
    GmCXt.playerI.type = GmCXt.playerI.type || 'live';
    GmCXt.playerI.currentStepId = GmCXt.playerI.currentStepId || 0;
    GmCXt.log(33, "Current Step ID Updated(Fn: tourPlayerInit):" + GmCXt.playerI.currentStepId);
    GmCXt.playerI.totalStepCount = parseInt(GmCXt.playerI.tour.step_count);

    if (!GmCXt.playerI.playNextBranch &&
		(GmCXt.playerI.currentLoop === undefined || !(GmCXt.playerI.currentLoop && GmCXt.playerI.currentLoop > 0))) {
        GmCXt.playerI.playStructure = [];
        if (GmCXt.playerI.tour) {
            updatePlayStructure(GmCXt.playerI.tour);
        }
    }

    let self = {
        maxWait: 500,
        ready: true,
        status: null,
        DOM_WAITING: 100,
        DOM_SUCCESS: 200,
        DOM_FAILURE: 300,
        ATTR_CLS_FAILURE: 400,
        isDeskReq: data ? data.isDeskReq : null,
        windowHostNamePath: GmCXt.getPageHostPathName(),
        windowHost: GmCXt.getPageDomain()
    };

    let tourSetting = GmCXt.playerI.tour.tour_settings;
    let tourStepSetting = tourSetting.step_settings;
    let delayChecked = false;

    pub.isLastStepVisible = true;

    if (GmCXt.playerI.isAutomation) {
        GmCXt.playerI.automate = true;
        GmCXt.playerI.manual = false;
        GmCXt.playerI.initiator = 'doitforme';
    } else if (GmCXt.playerI.testAutomation) {
        GmCXt.playerI.automate = true;
        GmCXt.playerI.manual = false;
    } else if (GmCXt.playerI.initiator === 'doitforme') {
        GmCXt.playerI.manual = false;
    } else {
        GmCXt.playerI.manual = true;
    }

    if (GmCXt.playerI.origin === "keypress")
        GmCXt.playerI.keyShorts = true;
    else
        GmCXt.playerI.keyShorts = false;

    pub.triggerMyGuideClickMouseDown = function(ev) {
        // prevent blur event that takes focus off of forms etc & collapses/closes the section as a result
        ev.preventDefault();
    };

    pub.triggerMyGuideClick = function(idName, ev) {
        ev.stopPropagation();
        switch (idName) {
        case 'mgPlayerJSProd_play_step_pause_classic':
        case 'mgPlayerJSProd_play_step_pause':
        case 'mgPlayerJSProd_play-step-pause-svg':
            stopAutomation();
            break;

        case 'mgPlayerJSProd_play_step_next':
        case 'mgPlayerJSProd_play_step_next_classic':
            playNxtStep(ev);
            break;

        case 'mgPlayerJSProd_play_step_prev':
        case 'mgPlayerJSProd_play_step_prev_classic':
            pub.playPreviousStep(ev);
            break;

        case 'mgPlayerJSProd_play_step_popup_close':
        case 'mgPlayerJSProd_play_step_next_done':
        case 'mgPlayerJSProd_play_step_next_done_classic':
        case 'mgPlayerJSProd_play-step-popup-close-svg':
            playStepPopupCloseButtonClickEvent();
            break;

        case 'mgPlayerJSProd_play_step_popup_edit':
        case 'mgPlayerJSProd_play-step-popup-edit-icon':
            editStepFromPopUp();
            break;
        }
    };

    pub.start = function() {

        if (GmCXt.isAutomationRunning()) {
            GmCXt.auto.showProgress();
        }
        GmCXt.log(33, "Guide player started");

        if (GmCXt.playerI && GmCXt.playerI.initiator === "urlTour") {
            GmCXt.isPageReloaded = true;
        }

        window.addEventListener("mouseup", GmCXt.registerClickListner, true);
        window.addEventListener("mousedown", GmCXt.registerClickListner, true);
        window.addEventListener("keyup",
            function(e) {
                if (e.keyCode === 13) {
                    GmCXt.registerClickListner(e);
                }
            }, true);
        window.addEventListener("keydown", function(e) {
            if (e.keyCode === 13) {
                GmCXt.registerClickListner(e);
            }
        }, true);

        GmCXt.storage().set({
            'loopingCompleted': false
        });

        if (GmCXt.playerI.isAutolaunch) {
            GmCXt.setAutoTour(GmCXt.playerI.tour.tour_id);
        } else {
            GmCXt.setAutoTour(0);
        }

        if (GmCXt.playerI.currentLoop === undefined || !(GmCXt.playerI.currentLoop && GmCXt.playerI.currentLoop > 0)) {
            updatePlayStructure(GmCXt.playerI.tour);
        }

        GmCXt.log(33, "Guide play structure", GmCXt.playerI.playStructure);

        if (!GmCXt.playerI.currentStepId) {

            let firstStepId = GmCXt.getFirstStepId();
            if (firstStepId) {
                GmCXt.playerI.currentStepId = firstStepId;
                GmCXt.log(33, "Current Step ID Updated(Fn: pub.start):" + GmCXt.playerI.currentStepId);

                if (!GmCXt.playerI.startStepId) {
                    GmCXt.playerI.startStepId = GmCXt.playerI.currentStepId;
                }

            } else if (!GmCXt.isDesktop()) {
                GmCXt.cleanPlayer();
                return true;
            }

        }

        checkPreviousStepIsHoverStep();

        function hideBeaconsAndTips() {
            GmCXt.hideBeacons();
            GmCXt.hideSmartTipsIfOptionON();
            mg$(document).off('keydown').on('keydown', keydownEventListener);
        }

        if (GmCXt.playerI.guideState === 'pause') {
            GmCXt.pauseGuide();
            hideBeaconsAndTips();
        } else {

            let appDomainMatch = getMatchDomain();

            if (!GmCXt.playerI) return;

            let tourSetting = GmCXt.playerI.tour.tour_settings;

            if (!appDomainMatch && GmCXt.isFQDN()) {
                GmCXt.log(33, "Domain mismatch. Stop guide play.");
                hideBeaconsAndTips();
                return;
            } else if (GmCXt.playerI) {
                // PlayerI might not be available due to user interruption while automation.
                playStep(GmCXt.playerI.currentStepId);
            }
        }
    };

    function getMatchDomain() {
        GmCXt.log(33, "Matching domain:");
        let match = false;

        if (!GmCXt.playerI) {
            return;
        }
        let tour = GmCXt.playerI.tour;

        if (tour.allDomains && tour.allDomains.length > 0) {

            if (GmCXt.isElectron()) {
                var d = GmCXt.getCurrentMyGuideApp(tour.allDomains);
            } else {
                var d = GmCXt.findDomainMatch(tour.allDomains, GmCXt.urlParts.fullUrl);
            }
            if (!GmCXt.isEmpty(d)) {
                match = true;
            }

        } else {
            match = true;
        }
        GmCXt.log(33, "Match Result: " + match);
        return match;
    }

    pub.stop = function(forceClose, keepUserGuide) {

        let pi = GmCXt.playerI;

        if (GmCXt.playerI) {
            step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

            if(forceClose || keepUserGuide){
                let resumeStepId = forceClose ? step.step_id : GmCXt.getPreviousStepId(step.step_id);
                GmCXt.tourActivity['t:' + pi?.tour?.tour_id] = resumeStepId;
            }
           

            if (GmCXt.FT.isPlayer && !GmCXt.taskListOpen) {
                GmRootScope.setPlayedStepsInfo(step);
            }

            if (step && (step.step_type === "video" || step.step_type === "image")) {
                GmCXt.removeVideoPlayer();
            }
        }

        if (GmCXt.isAutomationRunning()) {
            if (GmCXt.playerI.isPageReloadByLastStep) {
                return;
            } else if (GmCXt.playerI.currentBranchIndex !== undefined && !forceClose) {
                let node = getNode(GmCXt.playerI.currentBranchStep.step_id);
                let tail_ = node.branch[GmCXt.playerI.currentBranchIndex].tail;

                let s = findFirstNonAutoStepInBranch(tail_);
                GmCXt.auto.branchPlaySuccess(s.step_id, function() {
                    GmCXt.playerI.currentBranchIndex++;
                    GmCXt.playerI.playNextBranch = true;

                    GmCXt.storage().set({
                        'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
                        'guide_play_event': GmCXt.guidePlayTracker
                    });

                    let tour = GmCXt.playerI.tour;
                    window.location = GmCXt.getRedirectUrlForAuto(GmCXt.playerI.currentBranchStep.step_url, tour);
                });
                return;
            }
        }
        let initiator = pi.initiator;
        let jobId = pi.currentStepId;

        let isTourCompleted = pi.completeEventTracked;

        if (initiator) isTourCompleted = false;

        clearTimeouts();

        hideWaitMsg();

        GmCXt.restartInParent(true);

        GmCXt.hideResumePopup();
        GmCXt.storage().get(['botTourPlayList']).then(function(tList) {
            if (tList && tList.botTourPlayList && tList.botTourPlayList.length && pi && pi.tour) {
                for (let i = 0; i < tList.botTourPlayList.length; i++) {

                    if (tList.botTourPlayList[i].tour_id === pi.tour.tour_id) {
                        nextTourPlayed = tList.botTourPlayList[i + 1];
                        if (nextTourPlayed) {
                            let completeURL = '';
                            if (!nextTourPlayed.tour_url.startsWith('http')) {
                                completeURL = location.protocol + '//' + nextTourPlayed.tour_url;
                            } else {
                                completeURL = nextTourPlayed.tour_url;
                            }
                            GmCXt.log(33, "REDIRECTING TO URL - ", {
                                URL: completeURL
                            });
                            GmCXt.redirect(completeURL);

                            let msg = {
                                tour: nextTourPlayed,
                                source: 'bot',
                                automate: true,
                                initiator: 'doitforme',
                                type: 'doitforme'
                            };

                            GmCXt.showToastMsg(GmCXt.label.playNextBotTour);
                            GmCXt.timeout(GmCXt.requestHandler.playGuide(msg), 5000);

                        }
                        break;
                    }
                }
            }
        });

        if (GmCXt.isDesktop()) {
            GmCXt.log(74, 'Close guide play');
            GmCXt.sendMessageToDesktop({
                requestId: 10000,
                requestType: 'closeGuidePlay',
                errCode: 1000
            });
        }

        GmCXt.cleanPlayer();

        pub.closeStep(jobId, keepUserGuide);

        onCloseTour(initiator, forceClose);

        if (GmCXt.isPlayer()) {
            if (((GmCXt.isEmpty(GmCXt.onScreenTooltipGuideIds) || !GmCXt.onScreenTooltipGuideIds.length) &&
					(GmCXt.isEmpty(GmCXt.beaconsOnScreen) || !GmCXt.beaconsOnScreen.length)) || GmCXt.notificationGuides) {
                GmCXt.getContextGuides("Guide play complete");
            }

            GmCXt.showSmartTips();
            GmCXt.showBeacons();
        }

    };

    function updatePlayedTours(tour_id) {
        let PI = GmCXt.playerI;

        if (GmCXt.playedTour.indexOf(tour_id) === -1 &&
			(PI.totalStepCount === 1 || PI.startStepId !== PI.currentStepId)) {

            GmCXt.playedTour.push(tour_id);
            GmCXt.storage().set({
                'playedTour': GmCXt.playedTour
            });
        }
    }

    pub.closeGuide = function(forceClose, fromShowme) {

        GmCXt.failedStepId = 0;

        let pi = GmCXt.playerI;
        let step = GmCXt.getCurrentStep(pi.currentStepId);
        let tour = pi.tour;
        let ti = GmCXt.tourPlayerI;

        if (self.completionTimeout) {
            clearTimeout(self.completionTimeout);
        }

        if (GmCXt.isLastStep(pi.currentStepId, pi.playStructure)) {
            updatePlayedTours(tour.tour_id);
            GmCXt.markAutoLaunchTourDoNotShow(tour);
        } else if (GmCXt.FT.isPlayer) {

            GmCXt.tourActivity['t:' + pi.tour.tour_id] = pi.lastPlayedStepId;
        }

        if (GmCXt.autoTrigger) {
            clearTimeout(GmCXt.autoTrigger);
        }

        if (step) {
            let completeEventTracked = (pi.completeEventTracked) ? true : false;

            if (!completeEventTracked) {
                let o = {
                    tour: pi.tour,
                    stepId: pi.currentStepId,
                };

                if (step.step_type == GmCXt.STEP_TYPE_INLINE && !GmCXt.isTrue(step.step_settings.inlineBranch)) {
                    o.type = "Inline Step";
                } else if (step.step_type == GmCXt.STEP_TYPE_IMAGE) {
                    o.type = "Image Step";
                }
            }

            if (GmCXt.getTail(pi.currentStepId, pi.playStructure) === null) {
                toggle();
            }
        }
        GmCXt.stopAudio();

        if (!fromShowme) {
            GmCXt.getSurveyScreen(GmCXt.createDeepCopy(pi));
        }

        // Handle task completion tracking
        if (pi.taskObj && pi.completeEventTracked && !pi.taskObj.isComplete) {
            // Mark guide as complete when played from task list
            const taskData = {
                taskListId: pi.taskObj.taskId,
                tourId: pi.tour.tour_id,
                complete_count: pi.taskObj.complete_count,
                total_count: pi.taskObj.total_count
            };
            GmRootScope.markTaskGuideComplete(taskData);
        } else if (GmCXt.isPlayer() && pi.completeEventTracked && GmCXt.taskListCount > 0) {
            // Mark guide as complete when played outside task list but exists in task list
            const tourData = {
                tourId: tour.tour_id
            };
            GmRootScope.markTaskGuideCompletePlayedOutside(tourData);
        }

        ti.stop(forceClose);

        mg$('.mgPlayerJSProd_image-step-prev').remove();
        mg$('.mgPlayerJSProd_image-step-next').remove();
        mg$('.mgPlayerJSProd_image-step-done').remove();

        if (step.step_type === "video" || step.step_type === "image") {
            GmCXt.removeVideoPlayer();
        }
        if (!GmCXt.isAutomationRunning()) {
            let data = {
                terminate: true
            };
            GmCXt.closeMediaPlayer(data);
        }
    };

    function redirectTour(tourSetting) {

        GmCXt.storage().set({
            'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
            'guide_play_event': GmCXt.guidePlayTracker
        }).then(function() {
            if (GmCXt.playerI.testAutomation) {
                if (!showStepRedirect(tourSetting)) {
                    let msg = 'Guide Rules Not Matched.';
                    if (GmCXt.playerI.stepRuleMatch === false) {
                        msg = 'Step Rules Not Matched.';
                    }
                    let s = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
                    GmCXt.auto.fail(s, {
                        errorMessage: msg
                    });
                } else {
                    GmCXt.changeUrl(getStepUrl(), GmCXt.playerI.tour);
                }
            } else if (GmCXt.playerI.loops) {
                //For CSV file reading
                GmCXt.changeUrl(getStepUrl(), GmCXt.playerI.tour);
            } else {
                if (!showStepRedirect(tourSetting)) {
                    GmCXt.cleanPlayer();
                }
            }
        });

    }

    function updatePlayStructure(tour) {

        let playStructure = GmCXt.getGuidePlayStructure(tour);

        if (GmCXt.isDesktop()) {
            playStructure = tour.steps[0].playStructure;
        }

        GmCXt.playerI.playStructure = playStructure;

    }

    function checkPreviousStepIsHoverStep() {
        if (GmCXt.playerI.currentStepId &&
			(GmCXt.playerI.lastPlayedStepId || GmCXt.playerI.lastPlayedStepId === undefined) &&
			(GmCXt.playerI.currentStepId !== GmCXt.playerI.lastPlayedStepId) &&
			(GmCXt.checkPreviousHoverStep === true)) {

            GmCXt.checkPreviousHoverStep = false;

            let previousStepId = GmCXt.playerI.lastPlayedStepId;
            if (!previousStepId) {
                previousStepId = GmCXt.getPreviousStepId(GmCXt.playerI.currentStepId);
            }

            let previousStep = GmCXt.createDeepCopy(GmCXt.getStepFromPlayerI(previousStepId));

            if (previousStep && !GmCXt.isEmpty(previousStep)) {

                if (previousStep.step_settings.hoverNext) {
                    let windowHost = GmCXt.getPageDomain();
                    let previousStepUrlHost = GmCXt.getDomain(previousStep.step_url);

                    if (previousStepUrlHost == windowHost) {
                        GmCXt.playerI.currentStepId = previousStepId;
                        GmCXt.log(33, "Current Step ID Updated(Fn: checkPreviousStepIsHoverStep):" + GmCXt.playerI.currentStepId);
                        GmCXt.showTooltipOnPreviousHoverStep = true;
                    }
                }
            }

        }
    }

    function onCloseTour(initiator, forceClose) {

        if (initiator === 'automation') {
            if (forceClose) {
                GmCXt.auto.stop(true);
            } else {
                GmCXt.auto.onCloseTour();
            }
        }

        mg$('.mgPlayerJSProd_highlighter-span').remove();
        mg$('.mgPlayerJSProd_image-step-screen').remove();
    }

    pub.playNextStep = function(isAutomationSuccess) {
        if (isAutomationSuccess) {
            self.ready = true;
        }
        pub.closeStep();
        playNxtStep();
    };

    pub.closeStep = function(jobId, keepUserGuide) {

        if (GmCXt.playerI) jobId = GmCXt.playerI.currentStepId;
        let step = {};

        if (GmCXt.playerI) {
            step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        }

        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:stop_dom_highlighter", { jobId });
        if(window.self === window.top) {
            GmCXt.highlighter.unqueue({ jobId });
        }

        GmCXt.stopAudio();

        if (GmCXt.userGuideInstance && !keepUserGuide) {
            GmCXt.userGuideInstance.close();
        }

        if (GmCXt.previewStepPopupInstance) {
            GmCXt.previewStepPopupInstance.close();

        }

        if (!GmCXt.isEmpty(GmCXt.highlight_elements)) {
            delete GmCXt.highlight_elements;
        }

        GmCXt.removeScreenOverlay();
        mg$('.mgPlayerJSProd_step-tooltips').remove();
        mg$('.mgPlayerJSProd_highlighter-span').remove();
        let currStepData = false;

        if (self.prevEvent) {
            currStepData = GmCXt.getPreviousStep();
        } else {
            currStepData = GmCXt.getNextStep();
        }

        if (currStepData && currStepData.step_type !== 'image') {
            mg$('.mgPlayerJSProd_image-step-screen').remove();
        }
        mg$('#mgPlayerJSProd_image_popup').hide();
        mg$('.mgPlayerJSProd_image-step-prev').remove();
        mg$('.mgPlayerJSProd_image-step-next').remove();
        mg$('.mgPlayerJSProd_image-step-done').remove();

        if (step && (step.step_type === "video" || step.step_type === "image")) {
            GmCXt.removeVideoPlayer();
        }
        if (!GmCXt.isAutomationRunning) {
            let data = {
                terminate: GmCXt.playerI ? false : true
            };
            GmCXt.closeMediaPlayer(data);
        }

        GmCXt.unlockScroll();

    };

    pub.setStepCompletionTimeout = function(step) {

        if (step && !step.step_settings)
            return true;

        // Close current step after 4 sec
        if (step.step_settings.closeAfterDelay) {
            let closeTimeout = GmCXt.t.stepComplition;

            if (step.step_settings.completionTime) {
                closeTimeout = parseInt(step.step_settings.completionTime) * 1000;
                closeTimeout = (closeTimeout) ? closeTimeout : GmCXt.t.stepComplition;
            }

            if (closeTimeout) {
                self.completionTimeout = GmCXt.timeout(function() {
                    if (mg$('.mgPlayerJSProd_popup').length === 0 &&
						mg$('.mgPlayerJSProd_survey-popup-container').length === 0) {
                        playNxtStep();
                    } else {
                        pub.setStepCompletionTimeout(step);
                    }
                }, closeTimeout);
            }
        }
    };

    function keydownEventListener(e) {
        if (!GmCXt.playerI)
            return true;

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let elem = {};

        if (step) {
            elem = step.step_settings.element;
            if (elem && elem.selector && elem.selector.js) {
                elem.tagName = GmCXt.getTagName(elem.selector.js[0]);
            }
        }

        function cb() {
            GmCXt.stopAudio();
            pub.stop();
        }

        if (e.which === 27) {
            // escape key pressed
            if (isNotLastStep() && GmCXt.isExitSurvey() && GmCXt.isPlayer()) {
                GmCXt.showExitSurvey();
            }
            cb();
        }
    }

    var isNotLastStep = function() {
        if (GmCXt.getTail(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure) !== null)
            return true;
        else
            return false;
    };

    function playNextStepWrapper(stepId) {
        if (GmCXt.playerI && GmCXt.playerI.currentStepId === stepId)
            playNxtStep();
    }

    function playNxtStep(e) {

        if (GmCXt.isDesktop()) {
            let reqType = 'playNextStep';
            GmCXt.log(74, reqType);
            desktopPlaySteps(reqType);
        }

        if (mg$('.mgPlayerJSProd_popup-info') && mg$('.mgPlayerJSProd_popup-info').length) return true;
        self.prevEvent = false;

        let pi = GmCXt.playerI;

        if (!pi) return true;

        GmCXt.markAutoLaunchTourDoNotShow(pi.tour);

        if (self.completionTimeout)
            clearTimeout(self.completionTimeout);

        if (self.ready === true) {
            GmCXt.log(33, "playNextStep event, lastStepId: " + pi.currentStepId);

            let nextStepId = GmCXt.getTail(pi.currentStepId, pi.playStructure, e);
            let nextStep = getStepFromTour(nextStepId, pi.tour);

            if (GmCXt.isAutomationRunning()) {

                if (!GmCXt.isAutomationStep(nextStep) && GmCXt.playerI.runningBranchDecisionAutoSteps === true) {
                    GmCXt.playerI.runningBranchDecisionAutoSteps = false;
                    playStep(pi.currentBranchStep.step_id);
                    return;
                }

                if (GmCXt.checkForBranchVariationSteps(nextStep)) {
                    GmCXt.playerI.runningBranchDecisionAutoSteps = true;
                }
            }

            GmCXt.log(33, "playNextStep event, nextStepId: " + nextStepId);

            if (nextStepId) {
                self.ready = false;

                pub.closeStep();

                GmCXt.timeout(function() {
                    playStep(nextStepId);
                }, self.maxWait);

            } else if (GmCXt.isLastStep(pi.currentStepId, pi.playStructure)) {

                if (pi.loops) {
                    GmCXt.log(33, 'Tour Loop: ' + (pi.currentLoop + 1) + ' completed.');
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:tour_loop_completed');

                } else {
                    GmCXt.tourPlayerI.closeGuide();
                }
            }
        }

        mg$('.mgPlayerJSProd_image-step-prev').remove();
        mg$('.mgPlayerJSProd_image-step-next').remove();
        mg$('.mgPlayerJSProd_image-step-done').remove();
    }

    pub.playPreviousStep = function(e) {
        if (GmCXt.isDesktop()) {
            let reqType = 'playPreviousStep';
            GmCXt.log(74, reqType);
            desktopPlaySteps(reqType);
        }

        self.prevEvent = true;

        if (GmCXt.getTail(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure) === null) {
            toggle();
        }

        if (!GmCXt.playerI) return true;

        if (self.ready === true) {

            let previousStepId = GmCXt.getPreviousStepId(GmCXt.playerI.currentStepId);

            GmCXt.log(33, "playPreviousStep event, previousStepId: " + previousStepId);

            if (previousStepId) {
                self.ready = false;
                pub.closeStep();

                GmCXt.timeout(function() {
                    playStep(previousStepId);
                }, self.maxWait);
            }

            mg$('.mgPlayerJSProd_image-step-prev').remove();
            mg$('.mgPlayerJSProd_image-step-next').remove();
            mg$('.mgPlayerJSProd_image-step-done').remove();
        }
    };

    function stopAutomation() {
        if (GmCXt.playerI) {
            GmCXt.playerI.automate = false;
            GmCXt.playerI.pauseAutomate = true;
            GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:update_player_instance_app');
        }
        hideAutoIndicator();
        hideStopButton();

        if (GmCXt.autoTrigger) {
            clearTimeout(GmCXt.autoTrigger);
        }

        showNagivation();

        //show next button
        if (hasNextStep()) {
            showNextButton();
            hideDoneButton();
        }

        let currStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let ss = currStep.step_settings;
        showPrevBtnToggle(ss);
    }

    function branchDecicisionPopUp(opt) {
        let ob = {};

        function selectBranchType() {
            let html = '';

            mg$.each(opt.branch, function(index, branch) {
                html +=
					'<wmgPlayerJSProd_ branchIndex="' + index + '" class="mgPlayerJSProd_branching-decision-step">' +
					'<wmgPlayerJSProd_ branchIndex="' + index + '"  class="mgPlayerJSProd_tour-details-small-thumbnails-wrapper mgPlayerJSProd_inline-block-vm" ' +
					'class="mgPlayerJSProd_branching-decision-step-value">' +
					'<wmgPlayerJSProd_ branchIndex="' + index + '"  class="mgPlayerJSProd_tour-title-small-thumbnails mgPlayerJSProd_font-size-16">' + GmCXt.escapeHtml(branch.branchName) + '</wmgPlayerJSProd_>' +
					'</wmgPlayerJSProd_>';

                if (branch.branchDesc) {
                    html += '<wmgPlayerJSProd_ class="mgPlayerJSProd_position-relative mgPlayerJSProd_show-text-tooltip">' + '<wmgPlayerJSProd_ branchIndex="' + index + '"  class="mgPlayerJSProd_branching-decision-branch-desc mgPlayerJSProd_font-size-12">' + GmCXt.escapeHtml(branch.branchDesc) + '</wmgPlayerJSProd_>' +
						'<wmgPlayerJSProd_ class="mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-left">' +
						'<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">' + branch.branchDesc + '</wmgPlayerJSProd_>' +
						'</wmgPlayerJSProd_>' + '</wmgPlayerJSProd_>';
                }
                html += '</wmgPlayerJSProd_>';
            });
            return html;
        }

        ob.show = function() {
            title = GmCXt.label.branchStepMessagePopup;
            let isOpacity = true;
            if (opt && opt.step && opt.step.step_title) {
                title = opt.step.step_title;
                isOpacity = GmCXt.isDefined(opt.step.step_settings.branchOpacity) ? opt.step.step_settings.branchOpacity : true;
            }

            let html =
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-outer'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup mgPlayerJSProd_branching-decision-popup'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-title '>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_branching-decision-title'>" + title + "</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-popup-drag-icon' class='mgPlayerJSProd_span mgPlayerJSProd_branching-drag'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_branching-decision-close mgPlayerJSProd_inline-block-vm'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_inline-block-vm'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_span' id='mgPlayerJSProd_branching-decision-close-svg'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-title'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-content mgPlayerJSProd_branching-decision-content mgPlayerJSProd_no-padding'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_branching-decision-content-wrapper'>" +
				selectBranchType() +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";

            mg$("body").append(html);
            if (opt.branch.length > 5) {
                mg$('.mgPlayerJSProd_branching-decision-content-wrapper').css({
                    'overflow-y': 'auto'
                });
            }

            mg$(".mgPlayerJSProd_panel-popup-outer").css('height', mg$(document).height());
            if (!isOpacity) {
                mg$(".mgPlayerJSProd_panel-popup-outer").css('display', 'none');
            }

            mg$("#mgPlayerJSProd_branching-decision-close-svg").html(GmCXt.svgs.popup_close);
            mg$("#mgPlayerJSProd_play-step-popup-drag-icon").html(GmCXt.svgs.popup_drag);

            mg$(".mgPlayerJSProd_branching-decision-step").on("click", function(e) {
                if (mg$.isFunction(opt.callback))
                    opt.callback(e);
            });

            mg$(".mgPlayerJSProd_branching-decision-close").on("click", function() {
                ob.close();
                if (GmCXt.firstStepAutoLaunch()) {
                    GmCXt.showAutoLaunchCloseOptions(GmCXt.playerI.tour);
                }
                pub.stop();
            });

            let elmnt = document.getElementsByClassName('mgPlayerJSProd_branching-decision-popup')[0];
            let dragEl = document.getElementById('mgPlayerJSProd_play-step-popup-drag-icon');

            GmCXt.attachDragEvents(elmnt, dragEl);
        };

        ob.close = function() {
            mg$(".mgPlayerJSProd_panel-popup").remove();
            mg$(".mgPlayerJSProd_panel-popup-outer").remove();
        };

        return ob;
    }

    function transportDecicisionPopUp(opt) {
        let ob = {};

        ob.show = function() {
            title = "";
            let isOpacity = true;
            if (opt && opt.step && opt.step.step_title) {
                title = opt.step.step_title;
                isOpacity = true;
            }

            let html =
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-outer'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup mgPlayerJSProd_branching-decision-popup'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-title '>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_branching-decision-title'>" + title + "</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-popup-drag-icon' class='mgPlayerJSProd_span mgPlayerJSProd_branching-drag'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_branching-decision-close mgPlayerJSProd_inline-block-vm'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_inline-block-vm'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_span' id='mgPlayerJSProd_branching-decision-close-svg'></wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-title'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_panel-popup-content mgPlayerJSProd_branching-decision-content mgPlayerJSProd_no-padding'>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_branching-decision-content-wrapper'>" +
				"<wmgPlayerJSProd_ id='mgPlayerJSProd_trans-redirection' class='mgPlayerJSProd_branching-decision-step'>" +
				"<wmgPlayerJSProd_ class= 'mgPlayerJSProd_tour-details-small-thumbnails-wrapper mgPlayerJSProd_inline-block-vm mgPlayerJSProd_branching-decision-step-value'> " +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_tour-title-small-thumbnails mgPlayerJSProd_font-size-16'>" +
				GmCXt.label.tranportURlRedirectionConfirm +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_ext-link-icon'>" +
				GmCXt.svgs.iconExternalLink +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"<wmgPlayerJSProd_ id='mgPlayerJSProd_guide-continue' class='mgPlayerJSProd_branching-decision-step'>" +
				"<wmgPlayerJSProd_ class= 'mgPlayerJSProd_tour-details-small-thumbnails-wrapper mgPlayerJSProd_inline-block-vm mgPlayerJSProd_branching-decision-step-value'> " +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_tour-title-small-thumbnails mgPlayerJSProd_font-size-16'>" +
				GmCXt.label.guideContinueConfirm +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";

            mg$("body").append(html);


            mg$(".mgPlayerJSProd_panel-popup-outer").css('height', mg$(document).height());
            if (!isOpacity) {
                mg$(".mgPlayerJSProd_panel-popup-outer").css('display', 'none');
            }

            mg$("#mgPlayerJSProd_branching-decision-close-svg").html(GmCXt.svgs.popup_close);
            mg$("#mgPlayerJSProd_play-step-popup-drag-icon").html(GmCXt.svgs.popup_drag);

            mg$("#mgPlayerJSProd_trans-redirection").on("click", function(e) {
                GmCXt.playerI.lastPlayedStepId = GmCXt.playerI.currentStepId;
                GmCXt.recordGuideEvents();
                GmCXt.storage().set({
                    'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
                    'guide_play_event': GmCXt.guidePlayTracker
                }).then(function() {
                    if(opt?.step?.step_settings?.transportStepMode === "new_tab") {
                        window.open(opt.step.step_settings.transport_url, "_blank");
                    } else {
                        window.open(opt.step.step_settings.transport_url, "_self").focus(); 
                    }
                    ob.close();
                });
            });

            mg$("#mgPlayerJSProd_guide-continue").on("click", function(e) {
                transportCB();
                ob.close();
            });

            mg$(".mgPlayerJSProd_branching-decision-close").on("click", function() {
                transportCB();
                ob.close();
            });

            let elmnt = document.getElementsByClassName('mgPlayerJSProd_branching-decision-popup')[0];
            let dragEl = document.getElementById('mgPlayerJSProd_play-step-popup-drag-icon');

            GmCXt.attachDragEvents(elmnt, dragEl);
        };

        ob.close = function() {
            mg$(".mgPlayerJSProd_panel-popup").remove();
            mg$(".mgPlayerJSProd_panel-popup-outer").remove();
        };

        return ob;
    }

    function findFirstNonAutoStepInBranch(id) {
        if (!id) {
            return;
        }
        let s = GmCXt.getStepFromPlayerI(id);
        if (!GmCXt.isAutomationStep(s)) {
            return s;
        }
        let playStructure = GmCXt.playerI.playStructure;

        for (let i = 0; i < playStructure.length; i++) {
            if (parseInt(playStructure[i].id) === parseInt(id)) {
                let node = playStructure[i];
                s = GmCXt.getStepFromPlayerI(node.tail);
                if (GmCXt.isAutomationStep(s)) {
                    return findFirstNonAutoStepInBranch(s.step_id);
                } else {
                    return s;
                }
            }
        }
    }

    function isVariableExistInBranchs(branch) {
        for (let i = 0, j = branch.length; i < j; i++) {
            for (let k = 0, l = branch[i].rulesEngine.length; k < l; k++) {
                if (branch[i].rulesEngine[k].type === 'Variables') {
                    return true;
                }
            }
        }
        return false;
    }

    function playBranchStep(step) {

        if (GmCXt.isStepInlineBranch(step)) {
            playInlineStep();
            return;
        }

        GmCXt.log(33, 'Play Branching Step');

        let branch = step.step_settings.branch;
        let counter = 0;
        let isVariableExistInBranch = isVariableExistInBranchs(branch);

        function validate() {
            if (isVariableExistInBranch) {
                GmCXt.timeout(function() {
                    validateRule();
                }, GmCXt.t.checkVariable);
            } else {
                validateRule();
            }
        }

        let onValidation = function(r) {
            GmCXt.log(33, "Rule validation response received for branch " + r.branchIndex + " " + r.valid);

            if (r.valid) {
                branch[r.branchIndex].valid = true;
            }
        };

        function clear() {
            clearInterval(ruleInterval);
        }

        function updatePlayStructureIfErrHandler(step_id) {
            let PS = GmCXt.playerI.playStructure;
            for (let ind in PS) {
                if (PS[ind].id === step_id) {
                    PS[ind].tail = step.step_id;
                    break;
                }
            }
        }

        let goToBranch = function(index) {
            clear();
            if (!GmCXt.playerI) {
                return;
            }

            let node = getNode(GmCXt.playerI.currentStepId);
            let tail_ = node.branch[index].tail;
            let testingBranchIndex = GmCXt.playerI.currentBranchIndex;

            let s = findFirstNonAutoStepInBranch(tail_);
            if (index !== testingBranchIndex && GmCXt.isAutomationRunning()) {
                tail_ = node.branch[testingBranchIndex].tail;
                s = findFirstNonAutoStepInBranch(tail_);
                GmCXt.auto.branchPlayFailed(s);
                return;
            }

            if (s) {
                if (index === 1 && step.step_type === GmCXt.STEP_TYPE_ERROR_HANDLER) {
                    updatePlayStructureIfErrHandler(s.step_id);
                }

                playStep(s.step_id);
                //} else if (tail_) {
                //	playStep(tail_);
            } else {
                GmCXt.cleanPlayer();
            }
        };

        let goToBotBranchStep = function() {
            if (step.step_settings.automation.enableBot && step.step_settings.automation.defaultData) {
                let bdata = step.step_settings.automation.defaultData;
                let index = 0;
                for (let i = 0; i < branch.length; i++) {
                    if (branch[i].branchName === bdata.branchName) {
                        index = i;
                        break;
                    }
                }
                GmCXt.playerI.currentBranchIndex = index;
                GmCXt.playerI.currentBranchStep = step;
                goToBranch(GmCXt.playerI.currentBranchIndex);
            }
        };

        let domRuleExists = function() {

            for (let i = 0, j = branch.length; i < j; i++) {
                if (branch[i].isDefault !== true) {
                    if (GmCXt.numberOfDomRules(branch[i].rulesEngine) > 0)
                        return true;
                }
            }

            return false;
        };

        var validateRule = function() {
            if (!GmCXt.playerI) {
                return;
            }

            counter++;

            GmCXt.log(33, "Validating all branches cycle " + counter);

            for (let i = 0, j = branch.length; i < j; i++) {

                if (branch[i].isDefault !== true) {

                    let obj = {
                        branchIndex: i,
                        rules: branch[i].rulesEngine,
                        tour: GmCXt.playerI.tour,
                        timeoutVal: GmCXt.t.ruleTimeOut15ms,
                        timeout: GmCXt.t.ruleTimeOut15ms,
                        cb: onValidation,
                        isTour: false,
                        initiator: 'tourPlay'
                    };
                    GmCXt.ruleEngine.queue(obj);
                }
            }
        };

        let playSelectedBranch = function(ev) {
            if (ev) {
                let branchIndex = ev.target.getAttribute("branchIndex");
                if (branchIndex) {
                    goToBranch(branchIndex);
                    branchDecicisionPopUp().close();
                }
            }
        };

        let takeDecision = function() {

            for (let i = 0, j = branch.length; i < j; i++) {

                if (branch[i].valid === true) {
                    branch[i].valid = false;
                    GmCXt.log(33, "Validation true. Going inside branch: " + i);
                    goToBranch(i);
                    return;
                }
            }

            if (Date.now() < intervalEndTime) {
                validate();

            } else if (Date.now() >= intervalEndTime && branch[0].isDefault === true) {
                GmCXt.log(33, "Going into default branch.");
                goToBranch(0);
            } else {
                let option = {
                    branch: branch,
                    callback: playSelectedBranch
                };
                branchDecicisionPopUp(option).show();
                clear();
            }
        };

        GmCXt.playerI.currentStepId = step.step_id;
        GmCXt.log(33, "Current Step ID Updated(Fn: playBranchStep):" + GmCXt.playerI.currentStepId);
        if (step.step_settings.branch_type === "User Selection") {
            if (GmCXt.isAutomationRunning()) {
                goToBranch(GmCXt.playerI.currentBranchIndex);
            } else if (GmCXt.playerI.source === "bot") {
                goToBotBranchStep();
            } else {
                let option = {
                    branch: branch,
                    callback: playSelectedBranch,
                    step: step
                };
                branchDecicisionPopUp(option).show();
                clear();
            }

        } else {
            let currentTime = Date.now();
            var intervalEndTime = currentTime + GmCXt.t.branchDecision;
            let intervalTimer = GmCXt.t.branchDecisionInterval;

            if (domRuleExists()) {
                intervalTimer = GmCXt.t.branchDecisionInterval_domRule;
                if (step.step_settings.branch_type === 'Quick Branch') {
                    intervalEndTime = currentTime + GmCXt.t.branchDecision_domRule_quickBranch;
                } else if (step.step_settings.branch_type === 'errorHandler') {
                    intervalEndTime = currentTime + GmCXt.t.branchDecision_errorHandler;
                } else {
                    intervalEndTime = currentTime + GmCXt.t.branchDecision_domRule;
                }

            }

            if (isVariableExistInBranch) {
                intervalTimer = intervalTimer + GmCXt.t.checkVariable;
            }

            GmCXt.log(33, "Decision Interval set for every " + intervalTimer + "ms for " + (intervalEndTime - currentTime) + "ms.");

            var ruleInterval = setInterval(function() {
                takeDecision();
            }, intervalTimer);

            GmCXt.log(33, "Playing branch step: " + step.step_id);

            if (GmCXt.playerI.runningBranchDecisionAutoSteps === true) {
                goToBranch(index);
            } else {
                if (branch[0].isDefault === true && branch.length > 1) {
                    validate();

                } else if (branch[0].isDefault === true && branch.length === 1) {

                    GmCXt.log(33, "Going into default branch directly.");
                    goToBranch(0);

                } else {
                    validate();
                }
                recordEvent(step);
            }
        }
    }

    function playLinkedGuide(step) {

        GmCXt.trackStepEvent(step);

        let ts = [];

        function updatePiStepsCb() {
            playStep(GmCXt.playerI.linkGuideFS);
        }

        function updatePiPsCb(ps) {
            ts = ts.length > 0 ? ts : GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_PS_done'].ts;
            if (!ts.length) return;

            GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_steps_done'] = {};
            GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_steps_done'].cb = updatePiStepsCb;

            GmCXt.concatLinkGuideSteps(ts);

            if (ps) GmCXt.playerI.playStructure = ps;

            GmCXt.playerI.tour.tour_settings.play_structure = GmCXt.playerI.playStructure;
        }

        function skipLinkGuide() {
            GmCXt.log(33, "SKIPING LINKED GUIDE STEPS, segment not valid");
            self.ready = true;
            playNxtStep();
        }

        GmCXt.failedStepId = step.step_id;

        let d = {
            tour_id: step.step_settings.tour_id
        };

        if (step.step_settings.linkGuidePlayMode) {
            GmCXt.playerI.linkGuidePlayMode = step.step_settings.linkGuidePlayMode;
        }

        if (GmCXt.apiPlayer) {
            d.forceJSONApi = true;
        }

        if (GmCXt.playerI && !GmCXt.isEmpty(GmCXt.mgActiveLang) && !GmCXt.playerI.isDefaultLang) {
            d.language = GmCXt.mgActiveLang;
        }

        GmCXt.getSteps(d).then(function(tour) {
            let lnkGuides = [];

            if (!tour) {
                skipLinkGuide();
                return;
            }
            //check guide segmentation
            GmCXt.checkGuidesBasedOnSegment([tour], function(_tour) {

                if (GmCXt.isEmpty(_tour)) {
                    skipLinkGuide();
                    return;
                }

                if (GmCXt.isEmpty(GmCXt.playerI.linkedGuides)) {
                    GmCXt.playerI.linkedGuides = [];
                }

                GmCXt.playerI.linkedGuides.push(tour.tour_id);

                if (GmCXt.playerI.mode === 'live' &&
					GmCXt.playerI.linkGuidePlayMode &&
					GmCXt.playerI.linkGuidePlayMode === "PDF" &&
					!(GmCXt.playerI.initiator && GmCXt.playerI.initiator === "doitforme")) {

                    if (!GmCXt.isEmpty(tour.media_files) && tour.media_files[0].pdf) {

                        GmCXt.playerI.linkGuidePdfUrl = tour.media_files[0].pdf;
						
                        GmCXt.openPdf(GmCXt.playerI.linkGuidePdfUrl+GmCXt.getCdnSign());
                        return;
                    }
                }

                GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_PS_done'] = {};
                GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_PS_done'].ts = tour.steps;
                GmCXt.globalMsgData['mgPlayerJSProd_action:update_PI_PS_done'].cb = updatePiPsCb;

                GmCXt.updatePlayStructureLinkGuide(tour);
                ts = tour.steps;
            });
        });
    }

    function triggerClickForWD() {
        // [MG-26104] For editable forms on WD, 'Next' click from step popup is considered as background click
        // Hence, form goes out of editable state, trigger click to bring to editable state again
        let index = self.workdayEdit.index;
        GmCXt.workdayAutoClick(index);
    }

    function transportCB() {
        self.ready = true;
        GmCXt.tourPlayerI.playNextStep();
    }

    function playStep(stepId) {

        if (self.workdayEdit && self.workdayEdit.isTrue) {
            triggerClickForWD();
        }

        if (GmCXt.playerI === null || !GmCXt.playerI.tour) {
            return;
        }

        GmCXt.playerI.currentStepId = stepId;
        GmCXt.log(33, "Current Step ID Updated(Fn: PlayStep):" + GmCXt.playerI.currentStepId);

        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:set_iframe_id:do', {
            currentIframeId: null
        });

        if ((GmCXt.isDefined(GmCXt.playerI.automate) && !GmCXt.playerI.automate) ||
			!GmCXt.playerI.testAutomation) {
            GmCXt.playerI.playAudio = true;
        }

        self.id = null;

        let step = GmCXt.getCurrentStep(stepId);

        if (!step) return;

        clearTimeouts(step.step_type);

        let log = "Playing step...\nID: " + stepId + "\nTitle: " + GmCXt.getText(step.step_title) + "\t";
        GmCXt.log(33, log, 1);

        let ts = GmCXt.playerI.tour.tour_settings;
        if (GmCXt.decodeVersion(ts.version) < 2020063000) {

            if (GmCXt.checkForBranchVariationSteps(step)) {
                if (GmCXt.isAutomationRunning() &&
					(GmCXt.playerI.runningBranchDecisionAutoSteps === true || GmCXt.playerI.runningBranchDecisionAutoSteps === undefined)) {
                    GmCXt.playerI.currentBranchIndex = 0;
                    GmCXt.playerI.currentBranchStep = step;
                    pub.playBranchStepInAutomation(step);
                } else {
                    playBranchStep(step);
                }
            } else if (step.step_type === GmCXt.STEP_TYPE_GUIDE) {
                playLinkedGuide(step);
            } else if (step.step_type === GmCXt.STEP_TYPE_TRANSPORT) {
                let op = {
                    step: step
                };
                transportDecicisionPopUp(op).show();
            } else playGuideRulesCheck(step);

        } else {
            playGuideRulesCheck(step);
        }
    }

    pub.playBranchStepInAutomation = function(step) {

        GmCXt.auto.showProgress();

        GmCXt.log(36, "Automation - Start testing all branches ");

        let branch = step.step_settings.branch;
        let branchStepId = step.step_id;
        let index = GmCXt.playerI.currentBranchIndex;

        if (index !== undefined) {
            let currentStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
            if (index >= branch.length) { // Boundary Reached
                GmCXt.log(36, 'Branch end reached for branch - ' + branch.branchName);
                let previousBranch = GmCXt.auto.getPreviousBranch();
                if (previousBranch.step && previousBranch.index != null && previousBranch.index != undefined) {
                    GmCXt.playerI.currentBranchStep = previousBranch.step;
                    GmCXt.playerI.currentBranchIndex = previousBranch.index;
                } else {
                    GmCXt.playerI.currentBranchIndex = undefined;
                }
                pub.stop();
                return;
            }
            let currentBranch = branch[index];
            let branchName = currentBranch.branchName;

            let node = getNode(step.step_id);
            let tail_ = node.branch[index].tail;

            let s = findFirstNonAutoStepInBranch(tail_);
            if (currentBranch) {
                GmCXt.auto.setCurrentBranchDetail(s.step_id, index, branchName, branchStepId, function() {
                    GmCXt.log(36, "Testing branch with index - " + index);
                    let autoStep = getNextAutomationStepForBranch(index, step, GmCXt.playerI.tour);
                    if (autoStep) {
                        GmCXt.playerI.runningBranchDecisionAutoSteps = true;
                        playStep(autoStep.step_id);
                    } else {
                        GmCXt.playerI.runningBranchDecisionAutoSteps = false;
                        playStep(step.step_id);
                    }
                });
            } else {
                GmCXt.playerI.currentBranchIndex = undefined;
                pub.stop();
            }
        }
    };

    function getStepFromTour(step_id, tour) {
        if (step_id) {
            for (let i = 0; i < tour.steps.length; i++) {
                if (parseInt(tour.steps[i].step_id) === parseInt(step_id)) {
                    return tour.steps[i];
                }
            }
        } else {
            return false;
        }
    }

    function getNextAutomationStepForBranch(index, step, tour) {
        let cN = getNode(step.step_id); //Current Node
        if (cN && cN.branch && cN.branch[index]) {
            let currentBranchNode = cN.branch[index];
            let nB = getNode(currentBranchNode.tail); //Node Below
            if (nB) {
                step = getStepFromTour(nB.id, tour);
                if (GmCXt.isAutomationStep(step)) {
                    return step;
                }
            }
        }
    }

    function checkSetupStep(step) {

        let pathname = GmCXt._location().pathname;
        let steps = GmCXt.playerI.tour.steps;
        let ctr = 0;

        steps.forEach(function(item, index) {
            if (item.step_id === step.step_id) {
                ctr = index + 1;
            }
        });

        if (step.step_type === GmCXt.STEP_TYPE_INLINE && !step.step_url.includes(pathname)) {
            let text = step.step_settings.element.meta.textPropertyValue;
            let new_step;
            while (ctr < steps.length && text === "Setup") {
                new_step = steps[ctr];
                if (new_step.step_url.includes(pathname)) {
                    step = new_step;
                    GmCXt.playerI.currentStepId = step.step_id;
                    GmCXt.log(33, "Current Step ID Updated(Fn: checkSetupStep):" + GmCXt.playerI.currentStepId);
                    break;
                }
                ctr++;
            }
        }
        return step;
    }

    function editStepFromPopUp() {

        let tour = GmCXt.playerI.tour;
        let language = GmCXt.playerI.language;
        let isDefaultLang = GmCXt.playerI.isDefaultLang;
        let step_id = GmCXt.playerI.currentStepId;

        for (let i = 0; i < tour.steps.length; i++) {
            if (tour.steps[i].step_id === step_id) {
                var step = tour.steps[i];
            }
        }

        pub.stop();
        GmCXt.log(33, "EDIT step event received");

        GmCXt.editStepWrapper(tour, step, null, language, isDefaultLang);
    }

    function getNodeFromTail(id) {

        //This will return the node which has the id passed in its tail
        let stepToReturn;
        let PS = GmCXt.playerI.playStructure;

        for (let i = 0; i < PS.length; i++) {
            if (PS[i].tail === id) {
                stepToReturn = PS[i];
                break;
            } else if (PS[i].branch) {
                for (let j = 0; j < PS[i].branch.length; j++) {
                    if (PS[i].branch[j].tail === id) {
                        stepToReturn = PS[i];
                        break;
                    }
                }
            }
        }

        return stepToReturn;
    }

    function getNode(id) {

        let playStructure = GmCXt.playerI.playStructure;
        let node = null;

        for (let i = 0; i < playStructure.length; i++) {
            if (parseInt(playStructure[i].id) === parseInt(id)) {
                node = playStructure[i];
            }
        }
        return node;
    }

    function playGuideRulesCheck(step) {

        GmCXt.stepAudioPlayed = false;
        GmCXt.playerI.currentStepId = step.step_id;
        GmCXt.log(33, "Current Step ID Updated(Fn: playGuideRulesCheck):" + GmCXt.playerI.currentStepId);

        GmCXt.playerI.forceGuideMe = tourStepSetting.forceGuideMe;

        if (GmCXt.playerI.mode === 'live' && GmCXt.playerI.linkedGuides && GmCXt.playerI.linkedGuides.includes(step.tour_id)) {
            if (GmCXt.playerI.linkGuidePlayMode &&
				GmCXt.playerI.linkGuidePlayMode === "Show Me" &&
				!(GmCXt.playerI.initiator && GmCXt.playerI.initiator === "doitforme")) {

                GmCXt.log(33, "Playing slideshow");
                GmCXt.playerI.originalMode = "live";
                playSlideshowStep();
                return true;
            }
        }

        if (step.step_type === "image") {
            playImageStep();
            return;
        } else if (step.step_type === "video") {
            GmCXt.log(33, "Playing video");
            GmCXt.playerI.originalMode = "live";
            playVideoStep();
            return;
        }

        if (GmCXt.checkSalesForceSite()) {
            step = checkSetupStep(step);
        }

        let stepSetting = step.step_settings;
        let stepRulesExist = (stepSetting.rules && stepSetting.rules.length);
        let delay = getDelayedPlayTime(step, tourSetting);

        if (stepRulesExist && delay) {
            delayChecked = true;
            GmCXt.timeout(cb, delay);
        } else {
            delayChecked = false;
            cb();
        }


        function cb() {
            GmCXt.checkProceedToPlay(step, GmCXt.playerI.tour).then(function(y) {

                if (!GmCXt.playerI) return;

                if (y) {
                    if (GmCXt.checkForBranchVariationSteps(step)) {
                        let playBranchSteps = function() {
                            if (GmCXt.isAutomationRunning() &&
								(GmCXt.playerI.runningBranchDecisionAutoSteps === true || GmCXt.playerI.runningBranchDecisionAutoSteps === undefined)) {
                                GmCXt.playerI.currentBranchIndex = 0;
                                GmCXt.playerI.currentBranchStep = step;
                                pub.playBranchStepInAutomation(step, 0);
                            } else {
                                playBranchStep(step);
                            }
                        };
                        let delay = getDelayedPlayTime(step, tourSetting);
                        if (delay && !delayChecked) {
                            GmCXt.log(33, "Branch Step Delayed for : ", delay);
                            GmCXt.timeout(playBranchSteps, delay);
                        } else {
                            playBranchSteps();
                        }
                    } else if (step.step_type === GmCXt.STEP_TYPE_GUIDE) {
                        playLinkedGuide(step);
                    } else if (step.step_type === GmCXt.STEP_TYPE_TRANSPORT) {
                        let op = {
                            step: step
                        };
                        transportDecicisionPopUp(op).show();
                    } else playStepOK(step);


                } else if (!self.failedStep) {
                    self.failedStep = step;

                    if (GmCXt.client.isUrlTour) {
                        GmCXt.log(33, 'RULES FAILED: Unable to proceed URL embed tour', self.failedStep);
                    } else {
                        GmCXt.log(33, 'Redirect to step URL', self.failedStep);

                        if (!GmCXt.playerI.guideRuleMatch && GmCXt.isFirstNonAutomationStep()) {
                            redirectTour(tourSetting);
                        } else if (!GmCXt.playerI.stepRuleMatch) {
                            redirectTour(tourSetting);
                        }
                    }
                }
            });
        }
    }

    function playStepOK(step) {

        if (!GmCXt.isWestpac()) {
            closeTour();
        }

        GmCXt.closeNotificationPopupSidePanel();

        if (GmCXt.isAutomationRunning()) {
            GmCXt.auto.setEndTime();
        }

        function cb() {

            if (GmCXt.isEmpty(GmCXt.playerI)) return;

            if ((step.step_type === GmCXt.STEP_TYPE_INLINE || step.step_type === GmCXt.STEP_TYPE_WEB_INLINE ||
					step.step_type === GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION)) {
                playInlineStep();
            } else if (step.step_type === GmCXt.STEP_TYPE_MESSAGE) {
                playMessageStep();
            } else if (GmCXt.isAutomationStep(step)) {
                decideActionForAutomationStep(step);
            }
        }

        switch (step.step_type) {

        case GmCXt.STEP_TYPE_INLINE:
        case GmCXt.STEP_TYPE_WEB_INLINE:
        case GmCXt.STEP_TYPE_MESSAGE:
        case GmCXt.STEP_TYPE_AUTOMATION:
        case GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION: {
            let delay = getDelayedPlayTime(step, tourSetting);

            if (delay && !delayChecked) {
                GmCXt.timeout(cb, delay);
            } else {
                cb();
            }
            break;
        }

        case GmCXt.STEP_TYPE_IMAGE: {
            playImageStep();
            break;
        }

        case GmCXt.STEP_TYPE_VIDEO:
            playSlideshowStep();
            break;

        case GmCXt.STEP_TYPE_SURVEY:
            playSurveyStep();
            break;
        }
    }

    // Skip Automation step for any mode other than doItForMe
    function decideActionForAutomationStep(step) {
        if (!GmCXt.playerI.testAutomation &&
			GmCXt.playerI.initiator !== "doitforme") {
            GmCXt.log(33, "SKIP THE AUTOMATION STEP");
            self.ready = true;
            pub.playNextStep(step);
        } else if (step.step_type === GmCXt.STEP_TYPE_IMAGE) {
            playImageStep();
        } else {
            playInlineStep();
        }
    }

    function getDelayedPlayTime(step, tourSetting) {

        let delay = 0;
        let tourDelay = parseInt(tourSetting.stepDelayTime);
        let stepDelay = parseInt(step.step_settings.stepDelayTime);

        if (!isNaN(tourDelay) && !!tourDelay && GmCXt.playerI.currentStepId !== GmCXt.playerI.startStepId) { // When directly playing a step, omit the tour delay
            delay = tourDelay;
        }

        if (!isNaN(stepDelay) && !!stepDelay) {
            delay = stepDelay;
        }

        return delay ? delay * 1000 : 0;
    }

    function getStepUrl() {
        let url = '';
        let step;
        if (self.failedStep) {
            step = self.failedStep;
        } else {
            step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        }

        url = step.step_url;
        return url;
    }

    function playSlideshowStep() {

        if (autoModePlay('Slideshow')) return;

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        window.onvisibilitychange = null;
        GmCXt.playerI.type = GmCXt.TOUR_PLAYER_SLIDESHOW;

        GmCXt.playedPreviousSteps.push(GmCXt.playerI.currentStepId);

        GmCXt.requestHandler.playSlideshow();

        GmCXt.nextStepPlayEventReceived = false;

        GmCXt.timeout(function() {
            self.ready = true;
            recordEvent(step);
        }, 100);
    }

    function showHoverGuide(highlightedArea) {
        let options = {
            type: 'hoverTipPlayStepGuide',
            highlightedArea: highlightedArea
        };

        if (GmCXt.userGuideInstance) {
            GmCXt.userGuideInstance.close();
        }

        GmCXt.userGuideInstance = GmCXt.userGuide(options);
        GmCXt.userGuideInstance.open();

        self.ready = true;
        GmCXt.showTooltipOnPreviousHoverStep = false;
    }

    pub.onFailureTooltipElementNotFound = function(tooltipId) {
        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        if (self.status === self.DOM_WAITING && step.step_settings && step.step_settings.domElems &&
			tooltipId === step.step_settings.domElems[0].id && step.step_settings.optional) {

            self.ready = true;
            self.maxWait = 0;

            GmCXt.log(33, "Playing optional step.");

            if (self.prevEvent) {
                self.prevEvent = false;
                pub.playPreviousStep();
            } else {
                GmCXt.recordGuideEvents();
                playNxtStep();
            }
            self.maxWait = 500;
        }
    };

    pub.onFailureElementNotFound = function(isAttrClassCheck, rca) {

        GmCXt.log(37, "ELEMENT NOT FOUND", 1);

        if (GmCXt.isDesktop()) {
            GmCXt.sendMessageToDesktop({
                stepId: GmCXt.playerI.tour.steps[0].step_id,
                status: "stepFailed"
            });
        }

        if (self.status === self.DOM_WAITING || isAttrClassCheck) {
            self.status = isAttrClassCheck ? self.ATTR_CLS_FAILURE : self.DOM_FAILURE;

            if (!GmCXt.playerI.currentStepId) {
                let firstStepId = GmCXt.playerI.tour.steps[0].step_id;

                if (GmCXt.playerI.playStructure) {
                    firstStepId = GmCXt.playerI.playStructure[0].id;
                }

                if (firstStepId) {
                    GmCXt.playerI.currentStepId = firstStepId;
                    GmCXt.log(33, "Current Step ID Updated(Fn: onFailureElementNotFound):" + GmCXt.playerI.currentStepId);
                }
            }

            let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
            let tour = GmCXt.playerI.tour;

            GmCXt.markAutoLaunchTourDoNotShow(GmCXt.playerI.tour); // do not show autoLuanch guide if elem not found

            if (GmCXt.deskReq) {
                GmCXt.sendMessageToDesktopApp('step_failed', step);
            }

            if (isAttrClassCheck) {
                GmCXt.recordGuideEvents();
                GmCXt.trackStepEvent(step, "Step element did not match attribute/class");

                pub.stop(null, true);

            } else if (GmRootScope.isResumeGuide && GmRootScope.resumeFromStartPoint) {

                if (GmRootScope.startPoints.length) {
                    if (tour.steps[0].step_type === 'inline') {
                        GmRootScope.startPoints.unshift(tour.steps[0]);
                    }
                    GmRootScope.searching_sp = 0;
                    let data = {
                        tour_id: tour.tour_id,
                        startPoint: GmRootScope.startPoints[0],
                        resumeGuide: GmRootScope.isResumeGuide
                    };

                    GmCXt.sendMessageToAllWindows(
                        'mgPlayerJSProd_action:started;task:search_start_point',
                        data,
                    );
                    GmRootScope.isResumeGuide = false; 
                    GmRootScope.resumeFromStartPoint = false;
                }

            } else if (step.step_settings.optional) {

                self.ready = true;
                self.maxWait = 0;

                GmCXt.log(33, "Playing optional step.");

                if (self.prevEvent) {
                    self.prevEvent = false;
                    pub.playPreviousStep();
                } else {
                    GmCXt.recordGuideEvents();
                    playNxtStep();
                }
                self.maxWait = 500;
            } else {

                if (!GmCXt.failedStepId) GmCXt.failedStepId = step.step_id;

                if (GmCXt.playerI.testAutomation) {
                    GmCXt.auto.fail(step, {
                        errorMessage: 'Step Element Not Found'
                    });
                } else {
                    if (step.step_type !== GmCXt.STEP_TYPE_BRANCH || GmCXt.isTrue(step.step_settings.inlineBranch)) {
                        GmCXt.recordGuideEvents();
                        GmCXt.trackStepEvent(step, "step element not found");
                    }

                    if (GmCXt.playerI.automate) {
                        GmCXt.playerI.automate = false;
                    }

                    let options = {
                        type: "step_not_found"
                    };

                    GmCXt.userGuideInstance = GmCXt.userGuide(options);
                    let img = !step.screen_url || step.screen_url.startsWith('undefined') ? step.step_screen_temp : step.screen_url;
                    GmCXt.userGuideInstance.open(step.step_title, img, step.is_thumbnail_processed, step.step_order, step.step_id, rca, step.step_settings.element.meta.elAttributes);

                    pub.stop(null, true);
                }
            }
        }
    };

    pub.onImageCompareFailure = function(step) {
        if (!GmCXt.failedStepId) GmCXt.failedStepId = step.step_id;

        GmCXt.recordGuideEvents();
        GmCXt.trackStepEvent(step, 'Image Comparison Task Failed');
        GmCXt.tourPlayerI.stop(null, true);
    };

    pub.onSuccessElementFound = function(elPos, workdayEdit, id) {
        hideWaitMsg();

        if (!self.id) {
            self.id = id;
            GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:set_iframe_id:do', {
                currentIframeId: self.id
            });
            GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:clear_outline;action:do', {
                scriptId: self.id
            });
        } else if (self.id !== id) {
            return;
        }

        if (GmCXt.tourPlayerI.guideState === 'pause') return;

        GmCXt.tourPlayerI.elementFound = true;
        GmRootScope.isResumeGuide = false;

        GmCXt.failedStepId = false;

        self.status = self.DOM_SUCCESS;
        self.prevEvent = false;

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        step.highlightedArea = [elPos];

        GmCXt.nextStepPlayEventReceived = false;

        if (GmCXt.showTooltipOnPreviousHoverStep === true) {
            showHoverGuide(step.highlightedArea);
            return;
        }

        let ss = step.step_settings;
        if (ss.headerNext && GmCXt.decodeVersion(ss.element.version) < 2020063001) { // for old steps on header humanInteration only reflects on UI
            ss.automation.hasHumanInteraction = true;
        }

        self.ready = true;
        self.workdayEdit = workdayEdit;

        playInlineStepPreview(step);

        recordEvent(step);

        if (step.step_type === GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION || step.step_settings.autoPlayStep) {
            GmCXt.sendMessageToDesktopApp('trigger_event', step);
        }
    };

    function automationTriggerEvent(step) {
        let nextStep = GmCXt.getNextStep();
        if (GmCXt.playerI.automate && (!step.step_settings.automation.hasHumanInteraction || GmCXt.isAutomationStep(nextStep))) {
            return true;
        }
        return false;
    }

    function checkRestartInParent(step) {
        let stepId = step.step_id;
        let steps = GmCXt.getStepSortedByPS(GmCXt.playerI.playStructure, stepId);
        for (let i = 0; i < steps.length; i++) {
            if (parseInt(stepId) !== parseInt(steps[i].step_id)) {
                if (steps[i].step_settings.pageReloadOption === "restart_parent") {
                    GmCXt.log(33, "START WATCHING for step " + GmCXt.getText(steps[i].step_title) + "to restart guide in parent window.");
                    return true;
                } else if (steps[i].step_settings.pageReloadOption === "new_tab") {
                    return false;
                }
            }
        }

        return false;
    }

    function hideWaitMsg() {
        clearTimeout(self.waitTimeout);
        GmCXt.hideToastMsg();
    }

    function showFindingToastMsg(message) {

        return {
            show: function() {
                let htmlstr = "<wmgPlayerJSProd_ class='mgPlayerJSProd_toast-msg-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_toast-msg-close' id='mgPlayerJSProd_toast_msg_close' >x</wmgPlayerJSProd_>";
                htmlstr += "<wmgPlayerJSProd_ id='mgPlayerJSProd_toast_msg_text' class='mgPlayerJSProd_toast-msg-text' >" + message + "</wmgPlayerJSProd_></wmgPlayerJSProd_>";

                mg$("#mgPlayerJSProd_toast_msg").html(htmlstr);
                mg$("#mgPlayerJSProd_toast_msg").fadeIn();

                mg$("#mgPlayerJSProd_toast_msg_close").click(function(e) {
                    showFindingToastMsg().hide(e);
                });
            },
            hide: function(e) {
                mg$('#mgPlayerJSProd_toast_msg').fadeOut(500);
                if (GmCXt.playerI && e && e.currentTarget.id === 'mgPlayerJSProd_toast_msg_close') {
                    pub.stop();
                }
            }
        };
    }

    function getCountSpan(t) {
        return "<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_toast-timer'>" + t + "</wmgPlayerJSProd_>";
    }

    function showPleaseWaitMessage(timeout) {

        if (self.status === self.DOM_WAITING && GmCXt.playerI) {

            let now = Date.now();
            let remainingTime = parseInt((timeout - now) / 1000);

            if (remainingTime) {
                let msg = GmCXt.label.findingElementMessage + " (" + getCountSpan(remainingTime) + ")";
                showFindingToastMsg(msg).show();

                clearTimeout(self.waitTimeout);
                self.waitTimeout = setTimeout(function() {
                    showPleaseWaitMessage(timeout);
                }, GmCXt.t.plsWaitMsg);
            } else {
                showFindingToastMsg().hide();
            }
        }
    }

    function playInlineStep() {

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        if (GmCXt.playerI.initiator === 'doitforme' || step.step_settings.autoPlayStep) {
            let autoSettings = step.step_settings.automation;
            if (autoSettings.muteNarration && GmCXt.isFalse(autoSettings.hasHumanInteraction)) {
                GmCXt.playerI.playAudio = false;
            }
        }

        // For automation of the creator app.
        // If there is a hover step, it should be skipped as such kind cannot be automated.
        if (step.step_settings.completionEvent === "hoverNext" && GmCXt.playerI.testAutomation) {
            if (step.step_settings.optional) {
                self.ready = true;
                GmCXt.log(37, "SKIP THE HOVER STEP", 1);
                GmCXt.auto.updateAutomationMessage("Hover step was not tested as it is not supported", function() {
                    playNxtStep();
                });
            } else {
                markStatusFailed(step);
                GmCXt.auto.fail(step, {
                    errorMessage: "On Hover step is not supported by automation"
                });
            }

            return;
        }
        let nextStep = GmCXt.getNextStep();
        let waitFor = getWaitTime(step);

        markStatusFailed(step);

        self.status = self.DOM_WAITING;

        let isLastStep = GmCXt.isLastStep(step.step_id, GmCXt.playerI.playStructure);

        let data = {
            requestId: step.step_id,
            settings: step.step_settings,
            nextStep: nextStep,
            windowHost: GmCXt.getPageDomain(),
            task: 'playTour',
            timeout: Date.now() + parseInt(waitFor),
            autoRun: GmCXt.playerI.automate,
            log_stepInfo: GmCXt.getStepInfoLog(step),
            isLastStep: isLastStep,
            testAutomation: GmCXt.playerI.testAutomation,
            iframeAttrs: step.step_settings.element.iframeAttrs,
            isDeskReq: self.isDeskReq,
            showLogs: false
        };

        if (GmCXt.deskReq) {
            if (data.settings.automation && data.settings.automation.getfromBot) {
                data.botUsers = GmCXt.deskReq.botUsers;
            }
        }

        if (GmCXt.playerI.csvData) {
            data.csvData = GmCXt.playerI.csvData;
            data.currentLoop = GmCXt.playerI.currentLoop;
        }

        if (GmCXt.playerI.manual && !step.step_settings.autoPlayStep) {
            if (data.settings && data.settings.automation) {
                data.settings.automation.enableDefaultData = false;
            }
        } else if (GmCXt.playerI.automate)
            data.triggerEvent = automationTriggerEvent(step);

        if (step.step_settings.autoPlayStep) {
            data.triggerEvent = true;
        }

        GmCXt.tourPlayerI.elementFound = false;
        GmCXt.tourPlayerI.currentStepReq = mg$.extend(true, {}, data);

        if (data.settings.pageReloadOption === "new_tab" && checkRestartInParent(step)) {
            GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:keep_watching_step:inform');
        }

        GmCXt.log(33, 'Find element: ' + GmCXt.stepLog(step.step_id, GmCXt.playerI.tour.tour_id));

        if (data.settings.element.meta.inTopWindow) {
            GmCXt.log(33, "FINDING STEP ELEMENT only in TOP window");
            GmCXt.requestHandler.selectExistingDomElement(data);
        } else {
            // Element in iframe
            if (data.settings.element.criteria.precision_level === "High" && !GmCXt.isEmpty(data.settings.element.iframeAttrs)) {

                let findInIframe = 2500;
                data.timeout = Date.now() + findInIframe;

                GmCXt.log(33, "FINDING STEP ELEMENT only in TARGET frame");
                GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_existing_dom_element:target_frame_only', data);

                GmCXt.findStepTimeout = GmCXt.timeout(function() {
                    if (!GmCXt.currentIframeId) {
                        GmCXt.log(33, "TIMED OUT in Target Frame..\nFINDING STEP ELEMENT in all frames");
                        data.timeout = Date.now() + parseInt(waitFor) - findInIframe;
                        data.checkIframe = true;
                        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_existing_dom_element', data);
                    }
                }, findInIframe + 250);
            } else {
                let tm = 0;
                GmCXt.timeout(function() {
                    GmCXt.log(33, "FINDING STEP ELEMENT in all frames");
                    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_existing_dom_element', data);
                }, tm);
            }
        }

        GmCXt.timeout(function() {
            if (GmCXt.isPlayer() && GmCXt.tourPlayerI && !GmCXt.tourPlayerI.elementFound) {
                if (!GmCXt.pageTours) {
                    GmCXt.getContextGuides();
                }
                GmCXt.showSmartTips(true);
                GmCXt.showBeacons(true);
            }
            GmCXt.displayWidget(true);
        }, 20000);

        if (GmCXt.isWestpac()) {
            let timeout = Date.now() + parseInt(GmCXt.elLookupTime);

            self.waitTimeout = setTimeout(function() {
                showPleaseWaitMessage(timeout);
            }, 3500);
        }
    }

    pub.onSuccessTooltipElementFound = function(elementPos, tooltipId) {

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let tooltip = getTooltipFromId(step, tooltipId);

        self.prevEvent = false;
        GmCXt.nextStepPlayEventReceived = false;

        let s = step.step_settings;

        if (s.overlayOpacity || (!s.doNotForceGuide && GmCXt.playerI && GmCXt.playerI.forceGuideMe)) {
            GmCXt.highlight_elements[tooltipId] = [elementPos];
            GmCXt.applyOverlayMessageStep(GmCXt.highlight_elements);
        }

        if (self.status === self.DOM_WAITING &&
			tooltipId === step.step_settings.domElems[0].id &&
			step.step_settings.optional) {
            self.status = self.DOM_SUCCESS;
            playInlineStepPreview(step);
        }

        if (tooltip.title) {

            let options = {
                description: tooltip.title,
                highlightedArea: [elementPos],
                width: GmCXt.stepPopupWidth,
                tooltipId: tooltipId,
                tour: GmCXt.playerI.tour,
                alignment: tooltip.alignment,
                stepType: step.step_type
            };

            GmCXt.showTooltip(options);
        }
    };

    function getTooltipFromId(step, id) {
        let stepData = step.step_settings;
        let domElems = stepData.domElems;

        for (let i = 0, j = domElems.length; i < j; i++) {
            if (domElems[i].id === id) {
                return domElems[i];
            }
        }

        return null;
    }

    function msgToDesktop(step) {
        GmCXt.sendMessageToDesktop({
            isHybrid: GmCXt.playerI.isHybrid,
            isFirstStep: GmCXt.playerI.isFirstStep,
            isLastStep: GmCXt.playerI.isLastStep,
            stepDetails: step,
            ack: GmCXt.playerI.lastStepStatus
        });
    }

    function markStatusFailed(step) {
        if (!step.step_settings.optional && !GmCXt.isEmpty(GmCXt.playerI)) {
            GmCXt.playerI.lastStepStatus = 'failed';
        }
    }

    function checkFailedMessage(step) {
        if (!GmCXt.isEmpty(step.step_description) && step.step_description.toLowerCase().indexOf("fail") !== -1) {

            let prevStepId = GmCXt.playedPreviousSteps[GmCXt.playedPreviousSteps.length - 1];
            let prevStep = prevStepId ? GmCXt.createDeepCopy(GmCXt.getStepFromPlayerI(prevStepId)) : null;

            if (prevStep && prevStep.step_type === 'branch') {
                return true;
            }
        }
        return false;
    }

    function recordFailedTestCase(step) {
        GmCXt.log(33, 'Message Step: "Fail" text found in description marking testcase failed');
        GmCXt.recordGuideEvents();
        let title = mg$('<span />').html(step.step_title).text().trim();
        GmCXt.trackStepEvent(step, title);

    }

    function playMessageStep() {

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let nextStep = GmCXt.getNextStep();
        let stepSettings = GmCXt.createDeepCopy(step.step_settings);
        let tooltipExists = false;
        let scrollTopBefore = mg$(window).scrollTop();

        GmCXt.nextStepPlayEventReceived = false;

        markStatusFailed(step);

        let waitFor = GmCXt.t.stepMTimeout;

        if (!stepSettings.optional) {
            playInlineStepPreview(step);
        } else {
            self.status = self.DOM_WAITING;
            waitFor = 3000;
        }

        recordEvent(step);

        if (stepSettings) {
            let auto = stepSettings.automation;

            if (stepSettings.completionEvent === "onClickAnywhere" &&
				GmCXt.playerI.testAutomation) {
                if (!auto.hasHumanInteraction) {
                    automatePlayStep();
                } else {
                    GmCXt.log(33, 'Message Step - Wait for human interaction');
                    if (GmCXt.isAutomationStep(nextStep)) {
                        automatePlayStep();
                    }
                }
            } else if (stepSettings.keepNext === true && GmCXt.playerI.testAutomation) {
                automatePlayStep();
            } else if (GmCXt.playerI.automate && !auto.hasHumanInteraction) {

                GmCXt.rotateGear();
                automatePlayStep();
            }

            let domElems = stepSettings.domElems;

            if (domElems && domElems.length) {
                GmCXt.highlight_elements = {};
                tooltipExists = true;

                let data = {
                    requestId: step.step_id,
                    settings: stepSettings,
                    nextStep: nextStep,
                    windowHost: GmCXt.getPageDomain(),
                    task: 'playTour',
                    timeout: Date.now() + parseInt(waitFor),
                    stepType: GmCXt.STEP_TYPE_MESSAGE,
                    isOptional: stepSettings.optional
                };

                if (GmCXt.playerI.automate)
                    data.triggerEvent = automationTriggerEvent(step);

                let action = 'mgPlayerJSProd_action:started;task:select_dom_element_tooltips';
                GmCXt.sendMessageToAllWindows(action, data);
            }
        }

        if (tooltipExists === true) {
            GmCXt.timeout(function() {
                let scrollTopAfter = mg$(window).scrollTop();
                if (scrollTopAfter !== scrollTopBefore) {

                    let $popup = mg$(".mgPlayerJSProd_step-popup");
                    GmCXt.alignMessagePreview($popup,
                        mg$(window),
                        stepSettings.alignment,
                        stepSettings);
                }
            }, GmCXt.t_.sec1);
        }
    }

    function getWaitTime(step) {

        let wait = GmCXt.elLookupTime;
        let el = step.step_settings.element;

        if (step.step_settings.optional) {
            wait = 100;
            // If current and previous step is optional
            let prevStep = GmCXt.getPreviousStep();
            if (prevStep) {
                if (prevStep.step_settings.optional) wait = 50;
            }
            if (el && !el.meta.inTopWindow) {
                wait = wait * 30;
            }
        }
        let PI = GmCXt.playerI;
        if (!GmCXt.isWestpac() && PI && PI.currentStepId === PI.startStepId) {
            wait = 6000;
        }

        if (PI && PI.loops) {
            wait = 3000;
        }

        if (GmCXt.playerI.testAutomation && !step.step_settings.optional) {
            wait = GmCXt.t.autoWaitTime;
        }

        return wait;
    }

    function playInlineStepPreview(step) {

        GmCXt.log(33, "PLAY INLINE STEP PREVIEW");

        if ((GmCXt.playerI.testAutomation || GmCXt.playerI.initiator === 'doitforme') && GmCXt.isAutomationStep(step)) {
            return;
        }
        if (GmCXt.playerI.keyShorts && GmCXt.playerI.initiator === 'doitforme') {
            return;
        }

        let options = {
            step: step,
            totalStepCount: GmCXt.playerI.totalStepCount,
            tour: GmCXt.playerI.tour,
            playingTour: true
        };

        if (GmCXt.previewStepPopupInstance) {
            GmCXt.previewStepPopupInstance.close();
        }

        GmCXt.previewStepPopupInstance = GmCXt.previewStepPopup(options);
        GmCXt.previewStepPopupInstance.load();

        addEventsOnPreviewPopup(step);

        GmCXt.timeout(function() {
            setUpStepAudio(step);
        }, 500);

        setStepComTimeout(step);

        self.ready = true;
    }

    function recordEvent(step) {
        GmCXt.recordGuideEvents();
        GmCXt.trackStepEvent(step);

        let PI = GmCXt.playerI;

        GmCXt.playedPreviousSteps.push(PI.currentStepId);

        PI.lastPlayedStepId = PI.currentStepId;
        PI.lastStepStatus = 'success';
        if (GmCXt.isDesktop()) {
            msgToDesktop(step);
        }

        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:update_player_instance");

        GmCXt.storage().remove(['linkClickOnStep']);
        GmCXt.storage().set({
            'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': PI,
            'guide_play_event': GmCXt.guidePlayTracker
        });
    }

    function saveImage(imageStr) {
        return new Promise(function(resolve, reject) {
            let formData = new FormData();
            formData.append('image_data', imageStr.replace('data:image/jpeg;base64,', ''));

            let options = {
                args: formData
            };
            GmCXt.api.uploadFileBase64(options).then(function(result) {
                resolve(result.data.image_id);
            }).catch(function(result) {
                reject(result.message);
            });
        });
    }

    function clearTimeouts(stepType) {
        if (GmCXt.closeTourTimeout) {
            clearTimeout(GmCXt.closeTourTimeout);
        }

        if (GmCXt.findStepTimeout) {
            clearTimeout(GmCXt.findStepTimeout);
        }

        hideWaitMsg();

    }

    function closeTour() {

        let wait = GmCXt.t_.min5;
        GmCXt.log(33, "CLOSE TOUR TIMEOUT initiated for " + wait);
        if (GmCXt.playerI && GmCXt.playerI.testAutomation) {
            wait = GmCXt.t.autoWaitTime + 5000;
        }

        clearTimeouts();

        GmCXt.closeTourTimeout = GmCXt.timeout(function() {

            if (GmCXt.playerI) {
                
                let tour = GmCXt.playerI.tour;
                let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

                if (GmCXt.isAutomationRunning()) {
                    GmCXt.auto.fail(step, {
                        errorMessage: "Stop automation for current guide due to timeout"
                    });
                    return;
                }

                if (GmCXt.isLastStep(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure)) {
                    updatePlayedTours(tour.tour_id);
                    GmCXt.markAutoLaunchTourDoNotShow(tour);
                } else if (GmCXt.FT.isPlayer) {
                    GmCXt.tourActivity['t:' + tour.tour_id] = GmCXt.playerI.lastPlayedStepId;
                }

                GmCXt.log(33, "KILLED guide after " + wait);
                if (!mg$(".mgPlayerJSProd_slideshow-panel").visible()) {
                    GmCXt.recordGuideEvents();
                    GmCXt.trackStepEvent(step, "Stop current guide due to timeout");
                    pub.stop();
                }
            }
        }, wait);
    }

    function playImageStep() {

        if (autoModePlay('Image')) return;

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        markStatusFailed(step);

        if (!step.step_settings.displayPreview) {

            window.onvisibilitychange = null;
            GmCXt.playerI.type = "image";

            GmCXt.playedPreviousSteps.push(GmCXt.playerI.currentStepId);

            addEventsOnPreviewPopup(step);

            let data = {
                prev_btn: self.prev_button,
                next_btn: self.next_button
            };
			
            GmCXt.playStepInMyShowShell(false, data);

            GmCXt.nextStepPlayEventReceived = false;

            self.ready = true;
            recordEvent(step);
        } else {
            GmCXt.lockScroll();

            if (mg$("body").find('.mgPlayerJSProd_image-step-screen').length === 0) {
                mg$("<wmgPlayerJSProd_ class='mgPlayerJSProd_image-step-screen'><img id='mgPlayerJSProd_img_step_div' class='mgPlayerJSProd_custom-image mgPlayerJSProd_img-step-div' src='' ></wmgPlayerJSProd_>").appendTo('body');
            }

            let container = mg$('#mgPlayerJSProd_img_step_div');

            container.attr('src', (step.image_url)).one('load', function(e) {

                mg$('.mgPlayerJSProd_image-step-screen').show();
                mg$('.mgPlayerJSProd_highlighter-span').remove();
                let windowWidth = mg$(window).width();
                let windowHeight = mg$(window).height();
                let containerWidth = container.width();
                let containerHeight = container.height();

                container.css('margin-left', (windowWidth - containerWidth) / 2);
                container.css('margin-top', (windowHeight - containerHeight) / 2);

                /**
					* preview popup requires highlightedArea to be set on step object
					* But in database highlightedArea is in step_settings property of step object
					*/
                step.highlightedArea = scaleHighlightedArea(step);

                /**
					* Select highlighted areas on image canvas
					*/
                step.highlightedArea.forEach(function(val, ind) {
                    let offset = mg$("#mgPlayerJSProd_img_step_div").offset();
                    let bordWidth = "1";
                    let borderColor = "red";
                    if (step.step_settings.highlightedArea) {

                        if (step.step_settings.highlightedArea[ind].borderColor) {
                            borderColor = step.step_settings.highlightedArea[ind].borderColor;
                        } else {
                            borderColor = "red";
                        }

                        if (step.step_settings.highlightedArea[ind].borderWidth) {
                            bordWidth = step.step_settings.highlightedArea[ind].borderWidth;
                        } else {
                            bordWidth = 1;
                        }
                    }
                    let highlighterHtml = '<wmgPlayerJSProd_ class="mgPlayerJSProd_highlighter-span highliter_' + ind + '" style="' +
						'    width:' + val.width + 'px; ' +
						'    height:' + val.height + 'px;' +
						'    top:' + (val.top + offset.top) + 'px;' +
						'    left:' + (val.left + offset.left) + 'px;' +
						'    border: ' + bordWidth + 'px solid ' + borderColor + '!important; position: absolute;box-sizing: border-box">' +
						'</wmgPlayerJSProd_>';
                    mg$('.mgPlayerJSProd_image-step-screen').append(highlighterHtml);
                });

                window.scrollTo(0, 0);

                var options = {
                    step: step,
                    totalStepCount: GmCXt.playerI.totalStepCount,
                    containerOffest: container.offset(),
                    container: container,
                    tour: GmCXt.playerI.tour,
                    playingTour: true
                };
                if (GmCXt.isEmpty(step.step_title.trim()) && GmCXt.isEmpty(step.step_description.trim())) {
                    createBlackoutViewPortInstance(options);
                } else {
                    GmCXt.previewStepPopupInstance = GmCXt.previewStepPopup(options);
                    GmCXt.previewStepPopupInstance.load();
                    addEventsOnPreviewPopup(step);
                }

                GmCXt.nextStepPlayEventReceived = false;

                recordEvent(step);
                setUpStepAudio(step);
                setStepComTimeout(step);

                if (step.step_settings.version) {

                    let highlightedAreaScaled = scaleHighlightedArea(step);

                    for (let i = 0; i < step.step_settings.highlightedArea.length; i++) {

                        let highLightArr = [];
                        let offset = mg$("#mgPlayerJSProd_img_step_div").offset();

                        highlightedAreaScaled[i].left = highlightedAreaScaled[i].left + offset.left;
                        highlightedAreaScaled[i].top = highlightedAreaScaled[i].top + offset.top;

                        highLightArr.push(highlightedAreaScaled[i]);

                        var options = {
                            description: step.step_settings.highlightedArea[i].title.trim(),
                            highlightedArea: highLightArr,
                            width: 250,
                            tooltipId: i,
                            tour: GmCXt.playerI.tour,
                            alignment: step.step_settings.highlightedArea[i].alignment,
                            stepType: step.step_type
                        };
                        if (options.description) GmCXt.showTooltip(options);
                    }
                }

                mg$("<wmgPlayerJSProd_ class='mgPlayerJSProd_image-step-done' ><wmgPlayerJSProd_ class='mgPlayerJSProd_icon-image-close mgPlayerJSProd_inline-block-vm'></wmgPlayerJSProd_></wmgPlayerJSProd_>").appendTo('html');
                mg$(".mgPlayerJSProd_image-step-done").html(GmCXt.svgs.close_slideshow);
                mg$(".mgPlayerJSProd_image-step-done").off("click").on("click", playStepPopupCloseButtonClickEvent);

                if (GmCXt.getTail(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure)) {
                    mg$("<wmgPlayerJSProd_ class='mgPlayerJSProd_image-step-nav-button mgPlayerJSProd_image-step-next'><wmgPlayerJSProd_ class='mgPlayerJSProd_img-step-next-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>").appendTo('html');
                    mg$(".mgPlayerJSProd_img-step-next-icon").html(GmCXt.svgs.slideshow_next_button);
                    mg$(".mgPlayerJSProd_image-step-next").off("click").on("click", playNxtStep);
                }

                let prevStep = GmCXt.getPreviousStep();

                if (prevStep !== null && showPrevBtnCond(prevStep) && !tourStepSetting.hidePrevBtn) {

                    mg$("<wmgPlayerJSProd_ class='mgPlayerJSProd_image-step-nav-button mgPlayerJSProd_image-step-prev'><wmgPlayerJSProd_ class='mgPlayerJSProd_img-step-prev-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>").appendTo('html');
                    mg$(".mgPlayerJSProd_img-step-prev-icon").html(GmCXt.svgs.slideshow_prev_button);
                    mg$(".mgPlayerJSProd_image-step-prev").off("click").on("click", pub.playPreviousStep);
                }
                self.ready = true;
            });
        }
    }

    function playVideoStep() {

        if (autoModePlay('Video')) return;

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        window.onvisibilitychange = null;
        GmCXt.playerI.type = "video";

        GmCXt.playedPreviousSteps.push(GmCXt.playerI.currentStepId);

        addEventsOnPreviewPopup(step);

        let data = {
            prev_btn: self.prev_button,
            next_btn: self.next_button
        };

        GmCXt.playStepInMyShowShell(true, data);

        GmCXt.nextStepPlayEventReceived = false;

        GmCXt.timeout(function() {
            self.ready = true;
            recordEvent(step);
        }, 100);

    }

    function scaleHighlightedArea(step) {

        let containerWidth = mg$('#mgPlayerJSProd_img_step_div').width();
        let containerHeight = mg$('#mgPlayerJSProd_img_step_div').height();

        let imageRatio = step.step_settings.imageDimension.width / step.step_settings.imageDimension.height;
        let containerRatio = containerWidth / containerHeight;

        let ratio = 1;
        if (imageRatio <= containerRatio) {
            ratio = (containerHeight * 100) / step.step_settings.imageDimension.height;
        } else {
            ratio = (containerWidth * 100) / step.step_settings.imageDimension.width;
        }

        let arr = [];

        if (step.step_settings.highlightedArea === undefined || step.step_settings.highlightedArea === null) {
            step.step_settings.highlightedArea = [];
        }

        let highlightedArea = step.step_settings.highlightedArea;
        highlightedArea.forEach(function(val, ind) {
            let a = {
                'left': (((highlightedArea[ind].left || highlightedArea[ind].position.left)  * ratio) / 100),
                'top': ((highlightedArea[ind].top || highlightedArea[ind].position.top) * ratio) / 100,
                'height': ((highlightedArea[ind].height || highlightedArea[ind].position.height) * ratio) / 100,
                'width': ((highlightedArea[ind].width || highlightedArea[ind].position.width) * ratio) / 100
            };
            arr.push(a);
        });

        return arr;
    }

    function setUpStepAudio(step) {

        if (!GmCXt.FT.audio) return;
        if (GmCXt.isPageReloaded) {
            GmCXt.setOffAudioMode();
            GmCXt.isPageReloaded = false;
            showAudioIcon();
            return;
        }

        mg$('.mgPlayerJSProd_play-step-audio-loader').show();
        mg$(".mgPlayerJSProd_play-step-audio").css("opacity", ".5");

        GmCXt.storage().get(['stepAudioRunningStatus']).then(function(items) {

            if (items === undefined) items = {};

            if (!GmCXt.isAutomationRunning() && GmCXt.getAudioPreference(items.stepAudioRunningStatus)) {

                if (step.step_audio) {
                    let message = {
                        audioTrack: step.step_audio,
                        step: step
                    };

                    if (GmCXt.playerI && GmCXt.playerI.playAudio) {

                        if (!GmCXt.stepAudioPlayed) {
                            GmCXt.stepAudioPlayed = true;
                            GmCXt.playAudioTrack(message);
                        }

                    } else {
                        GmCXt.setOffAudioMode();
                    }

                    showAudioIcon();

                } else {
                    showAudioIcon();
                }

            } else {
                GmCXt.stopAudio();
                GmCXt.setOffAudioMode();

                showAudioIcon();
            }
        });

        function showAudioIcon() {
            mg$('.mgPlayerJSProd_play-step-audio-loader').hide();
            mg$(".mgPlayerJSProd_play-step-audio").css("opacity", "1");
        }
    }

    function setStepComTimeout(step) {
        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.setStepCompletionTimeout(step);
        }
    }

    function playStepPopupCloseButtonClickEvent() {
        GmCXt.log(33, "STOP guide event received");
        let forceClose = !GmCXt.playerI.testAutomation;
        GmCXt.confirmTourClose(forceClose);
    }

    function isClassicSetting() {
        return mg$('.mgPlayerJSProd_preview-step-popup-container').hasClass('mgPlayerJSProd_preview-step-popup-classic-design');
    }

    function showPrevButton() {
        if (isClassicSetting()) {
            GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-design-navigation-prev', {
                'display': 'flex'
            }, false);
        } else {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-prev', {
                'display': 'inline-block'
            }, false);
        }
        self.prev_button = true;
        mg$(".mgPlayerJSProd_play-step-prev").css({
            "opacity": "1",
            "pointer-events": "initial"
        });
    }

    function showNextButton() {
        let currStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        if (onChangeNextStep()) {
            if (isClassicSetting()) {
                mg$("#mgPlayerJSProd_play_step_next_classic").find('.mgPlayerJSProd_text-span').text(GmCXt.label.btnSkip);
            } else {
                mg$(".mgPlayerJSProd_play-step-next").find('.mgPlayerJSProd_span').text(GmCXt.label.btnSkip);
            }
        }

        if (!onChangeNextStep() || !currStep.step_settings.hideSkip) {
            if (isClassicSetting()) {
                GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-next', {
                    'display': 'flex'
                }, false);
            } else {
                GmCXt.setElementStyle('.mgPlayerJSProd_play-step-next', {
                    'display': 'inline-block'
                }, false);
            }
        }

        self.next_button = true;
    }

    function hidePrevButton() {
        if (isClassicSetting()) {
            GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-design-navigation-prev', {
                'display': 'none'
            }, false);
        } else {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-prev', {
                'display': 'none'
            }, false);
        }

        mg$(".mgPlayerJSProd_image-step-prev").hide();
    }

    function hideNextButton() {
        if (isClassicSetting())
            GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-next', {
                'display': 'none'
            }, false);
        else
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-next', {
                'display': 'none'
            }, false);

        mg$(".mgPlayerJSProd_image-step-next").remove();
    }

    function showDoneButton() {
        let currStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let ss = currStep.step_settings;

        GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
            'display': 'inline-block'
        }, false);

        if (ss.automation && ss.automation.hasHumanInteraction) {
            mg$(".mgPlayerJSProd_play-step").removeClass("mgPlayerJSProd_hide");
        }
        if (isClassicSetting()) {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-classic-done', {
                'display': 'inline-block'
            }, false);
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
                'width': '28%'
            }, true);
        } else {
            mg$(".mgPlayerJSProd_play-step").html(GmCXt.label.close);
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
                'min-width': '50px'
            }, true);
        }
    }

    function hideDoneButton() {
        GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
            'display': 'none'
        }, false);
        mg$(".mgPlayerJSProd_image-step-done").hide();
    }

    function showAutoIndicator() {
        mg$('#mgPlayerJSProd_play-step-automation-indicator-wrapper').show();
    }

    function hideAutoIndicator() {
        mg$('#mgPlayerJSProd_play-step-automation-indicator-wrapper').hide();
    }

    function showStopButton() {
        if (isClassicSetting()) {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-pause-classic', {
                'display': 'flex'
            }, false);
        } else {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-pause', {
                'display': 'inline-block'
            }, false);
        }
    }

    function hideStopButton() {
        if (isClassicSetting())
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-pause-classic', {
                'display': 'none'
            }, false);
        else
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step-pause', {
                'display': 'none'
            }, false);
    }

    function resetNavigationButton() {
        hidePrevButton();
        hideNextButton();
        hideDoneButton();
        hideStopButton();
    }

    function showNagivation() {
        let pi = GmCXt.playerI;
        mg$(".mgPlayerJSProd_hide").removeClass("mgPlayerJSProd_hide");
        mg$(".mgPlayerJSProd_preview-step-popup-navigation-wrapper").css("width", "calc(100% - 35px)");

        if (GmCXt.isLastStep(pi.currentStepId, pi.playStructure)) {
            mg$(".mgPlayerJSProd_preview-step-popup-navigation-wrapper").css("width", "100%");
        }
    }

    function hideButton(selector) {
        mg$(selector).addClass("mgPlayerJSProd_hide");
    }

    function hideNavigation() {
        hideButton(".mgPlayerJSProd_play-step-prev");
        hideButton(".mgPlayerJSProd_popup-classic-design-navigation-prev");
        hideButton(".mgPlayerJSProd_image-step-prev");
        hideButton(".mgPlayerJSProd_image-step-next");
        hideButton(".mgPlayerJSProd_play-step");
        hideButton(".mgPlayerJSProd_image-step-done");
        mg$(".mgPlayerJSProd_preview-step-popup-navigation-wrapper").css("width", "100%");
    }

    function addEventsOnPreviewPopup(step) {

        resetNavigationButton();
        self.prev_button = false;
        self.next_button = false;
        //show next button
        if (hasNextStep()) {
            showNextButton();
            hideDoneButton();
        }

        // show previous button
        let currStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let ss = currStep.step_settings;
        let automate = GmCXt.playerI.automate;

        showPrevBtnToggle(ss);

        if (automate) {
            showAutoIndicator();
            hideNavigation(); // Except 'Next' button

            if (ss.automation && !ss.automation.hasHumanInteraction) {
                hideNextButton();
                showStopButton();
            }
        } else {
            hideAutoIndicator();
        }

        // show done button
        if (GmCXt.isLastStep(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure) || (GmCXt.isDesktop() && GmCXt.playerI.isLastStep)) {
            hideNextButton();
            showDoneButton();
        }
        if ((GmCXt.isDesktop() && !GmCXt.playerI.isLastStep && !automate)) {
            showNextButton();
            hideDoneButton();
        }

        //hide previous button if totalStepCount is one
        if (parseInt(GmCXt.playerI.totalStepCount) == 1) {
            hidePrevButton();
        }

        mg$(".g" + "ss-play-linked-guide")
            .off("mousedown")
            .on("mousedown", playGuideOnLinkClick);
    }

    function showPrevBtn(ss) {

        if (tourStepSetting.hidePrevBtn) {
            if (ss.showPreviousStep)
                return true;
        } else if (!ss.hidePreviousStep) {
            return true;
        }
        return false;
    }

    function showPrevBtnToggle(ss) {
        let prevStep = GmCXt.getPreviousStep();
        if (showPrevBtn(ss)) {
            if (GmCXt.isDesktop() && !GmCXt.playerI.isFirstStep) {
                showPrevButton();
                return;
            }

            if (!GmCXt.isEmpty(prevStep) && showPrevBtnCond(prevStep)) {
                if ((mg$.inArray(prevStep.step_id, GmCXt.playedPreviousSteps) !== -1 || prevStep.step_settings.optional) &&
					pub.isLastStepVisible) {
                    showPrevButton();
                } else
                    pub.isLastStepVisible = true;
            }
        }
    }

    function showPrevBtnCond(step) {
        if (step.step_settings.keepNext === true ||
			step.step_settings.completionEvent === 'closeAfterDelay' ||
			step.step_type === GmCXt.STEP_TYPE_VIDEO) {
            return true;
        } else {
            return false;
        }
    }

    function playGuideOnLinkClick(e) {
        e.stopPropagation();
        let tourId = mg$(e.currentTarget).attr('href').split('tourId=')[1];
        if (tourId) {
            pub.closeStep();
            GmCXt.requestHandler.playLinkedGuide({
                tourId: tourId
            });
        }
    }

    var hasNextStep = function() {
        let pi = GmCXt.playerI;
        let currStep = GmCXt.getCurrentStep(pi.currentStepId);
        let ss = currStep.step_settings;
        let flag = false;

        if (ss.keepNext || ss.onChangeNext || ss.onKeyupNext || self.showNextButtonCV) {
            if (GmCXt.getTail(pi.currentStepId, pi.playStructure) !== null) {
                flag = true;
            }
        }

        return flag;
    };

    var onChangeNextStep = function() {
        let pi = GmCXt.playerI;
        let currStep = GmCXt.getCurrentStep(pi.currentStepId);
        let ss = currStep.step_settings;
        if (!GmCXt.isStepInlineBranch(currStep)) {
            if (ss.onChangeNext || ss.onKeyupNext) {
                return true;
            }
        }
        return false;
    };

    let hasClickNext = function() {
        let pi = GmCXt.playerI;
        let currStep = GmCXt.getCurrentStep(pi.currentStepId);
        let flag = false;

        if (currStep.step_settings.clickNext === true) {
            if (GmCXt.getTail(pi.currentStepId, pi.playStructure) !== null) {
                flag = true;
            }
        }

        return flag;
    };

    function toggle() {
        if (isClassicSetting()) {
            var next = mg$(".mgPlayerJSProd_popup-classic-navigation-next");
            GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-next', {
                'display': 'none'
            }, false);
            if (next.length > 1) {
                next[1].style.display = "block";
            } else {
                GmCXt.setElementStyle('.mgPlayerJSProd_popup-classic-navigation-next:first', {
                    'display': 'flex'
                }, false);
            }
        } else {
            var next = mg$(".mgPlayerJSProd_play-step-next-done:visible").hide().next();
            if (next.length > 1)
                next[1].style.display = "block";
            else
                mg$(".mgPlayerJSProd_play-step-next-done:first").show();
        }
    }

    function doneButtonConfiguration() {
        if (isClassicSetting()) {
            mg$(".mgPlayerJSProd_play-step").html(GmCXt.label.close);
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
                'width': '50px'
            }, true);
        } else {
            GmCXt.setElementStyle('.mgPlayerJSProd_play-step', {
                'width': '49%'
            }, true);
        }
        mg$(".mgPlayerJSProd_play-step").off("click").on("click", playStepPopupCloseButtonClickEvent);
    }

    window.onresize = function() {
        if (GmCXt.playerI && GmCXt.playerI.type === 'live') {
            let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

            if (step.step_type == "image" && !step.step_settings.isCvStep) {
                if (!GmCXt.isMediaPlayerOn) {
                    pub.closeStep();
                }
                playImageStep();
            }
        }
    };

    function createBlackoutViewPortInstance(options) {
        /**
			* Blackout area surrounding step DOM element for inline step
			* and surrounding highlighted areas for image steps.
			*/
        let ob = {
            id: options.step.step_id,
            type: options.step.step_type,
            title: options.step.step_title,
            description: options.step.step_description,
            audioTrack: options.step.step_audio,
            highlightedArea: options.step.highlightedArea,
            settings: options.step.step_settings,
            serialNumber: options.step.order || 0,
            container: options.container,
            containerOffest: options.containerOffest || {
                left: 0,
                top: 0
            },
            totalStepCount: options.totalStepCount,
            playingTour: options.playingTour || false
        };

        if (ob.playingTour && options.tour) {
            ob.tour = options.tour;
        } else {
            ob.tour = false;
        }

        if (ob.settings.screenBlackout === true) {

            if (!ob.highlightedArea) {
                ob.highlightedArea = [{
                    left: 0,
                    top: 0,
                    height: 0,
                    width: 0
                }];
            } else {

                var options = {
                    data: ob.highlightedArea,
                    containerOffset: GmCXt.getContainerOffSet(mg$('#mgPlayerJSProd_image_canvas')),
                    stepType: GmCXt.STEP_TYPE_IMAGE,
                    tour: ob.tour,
                    stepIndex: ob.serialNumber
                };

                if (ob.container) {
                    options.containerOffset = GmCXt.getContainerOffSet(ob.container);
                }
            }


            GmCXt.removeScreenOverlay();

            if (GmCXt.browserApp !== 'ie') {

                if (GmCXt.playerI && GmCXt.playerI.tour) {

                    let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
                    let overlayOpacity = GmCXt.getOpacity(step);

                    if (overlayOpacity) {
                        GmCXt.screenOverlayI = GmCXt.screenOverlay(options);
                        GmCXt.screenOverlayI.start();
                    }
                }
            }
        }
    }

    function triggerAutoClick() {
        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        let data = {
            requestId: step.step_id
        };

        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:command; task:trigger_step_click', data);
    }

    function autoModePlay(stepType) {
        let ret = false;
        if (GmCXt.playerI && GmCXt.playerI.automate) {
            self.ready = true;
            ret = true;
            if (GmCXt.isAutomationRunning()) {
                GmCXt.auto.updateAutomationMessage(stepType + " step was not tested as it is not supported", function() {
                    playNxtStep();
                });
            } else {
                playNxtStep();
            }
        }

        return ret;
    }

    function automatePlayStep() {

        if (GmCXt.autoTrigger) {
            clearTimeout(GmCXt.autoTrigger);
        }

        GmCXt.autoTrigger = GmCXt.timeout(function() {
            if (GmCXt.playerI && !GmCXt.playerI.pauseAutomate) {
                playNxtStep();
            }
        }, 3000);
    }

    let alertRedirect = function() {
        let url = getAlertRedirectUrl(GmCXt.playerI.tour.tour_settings);
        window.open(url, '_blank');
    };

    function getAlertURLByStepDomain(url) {
        let stepDomain = GmCXt.getHostnameFromUrl(url);

        if (GmCXt.isFQDN()) {
            let fullUrl = GmCXt.urlParts.href.split('/');

            if (fullUrl[0]) {
                url = url.replace(stepDomain, fullUrl[0]);
            }
        }

        url = GmCXt.urlParts.scheme + "://" + url;
        return url;
    }

    function getAlertRedirectUrl(tourSetting) {
        let url = getStepUrl();

        let envurls = tourSetting.redirectRules;
        if (!GmCXt.isEmpty(envurls) && GmCXt.isFQDN()) {
            let activeEnv = GmCXt.getAppEnvByDomain();
            envurls = envurls.filter(function(envData) {
                return envData.env === activeEnv;
            });
        }

        if (tourSetting.enableRuleRedirect) {
            url = getRedirectURLFromTourSetting(tourSetting);
        } else {
            url = getAlertURLByStepDomain(url);
        }


        return url;
    }

    function getRedirectURLFromTourSetting(tourSetting) {
        let envurls = tourSetting.redirectRules;
        if (!GmCXt.isEmpty(envurls) && GmCXt.isFQDN()) {
            let activeEnv = GmCXt.getAppEnvByDomain();
            envurls = envurls.filter(function(envData) {
                return envData.env === activeEnv;
            });
        }

        let url = getStepUrl();

        if (GmCXt.isEmpty(envurls)) {
            url = getAlertURLByStepDomain(url);
        } else {
            let path = envurls[0].path;

            if (path.includes('https://') || path.includes('http://')) {
                url = path;
            } else {
                url = GmCXt.urlParts.scheme + "://" + GmCXt.urlParts.host + "/" + path;
            }
        }
        return url;
    }

    function showStepRedirect(tourSetting) {
        let redirectUrl = getAlertRedirectUrl(tourSetting);
        let redirectUrl_ = GmCXt.filterUrlScheme(redirectUrl);
        let currUrl = GmCXt.filterUrlScheme(GmCXt.urlParts.fullUrl);

        if ((redirectUrl_ !== currUrl) && !GmCXt.isElectron()) {

            if (tourSetting.disableRedirect) {
                GmCXt.log(33, "NO REDIRECT PROMPT since disabled from Guide advanced settings");
                alertRedirect(tourSetting);
            } else {
                GmCXt.log(33, " REDIRECT PROMPT from Guide advanced settings");
                let option = {
                    description: GmCXt.label.stepNotFoundRedirect,
                    button1Callback: alertRedirect,
                    button1: GmCXt.label.btnYes,
                    button2: GmCXt.label.btnNo,
                    closeTour: true
                };
                GmCXt.alertV2(option).show();
            }
        } else {
            GmCXt.log(33, "NO REDIRECT since step URL matches current URL");
            if (GmCXt.playerI.stepRuleMatch === false) {
                var msg = GmCXt.label.stepRuleMatchErr;
                GmCXt.toastMsg(msg).show();
                GmCXt.log(33, "STEP RULE not matched");
                return false;
            } else if (GmCXt.playerI.guideRuleMatch === false) {
                var msg = GmCXt.label.guideRuleMatchErr;
                GmCXt.toastMsg(msg).show();
                GmCXt.log(33, "GUIDE RULE not matched");
                return false;
            }
        }
        return true;
    }

    function playSurveyStep() {
        self.ready = true;
        if (GmCXt.playerI.initiator === 'doitforme' || GmCXt.isAutomationRunning()) {
            GmCXt.log(33, "Skip Survey Step since doItForMe.");
            if (GmCXt.isAutomationRunning()) {
                GmCXt.auto.updateAutomationMessage("Survey step was not tested as it is not supported", function() {
                    playNxtStep();
                });
            } else {
                GmCXt.tourPlayerI.playNextStep();
            }
        } else {
            let pi = GmCXt.playerI;
            let step = GmCXt.getCurrentStep(pi.currentStepId);
            recordEvent(step);
            GmCXt.getSurveyScreen(GmCXt.createDeepCopy(pi), true);
        }
    }

    function desktopPlaySteps(ackMsg) {
        GmCXt.sendMessageToDesktop({
            stepId: GmCXt.playerI.currentStepId,
            requestId: GmCXt.playerI.requestId,
            ack: ackMsg
        });

        self.ready = false;
        pub.closeStep();

        return;
    }

    return pub;
};

/**
 * @file Guideme preview step popup
 * @author Nilesh Pachpande
 */

GmCXt.showTooltip = function(options) {
    options = options || {};

    let self = {
        description: GmCXt.replaceVariableWithValue(options.description),
        highlightedArea: options.highlightedArea,
        alignment: options.alignment,
        width: options.width,
        tour: options.tour,
        containerOffest: {
            left: 0,
            top: 0
        },
        tipClass: "gm-tip-" + options.tooltipId,
        tipId: options.tooltipId
    };

    self.description = GmCXt.updateOrgAndAddSignature(self.description);
    self.description = GmCXt.restoreAssetSrc(self.description);

    let brandLogo = GmCXt.brandLogo();

    function add() {
        let position = false;
        if (GmCXt.tourPlayerI) {
            position = GmCXt.tourPlayerI.cssPosition;
        }
        let html =
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_preview_step_popup_container' class='mgPlayerJSProd_preview-step-popup-container mgPlayerJSProd_step-tooltips mgPlayerJSProd_z-index-maximum " +
			self.tipClass + " " + GmCXt.getPosition(position) + "'>" +
			"	<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup'>" +
			"  		<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-tooltip-ctrls-wrapper'>";

        if (options.stepType === GmCXt.STEP_TYPE_MESSAGE) {
            html +=
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-close mgPlayerJSProd_tooltip-popup-close' id='" + self.tipId + "'>" +
				"	<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_tooltip-popup-close-svg'></wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";
        }

        html += "</wmgPlayerJSProd_>" +
			"		<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-header'>" +
			"			<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-wrapper'>";

        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_msg-tooltip-description mgPlayerJSProd_play-step-popup-s-title'>" +
			self.description +
			"</wmgPlayerJSProd_></wmgPlayerJSProd_></wmgPlayerJSProd_>" +

			"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-footer'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_brand-logo mgPlayerJSProd_play-step-popup-logo mgPlayerJSProd_inline-block-vm'>" +
			"<img src='" + brandLogo + "' class='mgPlayerJSProd_custom-image' />" +
			"</wmgPlayerJSProd_></wmgPlayerJSProd_></wmgPlayerJSProd_></wmgPlayerJSProd_>";

        mg$("html").append(html);

        mg$(".mgPlayerJSProd_tooltip-popup-close-svg").html(GmCXt.svgs.close_popup);

        GmCXt.zoomImage(self.description, ".mgPlayerJSProd_msg-tooltip-description");
        GmCXt.setLinkClickhandler(self.description, ".mgPlayerJSProd_msg-tooltip-description");
        if (self.description.indexOf('target = "gssPlayGuide"' !== -1)) {
            GmCXt.setLinkGuidePlay(self.description, ".mgPlayerJSProd_msg-tooltip-description");
        }

        GmCXt.onPopupRerender();
    }

    function align() {
        let $popup = mg$("." + self.tipClass);

        let a = GmCXt.alignPopup({
            popup: $popup,
            highlightedArea: self.highlightedArea[0],
            containerOffest: self.containerOffest,
            alignment: self.alignment
        });

        a.clear();

        let alignment = a.start();

        if (alignment) {
            $popup.addClass(alignment);
        }
    }

    function setDesign() {
        let popupDesign = GmCXt.getStepSettings().popupDesign;

        mg$('.mgPlayerJSProd_tooltip-wrapper').css('max-height', '400px');

        if (popupDesign.type === 'classic') {
            mg$('.mgPlayerJSProd_preview-step-popup-container').addClass('mgPlayerJSProd_preview-step-popup-classic-design');
            mg$('.mgPlayerJSProd_brand-logo').css({
                'display': 'none'
            });
        }

        // For backward compatibility
        if (popupDesign.popupActiveSettings) {
            popupDesign.current = popupDesign.popupActiveSettings;
        }

        mg$('.' + self.tipClass).css({
            "background-color": popupDesign.current.bgColor,
            "border-color": popupDesign.current.borderColor,
            "border-width": popupDesign.current.borderWidth,
            "border-radius": popupDesign.current.borderRadius,
            "border-style": "solid",
            "zIndex": '2147483647',
            "padding-top": popupDesign.current.padding.top,
            "padding-bottom": popupDesign.current.padding.bottom,
            "padding-left": popupDesign.current.padding.left,
            "padding-right": popupDesign.current.padding.right
        });

        mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description').css({
            "color": popupDesign.current.stepTitleColor
        });
        let len = mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description img').length;
        if (len) {
            for (let i = 0; i < len; i++) {
                let imgW = mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description img')[i].getAttribute('width');
                let imgH = mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description img')[i].getAttribute('height');

                mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description img')[i].style.setProperty('width', imgW + 'px', 'important');
                mg$('.' + self.tipClass + ' .mgPlayerJSProd_msg-tooltip-description img')[i].style.setProperty('height', imgH + 'px', 'important');
            }
        }

        if (GmCXt.getOrgLevelBrandLogoSetting()) {
            mg$("." + self.tipClass + " .mgPlayerJSProd_brand-logo img").hide();
        } else {
            mg$("." + self.tipClass + " .mgPlayerJSProd_brand-logo img").show();
        }

        mg$("." + self.tipClass).css({
            "width": self.width
        });
    }

    function onClose(e) {
        let currentTip = e.currentTarget.id;

        mg$(".gm-tip-" + currentTip).remove();
        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:clear_dom_outline", {
            id: currentTip
        });
        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:clear_message_tooltip", {
            id: GmCXt.playerI.currentStepId + '_' + currentTip
        });
        changeOpacity(currentTip);
    }

    function changeOpacity(currentTip) {
        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let s = step.step_settings;
        if (!s.overlayOpacity) return;
        if (s.highlightedArea && GmCXt.highlight_elements) {

            delete GmCXt.highlight_elements[currentTip];
            GmCXt.applyOverlayMessageStep(GmCXt.highlight_elements);
        }
    }

    mg$("." + self.tipClass).remove();
    add();
    mg$("." + self.tipClass).show();
    mg$('.mgPlayerJSProd_tooltip-popup-close').off('click').on('click', onClose);

    setDesign();
    align();
};

/**
	* @author Nilesh Pachpande
	*/
GmCXt.listenerBackgroud = function(request) {
    // Parse and normalize the request
    request = GmCXt.parseJSON(request);
    if (!request.data) {
        request = GmCXt.convertMgdata(request);
    }

    // Check if the current domain is registered in apps
    let appDomainExist = true;
    if (GmCXt.isPlayer() && !GmCXt.isEmpty(GmCXt.urlParts) && !GmCXt.isEmpty(GmCXt.appList)) {
        let domainApp = GmCXt.checkDomainInApps(GmCXt.urlParts.fullUrl);
        if (domainApp && !domainApp.appName) {
            appDomainExist = false;
        }
    }

    // Early exit for disabled panel
    if (request.action === 'mgPlayerJSProd_action:browser_action_icon_click' &&
        (GmCXt.isExcludeDomain() || !appDomainExist)) {
        GmCXt.showPanelDisabledPopup();
        return true;
    }
    // Define all action handlers here in a map for efficient lookup
    const actionHandlers = {
        'mgPlayerJSProd_action:open_panel_after_capture': () => {
            GmCXt.clearStepReq();
            GmCXt.openAppPanel();
        },

        'mgPlayerJSProd_action:browser_action_icon_click': () => {
            if (GmCXt.initialization && GmCXt.initialization.sidePanel && appDomainExist) {
                if (GmCXt.isInspectToolON()) {
                    GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:stop_inline_step_selection_mode');
                }
                GmCXt.openAppPanel(null, 'extension');
            }
        },

        'mgPlayerJSProd_action:user_logged_out': () => {
            GmRootScope.logout("fromOtherTab");
        }
    };

    // Execute the handler if it exists
    const handler = actionHandlers[request.action];
    if (handler) {
        handler();
    } else if(GmCXt.playerAppMsgHandler) {
        GmCXt.playerAppMsgHandler(request);
    }

    return true;
};


GmCXt.listenTopWinPlayer = function(event) {
    event = mg$.extend({}, event);
    if (GmCXt.verifyMsg(event)) {
        GmCXt.processTopWinPlayer(event);
        GmCXt.processIframePlayer(event);
    }
};

GmCXt.processTopWinPlayer = function(event) {

    let message = event.data;

    switch (message.action) {

    case 'mgPlayerJSProd_action:update_PI_steps_done':
    case 'mgPlayerJSProd_action:update_PI_PS_done':
        if (GmCXt.globalMsgData[message.action]) {
            GmCXt.globalMsgData[message.action].cb();
            delete GmCXt.globalMsgData[message.action];
        }
        break;

    case 'mgPlayerJSProd_action:automation_check_reload':
        if (!GmCXt.playerI) {
            GmCXt.playerI = message.data.playerInstance;
        }
        GmCXt.auto.newTabStepFound(message.data.pageReloadOption, message.data.isNextStep);
        break;

    case 'mgPlayerJSProd_action:set_iframe_id':
        GmCXt.currentIframeId = message.data.currentIframeId;
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:set_iframe_id:do', message.data);
        break;

    case 'mgPlayerJSProd_action:set_iframe_id:beacon':
        GmCXt.beaconIframe[message.data.tour_id].frameId = message.data.frameId;
        break;

    case 'mgPlayerJSProd_action:set_iframe_id:tooltip':
        GmCXt.smartTipIframe[message.data.step_id].frameId = message.data.frameId;
        break;

    case 'mgPlayerJSProd_action:set_iframe_id:tag':
        GmCXt.tagIframe[message.data.step_id].frameId = message.data.frameId;
        break;

    case 'mgPlayerJSProd_action:position_play_pause_toolbar':
        GmCXt.handlePositionToolbar(event);
        break;

    case 'mgPlayerJSProd_action:get_cdn_signature':
        GmCXt.getCdnSignature(true);
        break;

    case 'mgPlayerJSProd_action:clear_outline;action:inform':
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:clear_outline;action:do', message.data);
        break;

    case 'mgPlayerJSProd_action:enable_next_button':
        GmCXt.requestHandler.enableNextButton();
        break;

    case 'mgPlayerJSProd_action:open_app_panel':
        GmCXt.handleOpenApp(event);
        break;

    case 'mgPlayerJSProd_action:play_linked_tour':
        GmCXt.requestHandler.playLinkedGuide(message.data);
        break;

    case 'mgPlayerJSProd_action:play_tour;event:beacon_click':
        GmCXt.handleEventBeaconClick(event);
        break;

    case 'mgPlayerJSProd_action:close_step':
        GmCXt.requestHandler.closeStep();
        break;

    case 'mgPlayerJSProd_action:completed;task:select_dom_element_tooltips':
        GmCXt.timeout(function() {
            GmCXt.requestHandler.handleEventSelectDOMElTooltip(event, message.data);
        }, 500);
        break;

    case 'mgPlayerJSProd_action:find_other_msg_step_tooltips':
        GmCXt.requestHandler.findOtherTooltips(message.data);
        break;

    case 'mgPlayerJSProd_action:completed;task:select_existing_dom_element':

        GmCXt.timeout(function() {
            GmCXt.requestHandler.handleEventSelectDOMElement(event, message.data);
        }, 500);
        break;

    case 'mgPlayerJSProd_action:hide_current_page_guide_indicator':

        break;

    case 'mgPlayerJSProd_action:go_to_web_tour':
        var webUrl = (message.data && message.data.webUrl) ? message.data && message.data.webUrl : false;
        if (webUrl) {
            window.open(webUrl, "_blank");
        }
        break;

    case 'mgPlayerJSProd_action:save_org':
        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:save_org_in_iframes", {
            org: message.data
        });

        break;

    case 'mgPlayerJSProd_action:start_step_completion_timeout':
        if (GmCXt.tourPlayerI && message.data && message.data.step) {
            GmCXt.tourPlayerI.setStepCompletionTimeout(message.data.step);
        }
        break;

    case 'mgPlayerJSProd_action:set_audio_storage':
        if (message.data && GmCXt.playerI.playAudio) {
            GmCXt.stepAudioRunningStatus = message.data.stepAudioRunningStatus;
            GmCXt.storage().set(message.data);
        }

        GmCXt.updateAudioStatusForTracking();

        break;

    case 'mgPlayerJSProd_action:pause_playing_audio':
        if (GmCXt.audioObject) {
            GmCXt.audioObject.pause();
        }

        break;

    case 'mgPlayerJSProd_action:set_style_audio_icon':
        var os = GmCXt.getStepSettings();
        if (os) {
            let popupDesign = os.popupDesign;

            if (popupDesign) {

                let popUpCSS = "<style id='mgPlayerJSProd_popup-arrow' type='text/css'>" +
						".mgPlayerJSProd_play-step-audio-on svg path {" +
						"fill:" + popupDesign.current.closeIconColor + "!important;" +
						"}" +
						".mgPlayerJSProd_play-step-audio-off svg path {" +
						"fill:" + popupDesign.current.closeIconColor + "!important;" +
						"}" +
						"html, body {" +
						"background:" + popupDesign.current.bgColor + " !important;" +
						"}" +
						"</style>";

                GmCXt.sendMsgToAudioFrame('mgPlayerJSProd_action:set_style_audio_icon_response', {
                    data: popUpCSS,
                    user: GmCXt.user
                });
            }
        }
        break;
    case 'mgPlayerJSProd_action:hide_pop_audio_ctrl':
        mg$('.mgPlayerJSProd_audio-pop-icons').hide();
        break;

    case 'mgPlayerJSProd_action:survey_start;task:show_survey':
        GmCXt.playSurvey(message.data);
        break;

    case 'mgPlayerJSProd_action:exit_survey_start;task:show_survey':
        mg$(window).focus();
        GmCXt.isSurveyVisible = true;
        GmCXt.surveyStart(message.data, true);
        break;

    case "mgPlayerJSProd_action:record_event;testMe":
        GmCXt.requestHandler.recordEventTestMe(message.data);
        break;

    case 'mgPlayerJSProd_action:show_toast_message':
        GmCXt.toastMsg(message.data).show();
        break;

    case 'mgPlayerJSProd_action:completed;task:select_dom_element_for_rules':
        GmCXt.ruleEngine.onSuccessDOMRuleMatch(message.data);
        break;

    case 'mgPlayerJSProd_action:play_next_step':
        GmCXt.requestHandler.playTourNextStep();
        break;

    case 'mgPlayerJSProd_action:click_event_for_guide':
        GmCXt.requestHandler.pageClickForGuide(message);
        break;

    case 'mgPlayerJSProd_action:set_audio_icon_off':
        GmCXt.setOffAudioMode();
        break;

    case 'mgPlayerJSProd_action:set_audio_icon_off_onboar':
        GmCXt.setOffOnBoarAudioMode();
        break;

    case 'mgPlayerJSProd_action:set_audio_icon_on_onboar':
        GmCXt.setOnOnBoarAudioMode();
        break;

    case 'mgPlayerJSProd_action:page_clicked':
        GmCXt.triggerChangeListeners('page_click');
        break;

    case 'mgPlayerJSProd_action:start_point_found':
        GmRootScope.handleStartPointFound(message.data);
        break;

    case 'mgPlayerJSProd_action:start_point_not_found':
        GmRootScope.handleStartPointNotFound(message.data);
        break;

    case 'mgPlayerJSProd_action:next_step_found':
        GmRootScope.handleNextStepFound();
        break;

    case 'mgPlayerJSProd_action:get_survey_data':
        GmCXt.getSurveyDetailsAndPlay(message.data);
        break;

    case 'mgPlayerJSProd_action:init;task:select_dom_element_for_rules':
        GmCXt.sendMessageToAllWindows(
            'mgPlayerJSProd_action:started;task:select_dom_element_for_rules',
            message.data);
        break;

    case 'mgPlayerJSProd_action:preview_beacon':

        break;

    case 'mgPlayerJSProd_action:tour_loop_completed':
        GmCXt.requestHandler.playAutoTour();
        break;

    case 'mgPlayerJSProd_action:close_guide':
        if (GmCXt.tourPlayerI) {
            let fromShowme = message.data.fromShowme;
            GmCXt.tourPlayerI.closeGuide(false, fromShowme);
        }
        break;

    case 'gmPlayerXt_action:snow_panel_open': // for backward compatibility
    case "mgPlayerJSProd_action:snow_panel_open":
        if (GmCXt.isPlayer() && GmCXt.serviceNow())
            GmCXt.openAppPanel();
        break;

    case 'mgPlayerJSProd_action:show_ducttape_alert':
        GmCXt.showDuctTapeAlert(message.data);
        break;

    case 'mgPlayerJSProd_action:show_smarttip':
        GmCXt.requestHandler.showSmarttip(message.data, event);
        break;

    case 'mgPlayerJSProd_action:show_beacon':
        GmCXt.requestHandler.setBeaconPosition(message, event);
        break;

    case 'mgPlayerJSProd_action:toggle_beacon_visibility':
        GmCXt.requestHandler.toggleBeacon(message);
        break;

    case 'mgPlayerJSProd_action:trigger_next_click':
        if (GmCXt.playerI && GmCXt.playerI.testAutomation) {
            GmCXt.tourPlayerI.playNextStep();
            return;
        }
        var btn = GmCXt.getNextBtnElem();
        GmCXt.triggerClick(btn);
        break;

    case 'mgPlayerJSProd_action:play_next_step_automator':
        GmCXt.tourPlayerI.playNextStep();
        break;

    case 'mgPlayerJSProd_action:rotate_gear':
        GmCXt.rotateGear();
        break;

    case 'mgPlayerJSProd_action:complete:get_cards':
        GmCXt.successCallbackCards(message);
        break;

    case 'mgPlayerJSProd_action:open_power_form':
        GmCXt.openPowerForm(message.data);
        break;

    case 'mgPlayerJSProd_action:error:get_cards':
        GmCXt.errorCallbackCards(message);
        break;

    case 'mgPlayerJSProd_action:hide_smarttip_delay':
        GmCXt.requestHandler.hideSmarttipDelay(message.data, message.data.options);
        break;

    case 'mgPlayerJSProd_action:clear_smarttip_delay_timeout':
        GmCXt.clearTooltipTimeout();
        break;

    case 'mgPlayerJSProd_action:hide_validation_smarttip':
        GmCXt.requestHandler.hideValidationSmarttip(message.data);
        break;

    case 'mgPlayerJSProd_action:hide_smarttip':
        GmCXt.requestHandler.hideSmartTip(message.data);
        break;

    case 'mgPlayerJSProd_action:initialize_image_iframe_popup':
        GmCXt.setImagePopUp();
        break;

    case 'mgPlayerJSProd_action:open_image_iframe_popup':
        GmCXt.openImagePopup(message.data);
        break;

    case 'mgPlayerJSProd_action:play_guide_from_link':
        GmCXt.getTourAndPlay(message.data.tourId, message.data.initiator);
        break;

    case 'mgPlayerJSProd_action:play_guide_from_notification':
        GmCXt.playLiveTour(message.data.tour, 0, 'overlayTourPopup', message.data.isAutolaunchTriggered, 'live');
        break;

    case 'mgPlayerJSProd_action:update_beacons_on_screen':
        GmCXt.updateBeaconsOnScreen(message.data.jobId, message.data.isValid);
        break;

    case 'mgPlayerJSProd_action:update_smarttip_on_screen':
        GmCXt.updateOnScreenTooltipGuideInfo(message.data.tour, message.data.tourId, message.data.stepId, message.data.isValid, message.data.smartTip, message.data.url);
        break;

    case 'mgPlayerJSProd_action:update_tooltip_action_info':
        var d = message.data;
        GmCXt.updateTooltipActionInfo(d.tourId, d.stepId, d.smartTip, d.actionName);
        break;

    case 'mgPlayerJSProd_action:set_auto_tour':
        GmCXt.setAutoTour(message.data.tourId);
        break;

    case 'mgPlayerJSProd_action:clear_player_instance':
        GmCXt.cleanPlayer();
        break;

    case 'mgPlayerJSProd_action:print_debug_log':

        break;

    case 'mgPlayerJSProd_action:keep_watching_step:inform':
        GmCXt.handleRestartInParent();
        break;

    case 'mgPlayerJSProd_action:update_PI_PS':
        GmCXt.requestHandler.updatePIPS(message.data);
        break;

    case 'mgPlayerJSProd_action:update_PI_steps':
        GmCXt.requestHandler.updatePISteps(message.data);
        break;

    case 'mgPlayerJSProd_action:update_tooltip_tracking':
        GmCXt.tooltipTrackingList = message.data.trackingInfo;
        break;

    case 'mgPlayerJSProd_action:hide_inline_step_popup':
        mg$('.mgPlayerJSProd_preview-step-popup-container').css({
            'display': 'none'
        });
        mg$('.mgPlayerJSProd_screen-blackout').hide();
        GmCXt.stopAudio();
        var iframe = document.getElementById('mgPlayerJSProd_play-step-audio-iframe');
        if (iframe && iframe.src) {
            iframe.src = iframe.src;
        }
        GmCXt.stepAudioPlayed = false;
        GmCXt.displayWidget();
        break;

    case 'mgPlayerJSProd_action:hide_inline_step_popup_tootip':
        mg$('.gm-tip-' + message.data.id).css({
            'display': 'none'
        });
        break;

    case 'mgPlayerJSProd_action:step_element_hidden':
        GmCXt.tourPlayerI.isLastStepVisible = false;
        GmCXt.stepAudioPlayed = false;
        GmCXt.stopAudio();
        break;

    case 'mgPlayerJSProd_action:check_iframe_visible':
        if (message.data && message.data.selector) {
            GmCXt.highlighter.bringElementInViewport({}, message.data.selector, true);
        }
        break;

    case 'mgPlayerJSProd_action:track_notification_for_automation':
        GmCXt.auto.trackNotificationForAutomation(message.data);
        break;

    case 'mgPlayerJSProd_action:stop_automation':
        GmCXt.auto.stop(true);
        break;

    case 'mgPlayerJSProd_action:update_click_time':
        GmCXt.clickTime = message.data.clickTime;
        break;

    case 'mgPlayerJSProd_action:update_secrets':
        GmCXt.trackerUtil.secrets = message.data.secrets;
        GmCXt.storage().set({
            'tracker_secrets': JSON.stringify(GmCXt.trackerUtil.secrets)
        });
        break;

    case 'mgPlayerJSProd_action:track_element_not_found':
        GmCXt.trackElNotFound(message.data);
        break;

    case 'mgPlayerJSProd_action:send_dom_tracker_info':
        GmCXt.combineDomTrackerData(message.data);
        break;

    case 'mgPlayerJSProd_action:preview_sound':
        GmCXt.sendMessageToDesktop(message.data);
        break;

    case 'mgPlayerJSProd_action:track_beacon_feature':
        GmCXt.trackerV1.trackBeacons(message.tour, message.eventType);
        break;

    case 'mgPlayerJSProd_action:set_audio_mode_on':
        var d = {
            user: GmCXt.user
        };

        GmCXt.sendMsgToAudioFrame('mgPlayerJSProd_action:set_audio_mode_on', d);
        break;

    case 'mgPlayerJSProd_action:set_audio_mode_off':
        var d = {
            user: GmCXt.user
        };
        GmCXt.sendMsgToAudioFrame('mgPlayerJSProd_action:set_audio_mode_off', d);

        break;
    case 'mgPlayerJSProd_action:set_feature_tag_storage':
        GmCXt.setFeatureTagStorage(message.data);
        break;

    case 'mgPlayerJSProd_action:reset_activity_timer':
        GmCXt.resetIdleActivityTimer();
        break;

    default:
    }
};

GmCXt.addTagPayloadInStorage = function(data, existingPayloadArray) {
    let featureTagPayload = GmCXt.trackerV1.getFeatureTagPayload(data);
    let featureData = [];
    let featureTagPayloadArray = [];

    if (!GmCXt.isEmpty(existingPayloadArray)) {
        featureTagPayloadArray = existingPayloadArray;
    }

    let featureTag = {
        step_id: data.step_id,
        tour_id: data.tour_id,
        step_type: "feature_tag",
        event_time: [new Date().getTime()]
    };

    featureData.push(featureTag);
    featureTagPayload.miscellaneous.sequence = featureData;
    featureTagPayload.is_tracking_enabled = parseInt(data.is_tracking_enabled);
    featureTagPayloadArray.push(featureTagPayload);

    GmCXt.log(16, "Feature tag record is stored in storage.",featureTagPayloadArray);

    GmCXt.storage().set({
        'insightFeatureTagData': JSON.stringify(featureTagPayloadArray)
    });
};


GmCXt.setFeatureTagStorage = function(data) {
    GmCXt.storage().get(['insightFeatureTagData']).then(res => {
        const rawPayload = res?.insightFeatureTagData;
        const existingData = !GmCXt.isEmpty(rawPayload) ? GmCXt.parseJSON(rawPayload) : [];

        if (GmCXt.isEmpty(existingData)) {
            GmCXt.addTagPayloadInStorage(data);
            return;
        }

        const tourIndex = existingData.findIndex(item => item.entity_code === data.tour_id);

        if (tourIndex !== -1) {
            let sequence = existingData[tourIndex].miscellaneous.sequence;

            // Handle if sequence is a JSON string
            if (typeof sequence === 'string') {
                sequence = GmCXt.parseJSON(sequence);
            }

            const stepIndex = sequence.findIndex(step => step.step_id === data.step_id);
            const currentTime = new Date().getTime();

            if (stepIndex !== -1) {
                const existingTimestamps = sequence[stepIndex].event_time;
                // Only add a new timestamp if 10 sec time has passed since the last recorded timestamp
                if (existingTimestamps.length > 0) {
                    const lastRecordedTimestamp =  existingTimestamps[existingTimestamps.length - 1];
                    const timeElapsed = currentTime - lastRecordedTimestamp;
                    if (timeElapsed > GmCXt.t_.sec10){
                        sequence[stepIndex].event_time.push(currentTime);
                    }
                }

            } else {
                sequence.push({
                    step_id: data.step_id,
                    tour_id: data.tour_id,
                    step_type: "feature_tag",
                    event_time: [currentTime]
                });
            }

            existingData[tourIndex].miscellaneous.sequence = sequence;

            GmCXt.log(16, "Feature tag record is stored in storage.",existingData);

            GmCXt.storage().set({
                'insightFeatureTagData': JSON.stringify(existingData)
            });

        } else {
            GmCXt.addTagPayloadInStorage(data, existingData);
        }
    });
};



GmCXt.eventApiCall = function(payload) {
    let keys = GmCXt.trackerUtil.secrets;

    if (!keys) {
        GmCXt.storage().get([
            'tracker_secrets'
        ]).then(function(r) {
            keys = r.tracker_secrets;
            if (keys && !keys.registerClientId) {
                keys = GmCXt.parseJSON(keys);
            }
            GmCXt.addPayload(keys, payload);
        });
    } else {
        GmCXt.addPayload(keys, payload);
    }
};

GmCXt.addPayload = function(keys, payload) {
    if (keys && keys.registerClientId) {
        let jsonData = {
            "app_client_id": keys.registerClientId,
            "payload": [],
            "signature": ''
        };

        if (payload.event_type === "mi_logout") {
            GmCXt.isLogoutTrackApi = true;
        }

        jsonData.event_chain_id = GmCXt.ANALYTICS_EVENT_CHAIN_ID;

        if (GmCXt.isDefined(payload.length) && payload.length) {
            jsonData.payload = payload;
        } else {
            jsonData.payload = [payload];
        }
        jsonData.signature = SHA256(SHA256(JSON.stringify(jsonData.payload)) + keys.app_client_secret).toString();

        if (GmCXt.isEventTimeValid(jsonData.payload[0].event_time)) {
            GmCXt.trackerV1.apiV1(jsonData);
        }
    }
};

GmCXt.getTourDetails = function(d) {
    return new Promise(function(resolve, reject) {
        GmCXt.api.getTour(d, function(_tour) {
            if (GmCXt.isPlayer() && GmRootScope.notDefaultLang() && _tour) {
                _tour = GmRootScope.getTranslatedTourAndSteps(_tour, GmRootScope.language);
            }
            resolve(_tour);
        }, reject);
    });
};

GmCXt.toggleSidePanel = function(fullscreen) {

    if (fullscreen) {
        if (GmCXt.isMicroPlayer()) {
            mg$('.mgPlayerJSProd_panel').css({
                'width': '100%',
                'left': '0px',
                'right': '0px',
                'height': '100vh',
                'min-width': '100%'
            });
        } else {
            mg$('.mgPlayerJSProd_panel').css({
                'width': '100%',
                'left': '0px',
                'right': 'initial',
                'top': '0',
                'display': 'block'
            });
        }
    } else {

        if (GmCXt.APP_PANEL_OPEN) {
            if (GmCXt.isMicroPlayer()) {
                mg$('.mgPlayerJSProd_panel').removeAttr('style');
            }

            mg$('.mgPlayerJSProd_panel').css({
                'width': '500px',
                'right': '0px'
            });

            if (window.matchMedia("(max-width: 480px)").matches && !GmCXt.isMiniPlayer) {
                mg$('.mgPlayerJSProd_panel').css({
                    'width': '85%'
                });
            }

            mg$('.mgPlayerJSProd_panel').css({
                'left': 'initial'
            });

        } else {
            mg$('.mgPlayerJSProd_panel').removeAttr('style');
            GmCXt.closeAppPanel();
        }
    }
};

GmCXt.increaseSidePanelWidth = function() {
    GmCXt.toggleSidePanel(true);
    mg$('.mgPlayerJSProd_panel').css({
        'width': '100%',
        'left': '0px',
        'right': 'initial'
    });

    if (!GmCXt.isMicroPlayer()) GmCXt.hidePanelCloseBtn();
};

GmCXt.reduceSidePanelWidth = function() {
    GmCXt.toggleSidePanel(false);
    if (!GmCXt.isMicroPlayer()) GmCXt.showPanelCloseBtn();
};

GmCXt.updateAppListSettingsInAllFrames = function(d) {
    if (!GmCXt.isEmpty(GmCXt.appList)) {

        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];
        var d = {};

        if (activeApp && activeApp.settings) {
            d.activeAppSettings = activeApp.settings;
        }
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:update_app_settings', d);
    }
};

GmCXt.requestHandler.printDebugLog = function(d) {
    GmCXt.log(d.mode, d.str, d.opt);
};

GmCXt.requestHandler.updatePIPS = function(d) {
    GmCXt.playerI.playStructure = d;
    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:update_PI_PS_done');
};

GmCXt.requestHandler.updatePISteps = function(d) {
    GmCXt.playerI.tour.steps = d;
    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:update_PI_steps_done');
};

GmCXt.updateNotiDoNotShow = function(tour_id) {
    GmCXt.storage().get(['tourIdArray', 'toursClosed']).then(function(st) {
        let doNotShowTours = GmCXt.parseJSON(st.tourIdArray);
        if (doNotShowTours[tour_id]) {
            delete doNotShowTours[tour_id];
            GmCXt.storage().set({
                'tourIdArray': doNotShowTours
            });
        }
        let toursClosedByUser = GmCXt.parseJSON(st.toursClosed);
        GmCXt.updNotifDataSidePanel(toursClosedByUser, doNotShowTours);
    });
};

GmCXt.updateNotiWatchLater = function(tour_id) {
    GmCXt.storage().get(['tourIdArray', 'toursClosed']).then(function(st) {
        let toursClosedByUser = GmCXt.parseJSON(st.toursClosed);
        if (toursClosedByUser[tour_id]) {
            delete toursClosedByUser[tour_id];
            GmCXt.storage().set({
                'toursClosed': toursClosedByUser
            });
        }
        let doNotShowTours = GmCXt.parseJSON(st.tourIdArray);
        GmCXt.updNotifDataSidePanel(toursClosedByUser, doNotShowTours);
    });
};

GmCXt.handleRestartInParent = function() {
    GmCXt.storage().remove(['restartInParent']);
    let cb = function() {
        GmCXt.storage().get(['restartInParent']).then(function(st) {
            if (st.restartInParent) {
                clearInterval(intervalId);
                GmCXt.log(33, "STOP WATCHING and restart guide in parent window.");
                GmCXt.processActiveReq();
                GmCXt.storage().remove(['restartInParent']);
                return;
            }
        });
    };
    var intervalId = null;
    clearInterval(intervalId);
    intervalId = setInterval(cb, 1000);
};

GmCXt.handleUpdatePlayerMode = function(d) {
    GmCXt.initPlayerModeFeatures(d.showPlayer, d.isMiniPlayer, d.playerMode);
    GmCXt.setPanelTopLeft();

    if (GmCXt.isMicroPlayer()) {
        GmCXt.addDragMicroPlayerFunction();
        mg$(".mgPlayerJSProd_panel").removeClass('mgPlayerJSProd_mobile-view');
    }
};

GmCXt.showDuctTapeAlert = function(data) {
    let options = {
        title: "",
        description: GmCXt.updateOrgAndAddSignature(GmCXt.replaceVariableWithValue(data.desc)),
    };

    GmCXt.alert(options).show();
    mg$(".mgPlayerJSProd_popup-content-info").css('max-height', "250px");
    mg$(".mgPlayerJSProd_popup-content-info").css('overflow', "auto");
    mg$(".mgPlayerJSProd_popup-content-info *").css('width', "auto");
};

GmCXt.startAuto = function(app) {
    GmCXt.auto.init(app);
};

GmCXt.initSfdc = function(m) {

    if (GmCXt.FT.isPlayer) {

        let userData = GmCXt.parseJSON(m);
        userData.user = GmCXt.validateDataModel(userData.user, GmCXt.model.user);

        GmCXt.isSFDCApp = true;

        let session = false;

        if (!GmCXt.user) {
            const data = {
                data: userData
            };
            GmCXt.onUserSignin(data);
            session = true;
        } else if (GmCXt.user.user_email === userData.user.user_email) {
            session = true;
        }

        var m = {
            action: "mgPlayerJSProd_action:sfdc_app_acknowledgement",
            data: {
                session: session
            }
        };
        GmCXt.msgToThisWin(m);

        m.action = "gmPlayerXt_action:sfdc_app_acknowledgement";
        GmCXt.msgToThisWin(m);
    }
};

GmCXt.handlePositionToolbar = function(event) {
    let message = event.data;

    if (message.data.position === 'top') {
        mg$('.mgPlayerJSProd_play-pause-toolbar').css({
            top: '5px'
        });
    } else if (message.data.position === 'bottom') {
        let bpos = mg$(window).height() - 141;
        mg$('.mgPlayerJSProd_play-pause-toolbar').css({
            top: bpos + 'px'
        });
    }
};

GmCXt.handleUpdateCdnSign = function(user) {

    GmCXt.updateGlobalUser(user);
    GmCXt.showWidget();
    GmCXt.showChatIcon();
    GmCXt.reloadFailedImages();
};

GmCXt.handleEventBeaconClick = function(event) {
    let message = event.data;
    if (message.data && message.data.tourId) {

        let data = {
            tour_id: message.data.tourId
        };
        GmCXt.getTourDetails(data).then(function(_tour) {

            GmCXt.playLiveTour(_tour, 0, 'beaconTour', false, 'live');

        });
    }
};

GmCXt.handleStartTest = function(message) {

    let checkCurrentDomain = GmCXt.requestHandler.checkTestMeDomain(message.data);
    if (checkCurrentDomain) {
        GmCXt.log(58, "DOMAIN MATCHED, START MyTest");
        GmCXt.requestHandler.startToolTestMe(message.data);
    } else {
        GmCXt.log(58, "DOMAIN DID NOT MATCH, show REDIRECT message");
        GmCXt.requestHandler.redirectToUrl(message.data);
    }
};

GmCXt.handleOpenApp = function(event) {
    let message = event.data;
    let byPassRoute = (message.data && message.data.byPassRoute) ? "byPassRoute" : null;
    GmCXt.openAppPanel(byPassRoute);
};

GmCXt.handlePreviewTooltip = function(message) {

    GmCXt.closeAppPanel();
    GmCXt.hideTips();
    GmCXt.smartTipPreviewOn = true;

    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:smarttip_preview_on');

    GmCXt.timeout(function() {
        GmCXt.renderSmartTips(message.data, true);
    }, 0);
};

GmCXt.handlePreviewBeacon = function(data) {

    GmCXt.closeAppPanel();
    GmCXt.hideTips();

    GmCXt.timeout(function() {
        GmCXt.renderBeacons(data, true);
    }, 0);
};

GmCXt.handleAppInit = function() {

    if (GmCXt.isExcludeDomain()) {
        return;
    }

    GmCXt.initialization.sidePanel = true;

    if (!GmCXt.mgActiveLang && GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization) &&
		GmCXt.organization.admin_settings.language_settings &&
		GmCXt.organization.admin_settings.language_settings.default) {
        let l = GmCXt.organization.admin_settings.language_settings.default.language;

        if (GmCXt.browserLang && GmCXt.browserLang !== l &&
			GmCXt.checkLangExist(GmCXt.organization.admin_settings.language_settings.translations, GmCXt.browserLang)) {
            l = GmCXt.browserLang;
        }
        GmCXt.getAllLabels(l);
    }

    let d = GmCXt.getCurrentURL();
    d.pageTitle = GmCXt.pageTitle;

    if (GmCXt.FT.isPlayer) {
        d.baseUrl = GmCXt.conf.baseUrl;
        d.orgSecKey = window.guideMe ? window.guideMe.orgkey : "";
        d.myGuideOrgKey = window.myGuideOrgKey;
    }

    GmCXt.storage().get(['desktopReq']).then(function(st) {
        if (st.desktopReq) {
            d.isDesktopReq = true;
            GmCXt.deskReq = st.desktopReq;

        }
        GmCXt.log(21, "LOADING side panel, message from content script", d);

        GmCXt.saveCurrentURL();
        GmRootScope.updatePageUrl(d);

        if (GmCXt.isPlayer()) {
            GmRootScope.orgSecrret = d.orgSecKey || GmCXt.conf.orgSecrret;
            GmRootScope.myGuideOrgKey = d.myGuideOrgKey;
        }

        if (d.isDesktopReq) {
            GmCXt.showWidget();
            GmRootScope.processActiveRequests();
        } else {
            GmRootScope.initApp();
        }
    });
};

GmCXt.handleBeaconPosition = function(message) {

    GmCXt.closeAppPanel();
    GmCXt.hideSmartTips();
    GmCXt.hideBeacons();
    GmCXt.stepReq = message;
    GmCXt.storage().set({
        'beaconReq': message
    }).then(function() {
        GmCXt.requestHandler.selectBeaconPosition(message);
    });
};

GmCXt.getUserRolesLXP = function(params) {
    let d = window.__ED__;

    let profileData = {
        onboardingCompleted: 'no',
        orgAnnualSubscriptionPaid: 'no',
        countryCode: ''
    };

    // Get LXP user profile information
    if (d && d.profile && Object.keys(d.profile).length) {
        profileData = Object.assign({}, profileData, d.profile);
    }

    let rolesObject = {
        isManager: 'manager',
        isMkpAdmin: 'mkpAdmin',
        isOrgAdmin: 'orgAdmin',
        isSuperAdmin: 'superAdmin',
        isAdmin: 'admin'
    };

    function filterRoles(roles) {
        const filteredRoles = roles.filter(role => {
            return role !== 'member' && !Object.values(rolesObject).includes(role);
        });
        return filteredRoles.join(',');
    }

    let role = '';
    for (let l in rolesObject) {
        if (d[l]) {
            role = role.length > 0 ? role + ',' + rolesObject[l] : rolesObject[l];
        }
    }

    if (d.roles && d.roles.length > 1) {
        role = filterRoles(d.roles) ? role + ',' + filterRoles(d.roles) : role;
    }
    if (role.length === 0) role = 'member';

    profileData.role = role;

    if (d.onboardingCompleted) {
        profileData.onboardingCompleted = 'yes';
    }

    if (d.orgAnnualSubscriptionPaid) {
        profileData.orgAnnualSubscriptionPaid = 'yes';
    }

    profileData.countryCode = d.countryCode;

    params.profile = JSON.stringify(profileData);
};

GmCXt.updateUserData = function(params) {
    let d = null;
    let subdomain = "";

    if (GmCXt.urlParts.host) {
        subdomain = GmCXt.urlParts.host.split('.')[0];
        if (GmCXt.urlParts.pathname.indexOf('admin') !== -1) {
            subdomain = 'admin' + subdomain;
        }
    }

    if (GmCXt.isLXP()) {

        d = window.__ED__;
        GmCXt.getUserRolesLXP(params);

    } else {
        d = window.__MG__;
    }

    if (d && d.email) {

        if (GmCXt.isLXP()) {

            let emailParts = d.email.split('@');
            params.email_id = emailParts[0] + '+' + subdomain + '@' + emailParts[1];

        } else {
            params.email_id = d.email;
        }
        params.first_name = d.fullName;
        params.last_name = "";

    } else {

        params.email_id = 'guest-' + subdomain + '@myguide.com';
        params.first_name = 'guest-' + subdomain;
    }
};

GmCXt.loginUsingAuthKey = function() {

    if (GmCXt.loginUsingAuthKeyTime && ((GmCXt.loginUsingAuthKeyTime + 30000) > Date.now())) {
        return;
    }

    GmCXt.loginUsingAuthKeyTime = Date.now();

    let l = 0;
    readMyGuideOrgKey();

    function readMyGuideOrgKey() {

        let myGuideOrgKey = window.myGuideOrgKey;

        if (myGuideOrgKey) {
            let jwOrgKey = GmCXt.getOrgKeyFromJwToken(myGuideOrgKey);
            GmCXt.log(21, "GOT myGuideOrgKey" + myGuideOrgKey);

            processLogin(jwOrgKey);
        } else {
            GmCXt.timeout(function() {
                if (!GmCXt.user)
                    readMyGuideOrgKey();
            }, 1000);
        }
    }

    function callSigninApi(jwOrgKey) {
        let params = {
            myGuideOrgKey: myGuideOrgKey,
        };

        GmCXt.updateUserData(params);
        GmCXt.log(21, "SIGN-IN user info", params);

        //sign in using window.myGuideOrgKey
        GmCXt.api.userApiKeySignin(params).then(function(response) {

            if (response.error) {
                GmCXt.signInWithOrgKeyFailed(response);
                GmCXt.log(21, "ERROR: User signin failed", response.message[0]);
                return;
            }

            response.forceLogin = true;

            if (GmCXt.reloginInterval) {
                clearInterval(GmCXt.reloginInterval);
            }

            let user = response.data.user;

            if (GmCXt.isSumtotal() && user.user_email.indexOf('anonymous-') !== -1) { // TODO: GmCXt.isSumtotal() condition need to update as admin per admin setting - enable_anonymous_user_preference
                let data = {
                    email_id: params.email_id,
                    organization_id: user.organization_id
                };
                GmCXt.api.getAnonymousUserPrefrence(data, user.accesstoken).then(function(prefrence) {

                    if (!prefrence.error) {
                        response.data.user.signin_user_email = params.email_id;
                        response.data.user.settings = prefrence.data.settings;
                    }
                    GmCXt.onUserSignin(response);
                });
            } else {
                GmCXt.onUserSignin(response);
            }

            GmCXt.storage().set({
                myGuideKey: jwOrgKey
            });

        }).catch(function(e) {
            GmCXt.signInWithOrgKeyFailed(e);
            GmCXt.storage().remove(['myGuideKey']);
            GmCXt.log(21, "ERROR: exception, user signin failed", e);
        });
    }

    function processLogin(jwOrgKey) {
        GmCXt.storage().get(['myGuideKey', 'user']).then(function(st) {

            if ((GmCXt.isLXP() && st.user && st.user.val) || st.user) {

                let user = st.user;

                if (st.user.val) {
                    user = st.user.val;
                }

                if (jwOrgKey === st.myGuideKey || user.ssoSignInTrue) {

                    GmCXt.log(21, "FOUND USER SESSION for this org key");
                    return;
                }
            }

            callSigninApi(jwOrgKey);

        }).catch(function(error) {

            GmCXt.log(21, "ERROR: Failed to retrieve storage data - Retrying Login", error);

            callSigninApi(jwOrgKey);

        });
    }
};

GmCXt.pauseGuide = function() {

    if (!GmCXt.playerI) return;

    let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

    if (step && step.step_settings.onPageClickNext === true) {

        GmCXt.playerI.guideState = 'pause';
        GmCXt.playerI.pausedOn = GmCXt.urlParts.host + GmCXt.urlParts.pathname;

        GmCXt.storage().set({
            'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
            'guide_play_event': GmCXt.guidePlayTracker
        });

        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.guideState = 'pause';
            GmCXt.tourPlayerI.closeStep();
        }

        GmCXt.storage().get(['resumeWinDisplayed']).then(function(st) {

            if (!st.resumeWinDisplayed) {
                mg$('.mgPlayerJSProd_play-pause-toolbar').show();
                mg$('#mgPlayerJSProd_play-pause-toolbar-title').html(GmCXt.label.resumeGuide);
                mg$('#mgPlayerJSProd_play-pause-resume-message').html(GmCXt.label.resume);
                GmCXt.hideWidgetIcon();
                GmCXt.setResumeWinDisplayed(true);
            }
        });
    }
};

GmCXt.startTourFromDesktopApp = function() {

    GmCXt.log(33, 'Tour invoked: ' + GmCXt.deskReq.testCaseId);
    let d = {
        tour_id: GmCXt.deskReq.testCaseId,
        isDeskReq: true
    };

    GmCXt.getTourDetails(d).then(function(tour) {
        GmCXt.log(33, "Tour received", tour);
        GmCXt.playLiveTour(tour, 0, 'doitforme', false, 'live');
    });
};

GmCXt.isTestMeOn = function(o) {

    if (o && (o.expectedTime || o.tour))
        return true;
    else
        return false;
};

GmCXt.onSidePanelInit = function(m) {

    GmCXt.refreshTime = m.data.refreshTime;
    GmCXt.lastTimeStampSync = m.data.lastTimeStampSync;

    GmCXt.updateGlobalUser(m.data.user);

    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:save_user_in_iframes", {
        user: GmCXt.user
    });

    GmCXt.updateGlobalOrg(m.data.organization);

    GmCXt.activeAppId = m.data.activeAppId;

    GmCXt.externalAppId = GmCXt.appList['app:' + GmCXt.activeAppId].external_id;

    GmCXt.userPrefLang = m.data.userPrefLang;

    let as = GmCXt.getAppSetting();
    if (GmCXt.organization && !GmCXt.isEmpty(GmCXt.organization) && as) {
        GmCXt.orgBucket = GmCXt.organization.bucket;
        let s = GmCXt.organization.settings;
        let data = {
            userLabels: s.userLabels,
            chatLabels: as.chatLabels
        };

        if (GmCXt.isDefined(as.playAudio)) {
            GmCXt.FT.audio = as.playAudio;
        } else if (GmCXt.isDefined(GmCXt.organization.settings.playAudio)) {
            GmCXt.FT.audio = GmCXt.organization.settings.playAudio;
        } else {
            GmCXt.FT.audio = true;
        }

        GmCXt.updateCustomLabels(data);
    }

    if (m.data.reset) {
        GmCXt.log(21, "Reset Beacon and tooltip data");
        GmCXt.clearBeaconsAndTooltips();
        GmCXt.resetBeaconsandTooltips();
    }

    GmCXt.log(21, "Content script initialisation completed", m.data);

    GmCXt.processActiveReq(m);
};



GmCXt.processActiveReqOnSidePanelInit = function(st) {
    // Handle timestamp update if in player mode
    if (GmCXt.user && GmCXt.inPlayer) {
        if (GmCXt.isClientJs()) {
            GmCXt.log(70, "TRIGGER PLAYER UPDATE " + new Date());
            GmCXt.checkTimeStampUpdate();
        } else {
            GmCXt.sendMessageToBackgroundService({
                action: "mgPlayerJSProd_action:check_time_stamp_update"
            });
        }
    }
};


GmCXt.processActiveReq = function(m) {

    GmCXt.log(33, 'PROCESS ACTIVE REQUEST FROM PREVIOUS PAGE');

    let items = ['mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY', 'SHOW_SURVEY', 'stepReq',
        'testMe', 'linkClickOnStep', 'guide_play_event',
        'loopingCompleted', 'tourActivity', 'playedTour','captureStepCounter',
        'testAuto', 'guide_play_event', 'desktopReq', 'trackingTours', 'isRecording', 'replaceElReq',
        'tooltipTrackData', 'insightFeatureTagData', 'pageVisitData',
    ];

    GmCXt.storage().get(items).then(function(st) {

        GmCXt.tooltipTrackData = st.tooltipTrackData ? st.tooltipTrackData : [];

        if (GmCXt.isElectron() && !GmCXt.isEmpty(st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY)) {
            st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY = null;
            GmCXt.cleanPlayer();
        }

        if (st.captureStepCounter) {
            GmCXt.captureStepCounter = st.captureStepCounter;
        }

        if (st.desktopReq) {
            GmCXt.deskReq = st.desktopReq;
        }

        if (st.pageVisitData) {
            GmCXt.pageVisit = GmCXt.parseJSON(st.pageVisitData);
        }

        if ((GmCXt.isEmpty(GmCXt.pageVisit) || GmCXt.pageVisit?.url !== GmCXt.urlParts?.fullUrl) &&
			GmCXt.trackerUtil.pageTracking) {
            if (!GmCXt.isEmpty(GmCXt.pageVisit)) {
                GmCXt.trackerV1.trackPageVisit().then(function() {
                    GmCXt.pageVisit = undefined;
                    GmCXt.startPageTracker();
                });
            } else {
                GmCXt.startPageTracker();
            }
            GmCXt.storage().remove(['pageVisitData']);
        }

        if (st.replaceElReq) {

            const step = st.replaceElReq;
            if (step && step.step_settings && step.step_settings.element) {
                state = $state.go('findNReplace', {
                    auto_jquery: step.step_settings.element.criteria.auto_jquery,
                    jquery_selector: step.step_settings.element.criteria.jquery_selector
                });
            }
            GmCXt.storage().remove(['replaceElReq']);
        }

        if (st.testAuto) {
            GmCXt.auto.resumeState(st.testAuto);
            GmCXt.auto.startWatcher();
            if (st.testAuto.playNext) {
                GmCXt.auto.next();
                return;
            } else if (st.testAuto.shouldRedirectToTourPage) {
                GmCXt.getContextGuides("Test Auto");
                GmCXt.auto.onRedirectToTourPage();
            } else if (st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY) {
                GmCXt.playerI = st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY;
                if (!GmCXt.tourPlayerI) {
                    GmCXt.tourPlayerI = GmCXt.tourPlayer();
                }
                if (st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.isPageReloadByLastStep) {
                    GmCXt.playerI.isPageReloadByLastStep = false;
                    GmCXt.tourPlayerI.stop();
                    return;
                } else if (st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.playNextBranch) {
                    GmCXt.playerI.playNextBranch = false;
                    GmCXt.tourPlayerI.playBranchStepInAutomation(GmCXt.playerI.currentBranchStep);
                    return;
                } else if (st.testAuto.automationInProgress && st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.lastPlayedStepId) {
                    let nextStepId = GmCXt.getTail(st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.lastPlayedStepId, st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.playStructure);
                    if (nextStepId) {
                        GmCXt.playLiveTour(st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.tour, nextStepId, 'automation', false, 'live');
                    }
                    return;
                }
                return;
            }
        }

        if (GmCXt.isPlayer()) {
            GmCXt.tourActivity = st.tourActivity || {};
            GmCXt.playedTour = st.playedTour || [];
        }

        if (GmCXt.isLXP()) {
            GmCXt.setLangFromCS(GmCXt.getLXPLang());
        } else if (!GmCXt.userPrefLang) {
            GmCXt.setLangFromCS(GmCXt.browserLang);
        }

        if (GmCXt.isExtension() && st.stepReq) {
            GmCXt.handleActiveStepReq(st);
        } else if (GmCXt.isDomainInActiveApp()) {
            GmCXt.processGuides(st);
        }

        // if (GmCXt.user) {
        //     if (GmCXt.isClientJs()) {
        //         GmCXt.processLastActionTime();
        //     }
        // }
        if (m && m.mgdata && m.mgdata.triggerSync) GmCXt.processActiveReqOnSidePanelInit(st);

    });
};

GmCXt.updateCustomLabels = function(data) {
    let userLabels = data.userLabels;
    let chatLabels = data.chatLabels;
    let enLabels = GmCXt.getEngLabels();
    for (var property in userLabels) {
        if (GmCXt.label.hasOwnProperty(property) && (userLabels[property] !== enLabels[property])) {
            GmCXt.label[property] = userLabels[property] || GmCXt.label[property];
        }
    }

    for (var property in chatLabels) {
        if (GmCXt.label.hasOwnProperty(property)) {
            GmCXt.label[property] = chatLabels[property] || GmCXt.label[property];
        }
    }
};

GmCXt.processGuides = function(d) {

    if (GmCXt.checkPrecedence()) {

        GmCXt.log(21, "Precedence check passed");
        let tourAppId = d.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY && d.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.tour.application_id || d.testMe && d.testMe.message && d.testMe.message.tour.application_id || d.testMe && d.testMe.tour && d.testMe.tour.application_id;
        let pubEnv = d.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY && d.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.tour.tour_settings.app_publish_env;
        if ((tourAppId === GmCXt.activeAppId) ||
			(GmCXt.isMirrorApp() && GmCXt.getBaseAppId() === GmCXt.activeAppId)) {
            //ON APP ID MATCH
            if (GmCXt.isTestMeOn(d.testMe)) {
                GmCXt.processTestMe(d.testMe);
            } else if (GmCXt.checkDomainInPublishedEnv(pubEnv) || !GmCXt.isPlayer()) {
                GmCXt.runPlayer(d);
            }
        }

        if (GmCXt.isPlayer() || d.testAuto) {

            if (d.SHOW_SURVEY && d.SHOW_SURVEY.tourId && !d.linkClickOnStep) {
                GmCXt.showSurveyScreen({
                    tourId: d.SHOW_SURVEY.tourId,
                    version: d.SHOW_SURVEY.version
                });
            }

            GmCXt.getContextGuides("Process Guides");
        }

        if (!GmCXt.tourPlayerI && GmCXt.client.isUrlTour) {
            GmCXt.executeUrlTour();
        }

        if (GmCXt.isPlayer() && GmCXt.getAppSetting('keep_player_panel_open') && !GmCXt.playerI) {
            GmCXt.openAppPanel();
        }
    }
};

GmCXt.executeUrlTour = function() {

    if (GmCXt.client.executed) return;

    GmCXt.client.executed = true;
    let initiator = 'urlTour';
    if (GmCXt.client.automation) {
        initiator = 'doitforme';
    }
    GmCXt.getTourAndPlay(GmCXt.client.tourId, initiator, 'urlTour');
};

GmCXt.processTestMe = function(d) {

    GmCXt.testMe = d;

    if (d.expectedTime)
        GmCXt.requestHandler.startTestMeWatcher();
    else if (d.tour)
        GmCXt.requestHandler.startToolTestMe(d);
};

GmCXt.isActiveStepReq = function() {
    let currentTime = (new Date()).getTime();
    if (GmCXt.stepReq && (currentTime - GmCXt.stepReq.time) < 60000)
        return true;
    else
        return false;
};

GmCXt.handleActiveStepReq = function(st) {
    function gotTabId(tabId) {
        if (req.tabId === tabId) {
            GmCXt.stepReq = req;
            GmCXt.updateStepCounterInToolbar();
            if (inlineReq || quickReq) {
                GmCXt.requestHandler.createInlineStep();
            } else if (tooltipReq) {
                GmCXt.requestHandler.createSmartTipStep();
            }

        } else {
            GmCXt.processGuides(st);
        }
    }

    if (GmCXt.isDomainInActiveApp() && st.stepReq.appId === GmCXt.activeAppId) {
        var req = st.stepReq;
        var inlineReq = (req.action === 'mgPlayerJSProd_action:create_step,type:inline');
        var quickReq = (req.action === 'mgPlayerJSProd_action:create_step,type:quick');
        var tooltipReq = (req.action === 'mgPlayerJSProd_action:create_step,type:smartTip');

        if (inlineReq || quickReq || tooltipReq) {
            let m = {
                action: 'mgPlayerJSProd_action:get_current_tab_id'
            };
            GmCXt.sendMessageToBackgroundService(m, gotTabId);
        } else {
            GmCXt.processGuides(st);
        }
    } else {
        if(!GmCXt.isDomainInActiveApp()){
            GmCXt.toastMsg(rootScope.labels.nonConfiguredDomain).show();
        }
        if(st.stepReq.action != 'mgPlayerJSProd_action:create_step,type:quick'){
            GmCXt.storage().remove(['stepReq']);
        }
    }
};

GmCXt.runPlayer = function(st) {

    let pi = st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY;

    if (st.loopingCompleted && pi) {
        pi = null;
    }

    let next = function() {

        if (!st.linkClickOnStep) {
            GmCXt.invokeLiveTour();
        } else {
            GmCXt.storage().remove(['linkClickOnStep']);
        }
    };

    GmCXt.guidePlayTracker = st.guide_play_event || {};

    if (pi) {
        GmCXt.log(33, 'Page reloaded. Running player.');

        GmCXt.playerI = st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY;

        GmCXt.storage().set({
            'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
            'guide_play_event': st.guide_play_event
        });

        GmCXt.isPageReloaded = true;

        let tour = GmCXt.playerI.tour;
        let ss = tour.tour_settings.segment_groups;

        if (GmCXt.isPlayer() && GmCXt.organization.admin_settings.guide_segmentation && ss.length > 0) {
            GmCXt.checkGuidesBasedOnSegment([tour], function(t) {
                if (!GmCXt.isEmpty(t)) {
                    next();
                }
            }, "guidePlay");
        } else {
            next();
        }

    } else if (!GmCXt.isEmpty(GmCXt.guidePlayTracker)) {
        GmCXt.trackGuide();
    }
};

GmCXt.getContextGuides = function(eventType) {

    if (!GmCXt.checkPrecedence()) {
        return;
    }

    if (GmCXt.isDomainInActiveApp()) {

        if (GmCXt.organization || GmCXt.onPrem()) {
            let options = {
                url: GmCXt.getUrl(),
                organization_id: GmCXt.organization.organization_id,
                title: GmCXt.pageTitle
            };

            if (GmCXt.getLXPLang()) {
                options.language = GmCXt.getLXPLang();
            }

            GmCXt.getContextualTourData(options).then(gotCTours);
        }
    } else {
        GmCXt.log(1, "ERROR: Domain not configured in any app");
    }

    function gotCTours(tours) {

        GmCXt.log(1, "Guides on this domain", tours);

        if (GmCXt.isPlayer() && !GmCXt.isEmpty(tours)) {
            tours = GmCXt.filterScheduleTours(tours);
        }

        GmCXt.pageTours = tours;

        if (GmCXt.isAutomationRunning()) {
            let automatedCurrentTour = GmCXt.getAutomatedCurrentTour();
            GmCXt.log(37, "Automation running for guide ", automatedCurrentTour);
            tours = tours.filter((tour) => tour.tour_id === automatedCurrentTour.tour_id);
            GmCXt.log(37, "After automation filter Context tours left ", tours);
        }

        GmCXt.renderBeacons(GmCXt.filterBeaconGuides(tours));

        let rulesElementTooltips = GmCXt.tooltipTours.filter(function(tour) {
            return tour.tour_settings.watchRulesElement === true;
        });

        let removeInvalidTooltips = rulesElementTooltips.filter(function(tour) {
            return !tours.includes(tour.tour_id);
        });

        for (let i = 0; i < removeInvalidTooltips.length; i++) {
            let invalidTour = removeInvalidTooltips[i];
            GmCXt.removeTooltips(invalidTour);
        }
        GmCXt.renderSmartTips(GmCXt.filterSmartTipGuides(tours));

        GmCXt.notificationGuides = mg$.extend([], GmCXt.filterNotifications(tours));

        if (!GmCXt.stopNotification(false) || GmCXt.isAutomationRunning()) {
            GmCXt.showNotifications(false);
        }

        if (GmCXt.trackerUtil.featureTracking) {
            GmCXt.validateFtGuideRules(GmCXt.filterFtTags(tours));
        }

        GmRootScope.getContextToursAfterLogin = false;
        GmRootScope.refreshCurrentPage(eventType, true);
        GmRootScope.refreshTaskList();
    }
};

GmCXt.filterTrackingGuides = function(tours) {
    return tours.filter(function(t) {
        return GmCXt.isFeatureTags(t);
    });
};

GmCXt.renderBeacon = function(tour, isPreview) {

    if (!(tour && tour.tour_id)) return;

    let renderB = function(_t) {

        let settings = _t.tour_settings;
        let beaconSettings = settings.beacon;
        let data = {
            stepData: beaconSettings.selectedDOMElement,
            beaconSettings: beaconSettings,
            tour: _t,
            tourId: _t.tour_id,
            tourTitle: _t.tour_title,
            isPreview: isPreview,
            timeout: Date.now() + GmCXt.getOrgStepWaitTime()
        };

        if (data?.stepData && data?.stepData?.meta?.inTopWindow) {
            GmCXt.log(49, "FINDING BEACON only in TOP window");

            GmCXt.highlighter.queueBeacon({
                data: data
            });
        } else {
            // Element in iframe
            if (data?.stepData?.criteria?.precision_level === "High" && data?.stepData?.iframeAttrs) {

                let findInIframe = 3000;
                data.timeout = Date.now() + findInIframe;

                GmCXt.log(49, "FINDING BEACON only in TARGET frame");
                GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:show_beacon_on_dom_element:target_frame_only', data);

                GmCXt.beaconIframe[_t.tour_id].timeout = GmCXt.timeout(function() {
                    if (!GmCXt.beaconIframe[_t.tour_id].frameId) {
                        GmCXt.log(49, "TIMED OUT in Target Frame..\nFINDING BEACON in all frames");
                        data.timeout = Date.now() + GmCXt.getOrgStepWaitTime() - findInIframe;
                        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:show_beacon_on_dom_element', data);
                    }
                }, findInIframe + 500);
            } else {
                GmCXt.log(49, "FINDING BEACON in all frames");
                GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:show_beacon_on_dom_element', data);
            }
        }
    };

    if (GmCXt.getObjectSize(tour.tour_settings.beacon)) {
        renderB(tour);
    }
};

GmCXt.validateBeaconGuideRules = function(tours, isPreview, clickEvent) {

    GmCXt.log(1, "Beacon tours", tours);

    function queueRule(data, ruleDelayTime) {
        GmCXt.timeout(function() {
            GmCXt.ruleEngine.queue(data);
        }, ruleDelayTime);
    }

    for (let i = 0, j = tours.length; i < j; i++) {
        let tour = tours[i];
        let tid = parseInt(tour.tour_id);

        GmCXt.log(48, "VALIDATING GUIDE RULES for: ", GmCXt.tourLog(tour));

        if (GmCXt.beaconIframe[tid] && GmCXt.beaconIframe[tid].timeout) {
            clearTimeout(GmCXt.beaconIframe[tid].timeout);
        }
        GmCXt.beaconIframe[tid] = {};
        let beaconNotOnScreen = ((GmCXt.beaconsOnScreen.indexOf(tid) < 0) || isPreview);

        if (tour.is_published &&
			(beaconNotOnScreen || tour.tour_settings.removeBeaconRulesInvalid || GmCXt.checkRuleOnPageClick(clickEvent, tour))) {

            let waitTime = tour.tour_settings.ruleDelayTime || 0;
            let timeout = GmCXt.t.ruleTimeOut25ms;
            if (GmCXt.checkTourCreatedBefore(tour.tour_settings, 2021013001)) {
                timeout = GmCXt.t.ruleTimeOut10s;
            }

            if (tour.ruleValidated && !waitTime) { // useful in json player when the tours are returned after validation
                onMatch({
                    tour: tour,
                    valid: true
                });
            } else {
                let data = {
                    rules: tour.tour_settings.rules,
                    tour: tour,
                    timeoutVal: timeout,
                    timeout: timeout,
                    cb: onMatch,
                    isTour: true,
                    initiator: 'beacon'
                };

                queueRule(data, waitTime);
            }
        }
    }

    function onMatch(result) {
        if (result.valid) {

            delete result.tour.ruleValidated;

            GmCXt.renderBeacon(result.tour, isPreview);
        } else if (isPreview) {
            GmCXt.openAppPanel("byPassRoute");
            GmRootScope.showPopup(GmRootScope.labels.noPreview);
        } else {
            GmCXt.removeBeaconElement(result.tour);
        }
    }
};

GmCXt.renderBeacons = function(tours, isPreview, clickEvent) {

    GmCXt.log(48, "Skip already loaded beacons", GmCXt.beaconsOnScreen);

    let segmentCb = function(t) {

        if (!GmCXt.isEmpty(t)) {
            GmCXt.validateBeaconGuideRules([t], isPreview, clickEvent);
        }
    };

    if (GmCXt.organization?.admin_settings?.guide_segmentation && !isPreview) {
        GmCXt.checkGuidesBasedOnSegment(tours, segmentCb, "beaconSeg");
    } else {
        GmCXt.validateBeaconGuideRules(tours, isPreview, clickEvent);
    }
};

GmCXt.removeBeaconElement = function(t) {
    if (GmCXt.beaconsOnScreen.indexOf(parseInt(t.tour_id)) >= 0) {
        GmCXt.log(48, "Rules Failed. Removing Beacon for " + t.tour_title, t);
        GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:remove_beacon_job", {
            tourId: t.tour_id
        });
    }
};

GmCXt.validateSmartTipGuideRules = function(tours, isPreview, clickEvent) {

    function queueRule(data, ruleDelayTime) {
        GmCXt.timeout(function() {
            GmCXt.log(42, "QUEUE TOUR RULE: " + GmCXt.tourLog(tour));
            GmCXt.ruleEngine.queue(data);
        }, ruleDelayTime);
    }

    for (let i = 0, m = tours.length; i < m; i++) {
        var tour = tours[i];

        GmCXt.log(42, "VALIDATING GUIDE RULES for: ", GmCXt.tourLog(tour));

        let tooltipsLoaded = (GmCXt.onScreenTooltipGuideIds.indexOf(tour.tour_id) !== -1);

        if (tour.is_published &&
			(!tooltipsLoaded ||
				tour.tour_settings.watchRulesElement ||
				GmCXt.checkRuleOnPageClick(clickEvent, tour)
			)) {

            let waitTime = tour.tour_settings.ruleDelayTime || 0;
            let timeout = GmCXt.t.ruleTimeOut25ms;
            if (GmCXt.checkTourCreatedBefore(tour.tour_settings, 2021013001)) {
                timeout = GmCXt.t.ruleTimeOut10s;
            }

            if (tour.ruleValidated && !waitTime) { // useful in json player when the tours are returned after validation

                onMatch({
                    tour: tour,
                    valid: true
                });
            } else {
                let data = {
                    rules: tour.tour_settings.rules,
                    tour: tour,
                    cb: onMatch,
                    timeoutVal: timeout,
                    timeout: timeout,
                    isTour: true,
                    initiator: 'smartTip'
                };

                queueRule(data, waitTime);
            }

        } else {
            GmCXt.log(42, "Skip Tooltip: ", GmCXt.tourLog(tour));
        }
    }

    function onMatch(result) {
        GmCXt.onTooltipMatch(result, isPreview);
    }
};

GmCXt.checkRuleOnPageClick = function(clickEvent, t) {
    if (clickEvent && GmCXt.organization.admin_settings.efficient_rule_mode && t.tour_settings.ruleCheckOnClick) {
        return true;
    }
    return false;
};

GmCXt.validateFtGuideRules = function(tours) {

    for (let i = 0, m = tours.length; i < m; i++) {
        let tour = tours[i];

        GmCXt.log(16, "VALIDATING GUIDE RULES for: ", GmCXt.tourLog(tour));

        if (tour.is_published) {
            let waitTime = tour.tour_settings.ruleDelayTime || 0;

            if (tour.ruleValidated && !waitTime) { // useful in json player when the tours are returned after validation
                GmCXt.onTagsMatch({
                    tour: tour,
                    valid: true
                });
            } else {
                let data = {
                    rules: tour.tour_settings.rules,
                    tour: tour,
                    cb: GmCXt.onTagsMatch,
                    timeoutVal: GmCXt.t.ruleTimeOut25ms,
                    timeout: GmCXt.t.ruleTimeOut25ms,
                    isTour: true,
                    initiator: 'ftags'
                };
                queueRule(waitTime, tour, data);
            }

        } else {
            GmCXt.log(16, "Skip Tag: ", GmCXt.tourLog(tour));
        }
    }

    function queueRule(waitTime, tour, data) {
        GmCXt.timeout(function() {
            GmCXt.log(16, "QUEUE TOUR RULE: " + GmCXt.tourLog(tour));
            GmCXt.ruleEngine.queue(data);
        }, waitTime);
    }
};

GmCXt.onTagsMatch = function(data) {

    let tour = data.tour;
    GmCXt.log(16, "VALID TOUR RULE, showing: " + GmCXt.tourLog(tour));

    delete tour.ruleValidated;

    if (tour.steps.length) {
        GmCXt.log(17, "FOUND IN CACHE", tour);
        GmCXt.startFtTag(tour);
    } else {
        GmCXt.log(17, "CALL API to get tour");

        let d = {
            tour_id: tour.tour_id,
            category_id: tour.category_id
        };

        GmCXt.getTourDetails(d).then(function(_tour) {

            GmCXt.pageTours.forEach(function(t) {
                if (t.tour_id === _tour.tour_id) {
                    t.steps = _tour.steps;
                }
            });

            // Remove existing tour
            GmCXt.fTags.forEach(function(t, key) {
                if (t.tour_id === _tour.tour_id) {
                    GmCXt.fTags.splice(key, 1);
                }
            });
            // Push new tour
            GmCXt.fTags.push(_tour);
            GmCXt.startFtTag(_tour);
        });
    }
};

GmCXt.renderSmartTips = function(tours, isPreview, clickEvent) {

    GmCXt.log(42, "Skip already loaded tooltips: ", GmCXt.onScreenTooltipGuideIds);

    let segmentCb = function(t) {
        if (!GmCXt.isEmpty(t)) {
            GmCXt.validateSmartTipGuideRules([t], isPreview, clickEvent);
        }
        //remove invallid tours
    };

    if (GmCXt.organization?.admin_settings?.guide_segmentation && !isPreview) {
        GmCXt.checkGuidesBasedOnSegment(tours, segmentCb, "smarttipSeg");
    } else {
        GmCXt.validateSmartTipGuideRules(tours, isPreview, clickEvent);
    }
};

GmCXt.startFtTag = function(tour) {

    let windowHost = GmCXt.getPageDomain();

    for (let j = 0; j < tour.steps.length; j++) {
        let step = mg$.extend({}, tour.steps[j]);
        let nodes = mg$('.' + GmCXt.tagClassName(step, tour));

        if (nodes.length) return; //Return since already tagged

        if (step.step_settings && step.step_settings.element) {

            GmCXt.log(17, "LOADING STEP " + GmCXt.stepLog(step.step_id, step.tour_id));

            let data = {
                settings: step.step_settings,
                windowHost: windowHost,
                step: step,
                tour: tour,
                task: 'showTag',
                timeout: Date.now() + GmCXt.getOrgStepWaitTime(),
                iframeAttrs: step.step_settings.element.iframeAttrs,
                os: GmCXt.getStepSettings()
            };

            if (GmCXt.tagIframe[step.step_id] && GmCXt.tagIframe[step.step_id].timeout) {
                clearTimeout(GmCXt.tagIframe[step.step_id].timeout);
            }
            GmCXt.tagIframe[step.step_id] = {};
            searchTag(data, step);
        }
    }

    function searchTag(data, step) {

        if (data.settings.element.meta.inTopWindow) {
            GmCXt.log(17, "FINDING TAG only in TOP window");

            GmCXt.highlighter.queueTag({
                data: data
            });
        } else {

            let findInIframe = 3000;
            data.timeout = Date.now() + findInIframe;

            GmCXt.log(17, "FINDING TAG only in TARGET frame");
            GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:find_tag_elm:target_frame_only', data);

            GmCXt.tagIframe[step.step_id].timeout = GmCXt.timeout(function() {
                if (!GmCXt.tagIframe[step.step_id].frameId) {
                    GmCXt.log(17, "TIMED OUT in Target Frame..\nFINDING TAG in all frames");
                    data.timeout = Date.now() + GmCXt.getOrgStepWaitTime() - findInIframe;
                    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:find_tag_elm', data);
                }
            }, findInIframe + 500);
        }
    }
};

GmCXt.startTooltip = function(tour, isPreview) {

    GmCXt.setOnScreenTooltipGuideInfo(tour);

    for (let j = 0; j < tour.steps.length; j++) {

        let step = mg$.extend({}, tour.steps[j]);
        let windowHost = GmCXt.getPageDomain();

        if (GmCXt.mgActiveLang && !GmCXt.isGuideInDefaultLang(tour, GmCXt.mgActiveLang) && step.language_data && step.language_data[GmCXt.mgActiveLang]) {
            let langStepSetting = GmCXt.parseJSON(step.language_data[GmCXt.mgActiveLang].step_settings);
            step.step_settings.smartTip = langStepSetting.smartTip;
        }

        if (step.step_settings && step.step_settings.element) {

            GmCXt.log(43, "LOADING STEP " + GmCXt.stepLog(step.step_id, step.tour_id));

            let data = {
                settings: step.step_settings,
                windowHost: windowHost,
                step: step,
                tour: tour,
                isPreview: isPreview,
                task: 'showSmarttip',
                timeout: Date.now() + GmCXt.getOrgStepWaitTime(),
                iframeAttrs: step.step_settings.element.iframeAttrs,
                os: GmCXt.getStepSettings()
            };

            if (GmCXt.smartTipIframe[step.step_id] && GmCXt.smartTipIframe[step.step_id].timeout) {
                clearTimeout(GmCXt.smartTipIframe[step.step_id].timeout);
            }
            GmCXt.smartTipIframe[step.step_id] = {};
            searchTooltip(data, step);
        }
    }

    function searchTooltip(data, step) {

        if (data.settings.element.meta.inTopWindow) {
            GmCXt.log(43, "FINDING TOOLTIP only in TOP window");

            GmCXt.highlighter.queueSmarttip({
                data: data
            });
        } else {
            // Element in iframe
            if (data.settings.element.criteria.precision_level === "High" && data.iframeAttrs) {

                let findInIframe = 3000;
                data.timeout = Date.now() + findInIframe;

                GmCXt.log(43, "FINDING TOOLTIP only in TARGET frame");
                GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_dom_element_to_show_tooltip:target_frame_only', data);

                GmCXt.smartTipIframe[step.step_id].timeout = GmCXt.timeout(function() {
                    if (!GmCXt.smartTipIframe[step.step_id].frameId) {
                        GmCXt.log(43, "TIMED OUT in Target Frame..\nFINDING TOOLTIP in all frames");
                        data.timeout = Date.now() + GmCXt.getOrgStepWaitTime() - findInIframe;
                        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_dom_element_to_show_tooltip', data);
                    }
                }, findInIframe + 500);
            } else {
                GmCXt.log(43, "FINDING TOOLTIP in all frames");
                GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:started;task:select_dom_element_to_show_tooltip', data);
            }
        }
    }
};

GmCXt.onTooltipMatch = function(r, isPreview) {

    let tour = r.tour;

    delete tour.ruleValidated;

    let d = {
        tour_id: tour.tour_id,
        category_id: tour.category_id
    };

    function tooltipGetSteps(tour, cb, isPreview, isValid) {

        if (tour.steps.length) {
            GmCXt.log(43, "FOUND IN CACHE", tour);
            cb(tour, isPreview);

        } else if (isValid) {
            GmCXt.log(43, "CALL API to get tour");
            let d = {
                tour_id: tour.tour_id,
                category_id: tour.category_id
            };
            GmCXt.getTourDetails(d).then(function(_tour) {

                if (GmCXt.pageTours) {
                    GmCXt.pageTours.forEach(function(t) {
                        if (t.tour_id === _tour.tour_id) {
                            t.steps = _tour.steps;
                        }
                    });
                }

                let showTooltip = function(_t) {
                    // Remove existing tour
                    GmCXt.tooltipTours.forEach(function(t, key) {
                        if (t.tour_id === _t.tour_id) {
                            GmCXt.tooltipTours.splice(key, 1);
                        }
                    });
                    // Push new tour
                    GmCXt.tooltipTours.push(_t);
                    cb(_t, isPreview);
                };

                showTooltip(_tour);
            });
        }
    }

    if (r.valid) {

        GmCXt.log(42, "VALID TOUR RULE, showing: " + GmCXt.tourLog(tour));

        if (isPreview) {
            GmCXt.startTooltip(tour, isPreview);
        } else {
            tooltipGetSteps(tour, GmCXt.startTooltip, isPreview, true);
        }

    } else if (!r.valid) {

        GmCXt.log(42, "INVALID TOUR RULE: " + GmCXt.tourLog(tour));

        tooltipGetSteps(tour, GmCXt.removeTooltips, isPreview, false);

        if (isPreview) {
            GmCXt.openAppPanel("byPassRoute");
            GmRootScope.showPopup(GmRootScope.labels.noPreview);
        }
    }
};

GmCXt.filterOutSmarttipGuides = function(tours) {
    let arr = [];
    tours.filter(function(itm) {
        if (itm.tour_type.indexOf('smartTip') === -1) {
            arr.push(itm);
        }
    });
    return arr;
};

GmCXt.notifyCurrentPageGuideExistence = function() {
    let m = {
        action: 'mgPlayerJSProd_action:get_cguide_count',
        data: GmCXt.ifGuidesOnCurrentPage
    };
    GmCXt.msgToThisWin(m);
};

GmCXt.hideCurrentPageGuidesIndicator = function() {
    mg$('.mgPlayerJSProd_start-button-cnt').hide();
    GmCXt.notifyCurrentPageGuideExistence();

    GmCXt.showWidget();
};

GmCXt.showCurrentPageGuidesIndicator = function() {

    if (GmCXt.FT.isPlayer) {
        let ws = GmCXt.getWidgetSettings();

        let wCnt = mg$('.mgPlayerJSProd_start-button-cnt');
        if (GmCXt.ifGuidesOnCurrentPage && ws && ws.guide_count_on_widget) {

            wCnt.css({
                background: ws.guide_count_widget_color
            });

            wCnt.show();
        } else {

            wCnt.hide();
        }
    }

    GmCXt.notifyCurrentPageGuideExistence();
};

GmCXt.showNotifications = function(isPageClicked) {

    let guideMeTourId = GmCXt.getUrlParameter('guideMe-tourId');
    let delay = GmCXt.getNotificationDelay();

    if (!(GmCXt.isPlayer() || GmCXt.isAutomationRunning())) {
        return;
    }
    if (GmCXt.isSurveyVisible || GmCXt.orgNotificationPopup) {
        return;
    }

    if (GmCXt.isAutomationRunning()) {
        delay = 0; // Render Notification for Automation
    } else if (GmCXt.tourPlayerI || guideMeTourId) {
        delay = 5000;
        GmCXt.log(10, "DELAYED notifications, guide is playing");
    }

    GmCXt.log(10, "NOTIFICATION ENABLED guides", GmCXt.notificationGuides);

    if (!GmCXt.stopNotification(false) || GmCXt.isAutomationRunning()) {
        GmCXt.timeout(function() {
            GmCXt.loadGuideNotifications(
                GmCXt.notificationGuides,
                false,
                false,
                false,
                isPageClicked
            );
        }, delay);
    }
};

GmCXt.filterNotifications = function(t) {
    let arr = [];

    if (!GmCXt.isEmpty(t)) {
        arr = t.filter(function(_t) {
            if (_t.tour_type.indexOf('overlay_tour') > -1)
                return _t;
        });
    }

    return arr;
};

GmCXt.filterSmartTipGuides = function(tours) {
    let arr = [];

    if (!GmCXt.isEmpty(tours)) {
        tours.filter(function(itm) {
            if (itm.tour_type.indexOf('smartTip') > -1) {
                arr.push(itm);
            }
        });
    }

    GmCXt.tooltipTours = arr;

    GmCXt.log(42, "TOOLTIP guides", arr);

    return arr;
};

GmCXt.filterFtTags = function(tours) {
    let arr = [];
    if (!GmCXt.isEmpty(tours)) {
        tours.filter(function(itm) {
            if (itm.tour_type.indexOf('insights') > -1) {
                arr.push(itm);
            }
        });
    }
    GmCXt.fTags = arr;

    GmCXt.log(16, "FEATURE TAGS guides", arr);

    return arr;
};

GmCXt.filterBeaconTourByDiplayFrequency = function(tour) {
    let beaconsViewed = GmCXt.user.settings.display_frequency_beacons;
    let retVal = true;
    if (!GmCXt.isEmpty(beaconsViewed)) {
        let countObj = beaconsViewed[parseInt(tour.tour_id)];
        if (GmCXt.isDefined(countObj)) {
            if (parseInt(countObj.version) === parseInt(tour.version)) {
                if (countObj.playedCount >= tour.tour_settings.beacon.displayFrequencyTimes) {
                    return false;
                }
            }
        }
    }

    return retVal;
};

GmCXt.filterBeaconGuides = function(tours) {
    let arr = [];

    if (!GmCXt.isEmpty(tours)) {
        tours.filter(function(itm) {
            if (itm.tour_type.indexOf('beacon_tour') > -1) {
                if (itm.tour_settings.beacon.displayFrequency) {
                    if (GmCXt.filterBeaconTourByDiplayFrequency(itm)) {
                        arr.push(itm);
                    }
                } else {
                    arr.push(itm);
                }
            }
        });
    }

    GmCXt.log(48, "BEACON guides", arr);

    GmCXt.beaconTours = arr;
    return arr;
};

GmCXt.requestHandler.sendRequestForDomSelectTableRule = function(request) {
    GmCXt.clearScreen();
    GmCXt.unlockScroll();
    GmCXt.closeAppPanel();
    GmCXt.toggleStepSelectionToolbar(true);
    GmCXt.hideBeacons();
    GmCXt.hideSmartTips();

    let data = {
        ruleIndex: request.data.ruleIndex,
        groupIndex: request.data.groupIndex,
        reSelect: request.data.reSelect
    };

    let action = "mgPlayerJSProd_action:started;task:select_new_table_for_dom_select_rule";
    GmCXt.sendMessageToAllWindows(action, data);
};

GmCXt.requestHandler.sendRequestForDomSelectRule = function(data) {

    GmCXt.clearScreen();
    GmCXt.unlockScroll();
    GmCXt.closeAppPanel();
    GmCXt.toggleStepSelectionToolbar(true);
    GmCXt.hideBeacons();
    GmCXt.hideSmartTips();

    let reqData = {
        ruleIndex: data.ruleIndex,
        groupIndex: data.groupIndex,
        reSelect: data.reSelect
    };

    let action = "mgPlayerJSProd_action:started;task:select_new_element_for_dom_select_rule";
    GmCXt.sendMessageToAllWindows(action, reqData);
};

GmCXt.requestHandler.playLinkedGuide = function(data) {
    GmCXt.playerI = {
        tour: null,
        tourId: data.tourId
    };

    let d = {
        tour_id: data.tourId
    };

    if (GmCXt.getOrgSettings()) {
        GmCXt.getTourDetails(d)
            .then(function(tour) {

                GmCXt.playerI.tour = tour;
                GmCXt.playerI.startStepId = 0;

                GmCXt.storage().set({
                    'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': GmCXt.playerI,
                    'guide_play_event': GmCXt.guidePlayTracker
                }).then(function() {
                    GmCXt.playTour();
                });
            });
    }
};

GmCXt.requestHandler.playGuide = function(data) {
    GmCXt.closeNotificationPopupSidePanel();
    if (data.playerInstance)
        GmCXt.playerI = mg$.extend({}, data.playerInstance);
    else
        GmCXt.playerI = mg$.extend({}, data);

    if (GmCXt.isFirstNonAutomationStep())
        GmCXt.checkPreviousHoverStep = false;
    else
        GmCXt.checkPreviousHoverStep = true;

    if (!GmCXt.playerI.currentStepId && !GmCXt.isMicroPlayer()) {
        let firstStepId = GmCXt.playerI.tour.steps[0].step_id;
        if (data.tour) {
            let ts = data.tour.tour_settings;
            if (ts.play_structure.length) {
                firstStepId = ts.play_structure[0].id;
            }
        }

        if (firstStepId) {
            GmCXt.playerI.currentStepId = firstStepId;
        }
    }

    GmCXt.playerI.startStepId = GmCXt.playerI.currentStepId;

    let PI = GmCXt.playerI;

    GmCXt.storage().set({
        'mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY': PI,
        'guide_play_event': GmCXt.guidePlayTracker
    }).then(function() {
        GmCXt.playTour();
    });
};

GmCXt.updatePlayerI = function() {
    let PI = GmCXt.playerI;

    if (PI && PI.completeEventTracked) {
        PI.currentStepId = PI.startStepId;
        PI.completeEventTracked = false;
        PI.lastPlayedStepId = 0;

        ++PI.currentLoop;

        GmCXt.playerI = PI;

        GmCXt.log(33, 'Player Instance updated for looping.');
    }
};

GmCXt.requestHandler.playAutoTour = function() {

    GmCXt.updatePlayerI();

    if (GmCXt.isLooping()) {
        GmCXt.timeout(function() {
            if (!GmCXt.tourPlayerI) {
                GmCXt.tourPlayerI = GmCXt.tourPlayer();
            }
            GmCXt.tourPlayerI.start();
        }, 500);

    } else {
        GmCXt.log(33, 'Tour Player ' + GmCXt.playerI.loops + ' times.');

        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.stop();
        } else {
            GmCXt.cleanPlayer();
        }

        GmCXt.storage().set({
            'loopingCompleted': true
        });
    }
};

GmCXt.newIframesFound = false;
GmCXt.requestHandler.newIframeFound = function(iframeIdentifier) {

    GmCXt.newIframesFound = true; //This will load tooltips and beacons in new iframe

    if (GmCXt.DomSelectorToolActive === true) {
        let action = 'mgPlayerJSProd_action:started;task:select_new_dom_element';
        if (GmCXt.stepReq && GmCXt.stepReq.action === 'mgPlayerJSProd_action:create_step,type:smartTip') {
            action = 'mgPlayerJSProd_action:started:select_new_dom_element_for_smart_tip';
        }

        GmCXt.sendMessageToAllWindows(action, {
            enableNavigateTool: GmCXt.enableNavigateTool
        });
    }

    GmCXt.log(1, "IFRAME found, ID: " + iframeIdentifier);

    let d = {
        org: GmCXt.organization,
        user: GmCXt.user,
        debugMode: GmCXt.debugMode,
        urlParts: GmCXt.urlParts,
        featureTracking: GmCXt.trackerUtil.featureTracking,
        pageTracking: GmCXt.trackerUtil.pageTracking,
        sessionInfo: GmCXt.sessionInfo,
        showPlayer: GmCXt.showPlayer,
        rules: GmCXt.rulesIframeQueue
    };

    d.domainInApp = GmCXt.isDomainInActiveApp();

    if (GmCXt.tourPlayerI && GmCXt.tourPlayerI.currentStepReq && !GmCXt.isLastStepPlayed()) {
        d.req = GmCXt.tourPlayerI.currentStepReq;
    }

    if (!GmCXt.isEmpty(GmCXt.appList)) {

        let activeApp = GmCXt.appList['app:' + GmCXt.activeAppId];
        d.activeAppSettings = {};
        if (activeApp && activeApp.settings) {
            d.activeAppSettings = activeApp.settings;
        }
    }

    if (window.self === window.top) {
        GmCXt.iframeCount++;
    }

    let m = {
        action: "mgPlayerJSProd_action:task:init_new_iframe",
        data: d
    };
    GmCXt.sendToIframes(m, iframeIdentifier);
};

GmCXt.sendMessageToRenderBeacons = function() {

    if (GmCXt.beaconTours.length) {
        let tours = mg$.extend([], GmCXt.beaconTours);
        GmCXt.renderBeacons(tours);
    }
};

GmCXt.sendMessageToRenderSmartTip = function() {

    if (GmCXt.tooltipTours.length) {
        let tours = mg$.extend([], GmCXt.tooltipTours);
        GmCXt.renderSmartTips(tours);
    }
};

GmCXt.addWidgetIcon = function() {

    return new Promise(function(resolve, reject) {
        GmCXt.getWidgetIcon().then(function(wUrl) {

            let str = "<wmgPlayerJSProd_ " +
				" id='mgPlayerJSProd_btn-start-button' class='mgPlayerJSProd_start-button " + GmCXt.getStartBtnClass() + " mgPlayerJSProd_display-none'> " +
				" <wmgPlayerJSProd_ class='mgPlayerJSProd_start-button-cnt' ></wmgPlayerJSProd_>" +
				" <img src='" + wUrl + "' aria-label='My Guide Widget' tabindex='0' class='mgPlayerJSProd_custom-image' " +
				" err-src='" + GmCXt.getDefaultIcon() + "'/> " +
				" </wmgPlayerJSProd_>";

            mg$("html").append(str);
            GmCXt.positionWidget();
            GmCXt.widgetIconCustomize();

            GmCXt.log(8, "WIDGET HTML added");
            resolve();
        });
    });
};

GmCXt.addChatIcon = function() {

    return new Promise(function(resolve, reject) {
        GmCXt.getChatIcon().then(function(wUrl) {

            let str = "<wmgPlayerJSProd_ " +
				" id='mgPlayerJSProd_btn-chat-button' class='mgPlayerJSProd_chat-button " + GmCXt.getStartBtnClass() + " mgPlayerJSProd_display-none'> " +
				" <img src='" + wUrl + "' class='mgPlayerJSProd_custom-image' " +
				" err-src='" + GmCXt.getChatDefaultIcon() + "'/> " +
				" </wmgPlayerJSProd_>";

            mg$("html").append(str);
            GmCXt.positionChatIcon();
            GmCXt.chatIconCustomize();

            GmCXt.log(8, "CHAT ICON HTML added");
            resolve();
        });
    });
};

GmCXt.addWidgetIconEvents = function() {

    dragElement(document.getElementById("mgPlayerJSProd_btn-start-button"));

    function dragElement(elmnt) {
        let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0,
            drag = false;

        if (!elmnt) return;

        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;

        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            mg$('iframe').css('pointer-events', 'none');
            mg$('body').css('pointer-events', 'none');
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.setProperty("top", (elmnt.offsetTop - pos2) + "px", "important");
            elmnt.style.setProperty("left", (elmnt.offsetLeft - pos1) + "px", "important");
            drag = true;
        }

        function closeDragElement(e) {
            /* stop moving when mouse button is released:*/

            mg$('iframe').css('pointer-events', 'initial');
            mg$('body').css('pointer-events', 'initial');
            document.onmouseup = null;
            document.onmousemove = null;
            if (!drag) {
                GmCXt.onClickGuideMeIcon(e);
            }
            if (elmnt.style.top !== 'initial') {
                GmCXt.dragWidgetPose.top = elmnt.style.top;
                GmCXt.dragWidgetPose.left = elmnt.style.left;
            }

            GmCXt.timeout(function() {
                drag = false;
            }, 500);
        }
    }
};

GmCXt.addChatIconEvents = function() {

    dragElement(document.getElementById("mgPlayerJSProd_btn-chat-button"));

    function dragElement(elmnt) {
        let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0,
            drag = false;

        if (!elmnt) return;

        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;

        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            mg$('iframe').css('pointer-events', 'none');
            mg$('body').css('pointer-events', 'none');
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.setProperty("top", (elmnt.offsetTop - pos2) + "px", "important");
            elmnt.style.setProperty("left", (elmnt.offsetLeft - pos1) + "px", "important");
            drag = true;
        }

        function closeDragElement(e) {
            /* stop moving when mouse button is released:*/

            mg$('iframe').css('pointer-events', 'initial');
            mg$('body').css('pointer-events', 'initial');
            document.onmouseup = null;
            document.onmousemove = null;
            if (!drag) {
                GmCXt.onClickChatIcon(e);
            }
            if (elmnt.style.top !== 'initial') {
                GmCXt.dragChatPose.top = elmnt.style.top;
                GmCXt.dragChatPose.left = elmnt.style.left;
            }

            GmCXt.timeout(function() {
                drag = false;
            }, 500);
        }
    }
};

GmCXt.removeWidget = function() {
    let widget = GmCXt.getWidgetInstance();
    if (widget.length) widget.remove();
};

GmCXt.removeChatIcon = function() {
    let chat = GmCXt.getChatIconInstance();
    if (chat.length) chat.remove();
};

// Widget Test Cases
// 1. Show default widget icon before login
// 2. Update widget icon and position after login
// 3. Update widget icon and position after Org settings change
// 4. Set default widget icon after logout
// 5. Hide widget if its hidden in Org settings

GmCXt.addingWidgetIcon = false;

GmCXt.showWidget = function() {

    if (GmCXt.APP_PANEL_OPEN) return;

    if (GmCXt.getWidgetVisibility()) {

        let show = function() {

            GmCXt.log(8, "SHOW WIDGET");

            GmCXt.positionWidget();
            GmCXt.widgetIconCustomize();

            GmCXt.showCurrentPageGuidesIndicator();

            GmCXt.displayWidget();
        };

        let widget = GmCXt.getWidgetInstance();

        if (widget.length) {
            GmCXt.getWidgetIcon().then(function(wURl) {
                mg$(".mgPlayerJSProd_start-button img").attr('src', wURl);
                show();
            });

        } else if (!GmCXt.addingWidgetIcon) {

            GmCXt.addingWidgetIcon = true;
            GmCXt.addWidgetIcon().then(function() {

                GmCXt.addingWidgetIcon = false;
                GmCXt.addWidgetIconEvents();
                show();
            });
        }

    } else {
        GmCXt.removeWidget();
    }
};

GmCXt.showChatIcon = function() {

    if (!GmCXt.checkPrecedence()) return;
    if (GmCXt.APP_PANEL_OPEN) return;
    if (!GmCXt.organization && GmCXt.isEmpty(GmCXt.organization)) return;


    if (GmCXt.isPlayer() && GmCXt.isChatEnable() && GmCXt.getChatIconVisibility()) {

        let show = function() {

            GmCXt.log(8, "SHOW CHAT ICON");

            GmCXt.positionChatIcon();
            GmCXt.chatIconCustomize();

            GmCXt.displayChatIcon();
        };

        let chat = GmCXt.getChatIconInstance();

        if (chat.length) {
            GmCXt.getChatIcon().then(function(wURl) {
                mg$("#mgPlayerJSProd_btn-chat-button img").attr('src', wURl);
                show();
            });

        } else if (!GmCXt.addingChatIcon) {

            GmCXt.addingChatIcon = true;
            GmCXt.addChatIcon().then(function() {

                GmCXt.addingChatIcon = false;
                GmCXt.addChatIconEvents();
                show();
            });
        }

    } else {
        GmCXt.removeChatIcon();
    }
};

GmCXt.resetBeaconsandTooltips = function() {

    for (let prop in GmCXt.onScreenTooltipGuideInfo) delete GmCXt.onScreenTooltipGuideInfo[prop];

    GmCXt.onScreenTooltipGuideIds = [];

    GmCXt.beaconTours = [];
    GmCXt.beaconsOnScreen = [];
    GmCXt.tooltipTours = [];
    GmCXt.partialVisibleTooltipsIds = [];
};

GmCXt.positionWidget = function() {

    let s = GmCXt.getWidgetSettings();
    if (GmCXt.isEmpty(s)) return;

    let widget = GmCXt.getWidgetInstance();
    let strCss = '';

    if (GmCXt.dragWidgetPose.left) {
        strCss = "top:" + GmCXt.dragWidgetPose.top + " !important;" +
			"left:" + GmCXt.dragWidgetPose.left + " !important;" +
			"bottom: initial;right: initial";
    } else {
        switch (s.widgetIconPos) {
        case 'top-left':
            strCss = "top: " + s.widget_icon_pos.widget_icon_top_pos + s.widget_icon_pos.widget_icon_top_pos_unit + " !important;" +
					"left: " + s.widget_icon_pos.widget_icon_left_pos + s.widget_icon_pos.widget_icon_left_pos_unit + " !important;" +
					"bottom: initial; right: initial;";
            break;

        case 'top-right':

            strCss = "top:" + s.widget_icon_pos.widget_icon_top_pos + s.widget_icon_pos.widget_icon_top_pos_unit + " !important;" +
					"right:" + s.widget_icon_pos.widget_icon_right_pos + s.widget_icon_pos.widget_icon_right_pos_unit + " !important;" +
					"left: initial; bottom: initial";

            break;

        case 'bottom-left':
            strCss = "bottom: " + (s.widget_icon_pos.widget_icon_bottom_pos + s.widget_icon_pos.widget_icon_bottom_pos_unit) + " !important;" +
					"left: " + s.widget_icon_pos.widget_icon_left_pos + s.widget_icon_pos.widget_icon_left_pos_unit + " !important;" +
					"top: initial; right: initial;";
            break;

        case 'bottom-right':

            strCss = "bottom: " + s.widget_icon_pos.widget_icon_bottom_pos + s.widget_icon_pos.widget_icon_bottom_pos_unit + " !important;" +
					"right:" + s.widget_icon_pos.widget_icon_right_pos + s.widget_icon_pos.widget_icon_right_pos_unit + " !important;" +
					"top: initial; left: initial;";

            break;
        }
    }

    widget.attr('style', strCss);
};

GmCXt.positionChatIcon = function() {

    let s = GmCXt.getAppSetting();

    if (GmCXt.isEmpty(s)) return;

    let chat = GmCXt.getChatIconInstance();

    let strCss = '';

    if (GmCXt.dragChatPose.left) {
        strCss = "top:" + GmCXt.dragChatPose.top + " !important;" +
			"left:" + GmCXt.dragChatPose.left + " !important;" +
			"bottom: 'initial';right: 'initial'";
    } else {
        switch (s.chatIconPos) {
        case 'top-left':
            strCss = "top: " + s.chat_icon_pos.chat_icon_top_pos + s.chat_icon_pos.chat_icon_top_pos_unit + " !important;" +
					"left: " + s.chat_icon_pos.chat_icon_left_pos + s.chat_icon_pos.chat_icon_left_pos_unit + " !important;" +
					"bottom: 'initial'; right: 'initial';";
            break;

        case 'top-right':

            strCss = "top:" + s.chat_icon_pos.chat_icon_top_pos + s.chat_icon_pos.chat_icon_top_pos_unit + " !important;" +
					"right:" + s.chat_icon_pos.chat_icon_right_pos + s.chat_icon_pos.chat_icon_right_pos_unit + " !important;" +
					"left: 'initial'; bottom: 'initial'";

            break;

        case 'bottom-left':
            strCss = "bottom: " + (s.chat_icon_pos.chat_icon_bottom_pos + s.chat_icon_pos.chat_icon_bottom_pos_unit) + " !important;" +
					"left: " + s.chat_icon_pos.chat_icon_left_pos + s.chat_icon_pos.chat_icon_left_pos_unit + " !important;" +
					"top: 'initial'; right: 'initial';";
            break;

        case 'bottom-right':

            strCss = "bottom: " + s.chat_icon_pos.chat_icon_bottom_pos + s.chat_icon_pos.chat_icon_bottom_pos_unit + " !important;" +
					"right:" + s.chat_icon_pos.chat_icon_right_pos + s.chat_icon_pos.chat_icon_right_pos_unit + " !important;" +
					"top: 'initial'; left: 'initial';";

            break;
        }
    }

    chat.attr('style', strCss);
};

GmCXt.requestHandler.selectBeaconPosition = function(request) {
    GmCXt.hideWidgetIcon();
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:started;task:select_dom_element_for_beacon");
    GmCXt.toggleStepSelectionToolbar(true);
};

GmCXt.requestHandler.closeStep = function() {
    GmCXt.closeAppPanel();

    if (GmCXt.tourPlayerI) GmCXt.tourPlayerI.closeStep();
};

GmCXt.requestHandler.closeSlideshow = function() {

    GmCXt.showSmartTips();
    GmCXt.showBeacons();

    let pi = GmCXt.playerI;

    if (pi && pi.totalStepCount > 1 && GmCXt.firstStepAutoLaunch()) {

        let options = {
            tour: pi.tour,
            slideshow: true
        };
        GmCXt.showPushOptions(options).show();

    } else {
        GmCXt.stopSlideshow();

        if (pi) {
            GmCXt.markAutoLaunchTourDoNotShow(pi.tour);
            GmCXt.getSurveyScreen(mg$.extend({}, pi)).then(function(f) {
                if (!f)
                    GmCXt.openAppPanel();
            });
            GmCXt.cleanPlayer();
        }
    }
};

GmCXt.requestHandler.pageClickForGuide = function(msg) {
    let e = msg.data;
    let stepPlaying = mg$('.mgPlayerJSProd_preview-step-popup-container').length;

    if (GmCXt.playerI && stepPlaying && GmCXt.enforceGuideMePopup !== true && !GmCXt.isSurveyVisible) {

        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
        let watchState = true;

        if (step.step_type === GmCXt.STEP_TYPE_INLINE && e.state && e.state !== 'watch') { //e.state = undefined for iframes
            watchState = false;
        }

        if (step && watchState) {
            let s = step.step_settings;
            let playNext = false;
            let notClickOnPageStep = (!s.onClickAnywhere && !s.onPageClickNext && !s.onChangeNext);
            let forceMode = (s.doNotForceGuide !== true && GmCXt.playerI.forceGuideMe === true);

            if (forceMode && s.onRightClickNext) {
                if (!e.onRightClickElem) {
                    GmCXt.showForceMode();
                }
            } else if (forceMode && notClickOnPageStep && !e.onElem && !e.inColumn) {
                if (step.step_type === GmCXt.STEP_TYPE_INLINE || step.step_type === GmCXt.STEP_TYPE_MESSAGE) {
                    GmCXt.showForceMode();
                }
            } else if (s.onClickTooltip === true && e.onElem) {
                playNext = true;
            } else if (s.pageReloadOption === "restart_parent" && (e.onElem || s.onClickAnywhere)) {
                GmCXt.restartInParent();
                playNext = true;
            } else if (s.headerNext && e.inColumn) {
                playNext = true;
            } else if (s.onClickAnywhere === true) {
                playNext = true;
            } else if (s.onPageClickNext === true) {
                GmCXt.pauseGuide();
            }

            if (playNext) {

                if (s.checkOnScreenError) {

                    GmCXt.timeout(function() {
                        if (GmCXt.checkForErrorOnScreen()) return;
                        GmCXt.requestHandler.playTourNextStep();
                    }, 3000);

                } else {
                    GmCXt.requestHandler.playTourNextStep();
                }
            }
        }
    }
};

GmCXt.requestHandler.playTourNextStep = function() {

    GmCXt.log(33, "Executing play next step handler.");

    if (!GmCXt.isTrue(GmCXt.nextStepPlayEventReceived)) {

        GmCXt.nextStepPlayEventReceived = true;

        if (GmCXt.tourPlayerI) {
            GmCXt.tourPlayerI.currentStepReq = null;
            GmCXt.tourPlayerI.playNextStep();
        }
    }
};

GmCXt.requestHandler.playTourPrevStep = function() {

    GmCXt.log(33, "Executing play previous step handler.");

    if (GmCXt.tourPlayerI) {
        GmCXt.tourPlayerI.currentStepReq = null;
        GmCXt.tourPlayerI.playPreviousStep();
    }
};

GmCXt.requestHandler.videoAssignmentPlayed = function() {

    //'mgPlayerJSProd_action:lms_video_assignment_complete' handler needs to be added, does not exist anywhere

    GmCXt.showSmartTips();
    GmCXt.showBeacons();

    GmCXt.openAppPanel("byPassRoute");

    GmCXt.cleanPlayer();
};

GmCXt.insertVideoThumbSteps = function(videoSettings = {}, steps = []) {
    const {
        first_slide_img,
        last_slide_img,
        first_slide,
        last_slide,
        first_slide_id,
        last_slide_id,
        first_slide_text,
        last_slide_text
    } = videoSettings;

    const firstSlideURL = first_slide_img || first_slide?.substr(1);
    const lastSlideURL = last_slide_img || last_slide?.substr(1);

    if (!firstSlideURL || !lastSlideURL) return steps;

    const createStep = (id, url, title, isFirst, isLast) => {
        const fullUrl = url.includes(GmCXt.conf.cdn) ? url : GmCXt.conf.cdn + url;
        return {
            step_id: id,
            image_url: fullUrl,
            screen_url: fullUrl,
            thumbnail_url: fullUrl,
            step_title: title,
            step_type: 'image',
            step_settings: {},
            is_first_step: isFirst,
            is_last_step: isLast
        };
    };

    const firstStep = createStep(first_slide_id, firstSlideURL, first_slide_text, true, false);
    const lastStep = createStep(last_slide_id, lastSlideURL, last_slide_text, false, true);

    return [
        firstStep,
        ...steps,
        lastStep
    ];
};

GmCXt.playTour = function(data) {
    GmCXt.closeAppPanel();
    GmCXt.playerI.tour.steps = GmCXt.getStepsForPS(GmCXt.playerI.tour.steps);

    let mode = GmCXt.playerI.mode;

    if (!GmCXt.isAutomationRunning()) {
        GmCXt.hideBeacons();
    }

    if (mode === 'slideshow' || mode === 'video' || mode === 'blog' || mode === 'giphy') {
        GmCXt.tourPlayerI = GmCXt.tourPlayer();
        GmCXt.playerI.tour.steps = GmCXt.playerI.tour.steps.filter(function(step) {
            return step.step_type !== 'survey';
        });

        GmCXt.openAppPanel("playSlideShow");
        GmCXt.requestHandler.playSlideshow(mode);

    } else {

        mg$(window).focus();

        GmCXt.tourPlayerI = GmCXt.tourPlayer(data);
        GmCXt.tourPlayerI.start();
    }
};

GmCXt.checkVisible = function(pos) {
    let winHeight = mg$(window).height();
    let winWidth = mg$(window).width();

    return GmCXt.visibleInViewport(pos, winHeight, winWidth);
};

GmCXt.requestHandler.findOtherTooltips = function(message) {
    let data = message.data;
    delete data.isOptional;
    data.timeout = Date.now() + parseInt(GmCXt.t.tooltipTimeout);
    data.findOther = true;

    let action = 'mgPlayerJSProd_action:started;task:select_dom_element_tooltips';
    GmCXt.sendMessageToAllWindows(action, data);
};

GmCXt.requestHandler.handleEventSelectDOMElTooltip = function(event, message) {
    if (window.self === window.top) {
        let pi = GmCXt.playerI;

        if (!GmCXt.isNotNull(pi) || !GmCXt.isDefined(pi)) {
            return;
        }

        let d = message.data;

        if (event && message.status === GmCXt.ELEMENT_FOUND) {
            let pos = d.element.position;
            if (!event.source) {
                event.source = GmCXt.iframeEls[d.id];
            }
            d.element.position = GmCXt.addFrameOffset(event, pos);
        }

        if (GmCXt.tourPlayerI &&
			d.requestId === pi.currentStepId && message.status === GmCXt.ELEMENT_FOUND) {

            d.element.position = GmCXt.addScrollOffset(
                d.element.position,
                d.element.cssPosition
            );

            GmCXt.tourPlayerI.cssPosition = d.element.cssPosition;
            let render = false;

            if (d.watch) {
                if (d.posChanged) {
                    GmCXt.log(33, "Tooltip element position changed.");
                    render = true;
                } else if (mg$('.gm-tip-' + d.tooltipId).is(":hidden")) {
                    GmCXt.log(33, "Tooltip PopUp is hidden.");
                    render = true;
                }
            } else {
                GmCXt.log(33, "Show tooltip at first.");
                render = true;
            }

            if (render) {

                GmCXt.tourPlayerI.onSuccessTooltipElementFound(d.element.position,
                    d.tooltipId);
            }
        } else if (message.status === GmCXt.ELEMENT_NOT_FOUND) {
            GmCXt.tourPlayerI.onFailureTooltipElementNotFound(d.tooltipId);
        }

        GmCXt.playerI = pi;
    }
};

GmCXt.requestHandler.handleEventSelectDOMElement = function(event, message) {

    if (window.self === window.top) {

        let d = message.data;

        if (event && message.status === GmCXt.ELEMENT_FOUND) {
            let pos = d.element.position;
            if (!event.source) {
                event.source = GmCXt.iframeEls[d.id];
            }
            d.element.position = GmCXt.addFrameOffset(event, pos);
        }

        if (message.action == 'mgPlayerJSProd_action:completed;task:select_existing_dom_element') {

            if (message.status === GmCXt.ELEMENT_FOUND && !d.watch) {
                let visible = GmCXt.checkVisible(d.element.position);
                if (!visible)
                    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:bring_element_in_viewport', d);
            }

            if (GmCXt.isEmpty(GmCXt.playerI)) return;

            if (GmCXt.tourPlayerI && d.requestId === GmCXt.playerI.currentStepId) {

                switch (message.status) {

                case GmCXt.ELEMENT_FOUND:

                    d.element.position = GmCXt.addScrollOffset(
                        d.element.position,
                        d.element.cssPosition
                    );

                    GmCXt.tourPlayerI.cssPosition = d.element.cssPosition;
                    var render = false;

                    if (d.watch) {
                        if (d.posChanged) {
                            GmCXt.log(33, "POS CHANGED element");
                            render = true;
                        } else if (mg$('.mgPlayerJSProd_step-popup').is(":hidden")) {
                            GmCXt.log(33, "SHOW AGAIN. Step popup is hidden");
                            render = true;
                        }
                    } else {
                        GmCXt.log(33, "SHOW step popup");
                        render = true;
                    }

                    if (render) {
                        GmCXt.tourPlayerI.onSuccessElementFound(d.element.position, d.workdayEdit, d.id);
                    }
                    GmCXt.hideToastMsg();

                    break;

                case GmCXt.ELEMENT_NOT_FOUND:
                    GmCXt.tourPlayerI.onFailureElementNotFound(false, d.rca);
                    break;
                }
            }
        }
    }
};

GmCXt.requestHandler.enableNextButton = function(message) {
    mg$(".mgPlayerJSProd_play-step-next").css({
        "opacity": 1,
        "pointer-events": "initial"
    });
};

GmCXt.getTooltipText = function(message) {

    let text = '';
    let opts = message.options;

    if (message.derivedType === 'validation') {

        // From v1.3.27, added support multiple validations on a tooltip
        if (opts.rules && opts.rules.message) {

            mg$('.mgPlayerJSProd_smarttip-valid-' + message.stepId).hide();

            for (let rule in opts.rules) {

                if (opts.validationType && opts.validationType[rule] === true && GmCXt.tooltipValidRulesArr.indexOf(rule) === -1) {
                    text += GmCXt.escapeHtml(opts.rules.message[rule]) + ' <br/> ';
                }
            }

        } else if (opts.validationMessage) {
            text = GmCXt.escapeHtml(opts.validationMessage);
        }

    } else if (message.derivedType === 'guidance') {
        text = opts.guidanceMessage;
    }

    return text;
};

GmCXt.requestHandler.setBeaconPosition = function(m, ev) {

    if (ev && !ev.source) {
        ev.source = GmCXt.iframeEls[m.reqId];
    }
    let css_ = GmCXt.addFrameOffset(ev, m.css_);

    if (!m.isPositionFixed && window.top === window.self) {
        css_.left = css_.left + mg$(window).scrollLeft();
        css_.top = css_.top + mg$(window).scrollTop();
    }
    let beaconObj = mg$("#mgPlayerJSProd_beacon-icon-" + m.tourId);

    if (beaconObj.length) {
        beaconObj.css(css_);

        if (m.isPreview) {
            GmCXt.previewBeacons(m.tourId);
        }
    } else {
        let beaconIcon = m.beaconIcon;
        let beaconImgUrl = beaconIcon;

        if (beaconImgUrl.indexOf('default_beacon') === -1) {
            beaconImgUrl = GmCXt.restoreAssetSrc(beaconIcon);
        } else {
            beaconImgUrl = GmCXt.conf.staticContentPath + "default_beacon.png";
        }

        let beaconClass = "mgPlayerJSProd_beacon-icon mgPlayerJSProd_beacon-icon-tour-" + m.tourId;
        if (GmCXt.beaconsAreHidden && !m.isPreview) {
            beaconClass += " mgPlayerJSProd_hidden";
        }

        if (m.isPreview) beaconClass += " mgPlayerJSProd_preview-beacon";

        let titleAlign = m.align;
        if (m.requestData.beaconSettings.beaconMsgPosition) {
            titleAlign = m.requestData.beaconSettings.beaconMsgPosition;
        }

        let t = GmCXt.escapeHtml(m.tourTitle);
        let c = GmCXt.singleLineTitle(t);

        let html_ = "<wmgPlayerJSProd_ id='mgPlayerJSProd_beacon-icon-" + m.tourId +
			"' class='" + beaconClass + "'>" +
			"   <img src='" + beaconImgUrl + "' class='mgPlayerJSProd_custom-image' />" +
			"   <wmgPlayerJSProd_ class='mgPlayerJSProd_tour-title-on-beacon " + c + " mgPlayerJSProd_tour-title-on-beacon-" +
			titleAlign + "'>" +
			t +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";

        mg$(html_)
            .css(css_)
            .appendTo('html:first')
            .on('click', function() {
                if (!m.isPreview) {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_tour;event:beacon_click', {
                        tourId: m.tourId,
                        userKey: m.userKey
                    });
                    GmCXt.trackerV1.trackBeacons(m.requestData.tour, 'click');
                }
            })
            .on('mouseover', function() {
                this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex, true); // passing true for incrementing z-index
                if (!m.isPreview) {
                    GmCXt.trackerV1.trackBeacons(m.requestData.tour, 'hover');
                }
            })
            .on('mouseout', function() {
                this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex);
            });

        if (!m.isPreview) {
            GmCXt.updateBeaconsOnScreen(m.jobId.slice(1), true);
            GmCXt.trackerV1.trackBeacons(m.requestData.tour, 'display');
        }
    }
};

GmCXt.requestHandler.toggleBeacon = function(m) {
    let beaconImg = mg$(".mgPlayerJSProd_beacon-icon.mgPlayerJSProd_beacon-icon-tour-" + m.tourId);
    if (m.remove) {
        mg$(beaconImg).remove();
    } else if (!m.show) {
        mg$(beaconImg).hide();
    } else {
        mg$(beaconImg).show();
    }
};

//To show validation message and show guidance tooltip on user action
GmCXt.requestHandler.showSmarttip = function(m, ev) {

    if (!m.options) return;

    if (m.options.type == 'disableElement') {
        var text = m.options.ductTapeDescription;
    } else {
        var text = GmCXt.getTooltipText(m);
    }
    // disable smarttips in step creation mode
    if (GmCXt.stepReq &&
		GmCXt.stepReq.action.indexOf('inline_step') !== -1) {
        return;
    }

    let left = m.rect.left,
        top = m.rect.top,
        zIndex = m.zIndex,
        id = 'mgPlayerJSProd_smarttip-' + m.stepId,
        className = 'mgPlayerJSProd_smarttip-guidance-msg mgPlayerJSProd_hover-smarttip-msg mgPlayerJSProd_smarttip-tour-' + m.step.tour_id;

    if (m.derivedType === 'validation') {
        className += ' mgPlayerJSProd_smarttip-valid';
        className += ' mgPlayerJSProd_smarttip-valid-' + m.stepId;
        left = m.left;
        top = m.top - m.scrollTop;
        id = 'mgPlayerJSProd_smarttip-valid-' + m.stepId;
    }

    if (m.tipPosition) {
        className += ' ' + m.tipPosition;
    }

    if (m.isPreview)
        className += ' mgPlayerJSProd_preview-smarttip';

    className += ' mgPlayerJSProd_guidence-message-' + m.tourId;

    if (m.options.type == 'disableElement') {
        mg$('#' + id + "-alert").remove();
    } else {
        mg$('#' + id).remove();
    }
    mg$('.mgPlayerJSProd_smarttip-hover-element').hide();

    if (ev) {
        if (!ev.source) {
            ev.source = GmCXt.iframeEls[m.reqId];
        }
        let obj = {
            left: left,
            top: top
        };
        obj = GmCXt.addFrameOffset(ev, obj);
        left = obj.left + mg$(window).scrollLeft();
        top = obj.top + mg$(window).scrollTop();
    } else {
        top = m.top;
    }

    text = GmCXt.updateOrgAndAddSignature(GmCXt.replaceVariableWithValue(text));
    let c = GmCXt.singleLineTitle(text);

    var alignment = 'top';
    if (m.alignment) {
        alignment = m.alignment;
    }

    if (m.derivedType === 'validation') {
        if (m.options.rules.alignment)
            alignment = m.options.rules.alignment;

        if (alignment !== "top" || alignment !== "bottom")
            className += " mgPlayerJSProd_smarttip-guidance-msg-" + alignment + " mgPlayerJSProd_smarttip-valid-" + alignment;

        className += " mgPlayerJSProd_smarttip-valid-" + alignment;
    }

    if (m.actionType === 'hover') {
        className += " mgPlayerJSProd_smarttip-hover-element";
    }

    let popupSize = m.options.popupSize;
    let popupStyle = "";
    if (popupSize) {
        let popupWidth = popupSize.popupWidth ? popupSize.popupWidth : '250';
        let popupHeight = popupSize.popupHeight ? popupSize.popupHeight : '250';
        popupStyle = "max-width:" +
			popupWidth + "px; max-height:" + popupHeight + "px;";
    }

    let os = m.os || {};
    let tTheme = {};

    if (m.derivedType !== 'validation') {
        tTheme = GmCXt.tooltipTheme(os, 'wmgPlayerJSProd_', m.options);
        var popupFooter = "<wmgPlayerJSProd_ class='mgPlayerJSProd_smarttip-popup-footer mgPlayerJSProd_width-100 mgPlayerJSProd_display-flex mgPlayerJSProd_align-items-center mgPlayerJSProd_justify-content-flex-start'>" +
			"                 <img class='mgPlayerJSProd_custom-image' src='" + GmCXt.brandLogo() + "'>" +
			"              </wmgPlayerJSProd_>";
    }

    if (m.options.type == 'disableElement') {

        id = id + '-alert';
        mg$("<wmgPlayerJSProd_  class='" + className + " " + c + "' id='" + id + "' style=' " + (tTheme.tooltipBorderC ? tTheme.tooltipBorderC : '') + (tTheme.tooltipBgColor ? tTheme.tooltipBgColor : '') + (tTheme.tooltipBorderW ? tTheme.tooltipBorderW : '') + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + popupStyle + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_hover-smarttip-msg-inner'  style='" + popupStyle + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + (tTheme.tooltipDescColor ? tTheme.tooltipDescColor : '') + (tTheme.tooltipDescFsize ? tTheme.tooltipDescFsize : '') + (tTheme.tooltipDescFfamily ? tTheme.tooltipDescFfamily : '') + (tTheme.tooltipMwidth ? tTheme.tooltipMwidth : '') + (tTheme.tooltipWidth ? tTheme.tooltipWidth : '') + "'>" + text + "</wmgPlayerJSProd_>" + ((os.tooltipTheme && !os.hideBrandLogo) ? popupFooter : '') + "</wmgPlayerJSProd_>")
            .css({
                left: left,
                zIndex: zIndex,
                top: top,
            })
            .appendTo('html');
    } else {
        mg$("<wmgPlayerJSProd_  class='" + className + " " + c + "' id='" + id + "' style=' " + (tTheme.tooltipBorderC ? tTheme.tooltipBorderC : '') + (tTheme.tooltipBgColor ? tTheme.tooltipBgColor : '') + (tTheme.tooltipBorderW ? tTheme.tooltipBorderW : '') + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + popupStyle + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_hover-smarttip-msg-inner'  style='" + popupStyle + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + (tTheme.tooltipDescColor ? tTheme.tooltipDescColor : '') + (tTheme.tooltipDescFsize ? tTheme.tooltipDescFsize : '') + (tTheme.tooltipDescFfamily ? tTheme.tooltipDescFfamily : '') + (tTheme.tooltipMwidth ? tTheme.tooltipMwidth : '') + (tTheme.tooltipWidth ? tTheme.tooltipWidth : '') + "'>" + text + "</wmgPlayerJSProd_>" + ((os.tooltipTheme && !os.hideBrandLogo) ? popupFooter : '') + "</wmgPlayerJSProd_>")
            .css({
                left: left,
                zIndex: zIndex,
                top: top,
            })
            .appendTo('html');
    }
    GmCXt.imageSizeStyle('#' + id + ' .mgPlayerJSProd_hover-smarttip-msg-inner img');

    GmCXt.zoomImage(text, ".mgPlayerJSProd_hover-smarttip-msg-inner");

    if (text.indexOf('target = "gssPlayGuide"' !== -1)) {
        GmCXt.setLinkGuidePlay(text, ".mgPlayerJSProd_hover-smarttip-msg-inner");
    }

    if (GmCXt.isElectron()) {
        GmCXt.setLinkClickhandler(text, ".mgPlayerJSProd_hover-smarttip-msg-inner");
    }

    if (m.zIndex) {
        mg$('#' + id).css('z-index', parseInt(m.zIndex));
    }

    let elArea = GmCXt.getRectObject(m.highlightedArea);

    if (ev) {
        elArea = GmCXt.addFrameOffset(ev, elArea);

        if (m.tipPosition !== 'mgPlayerJSProd_absolute-position')
            elArea.top = elArea.top - m.scrollTop;

    } else if (m.tipPosition === 'mgPlayerJSProd_absolute-position') {
        elArea.top = elArea.top + m.scrollTop;
        if (alignment === "bottom")
            m.highlightedArea.top += 8;
    }

    let opts = {
        popup: mg$("#" + id),
        alignment: alignment,
        highlightedArea: elArea,
        doNotApplyArrow: true,
        isGuidance: true,
        customPos: m.options.customPosition
    };

    if (m.derivedType !== 'validation') {

        var alignment = GmCXt.alignPopup(opts).start();

        if (alignment) {
            mg$("#" + id).addClass(alignment);
        }

        if (!m.inTopWindow) {
            mg$("#" + id).css({
                top: mg$("#" + id).offset().top + mg$(window).scrollTop(),
                left: mg$("#" + id).offset().left + mg$(window).scrollLeft()
            });
        }

        if (m.options.hideAfter !== 'showAlways') {
            mg$('#' + id).off('mouseover').on('mouseover', function() {
                GmCXt.clearTooltipTimeout();
            }).off('mouseout').on('mouseout', function(e) {
                let topEl = document.elementFromPoint(e.clientX, e.clientY);

                if (!GmCXt.isParentElementId(topEl, id))
                    GmCXt.hideTooltipDelay(m.step, m.options);
            });
        }

        let toolTipActionData = {};
        toolTipActionData.settings = m.step.step_settings;
        toolTipActionData.step = m.step;

        GmCXt.addEventOnTooltip(toolTipActionData);

        if (!m.isPreview) {
            GmCXt.updateOnScreenTooltipGuideInfo(m.tour, m.tourId, m.stepId, true, m.options, GmCXt.urlParts.fullUrl);
        }
    }

    if (!m.isPreview) {
        GmCXt.updateTooltipActionInfo(m.tourId, m.stepId, m.options, m.actionType);
    }
};

GmCXt.getNotificationDelay = function() {

    let delay = GmCXt.getAppSetting('notificationDelay');
    delay = parseInt(delay);

    if (!isNaN(delay)) {
        if (delay) {
            GmCXt.log(10, "DELAYED notification loading: " + delay + " seconds");
        }
        return delay * 1000;
    } else
        return 0;
};

GmCXt.removeLxpStorageAll = function() {
    for (i = 0; i < window.localStorage.length; i++) {
        key = window.localStorage.key(i);
        if (key.slice(0, 5) === "mgLxp") {
            GmCXt.storage().remove(key);
        }
    }
};

GmCXt.addOverlay = function() {
    let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_global-black-overlay mgPlayerJSProd_display-none'> </wmgPlayerJSProd_>";
    mg$("html").append(html);
};

GmCXt.hideResumePopup = function() {
    mg$('.mgPlayerJSProd_play-pause-toolbar').hide();
    GmCXt.setResumeWinDisplayed(false);
};

GmCXt.addPauseGuideHtml = function() {
    let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-toolbar mgPlayerJSProd_display-none'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-toolbar-head'>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-pause-toolbar-title' class='mgPlayerJSProd_play-pause-toolbar-title'>" + GmCXt.label.resumeGuide + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_action-icons-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-position-top'>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-position-bottom'>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-toolbar-close'>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-toolbar-inner mgPlayerJSProd_inline-block-vm'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-pause-toolbar-resume mgPlayerJSProd_inline-block-vm'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_toolbar-resume-icon'>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-pause-resume-message' class='mgPlayerJSProd_label-resume mgPlayerJSProd_inline-block-vm'>" + GmCXt.label.resume + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";
    mg$("html").append(html);

    mg$(".mgPlayerJSProd_play-pause-position-top").html(GmCXt.svgs.down_arrow);
    mg$(".mgPlayerJSProd_play-pause-position-bottom").html(GmCXt.svgs.down_arrow);
    mg$(".mgPlayerJSProd_play-pause-toolbar-close").html(GmCXt.svgs.close_resume);
    mg$(".mgPlayerJSProd_toolbar-resume-icon").html(GmCXt.svgs.resume);

    mg$('.mgPlayerJSProd_play-pause-toolbar-resume').on("click", function() {
        GmCXt.hideResumePopup();

        GmCXt.storage().get(['mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY', 'guide_play_event']).then(function(result) {

            GmCXt.guidePlayTracker = result.guide_play_event || {};

            if (result.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY) {

                GmCXt.playerI.currentStepId = result.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY.lastPlayedStepId;

                GmCXt.playerI.guideState = 'live';
                GmCXt.tourPlayerI.guideState = 'live';

                GmCXt.requestHandler.playTourNextStep();
            }
        });
    });

    mg$('.mgPlayerJSProd_play-pause-toolbar-close').on("click", function() {
        GmCXt.hideResumePopup();
        GmCXt.displayWidget();

        if (GmCXt.tourPlayerI) GmCXt.tourPlayerI.stop();
    });

    mg$('.mgPlayerJSProd_play-pause-position-top').on('click', function(e) {
        GmCXt.setElementStyle(this, {
            'display': 'none'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-bottom', {
            'display': 'inline-block'
        }, true);
        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:position_play_pause_toolbar', {
            position: 'top'
        });
    });

    mg$('.mgPlayerJSProd_play-pause-position-bottom').on('click', function(e) {
        GmCXt.setElementStyle(this, {
            'display': 'none'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-top', {
            'display': 'inline-block'
        }, true);
        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:position_play_pause_toolbar', {
            position: 'bottom'
        });
    });
};

GmCXt.addImagePopHtml = function() {
    let html =
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_image_popup' class='mgPlayerJSProd_image-popup mgPlayerJSProd_display-none'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_close-img-popup'>&times;</wmgPlayerJSProd_>" +
		"<img class='mgPlayerJSProd_modal-content mgPlayerJSProd_custom-image' id='mgPlayerJSProd_img_desc'>" +
		"</wmgPlayerJSProd_>";
    mg$("html").append(html);
};

GmCXt.addStepPreviewHtml = function(popupObj) {
    let t = popupObj.tour;
    let a = popupObj.settings.automation;
    let audioIcon = "<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_popup-audio-on mgPlayerJSProd_popup-audio-icon'></wmgPlayerJSProd_>";
    let os = GmCXt.getStepSettings();

    let popupDesign = os.popupDesign;
    let labelBtnPrev = ((popupDesign.type === 'classic' &&
		GmCXt.getAppSetting("userLabels").btnPrev === GmCXt.engLbls.defaultBtnPrev) ? GmCXt.label.btnPrevious : GmCXt.label.btnPrev);

    let html =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_preview-step-popup-container mgPlayerJSProd_step-popup mgPlayerJSProd_display-none' id='mgPlayerJSProd_preview_step_popup_container'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-header'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-s-num mgPlayerJSProd_inline-block-vm'></wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-ctrls-wrapper mgPlayerJSProd_position-relative' > ";

    if (a.hasHumanInteraction) {
        html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-automation-indicator-wrapper' class='mgPlayerJSProd_play-step-automation-indicator-wrapper'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-user-icon'>" +
			"<img src='" + GmCXt.getBaseUrl('common/icons/mg-user-icon.png') + "'/>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";
    } else {
        html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-automation-indicator-wrapper' class='mgPlayerJSProd_play-step-automation-indicator-wrapper'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-auto-gear mgPlayerJSProd_inline-block-vm' id='mgPlayerJSProd_play_step_auto_gear'></wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_automation-progress-wrapper'>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_auto-progress-1' class='mgPlayerJSProd_automation-progress mgPlayerJSProd_inline-block-vm''></wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_auto-progress-2' class='mgPlayerJSProd_automation-progress mgPlayerJSProd_inline-block-vm''></wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_auto-progress-3' class='mgPlayerJSProd_automation-progress mgPlayerJSProd_inline-block-vm''></wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";
    }

    html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-drag mgPlayerJSProd_message-popup-drag mgPlayerJSProd_inline-block-vm mgPlayerJSProd_play-step-popup-icon-common' aria-label='step popup drag button' id='mgPlayerJSProd_play_step_popup_drag' tabindex='0'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span' id='mgPlayerJSProd_play-step-popup-drag-icon' ></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    let audioPreference = GmCXt.getAudioPreference();

    if (!audioPreference || GmCXt.isPageReloaded) {
        audioIcon = "<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_popup-audio-off mgPlayerJSProd_popup-audio-icon'></wmgPlayerJSProd_>";
    }

    if (GmCXt.FT.audio) {
        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-audio mgPlayerJSProd_inline-block-vm mgPlayerJSProd_play-step-popup-icon-common' id='mgPlayerJSProd_play_step_audio' tabindex='0'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_audio-pop-icons' >" +
			audioIcon +
			"</wmgPlayerJSProd_>" +
			"<iframe id='mgPlayerJSProd_play-step-audio-iframe' title='Guideme step audio iframe'  class='mgPlayerJSProd_play-step-audio-iframe' src='" + GmCXt.getBasePath('common/audio/audio.html') + "' ></iframe>" +
			"</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-audio-loader mgPlayerJSProd_inline-block-vm'>" +
			"<img src='" + GmCXt.loader() + "' />" + "</wmgPlayerJSProd_>";
    }
    if (GmCXt.FT.creatorApp && t && !t.is_published && !(GmCXt.isDesktop())) {
        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-edit mgPlayerJSProd_inline-block-vm mgPlayerJSProd_play-step-popup-icon-common' id ='mgPlayerJSProd_play_step_popup_edit' tabindex='0'>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-popup-edit-icon' class='mgPlayerJSProd_span mgPlayerJSProd_play-step-popup-edit-icon'></wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";
    }

    if (!GmCXt.isAutomationRunning()) {
        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-close mgPlayerJSProd_inline-block-vm mgPlayerJSProd_play-step-popup-icon-common' aria-label='step popup close button' id='mgPlayerJSProd_play_step_popup_close' tabindex='0'>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-popup-close-svg' class='mgPlayerJSProd_span mgPlayerJSProd_play-step-popup-close-svg' ></wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";
    }

    html += "</wmgPlayerJSProd_>";

    html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-content-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-s-title mgPlayerJSProd_step-title mgPlayerJSProd_inline-block-vm' tabindex='0'></wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-description' tabindex='0'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-footer'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-popup-logo mgPlayerJSProd_inline-block-vm'>" +
		"<img src='' class='mgPlayerJSProd_custom-image'  alt='" + GmCXt.label.brandLogo + "' tabindex='0'/>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-navigation mgPlayerJSProd_inline-block-vm'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-prev mgPlayerJSProd_inline-block-vm' aria-label='step popup " + labelBtnPrev + " button' id='mgPlayerJSProd_play_step_prev' tabindex='0'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_text-overflow-ellipsis'>" + labelBtnPrev + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-next mgPlayerJSProd_play-step-next-done mgPlayerJSProd_inline-block-vm' aria-label='step popup " + GmCXt.label.next + " button' id='mgPlayerJSProd_play_step_next' tabindex='0'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_text-overflow-ellipsis'>" + GmCXt.label.next + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-next mgPlayerJSProd_play-step-next-done mgPlayerJSProd_play-step mgPlayerJSProd_inline-block-vm mgPlayerJSProd_display-none mgPlayerJSProd_text-align-center mgPlayerJSProd_font-size-15' aria-label='step popup done button' id='mgPlayerJSProd_play_step_next_done' tabindex='0'>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-next-done-svg' class='mgPlayerJSProd_span mgPlayerJSProd_inline-block-vm mgPlayerJSProd_width-auto'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    if (!GmCXt.isAutomationRunning()) {
        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_play-step-pause mgPlayerJSProd_inline-block-vm mgPlayerJSProd_display-none mgPlayerJSProd_text-align-center mgPlayerJSProd_font-size-15' aria-label='step popup pause button' id='mgPlayerJSProd_play_step_pause' tabindex='0'>" +
			"<wmgPlayerJSProd_ id='mgPlayerJSProd_play-step-pause-svg' class='mgPlayerJSProd_span mgPlayerJSProd_inline-block-vm mgPlayerJSProd_width-auto'></wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";
    }

    html += "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_preview-step-popup-navigation-wrapper mgPlayerJSProd_inline-block-vt mgPlayerJSProd_popup-classic-design-navigation'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-classic-navigation-next mgPlayerJSProd_play-step-next mgPlayerJSProd_play-step-next-done mgPlayerJSProd_play-step mgPlayerJSProd_play-step-classic-done mgPlayerJSProd_inline-block-vt mgPlayerJSProd_display-none' aria-label='step popup " + GmCXt.label.close + " button' id='mgPlayerJSProd_play_step_next_done_classic' tabindex='0'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_popup-classic-next mgPlayerJSProd_width-auto mgPlayerJSProd_no-margin'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-classic-navigation-next mgPlayerJSProd_play-step-next mgPlayerJSProd_inline-block-vt' aria-label='step popup " + GmCXt.label.next + " button' id='mgPlayerJSProd_play_step_next_classic' tabindex='0'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_text-span mgPlayerJSProd_width-auto mgPlayerJSProd_text-overflow-ellipsis'>" + GmCXt.label.next + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_popup-classic-navigation-next-svg' class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_no-margin'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-classic-design-navigation-prev mgPlayerJSProd_play-step-prev mgPlayerJSProd_inline-block-vt' aria-label='step popup " + labelBtnPrev + " button' id='mgPlayerJSProd_play_step_prev_classic' tabindex='0'>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_popup-classic-navigation-prev-svg' class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_no-margin'></wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_width-auto mgPlayerJSProd_text-overflow-ellipsis'>" + labelBtnPrev + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-classic-navigation-pause mgPlayerJSProd_play-step-pause-classic mgPlayerJSProd_inline-block-vt mgPlayerJSProd_display-none' aria-label='step popup pause button' id='mgPlayerJSProd_play_step_pause_classic' tabindex='0'>" +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_popup-classic-nav-pause-svg' class='mgPlayerJSProd_span mgPlayerJSProd_inline-block-vt mgPlayerJSProd_width-auto'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_clear'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    mg$("html:first").append(html);

    mg$("#mgPlayerJSProd_play-step-popup-drag-icon").html(GmCXt.svgs.iconPopupDrag);
    mg$("#mgPlayerJSProd_play_step_auto_gear").html(GmCXt.svgs.iconStepAutoGear);
    mg$(".mgPlayerJSProd_popup-audio-on").html(GmCXt.svgs.iconStepPlayAudioOn);
    mg$(".mgPlayerJSProd_popup-audio-off").html(GmCXt.svgs.iconStepPlayAudioOff);
    mg$("#mgPlayerJSProd_play-step-popup-edit-icon").html(GmCXt.svgs.iconPopupEdit);
    mg$("#mgPlayerJSProd_play-step-popup-close-svg").html(GmCXt.svgs.iconClosePopup);
    mg$("#mgPlayerJSProd_play-step-pause-svg").html(GmCXt.svgs.iconPause);
    mg$("#mgPlayerJSProd_popup-classic-navigation-next-svg").html(GmCXt.svgs.iconClassicNavNext);
    mg$("#mgPlayerJSProd_popup-classic-navigation-prev-svg").html(GmCXt.svgs.iconClassicNavPrev);
    mg$("#mgPlayerJSProd_play-step-next-done-svg").html(GmCXt.svgs.iconPlayStepNext);
    mg$("#mgPlayerJSProd_popup-classic-nav-pause-svg").html(GmCXt.svgs.iconPause);

    if (!GmCXt.FT.audio) {
        mg$('.mgPlayerJSProd_play-step-popup-drag').css('right', '30px');
        mg$('.mgPlayerJSProd_play-step-popup-edit').css('right', '50px');
    }
};

GmCXt.setResumeWinDisplayed = function(status) {
    GmCXt.storage().set({
        'resumeWinDisplayed': status
    });
};

GmCXt.addStopTestMePanel = function() {
    let html =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-active mgPlayerJSProd_display-none'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-active-head'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-active-countdown'></wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-action-icons-wrapper'>" +
		"<button class='mgPlayerJSProd_play-pause-position-top mgPlayerJSProd_lbl-btn'>" +
		"</button>" +
		"<button class='mgPlayerJSProd_play-pause-position-bottom mgPlayerJSProd_lbl-btn'>" +
		"</button>" +
		"<button class='mgPlayerJSProd_testme-active-close mgPlayerJSProd_lbl-btn'>" +
		"</button>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-active-inner'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-active-title'>" + GmCXt.label.testMeStopMessage + "</wmgPlayerJSProd_>" +
		"<button class='mgPlayerJSProd_testme-active-stop mgPlayerJSProd_lbl-btn'>" +
		"<img class='mgPlayerJSProd_testme-stop-img' src='" + GmCXt.conf.staticContentPath + "white_stop.png'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_testme-stop-label'>" + GmCXt.label.stop + "</wmgPlayerJSProd_>" +
		"</button>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";
    mg$("html").append(html);

    mg$(".mgPlayerJSProd_play-pause-position-top").html(GmCXt.svgs.down_arrow);
    mg$(".mgPlayerJSProd_play-pause-position-bottom").html(GmCXt.svgs.down_arrow);
    mg$(".mgPlayerJSProd_testme-active-close").html(GmCXt.svgs.close_resume);

    function stopTestMe() {
        GmCXt.requestHandler.stopToolTestMe();
    }

    mg$('.mgPlayerJSProd_testme-active-stop').on("click", stopTestMe);
    mg$('.mgPlayerJSProd_testme-active-close').on("click", stopTestMe);

    mg$('.mgPlayerJSProd_play-pause-position-top').on('click', function(e) {
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-top', {
            'display': 'none'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-bottom', {
            'display': 'inline-block'
        }, true);
        mg$('.mgPlayerJSProd_testme-active').css({
            top: '5px'
        });
    });

    mg$('.mgPlayerJSProd_play-pause-position-bottom').on('click', function(e) {
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-bottom', {
            'display': 'none'
        }, true);
        GmCXt.setElementStyle('.mgPlayerJSProd_play-pause-position-top', {
            'display': 'inline-block'
        }, true);
        let bpos = mg$(window).height() - 127;
        mg$('.mgPlayerJSProd_testme-active').css({
            top: bpos + 'px'
        });
    });
};

GmCXt.addFeedBackToolbar = function() {
    let html = "<wmgPlayerJSProd_ id='mg-feedback-container-wrapper' class='mgPlayerJSProd_display-none'>" +
		"	<wmgPlayerJSProd_ id='mg-feedback-flex-container' class='mgPlayerJSProd_feedback-flex-container'>" +
		"		<wmgPlayerJSProd_ id='mgPlayerJSProd_blackout' class='mgPlayerJSProd_blackout'></wmgPlayerJSProd_>" +
		"		<wmgPlayerJSProd_ id='mgPlayerJSProd_highlight' class='mgPlayerJSProd_highlight'></wmgPlayerJSProd_>" +
		"		<wmgPlayerJSProd_ id='mg-feedback-popup' class='mgPlayerJSProd_feedback-modal-content'>" +
		"			<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-popup-inner-container'>" +
		"				<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-header'>" +
		"					<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-header-text'>" + GmCXt.label.sendFeedback + "</wmgPlayerJSProd_>" +
		"				</wmgPlayerJSProd_>" +
		"				<textarea class='mgPlayerJSProd_feedback-textarea' id='mg-feedback' name='feedback' rows='4' cols='5' maxlength='3000' placeholder='" + GmCXt.label.feedbackPlaceholder + "'></textarea>" +
		"				<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-body'>" +
		"					<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-check'>" +
		"						<input type='checkbox' id='mg-feedback-screenshot-check' class='mgPlayerJSProd_feedback-checkbox' checked>" +
		"						<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-label'>" + GmCXt.label.includeScreen + "</wmgPlayerJSProd_>" +
		"					</wmgPlayerJSProd_>" +
		"					<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-img-container'>" +
		"						<button class='mgPlayerJSProd_feedback-re-edit-btn mgPlayerJSProd_click-reEditImage'>" +
		"							<img id='mg-feedback-screenshot-image' class='mgPlayerJSProd_feedback-img' src=''>" +
		"							<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-overlay-svg'>" +
		"								<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'>" +
		"									<path d='M16.1 8.43V5.36a1 1 0 1 1 2 0v3.07a1 1 0 0 1-2 0Zm7 3.49a1 1 0 0 0 .71-.29L26 9.46a1 1 0 0 0 0-1.41 1 1 0 0 0-1.41 0l-2.17 2.17a1 1 0 0 0 .7 1.7ZM10.37 22.26 8.2 24.43a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l2.17-2.17a1 1 0 1 0-1.42-1.42ZM9.58 17a1 1 0 0 0-1-1H5.52a1 1 0 0 0 0 2h3.06a1 1 0 0 0 1-1Zm0-8.9A1 1 0 0 0 8.2 9.46l2.17 2.17a1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29 1 1 0 0 0 0-1.41Zm17.57 19.3a1 1 0 0 1-1.41 0l-3.63-3.63-2.58 3.35a1 1 0 0 1-.79.39h-.17a1 1 0 0 1-.78-.68L14.28 15.7a1 1 0 0 1 1.26-1.26L26.61 18a1 1 0 0 1 .31 1.75l-3.35 2.58 3.62 3.62a1 1 0 0 1 0 1.4Zm-5.89-5.8.07-.06.07-.06 2.74-2.11L16.73 17l2.37 7.4Z' />" +
		"								</svg>" +
		"								<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_feedback-svg-text'>" + GmCXt.label.feedbackOptBtn + "</wmgPlayerJSProd_>" +
		"							</wmgPlayerJSProd_>" +
		"						</button>" +
		"						<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-overlay-svg-error'>" + GmCXt.label.feedbackImgErrorMsg + " </wmgPlayerJSProd_>" +
		"					</wmgPlayerJSProd_>" +
		"				</wmgPlayerJSProd_>" +
		"				<wmgPlayerJSProd_ class='mgPlayerJSProd_feedback-footer'>" +
		"					<button type='submit' class='mgPlayerJSProd_feedback-cancel'>" + GmCXt.label.btnCancel + "</button>" +
		"					<button type='submit' class='mgPlayerJSProd_feedback-send-btn'>" + GmCXt.label.send + "</button>" +
		"				</wmgPlayerJSProd_>" +
		"			</wmgPlayerJSProd_>" +
		"		</wmgPlayerJSProd_>" +
		"		<wmgPlayerJSProd_ id='mg-feedback-selector-toolbar' class='mgPlayerJSProd_feedback-selector-toolbar mgPlayerJSProd_feedback-modal-content'>" +
		"			<button id='mg-feedback-highlight-btn' class='mgPlayerJSProd_selector-btn btn-border'>" + GmCXt.label.highlight + "</button>" +
		"			<button id='mg-feedback-hide-btn' class='mgPlayerJSProd_selector-btn btn-border'>" + GmCXt.label.hide + "</button>" +
		"			<button id='mg-feedback-done-btn' class='mgPlayerJSProd_selector-btn'>" + GmCXt.label.done + "</button>" +
		"		</wmgPlayerJSProd_>" +
		"	</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    mg$("html").append(html);

    mg$('.mgPlayerJSProd_feedback-send-btn').off('click').on('click', function() {
        GmCXt.sendFeedback();
    });
    mg$('.mgPlayerJSProd_feedback-cancel').off('click').on('click', function() {
        GmCXt.clearFeedBackView();
    });
    mg$('.mgPlayerJSProd_click-reEditImage').off('click').on('click', function() {
        GmCXt.onEditScreenshotClick();
    });
    mg$('#mg-feedback-highlight-btn').off('click').on('click', function() {
        GmCXt.onClickFeedbackHighlightArea();
    });
    mg$('#mg-feedback-hide-btn').off('click').on('click', function() {
        GmCXt.onClickFeedbackHideArea();
    });
    mg$('#mg-feedback-done-btn').off('click').on('click', function() {
        GmCXt.onClickFeedbackEditDone();
    });
};

GmCXt.addListenersToDesktopApp = function() {

    if (GmCXt.isCreatorExt()) {
        document.addEventListener('start_creator_session', createSession);

        document.addEventListener('start_guide_automation', function(e) {
            GmCXt.log(37, "input data", e.detail.playJSON);
            let data = GmCXt.parseJSON(e.detail.playJSON);
            syncDesktopRequest(e).then(function() {
                GmRootScope.switchApp(GmCXt.appList['app:' + data.application_id]);
                GmCXt.startAuto(data);
            });
        });
    }

    if (GmCXt.isPlayer()) {
        document.addEventListener('start_player_session', createSession);
    }

    function syncDesktopRequest(e) {

        let deskReq = e.detail;
        return GmCXt.storage().get(['desktopReq']).then(function(st) {
            if (st && st.desktopReq) {
                deskReq = Object.assign({}, st.desktopReq, deskReq);
            }
            GmCXt.deskReq = deskReq;
            return deskReq;
        });
    }

    function startTour(e) {
        return syncDesktopRequest(e).then(GmCXt.startTourFromDesktopApp);
    }

    function createSession(e) {
        return syncDesktopRequest(e).then(function() {
            if (!e.detail.user) {
                return;
            }

            // Prepare user data
            const userData = GmCXt.parseJSON(e.detail.user);
            const validatedUser = GmCXt.validateDataModel(userData, GmCXt.model.user);

            const data = {
                data: {
                    user: validatedUser
                }
            };

            // Process user sign-in if needed
            if (!GmCXt.user && validatedUser && !GmCXt.isEmpty(validatedUser)) {
                GmCXt.onUserSignin(data);
            }
        });
    }
};

GmCXt.addDragPopUpFunction = function() {
    let elmnt = document.getElementById("mgPlayerJSProd_preview_step_popup_container");
    let dragEl = document.getElementById('mgPlayerJSProd_play_step_popup_drag');
    GmCXt.attachDragEvents(elmnt, dragEl);
};

GmCXt.addDragMicroPlayerFunction = function() {
    let elmnt = document.getElementsByClassName('mgPlayerJSProd_panel mgPlayerJSProd_theme-mplayer')[0];
    let dragEl = document.getElementById('mgPlayerJSProd_mPlayer-drag');

    GmCXt.attachDragEvents(elmnt, dragEl);
};

GmCXt.addStepToolbar = function() {
    let cname = 'mgPlayerJSProd_toolbar-iframe';
    if (GmCXt.isCreatorExt()) {
        cname += ' ' + GmCXt.conf.appName + '-step-toolbar';
    }

    let toolbarHtml = `<wmgPlayerJSProd_ class='mgPlayerJSProd_toolbar-panel'>
		<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-body">
			<wmgPlayerJSProd_ class='mgPlayerJSProd_guideme-step-toolbar'>
				<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-header-wrapper">
					<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-title-wrapper">
						<wmgPlayerJSProd_ class="mgPlayerJSProd_title-text"></wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_info-icon-wrapper mgPlayerJSProd_position-relative mgPlayerJSProd_float-left mgPlayerJSProd_cursor-pointer">
							<wmgPlayerJSProd_ class="mgPlayerJSProd_info-icon mgPlayerJSProd_inline-block-vm mgPlayerJSProd_position-relative"></wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class="mgPlayerJSProd_info-hover mgPlayerJSProd_position-bottom-center">
								<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-tooltip-capture mgPlayerJSProd_toolbar-tooltip-instruction mgPlayerJSProd_info-hover-text">
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-tooltip-navigation mgPlayerJSProd_toolbar-tooltip-instruction mgPlayerJSProd_info-hover-text">
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_
									class="mgPlayerJSProd_toolbar-tooltip-delay-capture mgPlayerJSProd_toolbar-tooltip-instruction mgPlayerJSProd_info-hover-text">
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_
							class="mgPlayerJSProd_capture-step-counter-wrapper mgPlayerJSProd_display-none">
							<wmgPlayerJSProd_
								class="mgPlayerJSProd_capture-step-counter mgPlayerJSProd_display-flex mgPlayerJSProd_align-items-center mgPlayerJSProd_justify-content-center">
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center'>
								<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title-step-counter mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
					<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-header-icons-wrapper">
						<wmgPlayerJSProd_ id="mgPlayerJSProd_toolbar-position-top" class="mgPlayerJSProd_toolbar-position-top">
							<wmgPlayerJSProd_ class="mgPlayerJSProd_svg-position-top-arrow"></wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>
								<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title-move-top mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ id="mgPlayerJSProd_toolbar-position-bottom" class="mgPlayerJSProd_toolbar-position-bottom">
							<wmgPlayerJSProd_ class="mgPlayerJSProd_svg-position-bottom-arrow"></wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>
								<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title-move-bottom mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ id="mgPlayerJSProd_toolbar-close-btn" class="mgPlayerJSProd_toolbar-close-btn">
							<wmgPlayerJSProd_ class="mgPlayerJSProd_svg-toolbar-close-btn"></wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>
								<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title-close mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
				<wmgPlayerJSProd_ class="mgPlayerJSProd_step-tools-wrapper">
					<wmgPlayerJSProd_ class='mgPlayerJSProd_toolbar'>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-navigate-wrapper">
							<input type="radio" id="mgPlayerJSProd_default-action-radio-navigation"
								class="mgPlayerJSProd_input-radio-custom mgPlayerJSProd_opacity mgPlayerJSProd_opacity-2 mgPlayerJSProd_default-action-radio"
								name="mgPlayerJSProd_guide-select-mode" value="navigate" />
							<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick mgPlayerJSProd_position-relative mgPlayerJSProd_selected-mode-tick-navigation">
								<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick-icon"></wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-right'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title mgPlayerJSProd_default-selection-title mgPlayerJSProd_text-color-white">Default selection mode</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class="mgPlayerJSProd_navigate-tool-wrapper">
								<wmgPlayerJSProd_ id="mgPlayerJSProd_navigate-tool" class='mgPlayerJSProd_navigate-tool'>
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center mgPlayerJSProd_navigate-tooltip-wrapper'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
										<wmgPlayerJSProd_ class="mgPlayerJSProd_navigate-lbl mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
									</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-capture-wrapper">
							<input type="radio" id="mgPlayerJSProd_default-action-radio-capture"
								class="mgPlayerJSProd_input-radio-custom mgPlayerJSProd_opacity mgPlayerJSProd_opacity-2 mgPlayerJSProd_default-action-radio"
								name="mgPlayerJSProd_guide-select-mode" value="capture" />
							<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick mgPlayerJSProd_position-relative mgPlayerJSProd_selected-mode-tick-capture">
								<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick-icon"></wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title mgPlayerJSProd_default-selection-title mgPlayerJSProd_text-color-white">Default selection mode</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class="mgPlayerJSProd_capture-tool-wrapper">
								<wmgPlayerJSProd_ id="mgPlayerJSProd_capture-tool" class='mgPlayerJSProd_capture-tool'>
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center mgPlayerJSProd_capture-tooltip-wrapper'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
										<wmgPlayerJSProd_ class="mgPlayerJSProd_capture-lbl mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
									</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-delay-capture-wrapper">
							<input type="radio" id="mgPlayerJSProd_default-action-radio-delay"
								class="mgPlayerJSProd_input-radio-custom mgPlayerJSProd_opacity mgPlayerJSProd_opacity-2 mgPlayerJSProd_default-action-radio"
								name="mgPlayerJSProd_guide-select-mode" value="delay-capture" />
							<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick mgPlayerJSProd_position-relative mgPlayerJSProd_selected-mode-tick-delay">
								<wmgPlayerJSProd_ class="mgPlayerJSProd_selected-mode-tick-icon"></wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title mgPlayerJSProd_default-selection-title mgPlayerJSProd_text-color-white">Default selection mode</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-capture-tool-wrapper">
								<wmgPlayerJSProd_ id="mgPlayerJSProd_delay-capture-tool" class='mgPlayerJSProd_delay-capture-tool'>
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_
									class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-center mgPlayerJSProd_delay-capture-tooltip-wrapper'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
										<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-capture-lbl mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
									</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-jQuery-wrapper">
							<input type="checkbox" class="mgPlayerJSProd_enable-jQuery-checkbox" id="mgPlayerJSProd_switch" />
							<wmgPlayerJSProd_ class="mgPlayerJSProd_jQuery-tool-wrapper">
								<wmgPlayerJSProd_ id="mgPlayerJSProd_jQuery-tool" class='mgPlayerJSProd_jQuery-tool' for="switch">
								</wmgPlayerJSProd_>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left mgPlayerJSProd_jQuery-tooltip-wrapper'>
									<wmgPlayerJSProd_ class="mgPlayerJSProd_tooltip-title">
										<wmgPlayerJSProd_ class="mgPlayerJSProd_jQuery-lbl mgPlayerJSProd_text-color-white"></wmgPlayerJSProd_>
									</wmgPlayerJSProd_>
								</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>

					<wmgPlayerJSProd_ class='mgPlayerJSProd_jQuery-textarea-wrapper'>
						<textarea class="mgPlayerJSProd_textarea" rows="3" maxlength="1000" spellcheck="false"
							placeholder="Enter jQuery here..."></textarea>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_jQuery-textarea-footer">
							<button class='mgPlayerJSProd_select-jQuery-button mgPlayerJSProd_disabled'></button>
							<button class='mgPlayerJSProd_back-jQuery-button'></button>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
				<wmgPlayerJSProd_ class="mgPlayerJSProd_toolbar-footer-wrapper mgPlayerJSProd_width-100">
					<button class="mgPlayerJSProd_btn-selection-done mgPlayerJSProd_btn-default"></button>
				</wmgPlayerJSProd_>

				<wmgPlayerJSProd_ class="mgPlayerJSProd_done-btn-container mgPlayerJSProd_width-100">
					<button class="mgPlayerJSProd_tags-selection-done mgPlayerJSProd_btn-default"></button>
				</wmgPlayerJSProd_>
			</wmgPlayerJSProd_>

			<wmgPlayerJSProd_ class="mgPlayerJSProd_guideme-step-delay-capture-container">
				<wmgPlayerJSProd_ class="mgPlayerJSProd_guideme-step-delay-capture-inner-container">
					<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-capture-wrapper mgPlayerJSProd_delay-capture-5-wrapper">
						<wmgPlayerJSProd_ id="mgPlayerJSProd_5-second-delay" class="mgPlayerJSProd_delay-timer-wrapper mgPlayerJSProd_five-second-delay
					mgPlayerJSProd_5-second-delay-svg">
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-timer-wrapper mgPlayerJSProd_five-second-delay mgPlayerJSProd_5-second-delay-svg-counter">
							<wmgPlayerJSProd_ id="mgPlayerJSProd_5-second-delay-counter" class="mgPlayerJSProd_span mgPlayerJSProd_delay-counter"></wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_span mgPlayerJSProd_delay-5-sec"></wmgPlayerJSProd_>
					</wmgPlayerJSProd_>

					<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-capture-wrapper mgPlayerJSProd_delay-capture-10-wrapper">
						<wmgPlayerJSProd_ id="mgPlayerJSProd_10-second-delay-svg"
							class="mgPlayerJSProd_delay-timer-wrapper mgPlayerJSProd_ten-second-delay mgPlayerJSProd_10-second-delay-svg">
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_delay-timer-wrapper mgPlayerJSProd_ten-second-delay mgPlayerJSProd_10-second-delay-svg-counter">
							<wmgPlayerJSProd_ id="mgPlayerJSProd_10-second-delay-counter" class="mgPlayerJSProd_span mgPlayerJSProd_delay-counter"></wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class="mgPlayerJSProd_span mgPlayerJSProd_delay-10-sec"></wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
			</wmgPlayerJSProd_>
		</wmgPlayerJSProd_>
	</wmgPlayerJSProd_>`;

    mg$("html").append(toolbarHtml);

};

GmCXt.getSidePanelIframe = function() {
    let u = GmCXt.getBaseUrl("side_panel/sidepanel.html") + "?domainName=" + GmCXt.getPageDomain();
    let aria_hidden = "aria-hidden = 'true' tabindex = '-1'";
    let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_panel mgPlayerJSProd_mobile-view " + (GmCXt.isMicroPlayer() ? 'mgPlayerJSProd_theme-mplayer' : '') + "' " + aria_hidden + ">";

    // micro player drag element
    html += "<wmgPlayerJSProd_ id='mgPlayerJSProd_mPlayer-drag'> </wmgPlayerJSProd_>";

    let cname = 'mgPlayerJSProd_app';

    if (GmCXt.isCreatorExt() || GmCXt.isPlayer()) {
        cname += ' ' + GmCXt.conf.appName + '-side-panel';
    }

    let scormText = "";
    if (GmCXt.FT.isPlayer && window.location.hostname === "cloud.scorm.com") {
        scormText = 'onload="updateIframesLoadedCount()"';
    }

    html += "<wmgPlayerJSProd_ class='"+cname+"'>" +
	GmCXt.getSidePanelHtml() +
	"</wmgPlayerJSProd_>";

    return html;
};

GmCXt.getSidePanelHtml = function() {
    const mainContainerHTML = `
	<wmgPlayerJSProd_ id="mgPlayerJSProd_main-container">
		<wmgPlayerJSProd_ id='mgPlayerJSProd_ege-panel' class='mgPlayerJSProd_ege-panel'>
		</wmgPlayerJSProd_>

		<input id="mgPlayerJSProd_upload-multiple-images-file-input" type="file" tabindex="-1" multiple="">

		<wmgPlayerJSProd_ id='mgPlayerJSProd_slideshow-panel' class='mgPlayerJSProd_slideshow-panel mgPlayerJSProd_display-none'>
		</wmgPlayerJSProd_>

		<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-panel'>
			<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-panel-inner'>
				<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-header'>
					<wmgPlayerJSProd_ class='mgPlayerJSProd_options-left'>
						<wmgPlayerJSProd_ class='mgPlayerJSProd_options-zoom'>
							<wmgPlayerJSProd_ id='mgPlayerJSProd_min-media-player' class='mgPlayerJSProd_media-player-btn'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-min-media-player'></wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ id='mgPlayerJSProd_max-media-player' class='mgPlayerJSProd_media-player-btn'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-max-media-player'></wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-text-box'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-zoom-text'>100%</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class='mgPlayerJSProd_header-separator'> | </wmgPlayerJSProd_>
						<wmgPlayerJSProd_ class='mgPlayerJSProd_options-nav-page'>
							<wmgPlayerJSProd_ id="mgPlayerJSProd_media-player-pd" class='mgPlayerJSProd_media-player-btn'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-page-down-media-player'></wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ id="mgPlayerJSProd_media-player-pu" class='mgPlayerJSProd_media-player-btn mgPlayerJSProd_btn-rotate'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-page-up-media-player'></wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-text-box'>
								<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-page-cnt-text'>10</wmgPlayerJSProd_>
							</wmgPlayerJSProd_>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-page-cnt-text-total'>of 20</wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
					<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-header-title'></wmgPlayerJSProd_>
					<wmgPlayerJSProd_ class='mgPlayerJSProd_options-right'>
						<wmgPlayerJSProd_ id='mgPlayerJSProd_media-player-popout' class='mgPlayerJSProd_media-player-btn'>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-popout-media-player'> </wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
						<wmgPlayerJSProd_ id='mgPlayerJSProd_media-player-close' class='mgPlayerJSProd_media-player-btn'>
							<wmgPlayerJSProd_ class='mgPlayerJSProd_icon-close-media-player'> </wmgPlayerJSProd_>
						</wmgPlayerJSProd_>
					</wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
				<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-main mgPlayerJSProd_display-flex mgPlayerJSProd_display-inline-flex mgPlayerJSProd_align-items-center'>
					<wmgPlayerJSProd_ class='mgPlayerJSProd_media-player-wrapper-div' id='mgPlayerJSProd_pdf-container'>

						<wmgPlayerJSProd_ class="mgPlayerJSProd_pdf-image-spinner"><img alt="Pdf image spinner" /></wmgPlayerJSProd_>
						<canvas id="mgPlayerJSProd_pdf-canvas" class="mgPlayerJSProd_display-none"></canvas>


					</wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
				<wmgPlayerJSProd_ class="mgPlayerJSProd_options-floating">
					<wmgPlayerJSProd_ id="mgPlayerJSProd_media-player-print" class='mgPlayerJSProd_icon-print-media-player mgPlayerJSProd_floating-btn'></wmgPlayerJSProd_>
					<wmgPlayerJSProd_ id="mgPlayerJSProd_icon-pdf-download" class='mgPlayerJSProd_icon-pdf-download mgPlayerJSProd_floating-btn'></wmgPlayerJSProd_>
				</wmgPlayerJSProd_>
			</wmgPlayerJSProd_>
		</wmgPlayerJSProd_>

		<wmgPlayerJSProd_ class="mgPlayerJSProd_open-create-step-panel">
			<wmgPlayerJSProd_ class="mgPlayerJSProd_open-panel-btn">
				<wmgPlayerJSProd_ class="mgPlayerJSProd_open-panel-text"></wmgPlayerJSProd_>
				<wmgPlayerJSProd_ class="mgPlayerJSProd_open-panel-svg"></wmgPlayerJSProd_>
			</wmgPlayerJSProd_>
		</wmgPlayerJSProd_>
	</wmgPlayerJSProd_>`;
    return mainContainerHTML;
};

GmCXt.bootApplication = function() {

    GmCXt.log(33, "BOOT APP", 1);
    let lang = GmCXt.mgActiveLang;

    if (!GmCXt.mgActiveLang && GmCXt.browserLang) {
        lang = GmCXt.browserLang;
        GmCXt.mgActiveLang = lang;
    }

    GmCXt.initialiseDapStore();
    GmCXt.getAllLabels(lang);
    GmCXt.addOverlay();

    //LoginUsingAuthKey/SSO

    GmCXt.addPauseGuideHtml();
    GmCXt.addStopTestMePanel();

    let imgStepLoader = '';
    let editStepLoader = '';

    if (GmCXt.FT.creatorApp) {
        editStepLoader = "<wmgPlayerJSProd_ class='mgPlayerJSProd_edit-step-loader'>" +
			"<img src='" + GmCXt.loader() + "' /></wmgPlayerJSProd_>";
        imgStepLoader = "<wmgPlayerJSProd_ class='mgPlayerJSProd_image-step-loader'>" +
			"<img src='" + GmCXt.loader() + "' /></wmgPlayerJSProd_>";

        GmCXt.addStepToolbar();
    }
    mg$("html").append("<wmgPlayerJSProd_ class='mgPlayerJSProd_screen-blackout'></wmgPlayerJSProd_>");

    let html = GmCXt.getSidePanelIframe() +
		editStepLoader +
		imgStepLoader +
		"<wmgPlayerJSProd_ id='mgPlayerJSProd_toast-msg'></wmgPlayerJSProd_>";

    if (GmCXt.browserApp === 'ie') {
        mg$("body").append(html);
    } else {
        mg$("html").append(html);
    }

    mg$("#mgPlayerJSProd_micro_player_drag-svg").html(GmCXt.svgs.micro_drag);
    mg$("#mgPlayerJSProd_mplayer-close-svg").html(GmCXt.svgs.mplayer_close);
    mg$("#mgPlayerJSProd_close-lbl-svg").html(GmCXt.svgs.close);

    GmCXt.initialization.sidePanel = false;

    mg$(".mgPlayerJSProd_panel-close .mgPlayerJSProd_panel-close-btn-wrapper").click(function() {
        GmRootScope.closeAppPopup();
        GmCXt.closeAppPanel();
    });

    mg$(".mgPlayerJSProd_player-close-wrapper").click(function() {
        GmRootScope.closeAppPopup();
        GmCXt.closeAppPanel();
    });

    let newStyle = GmCXt.getCustomFontStyle();
    mg$("html:first").append(newStyle);

    // Guide Automation result popup should be visible even if user did a page refresh.
    // It should show until user clicked the Insights link in it or closed it.
    if (GmCXt.auto) {
        GmCXt.auto.getTestResultsFromStorage(function(response) {
            GmCXt.auto.showResults(response);
        });
    }
};

GmCXt.isSumtotalCalendarIframe = function(name) {
    if (GmCXt.isSumtotal() && name.toLowerCase().indexOf('calendar') !== -1) {
        return true;
    }
    return false;
};

GmCXt.isSabaSCORMIframe = function(name) {
    if (GmCXt.isSbx() && name.toLowerCase().indexOf('sco') !== -1) {
        return true;
    }
    return false;
};

GmCXt.isAllowedIframe = function(name) {
    let isAllowed = true;
    if (name.indexOf('guideme-iframe') !== -1 || GmCXt.isSumtotalCalendarIframe(name) || GmCXt.isSabaSCORMIframe(name)) {
        isAllowed = false;
    }
    return isAllowed;
};

GmCXt.showCookieDisabledPopup = function() {
    let m = {
        action: 'mgPlayerJSProd_action:to_background;task:show_cookie_disabled_popup'
    };
    GmCXt.sendMessageToBackgroundService(m);

    if (GmCXt.FT.isPlayer) {
        console.dir("Cookies are disabled in this browser. To use MyGuide, please enable cookies");
    }
};

GmCXt.setSession = function() {
    var mgInfo = sessionStorage.getItem('mgInfo');

    if (mgInfo) {
        GmCXt.sessionInfo = GmCXt.parseJSON(mgInfo);
    } else {

        var mgInfo = {
            session_id: GmCXt.getUUID()
        };

        //new session
        sessionStorage.setItem(
            'mgInfo', JSON.stringify(mgInfo)
        );
    }

    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:update_session_info", {
        sessionInfo: GmCXt.parseJSON(mgInfo)
    });
};

GmCXt.main = function() {

    if (!navigator.cookieEnabled) {
        GmCXt.showCookieDisabledPopup();
        return;
    }

    if ((GmCXt.isHumana() || GmCXt.isMcKesson()) && GmCXt.isSalesForcePopOutSide()) {
        return;
    }

    GmCXt.initDebugMode();

    GmCXt.isPageRefresh = GmCXt.convertType(localStorage.getItem('mg_pageRefreshEvent'));
    localStorage.setItem("mg_pageRefreshEvent", false);

    GmCXt.setSession();

    let m = {
        action: 'mgPlayerJSProd_action:to_background;task:disable_browser_action_popup'
    };
    GmCXt.sendMessageToBackgroundService(m, function() {});

    if (!GmCXt.isClientJs()) {
        GmCXt.storage().get(['login_state']).then(function(o) {
            if (o.login_state) {
                GmCXt.reportPresence();
            }
        });
    } else {
        GmCXt.reportPresence();
    }

    GmCXt.addListenersToDesktopApp();

    GmCXt.startMsgChannel('Guide:workerSelf');

    let lang = GmCXt.mgActiveLang;

    if (!GmCXt.mgActiveLang && GmCXt.browserLang) {
        lang = GmCXt.browserLang;
        GmCXt.mgActiveLang = lang;
    }

    GmCXt.getLanguageLabels(lang, true).then(function () {
        if (!GmCXt.isPlayer()) {
            GmCXt.getLanguageLabels(lang, false).then(function () {
                GmCXt.getAllLabels(lang);
                GmCXt.bootApplication();
            });
        } else {
            GmCXt.getAllLabels(lang);
            GmCXt.bootApplication();
        }
    });

    // Close side panel on Escape keypress
    mg$(document).on('keydown', function(e) {
        if (e.which === 27) GmCXt.closeAppPanel();
    });

    if (GmCXt.isLXP()) {
        let lxpBtn = mg$('[aria-label="MyGuide"]')[0];
        mg$(lxpBtn).off('click').on('click', function() {

            if (!GmCXt.APP_PANEL_OPEN) {
                GmCXt.trackerV1.trackPanelOpen('client');
            }
        });
    }

    GmCXt.readExternalVars();

    if (GmCXt.isExtension()) {
        if (GmCXt.browserApp === 'chrome') {
            chrome.runtime.onMessage.addListener(GmCXt.listenerBackgroud);
        } else if (GmCXt.browserApp === 'Safari') {
            safari.self.addEventListener("message", GmCXt.listenerBackgroud);
        } else {
            browser.runtime.onMessage.addListener(GmCXt.listenerBackgroud);
        }
    }
    if (GmCXt.conf.appConfig.desktopCommunication && (!GmCXt.desktopConnection || !GmCXt.desktopConnection.activeMsg)) {

        let m = {
            action: 'mgPlayerJSProd_action:content_script_init',

        };
        GmCXt.sendMessageToBackgroundService(m);
    }

};

GmCXt.readExternalVars = function() {

    if (GmCXt.FT.isPlayer) {
        if (window.guideMe) {

            GmCXt.client.tourId = window.guideMe.tourId;
            GmCXt.client.liveTourInvocation = window.guideMe.type;
            GmCXt.client.orgkey = window.guideMe.orgkey;

            GmCXt.conf.orgSecrret = GmCXt.client.orgkey;
            localStorage.setItem(GmCXt.storagePrefix + "orgkey", GmCXt.client.orgkey);

        } else {
            window.guideMe = {};
        }

        GmCXt.loginUsingAuthKey();
    }

    let tourId = GmCXt.getUrlParameter('guideMe-tourId');
    let automation = GmCXt.getUrlParameter('automation');

    if (tourId) {
        GmCXt.client.tourId = tourId;
        GmCXt.client.automation = automation === "true" ? true : false;
        GmCXt.client.isUrlTour = true;
    }
};

GmCXt.onClickGuideMeIcon = function(e) {
    e.stopPropagation();

    if (!GmCXt.initialization.sidePanel) return true;

    GmCXt.openAppPanel(null, 'widget');
};

GmCXt.onClickChatIcon = function(e) {
    e.stopPropagation();

    if (!GmCXt.initialization.sidePanel) return true;

    GmCXt.openAppPanel('chatbot', 'chatbotWidget');
};

GmCXt.getStartBtnClass = function() {

    // This class is only used to set position

    let n = "mgPlayerJSProd_start-button-creator";

    if (GmCXt.FT.isPlayer) {

        if (GmCXt.isExtension())
            n = "mgPlayerJSProd_start-button-playerxt";
        else
            n = "mgPlayerJSProd_start-button-clientJS";
    }

    return n;
};

/**
	* Check if user was playing live tour.
	* Play the last step again if user has selected 'Redirect to Live tour' option.
	* Play next step is user has clicked on the element (highlighted in inline step).
	*/

GmCXt.executeRequestPlayTour = function() {

    GmCXt.playerI = mg$.extend({}, GmCXt.playerI);

    if (GmCXt.playerI.testAutomation) {
        // Show the Guide Automation Progress bar
        GmCXt.auto.get(function(state) {
            if (!state) {
                GmCXt.cleanPlayer();
            } else {
                GmCXt.auto.showProgress();
            }
        });
    }

    if (GmCXt.playerI && GmCXt.playerI.tour &&
		GmCXt.playerI.tour.steps &&
		GmCXt.playerI.tour.steps.length > 0
    ) {

        let step = GmCXt.getStepFromPlayerI(GmCXt.playerI.currentStepId);
        if (!step) return;

        if (GmCXt.playerI.completeEventTracked && GmCXt.isLooping()) {
            GmCXt.requestHandler.playAutoTour();
            return;
        }

        let playMode = GmCXt.playerI.mode;

        GmCXt.log(33, "Page reloaded. Guide started.");

        if (GmCXt.playerI.guideState === 'pause' &&
			GmCXt.playerI.pausedOn === GmCXt.urlParts.host + GmCXt.urlParts.pathname &&
			playMode !== 'slideshow'
        ) {
            GmCXt.playTour();
            return;
        }

        let settings = step.step_settings;

        let inlineStepCheck = step.step_type === GmCXt.STEP_TYPE_INLINE;
        let isAutomationStep = GmCXt.isAutomationStep(step);
        let messageStepCheck = (step.step_type === GmCXt.STEP_TYPE_MESSAGE && !settings.keepNext);
        let transportStepCheck = step.step_type === GmCXt.STEP_TYPE_TRANSPORT;

        // If request is not coming from "redirect to live step" option,
        // and last step is played successfully
        // then increment stepIndex

        if (GmCXt.playerI.lastAction !== "redirection" &&
			(inlineStepCheck || messageStepCheck || isAutomationStep || transportStepCheck) &&
			GmCXt.playerI.lastPlayedStepId === GmCXt.playerI.currentStepId) {

            GmCXt.playerI.currentStepId = GmCXt.getTail(GmCXt.playerI.currentStepId, GmCXt.playerI.playStructure);

            step = GmCXt.getStepFromPlayerI(GmCXt.playerI.currentStepId);
            if (!step) {
                GmCXt.log(33, "Step not Found in Tour. Halt Guide Play.", GmCXt.playerI);
                if (transportStepCheck) {
                    GmCXt.playerI.currentStepId = GmCXt.playerI.lastPlayedStepId;
                    GmCXt.tourPlayerI = GmCXt.tourPlayer();
                    GmCXt.tourPlayerI.closeGuide();
                }
                GmCXt.cleanPlayer();
                return;
            }

            GmCXt.log(33, "Page reloaded. Pointer incremented to next step.");
        }

        if (step.step_type === "guide") {

            let d = {
                tour_id: step.step_settings.tour_id
            };

            GmCXt.getGuideFirstStep(d)
                .then(function(s) {
                    GmCXt.executeNextStep();
                });

        } else {
            GmCXt.executeNextStep();
        }
    }
};

GmCXt.getGuideFirstStep = function(d) {
    return new Promise(function(resolve, reject) {
        GmCXt.getTourDetails(d)
            .then(function(tour) {
                let s = {};
                if (tour) s = tour.steps[0];
                resolve(s);
            });
    });
};

GmCXt.executeNextStep = function() {
    function proceed() {
        GmCXt.playerI.onPageLoad = true;
        GmCXt.playTour();
    }

    GmCXt.playerI.lastAction = null;

    if (GmCXt.playerI.currentStepId) {
        let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);

        if (step.step_type === GmCXt.STEP_TYPE_GUIDE) {
            proceed();
        } else {
            GmCXt.checkProceedToPlay(step, GmCXt.playerI.tour).then(function(y) {
                if (y && GmCXt.playerI) {
                    proceed();
                }
            });
        }

    } else {
        GmCXt.cleanPlayer();
    }
};

GmCXt.gEvent = {};

GmCXt.triggerChangeListeners = function(eType) {

    if(!GmCXt.user) {return;}

    if (GmCXt.currentUrl !== GmCXt._location().href) {
        GmCXt.currentUrl = GmCXt._location().href;
        GmCXt.saveCurrentURL();
        eType = 'url';
    }

    if (GmCXt.pageTitle !== GmCXt.getDocTitle()) {
        GmCXt.setPageTitle();
        eType = 'page_title';
    }

    if (eType === 'url' || eType === 'page_title' || eType === 'page_click') {
        GmCXt.gEvent.type = eType;
        GmCXt.gEvent.time = Date.now();
        GmCXt.clearAllRuleJobs();
    }

    // Process page_title and url change events after 0.5 sec of occurrence
    if ((GmCXt.gEvent.type === 'url' || GmCXt.gEvent.type === 'page_title') && (Date.now() - GmCXt.gEvent.time > 500)) {
        GmCXt.changeEvent(GmCXt.gEvent.type);
        GmCXt.gEvent = {};

    } else if (GmCXt.gEvent.type === 'page_click' && (Date.now() - GmCXt.gEvent.time > 1500)) { // Process page_click event after 1.5 sec of occurrence
        GmCXt.changeEvent(GmCXt.gEvent.type);
        GmCXt.gEvent = {};
    }
};

GmCXt.clearAllRuleJobs = function() {
    GmCXt.ruleEngine.clearJobs();
    if (!(GmCXt.isHumana() && GmCXt.checkSalesForceSite())) {
        GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:clear_rule_jobs', {
            trigger: GmCXt.gEvent.type
        });
    }
    GmCXt.ruleEngine.clearJobs();
};

GmCXt.changeEvent = function(type) {

    if (GmCXt.isExcludeDomain()) return;

    GmCXt.log(1, "CHANGE EVENT: " + type);

    // To track events and for player sync
    if (GmCXt.user) {
        if (GmCXt.isClientJs()) {
            GmCXt.processLastActionTime();

        } else {
            let m = {
                action: "mgPlayerJSProd_action:record_user_activity",
                data: {
                    organization: GmCXt.organization,
                    user: GmCXt.user
                }
            };
            GmCXt.sendMessageToBackgroundService(m);
        }
    }

    GmCXt.validatedSegments = {};

    if (type === 'url' || type === 'page_title') {
        GmCXt.onContextChange(type);
    } else {
        GmCXt.onPageClicked();
    }
};

GmCXt.filterGuidesByRuleType = function(type) {
    let id, rules, found;
    let idList = [];

    let toursOnScreen = GmCXt.partialVisibleTooltipsIds.concat(GmCXt.onScreenTooltipGuideIds);

    for (let i = 0; i < toursOnScreen.length; i++) {
        id = toursOnScreen[i];
        rules = GmCXt.onScreenTooltipGuideInfo['tour_' + id].rules;
        found = false;
        if (type === 'url') {
            found = rules.some(function(r) {
                return ["URL Path", "URL", "URL Hostname", "URL Parameters", "URL Hash"].indexOf(r) >= 0;
            });
        } else if (type === 'page_title') {
            found = rules.indexOf("Page Title") >= 0;
        }

        //Return toolip guides which should be removed when rules become invalid
        if (found && GmCXt.onScreenTooltipGuideInfo['tour_' + id].watchRules) {
            idList.push(id);
        }
    }
    return idList;
};

GmCXt.onContextChange = function(eventType) {
    GmCXt.pageTours = {};
    GmCXt.clearBeaconsAndTooltips(false, GmCXt.filterGuidesByRuleType(eventType));
    GmCXt.rulesIframeQueue = [];
    GmCXt.showWidget();
    GmCXt.storage().get(['mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY', 'testMe', 'guide_play_event'])
        .then(function(st) {

            let pi = st.mgPlayerJSProd_mgPlayerJSProd_GM_PLAYER_STORAGE_KEY;

            if (pi && pi.testAutomation) {
                GmCXt.guidePlayTracker = st.guide_play_event || {};
            }

            // Neglect change event

            if (GmCXt.isTestMeOn(st.testMe)) {
                return true;
            } else if (!GmCXt.isPlayer()) {
                return true;
            }
            GmCXt.getContextGuides(eventType);
        });
};


GmCXt.removeInvalidSegmentSmartipAndBeacon = function(tList, tListType) {
    if (tList.length) {
        for (let b = 0; b < tList.length; b++) {
            let segmentGrp = tList[b].tour_settings.segment_groups;
            if (!GmCXt.isEmpty(segmentGrp)) {
                for (let sg = 0; sg < segmentGrp.length; sg++) {
                    let seg = GmCXt.getSegmentById(segmentGrp[sg]);
                    if (seg && seg.rule_check) {
                        if (tListType === "beacon") {
                            GmCXt.removeBeaconElement(tList[b]);
                            var tindx = GmCXt.beaconsOnScreen.indexOf(parseInt(tList[b].tour_id));
                            if (tindx !== -1) {
                                GmCXt.beaconsOnScreen.splice(tindx, 1);
                            }
                        } else if (tListType === "smarttip") {
                            var tindx = GmCXt.onScreenTooltipGuideIds.indexOf(tList[b].tour_id);
                            if (tindx !== -1) {
                                GmCXt.onScreenTooltipGuideIds.splice(tindx, 1);
                            }
                            GmCXt.removeTooltips(tList[b]);
                        }
                        break;
                    }
                }
            }
        }
    }
};

GmCXt.neglectChangeEvent = function() {
    if (GmCXt.isAutomationRunning()) {
        return false;
    }
    if(!GmCXt.user){
        return true;
    }else if (GmCXt.playerI && !GmCXt.showTooltipsDuringWorkflowGuide()) {
        return true;
    } else if (GmCXt.isTestMeOn(GmCXt.testMe)) {
        return true;
    } else if (!GmCXt.isPlayer()) {
        return true;
    } else {
        return false;
    }
};

GmCXt.onPageClicked = function() {

    if (GmCXt.neglectChangeEvent()) return;

    GmCXt.rulesIframeQueue = [];
    GmCXt.setPageTitle();

    if (!GmCXt.checkPrecedence()) {
        return;
    }

    if (GmCXt.user) {
        GmCXt.trackerV1.trackUserPulse();
    }

    let gotTours = function(tours) {

        if (GmCXt.isPlayer() && !GmCXt.isEmpty(tours)) tours = GmCXt.filterScheduleTours(tours);

        GmCXt.pageTours = tours;

        // Process beacon tours
        let beaconTours = tours ? GmCXt.filterBeaconGuides(tours) : mg$.extend([], GmCXt.beaconTours);

        // Process tooltip tours
        let tooltipTours = tours ? GmCXt.filterSmartTipGuides(tours) : mg$.extend([], GmCXt.tooltipTours);

        // Handle segment validation if efficient rule mode is enabled
        if (GmCXt.organization.admin_settings.efficient_rule_mode) {
            if (beaconTours.length) {
                GmCXt.removeInvalidSegmentSmartipAndBeacon(beaconTours, "beacon");
            }

            if (tooltipTours.length) {
                GmCXt.removeInvalidSegmentSmartipAndBeacon(tooltipTours, "smarttip");
            }
        }

        // Render beacons and smart tips
        if (beaconTours.length) {
            GmCXt.renderBeacons(beaconTours, false, true);
        }

        if (tooltipTours.length) {
            GmCXt.renderSmartTips(tooltipTours, false, true);
        }

        // Process notifications and feature tracking
        if (tours) {
            GmCXt.notificationGuides = mg$.extend([], GmCXt.filterNotifications(tours));

            if (GmCXt.trackerUtil.featureTracking) {
                GmCXt.validateFtGuideRules(GmCXt.filterFtTags(tours));
            }
        }

        // Show notifications if allowed
        let canShowNotifications = !GmCXt.stopNotification(false) || GmCXt.isAutomationRunning();
        if (canShowNotifications && GmCXt.notificationGuides && GmCXt.notificationGuides.length) {
            GmCXt.removeNotif();
            GmCXt.showNotifications();
        }
    };

    if (GmCXt.inPlayer) {
        if (GmCXt.isEmpty(GmCXt.pageTours)) {
            let options = {
                url: GmCXt.getUrl(),
                organization_id: GmCXt.organization.organization_id
            };
            GmCXt.getContextualTourData(options).then(gotTours);
        } else {
            gotTours(GmCXt.pageTours);
        }

    } else {
        gotTours(GmCXt.pageTours);
    }

    let gc = GmCXt.getAppSetting('guide_count_on_widget');
    let hw = GmCXt.getAppSetting('hide_widget_if_noguide');
    if ((gc && !GmCXt.isWestpac()) || hw || GmCXt.APP_PANEL_OPEN) {
        GmRootScope.refreshCurrentPage('page_click');
        GmRootScope.refreshTaskList();
    }
};

window.getMyGuides = async function(url) {
    let tours = [];
    let urlTours = GmRootScope.publishedTours.filter((tour) => tour.tour_url.includes(GmCXt.filterUrlScheme(url)));
    let rulesTours = GmRootScope.validateAllRulesExceptSelectEl(GmRootScope.publishedTours, false, url).tours;

    tours = GmCXt.removeDuplicates(urlTours.concat(rulesTours));
    tours = tours.map((tour) => ({
        id: tour.tour_id,
        title: tour.tour_title,
        description: tour.tour_description
    }));

    return tours;
};

window.playMyGuide = function(id) {
    GmCXt.getTourDetails({
        'tour_id': id
    }).then(function(tour) {
        if (tour.steps.length) {
            GmCXt.playLiveTour(tour, tour.steps[0].step_id, 'companion', null, 'slideshow', null, 'slideshow');
        }
    });
};

GmCXt.getTourAndPlay = function(tourId, initiator, origin) {
    GmCXt.log(33, "Fetching tour for Guide Play");
    let d = {
        tour_id: tourId
    };

    GmCXt.getTourDetails(d).then(function(tour) {
        GmCXt.log(33, "Tour response received for Guide Play", tour);
        if (tour && tour.is_published) {
            GmCXt.playLiveTour(tour, 0, initiator, false, false, origin);
        }
    });
};

GmCXt.getTourDetailsCallback = function(tour, domains, initiator, type) {
    if (tour && domains) {
        tour.allDomains = domains;
    }
    GmCXt.playLiveTour(tour, 0, initiator, undefined, type);
};

GmCXt.invokeLiveTour = function() {
    if (GmCXt.playerI) {
        if (GmCXt._location().href && GmCXt._location().href.indexOf("chrome/newtab") === -1) {
            GmCXt.executeRequestPlayTour();
        }
    }
};

GmCXt.playLiveTour = function(tour, currentStepId, initiator, isAutolaunch, type, origin, mode) {

    mode = mode ? mode : "live";

    if (isAutolaunch) GmCXt.isPageReloaded = true;

    if (GmCXt.FT.isPlayer && tour.tour_settings.slideshow_mode) {
        mode = "slideshow";
        type = "slideshow";
    }

    let isAutomation = GmCXt.getUrlParameter('automation');
    if (initiator === 'doitforme') {
        isAutomation = true;
    }

    let testAutomation = false;
    if (initiator === 'automation') {
        testAutomation = true;
    }

    if (initiator === 'beaconTour' || initiator === 'overlayTourPopup') {

        let ts = tour.tour_settings;
        mode = ts.defaultPlayAction;

        if (mode === 'Default') {
            mode = GmCXt.getAppSetting('defaultPlayAction');
        }

        if (mode === 'doitforme') {
            isAutomation = true;
        } else if (mode === 'slideshow') {
            type = 'slideshow';
            ts.play_structure = GmCXt.getGuidePlayStructure(tour);
            currentStepId = ts.play_structure[0].id;
        }
    }

    GmCXt.playerI = {
        type: type || 'slideshow',
        tour: tour,
        mode: mode,
        currentStepId: currentStepId,
        initiator: initiator,
        isAutomation: isAutomation,
        isAutolaunch: isAutolaunch,
        testAutomation: testAutomation,
        previousTourType: tour.previousTourType,
        origin: origin || initiator
    };
    GmCXt.playTour();
};

GmCXt.onDocumentMouseDown = function() {

    GmCXt.resetIdleActivityTimer();

    if (GmCXt.playerI && GmCXt.playerI.completeEventTracked) GmCXt.saveSurveyTrigger();

    GmCXt.clickTime = new Date().getTime();

    if (GmCXt.testMe || GmCXt.testMe === null) {
        GmCXt.storage().set({
            'testMe': GmCXt.testMe
        });
    }
};

GmCXt.saveSurveyTrigger = function() {

    if (GmCXt.playerI && GmCXt.tourPlayerI) {

        let ts = GmCXt.playerI.tour.tour_settings;
        let currentStepId = GmCXt.playerI.currentStepId;
        let playStructure = GmCXt.playerI.playStructure;
        let tour = GmCXt.playerI.tour;

        if (GmCXt.isLastStep(currentStepId, playStructure) && GmCXt.playerI.initiator !== 'doitforme') {
            if (tour.is_published && ts.enableSentiment == true) {
                GmCXt.storage().set({
                    'SHOW_SURVEY': {
                        tourId: tour.tour_id,
                        version: tour.version
                    }
                });
            }
        }
    }
};

GmCXt.onWinUnload = function() {
    // In clientJS, all the below storage calls fails,
    // since they are async. So for clientJS only, there is document
    // mousedown event to make storage calls.

    GmCXt.log(1, "Window unload event");

    if (GmCXt.FT.creatorApp && mediaRecorder) {
        mediaRecorder.stop();
        GmCXt.storage().set({
            'screen_recorder_close': true
        });
    }

    if (GmCXt.testMe || GmCXt.testMe === null) {
        GmCXt.storage().set({
            'testMe': GmCXt.testMe
        });
    }

    if (GmCXt.stepReq || GmCXt.stepReq === null) {
        GmCXt.stepReq.appId = GmCXt.activeAppId;
        GmCXt.storage().set({
            'stepReq': GmCXt.stepReq
        });
    }

    let pi = GmCXt.playerI;

    if (pi) {
        if (pi.completeEventTracked) GmCXt.saveSurveyTrigger();

        if (pi.guideState === 'pause') {
            GmCXt.setResumeWinDisplayed(false);
        }

        if (GmCXt.isLastStep(pi.lastPlayedStepId, pi.playStructure) && !GmCXt.isLooping()) {
            GmCXt.cleanPlayerI();
        }
    }

    localStorage.setItem(GmCXt.storagePrefix + "pageRefreshEvent", false);

    if (GmCXt.tourActivity) {
        GmCXt.storage().set({
            'tourActivity': GmCXt.tourActivity
        });
    }

    let currentTime = GmCXt.getCurrentTimeInMilSec();

    let pageRefreshed = false;

    if (!GmCXt.clickTime) {
        pageRefreshed = true;
    } else if (currentTime - GmCXt.clickTime > 1000) {
        pageRefreshed = true;
    }

    let mgInfo = GmCXt.parseJSON(sessionStorage.getItem('mgInfo'));

    mgInfo.pageRefreshed = pageRefreshed;
    mgInfo.lastUrl = GmCXt.urlParts.fullUrl;

    sessionStorage.setItem('mgInfo', JSON.stringify(mgInfo));

    localStorage.setItem("mg_pageRefreshEvent", pageRefreshed);

    if (!GmCXt.isEmpty(GmCXt.pageVisit)) {
        GmCXt.pageVisit.timeSpent = new Date().getTime() - GmCXt.pageVisit.timeStarted;
        GmCXt.pageVisit.url = GmCXt.urlParts.fullUrl;
        GmCXt.storage().set({
            'pageVisitData': JSON.stringify(GmCXt.pageVisit)
        });
    }
};

GmCXt.showKeyCodePopUp = function() {
    let ok = GmCXt.label.ok;

    if (!GmCXt.keyInputGuides || !GmCXt.keyInputGuides.length) {
        return;
    }

    mg$("html").append(GmCXt.getKeyShortPopupHtml(GmCXt.keyInputGuides, ok));

    function onOK(e) {
        GmCXt.unlockScroll();
        GmCXt.closePopup();
    }

    GmCXt.addPopupEvents(onOK);
};

GmCXt.startIdleActivityTimer = function() {
    GmCXt.idleTime = 0;
    clearInterval(GmCXt.idleActivityInterval);
    GmCXt.idleActivityInterval = GmCXt.timeout(GmCXt.checkIdleActivityTime, GmCXt.t_.min1); //check after 1 min
};

GmCXt.resetIdleActivityTimer = function() {
    //Reset idle activity timer
    GmCXt.startIdleActivityTimer();
};

GmCXt.checkIdleActivityTime = function() {
    GmCXt.log(1, "Event: User has been idle for more than 1 minute.");
    GmCXt.triggerFeatureTagEvents();
    clearInterval(GmCXt.idleActivityInterval);
    GmCXt.startIdleActivityTimer();
};

GmCXt.sendFeatureTagsClickTrackingEvent = function(featureTags) {
    // Clean up sequence by removing 'tour_id'
    const cleanFeatureTags = featureTags.map(paylod => ({
        ...paylod,
        miscellaneous: {
            ...paylod.miscellaneous,
            sequence: paylod.miscellaneous.sequence.map(({
                tour_id,
                ...rest
            }) => rest)
        }
    }));

    GmCXt.trackerV1.trackFeatureClick(cleanFeatureTags);
};

GmCXt.validateFeatureSeqData = function(data) {
    if (!data || !Array.isArray(data) || data.length === 0) return false;

    // Count total number of tags objects
    const totalTagsObjects = data.reduce((total, payload) => {
        const sequence = payload.miscellaneous?.sequence || [];
        return total + sequence.length;
    }, 0);

    return  totalTagsObjects > 2;
};

GmCXt.triggerFeatureTagEvents = function() {
    GmCXt.storage().get(['insightFeatureTagData']).then(function(st) {
        if (GmCXt.isPlayer() && !GmCXt.isEmpty(st) && !GmCXt.isEmpty(st.insightFeatureTagData)) {
            const featureTags = GmCXt.parseJSON(st.insightFeatureTagData);
            GmCXt.log(16, "Feature tag records is found in storage.",featureTags);

            if (!GmCXt.isEmpty(featureTags)) {
                if (GmCXt.validateFeatureSeqData(featureTags)) {
                    GmCXt.trackerV1.trackFeatureSeqPayload(featureTags);
                }

                const filteredFeatureTags = featureTags
                    .filter(fTag => fTag.is_tracking_enabled === 1)
                    .map(({ is_tracking_enabled, ...rest }) => rest);


                if (!GmCXt.isEmpty(filteredFeatureTags)) {
                    GmCXt.sendFeatureTagsClickTrackingEvent(filteredFeatureTags);
                }

                // Remove storage data after processing all items
                GmCXt.storage().remove(['insightFeatureTagData']);
            }
        }
    });
};

GmCXt.onVisibilityChange = function() {

    if (!GmCXt.visits) GmCXt.visits = 0;

    GmCXt.visits++;

    if (GmCXt.visits % 2) { //blur

        GmCXt.log(1, "Event: page visibility blur");

    } else { //focus

        GmCXt.log(1, "Event: page visibility focus");

        if (GmCXt.pageVisit) GmCXt.pageVisit.timeFocused = new Date().getTime();
    }
};

GmCXt.getCurrentURL = function() {
    let url = GmCXt.getUrl();
    return {
        url: url,
        urlParts: GmCXt.urlParts,
        fullUrl: GmCXt._location().href,
        title: GmCXt.getDocTitle(),
        elAppName: GmCXt.isElectron() ? GmCXt.getElectronAppName() : ''
    };
};

GmCXt.syncCurrentURL = function() {

    GmCXt.urlParts.fullUrl = GmCXt.getCurrentURL().fullUrl;

    var domainInApp = GmCXt.isDomainInActiveApp();

    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:domain_in_active_app', {
        domainInApp: domainInApp
    });
};

GmCXt.saveCurrentURL = function() {
    let parser = document.createElement('a');
    parser.href = GmCXt._location();

    GmCXt.urlParts = {};

    let host = parser.host;

    // Remove port number from host name, In IE port number coming with host
    if (host && host.indexOf(':') !== -1) {
        host = host.split(':')[0];
    }
    GmCXt.urlParts.host = host;

    GmCXt.urlParts.pathname = parser.pathname;
    GmCXt.urlParts.search = parser.search;
    GmCXt.urlParts.href = GmCXt.filterUrlScheme(parser.href);
    GmCXt.urlParts.fullUrl = parser.href;
    GmCXt.urlParts.hash = parser.hash;
    GmCXt.urlParts.scheme = GmCXt.getUrlScheme();
    GmCXt.urlParts.port = parser.port;
    GmCXt.elAppName = GmCXt.isElectron() ? GmCXt.getElectronAppName() : '';

    GmCXt.syncCurrentURL();
};

GmCXt.setPageTitle = function() {
    GmCXt.pageTitle = GmCXt.getDocTitle();
};

GmCXt.requestHandler.hideSmarttipDelay = function(data, options) {
    if (data) {
        if (window.self === window.top) {
            GmCXt.hideTooltipTimeout = GmCXt.timeout(function() {
                GmCXt.requestHandler.hideSmartTip(data, options);
            }, 200);
        } else {
            let m = {
                action: 'mgPlayerJSProd_action:hide_smarttip_delay',
                stepId: data.step_id
            };
            GmCXt.sendToParentWindow(m);
        }
    }
};

GmCXt.requestHandler.hideSmartTip = function(msg, options) {
    if (options && (options.type == 'disableElement')) {
        mg$('#mgPlayerJSProd_smarttip-' + msg.stepId + '-alert').hide();
    } else {
        mg$('#mgPlayerJSProd_smarttip-' + msg.stepId).hide();
        mg$('.mgPlayerJSProd_smarttip-icon-wrapper-' + msg.stepId).hide();
    }
};

GmCXt.requestHandler.hideValidationSmarttip = function(message) {
    mg$(".mgPlayerJSProd_smarttip-valid-" + message.stepId).hide();
};

GmCXt.getManifest = function() {

    if (GmCXt.browserApp === 'chrome') {
        var manifest = chrome.runtime.getManifest();
    } else {
        var manifest = browser.runtime.getManifest();
    }
};

GmCXt.playStepFromDesktop = function(msg) {

    let tour = {
        steps: [msg.step]
    };

    tour = GmCXt.validateDataModel(tour, GmCXt.model.guide);

    tour.tour_settings.play_structure = msg.step.playStructure;

    let data = {
        tour: tour,
        source: GmCXt.sourceDesktop,
        automate: false,
        isHybrid: msg.isHybrid,
        currentStepId: msg.step.currentStepId,
        isFirstStep: msg.isFirstStep,
        isLastStep: msg.isLastStep,
        playType: msg.type,
        requestId: msg.requestId
    };

    if (msg.mode === 'doitforme') {
        data.automate = true;
        data.initiator = 'doitforme';
    }

    GmCXt.requestHandler.playGuide(data);
};

GmCXt.sendMessageToDesktop = function(msg) {
    var m = {
        action: "mgPlayerJSProd_action:send_message_desktop_socket_server",
        data: msg
    };
    GmCXt.sendMessageToBackgroundService(m);

};
GmCXt.applyOverlayMessageStep = function(highLightEl) {
    let ha = [];
    for (let i in GmCXt.highlight_elements) {
        ha.push(GmCXt.highlight_elements[i][0]);
    }

    let options = {
        data: ha,
        containerOffset: GmCXt.getContainerOffSet(false),
        stepType: GmCXt.STEP_TYPE_INLINE,
        overlay: true,
    };

    GmCXt.screenOverlayI = GmCXt.screenOverlay(options);
    GmCXt.screenOverlayI.start();
};

GmCXt.getLXPLang = function() {
    if(GmCXt.isLXP()){
    	let lxpLang = window.localStorage.selectedLanguage;
    	return GmCXt.getProcessedLang(lxpLang);
    } else {
        return false;
    }
};

/**
	* This function sets language of the content script and then propagates to side panel and step creator frames.
	* Useful when laguage is read from host site e.g. LXP or read from browser preference.
	*/
GmCXt.setLangFromCS = function(lang) {
    GmCXt.mgActiveLang = lang;

    function setLangFromCSCb() {
        GmCXt.getAllLabels(lang);

    	GmRootScope.updateAppLang(lang);
    }

    GmCXt.getLanguageLabels(GmCXt.mgActiveLang, true).then(function () {
        if (!GmCXt.isPlayer()) {
            GmCXt.getLanguageLabels(GmCXt.mgActiveLang, false).then(function () {
                setLangFromCSCb();
            });
        } else {
            setLangFromCSCb();
        }
    });
};

/**
	* This function sets user preference language selected in the side panel.
	* Propagates change to step creator frame
	*/
GmCXt.setLangPref = async function(lang) {
    GmCXt.mgActiveLang = lang;

    function setLangPrefCb() {
        GmCXt.getAllLabels(lang);
        mg$('#mgPlayerJSProd_panel-close .mgPlayerJSProd_close-lbl').text(GmCXt.label.close);
    }

    return GmCXt.getLanguageLabels(GmCXt.mgActiveLang, true).then(function () {
        if (!GmCXt.isPlayer()) {
            GmCXt.getLanguageLabels(GmCXt.mgActiveLang, false).then(function () {
                setLangPrefCb();
            });
        } else {
            setLangPrefCb();
        }
    });
};

GmCXt.playAudioTrack = function(message) {
    GmCXt.isPageReloaded = false;
    if (GmCXt.FT.audio) {
        GmCXt.playStepAudio(message);
    }
};

GmCXt.filterPrivateTours = function(tours) {

    let arr = [];

    tours.forEach(function(tour) {

        if (tour.is_private)
            arr.push(tour);
    });

    return arr;
};

GmCXt.hidePanelCloseBtn = function() {
    mg$('.mgPlayerJSProd_panel-close').hide();
};

GmCXt.showPanelCloseBtn = function() {
    mg$('.mgPlayerJSProd_panel-close').show();
};

GmCXt.isExitSurvey = function() {
    let flag = false;
    let os = GmCXt.getOrgSettings();

    if (os && os.exitSurvey) flag = true;
    if (os && os.exitSentiment) flag = true;

    return flag;
};

GmCXt.widgetIconCustomize = function() {
    let s = GmCXt.getWidgetSettings();
    if (!s || GmCXt.isEmpty(s)) return;

    let widget = GmCXt.getWidgetInstance();
    widget.css({
        'z-index': ((s.widget_icon_zindex !== ('Default' || 'default')) ? s.widget_icon_zindex : GmCXt.defaultWidgetZindex)
    });

    switch (s.widgetIconType) {
    case 'circular':
        widget.css({
            width: s.widgetIconSize.widgetIconWidth,
            height: s.widgetIconSize.widgetIconWidth,
            borderRadius: '50%'
        });
        widget.find('.mgPlayerJSProd_custom-image').css('border-radius', '50%');
        break;

    case 'rectangular':
        widget.css({
            width: s.widgetIconSize.widgetIconWidth,
            height: s.widgetIconSize.widgetIconHeight,
        });
        break;
    }
};

GmCXt.chatIconCustomize = function() {
    let s = GmCXt.getAppSetting();

    if (!s || GmCXt.isEmpty(s)) return;

    let chat = GmCXt.getChatIconInstance();

    if (chat) {
        switch (s.chatIconType) {
        case 'circular':
            chat.css({
                width: s.chatIconSize ? s.chatIconSize.chatIconWidth : 50,
                height: s.chatIconSize ? s.chatIconSize.chatIconWidth : 50,
                borderRadius: '50%'
            });
            chat.find('.mgPlayerJSProd_custom-image').css('border-radius', '50%');
            break;

        case 'rectangular':
            chat.css({
                width: s.chatIconSize ? s.chatIconSize.chatIconWidth : 50,
                height: s.chatIconSize ? s.chatIconSize.chatIconHeight : 50,
            });
            break;
        }
    }
};

GmCXt.updateAccessibility = function(val) {
    if (GmCXt.isDefined(val)) {
        GmCXt.accessibility = val;
    } else {
        GmCXt.accessibility = false;
    }
};

GmCXt.removeSmarttipAndBeaconIcon = function(tourId) {
    let elements = document.getElementsByClassName('mgPlayerJSProd_smarttip-tour-' + tourId);

    if (!elements.length) {
        elements = document.getElementsByClassName('mgPlayerJSProd_beacon-icon-tour-' + tourId);
    }

    while(elements.length > 0) {
        elements[0].remove();
    }
};

GmCXt.handleCloseApp  = function(reset_panel_right) {
    GmCXt.closeAppPanel();
    mg$('.mgPlayerJSProd_panel').css({
        'width': '500px'
    });

    if (window.matchMedia("(max-width: 480px)").matches && !GmCXt.isMiniPlayer) {
        mg$('.mgPlayerJSProd_panel').css({
            'width': '85%'
        });
    }

    if (reset_panel_right) {
        GmCXt.resetSidePanelRight();
    }
};

GmCXt.getContextualTourData = function(data) {
    return new Promise((resolve, reject) => {
        // Define helper functions at the beginning
        function filterContextualTours(tours) {
            // Using direct filter with return instead of pushing to array
            return tours.filter(t =>
                t.tour_type.indexOf('beacon_tour') > -1 ||
							t.tour_type.indexOf('overlay_tour') > -1 ||
							t.tour_type.indexOf('smartTip') > -1 ||
							t.tour_type.indexOf('insights') > -1
            );
        }

        function determineLanguage() {
            return GmCXt.getLXPLang() ?
                GmCXt.getLXPLang() :
                (GmRootScope.language && GmRootScope.language.indexOf('en-') === -1 && !GmCXt.isFalse(GmRootScope.language) ?
                    GmRootScope.language :
                    data.language);
        }

        function fetchContextualTours() {
            // Set language once using a helper function
            data.language = determineLanguage();

            const callback = function(response) {
                const filteredTours = GmRootScope.processContextualGuide(response, data.url);
                resolve(filterContextualTours(filteredTours));
            };

            // Simplified conditional
            let apiMethod = (GmCXt.onPrem() && !GmCXt.isEmpty(GmCXt.user)) ?
                GmCXt.api.getContextualTourStorage :
                GmCXt.api.getContextualTour;

            apiMethod(data, callback);
        }

        // Main execution flow starts here
        const cachedTours = GmRootScope.readLocalCT(data.url, data.title);

        if (cachedTours && cachedTours.length) {
            GmCXt.log(10, "FETCHING tours from CACHE");
            const filteredTours = filterContextualTours(cachedTours);
            return resolve(filteredTours); // Added return to prevent unnecessary execution
        }

        fetchContextualTours();
    }).catch(error => {
        console.error("Error fetching contextual tour data:", error);
        reject(error);
    });
};

GmCXt.playSurvey = function(r){
    mg$(window).focus();
    GmCXt.isSurveyVisible = true;
    GmCXt.surveyStart(r);
};

GmCXt.getSurveyDetailsAndPlay = function(data) {
    GmCXt.apiGetSentiment({
        app_code: GmCXt.appList["app:" + GmCXt.activeAppId].external_id,
        sentiment_code: data.sentiment_code,
        user: GmCXt.user,
    }).then(function(r) {
        r.tourId = data.tourId;
        r.type = "tooltip";
        r.stepId = data.stepId;
        GmCXt.playSurvey(r);
    });
};

GmCXt.getSurveyDetails = function(data) {
    return new Promise(function(resolve, reject) {
        let obj = {};
        obj.sentiment_code = data.sentiment.sentimentCode;
        obj.user = GmCXt.user;
        if (data.isExit) {
            obj.app_code = '';
        } else {
            obj.app_code = GmCXt.appList['app:' + GmCXt.activeAppId].external_id;
        }
        GmCXt.apiGetSentiment(obj)
            .then(resolve)
            .catch(function(result) {
                reject(false);
            });
    });
};

GmCXt.signInWithOrgKeyFailed = function(d){
    if (d.paramsData) {
        d.params = d.paramsData;
        d.method_type = d.method;
        d.errMessage = d.message;
        GmRootScope.triggerError(message.data);
    }
    GmRootScope.myGuideOrgKey = '';
    GmRootScope.clearSession();
    GmRootScope.signInWithSso(true);
};

GmCXt.resetSidePanelRight = function() {
	 mg$('.mgPlayerJSProd_ege-panel').css({
        'right': 'initial'
    });
};

GmCXt.closePowerForm = function() {
    if (mg$(".mgPlayerJSProd_form-injector-wrapper").length > 0) {
        GmCXt.closePowerFormSp();
    }
};

GmCXt.clearDataOnLogout = function(d) {

    GmCXt.beaconTours = [];
    GmCXt.beaconsOnScreen = [];

    GmCXt.urlBasedTours = [];

    GmCXt.tooltipTours = [];
    GmCXt.fTags = [];
    GmCXt.onScreenTooltipGuideInfo = {};
    GmCXt.onScreenTooltipGuideIds = [];
    GmCXt.partialVisibleTooltipsIds = [];

    GmCXt.closeNotificationPopupSidePanel();

    GmCXt.trackerV1.trackPageVisit();

    if (GmCXt.creatorInterval) {
        clearInterval(GmCXt.creatorInterval);
    }
    //Triggering login without delay
    if (d.instantReLogin) {
        GmCXt.loginUsingAuthKey();
    }

    // If player and user was logged in before
    if (GmCXt.inPlayer && d.startInterval) {
        GmCXt.startReloginInterval();
    }

    if (GmCXt.isClientJs()) {
        GmCXt.trackerV1.sendEvents(true);
    }

    GmCXt.storage().remove(['trackingTours', 'guideTrackingInProcess', 'userPulsePayloadTime', 'tooltipTrackData']);

    GmCXt.user = false;
    GmCXt.organization = false;

    GmCXt.clearSession();
    GmCXt.sendMessageToAllWindows('mgPlayerJSProd_action:clear_session');
};

GmCXt.startReloginInterval = function() {

    GmCXt.log(21, "Start re-login Interval");

    if (GmCXt.reloginInterval) {
        clearInterval(GmCXt.reloginInterval);
    }

    GmCXt.reloginInterval = setInterval(function() {
        if (GmCXt.user) {

            GmCXt.log(21, "CLEAR: re-login interval");
            clearInterval(GmCXt.reloginInterval);
        } else {
            GmCXt.log(21, "RE-LOGIN using orgkey");
            GmCXt.storage().remove(['user']).then(function() {
                GmCXt.log(21, "CLEARED user data ");
                GmCXt.loginUsingAuthKey();
            });
        }
    }, GmCXt.t.autoRelogin);
};

GmCXt.alertV2 = function(options) {
    options = options || {};

    let pub = {};

    let self = {
        description: GmCXt.escapeHtml(options.description),
        button1: options.button1,
        button1Callback: options.button1Callback,
        button2: options.button2,
        button2Callback: options.button2Callback,
        button3: options.button3,
        button3Callback: options.button3Callback,
        keepScrollLock: options.keepScrollLock || false,
        closeTour: options.closeTour ? options.closeTour : false,
        showInputField: options.showInputField || false
    };

    let popupInputField = 'none';
    if (self.showInputField) {
        popupInputField = 'block';
    }
    pub.show = function() {
        let alt = GmCXt.getAutoLaunchTourId();
        let pi = GmCXt.playerI;
        let popupType = 'mgPlayerJSProd_popup-info';

        let html = " <wmgPlayerJSProd_ class='mgPlayerJSProd_overlay-container'></wmgPlayerJSProd_>" +
            "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup " + popupType + "'>" +
            "   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-wrapper'>" +
            "	   <wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon-wrapper'><wmgPlayerJSProd_ class='mgPlayerJSProd_popup-header-icon'></wmgPlayerJSProd_></wmgPlayerJSProd_>" +
            "   </wmgPlayerJSProd_>" +
            "<wmgPlayerJSProd_ style='display:" + popupInputField + "'><input type='text' class='mgPlayerJSProd_popup-input-field' maxlength='1000' /></wmgPlayerJSProd_>" +
            "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'>" + self.description + "</wmgPlayerJSProd_>" +
            "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper'>";

        if (self.button1) {
            html += "<wmgPlayerJSProd_ title='" + self.button1 + "' aria-label='" + self.button1 + "' class='mgPlayerJSProd_popup-ok-btn mgPlayerJSProd_btn-default mgPlayerJSProd_ok-btn mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt'>" + self.button1 + "</wmgPlayerJSProd_>";
        }

        if (self.button3) {
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-play-inapp mgPlayerJSProd_btn-default mgPlayerJSProd_ok-btn mgPlayerJSProd_inline-block-vt' aria-label='" + self.button3 + "'>" + self.button3 + "</wmgPlayerJSProd_>";
        }

        if (self.button2) {
            html += "<wmgPlayerJSProd_ title='" + self.button2 + "' aria-label='" + self.button2 + "' class='mgPlayerJSProd_popup-cancel-btn mgPlayerJSProd_btn-default mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt'>" + self.button2 + "</wmgPlayerJSProd_>";
        }

        html += "</wmgPlayerJSProd_>";

        if (pi && alt && alt === pi.tour.tour_id)
            html += "<wmgPlayerJSProd_><input type='checkbox' class='mgPlayerJSProd_popup-checkbox mgPlayerJSProd_input-checkbox-custom'>" + GmCXt.label.doNotShowAgain + "</wmgPlayerJSProd_>" +
            "</wmgPlayerJSProd_>";

        mg$("html").append(html);

        mg$(".mgPlayerJSProd_popup-header-icon").html(GmCXt.svgs.popup_info);
        mg$(".mgPlayerJSProd_popup").on("mousedown", function(e) {
            GmCXt.stopPropagation(e);
        });

        mg$(".mgPlayerJSProd_overlay-container").on("mousedown", function(e) {
            GmCXt.stopPropagation(e);
        });

        mg$(".mgPlayerJSProd_popup-ok-btn").on("click", function(e) {
            GmCXt.stopPropagation(e);
            let popupInputFieldValue = mg$('.mgPlayerJSProd_popup-input-field').val();
            if (pi && alt && alt === pi.tour.tour_id) {

                let checked = mg$('.mgPlayerJSProd_popup-checkbox:checkbox:checked').length > 0;

                if (checked)
                    GmCXt.setDoNotShowTours(pi.tour);
                else
                    GmCXt.setSnoozedTour(pi.tour);
            }
            self.closeTour = false;
            pub.close();
            if (mg$.isFunction(self.button1Callback))
                self.button1Callback(popupInputFieldValue);
        });

        mg$(".mgPlayerJSProd_popup-play-inapp").on("click", function(e) {
            GmCXt.stopPropagation(e);
            pub.close();
            if (mg$.isFunction(self.button3Callback))
                self.button3Callback();
        });

        mg$(".mgPlayerJSProd_popup-cancel-btn").on("click", function(e) {
            GmCXt.stopPropagation(e);
            pub.close(self.keepScrollLock);
            if (mg$.isFunction(self.button2Callback))
                self.button2Callback();
        });

        mg$(".mgPlayerJSProd_popup-close-button").on("click", function(e) {
            GmCXt.stopPropagation(e);
            pub.close(self.keepScrollLock);
        });
    };

    pub.close = function(keepScrollLock) {

        if (!keepScrollLock)
            GmCXt.unlockScroll();

        if (self.closeTour) GmCXt.cleanPlayer();

        GmCXt.closePopup();
    };

    return pub;
};

GmCXt.alignMessagePreview = function($popup, $container, alignment, stepSettings) {

    GmCXt.clearPreviewPopupAlignment($popup);
    let popupWidth = $popup.width();
    let popupHeight = $popup.height();
    let windowWidth = $container.width();
    let windowHeight = $container.height();
    let left = (windowWidth - popupWidth) / 2;
    let top = 0;

    if (!popupWidth || !popupHeight) return;

    switch (alignment) {

    case 'top':
        top = 20;
        left = (windowWidth - popupWidth) / 2;
        break;

    case 'center':
        top = (windowHeight - popupHeight) / 2;
        left = (windowWidth - popupWidth) / 2;
        break;

    case 'bottom':
        top = windowHeight - popupHeight - 20;
        left = (windowWidth - popupWidth) / 2;
        break;

    case 'left-top':
        top = 20;
        left = 20;
        break;

    case 'left-center':
        top = (windowHeight - popupHeight) / 2;
        left = 20;
        break;

    case 'left-bottom':
        top = windowHeight - popupHeight - 20;
        left = 20;
        break;

    case 'right-top':
        top = 20;
        left = windowWidth - popupWidth - 20;
        break;

    case 'right-center':
        top = (windowHeight - popupHeight) / 2;
        left = windowWidth - popupWidth - 20;
        break;

    case 'right-bottom':
        top = windowHeight - popupHeight - 20;
        left = windowWidth - popupWidth - 20;
        break;

    case 'custom':
        top = (stepSettings.elementTop * windowHeight) / 100;
        left = (stepSettings.elementLeft * windowWidth) / 100;
        break;
    }

    $popup.css({
        left: left,
        top: top,
        position: 'fixed'
    });
};

GmCXt.alignPushNotificationPreview = function($popup, $container, alignment) {
    GmCXt.clearPreviewPopupAlignment($popup);
    let popupWidth = $popup.width();
    let popupHeight = $popup.height();
    let windowWidth = $container.width();
    let windowHeight = $container.height();
    let left = 0;
    let top = 0;
    let right = 0;
    let bottom = 0;
    let transform;

    if (!popupWidth || !popupHeight) return;

    switch (alignment) {
    case 'top':
        top = '25px';
        left = '50%';
        right = 'initial';
        bottom = 'initial';
        transform = 'translate(-50%, 0px)';
        break;

    case 'center':
        top = '50%';
        left = '50%';
        right = 'initial';
        bottom = 'initial';
        transform = 'translate(-50%, -50%)';
        break;

    case 'bottom':
        top = 'initial';
        left = '50%';
        right = 'initial';
        bottom = '25px';
        transform = 'translate(-50%, 0px)';

        break;

    case 'left-top':
        top = '25px';
        left = '50px';
        right = 'initial';
        bottom = 'initial';
        transform = 'translate(0px, 0px)';
        break;

    case 'left-center':
        top = '50%';
        left = '50px';
        right = 'initial';
        bottom = 'initial';
        transform = 'translate(0px, -50%)';
        break;

    case 'left-bottom':
        top = 'initial';
        left = '50px';
        right = 'initial';
        bottom = '25px';
        transform = 'translate(0px, 0px)';
        break;

    case 'right-top':
        top = '25px';
        left = 'initial';
        right = '50px';
        bottom = 'initial';
        transform = 'translate(0px, 0px)';
        break;

    case 'right-center':
        top = '50%';
        left = 'initial';
        right = '50px';
        bottom = 'initial';
        transform = 'translate(0px, -50%)';
        break;

    case 'right-bottom':
        top = 'initial';
        left = 'initial';
        right = '50px';
        bottom = '25px';
        transform = 'translate(0px, 0px)';
        break;
    }

    $popup.css({
        left: left,
        top: top,
        transform: transform,
        bottom: bottom,
        right: right
    });
};

GmCXt.showAutoLaunchCloseOptions = function(tour, closeStep) {
    let options = {
        tour: tour
    };

    if (closeStep) {
        options.isTour = true;
        options.okClose = closeStep;
    }

    GmCXt.showPushOptions(options).show();
};

GmCXt.showPushOptions = function(opts) {

    let pub = {};

    pub.show = function() {

        GmCXt.isAutoNotifEnable = true;

        let msg = GmCXt.label.notifSnoozeDonotMsg;
        let ok = GmCXt.label.neverShowAgain;
        let cancel = GmCXt.label.watchLater;

        mg$("html").append(GmCXt.getPopupHtml(msg, ok, cancel));

        mg$(".mgPlayerJSProd_popup-header-icon").html(GmCXt.svgs.popup_info);

        function closeGuide() {
            if (opts.slideshow) {
                GmCXt.stopSlideshow();
                GmCXt.cleanPlayer();
            } else if (opts.isTour) {
                let pi = GmCXt.playerI;
                if (pi && GmCXt.isExitSurvey() &&
                    GmCXt.isPlayer() && !GmCXt.isLastStep(pi.currentStepId, pi.playStructure)) {
                    GmCXt.showExitSurvey();
                }

                opts.okClose();
            }
        }

        function onCancel(e) {
            GmCXt.stopPropagation(e);
            GmCXt.setSnoozedTour(opts.tour);
            closeGuide();
            pub.close();
        }

        function onClose(e) {
            GmCXt.stopPropagation(e);
            pub.close();
        }

        function onOK(e) {
            GmCXt.stopPropagation(e);
            GmCXt.setDoNotShowTours(opts.tour);
            closeGuide();
            pub.close();
        }

        GmCXt.addPopupEvents(onOK, onCancel, onClose);
    };

    pub.close = function() {
        GmCXt.unlockScroll();
        GmCXt.closePopup();
    };
    return pub;
};

GmCXt.setSnoozedTour = function(tour) {
    let msg = GmCXt.label.pushTourSnoozeMsg + ' ';
    GmCXt.setSnoozedTours(tour, msg);
};

GmCXt.setSnoozedTours = function(tour, msg) {

    GmCXt.storage().get(['toursClosed', 'tourIdArray']).then(function(st) {

        GmCXt.showSnoozeMessage(msg, tour);

        let toursClosedByUser = GmCXt.parseJSON(st.toursClosed);

        if (GmCXt.getObjectSize(toursClosedByUser) === 0) toursClosedByUser = {};

        if (mg$.isArray(tour)) {
            tour.forEach(function(tour) {
                toursClosedByUser[tour.tour_id] = new Date().getTime() + ':' + parseInt(tour.version);
            });
        } else {
            toursClosedByUser[tour.tour_id] = new Date().getTime() + ':' + parseInt(tour.version);
        }

        GmCXt.storage()
            .set({
                'toursClosed': JSON.stringify(toursClosedByUser)
            });
        GmCXt.updNotifDataSidePanel(toursClosedByUser, st.tourIdArray);
    });
};

GmCXt.showSnoozeMessage = function(str, tour) {
    let t = GmCXt.getSleepTime(GmCXt.label);

    if (t !== '0 ' + GmCXt.label.hour) {
        let msg = str + t;
        GmCXt.toastMsg(msg).show();
    }
};

GmCXt.setDoNotShowTours = function(tour) {
    if (GmCXt.isTourDisplayFrequencyReached(tour)) {
        return;
    }
    GmCXt.getDoNotShowTours(false)
        .then(function(t) {
            doNotShowTours = t;
            doNotShowTours[tour.tour_id] = parseInt(tour.version);
            GmCXt.updateNotification(doNotShowTours);
        });
};

GmCXt.isTourDisplayFrequencyReached = function(tour) {
    let retVal = false;
    let dispFreqGuides = GmCXt.user.settings.display_frequency_guides ? GmCXt.user.settings.display_frequency_guides : {};
    if (!GmCXt.isEmpty(dispFreqGuides)) {
        let countObj = dispFreqGuides[parseInt(tour.tour_id)];
        if (GmCXt.isDefined(countObj)) {
            if (parseInt(countObj.version) === parseInt(tour.version)) {
                if (tour.tour_settings.displayFrequencyTimes - countObj.playedCount <= 0) {
                    return true;
                }
            }
        }
    }

    if (tour.tour_settings.displayFrequency && tour.tour_settings.displayFrequencyTimes === 1) {
        return true;
    }

    return retVal;
};

GmCXt.setPanelTopLeft = function(isClose) {
    if (GmCXt.isMicroPlayer()) {
        mg$(".mgPlayerJSProd_panel").css("left", "initial");
        mg$(".mgPlayerJSProd_panel").css("top", "50%");
        if (GmCXt.APP_PANEL_OPEN) {
            mg$(".mgPlayerJSProd_panel").css("right", "50px");
        }
    } else {
        mg$(".mgPlayerJSProd_panel").css("left", "initial");
        mg$(".mgPlayerJSProd_panel").css("top", "0");
        if (GmCXt.APP_PANEL_OPEN) {
            let alignment = GmCXt.getWidgetAlignment();
            mg$(".mgPlayerJSProd_panel").css(alignment, "0");
        }
    }
};

/*
	* To change this license header, choose License Headers in Project Properties.
	* To change this template file, choose Tools | Templates
	* and open the template in the editor.
	*/

GmCXt.surveyStart = function(options, isExitSurvey, isPreview) {
    options = options || {};
    let surveyID = '';
    let tour_id = options.tourId;
    let surveyQuestion = [];
    let surveyQuestionList = [];
    let inValidFlag = true;
    let branchQues = [];
    let currentQues = {};

    if (!isExitSurvey && options.type !== 'stepPlay') {
        GmCXt.cleanPlayer();
    }

    clearSurveyInstance();
    openSurvey(options);


    function getBranchQueIndex(ques) {
        branchQues = [];
        bInd = -1;

        if (surveyQuestion && surveyQuestion.length > 0) {
            for (q = 0; q < surveyQuestion.length; q++) {
                if (ques && ques.questionID === surveyQuestion[q].questionID) {
                    bInd = q;
                }
                if (surveyQuestion[q].isBranchNode && ((ques && bInd !== -1 && q >= bInd) || !ques)) {
                    for (let opt = 0; opt < surveyQuestion[q].options.length; opt++) {
                        if (branchQues.indexOf(surveyQuestion[q].options[opt].nextHopOnBranch) === -1) {
                            branchQues.push(surveyQuestion[q].options[opt].nextHopOnBranch);
                        }

                    }
                }
            }
        }
        return branchQues;
    }

    function filterBranchNodePages() {
        let bLinkQues = getBranchQueIndex();
        let s = [];
        for (let i = 0; i < surveyQuestion.length; i++) {
            if (bLinkQues.indexOf(surveyQuestion[i].pageIndex) === -1) {
                s.push(surveyQuestion[i]);
            }
        }
        return s;
    }

    function getHtml(result) {
        surveyID = result.guide_id;
        surveyQuestion = result.questions;
        surveyQuestionList = filterBranchNodePages();
        surveyName = result.questionnaire_title || result.sentimentTitle;

        let surveyTitle = isExitSurvey ? GmCXt.label.exitSurvey : GmCXt.label.survey;
        if (options.type === 'stepPlay') {
            surveyTitle = options.step.step_title;
        }

        let previewClass = '';
        if (isPreview) {
            previewClass = ' mgPlayerJSProd_forbidden';
        }

        let htmlData = " <wmgPlayerJSProd_ class='mgPlayerJSProd_survey-popup-container'> " +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_survey-popup-wrapper'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_survey-header-wrapper'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_survey-logo-wrapper'>" + surveyTitle + "</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_survey-popup-close' aria-label='close survey' >" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-title'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_survey-content-wrapper'>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_question-single-select-wrapper'>" +

			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";

        let progressWrap = '';
        if (result.questions.length > 1) {
            progressWrap = '<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-footer-progress-wrapper mgPlayerJSProd_inline-block-vm">' +
				'	<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-progressbar-wrapper mgPlayerJSProd_inline-block-vm">' +
				'		<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-progressbar mgPlayerJSProd_inline-block-vm"></wmgPlayerJSProd_>' +
				'	</wmgPlayerJSProd_>' +
				'	<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-questions-count mgPlayerJSProd_inline-block-vm">' + GmCXt.label.question +
				' 		<wmgPlayerJSProd_ class="mgPlayerJSProd_span" id="mgPlayerJSProd_current_question">1</wmgPlayerJSProd_> <wmgPlayerJSProd_ class="mgPlayerJSProd_span" id="mgPlayerJSProd_question_count">' + GmCXt.label.of + ' ' + surveyQuestionList.length +
				'	</wmgPlayerJSProd_></wmgPlayerJSProd_>' +
				'</wmgPlayerJSProd_>';
        }

        htmlData += '<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-footer-action-wrapper">' +
			'<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-button-back mgPlayerJSProd_btn-default mgPlayerJSProd_disabled mgPlayerJSProd_inline-block-vm" aria-label="' + GmCXt.label.back + '" >' + GmCXt.label.back + '</wmgPlayerJSProd_>' +
			'<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-button-continue mgPlayerJSProd_btn-default mgPlayerJSProd_inline-block-vm" aria-label="' + GmCXt.label.next + '">' + GmCXt.label.next + '</wmgPlayerJSProd_>' +
			'<wmgPlayerJSProd_ class="mgPlayerJSProd_survey-button-submit mgPlayerJSProd_inline-block-vm mgPlayerJSProd_btn-default mgPlayerJSProd_display-none' + previewClass + '" aria-label="' + GmCXt.label.btnSubmit + '">' + GmCXt.label.btnSubmit + '</wmgPlayerJSProd_>' +
			progressWrap +
			'</wmgPlayerJSProd_>' +
			'</wmgPlayerJSProd_>';

        return htmlData;
    }

    function cb(sd) {
        if (sd) {
            let htmlData = getHtml(sd.data);

            mg$(".mgPlayerJSProd_user-guide-container").empty().append(htmlData).show();

            mg$(".mgPlayerJSProd_survey-popup-close").html(GmCXt.svgs.close_btn);
            currentQues = sd.data.questions[0];
            addQuestionInSurvey(sd.data.questions[0], 1);
            toggleBackContinueButton(0);
            changeProgressbar(1);
            attachDOMEvents(options);

            if (GmCXt.accessibility) {
                mg$(".mgPlayerJSProd_survey-footer-action-wrapper").addClass("mgPlayerJSProd_accessibility-theme");
                mg$(".mgPlayerJSProd_survey-button-back").addClass("mgPlayerJSProd_ass-default-btn");
                mg$(".mgPlayerJSProd_survey-button-continue").addClass("mgPlayerJSProd_ass-default-btn");
                mg$(".mgPlayerJSProd_survey-button-submit").addClass("mgPlayerJSProd_ass-default-btn");

            } else {
                mg$(".mgPlayerJSProd_survey-footer-action-wrapper").removeClass("mgPlayerJSProd_accessibility-theme");
                mg$(".mgPlayerJSProd_survey-button-back").removeClass("mgPlayerJSProd_ass-default-btn");
                mg$(".mgPlayerJSProd_survey-button-continue").removeClass("mgPlayerJSProd_ass-default-btn");
                mg$(".mgPlayerJSProd_survey-button-submit").removeClass("mgPlayerJSProd_ass-default-btn");
            }

            GmCXt.timeout(function() {
                mg$(".mgPlayerJSProd_survey-popup-close").focus();
            }, 500);

        } else {
            closeTourWithSurvey(false);
        }
    }

    function getExitSentimentDetails() {
        let data = {};
        let msgId = Math.floor(Math.random() * 100000);
        data.msgId = msgId;
        let os = GmCXt.getOrgSettings();
        data.sentiment = os.sentiment;
        data.isExit = true;
        GmCXt.getSurveyDetails(data).then(cb);
    }

    function openSurvey(options) {

        mg$("html").find('.mgPlayerJSProd_user-guide-container').remove();
        mg$("<wmgPlayerJSProd_></wmgPlayerJSProd_>").addClass('mgPlayerJSProd_user-guide-container').appendTo('html');

        if (isExitSurvey) {
            try {
                let os = GmCXt.getOrgSettings();
                let surveyData = null;
                if (os && os.exitSentiment) {
                    getExitSentimentDetails();
                } else if (os && os.exitSurvey) {
                    if (os.survey.length > 0) {
                        surveyData = getExitSurvey(os);
                        cb(surveyData);
                    }
                }
            } catch (e) {
                console.dir(e.message);
            }
        } else if (isPreview || (options.data && options.data.sentimentCode)) {
            cb(options);
        } else {
            let data = {};
            let msgId = Math.floor(Math.random() * 100000);
            data.msgId = msgId;
            if (options.type === 'stepPlay') {
                data.sentiment = options.step.step_settings.sentiment;
            } else if (options.type === 'guide') {
                let ts = options.instance.tour.tour_settings;
                if (ts.enableSentiment) {
                    data.sentiment = ts.sentiment;
                }
            } else if (options.tourId) {
                data.tourId = options.tourId;
            }

            GmCXt.getSurveyDetails(data).then(cb);
        }
    }

    function getExitSurvey(os) {
        let quesArray = [];
        let i = 0;
        if (os.survey[0].questions.length > 0) {
            for (i; i < os.survey[0].questions.length; i++) {
                let ques = {
                    question: os.survey[0].questions[i].question,
                    type: os.survey[0].questions[i].type,
                    options: os.survey[0].questions[i].options,
                    answer: []
                };
                quesArray.push(ques);
            }
        }

        let surveyData = {
            data: {
                guide_id: '',
                questionnaire_title: os.survey[0].surveyTitle,
                questions: quesArray
            }
        };

        return surveyData;

    }

    function clearPreviousAns(survey) {
        let s = survey;
        let i = 0;
        for (i; i < s.data.questions.length; i++) {
            s.data.questions[i].answer = [];
        }
        return s;
    }

    function addQuestionInSurvey(result, id) {
        let questionType = result.type;
        mg$('#mgPlayerJSProd_current_question').html(id);
        mg$('#mgPlayerJSProd_question_count').html(GmCXt.label.of + ' ' + surveyQuestionList.length);
        let htmlData = '';
        switch (questionType) {
        case 'yes-no':
            htmlData = addYesAndNoQuestion(result);
            break;
        case 'comment':
            htmlData = addCommentTypeQuestion(result);
            break;
        case 'select':
            htmlData = addSelectTypeQuestion(result);
            break;
        case 'multi-select':
            htmlData = addMultiSelectType(result);
            break;
        case 'range':
            htmlData = addRangeQuestion(result);
            break;
        case 'rating':
            htmlData = addRateQuestion(result);
            break;
        }
        changeProgressbar(id);
        mg$(".mgPlayerJSProd_question-single-select-wrapper").empty().append(htmlData);
        mg$(".mgPlayerJSProd_ext-link-svg").html(GmCXt.svgs.external_link);

    }

    function addCommentTypeQuestion(question) {
        let html = "<wmgPlayerJSProd_><wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'>" + GmCXt.escapeHtml(question.question) +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_select-option'>" +
			"<textarea id='mgPlayerJSProd_comment_type_" + question.questionID + "' class='mgPlayerJSProd_comment_type_question' cols='44' rows='4' data-gramm_editor='false' placeholder='" + GmCXt.label.surveyCommentPlaceholder + "' maxlength='500'></textarea>" +
			"</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_><wmgPlayerJSProd_ id='mgPlayerJSProd_comment_type_survey_" + question.questionID + "'>" + GmCXt.label.characters + " 0</wmgPlayerJSProd_><br><wmgPlayerJSProd_>";
        return html;
    }

    function changeProgressbar(length) {
        let initialProgressBar = parseInt((100 * length) / surveyQuestionList.length);
        mg$('.mgPlayerJSProd_survey-progressbar').css('width', initialProgressBar + '%');
    }

    function addYesAndNoQuestion(question) {
        let html = "<wmgPlayerJSProd_ id='mgPlayerJSProd_single-type-question-" + question.questionID + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'>" + GmCXt.escapeHtml(question.question) + "</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_select-option'>" +
			'<input type="radio" name="mgPlayerJSProd_capture-guide-radio-' + question.questionID + '" value="Yes" id="mgPlayerJSProd_capture-guide-checkbox" class="mgPlayerJSProd_input-radio-custom mgPlayerJSProd_input-radio-with-branch mgPlayerJSProd_inline-block-vm mgPlayerJSProd_input-display-block"><wmgPlayerJSProd_ class="mgPlayerJSProd_option-label mgPlayerJSProd_inline-block-vm">' + GmCXt.escapeHtml('Yes') + '</wmgPlayerJSProd_>';
        if (!GmCXt.isFalse(question.options[0]) && !GmCXt.isFalse(question.options[0].optionReferenceLink)) {
            html += "<a href='" + getReferenceURL(question.options[0].optionReferenceLink) + "' target='_blank' rel='noopener noreferrer'><wmgPlayerJSProd_ class='mgPlayerJSProd_ext-link-svg'></wmgPlayerJSProd_></a>";
        }
        html += '</wmgPlayerJSProd_>' +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_select-option'>" +
			'<input type="radio" name="mgPlayerJSProd_capture-guide-radio-' + question.questionID + '" value="No" id="mgPlayerJSProd_capture-guide-checkbox" class="mgPlayerJSProd_input-radio-custom mgPlayerJSProd_input-radio-with-branch mgPlayerJSProd_inline-block-vm mgPlayerJSProd_input-display-block"><wmgPlayerJSProd_ class="mgPlayerJSProd_option-label mgPlayerJSProd_inline-block-vm">' + GmCXt.escapeHtml('No') + '</wmgPlayerJSProd_>';
        if (!GmCXt.isFalse(question.options[1]) && !GmCXt.isFalse(question.options[1].optionReferenceLink)) {
            html += "<a href='" + getReferenceURL(question.options[1].optionReferenceLink) + "' target='_blank' rel='noopener noreferrer'><wmgPlayerJSProd_ class='mgPlayerJSProd_ext-link-svg'></wmgPlayerJSProd_></a>";
        }
        html += '</wmgPlayerJSProd_>' +
			"<br></wmgPlayerJSProd_>";
        return html;
    }

    function addSelectTypeQuestion(question) {
        let html = "<wmgPlayerJSProd_ id='mgPlayerJSProd_single-type-question-" + question.questionID + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'>" + GmCXt.escapeHtml(question.question) + "</wmgPlayerJSProd_>";
        mg$.each(question.options, function(index, element) {
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_select-option'>" +
				"<input class='mgPlayerJSProd_inline-block-vm mgPlayerJSProd_input-radio-with-branch mgPlayerJSProd_input-radio-custom mgPlayerJSProd_input-display-block' type='radio' name='select_type_option_" + question.questionID + "' value='" + element.option + "' />" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_option-label mgPlayerJSProd_inline-block-vm'>" + GmCXt.escapeHtml(element.option) + "</wmgPlayerJSProd_>";
            if (!GmCXt.isFalse(element.optionReferenceLink)) {
                html += "<a href='" + getReferenceURL(element.optionReferenceLink) + "' target='_blank' rel='noopener noreferrer'><wmgPlayerJSProd_ class='mgPlayerJSProd_ext-link-svg'></wmgPlayerJSProd_></a>";
            }
            html += "</wmgPlayerJSProd_>";
        });
        html += "<br></wmgPlayerJSProd_>";
        return html;
    }

    function getReferenceURL(url) {
        if (url.indexOf("https://") === 0 || url.indexOf("http://") === 0) {
            return url;
        }
        return "https://" + url;
    }

    function addMultiSelectType(question) {
        let html = "<wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'>" + GmCXt.escapeHtml(question.question) + "</wmgPlayerJSProd_><wmgPlayerJSProd_ id='mgPlayerJSProd_multiselect-type-question'>";
        mg$.each(question.options, function(index, element) {
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_select-option'>" +
				"<input class='mgPlayerJSProd_inline-block-vm mgPlayerJSProd_input-checkbox-custom mgPlayerJSProd_input-display-block' type='checkbox' name='multiselect_type_option_" + question.questionID + "[]' id='mgPlayerJSProd_multiselect_type_option_" + question.questionID + "' value='" + GmCXt.escapeHtml(element.option) + "' />" +
				"<wmgPlayerJSProd_ class='mgPlayerJSProd_option-label mgPlayerJSProd_inline-block-vm'>" + GmCXt.escapeHtml(element.option) + "</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";
        });
        html += "<br></wmgPlayerJSProd_>";
        return html;
    }

    function addRangeQuestion(question) {
        let html = "<wmgPlayerJSProd_ id='mgPlayerJSProd_single-type-question-" + question.questionID + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'> " + GmCXt.escapeHtml(question.question) + "</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_range-question-wrapper'>";

        for (let i = 1; i < 10; i++) {
            html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_value-range mgPlayerJSProd_inline-block-vm' id='mgPlayerJSProd_value-range-" + i + "' aria-label='range'>" + i + "</wmgPlayerJSProd_>";
        }

        html += "<wmgPlayerJSProd_ class='mgPlayerJSProd_value-range mgPlayerJSProd_inline-block-vm mgPlayerJSProd_border-right' id='mgPlayerJSProd_value-range-10' aria-label='range'>10</wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>" +
			"<br></wmgPlayerJSProd_>";
        return html;
    }

    function addRateQuestion(question) {
        let html = "<wmgPlayerJSProd_ id='mgPlayerJSProd_single-type-question-" + question.questionID + "'><wmgPlayerJSProd_ class='mgPlayerJSProd_single-type-question'> " + GmCXt.escapeHtml(question.question) + "</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_rating'>";

        for (let i = 1; i < 4; i++) {
            html += "<button class='mgPlayerJSProd_lbl-btn mgPlayerJSProd_stars-rate' id='mgPlayerJSProd_rate-" + i + "' aria-label='rate' >&#9733;</button>";
        }
        html += "</wmgPlayerJSProd_>" +
			"<br></wmgPlayerJSProd_>";
        return html;
    }

    function checkCommentTypeMess() {
        mg$('.mgPlayerJSProd_comment_type_question').on('keyup', function(e) {
            let qI = parseInt(mg$('#mgPlayerJSProd_current_question').html());
            if (!qI) {
                qI = 1;
            }
            let ansLen = e.target.value.length;
            mg$('#mgPlayerJSProd_comment_type_survey_' + surveyQuestion[qI - 1].questionID).html(GmCXt.label.characters + ' ' + ansLen);
            if (ansLen === 500) {
                GmCXt.toastMsg(GmCXt.label.feedCmt).show();
            }
        });
    }

    function getQuesnIndex(pindex, qindex) {
        let index = -1;
        if (surveyQuestion && surveyQuestion.length > 0) {
            for (q = 0; q < surveyQuestion.length; q++) {
                if (surveyQuestion[q].pageIndex === pindex &&
					surveyQuestion[q].indexInPage === qindex) {
                    index = q;
                }
            }
        }
        return index;
    }

    function getQListByPageIndex(pi) {
        let qList = [];
        if (surveyQuestion && surveyQuestion.length > 0) {
            for (q = 0; q < surveyQuestion.length; q++) {
                if (surveyQuestion[q].pageIndex === pi) {
                    qList.push(surveyQuestion[q]);
                }
            }
        }
        return qList;
    }

    function getListQuesnIndex(qid) {
        let index = -1;
        if (surveyQuestionList && surveyQuestionList.length > 0) {
            for (q = 0; q < surveyQuestionList.length; q++) {
                if (surveyQuestionList[q].questionID === qid) {
                    index = q;
                }
            }
        }
        return index;
    }

    function onNextQuesClick() {
        let qI = parseInt(mg$('#mgPlayerJSProd_current_question').html());
        if (!qI) {
            qI = 1;
        }

        let status = storeQuestionAnswer(qI - 1);

        let ind = -1;

        if (!GmCXt.isEmpty(status)) {
            if (currentQues.isBranchNode) {
                if (currentQues.type === "select" || currentQues.type === 'yes-no') {
                    for (a = 0; a < currentQues.options.length; a++) {
                        if (currentQues.options[a].option === status) {
                            ind = getQuesnIndex(currentQues.options[a].nextHopOnBranch, 1);
                            break;
                        }
                    }
                }
            }

            if (ind !== -1) {
                //get all qusetion of next page
                let nq = getQListByPageIndex(surveyQuestion[ind].pageIndex);
                //Remove other Question with same page index of branch ques

                if (currentQues.isBranchNode) {
                    surveyQuestionList = surveyQuestionList.filter(function(q) {
                        return ((q.questionID === currentQues.questionID &&
								q.pageIndex === currentQues.pageIndex) ||
							(q.questionID !== currentQues.questionID &&
								(q.pageIndex !== currentQues.pageIndex ||
									(q.pageIndex === currentQues.pageIndex &&
										q.indexInPage < currentQues.indexInPage)) &&
								getBranchQueIndex(currentQues).indexOf(q.pageIndex) === -1));

                    });
                } else {
                    surveyQuestionList = surveyQuestionList.filter(function(q) {
                        return ((q.questionID === currentQues.questionID &&
								q.pageIndex === currentQues.pageIndex) ||
							(q.questionID !== currentQues.questionID &&
								q.pageIndex !== currentQues.pageIndex));

                    });
                }

                let inx = getListQuesnIndex(currentQues.questionID);
                surveyQuestionList.splice(inx + 1, 0, nq);
                if (surveyQuestionList.length) {
                    surveyQuestionList = surveyQuestionList.flat();
                }
            }
        }

        toggleBackContinueButton(qI);
        currentQues = surveyQuestionList[qI];
        addQuestionInSurvey(surveyQuestionList[qI], qI + 1);
        attachDOMEvents(options);
        setQuestionAnswer(qI);
    }

    function onBackQuesClick() {
        let qI = parseInt(mg$('#mgPlayerJSProd_current_question').html()) - 1;
        if (!qI) {
            qI = 0;
            if (options.type === 'stepPlay') {
                close(false, true);
                return;
            }
        }

        storeQuestionAnswer(qI);
        toggleBackContinueButton(qI - 1);
        currentQues = surveyQuestionList[qI - 1];
        addQuestionInSurvey(surveyQuestionList[qI - 1], qI);
        setQuestionAnswer(qI - 1);
    }


    function attachDOMEvents(options) {

        mg$('.mgPlayerJSProd_survey-popup-close').on('click', function(e) {
            if (isExitSurvey) {
                closeTourWithSurvey(true);
            } else if (GmCXt.isPlayer() && GmCXt.playerI && options && options.type === "stepPlay" && GmCXt.isExitSurvey()) {
                let data = {
                    tourId: GmCXt.playerI.tour.tour_id,
                    version: GmCXt.playerI.tour.version,
                    playerInstance: GmCXt.playerI
                };
                GmCXt.showSurveyScreen(data, true);
            } else {
                close(true);
            }
            e.stopPropagation();
        });

        checkCommentTypeMess();

        mg$(document).off('click', '.mgPlayerJSProd_value-range');
        mg$(document).on('click', '.mgPlayerJSProd_value-range', function(e) {
            mg$('.mgPlayerJSProd_value-range').removeClass('mgPlayerJSProd_value-range-selected');
            let selectRange = e.target.innerHTML;
            mg$('#mgPlayerJSProd_value-range-' + selectRange).addClass('mgPlayerJSProd_value-range-selected');
        });

        mg$(document).off('click', '.mgPlayerJSProd_stars-rate');
        mg$(document).on('click', '.mgPlayerJSProd_stars-rate', function(e) {
            if (e.target.id.indexOf("mgPlayerJSProd_rate") !== -1) {
                let elem = mg$('#' + e.target.id);
                elem.toggleClass('mgPlayerJSProd_rating-filled');
                elem.nextAll().removeClass('mgPlayerJSProd_rating-filled');
                elem.prevAll().addClass('mgPlayerJSProd_rating-filled');
            }
        });

        mg$(document).off('click', '.mgPlayerJSProd_survey-button-continue');
        mg$(document).on('click', '.mgPlayerJSProd_survey-button-continue', function(e) {
            onNextQuesClick();
        });

        mg$(document).off('change', '.mgPlayerJSProd_input-radio-with-branch');
        mg$(document).on('change', '.mgPlayerJSProd_input-radio-with-branch', function(e) {
            let ans = mg$("input:radio[name='" + mg$('.mgPlayerJSProd_input-radio-with-branch')[0].name +
				"']:checked").val();
            if (currentQues && currentQues.isBranchNode && !GmCXt.isEmpty(ans)) {
                let isSubmitVisible = false;
                if (mg$('.mgPlayerJSProd_survey-button-submit') && mg$('.mgPlayerJSProd_survey-button-submit')[0] &&
					mg$('.mgPlayerJSProd_survey-button-submit')[0].style.display !== "none") {
                    isSubmitVisible = true;
                }
                if (isSubmitVisible) {
                    for (let o = 0; o < currentQues.options.length; o++) {
                        if (currentQues.options[o].option === ans &&
							currentQues.options[o].nextHopOnBranch) {
                            mg$('.mgPlayerJSProd_survey-button-submit').hide();
                            mg$('.mgPlayerJSProd_survey-button-continue').show();
                            break;
                        }
                    }
                }
            }
        });

        mg$(document).off('click', '.mgPlayerJSProd_survey-button-back');
        mg$(document).on('click', '.mgPlayerJSProd_survey-button-back', function(e) {
            onBackQuesClick();
        });

        mg$(document).off('click', '.mgPlayerJSProd_survey-button-submit');
        mg$(document).on('click', ".mgPlayerJSProd_survey-button-submit", function(e) {
            if (!isPreview) {
                submitSurvey();
            }
        });
    }

    function mergeAllSurveyQuestions() {
        if (surveyQuestionList && surveyQuestionList.length) {
            for (let s1 = 0; s1 < surveyQuestion.length; s1++) {
                for (s2 = 0; s2 < surveyQuestionList.length; s2++) {
                    if (surveyQuestionList[s2].questionID === surveyQuestion[s1].questionID) {
                        surveyQuestion[s1] = surveyQuestionList[s2];
                        break;
                    }
                }
            }
        }
    }

    function submitSurvey() {
        var data = [];
        let dataAnalytics = [];


        let getAnswer = function(answer) {
            if (answer !== undefined) return answer;
            else return '';
        };

        let pushData = function(el) {
            return {
                'question_id': el.questionID ? el.questionID : '',
                'question_type': el.type,
                'question_name': el.question ? el.question : ''
            };
        };

        storeQuestionAnswer(surveyQuestionList.length - 1);

        surveyQuestionList.filter(function(el) {
            if (el.answer && el.answer.length > 0) {
                inValidFlag = false;
            }
        });

        mergeAllSurveyQuestions();

        mg$.each(surveyQuestion, function(index, element) {

            let valueData = '';

            switch (element.type) {
            case 'yes-no':
                if (element.answer !== undefined)
                    valueData = (element.answer === 'Yes') ? true : (element.answer === 'No') ? false : null;

                var data = pushData(element);
                data.is_answer_yes = valueData;
                break;

            case 'comment':
                valueData = getAnswer(element.answer);

                var data = pushData(element);
                data.comment = valueData;
                break;

            case 'multi-select':
                valueData = getAnswer(element.answer).split(",");
                var data = pushData(element);
                data.option = valueData;
                break;

            case 'select':
            case 'range':
                valueData = getAnswer(element.answer).split();
                var data = pushData(element);
                data.option = valueData;
                break;
            case 'rating':
                valueData = getAnswer(element.answer).split();
                var data = pushData(element);
                data.option = valueData;
                break;
            }

            dataAnalytics.push(data);
        });

        let user_id = 0;
        if (typeof GmCXt.user.user_id != 'undefined')
            user_id = GmCXt.user.user_id;

        if (!inValidFlag) {
            if (isExitSurvey) {
                let os = GmCXt.getOrgSettings();
                if (os.exitSentiment) {
                    if (!options.tourId) {
                        options.tourId = options.tour.tour_id;
                    }
                    var data = {
                        trigger_source_type: 'guide_exit',
                        trigger_source_id: options.tourId,
                        sentimentCode: os.sentiment.sentimentCode
                    };
                    GmCXt.trackerV1.trackSurveyInstantResponse(dataAnalytics, data);
                } else {
                    // Track With Insights Team
                    // GmCXt.trackerV1.trackExitSurvey(dataAnalytics, tour_id);
                }

            } else {
                var data = {
                    trigger_source_type: options.type,
                    trigger_source_id: tour_id + ':' + options.stepId
                };

                if (options.type === 'stepPlay') {
                    data.sentimentCode = options.step.step_settings.sentiment.sentimentCode;
                    data.trigger_source_type = 'step';
                    data.trigger_source_id = options.step.tour_id + ":" + options.step.step_id;
                } else if (options.data && GmCXt.isDefined(options.data.sentimentCode)) {
                    data.sentimentCode = options.data.sentimentCode;
                } else if (options.type === 'guide') {
                    let ts = options.instance.tour.tour_settings;
                    if (ts.enableSentiment) {
                        data.sentimentCode = ts.sentiment.sentimentCode;
                        data.trigger_source_id = tour_id;
                        data.trigger_source_type = 'guide';
                        GmCXt.updateSurveyCompletedData({
                            tourId: tour_id,
                            version: options.version
                        });
                    }
                }

                if (GmCXt.isDefined(data.sentimentCode)) {
                    GmCXt.trackerV1.trackSurveyInstantResponse(dataAnalytics, data);
                } else {
                    GmCXt.trackerV1.trackGuideSurveyAnswer(dataAnalytics, tour_id);
                }
            }

            closeTourWithSurvey(false);
            if (options.type !== 'stepPlay') {
                GmCXt.toastMsg(GmCXt.label.surveyThanksMessage).show();
            }
        } else {
            GmCXt.toastMsg(GmCXt.label.surveyErrorMsg).show();
        }
    }

    function toggleBackButton() {
        if (options.type === 'stepPlay') {
            let prevStep = GmCXt.getPreviousStep();
            if (!GmCXt.isEmpty(prevStep)) {
                if (mg$.inArray(prevStep.step_id, GmCXt.playedPreviousSteps) !== -1 || prevStep.step_settings.optional) {
                    mg$('.mgPlayerJSProd_survey-button-back').removeClass('mgPlayerJSProd_disabled');
                }
            }
        } else {
            mg$('.mgPlayerJSProd_survey-button-back').addClass('mgPlayerJSProd_disabled');
        }
    }

    function toggleBackContinueButton(ind) {

        if (surveyQuestionList.length === 1) {
            //Only One Question in Survey
            mg$('.mgPlayerJSProd_survey-button-submit').show();
            mg$('.mgPlayerJSProd_survey-button-continue').hide();
            mg$('.mgPlayerJSProd_survey-button-back').show();
            toggleBackButton();
        } else if (surveyQuestionList.length > 1 && ind === 0) {
            //More than one question and current question no 1
            mg$('.mgPlayerJSProd_survey-button-submit').hide();
            mg$('.mgPlayerJSProd_survey-button-continue').show();
            mg$('.mgPlayerJSProd_survey-button-back').show();
            toggleBackButton();

        } else if (surveyQuestionList.length === ind + 1) {
            //More than one questions and current at last question
            mg$('.mgPlayerJSProd_survey-button-submit').show();
            mg$('.mgPlayerJSProd_survey-button-continue').hide();
            mg$('.mgPlayerJSProd_survey-button-back').show();
            mg$('.mgPlayerJSProd_survey-button-back').removeClass('mgPlayerJSProd_disabled');
        } else if (surveyQuestionList.length > 1 && ind > 0) {
            //More than one question and questions between 1st and Last Excluding the tow
            mg$('.mgPlayerJSProd_survey-button-submit').hide();
            mg$('.mgPlayerJSProd_survey-button-continue').show();
            mg$('.mgPlayerJSProd_survey-button-back').show();
            mg$('.mgPlayerJSProd_survey-button-back').removeClass('mgPlayerJSProd_disabled');
        }

    }

    function close(closeIconClicked, playPrevStep) {
        let pi = GmCXt.playerI;
        GmCXt.isSurveyVisible = false;
        mg$('.mgPlayerJSProd_overlay-container').hide().empty();
        mg$('.mgPlayerJSProd_user-guide-container').hide().empty();
        mg$('.mgPlayerJSProd_user-tip-guide-container').hide().empty();
        if (isPreview) {
            GmCXt.openAppPanel();
        } else if (options.type === 'stepPlay') {
            if (closeIconClicked && GmCXt.tourPlayerI) {
                GmCXt.markAutoLaunchTourDoNotShow(GmCXt.playerI.tour);

                if (GmCXt.FT.isPlayer && pi) {
                    GmCXt.tourActivity['t:' + pi.tour.tour_id] = pi.lastPlayedStepId;
                }
                GmCXt.tourPlayerI.closeGuide(true);
            } else if (GmCXt.tourPlayerI && playPrevStep) {
                GmCXt.tourPlayerI.playPreviousStep();
            } else if (GmCXt.tourPlayerI) {
                GmCXt.tourPlayerI.playNextStep();
            }

        } else {
            GmCXt.showSmartTips();
            GmCXt.showBeacons();
            GmCXt.resumeAutomation();

            if (GmCXt.playerI) {
                let step = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
                if (step.step_type === "video") {
                    GmCXt.toggleSidePanel(true);
                }
            }
        }
    }

    function closeTourWithSurvey(closeIconClicked) {
        if (GmCXt.tourPlayerI && isExitSurvey) GmCXt.tourPlayerI.closeGuide();
        close(closeIconClicked);
    }

    function hideAllQuestions() {
        mg$('.question:visible').each(function(index, element) {
            mg$(element).hide();
        });
    }

    function storeQuestionAnswer(id) {
        let questionType = surveyQuestionList[id].type;
        let qId = surveyQuestionList[id].questionID;
        let retVal = true;

        switch (questionType) {
        case 'yes-no':
            surveyQuestionList[id].answer = mg$('input:radio[name=mgPlayerJSProd_capture-guide-radio-' + qId + ']:checked').val() || '';
            break;
        case 'comment':
            var ans = mg$('textarea#mgPlayerJSProd_comment_type_' + qId + '').val();
            if (ans.length > 500) {
                GmCXt.toastMsg(GmCXt.label.feedCmt).show();
                retVal = false;
                break;
            } else {
                surveyQuestionList[id].answer = ans;
            }
            break;
        case 'select':
            surveyQuestionList[id].answer = mg$('input:radio[name=select_type_option_' + qId + ']:checked').val() || '';
            break;
        case 'multi-select':
            var values = [];
            mg$.each(mg$("input:checkbox[name='multiselect_type_option_" + qId + "[]']:checked"), function() {
                values.push(mg$(this).val());
            });

            if (values.length) surveyQuestionList[id].answer = values.toString();
            else surveyQuestionList[id].answer = "";

            break;
        case 'range':
            var rangeValue = mg$('#mgPlayerJSProd_single-type-question-' + qId + '').find('.mgPlayerJSProd_value-range-selected');
            surveyQuestionList[id].answer = rangeValue.length ? rangeValue[0].textContent : '';
            break;
        case 'rating':
            var rateValue = mg$('#mgPlayerJSProd_single-type-question-' + qId + '').find('.mgPlayerJSProd_rating-filled');
            surveyQuestionList[id].answer = rateValue.length ? rateValue.length.toString() : '';
            break;
        }

        return surveyQuestionList[id].answer;
    }

    function setQuestionAnswer(id) {
        let questionType = surveyQuestionList[id].type;
        let qId = surveyQuestionList[id].questionID;
        let questionAns = surveyQuestionList[id].answer || '';

        switch (questionType) {
        case 'yes-no':
            mg$('input:radio[name=mgPlayerJSProd_capture-guide-radio-' + qId + '][value="' + questionAns + '"]').prop('checked', true);
            break;
        case 'comment':
            mg$('textarea#mgPlayerJSProd_comment_type_' + qId + '').val(questionAns);
            mg$('#mgPlayerJSProd_comment_type_survey_' + qId).html(GmCXt.label.characters + ' ' + questionAns.length);
            checkCommentTypeMess();
            break;
        case 'select':
            mg$('input:radio[name=select_type_option_' + qId + '][value="' + questionAns + '"]').prop('checked', true);
            break;
        case 'multi-select':
            mg$.each(questionAns.split(","), function(index, element) {
                mg$('input:checkbox[name="multiselect_type_option_' + qId + '[]"][value="' + element + '"]').prop('checked', true);
            });
            break;
        case 'range':
            mg$('#mgPlayerJSProd_single-type-question-' + qId + '').find('#mgPlayerJSProd_value-range-' + questionAns + '').addClass('mgPlayerJSProd_value-range-selected');
            break;
        case 'rating':
            mg$('.mgPlayerJSProd_stars-rate').removeClass('mgPlayerJSProd_rating-filled');
            var elem = mg$('#mgPlayerJSProd_single-type-question-' + qId + '').find('#mgPlayerJSProd_rate-' + questionAns + '');
            elem.addClass('mgPlayerJSProd_rating-filled');
            elem.prevAll().addClass('mgPlayerJSProd_rating-filled');
            break;
        }
    }

    function clearSurveyInstance() {
        GmCXt.storage().set({
            'SHOW_SURVEY': null
        });
        GmCXt.storage().remove(['SHOW_SURVEY']);
    }

};
GmCXt.requestHandler.startToolTestMe = function(data) {
    GmCXt.testMe = {};
    GmCXt.testMe.message = mg$.extend(true, {}, data);
    GmCXt.testMe.eventCount = 0;
    GmCXt.testMe.hitCount = 0;
    GmCXt.testMe.steps = data.tour.steps;
    GmCXt.testMe.tourId = data.tour.tour_id;
    GmCXt.testMe.url = data.tour.url;

    GmCXt.closeAppPanel();
    GmCXt.requestHandler.startTestMeWatcher();

    GmCXt.testMe.startTime = Date.now();

    //Number of inline steps in a guide
    GmCXt.testMe.stepCount = 0;

    if (GmCXt.testMe.steps) {
        GmCXt.testMe.goalStep = GmCXt.testMe.steps[GmCXt.testMe.steps.length - 1];

        for (let i = 0, j = GmCXt.testMe.steps.length; i < j; i++) {
            let step = GmCXt.testMe.steps[i];
            if (step.step_type === GmCXt.STEP_TYPE_INLINE) {
                GmCXt.testMe.stepCount++;
            }
        }
    }

    //Expected time to play guide 1 step = 10 sec
    GmCXt.testMe.expectedTime = GmCXt.testMe.stepCount * 10;
    GmCXt.testMe.countDownTime = new Date().getTime() + GmCXt.testMe.expectedTime * 1000;
};

GmCXt.showTestMeCountdown = function() {

    GmCXt.testMe.timer = setInterval(function() {

        if (GmCXt.testMe) {
            let now = new Date().getTime();

            let distance = GmCXt.testMe.countDownTime - now;

            // Time calculations for minutes and seconds
            let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Count down is over
            if (distance < 0) {
                clearInterval(GmCXt.testMe.timer);
                GmCXt.requestHandler.stopToolTestMe();
            } else {
                let str = "";
                if (minutes > 0) {
                    str += minutes + GmCXt.label.charM + " ";
                }
                if (seconds > 0) {
                    str += seconds + GmCXt.label.charS + " ";
                }
                mg$('.mgPlayerJSProd_testme-active-countdown').html(str);
            }
        }
    }, 1000);
};

GmCXt.requestHandler.startTestMeWatcher = function() {

    GmCXt.log(58, 'MyTest started');
    mg$('.mgPlayerJSProd_testme-active').show();
    mg$('.mgPlayerJSProd_testme-active-title').html(GmCXt.label.testMeStopMessage);
    mg$('.mgPlayerJSProd_testme-stop-label').html(GmCXt.label.stop);

    GmCXt.showTestMeCountdown();
    GmCXt.hideWidgetIcon();
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:start_watcher;testMe");
};

GmCXt.requestHandler.recordEventTestMe = function(data) {

    if (!GmCXt.testMe) return;

    GmCXt.log(58, "Recording events for testMe");

    let new_ = data.element;

    if (data.event === 'click') {
        GmCXt.log(58, data.event.toUpperCase() + " Event Occured");
    }

    //Loop through all the steps of a tour
    for (let i = 0; i < GmCXt.testMe.steps.length; i++) {

        let step = GmCXt.testMe.steps[i];

        if (step.step_type === GmCXt.STEP_TYPE_INLINE) {

            let settings = step.step_settings;
            let match = false;

            if (data.event === 'click' &&
				(settings.clickNext === true ||
					settings.onRightClickNext === true ||
					settings.onChangeNext === true ||
					settings.onKeyupNext === true)
            ) {
                GmCXt.testMe.eventCount++;
                match = matchStep(step);

            } else if (data.event === 'mouseover' &&
				(settings.hoverNext === true ||
					settings.keepNext === true ||
					settings.closeAfterDelay === true)
            ) {
                match = matchStep(step);
                if (match === true) {
                    GmCXt.log(58, data.event.toUpperCase() + " Event Occured");
                    GmCXt.testMe.eventCount++;
                }
            }

            if (match === true) {

                GmCXt.log(58, "STEP MATCHED Id: " + step.step_id);
                GmCXt.testMe.hitCount++;
                GmCXt.testMe.steps.splice(i, 1);

                if (GmCXt.testMe.goalStep.step_id == step.step_id) {
                    GmCXt.log(58, "GOAL STEP MATCHED, STOP TEST TOOL");
                    GmCXt.requestHandler.stopToolTestMe();
                } else {
                    break;
                }
            }
        }
    }

    function compareAttributes(elObj, stepEl) {
        let elAttr1 = mg$.extend(true, {}, elObj.meta.elAttributes);
        let elAttr2 = mg$.extend(true, {}, stepEl.meta.elAttributes);

        if (elAttr1 && elAttr2) {
            elAttr1.class = GmCXt.dom.filterValidClasses(elAttr1.class) ? GmCXt.dom.filterValidClasses(elAttr1.class).split('.') : [];
            elAttr2.class = GmCXt.dom.filterValidClasses(elAttr2.class) ? GmCXt.dom.filterValidClasses(elAttr2.class).split('.') : [];
        }

        return GmCXt.compareObjectsByPercentMatch(elAttr1, elAttr2, 60);
    }

    function matchStep(step) {

        let stepSettings = step.step_settings;
        let stepEl = stepSettings.element;
        let match = false;
        let old_ = stepEl;

        if (!mg$.isArray(new_)) {
            new_ = [new_];
        }

        for (let i = 0; i < new_.length; i++) {
            if (compareAttributes(new_[i], old_)) {
                match = true;
                break;
            }
        }
        return match;
    }

    function compareSelector(prop, old, new_) {

        let match = false;
        let oldSelector = old[prop];
        let newSelector = new_[prop];

        if (oldSelector && newSelector) {

            let len = newSelector.length;
            let o = 0;
            let n = 0;

            //Compare each selector
            for (let j = 0; j < len; j++) {
                if (oldSelector[o] === newSelector[n]) {
                    o++;
                    n++;
                    match = true;
                } else if (match === true) {
                    match = false;
                    break;
                }

                if (match === false && oldSelector[o] !== newSelector[n]) {
                    n++;
                }
            }
        }

        return match;
    }
};

GmCXt.requestHandler.stopToolTestMe = function() {
    GmCXt.log(58, 'MyTest ENDED');
    clearInterval(GmCXt.testMe.timer);
    mg$('.mgPlayerJSProd_testme-active').hide();
    GmCXt.testMe.stopTime = Date.now();
    GmCXt.requestHandler.stopTestMeWatcher();
    GmCXt.requestHandler.showTestMeReport();
};

GmCXt.requestHandler.stopTestMeWatcher = function() {
    GmCXt.sendMessageToAllWindows("mgPlayerJSProd_action:stop_watcher;testMe");
};

GmCXt.requestHandler.showTestMeReport = function() {
    GmCXt.testMe.userTime = parseInt((GmCXt.testMe.stopTime - GmCXt.testMe.startTime) / 1000) || 1;
    GmCXt.testMe.testEfficiency = null;
    GmCXt.testMe.testEffectiveness = null;
    GmCXt.testMe.testResult = "Failed";

    if (GmCXt.testMe.hitCount === GmCXt.testMe.stepCount) {

        GmCXt.testMe.testResult = "Passed";

        //(Expected time to complete a guide / Total time taken by user) * 100;
        GmCXt.testMe.testEfficiency =
			parseFloat(((GmCXt.testMe.expectedTime / GmCXt.testMe.userTime) * 100).toFixed(2));

        // (Number of inline steps in a guide / Number of steps performed by user) * 100
        GmCXt.testMe.testEffectiveness =
			parseFloat(((GmCXt.testMe.stepCount / GmCXt.testMe.eventCount) * 100).toFixed(2));
    }

    GmCXt.showTestMeReportUI();

    //call analytics tracker
    GmCXt.trackerV1.trackTestMe(GmCXt.testMe);
    GmCXt.retakeTest = GmCXt.testMe;
    GmCXt.storage().set({
        'testMe': null
    });
    GmCXt.testMe = {steps:[]};
};

GmCXt.showTestMeReportUI = function() {

    let testMeResultHeader =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-test-me-result-header'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-test-me-result-title'>" +
		GmCXt.label.testMeResultTitle +
		"</wmgPlayerJSProd_>" +
		"<button class='mgPlayerJSProd_popup-test-me-result-close mgPlayerJSProd_lbl-btn'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-test-me-close-svg'></wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_title-tooltip-wrapper mgPlayerJSProd_position-bottom-left'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_tooltip-title'>" + GmCXt.label.close + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</button>" +
		"</wmgPlayerJSProd_>";

    let testMeUserResultPass =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_result-passed-container'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_message-icon-passed'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_message-icon-passed-svg'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_message-text-passed'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span'>" + GmCXt.label.testMePassedMessage + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    let testMeUserResultFail =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_result-failed-container'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_message-icon-failed'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span mgPlayerJSProd_message-icon-failed-svg'></wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_message-text-failed'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_span'>" + GmCXt.label.testMeFailedMessage + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    //Get test time in min-sec format
    if (GmCXt.testMe.userTime > 60) {
        var testMeUserTime = Math.floor(GmCXt.testMe.userTime / 60) + " min " +
			parseInt(GmCXt.testMe.userTime - Math.floor(GmCXt.testMe.userTime / 60) * 60) + " sec";
    } else {
        var testMeUserTime = Math.floor(GmCXt.testMe.userTime) + " sec";
    }

    if (GmCXt.testMe.expectedTime > 60) {
        var testMeExpectedTime = Math.floor(GmCXt.testMe.expectedTime / 60) + " min " +
			parseInt(GmCXt.testMe.expectedTime - Math.floor(GmCXt.testMe.expectedTime / 60) * 60) + " sec";
    } else {
        var testMeExpectedTime = Math.floor(GmCXt.testMe.expectedTime) + " sec";
    }

    GmCXt.testMe.testMeExpectedTime = testMeExpectedTime;

    let testMeEfficiency = GmCXt.testMe.testEfficiency;
    let testMeEffectiveness = GmCXt.testMe.testEffectiveness;
    if (GmCXt.testMe.testEfficiency === null ||
		GmCXt.testMe.testEffectiveness === null) {

        testMeEfficiency = 0;
        testMeEffectiveness = 0;
    }

    let efficiencyResult =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-guide-efficiency'>" +
		GmCXt.label.testMeGuideEfficiency + " " + testMeEfficiency + "%" +
		"</wmgPlayerJSProd_>";

    let effectivenessResult =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-guide-effectiveness'>" +
		GmCXt.label.testMeGuideEffectiveness + " " + testMeEffectiveness + "%" +
		"</wmgPlayerJSProd_>";

    let testEfficiency =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_guide-efficiency-wrapper'>" +
		efficiencyResult +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_verticle-line'>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-time-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_time-taken-text'>" + GmCXt.label.testMeTestTime + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_time-user'>" + testMeUserTime + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-expected-time-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_expected-time-text'>" + GmCXt.label.testMeExpectedTime + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_time-expected'>" + testMeExpectedTime + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    let testEffectiveness =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_guide-effectiveness-wrapper'>" +
		effectivenessResult +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_verticle-line'>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-test-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_test-steps-text'>" + GmCXt.label.testMeStepsTaken + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_count-steps'>" + GmCXt.testMe.eventCount + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_text-required-steps-wrapper'>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_required-steps-text'>" + GmCXt.label.testMeExpectedSteps + "</wmgPlayerJSProd_>" +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_count-steps'>" + GmCXt.testMe.stepCount + "</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    if (GmCXt.testMe.testResult === "Passed") {
        var bottomButtons =
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_test-me-btn-action'>" +
			"<button class='mgPlayerJSProd_btn-default mgPlayerJSProd_btn-neutral mgPlayerJSProd_btn-esc-test-me mgPlayerJSProd_inline-block-vt mgPlayerJSProd_lbl-btn'>" + GmCXt.label.close + "</button>" +
			"</wmgPlayerJSProd_>";
    } else {
        var bottomButtons =
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_test-me-btn-action'>" +
			"<button class='mgPlayerJSProd_btn-default mgPlayerJSProd_btn-start-test mgPlayerJSProd_inline-block-vt mgPlayerJSProd_lbl-btn'>" + GmCXt.label.testMeRetakeTestBtn + "</button>" +
			"<button class='mgPlayerJSProd_btn-default mgPlayerJSProd_btn-neutral mgPlayerJSProd_btn-esc-test-me mgPlayerJSProd_inline-block-vt mgPlayerJSProd_lbl-btn'>" + GmCXt.label.close + "</button>" +
			"</wmgPlayerJSProd_>";
    }

    let testMeFailedDescription = "";

    if (GmCXt.testMe.testResult === "Passed") {
        testMeUserResultFail = "";
    } else {
        testMeUserResultPass = "";
        testEfficiency = "";
        testEffectiveness = "";

        //Show this message instead of Test Efficiency and Test Effectiveness when Test is failed.

        let msg = GmCXt.label.testMeFailedErrorMessage;
        msg = msg.replace(/{CORRECT_STEPS}/g, GmCXt.testMe.hitCount);
        msg = msg.replace(/{TOTAL_STEPS}/g, GmCXt.testMe.stepCount);

        testMeFailedDescription = "<wmgPlayerJSProd_ class='mgPlayerJSProd_text-guide-message-failed'>" + msg + "</wmgPlayerJSProd_>";
    }

    let html =
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-test-me-result-preview'>" +
		testMeResultHeader +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-test-me-result-container'>" +
		testMeUserResultFail +
		testMeUserResultPass +
		"<wmgPlayerJSProd_ class='mgPlayerJSProd_result-score-container'>" +
		testEfficiency +
		testEffectiveness +
		testMeFailedDescription +
		"</wmgPlayerJSProd_>" +
		bottomButtons +
		"</wmgPlayerJSProd_>" +
		"</wmgPlayerJSProd_>";

    mg$("html").append(html);

    mg$(".mgPlayerJSProd_popup-test-me-close-svg").html(GmCXt.svgs.close_btn);
    mg$(".mgPlayerJSProd_message-icon-passed-svg").html(GmCXt.svgs.testme_result_passed);
    mg$(".mgPlayerJSProd_message-icon-failed-svg").html(GmCXt.svgs.testme_result_failed);

    function closeTestMeReport() {
        mg$('.mgPlayerJSProd_popup-test-me-result-preview').hide();
        GmCXt.openAppPanel();
        GmCXt.displayWidget();
        GmCXt.testMe = null;
        GmCXt.storage().set({
            'testMe': null
        });
    }

    function reStartTestMe() {
        GmCXt.testMe = GmCXt.retakeTest;
        GmCXt.storage().set({
            'testMe': GmCXt.testMe
        });
        mg$('.mgPlayerJSProd_popup-test-me-result-preview').hide();
        GmCXt.hideWidgetIcon();
        let testMeMessage = mg$.extend(true, {}, GmCXt.testMe.message);

        //Start TestMe Tool
        GmCXt.testMe = null;
        GmCXt.storage().set({
            'testMe': null
        });
        GmCXt.requestHandler.startToolTestMe(testMeMessage);
        let firstStepId = testMeMessage.tour.tour_settings.play_structure[0].id;
        let firstStep = GmCXt.getStepFromSteps(firstStepId, testMeMessage.tour.steps);
        const currentUrl = new URL(window.location.href);
        const guideUrl = new URL(`https://${firstStep.step_url}`);
        if (guideUrl.hostname !== currentUrl.hostname || guideUrl.pathname !== currentUrl.pathname) {
            window.location.href = `https://${firstStep.step_url}`;
        }
    }

    //Close report on clicking close icon/Esc button
    mg$(".mgPlayerJSProd_popup-test-me-result-close").on("click", closeTestMeReport);
    mg$(".mgPlayerJSProd_btn-esc-test-me").on("click", closeTestMeReport);

    mg$(".mgPlayerJSProd_btn-start-test").on("click", reStartTestMe);

};

GmCXt.requestHandler.checkTestMeDomain = function(data) {
    GmCXt.storage().set({
        'testMe': null
    });
    GmCXt.closeAppPanel();
    let windowHost = GmCXt.getPageDomain();
    let stepUrlHost = GmCXt.getDomain(data.tour.steps[0].step_url);

    if (windowHost !== stepUrlHost) {
        return false;
    } else {
        return true;
    }

};

GmCXt.requestHandler.redirectToUrl = function(data) {

    function button1Callback() {
        GmCXt.storage().set({
            'testMe': data
        }).then(function() {
            window.open('https://' + data.tour.steps[0].step_url, '_blank');
        });
    }

    let options = {
        description: GmCXt.label.ConfirmIfTestMeModeRidirect,
        button1: GmCXt.label.redirect,
        button1Callback: button1Callback,
        button2: GmCXt.label.btnCancel
        // button2Callback: button2Callback
    };

    GmCXt.alertV1(options).show();

};

GmCXt.alertV1 = function(options) {
    options = options || {};

    let pub = {};

    let self = {
        description: options.description,
        button1: options.button1,
        button1Callback: options.button1Callback,
        button2: options.button2,
        button2Callback: options.button2Callback,
        keepScrollLock: options.keepScrollLock || false,
        closeTour: false,
        showInputField: options.showInputField || false
    };

    let popupInputField = 'none';
    if (self.showInputField) {
        popupInputField = 'block';
    }
    pub.show = function() {

        let html = " <wmgPlayerJSProd_ class='mgPlayerJSProd_overlay-container'></wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup'>" +
			"<img class='mgPlayerJSProd_popup-close-button' src='" + GmCXt.conf.staticContentPath + "close.png'/>" +
			"<wmgPlayerJSProd_ style='display:" + popupInputField + "'><input type='text'  maxlength='250' class='mgPlayerJSProd_popup-input-field'/></wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-content-wrapper'>" + self.description + "</wmgPlayerJSProd_>" +
			"<wmgPlayerJSProd_ class='mgPlayerJSProd_popup-btn-wrapper'>";

        if (self.button1) {
            html += "<wmgPlayerJSProd_ title='" + self.button1 + "' aria-label='popup " + self.button1 + " button' class='mgPlayerJSProd_popup-ok-btn mgPlayerJSProd_btn-default mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt'>" + self.button1 + "</wmgPlayerJSProd_>";
        }
        if (self.button2) {
            html += "<wmgPlayerJSProd_ title='" + self.button2 + "' aria-label='popup " + self.button2 + " button' class='mgPlayerJSProd_popup-cancel-btn mgPlayerJSProd_btn-default mgPlayerJSProd_text-overflow-ellipsis mgPlayerJSProd_inline-block-vt'>" + self.button2 + "</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";
        }
        html += "</wmgPlayerJSProd_>";

        mg$("html").append(html);

        let windowHeight = mg$(window).height();
        let popupTop = (windowHeight - mg$('.mgPlayerJSProd_popup').height()) / 2;
        mg$('.mgPlayerJSProd_popup').css("top", popupTop);

        mg$(".mgPlayerJSProd_popup-ok-btn").on("click", function() {
            let popupInputFieldValue = mg$('.mgPlayerJSProd_popup-input-field').val();
            pub.close();
            if (mg$.isFunction(self.button1Callback))
                self.button1Callback(popupInputFieldValue);
        });

        mg$(".mgPlayerJSProd_popup-cancel-btn").on("click", function() {
            pub.close(self.keepScrollLock);
            GmCXt.openAppPanel();
        });

        mg$(".mgPlayerJSProd_popup-close-button").on("click", function() {
            pub.close(self.keepScrollLock);
        });
    };

    pub.close = function(keepScrollLock) {

        if (!keepScrollLock)
            GmCXt.unlockScroll();

        mg$(".mgPlayerJSProd_popup").remove();
        mg$(".mgPlayerJSProd_overlay-container").remove();
    };

    return pub;
};
/**
	* @file Guideme HTTP service
	* @author Nilesh Pachpande
	*/

GmCXt.userApiKeySignin = function(data) {

    let myGuideOrgKey = data.myGuideOrgKey;
    delete data.myGuideOrgKey;

    let serviceName = GmCXt.getCustomerSpecificURL("user/sso/login");
    serviceName = serviceName + '?mg_source_name=' + GmCXt.conf.appConfig.customer;

    let params = {
        url: serviceName,
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            "Authorization": myGuideOrgKey
        },
        data: JSON.stringify(data)
    };
    return GmCXt.xhr(params);
};

GmCXt.getAnonymousUserPrefrence = function(data, accesstoken) {

    let params = {
        url: 'user/preference',
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            AccessToken: accesstoken
        },
        data: JSON.stringify(data)
    };
    return GmCXt.xhr(params);
};

GmCXt.setAnonymousUserPrefrence = function(data) {

    let params = {
        url: 'user/preference',
        method: 'PUT',
        headers: {
            'Content-Type': "application/json",
            AccessToken: GmCXt.user.accesstoken
        },
        data: JSON.stringify(data)
    };
    return GmCXt.xhr(params);
};


GmCXt.apiGetHandOffToken = function() {
    let params = {
        url: "accounts/v1/handoff-token/generate/",
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            AccessToken: GmCXt.user.accesstoken,
            RefreshToken: GmCXt.user.refreshtoken
        },
        data: ''
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiRegisterClientInsight = function() {
    let params = {
        url: "event/v1/client/register/?org_id=" + GmCXt.organization.organization_id,
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            AccessToken: GmCXt.user.accesstoken
        },
        data: ''
    };
    return GmCXt.xhrAnalytics(params, true);
};

GmCXt.apiGetClientSecretInsight = function(o) {
    let params = {
        url: "event/v1/client/secret/?org_id=" + GmCXt.organization.organization_id,
        method: 'POST',
        headers: {
            'Content-Type': "application/json"
        },
        data: JSON.stringify({
            "app_client_id": o
        })
    };
    return GmCXt.xhrAnalytics(params, true);
};

GmCXt.apiTrackEventV1 = function(o) {

    let params = {
        url: "event/v1/push/?org_id=" + o.payload[0].org_id + "&app_code=" + o.payload[0].app_code + "&event_type=" + o.payload[0].event_type,
        method: 'POST',
        headers: {
            'Content-Type': "application/json"
        },
        data: JSON.stringify(o)
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apitrackSentiment = function(o) {
    let params = {
        url: "register/v1/sentiment/report/",
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: JSON.stringify(o)
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apitrackConversation = function(o) {
    let params = {
        url: "register/v1/conversation/report/",
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: JSON.stringify(o)
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiGetSentiment = function(o) {
    let url = "";
    if (o.app_code) {
        url = "sentiments/v1/questionaire/?app_code=" + o.app_code + "&sentiment_code=" + o.sentiment_code +
			"&time_zone=utc+0530";
    } else {
        url = "sentiments/v1/questionaire/?sentiment_code=" + o.sentiment_code +
			"&time_zone=utc+0530";
    }
    let params = {
        url: url,
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: ''
    };

    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiGetBotConv = function(o) {
    let url = "";
    if (o.app_code) {
        url = "conversations/v1/questionaire/?app_code=" + o.app_code + "&conversation_code=" + o.conversation_code +
			"&time_zone=utc+0530";
    } else {
        url = "conversations/v1/questionaire/?conversation_code=" + o.conversation_code +
			"&time_zone=utc+0530";
    }
    let params = {
        url: url,
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: ''
    };

    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiGetSentiments = function(o) {
    let url = "";
    if (o.app_code) {
        url = "sentiments/v1/list/?app_code=" + o.app_code + "&sort_by=sentiment_title&order=asc&page_index=" +
			o.pageIndex + "&page_size=" + o.pageSize;
    } else {
        url = "sentiments/v1/list/?sort_by=sentiment_title&order=asc&page_index=" +
			o.pageIndex + "&page_size=" + o.pageSize;
    }
    let params = {
        url: url,
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: ''
    };

    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiGetBotConvList = function(o) {
    let url = "";
    if (o.app_code) {
        url = "conversations/v1/list/?app_code=" + o.app_code + "&sort_by=conversation_title&order=asc&page_index=" +
			o.pageIndex + "&page_size=" + o.pageSize;
    } else {
        url = "conversations/v1/list/?sort_by=conversation_title&order=asc&page_index=" +
			o.pageIndex + "&page_size=" + o.pageSize;
    }
    let params = {
        url: url,
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: ''
    };

    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiAIData = function(app_code) {
    let params = {
        url: "metadata/v1/guide/suggestions/?app_code=" + app_code + "&min_occurances=100&min_no_of_steps=5",
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken:  GmCXt.user.accesstoken,
        },
        data: ''
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiUpdateUserProfile = function(user) {
    user.settings = JSON.stringify(user.settings);
    let params = {
        url: "user",
        method: 'PUT',
        data: JSON.stringify(user)
    };
    return GmCXt.xhr(params);
};

GmCXt.apiUpdateUserGuidevView = function(data) {
    let guideView = {
        guide_view: JSON.stringify(data)
    };

    let params = {
        url: "user/guide_view",
        method: 'PUT',
        data: JSON.stringify(guideView)
    };
    return GmCXt.xhr(params);
};

GmCXt.logoutUser = function() {
    if(GmCXt.isBackgroundPage){
        GmCXt.msgToApp('mgPlayerJSProd_action:to_signin_page', {}, senderTabId);
    }else{
        GmRootScope.clearSession("1003: Access token invalid");
    }
};

GmCXt.loginFromConsole = function(email, password) {
    if (!GmCXt.isBackgroundPage) {
        const loginCredentials = {
            email: email,
            password: password
        };
        GmRootScope.loginFromConsole(loginCredentials);
    }
};

GmCXt.saveMyBotReport = function(o) {
    let params = {
        url: "register/v1/mybot/report/",
        method: 'POST',
        headers: {
            'Content-Type': "application/json",
            'AccessToken': GmCXt.user.accesstoken
        },
        data: JSON.stringify(o)
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.apiGetSegmentGroupList = function(o) {
    let params = {
        url: "segment/group/list?organization_id=" + o.organization_id,
        method: "GET",
        headers: {
            'Content-Type': "application/json"
        },
        data: ''
    };
    return GmCXt.xhr(params);
};

GmCXt.callGetCdnSignature = function(data) {

    let params = {
        url: 'organization/signature?',
        method: 'GET',
        headers: {
            'Content-Type': "application/json"
        },
        data: GmCXt.encode(data)
    };
    return GmCXt.xhr(params);
};

GmCXt.sendFeedbackEmail = function(obj) {
    let params = {
        url: "organization/feedback",
        method: 'POST',
        headers: {
            'Content-Type': "application/json"
        },
        data: JSON.stringify(obj)
    };
    return GmCXt.xhr(params);
};

GmCXt.getSearchURL = function(url, searchData) {
    let searchParams = new URLSearchParams(searchData);
    let searchParamsStr = searchParams.toString();
    if (searchParamsStr.length && searchParamsStr.indexOf("?") === -1 && url.indexOf("?") === -1) {
        searchParams = "?" + searchParams.toString();
    }
    url = url + searchParams;
    return url;
};

GmCXt.xhr = function(params, doNotAddWebURL, extApi) {

    return new Promise(function(resolve, reject) {
        let host = "";

        if (!GmCXt.isEmpty(GmCXt.urlParts)) {
            host = GmCXt.urlParts.host;
        }

        let headers = {
            'x-mg-host': host,
            'x-mg-source': GmCXt.conf.appName,
            'x-mg-orgId': ''
        };

        let showMaintenance = function() {
            if (GmCXt.isBackgroundPage === true) {
                GmCXt.sendMessageToPanel('mgPlayerJSProd_action:maintenance');
            } else {
                GmRootScope.goToMaintenance();
            }
        };

        let onError = function(error) {
            if (error) {
                error.url = params.url;
                error.paramsData = params.data;
                error.method = params.method;

                let code = error.code;

                if (code == 1003 || code === 2004 || (code === 2036 && (error.url.indexOf('user/signout') !== -1 || error.url.indexOf('user/token') !== -1))) { // AccessToken Invalid || Session Expired
                    if (GmCXt.isBackgroundPage) {
                        GmCXt.createStepJobs = [];
                    }
                    if (code === 2036 && error?.data?.remove_cookie && GmCXt.user?.ssoSignInTrue) {
                        GmRootScope.removeCookieWithSSO().then(function(){
                            GmCXt.logoutUser();
                            reject(error);
                        });
                    } else {
                        GmCXt.logoutUser();
                        reject(error);
                    } 
                    

                } else if (code == 1007) { // AccessToken expired
                    GmCXt.getAccessToken().then(function(r) {
                        GmCXt.saveToken(r);
                        headers.AccessToken = GmCXt.user.accesstoken;
                        callApi_();
                    }).catch(function(e) {
                        console.error('Error while fetching access token', e);
                        GmCXt.logoutUser();
                    });

                } else if (code === 1014) {
                    showMaintenance();
                    reject(error);

                } else {
                    reject(error);
                }

            } else {
                reject();
            }
        };

        let onSuccess = function(result) {

            result.code = parseInt(result.code);

            if (doNotAddWebURL) {
                resolve(result);
                return;
            }

            let code = result.code;
            if (result.error === false) {

                if (params.url && params.url.indexOf('user/token') !== -1) {
                    result = GmCXt.validateDataModel(result.data, GmCXt.model.userToken);
                }
                if (params.onSuccess) {
                    params.onSuccess(result);
                }

                resolve(result);
            } else if (code === 1005) {
                resolve(result);

            } else if (code === 1018) {
                resolve(result);

            } else if (code === 1014) {
                showMaintenance();
                reject(result);

            } else if (code == 1003 || code == 2004 || (code === 2036 && (params.url.indexOf('user/signout') !== -1 || params.url.indexOf('user/token') !== -1))) { // AccessToken Invalid || Session Expired

                if (GmCXt.isBackgroundPage) {
                    GmCXt.createStepJobs = [];
                }
                if (code === 2036 &&  result?.data?.remove_cookie && GmCXt.user?.ssoSignInTrue) {
                    GmRootScope.removeCookieWithSSO().then(function(){
                        GmCXt.logoutUser();
                        reject(result);
                    });
                } else {
                    GmCXt.logoutUser();
                    reject(result);
                }
                

            } else if (code == 1007) { // AccessToken expired
                GmCXt.getAccessToken().then(function(r) {
                    GmCXt.saveToken(r);
                    headers.AccessToken = GmCXt.user.accesstoken;
                    callApi_();
                }).catch(function(e) {
                    console.error('Error while fetching access token', e);
                    GmCXt.logoutUser();
                });

            } else {
                reject(result);
            }
        };

        function callApi_() {
            GmCXt.trackApiCalls();
            for (let key in params.headers) {
                if (params.headers.hasOwnProperty(key)) headers[key] = params.headers[key];
            }

            if (GmCXt.user && GmCXt.organization) {
                headers.appType = GmCXt.conf.appType;
                headers.orgId = GmCXt.organization.organization_id;
                headers['x-mg-orgId'] = GmCXt.organization.organization_id;

                headers.AccessToken = GmCXt.user.accesstoken;

                processApi();
            } else {
                GmCXt.getDatafromPanel().then(function(d) {
                    GmCXt.user = d.user;
                    GmCXt.organization = d.organization;
                    if (GmCXt.user) {
                        headers.appType = GmCXt.conf.appType;
                        headers.orgId = GmCXt.organization.organization_id;
                        headers.AccessToken = GmCXt.user.accesstoken;
                        headers['x-mg-orgId'] = GmCXt.organization.organization_id;
                    }
                    processApi();
                }).catch(function(e) {
                    console.log('Error while fetching user data', e);
                });
            }
        }

        function processApi() {

            let url = GmCXt.conf.webServiceUrl + "" + params.url;

            if (doNotAddWebURL) {
                url = params.url;
            }

            if (params.method === 'GET') {

                fetch(GmCXt.getSearchURL(url, params.data), {
                    headers: headers,
                    method: params.method
                })
                    .then(function(response) {
                        GmCXt.activeApiCallCount--;
                        if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                        if (doNotAddWebURL && !extApi) {

                            if (response.status === 200) {
                                resolve();
                            } else {
                                reject();
                            }

                        } else {
                            response.json()
                                .then(onSuccess)
                                .catch(onError);
                        }

                    }).catch(onError);

            } else {
                fetch(url, {
                    headers: headers,
                    method: params.method,
                    body: params.data
                })
                    .then(function(response) {
                        GmCXt.activeApiCallCount--;
                        if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                        response.json()
                            .then(onSuccess)
                            .catch(onError);
                    }).catch(onError);
            }
        }

        callApi_();
    });
};

GmCXt.getDetailTour = function(o) {
    return new Promise(function(resolve, reject) {
        let params = {
            url: "tour",
            method: 'GET',
            headers: {
                'Content-Type': "application/json"
            },
            data: GmCXt.encode(o)
        };

        function gotTour(tour) {
            tour = GmCXt.migrateTour(tour);

            resolve(tour);
        }

        function onSuccess(r) {
            if (r && r.data) {
                GmCXt.validateApiResp(gotTour,
                    "tour",
                    r.data.tour,
                    GmCXt.model.guide);
            } else {
                resolve();
            }
        }

        GmCXt.xhr(params).then(onSuccess);
    });
};

GmCXt.apiUpdateUserSettings = function(data, cb) {
    let params = {
        url: "user/update_settings",
        method: "POST",
        serviceType: "",
        data: JSON.stringify(data)
    };

    GmCXt.xhr(params).then(cb);
};

GmCXt.apiGetInsightPagesRules = function(appCode) {
    let params = {
        url: "tracker/v1/page/rules/?app_code=" + appCode,
        method: 'GET',
        headers: {
            'Content-Type': "application/json",
            accesstoken: GmCXt.user.accesstoken
        },
        data: ''
    };
    return GmCXt.xhrAnalytics(params);
};

GmCXt.xhrAnalytics = function(params, isInsight) {

    return new Promise(function(resolve, reject) {

        function OnAccessTokenError() {
            GmCXt.getAccessToken().then(function(r) {
                r = r || {};
                GmCXt.saveToken(r);

                params.headers.accesstoken = GmCXt.user.accesstoken;
                ajax();
            }).catch(function(e) {
                console.error('Error while fetching access token', e);
                GmCXt.logoutUser();
            });
        }

        let onSuccess = function(result) {

            result = GmCXt.parseJSON(result);

            if (result.status === 'success') {

                if (result.data.event_chain_id) {
                    if (isInsight) {
                        GmCXt.INSIGHTS_EVENT_CHAIN_ID = result.data.event_chain_id;
                    } else {
                        GmCXt.ANALYTICS_EVENT_CHAIN_ID = result.data.event_chain_id;
                    }
                }
                resolve(result);
            } else {
                if (!GmCXt.isEmpty(result) && GmCXt.isDefined(result.status) &&
					result.status === 'error' &&
					result.description === "Access token expired.") {
                    OnAccessTokenError();
                } else {
                    reject(result);
                }
            }
        };

        let onError = function(xhr) {

            console.log(xhr);
            if (xhr.responseJSON) {

                if (xhr.responseJSON.description == "Access token expired.") {
                    OnAccessTokenError();

                } else {
                    var error = xhr.responseJSON;
                    error.apiUrl = params.url;
                    reject(error);
                }
            } else {
                reject(error);
            }
        };

        function ajax() {
            GmCXt.trackApiCalls(false, true);
            var url = GmCXt.conf.analyticsPath + "" + params.url;

            if (params.method === 'GET') {

                fetch(GmCXt.getSearchURL(url, params.data), {
                    headers: params.headers,
                    method: params.method
                })
                    .then(function(response) {
                        
                        GmCXt.activeApiCallCount--;
                        if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                        
                        response.json()
                            .then(function(r) {
                                onSuccess(r);
                            })
                            .catch(onError);
                    });

            } else {
                fetch(url, {
                    headers: params.headers,
                    method: params.method,
                    body: params.data
                })
                    .then(function(response) {
                        
                        GmCXt.activeApiCallCount--;
                        if(!GmCXt.isBackgroundPage)  GmRootScope.hideLoading();
                        
                        response.json()
                            .then(onSuccess)
                            .catch(onError);
                    });
            }
        }

        let org = GmCXt.organization;

        if (!GmCXt.isEmpty(GmCXt.conf.analyticsPath) &&
			((org && org.admin_settings.insights.enabled) || params.url.indexOf("handoff-token") != -1 || GmCXt.isLogoutTrackApi || params.url.indexOf("sentiment") != -1)) {
            ajax();
        } else {
            reject();
        }
    });
};
GmCXt.guideMeApiProvider = function() {

    let pub = {};

    pub.getUser = function(o) {
        let params = {
            url: "user",
            method: 'GET',
            headers: {
                'Content-Type': "application/json"
            },
            data: GmCXt.encode(o)
        };
        return GmCXt.xhr(params);
    };

    pub.getVideoUploadUrl = function(data) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/upload/url?",
            method: 'GET',
            headers: {},
            data: GmCXt.encode(data)
        };
        return GmCXt.xhr(params);
    };

    pub.getVideoUploadUrl_AWS = function(data) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/presigned/upload/url?",
            method: "GET",
            headers: {},
            data: GmCXt.encode(data)
        };
        return GmCXt.xhr(params);
    };

    pub.getVideoUploadUrl_IBM = function(data) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/presigned/upload/url?",
            method: "GET",
            headers: {},
            data: GmCXt.encode(data)
        };
        return GmCXt.xhr(params);
    };

    pub.videoUploadStatus = function(data) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/upload/status",
            method: 'POST',
            headers: {},
            data: JSON.stringify(data)
        };
        return GmCXt.xhr(params);
    };

    pub.videoUploadStatusAWS = function(data) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/upload/status/aws",
            method: 'POST',
            headers: {},
            data: JSON.stringify(data)
        };
        return GmCXt.xhr(params);
    };

    pub.uploadFTPFile = function(data, successCb, errorCb) {
        data.organization_id = GmCXt.organization.organization_id;
        let params = {
            url: "file/upload/ftp",
            method: "POST",
            serviceType: "",
            data: data,
            fileInput: true,
            onSuccess: successCb,
            onFail: errorCb
        };
        return GmCXt.xhr(params);
    };

    pub.createBulkStep = function(d) {
        let params = {
            url: "step/bulk/create",
            method: 'POST',
            headers: {},
            data: JSON.stringify(d)
        };
        return GmCXt.xhr(params);
    };

    pub.createStep = function(o) {
        let params = {
            url: "step",
            method: 'POST',
            headers: {},
            data: JSON.stringify(o.args)
        };
        return GmCXt.xhr(params);
    };

    pub.deleteStep = function(data) {

        let params = {
            url: 'step',
            method: 'DELETE',
            data: JSON.stringify(data)
        };

        return GmCXt.xhr(params);
    };

    pub.updateTour = function(data) {
        let params = {
            url: 'tour',
            method: 'PUT',
            headers: {},
            data: JSON.stringify(data)
        };

        return GmCXt.xhr(params);
    };

    pub.updateStep = function(o) {
        let params = {
            url: "step",
            method: 'PUT',
            headers: {},
            data: JSON.stringify(o.args)
        };
        return GmCXt.xhr(params);
    };

    pub.updateStepLang = function(o) {
        let params = {
            url: "step/language/update",
            method: 'PUT',
            headers: {},
            data: JSON.stringify(o.args)
        };
        return GmCXt.xhr(params);
    };

    pub.uploadFileBase64 = function(o) {
        let params = {
            url: "file/base64image",
            method: 'POST',
            headers: {},
            data: o.args
        };
        return GmCXt.xhr(params);
    };

    pub.uploadBase64ImageFile = function(o) {
        let params = {
            url: "file/upload/base64image",
            method: 'POST',
            headers: {},
            data: o.args
        };
        return GmCXt.xhr(params);
    };

    pub.uploadFile = function(o) {
        o.args.append("organization_id", GmCXt.organization.organization_id);
        let params = {
            url: "file/image",
            method: 'POST',
            headers: {},
            data: o.args
        };
        return GmCXt.xhr(params);
    };

    pub.updateUserProfile = GmCXt.apiUpdateUserProfile;
    pub.getHandOffToken = GmCXt.apiGetHandOffToken;
    pub.getSentiments = GmCXt.apiGetSentiments;
    pub.getBotConvList = GmCXt.apiGetBotConvList;
    pub.getAIData = GmCXt.apiAIData;
    pub.getSentiment = GmCXt.apiGetSentiment;
    pub.getGetBotConv = GmCXt.apiGetBotConv;
    pub.getSegmentGroupList = GmCXt.apiGetSegmentGroupList;
    pub.userApiKeySignin = GmCXt.userApiKeySignin;
    pub.registerClientInsight = GmCXt.apiRegisterClientInsight;
    pub.getClientSecretInsight = GmCXt.apiGetClientSecretInsight;
    pub.trackEventV1 = GmCXt.apiTrackEventV1;
    pub.saveMyBotReport = GmCXt.saveMyBotReport;
    pub.trackSentiment = GmCXt.apitrackSentiment;
    pub.trackConversation = GmCXt.apitrackConversation;
    pub.getCdnSignature = GmCXt.callGetCdnSignature;
    pub.getDetailTour = GmCXt.getDetailTour;
    pub.sendFeedbackEmail = GmCXt.sendFeedbackEmail;
    pub.getAnonymousUserPrefrence = GmCXt.getAnonymousUserPrefrence;
    pub.setAnonymousUserPrefrence = GmCXt.setAnonymousUserPrefrence;
    pub.getInsightPagesRules = GmCXt.apiGetInsightPagesRules;
    pub.apiUpdateUserSettings  = GmCXt.apiUpdateUserSettings;

    return pub;
};

if (!GmCXt.isPlayer()) {
    GmCXt.api = GmCXt.guideMeApiProvider();
}
/*global GmCXt*/
GmCXt.apiPlayerProvider = function() {

    let pub = {};

    pub.updateUserProfile = GmCXt.updateUserProfile;
    pub.getSentiments = GmCXt.apiGetSentiments;
    pub.getBotConvList = GmCXt.apiGetBotConvList;
    pub.getSentiment = GmCXt.apiGetSentiment;
    pub.getGetBotConv = GmCXt.apiGetBotConv;
    pub.getSegmentGroupList = GmCXt.apiGetSegmentGroupList;
    pub.userApiKeySignin = GmCXt.userApiKeySignin;
    pub.registerClientInsight = GmCXt.apiRegisterClientInsight;
    pub.getClientSecretInsight = GmCXt.apiGetClientSecretInsight;
    pub.trackEventV1 = GmCXt.apiTrackEventV1;
    pub.saveMyBotReport = GmCXt.saveMyBotReport;
    pub.trackSentiment = GmCXt.apitrackSentiment;
    pub.trackConversation = GmCXt.apitrackConversation;
    pub.getHandOffToken = GmCXt.apiGetHandOffToken;
    pub.getCdnSignature = GmCXt.callGetCdnSignature;
    pub.getDetailTour = GmCXt.getDetailTour;
    pub.sendFeedbackEmail = GmCXt.sendFeedbackEmail;
    pub.getAnonymousUserPrefrence = GmCXt.getAnonymousUserPrefrence;
    pub.setAnonymousUserPrefrence = GmCXt.setAnonymousUserPrefrence;
    pub.getInsightPagesRules = GmCXt.apiGetInsightPagesRules;
    pub.apiUpdateUserSettings  = GmCXt.apiUpdateUserSettings;
    
    return pub;
};

if (GmCXt.isPlayer()) {
    GmCXt.api = GmCXt.apiPlayerProvider();
}

/**
	* @file Boot script
	* This code is executed only once, immediately after content script is injected
	* into a webpage.
	* @author Nilesh Pachpande
	*/

GmCXt.client = {
    'isUrlTour': false
};
GmCXt.user = false;
GmCXt.organization = false;
GmCXt.myGuideApps = {};
GmCXt.initialization = {};
GmCXt.beaconTours = [];
GmCXt.beaconsOnScreen = [];

GmCXt.onScreenTooltipGuideInfo = {}; //Info about tooltip guides with rules matched on the screen
GmCXt.onScreenTooltipGuideIds = []; //Tooltip guides with all tooltips are visible on screen
GmCXt.partialVisibleTooltipsIds = []; //Tooltip guides with at least one but less than total tooltips are visible on screen

GmCXt.urlBasedTours = [];
GmCXt.tooltipTours = [];
GmCXt.fTags = [];
GmCXt.beaconIframe = {};
GmCXt.smartTipIframe = {};
GmCXt.tagIframe = {};
GmCXt.rulesIframeQueue = [];
GmCXt.dragWidgetPose = {};
GmCXt.dragChatPose = {};

GmCXt.initLoading = new Date().getTime();
GmCXt.pageLoadTime = 0;

GmCXt.idleTime = 0;
GmCXt.idleActivityInterval;

mg$(window).on('load', function() {
    GmCXt.pageLoadTime = new Date().getTime() - GmCXt.initLoading;
    GmCXt.startIdleActivityTimer();
});

window.addEventListener('beforeunload', () => {
    if(GmCXt.mailToClicked) {
        GmCXt.mailToClicked = false;
        return;
    }
    GmCXt.onWinUnload();
});

GmCXt.main();

GmCXt.currentUrl = GmCXt._location().href;

GmCXt.gIntervalNumber = 0;

setInterval(function() {
    GmCXt.gIntervalNumber++;

    if (GmCXt.FT.isPlayer && GmCXt.isClientJs() && GmCXt.conf.appConfig.iframeInjection) {
        GmCXt.injectGuideMeInIframes(window);
    }
    GmCXt.triggerChangeListeners();

    // Update beacons and tooltips in newly found iframes in last 1 sec
    if (GmCXt.gIntervalNumber % 2 === 0 && GmCXt.newIframesFound) {
        GmCXt.newIframesFound = false;
        GmCXt.sendMessageToRenderBeacons();
        GmCXt.sendMessageToRenderSmartTip();
    }

}, 500); //Do Not Change the timer.

document.addEventListener('mousedown', GmCXt.onDocumentMouseDown);

document.addEventListener('mouseup', GmCXt.triggerChangeListeners);

document.addEventListener('visibilitychange', GmCXt.onVisibilityChange);

document.addEventListener('mousemove', GmCXt.resetIdleActivityTimer);
document.addEventListener('touchstart', GmCXt.resetIdleActivityTimer);

document.addEventListener("keypress", function(event) {

    GmCXt.resetIdleActivityTimer();

    let org = GmCXt.organization;
    if(!GmCXt.isEmpty(org) && org.admin_settings && org.admin_settings.keyboard_shortcuts &&
		org.admin_settings.keyboard_shortcuts === "0"){
        return;
    }

    if (event.keyCode == 63) {
        GmCXt.storage().get(['login_state']).then(function(o) {
            if (o.login_state) {
                GmCXt.showKeyCodePopUp();
            }
        });
    }

    let key = '';

    let keycharc = "";
    if (event.code.indexOf("Key") !== -1) {
        keycharc = event.code.replace("Key", '');
    } else {
        keycharc = unescape(encodeURIComponent(event.key));
    }

    if (event.shiftKey) {
        key = "shift+" + keycharc.toLowerCase();
    }

    if (!GmCXt.isEmpty(key) && GmCXt.isEmpty(GmCXt.playerI)) {
        let tour = GmCXt.getTourFromKey(key);
        if (tour) {
            GmCXt.getTourAndPlay(tour.tour_id, 'doitforme', 'keypress');
        }
    }
});

GmCXt.getTourFromKey = function(key) {
    let obj = null;
    GmCXt.keyInputGuides.forEach(function(tour) {
        if (tour && GmCXt.updateNumericKeys(tour.tour_settings.keyboardKeyInput) === key)
            obj = tour;
    });
    return obj;
};

GmCXt.saveCurrentURL();

GmCXt.setPageTitle();


/*global GmCXt,mg$*/
/**
 * @author Nilesh Pachpande
 */

GmCXt.domainInApp = false;

GmCXt.sendMessageToTheTopWindow = function(type, data) {
    GmCXt.sendMsgUp(type, data, true);
};

GmCXt.sendMessageToParentWindow = function(type, data) {
    GmCXt.sendMsgUp(type, data);
};

GmCXt.sendMsgUp = function(type, data, toTop) {

    data = data || {};

    if (GmCXt.playerI || GmCXt.playerI === null) {
        data.playerInstance = GmCXt.playerI;
    }

    let send = false;

    if (window.self === window.top) {
        switch (type) {
        case 'mgPlayerJSProd_action:close_step':
            GmCXt.requestHandler.closeStep();
            break;

        case 'mgPlayerJSProd_action:enable_next_button':
            GmCXt.requestHandler.enableNextButton();
            break;

        case 'mgPlayerJSProd_action:record_event;testMe':
            GmCXt.requestHandler.recordEventTestMe(data);
            break;

        case "mgPlayerJSProd_action:play_next_step":
            GmCXt.requestHandler.playTourNextStep();
            break;

        case "mgPlayerJSProd_action:update_PI_PS":
            GmCXt.requestHandler.updatePIPS(data);
            break;

        case 'mgPlayerJSProd_action:update_PI_steps':
            GmCXt.requestHandler.updatePISteps(data);
            break;

        case 'mgPlayerJSProd_action:set_feature_tag_storage':
            GmCXt.setFeatureTagStorage(data);
            break;

        default:
            send = true;
        }
    } else {
        send = true;
    }

    if (send) {
        let message = {
            action: type,
            data: data
        };
		
        if ( window.self.location.origin.indexOf("linkedin.com")>0 ) {
            return;
        }
        if (toTop)
            GmCXt.msgChannel.port1.postMessage(GmCXt.formatMsg(message));
        else
            GmCXt.sendToParentWindow(message);
    }
};

GmCXt.getIframesFromShadowDom = function() {
    if(document && document.body) {
        let elList = document.body.querySelectorAll('*');
        let frames = [];
        for (let i = 0; i < elList.length; i++) {
            if (elList[i].shadowRoot) {
                mg$.merge(frames, mg$(elList[i].shadowRoot).find('iframe'));
            }
        }
        return frames;
    }
    return false;
};

GmCXt.sendToContentIframes = function(msg) {

    for (let iframeId in GmCXt.iframePorts) {
   		if (GmCXt.iframePorts.hasOwnProperty(iframeId)) {

   			let frame = GmCXt.iframeEls[iframeId];
   			
   			if (msg.data && msg.data.frame && !GmCXt.isEmpty(msg.data.frame)) {
                msg.data.frame.iframeTitle = frame.frameElement.getAttribute("title");
                msg.data.frame.attributes = GmCXt.getIframeAttributes(mg$(frame));
                msg.data.frame.pos = frame.frameElement.getBoundingClientRect();

                if (msg.mgdata && msg.mgdata.frame && !GmCXt.isEmpty(msg.mgdata.frame)) {
                    msg.data.frame.pos.x += msg.mgdata.frame.pos.left;
                    msg.data.frame.pos.y += msg.mgdata.frame.pos.top;
                }
            }

            GmCXt.iframePorts[iframeId].postMessage(GmCXt.formatMsg(msg));
   		}
    }
};

GmCXt.forwardToContentWindows = function(message) {

    let msg = mg$.extend(true, {}, message);

    if (msg.data)
        msg.data.frame = {};

    if (window.top === window.self) {
        return;
    }

    GmCXt.sendToContentIframes(msg);
};

GmCXt.requestHandler.findElementToCheckDomRule = function(data) {

    let callback = function(result) {

        let obj = {
            valid: result.valid,
            jobId: data.jobId,
            ruleId: data.rule.ruleId,
            groupId: data.rule.groupId,
            fromSidePanel: data.fromSidePanel,
            initiator: data.job.initiator
        };

        let message = {
            action: "mgPlayerJSProd_action:completed;task:select_dom_element_for_rules",
            data: obj
        };

        if (window.self === window.top) {
            GmCXt.ruleEngine.onSuccessDOMRuleMatch(message.data);
        } else {
            GmCXt.sendMessageToParentWindow(message.action, message.data);
        }
    };

    let request = {
        data: {
            requestId: Math.random(),
            element: data.rule.element,
            frame: data.frame,
            job: data.job,
            rule: data.rule
        },
        cb: callback,
    };

    GmCXt.highlighter.queueRuleElement(request);
};

GmCXt.requestHandler.startWatcherTestMe = function(data) {
    GmCXt.testMeInstance = GmCXt.testMeWatcher({
        frame: data.frame
    });
    GmCXt.testMeInstance.start();
};

GmCXt.requestHandler.stopWatcherTestMe = function() {
    if (GmCXt.testMeInstance) {
        GmCXt.testMeInstance.stop();
    }
};

GmCXt.requestHandler.removeExistingDomElement = function(request) {
    GmCXt.highlighter.removeActiveEvents();
};

GmCXt.requestHandler.selectExistingDomElementIframe = function(d) {

    if (!GmCXt.currentIframeId &&
		d.req && d.req.settings &&
		!d.req.settings.element.meta.inTopWindow) {
        d.req.frame = d.frame;
        GmCXt.requestHandler.selectExistingDomElement(d.req);
    }

    let ruleReqs = d.rules;
    let totalReqs = ruleReqs.length;
    for (let i = 0; i < totalReqs; i++) {
        ruleReqs[i].job.timeout = Date.now() + (ruleReqs[i].job.timeoutVal || GmCXt.t.ruleTimeOut10s);
        GmCXt.log(6, "QUEUED IN IFRAME rules", ruleReqs[i]);
        GmCXt.requestHandler.findElementToCheckDomRule(ruleReqs[i]);
    }
};

GmCXt.requestHandler.selectDomElement = function(request) {

    let actionName = "mgPlayerJSProd_action:completed;task:select_dom_element_tooltips";

    let data = request.data;
    let elems = data.settings.domElems;
    let i = 0;
    if (data.findOther) {
        i = 1;
    }

    let cb = function(data) {
        delete data.he;
        let message = {
            action: actionName,
            status: data.status,
            data: data
        };

        if (GmCXt.playerI) {
            GmCXt.playerI.iframeIdentifier = GmCXt.id;
        }

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMElTooltip(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    };

    let optionalStepCb = function(opData) {
        cb(opData);
        if (!opData.watch && opData.status === GmCXt.ELEMENT_FOUND && elems.length > 1) {

            if (window.self === window.top) {
                GmCXt.requestHandler.findOtherTooltips(request);
            } else {
                GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:find_other_msg_step_tooltips', request);
            }
        }
    };

    if (data.isOptional) {

        data.tooltipId = elems[0].id;
        data.tooltip = 0;
        var _data = GmCXt.createDeepCopy(data);
        GmCXt.highlighter.queue({
            data: _data,
            element: elems[0].element,
            cb: optionalStepCb
        });

    } else {
        for (j = elems.length; i < j; i++) {

            data.tooltipId = elems[i].id;
            data.tooltip = i;
            var _data = GmCXt.createDeepCopy(data);
            if (request.data.settings) {
                GmCXt.highlighter.queue({
                    data: _data,
                    element: elems[i].element,
                    cb: cb
                });
            }
        }
    }
};

GmCXt.requestHandler.searchStartPoint = function(data) {

    let cb = function(d) {
        if (d.status === GmCXt.ELEMENT_FOUND) {
            GmCXt.sendMessageToTheTopWindow("mgPlayerJSProd_action:start_point_found", {
                step: data.startPoint,
                resumeGuide: data.resumeGuide
            });
        } else {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:start_point_not_found', {
                step: data.startPoint,
                resumeGuide: data.resumeGuide
            });
        }
    };
	
    let step = data.startPoint;

    GmCXt.highlighter.queue({
        data: {
            tour_id: data.tour_id,
            requestId: step.step_id,
            settings: step.step_settings,
            windowHost: GmCXt.getPageDomain(),
            task: 'findStep',
            findOnly: true,
            noOutline: true,
            timeout: Date.now() + 1000,
            log_stepInfo: GmCXt.getStepInfoLog(step)
        },
        cb: cb
    });
};

GmCXt.requestHandler.searchDomElement = function(d) {

    GmCXt.highlighter.queue({
        data: d,
        cb: function(r) {
            if (r.status === GmCXt.ELEMENT_FOUND) {
                GmCXt.sendMessageToTheTopWindow("mgPlayerJSProd_action:next_step_found");
            }
        }
    });
};

GmCXt.requestHandler.selectExistingDomElement = function(d) {

    if (d.settings) {
        if (d.task === 'playTour') {
            GmCXt.highlighter.queue({
                data: d,
                cb: GmCXt.onFindExistingEl
            });
        }
    }
};

GmCXt.onFindExistingEl = function(data) {

    let actionName = "mgPlayerJSProd_action:completed;task:select_existing_dom_element";
    delete data.he;

    let message = {
        action: actionName,
        status: data.status,
        data: data
    };

    if (GmCXt.playerI) {
        GmCXt.playerI.iframeIdentifier = GmCXt.id;
    }

    if (window.self === window.top) {
        GmCXt.requestHandler.handleEventSelectDOMElement(null, message);
    } else {
        GmCXt.sendMessageToParentWindow(actionName, message);
    }
};

GmCXt.requestHandler.triggerElementClick = function(request) {
    if (request.data)
        GmCXt.highlighter.triggerDomClick(request.data);
};

GmCXt.isMyGuideAction = function() {
    if (GmCXt.isAutomationRunning() && GmCXt.isAutomationStepRunning()) {
        return false;
    }

    if (GmCXt.selectorTool && GmCXt.selectorTool.status !== 'inactive')
        return true;
    else if (GmCXt.playerI && !GmCXt.showTooltipsDuringWorkflowGuide())
        return true;

    return false;
};

GmCXt.getElOptions = function(he) {

    let elOptions = [];

    if (he.tagName.toLowerCase() === 'select') {

        for (var i = 0; i < he.options.length; i++) {
            var obj = {
                value: he.options[i].value,
                name: he.options[i].innerText,
                type: 'select'
            };
            elOptions.push(obj);
        }
    } else {

        let allRadio = mg$(he).find("input[type=radio]");
        let allCheckbox = mg$(he).find("input[type=checkbox]");

        let allChildElems = mg$.merge(allRadio, allCheckbox);
        let parentPos = he.getBoundingClientRect();

        for (var i = 0; i < allChildElems.length; i++) {
            let childPos = allChildElems[i].getBoundingClientRect();
            var obj = {
                top: childPos.top - parentPos.top,
                left: childPos.left - parentPos.left,
                width: childPos.width,
                height: childPos.height,
                name: allChildElems[i].name,
                type: allChildElems[i].type
            };
            elOptions.push(obj);
        }
    }

    return elOptions;
};

GmCXt.updateFrameOffsetsForSmarttip = function(message) {
    // forward to contentwindow only when message is comming from top window
    // sendToParentWindow when message in coming from iframe's highlighter
    if (window.self !== window.top && message.rect && message.highlightedArea) {
        let obj = {};
        obj.left = message.rect.left;
        obj.top = message.rect.top;

        obj = GmCXt.addFrameOffset(event, obj);
        message.highlightedArea.left = message.rect.left = obj.left;
        message.highlightedArea.top = message.rect.top = obj.top;

        GmCXt.sendToParentWindow(message);
    } else {
        GmCXt.forwardToContentWindows(message);
    }
};

/**
 * @function
 * If receiving window is not the top window, it adds
 * offset of the frame embedding event window, to the element offset
 * and sends element offset to its parent window
 */
GmCXt.requestHandler.updateElementOffset = function(event, message) {
    if (window.self !== window.top) {
        if (message.data.status === GmCXt.ELEMENT_FOUND) {
            let pos = message.data.data.element.position;
            message.data.data.element.position = GmCXt.addFrameOffset(event, pos);
        }
        GmCXt.sendToParentWindow(message);
    }
};

GmCXt.requestHandler.removeSmarttipBeacon = function(idList) {
    if (GmCXt.highlighter) {
        GmCXt.highlighter.clearBeacons();
        GmCXt.highlighter.clearTooltips(idList);
    }
};

GmCXt.requestHandler.removeToolip = function(data) {
    if (GmCXt.highlighter) {
        GmCXt.highlighter.removeToolTipIcons(data);
        GmCXt.highlighter.clearJob(data.step_id);
    }
};

GmCXt.requestHandler.hideAllSmartTip = function(msg) {
    GmCXt.forwardToContentWindows(msg);
    mg$('.mgPlayerJSProd_smarttip-icon').hide();
    GmCXt.smarttipAreHidden = true;
};

GmCXt.processIframePlayer = function(event) {

    let message = event.data;
    let messageCopy = mg$.extend(true, {}, message);

    switch (message.action) {

    case 'mgPlayerJSProd_action:domain_in_active_app':
        GmCXt.domainInApp = message.data.domainInApp;
        break;

    case 'mgPlayerJSProd_action:page_url':
        GmCXt.urlParts = message.data.urlParts;
        GmCXt.elAppName = message.data.elAppName;
        GmCXt.pageTitle = message.data.title;
        break;

    case 'mgPlayerJSProd_action:started; task:remove_intel_events':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.removeExistingDomElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:clear_outline;action:do':
        if (message.data.scriptId !== GmCXt.id) {
            mg$('.mgPlayerJSProd_new-outline').hide();
            mg$('.mgPlayerJSProd_select-outline').hide();
        }
        break;

    case 'mgPlayerJSProd_action:set_iframe_id:do':
        GmCXt.currentIframeId = message.data.currentIframeId;
        break;

    case 'mgPlayerJSProd_action:started;task:select_existing_dom_element':
        if (GmCXt.visibleWindow(message.data)) {
            GmCXt.forwardToContentWindows(message);
            GmCXt.requestHandler.selectExistingDomElement(messageCopy.data);
        }
        break;

    case 'mgPlayerJSProd_action:started;task:select_existing_dom_element:target_frame_only':
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.requestHandler.selectExistingDomElement(messageCopy.data);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id', {
                currentIframeId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:started;task:search_next_step':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.searchDomElement(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:started;task:search_start_point':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.searchStartPoint(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_tooltips':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:task:init_new_iframe':

        if (!GmCXt.isEmpty(message.data.org)) {
            GmCXt.updateGlobalOrg(message.data.org);
        }

        if (message.data.featureTracking) GmCXt.trackerUtil.featureTracking = message.data.featureTracking;

        if (message.data.pageTracking) GmCXt.trackerUtil.pageTracking = message.data.pageTracking;

        if (message.data.sessionInfo) GmCXt.sessionInfo = message.data.sessionInfo;

        if (message.data.domainInApp) GmCXt.domainInApp = message.data.domainInApp;

        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:update_variables');

        if (message.data.activeAppSettings) {
            GmCXt.activeAppSettings = message.data.activeAppSettings;
        }
        GmCXt.requestHandler.selectExistingDomElementIframe(messageCopy.data);
        break;

    case "mgPlayerJSProd_action:command; task:trigger_step_click":
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.triggerElementClick(message);
        break;

    case 'mgPlayerJSProd_action:show_beacon_on_dom_element':
        GmCXt.forwardToContentWindows(message);

        GmCXt.highlighter.queueBeacon(messageCopy);
        break;

    case 'mgPlayerJSProd_action:show_beacon_on_dom_element:target_frame_only':
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.stepData.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.highlighter.queueBeacon(messageCopy);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id:beacon', {
                tour_id: message.data.tourId,
                frameId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:clear_dom_outline':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.removeOutline(message.data.id);
        break;

    case 'mgPlayerJSProd_action:stop_dom_highlighter':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.unqueue(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:completed;task:select_dom_element_tooltips':
    case 'mgPlayerJSProd_action:completed;task:select_existing_dom_element':
    case 'mgPlayerJSProd_action:completed;task:select_dom_element_for_rules':
        if (!GmCXt.isSidePanelApp) {
            GmCXt.requestHandler.updateElementOffset(event, message);
        }
        break;

    case 'mgPlayerJSProd_action:close_step':
        // pass to the top window if current window is not the top window
        if (window.parent !== window.top) {
            GmCXt.sendToParentWindow(message);
        }
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_to_show_tooltip':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.queueSmarttip(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_to_show_tooltip:target_frame_only':
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.highlighter.queueSmarttip(messageCopy);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id:tooltip', {
                step_id: message.data.step.step_id,
                frameId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:started;task:find_tag_elm':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.queueTag(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:find_tag_elm:target_frame_only':
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.highlighter.queueTag(messageCopy);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id:tag', {
                step_id: message.data.step.step_id,
                frameId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:bring_element_in_viewport':
    case 'mgPlayerJSProd_action:bring_element_in_viewport_edit_step':
        GmCXt.highlighter.bringElementInViewport(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:start_watcher;testMe':
        GmCXt.requestHandler.startWatcherTestMe(message.data);
        break;

    case 'mgPlayerJSProd_action:stop_watcher;testMe':
        GmCXt.requestHandler.stopWatcherTestMe();
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_for_rules':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.findElementToCheckDomRule(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:save_org_in_iframes':
        if (!GmCXt.isEmpty(message.data.org)) {
            GmCXt.updateGlobalOrg(message.data.org);
        }
        break;

    case 'mgPlayerJSProd_action:save_user_in_iframes':
        if (!GmCXt.isEmpty(message.data.user)) {
            GmCXt.updateGlobalUser(message.data.user);
        }
        break;

    case 'mgPlayerJSProd_action:hide_beacons':
        GmCXt.forwardToContentWindows(message);
        mg$('.mgPlayerJSProd_beacon-icon').addClass('mgPlayerJSProd_hidden');
        GmCXt.beaconsAreHidden = true;
        break;

    case 'mgPlayerJSProd_action:show_beacons':
        GmCXt.forwardToContentWindows(message);
        mg$('.mgPlayerJSProd_beacon-icon').removeClass('mgPlayerJSProd_hidden');
        GmCXt.beaconsAreHidden = false;
        break;

    case 'mgPlayerJSProd_action:remove_preview':
        GmCXt.removePreviewFrame();
        break;

    case "mgPlayerJSProd_action:clear_session":
        GmCXt.clearSession();
        break;

    case 'mgPlayerJSProd_action:hide_all_smarttip':
        GmCXt.requestHandler.hideAllSmartTip(message);
        break;

    case 'mgPlayerJSProd_action:clear_message_tooltip':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.clearJob(message.data.id);
        break;

    case 'mgPlayerJSProd_action:remove_tooltip':
        GmCXt.requestHandler.removeToolip(message.data);
        break;

    case 'mgPlayerJSProd_action:show_all_smarttip':
        GmCXt.updateFrameOffsetsForSmarttip(message);
        mg$('.mgPlayerJSProd_smarttip-icon').show();
        GmCXt.smarttipAreHidden = false;
        break;

    case 'mgPlayerJSProd_action:hide_smarttip_delay':
        if (window.self !== window.top) {
            GmCXt.sendToParentWindow(message);
        }
        break;

    case 'mgPlayerJSProd_action:show_preview_smarttip':
        mg$('.mgPlayerJSProd_smarttip-icon-wrapper-' + message.data.id).removeClass('tooltip-hidden');
        break;

    case 'mgPlayerJSProd_action:show_preview_beacon':
        mg$('.mgPlayerJSProd_beacon-icon-tour-' + message.data.id).show();
        break;

    case 'mgPlayerJSProd_action:forward;remove_active_smarttip_beacon':
        GmCXt.requestHandler.removeSmarttipBeacon(message.data.idList);
        break;

    case 'mgPlayerJSProd_action:smarttip_preview_on':
        GmCXt.forwardToContentWindows(message);
        GmCXt.smartTipPreviewOn = true;
        break;

    case 'mgPlayerJSProd_action:insert_power_html':
        GmCXt.highlighter.insertPowerForm(message.data);
        break;

    case 'mgPlayerJSProd_action:update_tracking_info:frames':
        GmCXt.forwardToContentWindows(message);

        GmCXt.trackerUtil = GmCXt.trackerUtil || {};
        GmCXt.trackerUtil.trackPI = message.data.trackPI;
        GmCXt.trackerUtil.featureTracking =  message.data.featureTracking;
        GmCXt.trackerUtil.pageTracking =  message.data.pageTracking;
        break;

    case 'mgPlayerJSProd_action:remove_beacon_job':
        GmCXt.highlighter.removeBeaconJob(message.data.tourId);
        break;

    case 'mgPlayerJSProd_action:clear_rule_jobs':
        GmCXt.forwardToContentWindows(message);

        var init = message.data.initiator || '';
        var triggerSource = message.data.trigger || '';

        GmCXt.highlighter.clearRuleJobs(init, triggerSource);
        break;

    case "mgPlayerJSProd_action:update_app_settings":
        GmCXt.activeAppSettings = message.data.activeAppSettings;
        break;

    case 'mgPlayerJSProd_action:sync_playerinstance_for_automation':
        GmCXt.playerI = message.data.playerInstance;
        break;

    case 'mgPlayerJSProd_action:request_dom_tracker_info':
        GmCXt.shareDomTrackerInfo();
        break;

    case 'mgPlayerJSProd_action:reset_dom_tracker':
        GmCXt.resetElTrackerVariable();
        break;

    case 'mgPlayerJSProd_action:empty_user_on_logout_in_iframes':
			
        GmCXt.user = false;
        break;

    default:
    }
};

GmCXt.listenIframePlayer = function(event) {
    event = mg$.extend({}, event);
    if (GmCXt.verifyMsg(event))
        GmCXt.processIframePlayer(event);
};
/**
 * @author Nilesh Pachpande
 */
/*global GmCXt,mg$*/
GmCXt.listenIframeCreator = function(event) {
    event = mg$.extend({}, event);
    if (GmCXt.verifyMsg(event)) {
        GmCXt.processIframeCreator(event);
        GmCXt.processIframePlayer(event);
    }
};

GmCXt.processIframeCreator = function(event) {
    let message = event.data;
    let messageCopy = mg$.extend(true, {}, message);

    switch (message.action) {

    case 'mgPlayerJSProd_action:toggle_capture_and_navigate_tool':
        if (GmCXt.enableNavigateTool === true) {
            GmCXt.enableNavigateTool = false;
        } else {
            GmCXt.enableNavigateTool = true;
        }
        break;

    case 'mgPlayerJSProd_action:hide_step_selector_toolbar':
        GmCXt.toggleStepSelectionToolbar(false);
        break;

    case 'mgPlayerJSProd_action:started;task:highlight_element':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.highlightElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:do;task:enable_navigate_tool':
        GmCXt.enableNavigateTool = true;
        GmCXt.forwardToContentWindows(message);
        break;

    case 'mgPlayerJSProd_action:do;task:enable_capture_tool':
        GmCXt.enableManualJQuerySelector = false;
        GmCXt.enableNavigateTool = false;
        GmCXt.jQElementFound = false;
        GmCXt.forwardToContentWindows(message);
        break;

    case 'mgPlayerJSProd_action:do;task:enable_capture_delay_tool':
        GmCXt.enableNavigateTool = true;
        GmCXt.forwardToContentWindows(message);
        break;

    case 'mgPlayerJSProd_action:do;task:enable_jQuery_selector':
        GmCXt.enableManualJQuerySelector = true;
        GmCXt.enableNavigateTool = true;
        GmCXt.jQElementFound = false;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectElementUsingJQ(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:clear_invalid_jQuery_message;action:do':
        GmCXt.jQElementFound = true;
        GmCXt.forwardToContentWindows(message.data);
        break;

    case 'mgPlayerJSProd_action:started;task:select_new_dom_element':
    case 'mgPlayerJSProd_action:started;task:select_new_dom_element_for_edit_step':
        GmCXt.enableNavigateTool = message.data.enableNavigateTool || false;
        GmCXt.forwardToContentWindows(message);

        GmCXt.log(74, 'mgPlayerJSProd_action:started;task:select_new_dom_element', messageCopy);

        GmCXt.requestHandler.selectNewDomElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_new_dom_element_find_replace':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectNewDomElementFindReplace(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:narrow_element_selection':
    case 'mgPlayerJSProd_action:started;task:expand_element_selection':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.modifyElementSelection(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_tags':
    case 'mgPlayerJSProd_action:started;task:select_dom_element_tags_2':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectNewDomElementTags(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:auto_capture_element_tags':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.autoCaptureDomElementTags(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_element_for_message_step':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectSupportingElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_element_for_branching_step':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectSupportingElementForBranching(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_element_for_step_rule':
    case 'mgPlayerJSProd_action:started;task:select_new_element_for_dom_select_rule':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectNewElementForDomRule(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:select_new_table_for_dom_select_rule':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectNewElementForDomTableRule(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:delete_element_for_message_step':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.deleteSupportingElement();
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_for_beacon':
        GmCXt.enableNavigateTool = false;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementForBeacon(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:blackout_dom_element':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.blackoutDomElement(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:edit_step_select_existing_dom_element':
        GmCXt.selectorTool = null;
        if (GmCXt.visibleWindow(message.data)) {
            GmCXt.forwardToContentWindows(message);
            GmCXt.requestHandler.selectDomElementEditStep(messageCopy);
        }
        break;

    case 'mgPlayerJSProd_action:started;task:edit_tag_select_existing_dom_element':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementEditTag(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:edit_step_select_existing_dom_element:target_frame_only':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.requestHandler.selectDomElementEditStep(messageCopy);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id', {
                currentIframeId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:started;task:edit_message_step_select_existing_dom_element':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementMessageEditStep(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:step_blackout_area_existing_dom_element':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementForBlackOutArea(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementBeaconEdit(messageCopy);
        break;

    case 'mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element:target_frame_only':
        GmCXt.selectorTool = null;
        GmCXt.forwardToContentWindows(message);
        if (GmCXt.validateTargetFrame(message.data.iframeAttrs, message.data.frame.attributes)) {
            GmCXt.requestHandler.selectDomElementBeaconEdit(messageCopy);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:set_iframe_id', {
                currentIframeId: GmCXt.id
            });
        }
        break;

    case 'mgPlayerJSProd_action:started:select_new_dom_element_for_smart_tip':
        GmCXt.enableNavigateTool = false;
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectNewDomElementForSmartTip(messageCopy);
        break;

    case 'mgPlayerJSProd_action:stop_dom_selector;action:do':
        GmCXt.handleStopDom(message);
        break;

    case 'mgPlayerJSProd_action:clear_step_req':
        GmCXt.forwardToContentWindows(message);
        GmCXt.clearStepReqObj();
        break;

    case 'mgPlayerJSProd_action:clear_dom_outline':
        GmCXt.handleClearDomOutline(message);
        break;

    case 'mgPlayerJSProd_action:set_curr_he':
        GmCXt.setCurrentHe(message);
        break;

    case 'mgPlayerJSProd_action:clear_dom_outline_new':
        GmCXt.handleClearDomOutlineNew(message);
        break;

    case 'mgPlayerJSProd_action:hide_dom_outline':
        GmCXt.handleHideDomOutline(message);
        break;

    case 'mgPlayerJSProd_action:delete_beacon_icon':
        var tourId = (message.data.tourId) ? message.data.tourId : 0;
        var len = mg$('.mgPlayerJSProd_beacon-icon-tour-' + tourId).length;
        if (len && len === 1)
            mg$('.mgPlayerJSProd_beacon-icon-tour-' + tourId).remove();

        break;

    case 'mgPlayerJSProd_action:find_element_to_get_precision':
        GmCXt.requestHandler.findElementToGetPrecision(messageCopy);
        break;

    case 'mgPlayerJSProd_action:find_element_to_get_precision_for_rules':
        GmCXt.requestHandler.findElementToGetPrecisionForRules(messageCopy);
        break;

    case 'mgPlayerJSProd_action:completed;task:select_new_dom_element':
    case 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_edit_step':
    case 'mgPlayerJSProd_action:completed;task:edit_step_select_existing_dom_element':
    case 'mgPlayerJSProd_action:completed;task:edit_tag_select_existing_dom_element':
    case 'mgPlayerJSProd_action:completed;task:select_element_for_message_step':
    case 'mgPlayerJSProd_action:completed;task:select_element_for_branching_step':
    case 'mgPlayerJSProd_action:completed;task:select_dom_element_for_beacon':
    case 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_smart_tip':
    case 'mgPlayerJSProd_action:started;task:edit_beacon_select_existing_dom_element':
    case 'mgPlayerJSProd_action:completed;task:select_element_for_step_rule':
    case 'mgPlayerJSProd_action:completed;task:select_new_element_for_dom_select_rule':
    case 'mgPlayerJSProd_action:completed;task:select_new_table_for_dom_select_rule':
    case 'mgPlayerJSProd_action:completed;task:select_element_for_variable_completed':
        GmCXt.requestHandler.updateElementOffset(event, message);
        break;

    case 'mgPlayerJSProd_action:stop_step_edit_tool_instance':
        GmCXt.forwardToContentWindows(message);
        GmCXt.highlighter.unqueue(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:started;task:select_dom_element_for_matching_in_rules':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.findElementToCheckMatchingAlgo(messageCopy.data);
        break;

    case 'mgPlayerJSProd_action:started;task:select_element_for_variable':
        GmCXt.forwardToContentWindows(message);
        GmCXt.requestHandler.selectDomElementForVariable(messageCopy);
        break;
    }
};

GmCXt.handleStopDom = function(message) {
    GmCXt.forwardToContentWindows(message);

    if (GmCXt.selectorTool) {
        GmCXt.selectorTool.status = 'inactive';
        GmCXt.selectorTool.stop();
    }
    if (GmCXt.selectorToolFill) {
        GmCXt.selectorToolFill.status = 'inactive';
        GmCXt.selectorToolFill.stop();
    }
    if (GmCXt.selectorToolRules) {
        GmCXt.selectorToolRules.status = 'inactive';
        GmCXt.selectorToolRules.stop();
    }
};

GmCXt.handleClearDomOutline = function(message) {
    GmCXt.forwardToContentWindows(message);
    if (GmCXt.selectorTool) {
        GmCXt.selectorTool.removeOutline();
    }
    if (GmCXt.selectorToolFill) {
        GmCXt.selectorToolFill.removeOutline();
    }
    if (GmCXt.selectorToolRules) {
        GmCXt.selectorToolRules.removeOutline();
    }
    if (GmCXt.selectorToolFill) {
        GmCXt.selectorToolFill.clearBlackoutArea();
        GmCXt.selectorToolFill = null;
    }
};

GmCXt.setCurrentHe = function(message) {
    GmCXt.forwardToContentWindows(message);
    if (GmCXt.selectorTool) {
        GmCXt.selectorTool.setCurrentHe();
    }
};

GmCXt.handleClearDomOutlineNew = function(message) {
    GmCXt.forwardToContentWindows(message);
    if (GmCXt.selectorTool) {
        GmCXt.selectorTool.removeOutlineNew();
    }
};

GmCXt.handleHideDomOutline = function(message) {
    GmCXt.forwardToContentWindows(message);
    if (GmCXt.selectorTool) {
        GmCXt.selectorTool.hideOutline();
    }
};

GmCXt.requestHandler.findElementToGetPrecision = function(req) {

    let index = req.data.data.index;

    function cb(el) {
        let data = {
            index: index,
            el: el
        };
        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:update_element_precision', data);
    }

    if (GmCXt.stepReq) {

        let elm = req.data.data.el;

        if ((GmCXt.stepReq.type === GmCXt.STEP_BEACON_TYPE && GmCXt.stepReq.dom.hasOwnProperty('selectedDOMElement')) ||
			(GmCXt.stepReq.step && GmCXt.stepReq.step.step_id && GmCXt.stepReq.reselectElem !== true)) {
            var el = GmCXt.highlighter.getElementPrecision(elm.criteria);
            cb(el);
        } else if (GmCXt.selectorTool) {
            var el = GmCXt.selectorTool.getElementPrecision(elm.criteria);
            cb(el);
        }
    }
};

GmCXt.requestHandler.findElementToGetPrecisionForRules = function(req) {

    if (!GmCXt.rulesElement) return;

    let d = req.data.data;
    let elm = d.el;
    GmCXt.rulesElement = d.el;

    function cb(el) {
        if (el === null) return;

        if (GmCXt.rulesElement) {
            GmCXt.rulesElement = el;
        }

        let dataValue = {
            index: d.index,
            parentIndex: d.parentIndex,
            rulesElement: el
        };
        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:update_element_precision:for_rules', dataValue);
    }

    if (GmCXt.highlighter) {
        var el = GmCXt.highlighter.getElementPrecision(elm.criteria);
        cb(el);
    } else if (GmCXt.selectorToolRules) {
        var el = GmCXt.selectorToolRules.getElementPrecision(elm.criteria);
        cb(el);
    }
};

GmCXt.requestHandler.blackoutDomElement = function(request) {
    let cb = function(data) {

        let rect = data.element.position;
        let actionName = 'mgPlayerJSProd_action:completed;task:blackout_dom_element';

        let message = {
            action: actionName,
            id: data.id,
            position: rect,
            element: data
        };

        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventBlackoutDOMElement(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
            GmCXt.selectorToolFill.removeBlackoutOutline();
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };
    GmCXt.selectorToolFill = GmCXt.selector({
        cb: cb,
        frame: request.data.frame,
        identifier: "blackout-request"
    });
    GmCXt.selectorToolFill.start();
};

GmCXt.requestHandler.selectSupportingElement = function(request) {
    let cb = function(data) {

        let actionName = "mgPlayerJSProd_action:completed;task:select_element_for_message_step";
        delete data.he;

        let message = {
            action: actionName,
            status: GmCXt.ELEMENT_FOUND,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {

                GmCXt.sendMessageToParentWindow(actionName, message);
            }
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };
    let frame = request.data.frame;

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.requestHandler.autoCaptureDomElementTags = function(request) {

    let data = GmCXt.getVisibleElementsTags(document.all);

    let actionName = request.action.replace("started", "completed");

    let message = {
        action: actionName,
        data: data,
        iframeIdentifier: GmCXt.id
    };

    GmCXt.timeout(function() {
        if (window.self === window.top) {
            GmCXt.handleSelectTagAll(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    }, 500);
};
GmCXt.requestHandler.selectNewDomElementTags = function(request) {
    let cb = function(data) {

        let actionName = request.action.replace("started", "completed");
        data.title = data.titleSuggestion.text;

        delete data.he;

        let message = {
            action: actionName,
            previewImage: GmCXt.stepReq?.previewImage,
            status: GmCXt.ELEMENT_FOUND,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        }, 500);
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 200);
    };

    let frame = request.data.frame;
    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.getVisibleElementsTags = function(allElements) {
    if (!allElements.length) {
        return [];
    }
    
    const nonVisualTags = [
        'SCRIPT', 'STYLE', 'META', 'LINK', 'HEAD', 'TITLE','HTML','BODY',
        'NOSCRIPT', 'TEMPLATE', 'BASE', 'PARAM', 'SOURCE','path', 'IFRAME'
    ];

    function checkChildren(el) {
        if (el.tagName === 'svg') {
            return true;
        }
        if (el.childElementCount > 1) {
            return false;
        } else if (el.childElementCount === 1) {
            return checkChildren(el.childNodes[0]);
        } else {
            return true;
        }
    }

    function isElementUseful(element) {
        let hasDimensions = (element.getBoundingClientRect().width > 1 && element.getBoundingClientRect().height > 1);

        let isUseful = hasDimensions && element.childElementCount <= 1;

        if (!isUseful) {
            return false;
        } else if (element.hasAttribute('onclick')) {
            return true;
        } else if (element.childElementCount) {
            return checkChildren(element.childNodes[0]);
        } else {
            return true;
        }
    }

    let filteredEles = [];

    for (let i = 0; i < allElements.length; i++) {
        let el = GmCXt.skipTags(allElements[i]);
        if (el.tagName.startsWith('wmgPlayerJSProd_'.toUpperCase())){
            break;
        }
        if (el.nodeType === Node.ELEMENT_NODE && 
        !nonVisualTags.includes(el.tagName) &&
        isElementUseful(el) &&
        GmCXt.getElVisibility(el) === 'visible') {
            if (!el.parentElement.hasAttribute('gm_visited') && !el.classList.contains('mg-ft-tag')) {
                let tag = GmCXt.selector().getElData(el);
                delete tag.he;
                tag.title = tag.titleSuggestion.text;
                if (tag.element.meta.score > 3 && tag.title) {
                    filteredEles.push(tag);
                    el.setAttribute('gm_visited', 'true');
                }
            } else {
                el.setAttribute('gm_visited', 'true');
            }
        }

        if (el.tagName === 'svg') el.setAttribute('gm_visited', 'true');
    }
  
    return filteredEles;
};

GmCXt.requestHandler.selectSupportingElementForBranching = function(request) {

    function getDataOption(elem) {
        let data = {
            id: elem.id,
            element: GmCXt.dom.getElement(elem, null, request.data.frame)
        };

        let opt = {
            text: readText(elem),
            value: elem.value,
            data: data
        };

        if (opt.text) return opt;
        else return null;
    }

    function readText(elem) {
        let text = elem.innerHTML;

        if (text === "" && elem.nextElementSibling) {
            text = elem.nextElementSibling.innerHTML;
        }

        if (text === "" && elem.parentElement) {

            let ps = elem.parentElement.nextElementSibling;

            if (ps && ps.tagName === "LABEL" &&
				(ps.getAttribute("for") === elem.getAttribute("name") ||
					ps.getAttribute("id") === elem.getAttribute("name") ||
					ps.getAttribute("for") === elem.getAttribute("id")
				)
            ) {
                text = ps.innerText;
            }
        }
        return text.substring(0, 50);
    }

    let cb = function(data) {

        let actionName = "mgPlayerJSProd_action:completed;task:select_element_for_branching_step";
        let message = {
            action: actionName,
            status: GmCXt.ELEMENT_FOUND,
            data: data,
        };

        let tagN = mg$(message.data.he)[0].tagName.toLowerCase();
        message.data.dataOptions = [];

        message.data.textContent = GmCXt.getElementText(message.data.he);

        if (tagN === 'select') {

            message.data.dataOptionsType = "select";
            for (var i = 0; i < message.data.he.options.length; i++) {
                var objToPush = {};
                objToPush.text = mg$(message.data.he.options[i])[0].innerHTML.substring(0, GmCXt.ruleTextLimit);
                objToPush.val = mg$(message.data.he.options[i]).val();
                objToPush.data = {};
                objToPush.data.element = GmCXt.dom.getElement(message.data.he, null, request.data.frame);
                message.data.dataOptions.push(objToPush);
            }
        } else if (tagN === 'input') {

            if (data.element.selector.js[0].toLowerCase().indexOf("radio") > -1) {

                var allRadio = mg$("input[name='" + message.data.he.name + "']");
                message.data.dataOptionsType = "radio";

                for (var i = 0; i < allRadio.length; i++) {
                    var opt = getDataOption(allRadio[i]);
                    if (opt) message.data.dataOptions.push(opt);
                }
            }
        } else if (mg$(message.data.he).has("input[type=radio]").length > 0) {

            message.data.dataOptionsType = "radio";

            var allRadio = mg$("input[name='" + mg$(message.data.he).find("input[type=radio]")[0].name + "']");

            for (var i = 0; i < allRadio.length; i++) {
                var opt = getDataOption(allRadio[i]);
                if (opt) message.data.dataOptions.push(opt);
            }
        } else if (mg$(message.data.he).find("select").length === 1) {

            message.data.dataOptionsType = "select";
            let elem = mg$(message.data.he).find("select");

            for (var i = 0; i < elem[0].options.length; i++) {
                var objToPush = {};
                objToPush.text = mg$(elem[0].options[i])[0].innerHTML;
                objToPush.val = mg$(elem[0].options[i]).val();
                objToPush.data = {};
                objToPush.data.element = GmCXt.dom.getElement(elem[0], null, request.data.frame);
                message.data.dataOptions.push(objToPush);
            }
        }

        delete message.data.he;

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        }, 300);
    };

    GmCXt.selectorToolRules = GmCXt.selector({
        cb: cb,
        frame: request.data.frame,
        identifier: "rules-engine-request"
    });
    GmCXt.selectorToolRules.start();

};

GmCXt.getInfoFromHe = function(data) {
    data.childElements = data.element.childElements;
    data.elTag = mg$(data.he)[0].tagName.toLowerCase();
    data.parentNotExist = !data.he.parentElement;
};

GmCXt.requestHandler.selectNewElementForDomTableRule = function(request) {
    let cb = function(data) {

        if (request.data && request.data.ruleIndex !== undefined) {
            data.ruleIndex = request.data.ruleIndex;
            data.groupIndex = request.data.groupIndex;
            data.reSelect = request.data.reSelect;
        }

        let actionName = "";

        if (data.he.tagName === 'TABLE') {
            let table = data.he;
            data.columns = {};
            let numberOfCols = table.rows[0].cells.length;
            let i;
            for (i = 0; i < numberOfCols; i++) {
                data.columns[i] = {
                    label: table.rows[0].cells[i].textContent,
                    id: i,
                    values: []
                };
            }
            let val = '';
            for (i = 1; i < table.rows.length; i++) {
                for (j = 0; j < numberOfCols; j++) {
                    val = table.rows[i].cells[j].textContent.trim();
                    if (val && !data.columns[j].values.includes(val)) {
                        data.columns[j].values.push(val);
                    }
                }
            }
            actionName = "mgPlayerJSProd_action:completed;task:select_new_table_for_dom_select_rule";
        } else {
            //If selected element not table change rule to select element
            actionName = "mgPlayerJSProd_action:completed;task:select_new_element_for_dom_select_rule";
        }
        let message = {
            action: actionName,
            status: GmCXt.ELEMENT_FOUND,
            data: data,
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        }, 500);

    };

    GmCXt.selectorToolRules = GmCXt.selector({
        cb: cb,
        frame: request.data.frame,
        identifier: "rules-engine-request",
        type: "table"
    });
    GmCXt.selectorToolRules.start();
};

// This function is to select dom element needed by Rule Engine to show beacon/tooltip/push notification
GmCXt.requestHandler.selectNewElementForDomRule = function(request) {

    let cb = function(data) {

        if (request.data && request.data.ruleIndex !== undefined) {
            data.ruleIndex = request.data.ruleIndex;
            data.groupIndex = request.data.groupIndex;
            data.reSelect = request.data.reSelect;
        }

        GmCXt.requestHandler.updateCriteriaForQuickFindEl(data);
        delete data.he;

        let actionName = "mgPlayerJSProd_action:completed;task:select_new_element_for_dom_select_rule";
        if (request.action === 'mgPlayerJSProd_action:started;task:select_element_for_step_rule') {
            // dom rule at step level
            data.rules = request.data.rules;
            actionName = "mgPlayerJSProd_action:completed;task:select_element_for_step_rule";
        }
        let message = {
            action: actionName,
            status: GmCXt.ELEMENT_FOUND,
            data: data,
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        }, 300);

    };

    GmCXt.selectorToolRules = GmCXt.selector({
        cb: cb,
        frame: request.data.frame,
        identifier: "rules-engine-request"
    });
    GmCXt.selectorToolRules.start();
};

GmCXt.requestHandler.deleteSupportingElement = function(request) {
    let message = {
        action: "mgPlayerJSProd_action:completed;task:delete_element_for_message_step",
        iframeIdentifier: GmCXt.id
    };

    // Send a message to all frames to clear outline.
    GmCXt.timeout(function() {
        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(message.action, message);
        }
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
    }, 300);
};

GmCXt.selectNewDomElForEdit = function(request) {

    let frame = request.data.frame;
    let actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_edit_step';

    let cb = function(data, autoCorrectData) {

        if (data.he) {
            let he = data.he;
            GmCXt.getInfoFromHe(data);
            data.isEditableEl = mg$(he).attr('contenteditable') || he && he.isContentEditable;
            delete data.he;
        }

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        let req = mg$.extend(true, {}, request);

        //Auto correction functionality
        if (req && req.action === 'mgPlayerJSProd_action:started;task:select_new_dom_element_for_edit_step') {

            let oldSelector = req.data.stepReq.data.step.step_settings.element.selector;

            //Get list of dynamic attributes
            GmCXt.dom.dynamicAttrs = GmCXt.requestHandler.getDynamicAttrList(oldSelector, data.element.selector);

            if (GmCXt.dom.dynamicAttrs !== null) {
                //Skip dynamic attributes while creating new selector
                message.data.element = GmCXt.dom.getElement(autoCorrectData.he, data.element.criteria, autoCorrectData.frame);

            } else {
                //If there are no dynamic attributes to skip, add addditional selector for this element
                message.data.element.selector1 = oldSelector;
            }
        }

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }

            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.selectNewDomEl = function(request) {
    let frame = request.data.frame || {};
    if (request.action === 'mgPlayerJSProd_action:started;task:select_new_dom_element_for_edit_step') {
        var actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_edit_step';
    } else {
        var actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element';
    }

    let cb = function(data) {
        GmCXt.getInfoFromHe(data);
        delete data.he;

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            stepType: request.data.stepType,
            iframeIdentifier: GmCXt.id
        };

        GmCXt.log(74, 'Element found', GmCXt.stepReq);

        // Send a message to all frames to clear outline.
        if (GmCXt.conf.appConfig.desktopCommunication || GmCXt.stepReq.action === 'mgPlayerJSProd_action:create_step,type:quick') {
            let m = {
                action: "mgPlayerJSProd_action:queue_step_capture",
                data:{
                    message:message,
                    stepReq:GmCXt.stepReq
                }
            };

            GmCXt.sendMessageToBackgroundService(m);
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }else{
            GmCXt.timeout(function() {
                if (window.self === window.top) {
                    GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
                } else {
                    GmCXt.sendMessageToParentWindow(actionName, message);
                }
                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
            }, 300);
        }
    };

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.selectNewDomElFindReplace = function(request) {

    let frame = request.data.frame;
    let actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element_find_replace';
    let cb = function(data) {

        delete data.he;

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        }, 500);
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 200);
    };

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.requestHandler.selectElementUsingJQ = function(request) {
    let jQ = request.val;
    let openPanel = request.openPanel;
    if (jQ) {
        if (GmCXt.selectorTool)
            GmCXt.selectorTool.getElemenetUsingJQ(jQ, openPanel);
        else if (GmCXt.selectorToolFill)
            GmCXt.selectorToolFill.getElemenetUsingJQ(jQ, openPanel);
        else if (GmCXt.selectorToolRules)
            GmCXt.selectorToolRules.getElemenetUsingJQ(jQ, openPanel);
    }
};

GmCXt.requestHandler.selectNewDomElement = function(request) {

    GmCXt.log(74, 'selectNewDomElement', request);

    if (request.action === 'mgPlayerJSProd_action:started;task:select_new_dom_element' ||
		request.data.stepReq.data.step.step_settings.element.selector1) {

        GmCXt.selectNewDomEl(request);

    } else if (request.action === 'mgPlayerJSProd_action:started;task:select_new_dom_element_for_edit_step') {
        GmCXt.selectNewDomElForEdit(request);
    }
};

GmCXt.requestHandler.selectNewDomElementFindReplace = function(request) {
    if (request.action === 'mgPlayerJSProd_action:started;task:select_new_dom_element_find_replace') {
        GmCXt.selectNewDomElFindReplace(request);
    }
};

GmCXt.requestHandler.modifyElementSelection = function(request) {

    let frame = request.data.frame;

    if (GmCXt.highlighter && GmCXt.stepReq.dom.status === GmCXt.ELEMENT_FOUND) {
        var currentHe = GmCXt.highlighter.getCurrentHe();
        GmCXt.startSelectorTool(null, frame);
    }

    if (GmCXt.selectorTool) {
        if (request.action === 'mgPlayerJSProd_action:started;task:expand_element_selection') {
            var data = GmCXt.selectorTool.expandElementSelection(currentHe);
            GmCXt.onChangeSelection(data);
        } else if (request.action === 'mgPlayerJSProd_action:started;task:narrow_element_selection') {
            var data = GmCXt.selectorTool.narrowElementSelection(currentHe);
            GmCXt.onChangeSelection(data);
        }
    }
};

GmCXt.onChangeSelection = function(data) {
    if (!data) return;
    let step_type = GmCXt.stepReq.step.step_type;
    let actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element';
    let he = data.he;

    data.isChildrenVisited = mg$(he).children('[gm_visited="true"]').length ? true : false;
    GmCXt.getInfoFromHe(data);

    if (step_type === GmCXt.STEP_TYPE_SMART_TIP) {

        data.isEditableEl = mg$(he).attr('contenteditable') || he && he.isContentEditable;
        actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_smart_tip';
        let isElementFixed = GmCXt.dom.getElementFixedPosition(he);
        data.elPosProp = isElementFixed ? 'fixed' : mg$(he).css('position');
        data.parentElPosProp = mg$(he).parent().css('position');
    }

    delete data.he;

    let message = {
        status: GmCXt.ELEMENT_FOUND,
        action: actionName,
        data: data,
        iframeIdentifier: GmCXt.id
    };

    GmCXt.timeout(function() {
        if (window.self === window.top) {
            if (step_type === GmCXt.STEP_TYPE_SMART_TIP) {
                GmCXt.requestHandler.handleEventSelectDOMElementForSmartTip(null, message);
            } else {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            }
        } else {
            GmCXt.sendMessageToParentWindow(message.action, message);
        }
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
    }, 0);
};

GmCXt.startSelectorTool = function(cb, frame) {
    if (!GmCXt.selectorTool || GmCXt.selectorTool.status === 'inactive') {
        GmCXt.selectorTool = GmCXt.selector({
            cb: cb,
            frame: frame
        });
        GmCXt.selectorTool.status = 'active';
        GmCXt.selectorTool.start();
    }
};

GmCXt.requestHandler.selectDomElementEditStep = function(request) {

    let actionName = "mgPlayerJSProd_action:completed;task:edit_step_select_existing_dom_element";

    let cb = function(data) {
        if (data.he) {
            let he = data.he;
            GmCXt.getInfoFromHe(data);
            let isElementFixed = GmCXt.dom.getElementFixedPosition(he);
            data.elPosProp = isElementFixed ? 'fixed' : mg$(he).css('position');
            data.parentElPosProp = mg$(he).parent().css('position');
            delete data.he;
        }

        let message = {
            action: actionName,
            status: data.status,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    };

    if (request.data.settings) {
        request.data.identifier = "editStep";
        GmCXt.highlighter.queue({
            data: request.data,
            cb: cb
        });
    }
};

GmCXt.requestHandler.selectDomElementEditTag = function(request) {

    let actionName = "mgPlayerJSProd_action:completed;task:edit_tag_select_existing_dom_element";
    let elTags = request.data.elTags;

    let cb = function(data) {

        delete data.he;

        let message = {
            action: actionName,
            status: data.status,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    };

    for (var i = 0; i < elTags.length; i++) {

        let d = {
            settings: elTags[i].step_settings
        };

        function handleTag(data) {
            data.tagId = elTags[i].step_id;
            cb(data);
        }

        if (request.data) {
            request.data.isElem = true;
            GmCXt.highlighter.queue({
                data: d,
                cb: handleTag,
                type: 'tag'
            });
        }
    }
};

GmCXt.requestHandler.selectDomElementMessageEditStep = function(request) {

    let data = request.data;
    let actionName = "mgPlayerJSProd_action:completed;task:edit_message_step_select_existing_dom_element";

    let elems = data.settings.domElems || {};
    let cb = function(data) {

        data.stepType = request.data.stepType;
        data.tooltip = request.data.tooltip;

        let message = {
            action: actionName,
            status: data.status,
            data: data,
            id: request.data.id,
            iframeIdentifier: GmCXt.id
        };

        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };

    for (let i = 0, j = elems.length; i < j; i++) {

        data.id = i;
        data.tooltipId = elems[i].id;
        data.tooltip = i;
        data.timeout = Date.now() + 250;

        if (request.data.settings) {
            request.data.identifier = "editStep";
            GmCXt.highlighter.queue({
                data: request.data,
                element: elems[i].element,
                cb: cb
            });
        }

    }
};

GmCXt.requestHandler.selectDomElementForBlackOutArea = function(request) {

    let actionName = "mgPlayerJSProd_action:completed;task:step_blackout_area_existing_dom_element";

    let cb = function(data) {

        let message = {
            action: actionName,
            status: data.status,
            data: data,
            id: request.data.id,
            iframeIdentifier: GmCXt.id
        };

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    };

    if (request.data.settings) {
        GmCXt.highlighter.queue({
            data: request.data,
            cb: cb,
            identifier: "blackout-request"
        });
    }
};

GmCXt.requestHandler.selectDomElementBeaconEdit = function(request) {

    let actionName = "mgPlayerJSProd_action:completed;task:edit_beacon_select_existing_dom_element";

    let cb = function(data) {

        request.data.beaconSetting.element = mg$.extend(true, {}, data.element);

        let message = {
            action: actionName,
            status: data.status,
            data: request.data.beaconSetting,
            iframeIdentifier: GmCXt.id
        };

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }
    };

    if (request.data.settings) {
        GmCXt.highlighter.queue({
            data: request.data,
            cb: cb
        });
    }
};

GmCXt.requestHandler.updateCriteriaForQuickFindEl = function(data) {
    // Default high for beacons, tooltips & rule Els
    data.element.criteria.precision_level = "High";
    data.element.isQuickFindEl = true;
};

GmCXt.requestHandler.selectDomElementForBeacon = function(request) {

    let actionName = 'mgPlayerJSProd_action:completed;task:select_dom_element_for_beacon';

    let frame = request.frame;
    let cb = function(data) {

        GmCXt.requestHandler.updateCriteriaForQuickFindEl(data);
        delete data.he;

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.requestHandler.selectDomElementForVariable = function(request) {

    let actionName = 'mgPlayerJSProd_action:completed;task:select_element_for_variable_completed';

    let frame = request.data.frame;
    let cb = function(data) {

        GmCXt.requestHandler.updateCriteriaForQuickFindEl(data);
        delete data.he;

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 500);
    };

    GmCXt.selectorToolRules = GmCXt.selector({
        cb: cb,
        frame: frame,
        identifier: "rules-engine-request",
        type: "variable"
    });
    GmCXt.selectorToolRules.start();
};

GmCXt.requestHandler.highlightElement = function(request) {

    let actionName = 'mgPlayerJSProd_action:completed;task:highlight_element';

    let cb = function(data) {
        if (request.data.originalRequest === 'highlightCurrentStepElement') {
            if (GmCXt.stepReq) GmCXt.stepReq.dom.status = data.status;
            return;
        }

        if (data.status === GmCXt.ELEMENT_FOUND) {

            let message = {
                action: actionName,
                status: data.status,
                data: data,
                iframeIdentifier: GmCXt.id
            };

            if (window.self === window.top) {
                GmCXt.requestHandler.handleEventSelectDOMEl(null, message);
            } else {
                GmCXt.sendMessageToParentWindow(actionName, message);
            }
        } else {
            if (window.self === window.top) {
                GmCXt.executeEditInlineStep(data);
            } else {
                GmCXt.sendMessageToParentWindow("mgPlayerJSProd_action:task:execute_edit_inline_step", data);
            }
        }
    };

    if (request.data.settings) {
        GmCXt.highlighter.queue({
            data: request.data,
            cb: cb,
            isHighlightEl: true
        });
    }
};

GmCXt.requestHandler.selectNewDomElementForSmartTip = function(request) {

    let actionName = 'mgPlayerJSProd_action:completed;task:select_new_dom_element_for_smart_tip';

    let frame = request.data.frame;

    let cb = function(data) {
        let he = data.he;
        GmCXt.getInfoFromHe(data);
        data.isEditableEl = mg$(he).attr('contenteditable') || he && he.isContentEditable;

        GmCXt.requestHandler.updateCriteriaForQuickFindEl(data);
        let isElementFixed = GmCXt.dom.getElementFixedPosition(he);
        data.elPosProp = isElementFixed ? 'fixed' : mg$(he).css('position');
        data.parentElPosProp = mg$(he).parent().css('position');
        delete data.he;

        function getUniqueSelector(element) {
            if (!(element instanceof Element)) return null;

            let path = [];

            while (element?.nodeType === Node?.ELEMENT_NODE) {
                let selector = element.nodeName.toLowerCase();

                if (element.id) {
                    selector += `#${element.id}`;
                    path.unshift(selector);
                    break;
                }

                let sibling = element;
                let index = 1;
                while ((sibling = sibling.previousElementSibling)) {
                    if (sibling.nodeName.toLowerCase() === selector) {
                        index++;
                    }
                }
                selector += `:nth-of-type(${index})`;

                path.unshift(selector);
                element = element.parentElement;
            }

            return path.join(" > ");
        }

        if(window.self !== window.top){
            data.querySelector = getUniqueSelector(he);
        }

        let message = {
            status: GmCXt.ELEMENT_FOUND,
            action: actionName,
            data: data,
            iframeIdentifier: GmCXt.id
        };

        if (window.self === window.top) {
            GmCXt.requestHandler.handleEventSelectDOMElementForSmartTip(null, message);
        } else {
            GmCXt.sendMessageToParentWindow(actionName, message);
        }

        // Send a message to all frames to clear outline.
        GmCXt.timeout(function() {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:stop_dom_selector;action:inform');
        }, 300);
    };

    GmCXt.startSelectorTool(cb, frame);
};

GmCXt.requestHandler.getDynamicAttrList = function(old, new_) {

    // Define dynamic attributes for each selector
    let dynamicAttr = {
        js: null,
        js1: null,
        js2: null,
        js3: null
    };

    // Get dynamic attributes for each selector
    if (old.js && new_.js) {
        dynamicAttr.js = getDynamicAttr(old.js, new_.js);
    }

    if (old.js1 && new_.js1) {
        dynamicAttr.js1 = getDynamicAttr(old.js1, new_.js1);
    }

    if (old.js2 && new_.js2) {
        dynamicAttr.js2 = getDynamicAttr(old.js2, new_.js2);
    }

    if (old.js3 && new_.js3) {
        dynamicAttr.js3 = getDynamicAttr(old.js3, old.js3);
    }

    function getDynamicAttr(old, new_) {

        let oldObj = GmCXt.dom.getAttributes(old);
        let newObj = GmCXt.dom.getAttributes(new_);

        let len;
        if (old.length < new_.length) {
            len = old.length;
        } else {
            len = new_.length;
        }

        let tagStatus = compareTags(oldObj, newObj, len);

        if (tagStatus !== true) {
            return null;
        }

        let dynamicAttri = compareAttributes_(oldObj, newObj, len);

        return dynamicAttri;
    }

    function compareAttributes_(old, new_, len) {

        //Dynamic attribute list
        let attributeList = [];

        for (let i = 0; i < len; i++) {
            if (old[i].tagName === new_[i].tagName) {
                // Extract dynamic attributes
                for (let attr in old[i]) {
                    if (!isEqual(old[i][attr], new_[i][attr]))
                        attributeList.push(attr);
                }
            }
        }

        if (attributeList.length === 0) {
            return null;
        } else {
            // Removes duplicate attributes
            attributeList = Array.from(new Set(attributeList));
            return attributeList;
        }
    }

    function isEqual(val1, val2) {
        if (val1 && val2) {
            if (typeof val1 === 'object' && JSON.stringify(val1) === JSON.stringify(val2))
                return true;
            if (val1 == val2)
                return true;
        }
        return false;
    }

    function compareTags(old, new_, len) {
        let tagStatus = true;

        for (let i = 0; i < len; i++) {
            if (old[i].tagName !== new_[i].tagName) {
                tagStatus = false;
                break;
            }
        }

        return tagStatus;
    }

    //Return dynamic attributes
    if (dynamicAttr.js || dynamicAttr.js1 || dynamicAttr.js2 || dynamicAttr.js3) {
        return dynamicAttr;
    } else {
        return null;
    }
};

GmCXt.requestHandler.findElementToCheckMatchingAlgo = function(data) {

    let callback = function(result) {

        if (!result.found) return;

        let obj = {
            found: result.found,
            jobId: data.jobId,
            fromSidePanel: data.fromSidePanel,
            ruleIndex: data.ruleIndex,
            groupIndex: data.groupIndex,
            de: result.de
        };

        GmCXt.rulesElement = result.he;

        let message = {
            action: "mgPlayerJSProd_action:forward;task:select_dom_element_for_matching_in_rules",
            data: obj
        };

        GmCXt.sendMessageToTheTopWindow(message.action, message.data);
    };

    let request = {
        data: {
            requestId: Math.random(),
            element: data.element,
            frame: data.frame,
            job: data.job
        },
        cb: callback
    };

    GmCXt.highlighter.queueMatchingAlgoElement(request);
};

GmCXt.domFinder = function(elem, elemPath) {

    let de = null;

    // Find element by id

    if (elem.id) {

        if (elem.id.indexOf(":") !== -1) {
            de = document.getElementById(elem.id);

        } else {

            de = mg$('#' + elem.id);

            //pull a native DOM element from a jQuery object
            if (de) {
                de = de[0];
            }
        }

        if (!(de && de.title === elem.title &&
				de.name === elem.name &&
				de.type === elem.type &&
				de.tagName === elem.tagName)) {
            de = null;
        }
    }

    if (de === null) {

        // Find element by its tag and classname and match its innerHTML

        let elements = [];

        if (elem.origClassName && typeof(elem.origClassName) !== 'object') {

            elem.origClassName = elem.origClassName.trim();
            if (elem.origClassName) {
                var arr = elem.origClassName.split(' ');
                var newArr = [];
                for (var i = 0; i < arr.length; i++) {
                    var str = arr[i].trim();
                    if (str.length) {
                        newArr[newArr.length] = str;
                    }
                }
                var classString = newArr.join('.');
                elements = mg$(elem.tagName + "." + classString);
            }
        }

        if (elements.length === 0 && elem.className && typeof(elem.className) !== 'object') {

            elem.className = elem.className.trim();
            if (elem.className) {
                var arr = elem.className.split(' ');
                var newArr = [];
                for (var i = 0; i < arr.length; i++) {
                    var str = arr[i].trim();
                    if (str.length) {
                        newArr[newArr.length] = str;
                    }
                }
                var classString = newArr.join('.');
                elements = mg$(elem.tagName + "." + classString);
            }
        }

        let count_ = 0;
        let selectedElements = [];

        if (elements.length) {
            for (var i = 0, j = elements.length; i < j; i++) {
                let einnerHTML = elements[i].innerHTML;
                let title = elements[i].title;
                let href = elements[i].getAttribute("href");
                let src = elements[i].getAttribute("src");
                let name = elements[i].name;
                let type = elements[i].type;
                let innerText = elements[i].innerText;

                if (elem.href === undefined || elem.href === '') {
                    elem.href = null;
                }
                if (elem.src === undefined || elem.src === '') {
                    elem.src = null;
                }

                if (einnerHTML.replace(/\s/g, '') == elem.innerHTML.replace(/\s/g, '') &&
					title === elem.title &&
					href === elem.href &&
					src === elem.src &&
					name === elem.name &&
					type === elem.type
                ) {
                    de = elements[i];
                    selectedElements.push(de);
                    count_++;
                } else if (innerText && elem.innerText &&
					(innerText.trim() == elem.innerText.trim()) &&
					title === elem.title &&
					href === elem.href &&
					src === elem.src &&
					name === elem.name &&
					type === elem.type
                ) {
                    de = elements[i];
                    selectedElements.push(de);
                    count_++;
                }
            }
        }
    }

    if (elemPath && (de === null)) {

        // Find element at level specified by jsPath

        if (de === null) {
            var jsPath = elemPath.jsPath,
                parent = document;
            if (parent && jsPath.length) {
                de = GmCXt.getSelectedDOMElement(elem, parent, jsPath);
            }
        }

        if (de === null) {
            if (elemPath.jsFromNearestParentHavingId &&
				elemPath.jsFromNearestParentHavingId.length) {

                var jsPath = elemPath.jsFromNearestParentHavingId,
                    parent = document.getElementById(elemPath.nearestParentId);
                if (parent && jsPath.length) {
                    de = GmCXt.getSelectedDOMElement(elem, parent, jsPath);
                }
            }
        }

    }

    return de;
};

GmCXt.getSelectedDOMElement = function(elem, parent, jsPath) {

    let de = null,
        i, k, len;

    if (parent) {
        for (k = 0; k < jsPath.length; ++k) {
            for (i = 0, len = parent.childNodes.length; i < len; ++i) {
                if (parseInt(jsPath[k]) == i) {
                    parent = parent.childNodes[i];
                    break;
                }
            }
        }
    }

    if (parent instanceof Element) {

        let elementClassName = "";
        if ((typeof(elem.className) === 'object')) {
            elementClassName = "";
        } else if ((typeof(elem.className) === 'string')) {
            elementClassName = elem.className.trim();
        } else {
            elementClassName = elem.className;
        }

        let parentClassName = "";
        if ((typeof(parent.className) === 'object')) {
            parentClassName = "";
        } else if ((typeof(parent.className) === 'string')) {
            parentClassName = parent.className.trim();
        } else {
            parentClassName = parent.className;
        }

        if (de === null &&
			elem.title == parent.title &&
			elem.name == parent.name &&
			elem.type == parent.type &&
			elem.tagName == parent.tagName &&
			elementClassName == parentClassName) {

            de = parent;
        }
    }

    return de;
};

GmCXt.checkAttributes = function(element1, element2) {
    let returnValue = false;
    if (
        (element1.tagName == element2.tagName) &&
		(element1.title == element2.title) &&
		(element1.src == element2.getAttribute("src")) &&
		(element1.href == element2.getAttribute("href")) &&
		(element1.name == element2.name) &&
		(element1.type == element2.type)
    ) {
        if ((element1.tagName == 'input') &&
			((element1.type == 'submit') || (element1.type == 'button') || (element1.type == 'hidden'))
        ) {

            if (element1.value == element2.value)
                returnValue = true;
            else
                returnValue = false;
        } else {
            returnValue = true;
        }
    }

    return returnValue;
};

GmCXt.findElementByLabel = function(elem) {
    let labelText = "";
    let placeholder = "";
    let de = null;
    let matchedElements = [];

    if (elem && elem.innerText && elem.innerText.trim().length) {
        labelText = elem.innerText.trim();
    }

    if (elem && elem.placeholder && elem.placeholder.trim().length) {
        placeholder = elem.placeholder.trim();
    }

    if (labelText.length || placeholder.length) {
        let elements = document.body.getElementsByTagName("*");
        let len = elements.length;
        for (let i = 0; i < len; i++) {
            let element = elements[i];
            if (element && element.innerText) {
                let elementLabelText = element.innerText.trim();
                if ((elementLabelText == labelText) && GmCXt.checkAttributes(elem, element)) {
                    matchedElements.push(element);
                }
            } else if (element && element.placeholder) {
                let elementPlaceholder = element.placeholder.trim();
                if ((placeholder == elementPlaceholder) && GmCXt.checkAttributes(elem, element)) {
                    matchedElements.push(element);
                }
            }
        }
    }

    if (matchedElements.length && (matchedElements.length == 1)) {
        de = matchedElements[0];
    }

    return de;
};

GmCXt.findElementByParentLabel = function(elem, parentData) {

    let de = null;
    let matchedElements = [];

    let elements = document.body.getElementsByTagName("*");
    let len = elements.length;
    for (let i = 0; i < len; i++) {
        let element = elements[i];
        if (element && element.textContent) {
            let elementLabelText = element.textContent.trim();
            if ((elementLabelText == parentData.innerText) && GmCXt.checkAttributes(parentData, element)) {
                matchedElements.push(element);
            }
        }
    }

    if (matchedElements.length && matchedElements.length == 1) {
        de = matchedElements[0];
        de = GmCXt.findElementUsingParentElement(elem, de);
    }

    return de;
};

GmCXt.findElementUsingParentElement = function(elem, parentElement) {
    let de = null;
    var elements = [];

    //Match Element using id
    if (elem.id) {
        elements = mg$(parentElement).find(elem.tagName + "#" + elem.id);
        if (elements.length) {

            if (elements.length == 1) {
                de = elements[0];
            }

            if (!(de && (de.title == elem.title) &&
					(de.type == elem.type) &&
					(de.src == elem.src) &&
					(de.placeholder == elem.placeholder)
            )) {
                de = null;
            }
        }
    }

    if (elem.origClassName && typeof(elem.origClassName) !== 'object') {

        elem.origClassName = elem.origClassName.trim();
        if (elem.origClassName) {
            var arr = elem.origClassName.split(' ');
            var newArr = [];
            for (var i = 0; i < arr.length; i++) {
                var str = arr[i].trim();
                if (str.length) {
                    newArr[newArr.length] = str;
                }
            }
            var classString = newArr.join('.');
            elements = mg$(parentElement).find(elem.tagName + "." + classString);
        }
    }

    if (elements.length === 0 && elem.className && typeof(elem.className) !== 'object') {

        elem.className = elem.className.trim();
        if (elem.className) {
            var arr = elem.className.split(' ');
            var newArr = [];
            for (var i = 0; i < arr.length; i++) {
                var str = arr[i].trim();
                if (str.length) {
                    newArr[newArr.length] = str;
                }
            }
            var classString = newArr.join('.');
            elements = mg$(parentElement).find(elem.tagName + "." + classString);
        }
    }

    if (elements.length) {
        if (elements.length == 1) {
            de = elements[0];
        } else {
            var selectedElements = [];
            for (var i = 0, j = elements.length; i < j; i++) {
                let einnerHTML = elements[i].innerHTML;
                let title = elements[i].title;
                let href = elements[i].getAttribute("href");
                let src = elements[i].getAttribute("src");
                let name = elements[i].name;
                let type = elements[i].type;
                let innerText = elements[i].innerText;

                if (einnerHTML.replace(/\s/g, '') == elem.innerHTML.replace(/\s/g, '') &&
					title === elem.title &&
					href === elem.href &&
					src === elem.src &&
					name === elem.name &&
					type === elem.type
                ) {
                    selectedElements.push(elements[i]);
                } else if (innerText && elem.innerText &&
					(innerText.trim() == elem.innerText.trim()) &&
					title === elem.title &&
					href === elem.href &&
					src === elem.src &&
					name === elem.name &&
					type === elem.type
                ) {
                    selectedElements.push(elements[i]);
                }
            }

            if (selectedElements.length == 1) {
                de = selectedElements[0];
            }
        }
    }

    if (de == null || de === undefined) {
        selectedElements = [];
        var elements = mg$(parentElement).find(elem.tagName);
        if (elements.length) {
            for (var j = 0; j < elements.length; j++) {
                let element = elements[j];
                if (GmCXt.checkAttributes(elem, element)) {
                    selectedElements.push(element);
                }
            }

            if (selectedElements.length && selectedElements.length == 1) {
                de = selectedElements[0];
            }
        }
    }

    return de;
};

/*global GmCXt,mg$*/
GmCXt.dom1334 = {};
GmCXt.dom1334.matchDepth = 10;
GmCXt.dom1334.skipMatchAttributes = null;

GmCXt.dom1334.setDefaultCriteria = function() {
    GmCXt.dom1334.matchCriteria = {
        precision_type: GmCXt.DOM_CRITERIA_DEFAULT,
        jquery_selector: null,
        matchAttributes: null
    };
};

GmCXt.dom1334.reset = function() {
    GmCXt.dom1334.setDefaultMatchAttributes();

    GmCXt.dom1334.matchDepth = 10;
    GmCXt.dom1334.he = null;
    GmCXt.dom1334.elementpath = null;
    GmCXt.dom1334.idMatchFound = false;
    GmCXt.dom1334.textPropertyName = '';
    GmCXt.dom1334.textPropertyValue = ''; // When found it is element's placeholder or value or textContent
};

GmCXt.dom1334.setSkipMatchAttributes = function(skipAttributes) {

    // Skips dynamic attributes
    GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchAttributes.filter(function(attribute) {
        return !skipAttributes.includes(attribute);
    });
};

GmCXt.dom1334.addSalesforceAttibutes = function(attrs) {
    if (GmCXt.checkSalesForceSite())
        GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchAttributes.concat(attrs);
};

GmCXt.dom1334.addWorkdayAttibutes = function() {
    let attrs = ["data-automation-id"];

    if (GmCXt.checkWorkdaySite())
        GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchAttributes.concat(attrs);
};

GmCXt.dom1334.addGmailAttributes = function() {
    let attrs = ["role", "aria-label", "data-tooltip"];

    if (GmCXt.checkGmailSite())
        GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchAttributes.concat(attrs);
};

GmCXt.dom1334.setDefaultMatchAttributes = function() {

    GmCXt.dom1334.matchAttributes = ["id", "class", "title", "href", "src", "name", "type", "alt", "text"];

    let salesforceAttibutes = ["data-type", "data-feed-type", "data-aura-class", "data-ngname", "data-href", "data-src"];

    GmCXt.dom1334.addWorkdayAttibutes();
    GmCXt.dom1334.addSalesforceAttibutes(salesforceAttibutes);
    GmCXt.dom1334.addGmailAttributes();
    GmCXt.dom1334.addHtml5Attributes();

    if (GmCXt.dom1334.skipMatchAttributes !== null && GmCXt.dom1334.skipMatchAttributes.js !== null) {
        GmCXt.dom1334.setSkipMatchAttributes(GmCXt.dom1334.skipMatchAttributes.js);
    }
};

GmCXt.dom1334.setJs1MatchAttributes = function() {

    GmCXt.dom1334.matchAttributes = ["class", "name", "type", "alt", "text"];

    let salesforceAttibutes = ["data-type", "data-feed-type", "data-aura-class", "data-ngname"];

    GmCXt.dom1334.addSalesforceAttibutes(salesforceAttibutes);
    GmCXt.dom1334.addHtml5Attributes();

    if (GmCXt.dom1334.skipMatchAttributes !== null && GmCXt.dom1334.skipMatchAttributes.js1 !== null) {
        GmCXt.dom1334.setSkipMatchAttributes(GmCXt.dom1334.skipMatchAttributes.js1);
    }
};

GmCXt.dom1334.setJs2MatchAttributes = function() {

    GmCXt.dom1334.matchAttributes = ["id", "title", "href", "src", "name", "type", "alt", "text"];

    let salesforceAttibutes = ["data-type", "data-aura-class", "data-href", "data-src"];

    GmCXt.dom1334.addSalesforceAttibutes(salesforceAttibutes);
    GmCXt.dom1334.addGmailAttributes();
    GmCXt.dom1334.addHtml5Attributes();

    if (GmCXt.dom1334.skipMatchAttributes !== null && GmCXt.dom1334.skipMatchAttributes.js2 !== null) {
        GmCXt.dom1334.setSkipMatchAttributes(GmCXt.dom1334.skipMatchAttributes.js2);
    }
};

GmCXt.dom1334.setJs3MatchAttributes = function() {

    GmCXt.dom1334.matchAttributes = ["title", "href", "src", "name", "type", "alt", "text"];

    let salesforceAttibutes = ["data-type", "data-feed-type", "data-ngname", "data-href", "data-src"];

    GmCXt.dom1334.addWorkdayAttibutes();
    GmCXt.dom1334.addSalesforceAttibutes(salesforceAttibutes);
    GmCXt.dom1334.addHtml5Attributes();

    if (GmCXt.dom1334.skipMatchAttributes !== null && GmCXt.dom1334.skipMatchAttributes.js3 !== null) {
        GmCXt.dom1334.setSkipMatchAttributes(GmCXt.dom1334.skipMatchAttributes.js3);
    }
};

/*
    This function sets any attributes configured by user in user settings,
    for matching purpose
*/
GmCXt.dom1334.addHtml5Attributes = function() {
    if (GmCXt.orgSettings) {
        let setting_data = GmCXt.parseJSON(GmCXt.orgSettings);

        if (setting_data && setting_data.matchAlgo &&
			setting_data.matchAlgo.html5Attributes != "") {

            let html5Attributes = setting_data.matchAlgo.html5Attributes.split(",");
            GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchAttributes.concat(html5Attributes);
        }
    }
};

GmCXt.dom1334.getElementPos = function(he) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getElementPos', arguments);

    let rect = he.getBoundingClientRect();
    rect = GmCXt.dom1334.getElementOffset(rect);
    let cssPosition = GmCXt.dom1334.getElementFixedPosition(he);

    let returnValue = {
        position: rect,
        cssPosition: cssPosition
    };

    return GmCXt.l.return(returnValue);
};

/*
    This functions is used to create element data including meta data and  js selectors
    Called from following locations:
     - Step element
     - Tooltip element
     - SmartTip element
     - Becaon element
*/

GmCXt.dom1334.getElement = function(he, criteria, frame) {

    GmCXt.l.reset();
    GmCXt.l.start('function', 'GmCXt.dom1334.getElement', arguments);

    GmCXt.dom1334.reset();

    GmCXt.dom1334.he = he;

    if (!criteria) {
        GmCXt.dom1334.setDefaultCriteria();
    } else {
        GmCXt.dom1334.matchCriteria = criteria;
    }

    let precisionType = GmCXt.dom1334.matchCriteria.precision_type;

    let selector = {
        js: null,
        js1: null,
        js2: null,
        js3: null,
        css: null
    };

    let meta = {
        inTopWindow: (window.self === window.top) ? true : false,
        iframeUrl: GmCXt._location().hostname + GmCXt._location().pathname,
        iframePath: GmCXt._location().pathname,
        iframeTitle: frame.iframeTitle,
        iframeScheme: GmCXt.getUrlScheme(),
        attributes: {}
    };

    GmCXt.dom1334.setTextProperties(he);

    if (precisionType === GmCXt.DOM_CRITERIA_JQUERY) {

        GmCXt.l.add('getElement > jQuery Selector');

        let nodes = GmCXt.dom1334.query(null, GmCXt.dom1334.matchCriteria.jquery_selector);
        meta.score = GmCXt.isOne(nodes) ? 5 : 0;

    } else if (precisionType === GmCXt.DOM_CRITERIA_CUSTOM) {

        GmCXt.l.add('getElement > Custom Selector');

        GmCXt.dom1334.matchAttributes = GmCXt.dom1334.matchCriteria.matchAttributes;

        meta.path = GmCXt.dom1334.getElemPaths(he);
        selector.js = GmCXt.dom1334.getJsSelector(he, meta, true, 'js');

        if (GmCXt.dom1334.matchAttributes.length > 0) {
            meta.score = GmCXt.dom1334.getScore();
        } else {
            meta.score = 0;
        }

    } else if (precisionType === GmCXt.DOM_CRITERIA_DEFAULT) {

        GmCXt.l.add('getElement > Default Selector');

        meta.path = GmCXt.dom1334.getElemPaths(he);

        selector.js = GmCXt.dom1334.getJsSelector(he, meta, true, 'js');

        GmCXt.dom1334.setJs1MatchAttributes();
        selector.js1 = GmCXt.dom1334.getJsSelector(he, meta, false, 'js1');

        GmCXt.dom1334.setJs2MatchAttributes();
        selector.js2 = GmCXt.dom1334.getJsSelector(he, meta, false, 'js2');

        GmCXt.dom1334.setJs3MatchAttributes();
        selector.js3 = GmCXt.dom1334.getJsSelector(he, meta, false, 'js3');

        let selectorCount = GmCXt.dom1334.removeDuplicates(selector);

        meta.score = GmCXt.dom1334.revaluateScore(selectorCount);

    } else {
        GmCXt.l.add('getElement > Identify by Text');

        meta.score = 5;
        // Rest of the processing for identify by text is done by default, 
        // irrespective of the selection of precision type
    }

    // Processing for Identify by text
    GmCXt.dom1334.setIdentifyByTextInfo(he, meta);

    let customSettings = GmCXt.dom1334.getCustomSettings(he);

    let rect = he.getBoundingClientRect();
    rect = GmCXt.dom1334.getElementOffset(rect);

    rect.windowWidth = mg$(window).width();
    rect.windowHeight = mg$(window).height();

    let cssPosition = GmCXt.dom1334.getElementFixedPosition(he);
    // Resets GmCXt.dom1334.skipMatchAttributes
    GmCXt.dom1334.skipMatchAttributes = null;

    let returnValue = {
        version: GmCXt.conf.version,
        selector: selector,
        meta: meta,
        criteria: GmCXt.dom1334.matchCriteria,
        customSettings: customSettings,
        position: rect,
        cssPosition: cssPosition,
        appName: GmCXt.conf.appName,
        xpath: GmCXt.dom1334.getXPath(he)
    };

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.getCustomSettings = function(he) {
    let settings = {};
    let tempHe = he;
    if (GmCXt.checkSalesForceSite()) {
        let salesforce = {};
        let level = 7; // Check for thead upto 7 levels up
        for (let i = 0; i < level; i++) {

            if (tempHe.tagName === 'BODY') break;

            if (tempHe.tagName === 'THEAD') {
                salesforce.tableCategory = 1;

                if (tempHe.parentNode.childNodes.length === 1) {
                    salesforce.tableCategory = 2;
                    break;
                }
                break;
            } else if (tempHe.tagName === 'TBODY') {
                if (mg$(tempHe).children().first().hasClass('headerRow')) {
                    salesforce.tableCategory = 3;
                    break;
                }
            }
            tempHe = tempHe.parentNode;
        }

        let rows = GmCXt.getTableRowsFromHeader(tempHe, salesforce.tableCategory);

        if (rows && mg$(rows).length) {
            settings.salesforce = GmCXt.dom1334.checkColumn(rows, he, salesforce);
        }
    }

    return settings;
};

GmCXt.dom1334.checkColumn = function(rows, he, salesforce) {

    while (he.tagName !== 'TH' && he.tagName !== 'TD') {

        if (he.tagName === 'BODY') break;

        he = he.parentNode;
    }

    if (he && he.tagName !== 'BODY') {
        let columnIndex = mg$(he).parent().children().index(mg$(he));

        for (let i = 0; i < rows.length; i++) {
            let columns = mg$(rows[i]).children();
            if (columns.eq(columnIndex).find('a').length) {
                salesforce.columnIndex = columnIndex;
                salesforce.isClickable = true;
                break;
            }
        }
    }

    return salesforce;
};

GmCXt.dom1334.removeDuplicates = function(selector) {
    let count = 4;

    if (GmCXt.dom1334.isEqual(selector.js3, selector.js) ||
		GmCXt.dom1334.isEqual(selector.js3, selector.js1) ||
		GmCXt.dom1334.isEqual(selector.js3, selector.js2)) {
        selector.js3 = null;
        count--;
    }

    if (GmCXt.dom1334.isEqual(selector.js2, selector.js) ||
		GmCXt.dom1334.isEqual(selector.js2, selector.js1)) {
        selector.js2 = null;
        count--;
    }

    if (GmCXt.dom1334.isEqual(selector.js1, selector.js)) {
        selector.js1 = null;
        count--;
    }

    return count;
};

GmCXt.dom1334.revaluateScore = function(selectorCount) {

    let score = GmCXt.dom1334.getScore();

    if (selectorCount === 2)
        score -= 1;
    else if (selectorCount === 1)
        score -= 2;

    if (score < 1) score = 1;

    return score;
};

GmCXt.dom1334.isEqual = function(a1, a2) {
    if (a1 && a2) {
        if (JSON.stringify(a1) === JSON.stringify(a2))
            return true;
    }
    return false;
};

GmCXt.dom1334.setTextProperties = function(he) {
    if (!GmCXt.dom1334.textPropertyName && he.textContent) {
        GmCXt.dom1334.textPropertyName = 'textContent';
        GmCXt.dom1334.textPropertyValue = he.textContent;
    }

    if (he.tagName === 'INPUT' || he.tagName === 'BUTTON') {
        let value = he.getAttribute('value');
        let placeholder = he.getAttribute('placeholder');

        if (value && (he.type === 'submit' || he.type === 'button')) {
            GmCXt.dom1334.textPropertyName = 'value';
            GmCXt.dom1334.textPropertyValue = value;
        } else if (placeholder) {
            GmCXt.dom1334.textPropertyName = 'placeholder';
            GmCXt.dom1334.textPropertyValue = placeholder;
        }
    }
};

GmCXt.dom1334.getXPath = function(element) {
    if (element.id)
        return '//*[@id="' + element.id + '"]';
    if (element === document.body)
        return element.tagName + '/';

    let ix = 0;

    if (element.parentNode) {
        let siblings = element.parentNode.childNodes;
        for (let i = 0; i < siblings.length; i++) {
            let sibling = siblings[i];
            if (sibling === element)
                return GmCXt.dom1334.getXPath(element.parentNode) + '/' + element.tagName + '[' + (ix + 1) + ']';
            if (sibling.nodeType === 1 && sibling.tagName === element.tagName)
                ix++;
        }
    }
};

GmCXt.dom1334.calculateScore = function(depth) {

    GmCXt.l.start('function', 'GmCXt.dom1334.calculateScore', arguments);

    GmCXt.dom1334.score = 0;

    if (depth > 0) {

        if (depth === GmCXt.dom1334.matchDepth) {
            GmCXt.dom1334.score = 5;

        } else if (depth > 7) {
            GmCXt.dom1334.score = 4;

        } else if (depth > 4) {
            GmCXt.dom1334.score = 3;

        } else if (depth > 2) {
            GmCXt.dom1334.score = 2;

        } else {
            GmCXt.dom1334.score = 1;
        }
    }

    GmCXt.l.end(GmCXt.dom1334.score);
};

GmCXt.dom1334.getScore = function() {
    return GmCXt.dom1334.score;
};

/*
    This function is used to find/select any element matching selectors and criteria configured while creating step.
    This is called from highlighter to select following element:
     - Step element
     - SmartTip element
     - Tooltip element
     - Becaon element     
*/

GmCXt.dom1334.migrateCustomSelectorCriteria = function(criteria) {
    if (criteria.precision_type === GmCXt.DOM_CRITERIA_JQUERY && criteria.jquery_selector_builder) {
        criteria.precision_type = GmCXt.DOM_CRITERIA_CUSTOM;
        criteria.jquery_selector = null;
        delete criteria.jquery_selector_builder;
    }
};

GmCXt.dom1334.finder = function(de, frame, log_stepInfo) {

    GmCXt.l.start('function', 'GmCXt.dom1334.finder', arguments);

    let he = null;
    let nodes = null;

    /*if (window.self !== window.top &&
		(typeof de.meta.iframePath !== 'undefined' && de.meta.iframePath !== GmCXt._location().pathname) &&
		(typeof de.meta.iframeTitle !== 'undefined' && de.meta.iframeTitle !== frame.iframeTitle)) {
		return null;
	}*/

    // If element is not in top window then do not find it in top window 
    if (window.self === window.top && de.meta.inTopWindow === false) {
        return null;
    }
    if (log_stepInfo) GmCXt.l.add(log_stepInfo, true);

    GmCXt.dom1334.migrateCustomSelectorCriteria(de.criteria);

    GmCXt.dom1334.matchCriteria = de.criteria;
    let selector = mg$.extend(true, {}, de.selector);
    let c = GmCXt.dom1334.matchCriteria;

    if (c.precision_type === GmCXt.DOM_CRITERIA_JQUERY) {

        GmCXt.l.add('Selector: jQuery  ' + c.jquery_selector, true);

        nodes = GmCXt.dom1334.query(null, c.jquery_selector);

        if (GmCXt.isOne(nodes)) he = nodes[0];
    } else if (c.precision_type === GmCXt.DOM_CRITERIA_CUSTOM) {

        GmCXt.l.add('Selector: Custom  ' + GmCXt.dom1334.matchCriteria.matchAttributes.join(', '), true);

        he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Strict_Unique_NoTextMatch);
    } else if (c.precision_type === GmCXt.DOM_CRITERIA_DEFAULT) {

        GmCXt.l.add('Selector: Default; Precision: ' + c.precision_level + (c.ignoreText ? 'Ignore Text is checked' : ''), true);

        if (!c.ignoreText)
            he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Unique_TextMatch);

        if (he === null)
            he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Strict_Unique_NoTextMatch);

        if (c.precision_level === "Low") {
            if (he === null)
                he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Flex_Unique_NoTextMatch);

            if (he === null)
                he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Flex_NotUnique_NoTextMatch);
        }
    }

    // Run identifyByText in all cases if element not found for elements with text Content.
    // Check if meta has the property 'textNode' (For steps created after the property was introduced)

    if (c.precision_type === GmCXt.DOM_CRITERIA_TEXT || !c.ignoreText) {
        if (he === null && de.meta.textPropertyValue) {
            if (de.meta.hasOwnProperty('textNode')) {

                GmCXt.l.add("Executing 'Identify By Text' for  " + de.meta.textPropertyValue, true);

                if (de.meta.textNode.position) {
                    he = GmCXt.dom1334.identifyByTextNodePosition(de.meta);
                }

                if (he === null && de.meta.textNode.jquery_selector) {
                    he = GmCXt.dom1334.executeTextBasedJquery(de.meta.textNode.jquery_selector, de.meta.textPropertyValue);
                }

            } else {

                GmCXt.l.add('Identify By Text (old Method)  ' + de.meta.textPropertyValue, true);

                he = GmCXt.dom1334.identifyByText(de, selector);

                if (he === null && c.precision_type === GmCXt.DOM_CRITERIA_TEXT)
                    he = GmCXt.dom1334.findElem(de, selector, GmCXt.dom1334.findElem_Unique_TextMatch);
            }
        }
    }

    let returnValue = he;
    if (he === null) {
        GmCXt.l.addRCA(c.precision_type, de.meta);

        if (de.selector1) {

            GmCXt.l.add('Not found using the current selector, trying another selector . . .');

            let tempDe = mg$.extend(true, {}, de);
            tempDe.selector = de.selector1;
            delete tempDe.selector1;

            returnValue = GmCXt.dom1334.finder(tempDe, frame, log_stepInfo);
        }
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.findElem = function(de, selector, cb) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findElem', arguments);

    GmCXt.l.add('Finding using function: ' + cb.name, true);

    let he = null;

    for (let jsSelectorKey in selector) {

        if (jsSelectorKey !== 'css' && selector[jsSelectorKey]) {

            he = cb(de, selector[jsSelectorKey]);

            let logStr = (he ? "> ELEMENT FOUND" : "> Element not found") + " by selector '" + jsSelectorKey + "'";

            // Older steps will not have the key 'attributes' in meta
            if (de.meta.attributes) {
                let attr = de.meta.attributes[jsSelectorKey];
                if (attr) {
                    logStr += ' containing attributes: ' + attr.join(', ');
                } else {
                    logStr += ' with no attributes; only path as the reference';
                }
            }

            GmCXt.l.add(logStr, true);

            if (he) break;
        }
    }

    return GmCXt.l.return(he);
};

GmCXt.dom1334.identifyByText = function(de, selector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.identifyByText', arguments);

    let he = null;
    let textProperty = de.meta.textPropertyName;

    let newSelector = GmCXt.dom1334.getIdByTextSelector(selector, textProperty);

    he = GmCXt.dom1334.identifyByTextGetEl(de, newSelector, true);

    if (he === null) he = GmCXt.dom1334.identifyByTextGetEl(de, newSelector, false);

    return GmCXt.l.return(he);
};

GmCXt.dom1334.identifyByTextGetEl = function(de, newSelector, visible) {

    GmCXt.l.start('function', 'GmCXt.dom1334.identifyByTextGetEl', arguments);

    if (visible) newSelector += ":visible";

    let he = null;
    let nodes = mg$(document).find(newSelector);
    let prop = de.meta.textPropertyName;

    if (nodes) {

        if (nodes.length && prop === 'textContent') {
            nodes = GmCXt.dom1334.filterTextNodes(nodes, de.meta.textPropertyValue);
        }

        nodes = GmCXt.dom1334.filterParentTextEl(nodes, de.meta.textPropertyValue);

        if (GmCXt.isMany(nodes)) he = nodes[0];
    }

    return GmCXt.l.return(he);
};

// This function remove all parent elements with same text for intentify by text elements.
GmCXt.dom1334.filterParentTextEl = function(nodes, text) {

    GmCXt.l.start('function', 'GmCXt.dom1334.filterParentTextEl', arguments);

    var text = text.trim().toLowerCase();

    nodes.filter(function(index, node) {
        mg$(node).parents().addClass('mgPlayerJSProd_dummy-class');
    });

    nodes = nodes.filter(function(index, node) {
        if (node.innerText) {
            let nodeText = node.innerText.trim().toLowerCase();
            return nodeText === text && !mg$(node).hasClass('mgPlayerJSProd_dummy-class');
        }
    });

    mg$('.mgPlayerJSProd_dummy-class').removeClass('mgPlayerJSProd_dummy-class');

    return GmCXt.l.return(nodes);
};

GmCXt.dom1334.getIdByTextSelector = function(jsSelector, prop) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getIdByTextSelector', arguments);

    let newSel = "";

    if (jsSelector.js) {

        let selector = jsSelector.js.slice(0, 1);

        let attributes = GmCXt.dom1334.getAttributes(selector);
        attributes = attributes[0];

        switch (prop) {

        case "value":
            newSel = attributes.tagName + "[value=" + attributes.value + "]";
            break;

        case "placeholder":
            newSel = attributes.tagName + "[placeholder=" + attributes.placeholder + "]";
            break;

        case "textContent":
            newSel = attributes.tagName;
            break;
        }

        if (attributes.type)
            newSel = newSel + "[type=" + attributes.type + "]";
    }

    return GmCXt.l.return(newSel);
};

GmCXt.dom1334.findElem_Unique_TextMatch = function findElem_Unique_TextMatch(de, jsSelector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findElem_Unique_TextMatch', arguments);

    let he = null;
    let nodes = null;
    let uniquePI = GmCXt.dom1334.getUniqueParentIndex(jsSelector);

    GmCXt.l.add('Unique Parent Index: ' + uniquePI);

    nodes = GmCXt.dom1334.strictTraverse(de, jsSelector, uniquePI);

    if (GmCXt.isMany(nodes))
        he = GmCXt.dom1334.filterByText(de, nodes);

    if (he === null) {

        let o = GmCXt.dom1334.flexibleTraverse(de, jsSelector, uniquePI);

        if (o) {

            if (GmCXt.isMany(o.nodes))
                he = GmCXt.dom1334.filterByText(de, o.nodes);

            if (he === null) {

                nodes = GmCXt.dom1334.removeEqAndQuery(o.parentEl, jsSelector[0]);

                if (GmCXt.isMany(nodes))
                    he = GmCXt.dom1334.filterByText(de, nodes);
            }
        }
    }

    if (he === null)
        he = GmCXt.dom1334.findInUniqueParents(de, jsSelector, 'text');

    return GmCXt.l.return(he);
};

GmCXt.dom1334.removeEqAndQuery = function(el, selector, children) {
    let nodes;
    selector = GmCXt.dom1334.removeEq(selector);

    if (selector) {
        GmCXt.l.add('Removed eq & querying.');
        nodes = GmCXt.dom1334.query(el, selector, children);
    }
    return nodes;
};

GmCXt.dom1334.findElem_Strict_Unique_NoTextMatch = function findElem_Strict_Unique_NoTextMatch(de, jsSelector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findElem_Strict_Unique_NoTextMatch', arguments);

    let returnValue = null;

    let uniquePI = GmCXt.dom1334.getUniqueParentIndex(jsSelector);

    GmCXt.l.add('Unique Parent Index: ' + uniquePI);

    nodes = GmCXt.dom1334.strictTraverse(de, jsSelector, uniquePI);

    if (GmCXt.isOne(nodes))
        returnValue = nodes[0];

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.findElem_Flex_Unique_NoTextMatch = function findElem_Flex_Unique_NoTextMatch(de, jsSelector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findElem_Flex_Unique_NoTextMatch', arguments);

    let he = null;
    let nodes = null;
    let uniquePI = GmCXt.dom1334.getUniqueParentIndex(jsSelector);

    GmCXt.l.add('Unique Parent Index: ' + uniquePI);

    let o = GmCXt.dom1334.flexibleTraverse(de, jsSelector, uniquePI);

    if (o) {
        nodes = o.nodes;

        nodes = GmCXt.dom1334.beforeQuery(jsSelector);

        if (GmCXt.isZero(nodes)) {
            nodes = GmCXt.dom1334.removeEqAndQuery(o.parentEl, jsSelector[0]);
        }

        if (GmCXt.isOne(nodes)) he = nodes[0];
    }

    if (he === null) {
        GmCXt.l.add('Finding in unique parents.');
        he = GmCXt.dom1334.findInUniqueParents(de, jsSelector, 'unique');
    }

    return GmCXt.l.return(he);
};

GmCXt.dom1334.findElem_Flex_NotUnique_NoTextMatch = function findElem_Flex_NotUnique_NoTextMatch(de, jsSelector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findElem_Flex_NotUnique_NoTextMatch', arguments);

    // Pick first if there was only one at the time of element selection, 
    // but found many later.
    // Pick last if element at specified index is not found. 
    // It happens when there are less number of matching elements at find time. 

    let he = null;
    let nodes = null;
    let uniquePI = GmCXt.dom1334.getUniqueParentIndex(jsSelector);

    GmCXt.l.add('Unique Parent Index: ' + uniquePI);

    let o = GmCXt.dom1334.flexibleTraverse(de, jsSelector, uniquePI);

    if (o) {
        nodes = o.nodes;

        if (GmCXt.isMoreThanOne(nodes)) {
            nodes = GmCXt.dom1334.query(null, jsSelector[0]);

            if (GmCXt.isMany(nodes)) nodes = nodes.first();

        } else if (GmCXt.isZero(nodes)) {

            nodes = GmCXt.dom1334.removeEqAndQuery(o.parentEl, jsSelector[0]);

            if (GmCXt.isMany(nodes)) nodes = nodes.last();
        }

        if (GmCXt.isOne(nodes)) he = nodes[0];
    }

    if (he === null)
        he = GmCXt.dom1334.findInUniqueParents(de, jsSelector, 'notUnique');

    return GmCXt.l.return(he);
};

GmCXt.dom1334.filterByText = function(de, nodes) {

    let he = null;
    GmCXt.l.add('FilterByText, number of nodes: ' + nodes.length);

    if (GmCXt.isMany(nodes) && de.meta.textPropertyName === 'textContent') {
        nodes = GmCXt.dom1334.filterTextNodes(nodes, de.meta.textPropertyValue);
    }

    if (GmCXt.isOne(nodes)) {
        he = nodes[0];
        GmCXt.l.add('Found one node.');
    }

    return he;
};

GmCXt.dom1334.strictTraverse = function(de, jsSelector, uniquePI) {

    GmCXt.l.start('function', 'GmCXt.dom1334.strictTraverse', arguments);

    let returnValue = null;
    let nodes = null;
    let he = null;
    var jsSelector = GmCXt.reverse(jsSelector);
    let tot = jsSelector.length;

    for (var i = uniquePI; i < tot; i++) {
        nodes = GmCXt.dom1334.query(he, jsSelector[i], true);

        if (GmCXt.isOne(nodes)) he = nodes[0];
        else break;
    }

    let exitedInLast = (i === (tot - 1));
    let completed = (i === tot);

    if (exitedInLast && GmCXt.isZero(nodes)) {
        nodes = GmCXt.dom1334.removeEqAndQuery(he, jsSelector[i], true);
        if (nodes) nodes = nodes.first();
    }

    if (completed || exitedInLast) {
        if (nodes) {
            returnValue = nodes;
            GmCXt.l.add('Number of nodes found: ' + nodes.length);
        } else {
            GmCXt.l.add('No nodes found.');
        }
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.flexibleTraverse = function(de, jsSelector, uniquePI) {

    GmCXt.l.start('function', 'GmCXt.dom1334.flexibleTraverse', arguments);

    let returnValue = null;
    let nodes = null;
    let parentEl = null;
    var jsSelector = GmCXt.reverse(jsSelector);
    let tot = jsSelector.length;

    for (var i = uniquePI; i < tot; i++) {

        nodes = GmCXt.dom1334.query(parentEl, jsSelector[i], true);

        if (GmCXt.isOne(nodes)) {
            parentEl = nodes[0];
        } else if (parentEl !== null) {

            if (GmCXt.isZero(nodes)) {
                nodes = GmCXt.dom1334.removeEqAndQuery(parentEl, jsSelector[i], true);

                if (nodes) nodes = nodes.last();
            }

            if (GmCXt.isMany(nodes)) parentEl = nodes[0];
        } else {
            break;
        }
    }

    if (nodes && (i === tot || i === (tot - 1))) {
        GmCXt.l.add('Number of nodes found: ' + nodes.length);

        returnValue = {
            nodes: nodes,
            parentEl: parentEl
        };
    } else {
        GmCXt.l.add('No nodes found.');
    }

    return GmCXt.l.return(returnValue);
};

// Returns index of first unique parent of a step element from a selector array
GmCXt.dom1334.getUniqueParentIndex = function(jsSelector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getUniqueParentIndex', arguments);

    let depth = jsSelector.length;
    let start = 0;
    let uniquePI = null;

    while (start < depth) {

        // If unique selector OR if it is last selector
        if (jsSelector[start].indexOf(":eq(") === -1 || start === (depth - 1)) {

            uniquePI = depth - start - 1; // Calculate index in reversed selector array
            break;
        }
        start++;
    }

    return GmCXt.l.return(uniquePI);
};

GmCXt.dom1334.findInUniqueParents = function(de, jsSelector, criteria) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findInUniqueParents', arguments);

    let depth = jsSelector.length;
    let start = 0;
    let uniquePI = null;
    let nodes = null;
    let he = null;

    while (start < depth) {

        // If unique selector OR if it is last selector
        if (jsSelector[start].indexOf(":eq(") === -1 || start === (depth - 1)) {

            uniquePI = depth - start - 1; // Calculate index in reversed selector array
            nodes = GmCXt.dom1334.findInParent(de, jsSelector, uniquePI);

            if (criteria === 'unique') {
                if (GmCXt.isOne(nodes)) he = nodes[0];

            } else if (criteria === 'notUnique') {

                if (GmCXt.isMoreThanOne(nodes)) nodes = nodes.splice(0, 1);

                if (GmCXt.isOne(nodes)) he = nodes[0];

            } else if (criteria === 'text') {
                he = GmCXt.dom1334.filterByText(de, nodes);
            }

            if (he) break;
        }
        start++;
    }

    return GmCXt.l.return(he);
};

GmCXt.dom1334.findInParent = function(de, jsSelector, uniquePI) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findInParent', arguments);

    var jsSelector = GmCXt.reverse(jsSelector);
    let parent = jsSelector[uniquePI];
    let child = jsSelector[jsSelector.length - 1];

    let child_ = GmCXt.dom1334.removeEq(child);
    if (child_) child = child_;

    let returnValue = mg$(parent).find(child);

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.removeEq = function(selector) {

    let returnValue = null;

    let str = selector.match(/^(.*?):eq/g);
    if (str !== null) {
        str = str[0].replace(/:eq/g, '');
        returnValue = str;
    }

    return returnValue;
};

GmCXt.dom1334.query = function(parent, selector, childrenSearch) {

    GmCXt.l.start('function', 'GmCXt.dom1334.query', arguments);

    let returnValue = null;

    // This is only needed in IE
    let isIncludes = selector.indexOf("javascript:");
    if (isIncludes !== -1) {
        selector = selector.replace(/\[href(.*?)'\]/, '');
    }

    if (parent) {
        if (childrenSearch)
            returnValue = mg$(parent).contents(selector);
        else
            returnValue = mg$(parent).find(selector);
    } else
        returnValue = mg$(selector);

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.selectorScore = function(arr) {
    let scoreObj = {};

    for (let i = 0; i < arr.length; i++) {

        let str = arr[i];
        let score = 3;
        str = str.replace(':visible', '');

        if (str.indexOf('SPAN') !== -1 || str.indexOf('DIV') !== -1) {
            str = str.replace('DIV', '');
            str = str.replace('SPAN', '');
            score--;
        }

        if (str.indexOf(':eq') !== -1) {
            str = str.split(':eq')[0];
            score--;
        }

        if (!str) {
            score--;
        }

        scoreObj[arr[i]] = score;
    }

    return scoreObj;
};

GmCXt.dom1334.beforeQuery = function(selector) {

    let uniquePI = GmCXt.dom1334.getUniqueParentIndex(selector);
    let arr = selector.slice(0, uniquePI);
    let scoreObj = GmCXt.dom1334.selectorScore(arr);
    var nodes = null;
    let he = null;

    arr = arr.filter(function(item) {
        if (scoreObj[item] === 0) {
            return false;
        }
        return true;
    });

    var nodes = GmCXt.dom1334.query(null, selector[uniquePI]);
    if (GmCXt.isOne(nodes)) {
        he = nodes[0];
    }
    let returnValue = null;

    for (let i = arr.length - 1; i >= 0; i--) {

        nodes = GmCXt.dom1334.query(he, arr[i]);

        if (GmCXt.isOne(nodes)) {
            he = nodes[0];
            returnValue = nodes;
        }

    }

    return returnValue;
};

GmCXt.dom1334.filterTextNodes = function(nodes, text) {

    GmCXt.l.start('function', 'GmCXt.dom1334.filterTextNodes', arguments);

    text = text.trim().toLowerCase();
    let returnValue = nodes.filter(function(index, node) {
        return mg$(node).text().trim().toLowerCase() === text;
    });

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.getJsSelector = function(he, meta, calculateScore, jsSelectorKey) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getJsSelector', arguments);

    let el = null;
    let index = null;
    let data = [];
    let depth = GmCXt.dom1334.matchDepth;

    while (depth > 0) {

        if (!el) {
            el = he;
        } else {
            el = el.parentNode;
            if (el === document) break;
        }

        if (el) {
            let selector = GmCXt.dom1334.getElementSelector(el, meta, jsSelectorKey);

            let nodes = GmCXt.dom1334.query(null, selector);

            if (GmCXt.isMoreThanOne(nodes)) {
                if (depth === 1) {
                    selector += ':eq(' + mg$(el).index(selector) + ')';
                } else {
                    index = GmCXt.dom1334.getElementIndex(el, selector);
                    if (index !== null) {
                        selector += ':eq(' + index + ')';
                    }
                }
            }

            data.push(selector);

            if (GmCXt.isOne(nodes) && calculateScore) {
                GmCXt.dom1334.calculateScore(depth);
                calculateScore = false;
            }

            depth--;
        }
    }

    return GmCXt.l.return(data);
};

GmCXt.dom1334.getElementIndex = function(el, selector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getElementIndex', arguments);

    let index = null;
    let nodes = GmCXt.dom1334.query(el.parentNode, selector, true);
    for (let i = 0, j = nodes.length; i < j; i++) {
        if (el === nodes[i]) {
            index = i;
            break;
        }
    }

    return GmCXt.l.return(index);
};

GmCXt.dom1334.addAttributeForSelector = function(attr, meta, jsSelectorKey) {
    let attrList = meta.attributes;
    if (attrList) {
        if (!attrList.hasOwnProperty(jsSelectorKey)) {
            attrList[jsSelectorKey] = [attr];
        } else if (attrList[jsSelectorKey].indexOf(attr) < 0) {
            attrList[jsSelectorKey].push(attr);
        }
    }
};

GmCXt.filterValidClasses = function(val) {

    let avoidClassList = ['hide', 'show', 'ascending', 'descending', 'has-focus'];

    if (val && typeof val === 'string') {

        let classes = val.split(' ');

        classes = classes.filter(function(className) {

            className = className.trim();

            if (!className || className.match(/\d+/g) || className.match(/[[\]{}():*+?.,\\^$|#]/g))
                return false;

            for (let i = 0, tot = avoidClassList.length; i < tot; i++) {
                if (className.includes(avoidClassList[i]))
                    return false;
            }

            return true;
        });

        if (classes.length)
            return classes.join('.');
    }
    return '';
};

// This function creator selector string based on matchAttributes
GmCXt.dom1334.getElementSelector = function(el, meta, jsSelectorKey) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getElementSelector', arguments);

    let selector = el.tagName;
    let attr = "";
    let attrs = GmCXt.dom1334.matchAttributes;
    let criteria = GmCXt.dom1334.matchCriteria;

    for (let i = 0, tot = attrs.length; i < tot; i++) {
        attr = attrs[i];
        let validAttr = false;

        switch (attr) {
        case "text":
            var textSelector = GmCXt.dom1334.getTextSelector(el);

            if (textSelector && criteria.precision_type === GmCXt.DOM_CRITERIA_TEXT) {
                selector += textSelector;
                validAttr = true;
            }
            break;
        case "id":
            value = el.getAttribute(attr);

            if (value && !value.match(/\d+/g)) {
                GmCXt.dom1334.idMatchFound = true;
                selector += GmCXt.dom1334.getAttrSelector(attr, value);
                validAttr = true;
            }
            break;
        case "class":
            value = el.getAttribute(attr);

            var classes = GmCXt.filterValidClasses(value);
            if (!GmCXt.isEmpty(classes)) {
                selector += '.' + classes;
                validAttr = true;
            }
            break;
        default:
            value = el.getAttribute(attr);

            if (value) {
                selector += GmCXt.dom1334.getAttrSelector(attr, value);
                validAttr = true;
            }

        }
        if (validAttr) GmCXt.dom1334.addAttributeForSelector(attr, meta, jsSelectorKey);
    }

    let returnValue = selector + ":visible";

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.getElemPaths = function(he) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getElemPaths', arguments);

    let elemId = he.id,
        fromDocument = "",
        fromParent = "",
        parentId = "",
        flag = false,
        parent = "";

    while (he !== document) {
        parent = he.parentNode;

        for (let i = 0, len = parent.childNodes.length; i < len; ++i) {
            if (parent.childNodes[i] === he) {
                fromDocument = i + "," + fromDocument;

                if (!elemId && !flag) {
                    if (parent.id && parent.id.length) {
                        flag = true;
                        fromParent = i + "," + fromParent;
                        parentId = parent.id;
                    }
                }
                break;
            }
        }

        he = he.parentNode;
    }

    let result = {
        fromDocument: fromDocument.slice(0, -1).split(','),
        fromParent: fromParent.slice(0, -1).split(','),
        parentId: parentId
    };

    GmCXt.dom1334.elementpath = result;

    return GmCXt.l.return(result);
};

GmCXt.dom1334.getAttrSelector = function(attr, value) {
    return "[" + attr + "='" + value.replace(/'/g, "\\'") + "']";
};

GmCXt.dom1334.getTextSelector = function(el) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getTextSelector', arguments);

    let value = el.getAttribute('value');
    let placeholder = el.getAttribute('placeholder');
    let selector = null;

    if ((el.tagName === 'INPUT' || el.tagName === 'BUTTON') &&
		(el.type === 'submit' || el.type === 'button')
    ) {
        if (value) {
            GmCXt.dom1334.textPropertyName = 'value';
            GmCXt.dom1334.textPropertyValue = value;
            selector = GmCXt.dom1334.getAttrSelector('value', value);
        }
    }

    if (!selector && el.tagName === 'INPUT' && placeholder) {
        GmCXt.dom1334.textPropertyName = 'placeholder';
        GmCXt.dom1334.textPropertyValue = placeholder;
        selector = GmCXt.dom1334.getAttrSelector('placeholder', placeholder);
    }

    return GmCXt.l.return(selector);
};

GmCXt.dom1334.getElementOffset = function(rect) {
    return {
        left: rect.left,
        top: rect.top,
        width: rect.width,
        height: rect.height
    };
};

GmCXt.dom1334.getElementFixedPosition = function(he) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getElementFixedPosition', arguments);

    let el = mg$(he);
    let all = el.add(el.parents());

    let cssPosition = all.filter(function() {
        return mg$(this).css("position") === "fixed";
    }).length > 0;

    return GmCXt.l.return(cssPosition);
};

GmCXt.dom1334.getElementZindex = function(he) {
    let el = mg$(he);
    let all = el.add(el.parents());

    for (let i = 0; i < all.length; i++) {
        if (mg$(all[i]).css("zIndex") > 0) {
            return mg$(all[i]).css("zIndex");
        }
    }

    return false;
};

// Returns attributes of a element selector in key,value pair
GmCXt.dom1334.getAttributes = function(selector) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getAttributes', arguments);

    let attrList = [];

    selector.forEach(function(selec) {

        let attrObj = {};

        //Get tag name
        let tag = getTagName(selec);
        attrObj.tagName = tag;

        //Gets key value pair of attributes
        let selecAttr = selec.match(/\[(.*?)\]/g);
        if (selecAttr !== null) {
            selecAttr = selecAttr.map(function(val) {
                let temp = val.replace(/\[|\]/g, '');
                return temp.split('=');
            });
        }

        //Adds key value pairs in attrObj
        if (selecAttr !== null) {
            for (let i = 0; i < selecAttr.length; i++) {
                attrObj[selecAttr[i][0]] = selecAttr[i][1];
            }
        }
        attrList.push(attrObj);
    });

    //Gets Tag name
    function getTagName(selec) {
        let tag = selec.match(/^(.*?)\[/g);
        if (tag === null) {
            tag = selec.match(/^(.*?)(:visible|:eq)/g);
            tag = tag[0].replace(/:visible|:eq/g, '');
            return tag;
        } else {
            tag = tag[0].replace(/\[/g, '');
            return tag;
        }
    }

    return GmCXt.l.return(attrList);
};

GmCXt.dom1334.findTargetInputElement = function(he, pathFromLabel, targetTag) {

    GmCXt.l.start('function', 'GmCXt.dom1334.findTargetInputElement', arguments);

    if (pathFromLabel[0] === -1) {
        // Label in child nodes
        while (he.tagName !== targetTag) {
            he = he.parentNode;
            children = mg$(he).find(mg$(targetTag));
            if (children.length > 0) {
                he = children[0];
                break;
            }
        }
    } else {
        if (mg$(he).siblings().length > 0 && he.nextElementSibling) {
            he = he.nextElementSibling;
        }

        let path = GmCXt.reverse(pathFromLabel);
        let i = 0;
        let tot = path.length;

        if (he) {
            while (i < tot) {
                let index = (he.childNodes.length > path[i]) ? path[i] : (he.childNodes.length - 1);
                he = he.childNodes[index];
                i++;
            }
        }

        // TODO: Add a tag check to crosscheck.
        // If not matched, we should jump to target tag in nextElementSibling
        // And pick if found unique

        if (i !== tot) he = null;
    }

    if (he && he.nodeType !== 1) he = null;

    return GmCXt.l.return(he);
};

// ********* IDENTIFY BY TEXT FUNCTIONS **********
// Save Element Info
GmCXt.dom1334.setIdentifyByTextInfo = function(he, meta) {

    GmCXt.l.start('function', 'GmCXt.dom1334.setIdentifyByTextInfo', arguments);

    meta.textPropertyValue = GmCXt.dom1334.textPropertyValue;
    meta.textPropertyName = GmCXt.dom1334.textPropertyName;
    let uniqueTextFlag = false;

    if (meta.textPropertyValue) {

        GmCXt.l.add('Check uniqueness & validity of the detected text  "' + meta.textPropertyValue + '"');

        meta.textNode = {};

        let textType = GmCXt.dom1334.classifyElementText(meta);
        let queryString = GmCXt.dom1334.getQueryString(he.tagName, textType, meta);
        let matches = GmCXt.dom1334.getTextMatches(queryString);
        meta.textNode.jquery_selector = GmCXt.dom1334.generateTextBasedjQuery(he, matches, queryString);

        let filteredMatches = textType ? GmCXt.dom1334.filterParentNodes(matches, meta.textPropertyValue) : matches;
        let length = filteredMatches.length;

        if (length) {
            filteredMatches.each(function(index, node) {
                if (node === he) {
                    meta.tagName = he.tagName;
                    meta.textNode.position = {
                        index: index,
                        length: length
                    };
                    uniqueTextFlag = true;
                }
            });
        }
    }

    GmCXt.l.end(uniqueTextFlag);
};

GmCXt.dom1334.classifyElementText = function(meta) {
    let textProperty = meta.textPropertyName;

    let textType = false;
    if (textProperty === 'textContent' || textProperty === 'text') {
        textType = true;
    }

    return textType;
};

GmCXt.dom1334.getQueryString = function(tagName, textType, meta) {
    let queryString = null;
    let textProperty = meta.textPropertyName;
    let text = meta.textPropertyValue;

    if (text && text.length < 201) {

        // Replace occurences of single quotes & double quotes
        text = text.replace(/\'/g, "\\'").replace(/\"/g, '\\"');

        if (textType) {
            queryString = tagName + ":contains('" + text + "')";
        } else {
            queryString = tagName + "[" + textProperty + "='" + text + "']";
        }
    }

    return queryString;
};

GmCXt.dom1334.getTextMatches = function(queryString) {

    GmCXt.l.start('function', 'GmCXt.dom1334.getTextMatches', arguments);

    let matches = [];

    if (queryString) {
        try {
            matches = mg$(queryString);
        } catch (e) {
            matches = [];
        }
    }

    return GmCXt.l.return(matches);
};

GmCXt.dom1334.filterParentNodes = function(nodes, text) {

    GmCXt.l.start('function', 'GmCXt.dom1334.filterParentNodes', arguments);

    var text = text.trim().toLowerCase();

    nodes = nodes.filter(function(index, node) {
        if (node.innerText && node.innerText.trim().toLowerCase() === text) {
            mg$(node).parents().addClass('mgPlayerJSProd_dummy-class');
            return true;
        }
        return false;
    });

    let childNodes = nodes.filter(function(index, node) {
        return !mg$(node).hasClass('mgPlayerJSProd_dummy-class');
    });

    mg$('.mgPlayerJSProd_dummy-class').removeClass('mgPlayerJSProd_dummy-class');

    let returnValue;
    if (childNodes.length === 1) { // All nodes are hierachichally linked (parent-child)
        returnValue = nodes;
    } else {
        GmCXt.l.add('Text is present at multiple places on the screen');
        returnValue = [];
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.dom1334.generateTextBasedjQuery = function(he, matches, queryString) {

    GmCXt.l.start('function', 'GmCXt.dom1334.generateTextBasedjQuery', arguments);

    let returnValue = null;

    if (matches.length) {
        matches.each(function(index, node) {
            if (node === he) {
                queryString += ':eq(' + index + ')';
                returnValue = queryString;
            }
        });
    }

    return GmCXt.l.return(returnValue);
};

// Find element
GmCXt.dom1334.identifyByTextNodePosition = function(meta) {

    GmCXt.l.start('function', 'GmCXt.dom1334.identifyByTextNodePosition', arguments);

    let textType = GmCXt.dom1334.classifyElementText(meta);
    let queryString = GmCXt.dom1334.getQueryString(meta.tagName, textType, meta);
    let matches = GmCXt.dom1334.getTextMatches(queryString);
    let filteredMatches = textType ? GmCXt.dom1334.filterParentNodes(matches, meta.textPropertyValue) : matches;
    let length = filteredMatches.length;

    let el = null;

    if (length) {

        let pos = meta.textNode.position;

        if (pos.length === length) {
            el = filteredMatches[pos.index];
        } else {
            let indexFromChild = pos.length - pos.index;
            if (length > indexFromChild)
                el = filteredMatches[length - indexFromChild];
        }
    }

    return GmCXt.l.return(el);
};

GmCXt.dom1334.executeTextBasedJquery = function(queryString, text) {

    GmCXt.l.start('function', 'GmCXt.dom1334.executeTextBasedJquery', arguments);

    let returnValue = null;

    let nodes = mg$(queryString);
    let length = nodes.length;

    if (!length || nodes.is(':hidden')) {
        queryString = queryString.split(':eq')[0];
        queryString += ':visible';
        nodes = mg$(queryString);
    }

    nodes = nodes.filter(function(index, node) {
        return node.textContent === text;
    });

    length = nodes.length;

    if (length) {
        returnValue = nodes[length - 1];
    }
    if (returnValue == null) {
        GmCXt.l.add('Could not find element using text based jQuery selector', true);
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.getPosition = function(cssPos) {
    if (cssPos) {
        return 'mgPlayerJSProd_fixed-position';
    } else {
        return 'mgPlayerJSProd_absolute-position';
    }
};
/*global GmCXt,mg$*/
GmCXt.dom = {};

GmCXt.dom.setDefaultCriteria = function() {
    GmCXt.dom.matchCriteria = {
        precision_type: GmCXt.DOM_CRITERIA_DEFAULT,
        ignoreText: false,
        jquery_selector: null,
        matchAttributes: [],
        precision_level: GmCXt.ELEMENT_PRECISION_MEDIUM
    };
};

GmCXt.dom.reset = function() {
    GmCXt.dom.matchDepth = 10;
    GmCXt.dom.score = {};
    GmCXt.dom.textPropertyName = '';
    GmCXt.dom.textPropertyValue = ''; // When found it is element's placeholder or value or textContent
    GmCXt.dom.currentEl = null;
    GmCXt.dom.attributeNames = [];
    GmCXt.dom.selectorAttributes = [];
    GmCXt.dom.uniqueSelectors = [];
    GmCXt.dom.shadowRootIndex = [];
    GmCXt.dom.currentElTag = '';
};

GmCXt.dom.getMatchAttributes = function(jsSelectorKey) {
    let attrList;
    let salesforceAttibutes;
    let gmailAttributes;
    switch (jsSelectorKey) {
    case 'js':
        attrList = ["class", "id", "title", "href", "src", "name", "type", "alt"];
        salesforceAttibutes = ["data-type", "data-feed-type", "data-aura-class", "data-ngname", "data-href", "data-src"];
        gmailAttributes = ["role", "aria-label", "data-tooltip"];

        if (GmCXt.checkWorkdaySite()) attrList.push("data-automation-id");
        break;

    case 'js1':
        attrList = ["class", "name", "type", "alt"];
        salesforceAttibutes = ["data-type", "data-feed-type", "data-aura-class", "data-ngname"];

        break;

    case 'js2':
        attrList = ["id", "title", "href", "src", "name", "type", "alt"];
        salesforceAttibutes = ["data-type", "data-aura-class", "data-href", "data-src"];
        gmailAttributes = ["role", "aria-label", "data-tooltip"];
        break;

    case 'js3':
        attrList = ["title", "href", "src", "name", "type", "alt"];
        salesforceAttibutes = ["data-type", "data-feed-type", "data-ngname", "data-href", "data-src"];
        break;

    case 'custom':
        attrList = GmCXt.dom.getElAttributeNames();
        break;
    }

    if (attrList && jsSelectorKey !== 'custom') {

        if (GmCXt.checkSalesForceSite())
            attrList = attrList.concat(salesforceAttibutes);

        if (GmCXt.checkGmailSite() && gmailAttributes) {
            attrList = attrList.concat(gmailAttributes);
        }

        attrList = GmCXt.dom.removeDynamicAttrs(attrList, jsSelectorKey);
    }

    return attrList;
};

GmCXt.dom.removeDynamicAttrs = function(attrList, jsSelectorKey) {

    // Dynamic attributes are checked when editing a step.
    // Attributes whose value is changed, are not considered in new selector.
    // TODO: Risk of loosing if there is actual change of HTML, so attr does not dynamic value.

    if (GmCXt.dom.dynamicAttrs && GmCXt.dom.dynamicAttrs[jsSelectorKey]) {
        let attrs = GmCXt.dom.dynamicAttrs[jsSelectorKey];
        attrList = attrList.filter(function(attr) {
            return !attrs.includes(attr);
        });
    }
    return attrList;
};

GmCXt.dom.getElAttributeNames = function() {

    // A: List of default attributes in js, js1, js2, js3 selectors 
    GmCXt.dom.selectorAttributes.concat(['placeholder', 'value']); // Text selector also exists in addition to js selectors

    // B: List of all attributes present on element upto 10 levels up
    // Return B minus A
    return GmCXt.dom.attributeNames
        .filter(function(value, index, self) {
            return self.indexOf(value) === index &&
				!GmCXt.dom.selectorAttributes.includes(value) &&
				!value.match(/[[\]{}():*+?.,\\^$|#]/g) &&
				value.indexOf('gm') !== 0;
        })
        .sort();
};

/*
    This functions is used to create element data including meta data and js selectors
    Called from following locations:
     - Step element
     - Tooltip element
     - SmartTip element
     - Beacon element
*/

GmCXt.dom.getElement = function(he, criteria, frame, hoverEl) {

    GmCXt.dom.reset();
    GmCXt.dom.currentEl = he;

    // Set matchCriteria
    if (!criteria) {
        GmCXt.dom.setDefaultCriteria();
    } else {
        GmCXt.dom.matchCriteria = criteria;
    }
    let c = GmCXt.dom.matchCriteria;

    // Set meta
    let meta = {
        inTopWindow: (window.self === window.top) ? true : false,
        iframeUrl: GmCXt._location().hostname + GmCXt._location().pathname,
        iframePath: GmCXt._location().pathname,
        iframeTitle: frame ? frame.iframeTitle : undefined,
        iframeScheme: GmCXt.getUrlScheme(),
        selectorAttributes: {}
    };

    meta.elAttributes = GmCXt.getAttributeValues(he);

    // Text info in meta
    GmCXt.dom.getIdentifyByTextInfo(he, meta);

    // Generate selectors
    let selector = {
        js: null,
        js1: null,
        js2: null,
        js3: null,
        custom: null
    };

    let selectorKeys = Object.keys(selector);

    selectorKeys.forEach(function(key) {
        GmCXt.dom.matchAttributes = GmCXt.dom.getMatchAttributes(key);

        if (GmCXt.dom.matchAttributes.length)
            selector[key] = GmCXt.dom.getJsSelector(key, he, meta);
    });

    let selectorCount = GmCXt.dom.removeDuplicates(selector, meta.selectorAttributes);

    meta.score = GmCXt.dom.revaluateScore(selectorCount, GmCXt.isTextExecutable(c, meta));

    if (!hoverEl) {
        meta.executionPriority = GmCXt.getSelectorExecutionPriority(meta.selectorAttributes);

        // Custom settings (by client url)
        var customSettings = GmCXt.dom.getCustomSettings(he);

        if (GmCXt.isEmpty(GmCXt.dom.shadowRootIndex)) {
            // Available attributes for custom selector
            c.availableAttr = GmCXt.getCustomMatchAttributes(he, meta);

            if (!criteria) {
                c.jquery_selector = GmCXt.dom.generateJQueryFromElAttributes(he, c.availableAttr);
                c.auto_jquery = c.jquery_selector;
            }

            if (c.precision_type === GmCXt.DOM_CRITERIA_CUSTOM) {
                meta.jqueryInfo = GmCXt.dom.getJqueryEqInfo(he, c.jquery_selector);
                meta.score = GmCXt.dom.getCustomQueryScore(meta.jqueryInfo);
            }
        }

        var iframeAttrs = null;
        if (frame && !meta.inTopWindow) {
            iframeAttrs = GmCXt.dom.validateIframeAttributes(frame.attributes);
        }

        var childElements = he.childElementCount;
        if (childElements === 1 && GmCXt.isSvgTag(he.children[0].tagName)) {
            childElements = 0;
        }
        // Resets GmCXt.dom.dynamicAttrs
        GmCXt.dom.dynamicAttrs = null;
    }

    let element = {
        version: GmCXt.conf.version,
        selector: selector,
        meta: meta,
        criteria: c,
        customSettings: customSettings,
        position: GmCXt.dom.getElPosition(he),
        cssPosition: GmCXt.dom.getElementFixedPosition(he),
        appName: GmCXt.conf.appName,
        childElements: childElements,
        xpath: GmCXt.dom.getXPath(he),
        iframeAttrs: iframeAttrs
    };

    if (!hoverEl) {
        GmCXt.log(12, "DOM element", element);
    }

    return element;
};

GmCXt.dom.validateIframeAttributes = function(attrs) {
    let filteredAttrs = {};
    let skipAttributes = ['height', 'width', 'style'];
    for (let key in attrs) {
        let val = attrs[key];
        if (skipAttributes.indexOf(key) < 0 && !GmCXt.isEmpty(val)) {
            if (key === 'id' && val.match(/\d+/g)) {
                continue;
            }
            filteredAttrs[key] = val;
        }
    }
    return filteredAttrs;
};

GmCXt.dom.getElPosition = function(he) {

    let rect = GmCXt.getAbsoluteRectFromIframe(he);
    if (!rect) {
        rect = he.getBoundingClientRect();
    }

    rect = GmCXt.dom.getElementOffset(rect);
    rect.windowWidth = mg$(window).width();
    rect.windowHeight = mg$(window).height();
    return rect;
};

GmCXt.dom.removeDuplicates = function(selector, attrList) {
    let count = 4;

    if (GmCXt.dom.isEqual(selector.js3, selector.js) ||
		GmCXt.dom.isEqual(selector.js3, selector.js1) ||
		GmCXt.dom.isEqual(selector.js3, selector.js2)) {
        delete selector.js3;
        delete attrList.js3;
        count--;
    }

    if (GmCXt.dom.isEqual(selector.js2, selector.js) ||
		GmCXt.dom.isEqual(selector.js2, selector.js1)) {
        delete selector.js2;
        delete attrList.js2;
        count--;
    }

    if (GmCXt.dom.isEqual(selector.js1, selector.js)) {
        delete selector.js1;
        delete attrList.js1;
        count--;
    }

    return count;
};

GmCXt.dom.revaluateScore = function(selectorCount, validTextQuery) {

    let score = GmCXt.dom.getScore();

    if (selectorCount === 2)
        score -= 1;
    else if (selectorCount === 1)
        score -= 2;

    if (score < 5 && validTextQuery)
        score += 1;

    if (score < 1) score = 1;

    return score;
};

GmCXt.dom.isEqual = function(a1, a2) {
    if (a1 && a2) {
        if (JSON.stringify(a1) === JSON.stringify(a2))
            return true;
    }
    return false;
};

GmCXt.dom.getXPath = function(element) {
    if (element.id)
        return '//*[@id="' + element.id + '"]';
    if (element === document.body)
        return element.tagName + '/';

    let ix = 0;

    if (element.parentNode) {
        let siblings = element.parentNode.childNodes;
        for (let i = 0; i < siblings.length; i++) {
            let sibling = siblings[i];
            if (sibling === element)
                return GmCXt.dom.getXPath(element.parentNode) + '/' + element.tagName + '[' + (ix + 1) + ']';
            if (sibling.nodeType === 1 && sibling.tagName === element.tagName)
                ix++;
        }
    }
};

GmCXt.dom.getJqueryEqInfo = function(el, selector) {

    let info = {};

    try {
        if (!selector) info.invalid = true;
        else {
            if (selector.includes(':eq('))
                selector = selector.split(':eq(')[0];
            
            let contextDoc = el.ownerDocument || document;

            selector = GmCXt.getIframeQuery(selector);

            let nodes = mg$(selector, contextDoc);

            if (GmCXt.isZero(nodes)) {
                info.invalid = true;
            } else if (GmCXt.isOne(nodes)) {
                info.unique = true;
            } else {

                let length = nodes.length;
                nodes.each(function(index, node) {
                    if (node === el) {
                        info.index = index;
                        info.length = length;
                        return false;
                    }
                });

                // If el is not found in nodes
                if (isNaN(info.index)) {
                    info.invalid = true;
                }
            }
        }
    } catch (e) {
        info.invalid = true;
    } finally {
        return info;
    }
};

GmCXt.dom.getCustomQueryScore = function(info) {

    if (!info || info.invalid) return 0;

    if (info.unique) return 5;

    return 3;
};

GmCXt.dom.generateJQueryFromElAttributes = function(he, attrList) {
    let filteredAttr = attrList.filter(function(attr) {
        let val = he.getAttribute(attr);

        if (attr === 'text')
            return true;

        if (typeof value === 'string' && val.length > 250)
            return false;

        return true;
    });

    filteredAttr.sort(function(a, b) {
        return GmCXt.getAttributePriority(a, he) - GmCXt.getAttributePriority(b, he);
    });

    let selectorArr = [];
    let selector = '';
    for (let i = 0; i < filteredAttr.length; i++) {
        selector = GmCXt.dom.getElementSelector(null, he, null, filteredAttr.slice(0, i + 1));
        var selectorInfo = GmCXt.dom.getJqueryEqInfo(he, selector);

        if (selectorInfo.unique) return selector;
        else {

            if (selectorInfo.length) {
                selectorArr.push({
                    selector: selector,
                    matches: selectorInfo.length
                });
            }

            selector = GmCXt.dom.getElementSelector(null, he, null, [filteredAttr[i]]);
            var selectorInfo = GmCXt.dom.getJqueryEqInfo(he, selector);

            if (selectorInfo.unique) return selector;
            else if (selectorInfo.length) {
                selectorArr.push({
                    selector: selector,
                    matches: selectorInfo.length
                });
            }
        }
    }

    // No unique selector found by attributes, attempting to find by ref queries
    if (!GmCXt.isEmpty(GmCXt.dom.uniqueSelectors) && !GmCXt.isEmpty(selectorArr)) {

        selectorArr.sort(function(a, b) {
            return a.matches - b.matches;
        });

        GmCXt.dom.uniqueSelectors.sort(function(a, b) {
            return a.depth - b.depth;
        });

        for (let j = 0; j < GmCXt.dom.uniqueSelectors.length; j++) {
            selector = GmCXt.dom.uniqueSelectors[j].selector + " " + selectorArr[0].selector;

            var selectorInfo = GmCXt.dom.getJqueryEqInfo(he, selector);

            if (selectorInfo.unique) return selector;
        }
    }

    return null;
};

GmCXt.dom.calculateScore = function(depth, key) {

    GmCXt.dom.score[key] = 0;
    if (depth > 0) {

        if (depth === GmCXt.dom.matchDepth) {
            GmCXt.dom.score[key] = 5;

        } else if (depth > 7) {
            GmCXt.dom.score[key] = 4;

        } else if (depth > 4) {
            GmCXt.dom.score[key] = 3;

        } else if (depth > 2) {
            GmCXt.dom.score[key] = 2;

        } else if (depth > 0) {
            GmCXt.dom.score[key] = 1;
        }
    }
};

GmCXt.dom.getScore = function() {

    if (GmCXt.isEmpty(GmCXt.dom.score)) return 0;

    let sum = 0;
    let ctr = 0;
    for (let key in GmCXt.dom.score) {
        sum += GmCXt.dom.score[key];
        ctr++;
    }

    return Math.round(sum / ctr);
};

GmCXt.dom.tFinder = function(de, frame, log_stepInfo) {

    let he = null;
	
    // If element is not in top window then do not find it in top window 
    if (window.self === window.top && de.meta.inTopWindow === false) {
        return null;
    }

    GmCXt.dom.matchCriteria = de.criteria;
    let c = GmCXt.dom.matchCriteria;

    if (!GmCXt.isEmpty(c.jquery_selector)) {
        he = GmCXt.dom.findElByCustomQuery(c, de.meta);
    }

    return he;
};

GmCXt.dom.finder = function(de, frame, log_stepInfo, strictOnly) {

    GmCXt.l.start('function', 'finder', arguments);

    GmCXt.dom.trackFinderRequest(log_stepInfo);

    let he = null;
    GmCXt.dom.tempHe = null;

    // If element is not in top window then do not find it in top window 
    if (window.self === window.top && de.meta.inTopWindow === false) {
        return null;
    }

    if (log_stepInfo && !log_stepInfo.includes('[El Rule]')) GmCXt.l.add(log_stepInfo, true);

    de = GmCXt.migrateMatchAlgoSetting(de);

    let selector = mg$.extend(true, {}, de.selector);

    GmCXt.dom.matchCriteria = de.criteria;
    let c = GmCXt.dom.matchCriteria;

    GmCXt.l.add('Selector: ' + c.precision_type + '; Precision: ' + c.precision_level + (c.ignoreText ? '; Ignore Text is checked' : ''), true);

    if (c.precision_level === 'High' && de.meta.inTopWindow) {
        strictOnly = true;
    }

    let skipDefault = false;
    if (c.precision_type === GmCXt.DOM_CRITERIA_CUSTOM || (de.isQuickFindEl && !GmCXt.isEmpty(c.jquery_selector))) {
        he = GmCXt.dom.findElByCustomQuery(c, de.meta);

        // If custom query has been specified, find ONLY by custom query in the 'strictOnly' cycles
        skipDefault = c.precision_level === 'High' ? true : strictOnly; // custom query with High will not go with default selector

        if (c.precision_level === 'Medium') {
            strictOnly = true; // custom query with Medium level will only do strict traverse on default selectors;
        }
    }

    if (!skipDefault) {
        if (!he) {
            he = GmCXt.dom.findElementBySelector(de, selector, strictOnly);
        }

        if (!he && de.meta.textPropertyValue && !de.meta.hasOwnProperty('textNode')) {
            GmCXt.l.add('Identify By Text (Old Method)  ' + de.meta.textPropertyValue, true);
            he = GmCXt.dom.identifyByText(de, selector);
        }
    }

    let returnValue = he;
    if (!he) {
        GmCXt.l.addRCA(c, de.meta);

        if (de.selector1) {

            GmCXt.l.add('Not found using the current selector, trying another selector . . .');

            let tempDe = mg$.extend(true, {}, de);
            tempDe.selector = de.selector1;
            delete tempDe.selector1;

            returnValue = GmCXt.dom.finder(tempDe, frame, log_stepInfo, strictOnly);
        }
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.dom.findElByCustomQuery = function(criteria, meta) {

    GmCXt.l.start('function', 'findElByCustomQuery', arguments);

    let he = null;
    let jquerySelector = criteria.jquery_selector;

    let removeEq = false;
    if ((criteria.precision_type === GmCXt.DOM_CRITERIA_DEFAULT && criteria.precision_level !== "High") &&
		(meta.jqueryInfo && !meta.jqueryInfo.unique)) {
        querySplit = criteria.jquery_selector.split(":eq(");
        if (querySplit[1].length < 3) { // eq is at the end of the selector, not in the middle
            removeEq = true;
            jquerySelector = querySplit[0] + ":eq(" + meta.jqueryInfo.index + ")";
        }
    }
	
    GmCXt.l.add("Finding using Custom jQuery Selector - " + jquerySelector, true);
    let nodes = GmCXt.dom.query(null, jquerySelector);

    if (GmCXt.isOne(nodes)) {
        he = nodes[0];
        GmCXt.l.add("> ELEMENT FOUND by custom selector", true);
    } else if (removeEq) {
        GmCXt.l.add("> Could not find unique element on executing the query", true);

        nodes = GmCXt.dom.removeEqAndQuery(null, jquerySelector);
        let noOfNodes = nodes.length;

        if (noOfNodes) {
            if (meta.jqueryInfo) {
                let indexFromChild = meta.jqueryInfo.length - meta.jqueryInfo.index;
                if (indexFromChild < noOfNodes) {
                    he = nodes[noOfNodes - indexFromChild];
                    GmCXt.l.add("> ELEMENT FOUND by picking closest index in resulting nodes", true);
                }
            }
            if (!he) {
                he = nodes[noOfNodes - 1];
                GmCXt.l.add("> ELEMENT FOUND by picking last index in resulting nodes", true);
            }
        }
    }

    return GmCXt.l.return(he);
};

GmCXt.dom.flexFind = function(selector, key, c, m, workdayInput) {

    let jsSelector = selector[key];
    let he = null;
    let nodes = null;

    if (jsSelector) {

        let o = GmCXt.dom.flexibleTraverse(jsSelector);
        if (o) {
            nodes = o.nodes;

            he = GmCXt.filterEl(nodes, c, m);

            if (!he && c.precision_level === "Low") {

                nodes = GmCXt.dom.beforeQuery(jsSelector);
                he = GmCXt.filterEl(nodes, c, m);

                if (!he) {
                    nodes = GmCXt.dom.removeEqAndQuery(o.parentEl, jsSelector[0]);
                    he = GmCXt.filterEl(nodes, c, m);
                }

                if (!he) {
                    he = o.parentEl;
                }
            }
        }

    } else if (key === 'text' && GmCXt.isTextExecutable(c, m)) {

        he = GmCXt.dom.executeTextBasedJquery(m.textNode.jquery_selector, m.textPropertyValue, workdayInput);
    }

    return he;
};

GmCXt.dom.strictFind = function(selector, key, c, m, workdayInput) {

    let jsSelector = selector[key];
    let he = null;

    if (jsSelector) {

        nodes = GmCXt.dom.strictTraverse(jsSelector);
        he = GmCXt.filterEl(nodes, c, m);

        if (!he && GmCXt.isOne(nodes) && GmCXt.isTextExecutable(c, m)) {
            GmCXt.dom.tempHe = nodes[0];
            if (GmCXt.dom.tempHe.className.includes('gss')) {
                GmCXt.dom.tempHe = null;
            }
        }

    } else if (key === 'text' && GmCXt.isTextExecutable(c, m)) {
        he = GmCXt.dom.identifyByTextNodePosition(m, workdayInput);
    }

    if (he && workdayInput && !GmCXt.dom.checkOpaque(he)) {
        return null;
    }

    return he;
};

GmCXt.dom.executeSelectors = function(de, selector, cb) {

    let he = null;
    let c = de.criteria;
    let m = de.meta;
    let priority = m.executionPriority;

    if (de.hasOwnProperty('customSettings'))
        var workdayInput = GmCXt.dom.isWorkdayInputType(de.customSettings.workday);

    for (let i = 0; i < priority.length; i++) {
        let key = priority[i];

        he = cb(selector, key, c, m, workdayInput);

        GmCXt.logSelectorOutcome(he, m, key);

        if (he) break;
    }

    return he;
};

GmCXt.dom.findElementBySelector = function(de, selector, strictOnly) {

    GmCXt.l.start('function', 'findElementBySelector', arguments);

    GmCXt.l.add('Finding using strict traverse. . .', true);

    let he = GmCXt.dom.executeSelectors(de, selector, GmCXt.dom.strictFind);

    if (!strictOnly) {
        if (!he) {
            GmCXt.l.add('Finding using flexible traverse. . .', true);
            he = GmCXt.dom.executeSelectors(de, selector, GmCXt.dom.flexFind);
        }

        if (!he) {
            GmCXt.l.add('Finding in parent nodes. . .', true);
            he = GmCXt.dom.executeSelectors(de, selector, GmCXt.dom.findInUniqueParents);
        }
    }

    if (!he && GmCXt.dom.tempHe && de.criteria.precision_level === 'Low') {
        he = GmCXt.dom.tempHe;
    }

    return GmCXt.l.return(he);
};

GmCXt.filterEl = function(nodes, criteria, meta) {

    GmCXt.l.start('function', 'filterEl', arguments);

    let he = null;

    if (GmCXt.isMany(nodes) && GmCXt.isTextExecutable(criteria, meta) && meta.textPropertyName === 'textContent')
        nodes = GmCXt.dom.filterByText(nodes, meta.textPropertyValue);

    if (GmCXt.isOne(nodes))
        he = nodes[0];

    return GmCXt.l.return(he);
};

GmCXt.isTextExecutable = function(criteria, meta) {
    return (!criteria.ignoreText && !GmCXt.isEmpty(meta.textPropertyValue) && meta.hasOwnProperty('textNode'));
};

GmCXt.dom.filterByText = function(nodes, text) {

    GmCXt.l.start('function', 'filterByText', arguments);

    text = text.trim().toLowerCase();
    let returnValue = nodes.filter(function(index, node) {
        return mg$(node).text().trim().toLowerCase() === text;
    });

    return GmCXt.l.return(returnValue);
};

GmCXt.logSelectorOutcome = function(he, meta, jsSelectorKey) {

    let logStr = (he ? "> ELEMENT FOUND" : "> Element not found") + " by selector '" + jsSelectorKey + "'";

    // Older steps will not have the key 'selectorAttributes' in meta
    if (jsSelectorKey !== 'text' && meta.selectorAttributes) {
        let attr = meta.selectorAttributes[jsSelectorKey];
        if (attr) {
            logStr += ' containing attributes: ' + attr.join(', ');
        } else {
            logStr += ' with no attributes; only path as the reference';
        }
    }

    GmCXt.l.add(logStr, true);
};

// ******************* TRAVERSAL ********************
// Returns index of first unique parent of a step element from a selector array
GmCXt.dom.getUniqueParentIndex = function(jsSelector) {

    GmCXt.l.start('function', 'getUniqueParentIndex', arguments);

    let uniquePI = null;
    let length = jsSelector.length;
    let i = 0;
    if (jsSelector.indexOf('shadowRoot') !== -1) {
        i = jsSelector.lastIndexOf("shadowRoot") + 1;
    }

    for (; i < length; i++) {
        let selector = jsSelector[i];

        // If unique selector OR if it is last selector
        if (selector.indexOf(":eq(") === -1 || i === (length - 1)) {
            uniquePI = i;
            break;
        }
    }

    return GmCXt.l.return(uniquePI);
};

GmCXt.dom.strictTraverse = function(jsSelector) {

    GmCXt.l.start('function', 'strictTraverse', arguments);

    let returnValue = null;
    let nodes = null;
    let he = null;
    let uniquePI = GmCXt.dom.getUniqueParentIndex(jsSelector);

    GmCXt.l.add('Unique Parent Index: ' + uniquePI, true);

    for (var i = uniquePI; i >= 0; i--) {
        nodes = GmCXt.dom.query(he, jsSelector[i], true);

        if (GmCXt.isOne(nodes)) {
            he = nodes[0];
            GmCXt.l.add("At index " + i + " in the selector, found an unique element by querying  " + jsSelector[i]);
        } else {
            if (i === 0 && GmCXt.isZero(nodes)) {
                // Flexible for last index
                nodes = GmCXt.dom.removeEqAndQuery(he, jsSelector[i], true);

                if (nodes) nodes = nodes.last();

            } else break;
        }
    }

    if (nodes && i <= 1)
        returnValue = nodes;

    return GmCXt.l.return(returnValue);
};

GmCXt.dom.flexibleTraverse = function(jsSelector, uniquePI) {

    GmCXt.l.start('function', 'flexibleTraverse', arguments);

    let returnValue = null;
    let nodes = null;
    let he = null;
    var uniquePI = GmCXt.dom.getUniqueParentIndex(jsSelector);

    for (var i = uniquePI; i >= 0; i--) {
        nodes = GmCXt.dom.query(he, jsSelector[i], true);

        if (GmCXt.isOne(nodes)) {
            he = nodes[0];
            GmCXt.l.add("At index " + i + " in the selector, found an unique element by querying  " + jsSelector[i]);
        } else if (!he) {

            if (GmCXt.isMany(nodes)) {
                he = nodes[0];
                GmCXt.l.add("At index " + i + " in the selector, picking 1st of " + nodes.length + " resulting nodes on querying  " + jsSelector[i]);
            }

            if (GmCXt.isZero(nodes)) {
                nodes = GmCXt.dom.removeEqAndQuery(he, jsSelector[i], true);

                if (nodes) {
                    GmCXt.l.add("At index " + i + " in the selector, picking last of " + nodes.length + " resulting nodes on querying (without eq)  " + jsSelector[i]);
                    nodes = nodes.last();
                }
            }

        } else break;
    }

    if (nodes && i <= 1)
        returnValue = {
            nodes: nodes,
            parentEl: he
        };

    return GmCXt.l.return(returnValue);
};

GmCXt.dom.findInUniqueParents = function(selector, key, criteria, meta) {

    GmCXt.l.start('function', 'findInUniqueParents', arguments);

    let he = null;
    let nodes = null;
    let jsSelector = selector[key];

    if (jsSelector) {
        let length = jsSelector.length;

        for (let i = 0; i < length; i++) {
            var selector = jsSelector[i];

            // If unique selector OR if it is last selector
            if (selector.indexOf(":eq(") === -1 || i === (length - 1)) {

                nodes = GmCXt.dom.findInParent(jsSelector, i);

                he = GmCXt.filterEl(nodes, criteria, meta);

                if (!he && criteria.precision_level === "Low" && GmCXt.isMoreThanOne(nodes)) {
                    he = nodes[0];
                }

                if (he) break;
            }
        }
    }

    return GmCXt.l.return(he);
};

// ******************* QUERYING ********************
GmCXt.dom.query = function(parent, selector, childrenSearch) {

    GmCXt.dom.trackQueryRequest();

    let nodes = null;

    if(selector.indexOf("!") !== -1){
        return [];
    }

    // This is only needed in IE
    let isIncludes = selector.indexOf("javascript:");
    if (isIncludes !== -1) {
        selector = selector.replace(/\[href(.*?)'\]/, '');
    }

    if (parent) {
        if (selector === 'shadowRoot') {
            return [parent.shadowRoot];
        }
        if (parent.nodeName === '#document-fragment') {
            return [parent.children];
        }
        if (childrenSearch){
            nodes = mg$(parent).contents(selector);
        } else {
            nodes = mg$(parent).find(selector);
        }
        return nodes;
    }

    nodes = GmCXt.getNodeFromIframeQuery(selector);

    return nodes;
};

GmCXt.dom.removeEq = function(selector) {
    return selector.split(':eq')[0];
};

GmCXt.dom.removeEqAndQuery = function(parent, selector, childrenSearch) {
    selector = GmCXt.dom.removeEq(selector);

    let nodes = GmCXt.dom.query(parent, selector, childrenSearch);

    return nodes;
};

GmCXt.dom.findInParent = function(jsSelector, uniquePI) {

    GmCXt.l.start('function', 'findInParent', arguments);

    let parent = jsSelector[uniquePI];
    let child = jsSelector[0];

    let child_ = GmCXt.dom.removeEq(child);
    if (child_) child = child_;

    let returnValue = mg$(parent).find(child);

    return GmCXt.l.return(returnValue);
};

GmCXt.dom.selectorScore = function(arr) {
    let scoreObj = {};

    for (let i = 0; i < arr.length; i++) {

        let str = arr[i];
        let score = 3;
        str = str.replace(':visible', '');

        if (str.indexOf('SPAN') !== -1 || str.indexOf('DIV') !== -1) {
            str = str.replace('DIV', '');
            str = str.replace('SPAN', '');
            score--;
        }

        if (str.indexOf(':eq') !== -1) {
            str = str.split(':eq')[0];
            score--;
        }

        if (!str) {
            score--;
        }

        scoreObj[arr[i]] = score;
    }

    return scoreObj;
};

GmCXt.dom.beforeQuery = function(selector) {

    let uniquePI = GmCXt.dom.getUniqueParentIndex(selector);
    let arr = selector.slice(0, uniquePI);
    let scoreObj = GmCXt.dom.selectorScore(arr);
    var nodes = null;
    let he = null;

    arr = arr.filter(function(item) {
        if (scoreObj === 0) {
            return false;
        }
        return true;
    });

    var nodes = GmCXt.dom.query(null, selector[uniquePI]);
    if (GmCXt.isOne(nodes)) {
        he = nodes[0];
    }
    let returnValue = null;

    for (let i = arr.length - 1; i >= 0; i--) {
        nodes = GmCXt.dom.query(he, arr[i]);

        if (GmCXt.isOne(nodes)) {
            he = nodes[0];
            returnValue = nodes;
        } else break;
    }

    return returnValue;
};
// ******************* FIND ACTUAL EL FROM LABEL ********************
GmCXt.dom.findTargetInputElement = function(he, pathFromLabel, targetInfo, de, ruleEl) {

    GmCXt.l.start('function', 'findTargetInputElement', arguments);

    let wdCustomSelect = false;

    if (!Array.isArray(pathFromLabel)) {
        for (var i = 0; i < pathFromLabel; i++) {
            he = he.parentNode;
        }
    } else {
        let str = '';
        if (targetInfo) {
            str = targetInfo.tagName;
            if (targetInfo.tagName === 'INPUT' && targetInfo.type) {
                str += "[type='" + targetInfo.type + "']";
            }
        }

        if (he.tagName === 'LABEL') {
            if (GmCXt.checkWorkdayTextfield(de)) {
                if (de.customSettings.workday.isWDCustomSelect) {
                    wdCustomSelect = true;
                    str = 'DIV[data-automation-id="multiselectInputContainer"]';
                }
                he = he.parentNode;
            } else if (GmCXt.dom.sfTextArea(de)) {
                he = he.parentNode;
            }
        }

        if (pathFromLabel[0] === -1 && str) {
            // Label in child nodes
            while (he && (he.tagName !== targetInfo.tagName || wdCustomSelect)) {
                he = he.parentNode;
                children = mg$(he).find(mg$(str));
                if (children.length > 0) {
                    he = children[0];
                    break;
                }
            }
        } else {
            if (mg$(he).siblings().length > 0 && he.nextElementSibling) {
                he = he.nextElementSibling;
            }

            let path = GmCXt.reverse(pathFromLabel);
            var i = 0;
            let tot = path.length;

            if (he) {
                while (he && i < tot) {
                    let index = (he.childNodes.length > path[i]) ? path[i] : (he.childNodes.length - 1);
                    he = he.childNodes[index];
                    if (GmCXt.checkWorkdaySite() && he &&
						mg$(he).children('[data-automation-id*="errorWidget"]').length && he.nextElementSibling) {
                        he = he.nextElementSibling;
                    }
                    i++;
                }
            }

            if (!ruleEl && GmCXt.checkWorkdayTextfield(de) && he) {
                let wd = de.customSettings.workday;
                if (wd && (wd.isInput || wd.isSelectBox)) {
                    if (he.tagName !== 'INPUT' && !mg$(he).find('input').length &&
						mg$(he).attr('data-automation-id') !== 'selectWidget')
                        he = null;
                }
            }

            // TODO: Add a tag check to crosscheck.
            // If not matched, we should jump to target tag in nextElementSibling
            // And pick if found unique

            if (i !== tot) he = null;
        }

        if (he && GmCXt.dom.isWDTextArea(de)) {
            let expandedHe = GmCXt.dom.checkForExpandedTextBox(he, de.meta);
            if (expandedHe) {
                he = expandedHe;
            }
        }
    }

    return GmCXt.l.return(he);
};

GmCXt.dom.isWDTextArea = function(de) {
    if (de.hasOwnProperty('customSettings')) {
        let s = de.customSettings.workday;
        return s && s.isTextarea;
    }
    return false;
};

// ******************* GENERATE SELECTOR ********************

GmCXt.dom.getJsSelector = function(jsSelectorKey, he, meta) {

    let calculateScore = true;

    let el = null;
    var index = null;
    let data = [];
    let depth = GmCXt.dom.matchDepth;
    let shadowRoot = false;
    let uniqueElIndex = [];

    while (depth > 0 || shadowRoot) {

        if (!el) {
            el = he;
        } else {
            el = el.parentNode;
            if (el instanceof ShadowRoot) {
                shadowRoot = true;
                data.push('shadowRoot');
                GmCXt.dom.shadowRootIndex.push(data.length - 1);
                el = el.host;
            }
            if (el === document) break;
        }

        if (el) {
            let selector = GmCXt.dom.getElementSelector(jsSelectorKey, el, meta);

            let nodes = GmCXt.dom.query(null, selector);

            if (!GmCXt.isOne(nodes)) {
                if (depth === 1 && !shadowRoot) {
                    // find eq when queried in document  for outermost selector
                    selector += ':eq(' + mg$(el).index(selector) + ')';
                } else {
                    // find eq when queried in parent node - for all intermediate selectors
                    index = GmCXt.dom.getElementIndex(el, selector);
                    if (index !== null) {
                        selector += ':eq(' + index + ')';
                    }
                }
            }

            data.push(selector);

            if (GmCXt.isOne(nodes)) {
                if (shadowRoot) {
                    uniqueElIndex.push(data.length - 1);
                } else if (calculateScore) {
                    GmCXt.dom.uniqueSelectors.push({
                        selector: selector,
                        depth: (10 - depth)
                    });

                    GmCXt.dom.calculateScore(depth, jsSelectorKey);

                    calculateScore = false;
                }
            }

            if (jsSelectorKey === 'js') {
                // Add to global attribute list for all 10 parents
                let attributes = '';
                if (el instanceof Document){
                    attributes = el.getAttributeNames();
                } 
                GmCXt.dom.attributeNames = GmCXt.dom.attributeNames.concat(attributes);
            }

            depth--;
        }
    }

    if (shadowRoot) {
        let lastIndex = data.lastIndexOf("shadowRoot");
        var index = data.length - 1;

        // uniqueElIndex cannot be empty
        // It will either point to a unique parent closer to the el or point to the body tag (which is always unique)
        for (let i = 0; i < uniqueElIndex.length; i++) {
            if (uniqueElIndex[i] > lastIndex) {
                index = uniqueElIndex[i];
                break;
            }
        }

        depth = 10 - (index - lastIndex); // Depth of outermost shadow-root to the unique el closest to it
        depth = (depth < 1) ? 1 : depth;
        GmCXt.dom.calculateScore(depth, jsSelectorKey); // max score will be 4 as depth will always be less than 10

        index = Math.max(9, index); // Length of the selector  greater than 10 aswell as the uniqueEl outside the outermost shadow-root
        data = data.splice(0, index + 1); // splice at uniqueEl - therefore no eq adjustment required
    }

    return data;
};

// This function creates a selector string based on attributes
GmCXt.dom.getElementSelector = function(jsSelectorKey, el, meta, customAttributes) {

    let isCustom = el ? false : true;
    let attributes = customAttributes || GmCXt.dom.matchAttributes;
    let i = attributes.indexOf('class');

    if (i >= 0) {
        let l = attributes.length;
        attributes[i] = attributes[l - 1];
        attributes[l - 1] = 'class';
    }

    let attrObj = isCustom ? meta.elAttributes : GmCXt.getAttributeValues(el, attributes);

    let selector = attrObj.tagName;
    let attrCtr = 0;
    attributes.forEach(function(attr) {
        let validAttr = false;

        switch (attr) {
        case "text":
            var textSelector = GmCXt.dom.getTextSelector(attr, attrObj[attr], !isCustom);

            if (textSelector) {
                selector += textSelector;
                validAttr = true;
                attrCtr++;
            }
            break;

        case "id":
            var idSelector = GmCXt.dom.getIdSelector(attr, attrObj[attr], !isCustom);

            if (idSelector) {
                selector += idSelector;
                validAttr = true;
                attrCtr++;
            }
            break;

        case "class":
            value = attrObj[attr];

            if (value) {

                value = GmCXt.dom.getClassSelector(attr, attrObj[attr], !isCustom, attrCtr);

                if (!GmCXt.isEmpty(value)) {
                    selector += '.' + value;
                    validAttr = true;
                }
            }
            break;

        default:
            value = attrObj[attr];

            if (value) {
                if (jsSelectorKey === 'custom') {
                    value = GmCXt.dom.skipSpecialCharValue(value);
                }
                if (!GmCXt.isEmpty(value)) {
                    let textAttr = ['placeholder', 'value', 'title', 'name'];

                    let attrSelector = '';
                    if (attr.includes('Id') || attr.toLowerCase().indexOf('id') === 0 ||
							attr.toLowerCase().includes('_id') || attr.toLowerCase().includes('-id')) {
                        attrSelector = GmCXt.dom.getIdSelector(attr, value, !isCustom);
                    } else if (textAttr.includes(attr)) {
                        attrSelector = GmCXt.dom.getTextSelector(attr, value, !isCustom);
                    } else {
                        attrSelector = GmCXt.dom.getAttrSelector(attr, value);
                    }

                    if (!GmCXt.isEmpty(attrSelector)) {
                        selector += attrSelector;
                        validAttr = true;
                        attrCtr++;
                    }
                }
            }

        }

        if (!isCustom && validAttr && jsSelectorKey)
            GmCXt.dom.addAttributeForSelector(attr, meta, jsSelectorKey);

    });

    if (!GmCXt.checkSalesForceSite() || attrObj.tagName !== 'SLOT') {
        selector += ":visible";
    }

    if (isCustom && GmCXt.isEmpty(attributes))
        selector = "";

    return selector;
};

GmCXt.dom.getClassSelector = function(attr, value, filter, attrCtr) {
    let selector = null;
    let operator = null;
    if (!GmCXt.isEmpty(value)) {
        if (filter) {
            selector = GmCXt.dom.filterValidClasses(value);
        }

        if (!filter || (!selector && !attrCtr)) {
            // Assuming class is always last in the list of attributes, if counter is 0, add classes without filtering
            let classes = value.split(/\s+/);
            classes = classes.filter(function(className) {
                className = className.trim();
                if (!className || className.match(/[[\]{}()<>%:*+?.,"'/\\^$|#=]/g)) {
                    return false;
                }
                return true;
            });
            selector = classes.filter(Boolean).join(".");
        }
    }
    return selector;
};

GmCXt.dom.getIdSelector = function(attr, value, filter) {
    let selector = null;
    let operator = null;
    if (!GmCXt.isEmpty(value)) {
        if (filter) {
            let temp = value;
            value = GmCXt.dom.getAlphabeticalSubstr(value);
            if (!value) return null;

            if (value[0] !== temp) {
                operator = 'contains';
            }
        }

        selector = GmCXt.dom.getAttrSelector(attr, value, operator);
    }
    return selector;
};

GmCXt.dom.getTextSelector = function(attr, value, filter) {

    let selector = null;
    let operator = null;

    if (!GmCXt.isEmpty(value)) {
        if (filter) {
            let temp = value;
            value = GmCXt.dom.getAlphabeticalSubstr(value);
            if (!value) return null;

            if (value[0] !== temp) {
                operator = 'contains';
            }

        }

        if (attr === 'text') {
            if (!filter) { // Value is a string if not passed through the filter function
                value = [value];
            }

            selector = '';
            let length = value.length > 3 ? 3 : value.length;

            for (let i = 0; i < length; i++) {
                selector += ":contains('" + value[i].trim() + "')";
            }

        } else {
            selector = GmCXt.dom.getAttrSelector(attr, value, operator);
        }
    }

    return selector;
};

GmCXt.dom.getAttrSelector = function(attr, value, operator) {

    let buildSelectorBlock = function(attr, value, operator) {
        let sel = "[" + attr + "='" + value.replace(/'/g, "\\'") + "']";

        switch (operator) {
        case undefined:
        case null:
            break;
        case 'contains': {
            sel = sel.replace('=', '*=');
            break;
        }

        case 'startsWith': {
            sel = sel.replace('=', '^=');
            break;
        }

        case 'endsWith': {
            sel = sel.replace('=', '$=');
            break;
        }
        }

        return sel;
    };

    if (typeof value === 'string') { // Single value
        var selector = buildSelectorBlock(attr, value, operator);
    } else { // Array of values
        var selector = '';
        let length = value.length > 3 ? 3 : value.length;

        for (let i = 0; i < length; i++) {
            selector += buildSelectorBlock(attr, value[i], operator);
        }
    }

    return selector;
};

GmCXt.dom.skipSpecialCharValue = function(text) {
    if (text.match(/[[\]{}():*+?.,\\^$|#]/g)) {
        return '';
    }
    return value;
};

GmCXt.dom.getAlphabeticalSubstr = function(text) {
    // Returns array of substrings if alphanumeric
    // Returns the string as is at index 0, if no digits present
    // Returns null if a proper length aphabetical substr not present
    let value = text;
    let valueArr = [];
    let temp = text;

    let num = value.match(/\d+/g); // Array of digits present in the string
    if (GmCXt.isEmpty(num)) {
        return [value];
    }

    if (num.length < 4) {
        let numIndex = [];
        for (let i = 0; i <= num.length; i++) {

            if (i === num.length) {
                value = temp;
            } else {
                numIndex[i] = temp.indexOf(num[i]);
                value = temp.substring(0, numIndex[i]);
                temp = temp.slice(numIndex[i] + num[i].length);
            }

            if (!GmCXt.isEmpty(value) && value.length > 3) {
                valueArr.push(value.trim());
            }
        }
    }

    if (!GmCXt.isEmpty(valueArr)) {
        return valueArr.sort(function(a, b) {
            return b.length - a.length;
        });
    }

    return null;
};

GmCXt.dom.filterValidClasses = function(val) {

    if (val && typeof val === 'string') {

        let classes = val.split(/\s+/);

        classes = classes.filter(function(className) {

            className = className.trim();

            if (!className || className.match(/\d+/g) || className.match(/[[\]{}()<>%:*+?.,"'/\\^$|#=]/g))
                return false;

            if (GmCXt.dom.invalidClass(className))
                return false;

            return true;
        });

        if (classes.length)
            return classes.join('.');
    }
    return '';
};

GmCXt.dom.invalidClass = function(cl) {

    let list = ['hide', 'show', 'ascending', 'descending', 'has-focus', 'over', 'doitforme-'];

    for (let i = 0; i < list.length; i++) {
        if (cl.includes(list[i]))
            return true;
    }
    return false;
};

GmCXt.dom.addAttributeForSelector = function(attr, meta, jsSelectorKey) {
    let attrList = meta.selectorAttributes;
    if (attrList) {
        if (!attrList.hasOwnProperty(jsSelectorKey)) {
            attrList[jsSelectorKey] = [attr];
        } else if (attrList[jsSelectorKey].indexOf(attr) < 0) {
            attrList[jsSelectorKey].push(attr);
        }
    }

    // Add to global selector Attributes variable
    if (GmCXt.dom.selectorAttributes.indexOf(attr) < 0) {
        GmCXt.dom.selectorAttributes.push(attr);
    }
};

GmCXt.dom.getElementIndex = function(el, selector) {

    let index = null;
    let nodes = GmCXt.dom.query(el.parentNode, selector, true);
    for (let i = 0, j = nodes.length; i < j; i++) {
        if (el === nodes[i]) {
            index = i;
            break;
        }
    }

    return index;
};

// Returns attributes of a element selector in key,value pair
GmCXt.dom.getAttributes = function(selectorArr) {

    let attrList = [];

    selectorArr.forEach(function(selector) {
        let attrObj = {};
        let splitByColon = selector.split(':');

        let splitBySqBracket = splitByColon[0].split(/\[(.*?)\]/g).filter(Boolean);
        for (let i in splitBySqBracket) {
            let attr = splitBySqBracket[i];

            if (attr.includes('.')) { // Check class
                var temp = attr.split('.').filter(Boolean);
                attrObj.class = temp;

                if (i == 0) attrObj.tagName = attrObj.class.shift(); // 1st part of the string is the tagname

                attrObj.class.sort();

            } else {
                if (i == 0) attrObj.tagName = attr;
                else {
                    var temp = attr.replace(/\'/g, '').split('=');
                    attrObj[temp[0]] = temp[1];
                }
            }
        }

        splitByColon.shift();
        splitByColon.forEach(function(part) {
            if (part.includes('contains')) {
                attrObj.text = part.split("\'")[1];
            }
        });

        attrList.push(attrObj);

    });

    return attrList;
};

// ******************* SALESFORCE TABLES SPECIAL HANDLING ********************

GmCXt.dom.checkAllProp = function(obj) {
    if (!Object.keys(obj).some(function(k) {
        return obj[k];
    })) {
        return true;
    }
    return false;
};

GmCXt.isSfSelectEl = function(he) {
    let type = 0;

    if (he.tagName === 'INPUT') {

        if (he.matches('.slds-combobox__input[role="textbox"]')) {
            type = 1;

        } else if (he.matches('.inputDate.input[type="text"]')) {
            type = 2;

        } else if (he.matches('.uiInput--default.uiInput--input[type="text"]')) {
            type = 4;
        }

    } else if (mg$(he).find('A.select[aria-haspopup="true"]').length ||
		he.matches('A.select[aria-haspopup="true"]')) {
        type = 3;

    } else if (mg$(he).find('input.uiAutocomplete[aria-haspopup="true"]').length ||
		mg$(he).find('input.uiInput--default.uiInput--input[type="text"]').length ||
		mg$(he).find('span.slds-pill__label').length ||
		mg$(he).find('span.pillText').length) {
        type = 4;
    }

    if (type) {
        return type;
    }
};

GmCXt.dom.getCustomSettings = function(he) {
    let settings = {};

    if (GmCXt.checkSalesForceSite()) {

        let salesforce = {};
        let inputType = ['text', 'password', 'email', 'search'];

        salesforce.customSelect = GmCXt.isSfSelectEl(he);

        if (salesforce.customSelect === 4) {
            salesforce.customInput = true;
        }

        if (!salesforce.customSelect) {
            if (typeof(he.className) === 'string')
                salesforce.globalSearch = he.className.includes('uiInput--{remove}');

            if (!salesforce.globalSearch) {
                salesforce.isInput = (he.tagName === 'INPUT' && inputType.includes(he.type));

                if (!salesforce.isInput) {
                    salesforce.isTextarea = GmCXt.dom.checkSFTextarea(he);

                    if (!salesforce.isTextarea) {
                        salesforce = GmCXt.dom.salesForceHeader(he);
                    }
                }
            }
        }

        if (he.tagName === 'TD' && he.hasAttribute('data-label') && mg$(he).find('input.uiInputText').length) {
            salesforce.customInput = true;
        }

        settings.salesforce = salesforce;

    } else if (GmCXt.checkWorkdaySite()) {

        let workday = {};
        workday = GmCXt.dom.checkInput(he);

        if (!workday.isCheckbox) {
            workday.isWDCustomSelect = GmCXt.dom.checkCustomSelect(he);
        }

        if (!workday.isInput && !workday.isWDCustomSelect) {
            workday.isTextarea = GmCXt.dom.checkTextarea(he);
        }

        if (GmCXt.dom.checkAllProp(workday)) {
            workday.isSelectBox = (he.getAttribute('data-automation-id') === 'selectWidget');
        }

        if (GmCXt.dom.checkAllProp(workday)) {
            workday = GmCXt.dom.workdayHeader(he);
        }
        settings.workday = workday;

    } else if (GmCXt.checkUBS()) {

        settings.ubs = GmCXt.dom.checkUBSHeader(he);
    } else {
        settings.table = GmCXt.dom.checkTableHeader(he);
    }

    return settings;
};

GmCXt.dom.checkInput = function(he) {
    let inputNode = mg$(he).find('input');

    let isInput = (he.tagName === 'INPUT');

    if (!isInput && GmCXt.isOne(inputNode)) {
        let tempHe = inputNode[0];
        for (let i = 0; i < 8 && tempHe; i++) {
            if (tempHe === he) {
                isInput = true;
                break;
            }
            tempHe = tempHe.parentNode;
        }
    }

    if (isInput) {
        var elem = GmCXt.isOne(inputNode) ? inputNode[0] : he;
    }

    let isCheckbox = ((isInput && elem.type === 'checkbox') ||
		(he.previousElementSibling && he.previousElementSibling.type === 'checkbox'));

    let returnObj = {
        isInput: isInput,
        isCheckbox: isCheckbox
    };

    return returnObj;
};

GmCXt.dom.workdayHeader = function(he) {
    let workday = {};
    let head = false;
    let rows = [];
    let tempHe = he;
    let level = 7;
    let isHead = false;

    if (tempHe.tagName) {
        for (var i = 0; i < level; i++) {
            if (tempHe.tagName === 'BODY' || tempHe instanceof ShadowRoot) break;
	
            if (tempHe.tagName === 'TR') {
                isHead = true;
                break;
            }
	
            if (tempHe.tagName === 'TD') {
                var columnIndex = mg$(tempHe).parent().children().index(mg$(tempHe));
            }
	
            tempHe = tempHe.parentNode;
        }
    }

    if (isHead) {
        rows = mg$(tempHe).parent().children();
    }

    if (rows.length && columnIndex) {
        for (i = 0; i < rows.length; i++) {
            let columns = mg$(rows[i]).children();
            if (columns.eq(columnIndex).find("textarea, .textArea").length) {
                workday.columnIndex = columnIndex;
                workday.isTableHeader = true;
            }
        }
    }

    return workday;
};

GmCXt.dom.checkCustomSelect = function(he) {
    let multiSelect = mg$(he).parents("[data-automation-id='multiselectInputContainer']");
    if (multiSelect.length === 1) {
        multiSelect = multiSelect[0];
    } else if (mg$(he).attr('data-automation-id') === 'multiselectInputContainer') {
        multiSelect = he;
    } else {
        multiSelect = null;
    }

    let selectedItemList = mg$(he).parent().siblings("ul[data-automation-id='selectedItemList'][role='listbox']");
    if (selectedItemList.length === 1) {
        selectedItemList = selectedItemList[0];
    } else if (mg$(he).attr('data-automation-id') === 'selectedItemList' && mg$(he).attr('role') === 'listbox') {
        selectedItemList = he;
    } else {
        selectedItemList = null;
    }

    if (he.tagName === 'INPUT' && multiSelect && selectedItemList) {
        return true;
    } else if (selectedItemList) {
        return true;
    } else if (multiSelect) {
        let node = mg$(multiSelect).find("ul[data-automation-id='selectedItemList'][role='listbox']")[0];

        if (node) {
            return GmCXt.dom.levelCheck(multiSelect, node, 9);
        }
    }

    return false;
};

GmCXt.dom.levelCheck = function(he, node, level) {
    for (let i = 0; i < level && node; i++) {
        if (node === he) {
            return true;
        }
        node = node.parentNode;
    }
    return false;
};

GmCXt.dom.checkSFTextarea = function(he) {
    let tempHe = he;
    let level = 3;

    if (!he) {
        return false;
    }

    if (he.matches('DIV[role="toolbar"]') ||
		(he.parentElement && he.parentElement.matches('DIV[role="toolbar"]'))) {
        return false;
    }

    if (he.children.length && he.children[0].tagName === 'LIGHTNING-INPUT-RICH-TEXT') {
        return true;
    }

    for (i = 0; i < level, tempHe; i++) {
        if (tempHe.parentElement && tempHe.parentElement.tagName === 'LIGHTNING-INPUT-RICH-TEXT') {
            return true;
        }
        tempHe = tempHe.parentNode;
    }
    return false;
};

GmCXt.dom.checkTextarea = function(he) {
    let tempHe = he;
    let level = 5;
    for (i = 0; i < level, tempHe; i++) {
        if (tempHe.previousElementSibling && tempHe.previousElementSibling.tagName === 'TEXTAREA') {
            return true;
        }
        tempHe = tempHe.parentNode;
    }
    return false;
};

GmCXt.dom.isWorkdayInputType = function(settings) {
    if (settings && GmCXt.checkWorkdaySite()) {
        if (settings.isTextarea || settings.isSelectBox || settings.isInput || settings.isCheckbox)
            return true;
    }
    return false;
};

GmCXt.dom.isOuterEl = function(he) {
    if (he.getAttribute('data-automation-id') === 'richTextEditor')
        return true;
    if (mg$(he).find("DIV[data-automation-id='richTextEditor']").length)
        return true;

    let tempHe = he.parentNode;
    for (let i = 0; i < 3; i++) {
        if (tempHe.getAttribute('data-automation-id') === 'richTextEditor') {
            return true;
        }
        tempHe = tempHe.parentNode;
    }
    return false;
};

GmCXt.dom.isInnerEl = function(he) {
    if (he.getAttribute('data-automation-id') === 'richTextContent')
        return true;
    if (mg$(he).find("DIV[data-automation-id='richTextContent']").length)
        return true;

    return false;
};

GmCXt.dom.checkForExpandedTextBox = function(he, meta) {

    let label = mg$('DIV.wd-popup').find("H1[data-automation-id='dialogLabel']")[0];
    if (label && meta.textPropertyValue !== label.textContent) return;

    let expandedTextArea = mg$('DIV.wd-popup').find("DIV[data-automation-id='richTextEditor']");

    if (expandedTextArea.length) {

        if (GmCXt.dom.isOuterEl(he))
            return expandedTextArea[0];

        if (GmCXt.dom.isInnerEl(he)) {
            let innerEl = expandedTextArea.find("DIV[data-automation-id='richTextContent']");

            if (innerEl.length)
                return innerEl[0];
        }
    }
    return null;
};

GmCXt.dom.checkUBSHeader = function(he) {
    let ubs = {};
    let tempHe = he;
    let level = 5;

    for (let i = 0; i < level; i++) {

        if (!tempHe || tempHe.tagName === 'BODY' || tempHe.tagName === 'HTML' || tempHe instanceof ShadowRoot) break;

        if (mg$(tempHe).hasClass('datagrid-header-column')) {
            ubs.tableCategory = 1;
            ubs.columnDataKey = tempHe.getAttribute('data-key');
            break;
        }

        if (tempHe.tagName && tempHe.tagName.toLowerCase() === 'th') {
            ubs.tableCategory = 2;
            break;
        }

        tempHe = tempHe.parentNode;
    }

    if (ubs.tableCategory) {
        ubs.columnIndex = mg$(tempHe).parent().children().index(mg$(tempHe));

        let rows = GmCXt.dom.getUBSTableRows(tempHe, ubs.tableCategory);
        if (rows.length) {
            ubs.isClickable = GmCXt.dom.checkColumnClickable(rows, ubs.columnIndex, ubs.columnDataKey);
        }

    }

    return ubs;
};

GmCXt.dom.getUBSTableRows = function(columnHeaderEl, tableCategory) {
    let rows = [];

    let header = false;
    let headerEl = columnHeaderEl;
    for (let i = 0; i < 5; i++) {
        if (mg$(headerEl).hasClass('datagrid-header') || headerEl.tagName.toLowerCase() === 'table') {
            header = true;
            break;
        }

        headerEl = columnHeaderEl.parentNode;
    }

    if (header) {
        switch (tableCategory) {
        case 1:
            var bodyEl = mg$(headerEl).parent().find('[class=datagrid-grid]')[0];
            rows = mg$(bodyEl).find('.datagrid-row');
            break;

        case 2:

            while (headerEl.parentNode.childElementCount === 1) {
                headerEl = headerEl.parentNode;
            }

            var bodyEl = mg$(headerEl).parent().find('table').find('tbody')[0];
            rows = mg$(bodyEl).find('tr');
            break;
        }
    }

    return rows;
};

GmCXt.dom.checkColumnClickable = function(rows, index, dataKey) {
    let isClickable = false;

    for (let i = 0; i < rows.length; i++) {
        if (dataKey) {
            var cell = mg$(rows[i]).find('[data-key=' + dataKey + ']')[0];
        } else {
            var cell = mg$(rows[i]).find('td')[index];
        }

        if (cell) {
            let aTag = mg$(cell).find('a');
            let button = mg$(cell).find('button');
            if (aTag.length || button.length) {
                isClickable = true;
                break;
            }
        }
    }

    return isClickable;
};

GmCXt.dom.salesForceHeader = function(he) {
    let salesforce = {};
    let tempHe = he;
    let level = 7; // Check for thead upto 7 levels up
    for (let i = 0; i < level; i++) {

        if (!tempHe.tagName || tempHe.tagName === 'BODY' || tempHe instanceof ShadowRoot) break;

        if (tempHe.tagName === 'THEAD') {
            salesforce.tableCategory = 1;

            if (tempHe.parentNode.childNodes.length === 1)
                salesforce.tableCategory = 2;

            break;

        } else if (tempHe.tagName === 'TBODY') {
            if (mg$(tempHe).children().first().hasClass('headerRow')) {
                salesforce.tableCategory = 3;
                break;
            }
        }
        tempHe = tempHe.parentNode;
    }

    if (salesforce.tableCategory) {
        let rows = GmCXt.dom.getTableRowsFromHeader(tempHe, salesforce.tableCategory);

        if (rows && mg$(rows).length) {
            salesforce = GmCXt.dom.checkColumn(rows, he, salesforce);
        }
    }

    return salesforce;
};

GmCXt.dom.getTableRowsFromHeader = function(headerEl, tableCategory) {
    let rows = null;
    if (headerEl) {
        switch (tableCategory) {
        case 1:
            rows = mg$(headerEl).siblings('tbody').children();
            break;

        case 2:
            tempHe = headerEl;
            headerEl = null;
            for (let ctr = 0; ctr < 6; ctr++) {

                if (tempHe.tagName === 'BODY' || tempHe instanceof ShadowRoot) break;

                if (mg$(tempHe).hasClass('x-grid3-header')) {
                    headerEl = tempHe;
                    break;
                }
                tempHe = tempHe.parentNode;
            }

            if (headerEl) {
                tbody = mg$(headerEl).siblings().find('tbody');
                rows = mg$(tbody).find('tr');
            }
            break;

        case 3:
            rows = mg$(headerEl).children();
        }
    }
    return rows;
};

GmCXt.dom.checkColumn = function(rows, he, salesforce) {

    while (he.tagName !== 'TH' && he.tagName !== 'TD') {

        if (he.tagName === 'BODY' || he instanceof ShadowRoot) break;

        he = he.parentNode;
    }

    if (he && he.tagName !== 'BODY') {
        let columnIndex = mg$(he).parent().children().index(mg$(he));

        for (let i = 0; i < rows.length; i++) {
            let columns = mg$(rows[i]).children();
            if (columns.eq(columnIndex).find("a, input[type='checkbox']").length) {
                salesforce.columnIndex = columnIndex;
                salesforce.isClickable = true;
                break;
            }
        }

        if (he.offsetHeight) {
            salesforce.tableHeight = he.offsetHeight * rows.length;
        } else {
            while (he.tagName !== 'TABLE') {
                if (he.tagName === 'BODY' || he instanceof ShadowRoot) break;
                he = he.parentNode;
            }
            if (he.tagName === 'TABLE') {
                salesforce.tableHeight = he.offsetHeight + he.offsetHeight / rows.length;
            }
        }
    }

    return salesforce;
};

GmCXt.dom.checkTableHeader = function(he) {
    let table = {};
    let tempHe = he;
    let level = 5;

    for (let i = 0; i < level && tempHe; i++) {

        if (tempHe.tagName === 'BODY' || tempHe.tagName === 'HTML' || tempHe instanceof ShadowRoot) break;

        if (tempHe.tagName && tempHe.tagName.toLowerCase() === 'th') {
            table.tableCategory = 1;
            break;
        }

        if (tempHe.tagName && tempHe.tagName.toLowerCase() === 'td') {
            let headerRow = tempHe.parentNode;
            if (headerRow.tagName.toLowerCase() === 'tr' && headerRow.parentNode.tagName.toLowerCase() === 'thead') {
                table.tableCategory = 2;
                break;
            }
        }

        tempHe = tempHe.parentNode;
    }

    if (table.tableCategory) {
        table.columnIndex = mg$(tempHe).parent().children().index(mg$(tempHe));

        let rows = GmCXt.dom.getTableRows(tempHe, table.tableCategory);
        if (rows.length) {
            table.isClickable = GmCXt.dom.checkColumnClickable(rows, table.columnIndex);
        }

    }

    return table;
};

GmCXt.dom.getTableRows = function(el, tableCategory) {
    let rows = [];

    let header = false;
    let headerEl = el;
    for (let i = 0; i < 5; i++) {
        if (headerEl.tagName.toLowerCase() === 'thead') {
            header = true;
            break;
        }

        headerEl = headerEl.parentNode;
    }

    if (header) {
        switch (tableCategory) {
        case 1:
        case 2: {
            while (headerEl.parentNode.childElementCount === 1) {
                headerEl = headerEl.parentNode;
            }

            let bodyEl = mg$(headerEl).parent().find('tbody')[0];

            if (bodyEl) {
                rows = mg$(bodyEl).find('tr');
            }
            break;
        }
        }
    }

    return rows;
};

GmCXt.dom.sfTextArea = function(el) {
    if (el && el.customSettings && el.customSettings.salesforce) {
        return el.customSettings.salesforce.isTextarea;
    }
    return false;
};

// ******************* CSS/POSITION RELATED FUNCTIONS ********************
GmCXt.dom.getElementPos = function(he) {

    let rect = he.getBoundingClientRect();
    rect = GmCXt.dom.getElementOffset(rect);
    let cssPosition = GmCXt.dom.getElementFixedPosition(he);

    let pos = {
        position: rect,
        cssPosition: cssPosition
    };

    return pos;
};

GmCXt.dom.getElementOffset = function(rect) {
    return {
        left: rect.left,
        top: rect.top,
        width: rect.width,
        height: rect.height
    };
};

GmCXt.dom.getElementFixedPosition = function(he) {

    let el = mg$(he);
    let all = el.add(el.parents());

    let cssPosition = all.filter(function() {

        return (mg$(this).css("position") === 'fixed' || mg$(this).css("position") === 'sticky');
    }).length > 0;

    return cssPosition;
};

GmCXt.dom.getElementZindex = function(he) {
    let el = mg$(he);
    let all = el.add(el.parents());

    for (let i = 0; i < all.length; i++) {
        if (mg$(all[i]).css("zIndex") > 0) {
            return mg$(all[i]).css("zIndex");
        }
    }

    return false;
};

// ******************* IDENTIFY BY TEXT FUNCTIONS ********************
// Save Element Info
GmCXt.dom.getIdentifyByTextInfo = function(he, meta) {

    GmCXt.dom.readElText(he);

    meta.textPropertyValue = GmCXt.dom.textPropertyValue;
    meta.textPropertyName = GmCXt.dom.textPropertyName;

    if (meta.textPropertyValue) {

        meta.textNode = {};

        let textType = GmCXt.dom.classifyElementText(meta);
        let queryString = GmCXt.dom.getQueryString(he.tagName, textType, meta);
        let matches = GmCXt.dom.getTextMatches(queryString);
        meta.textNode.jquery_selector = GmCXt.dom.generateTextBasedjQuery(he, matches, queryString);

        let filteredMatches = textType ? GmCXt.filterParentNodes(matches, meta.textPropertyValue) : matches;
        let length = filteredMatches.length;

        if (length) {
            filteredMatches.each(function(index, node) {
                if (node === he) {
                    meta.tagName = he.tagName;
                    meta.textNode.position = {
                        index: index,
                        length: length
                    };
                }
            });
        }
    }
};

GmCXt.dom.getElText = function(he) {
    var name, value;

    if (!GmCXt.dom.textPropertyName && he.textContent && /\S/.test(he.textContent)) {
        name = 'textContent';
        value = he.textContent.trim();
    }

    if (he.tagName === 'INPUT' || he.tagName === 'BUTTON') {
        var value = he.getAttribute('value');
        let placeholder = he.getAttribute('placeholder');

        if (value && (he.type === 'submit' || he.type === 'button')) {
            name = 'value';
            value = value;
        } else if (placeholder) {
            name = 'placeholder';
            value = placeholder;
        }
    }

    return {
        name: name,
        value: value
    };
};

GmCXt.dom.readElText = function(he) {

    let elTextDeatils = GmCXt.dom.getElText(he);
    GmCXt.dom.textPropertyName = elTextDeatils.name;
    GmCXt.dom.textPropertyValue = elTextDeatils.value;

};

GmCXt.dom.classifyElementText = function(meta) {
    let textProperty = meta.textPropertyName;

    let textType = false;
    if (textProperty === 'textContent' || textProperty === 'text') {
        textType = true;
    }

    return textType;
};

GmCXt.dom.getQueryString = function(tagName, textType, meta) {
    let queryString = null;
    let textProperty = meta.textPropertyName;
    let text = meta.textPropertyValue;

    if (text && text.length < 201) {

        // Replace occurences of single quotes & double quotes
        text = text.replace(/\'/g, "\\'").replace(/\"/g, '\\"');

        if (textType) {
            queryString = tagName + GmCXt.dom.getTextSelector('text', text, true) + ":visible";
        } else {
            queryString = tagName + "[" + textProperty + "='" + text + "']" + ":visible";
        }
    }

    return queryString;
};

GmCXt.dom.getTextMatches = function(queryString) {

    let matches = [];

    if (queryString) {
        try {
            matches = mg$(queryString);
        } catch (e) {
            matches = [];
        }
    }

    return matches;
};

GmCXt.dom.generateTextBasedjQuery = function(he, matches, queryString) {

    let query = null;

    if (matches.length) {
        matches.each(function(index, node) {
            if (node === he) {
                queryString += ':eq(' + index + ')';
                query = queryString;
            }
        });
    }

    return query;
};

// Find element
GmCXt.dom.identifyByTextNodePosition = function(meta, workdayInput) {

    if (GmCXt.isEmpty(meta.textNode.position)) return null;

    GmCXt.l.start('function', 'identifyByTextNodePosition', arguments);

    let textType = GmCXt.dom.classifyElementText(meta);
    let queryString = GmCXt.dom.getQueryString(meta.tagName, textType, meta);
    let matches = GmCXt.dom.getTextMatches(queryString);
    let filteredMatches = textType ? GmCXt.filterParentNodes(matches, meta.textPropertyValue) : matches;
    let length = filteredMatches.length;
    let el = null;

    if (length) {

        let pos = meta.textNode.position;

        if (pos.length === length) {
            el = filteredMatches[pos.index];
        } else {
            let indexFromChild = pos.length - pos.index;
            if (length > indexFromChild)
                el = filteredMatches[length - indexFromChild];
        }
    }

    if (workdayInput && el && !GmCXt.dom.checkOpaque(el)) {
        filteredMatches = GmCXt.dom.filterByOpacity(filteredMatches);
        if (filteredMatches.length === 1)
            el = filteredMatches[0];
        else
            el = null;
    }

    return GmCXt.l.return(el);
};

GmCXt.dom.executeTextBasedJquery = function(queryString, text, workdayInput) {

    if (GmCXt.isEmpty(queryString)) return null;

    GmCXt.l.start('function', 'executeTextBasedJquery', arguments);

    let returnValue = null;

    let nodes = mg$(queryString);

    let length = nodes.length;

    if (!length || nodes.is(':hidden') || workdayInput) {
        queryString = queryString.split(':eq')[0];
        if (!queryString.includes(':visible')) {
            queryString += ':visible';
        }
        nodes = mg$(queryString);
    }

    nodes = nodes.filter(function(index, node) {
        return node.textContent === text;
    });

    if (workdayInput) {
        nodes = GmCXt.dom.filterByOpacity(nodes);
    }

    length = nodes.length;

    if (length) {
        returnValue = nodes[length - 1];
    }

    return GmCXt.l.return(returnValue);
};

GmCXt.dom.filterByOpacity = function(nodes) {
    return nodes.filter(function(index, node) {
        return GmCXt.dom.checkOpaque(node);
    });
};

GmCXt.dom.checkOpaque = function(node) {
    let visible = true;
    let tempHe = node;
    for (let i = 0; i < 15; i++) {
        let opacity = window.getComputedStyle(tempHe).opacity;
        if (GmCXt.isNumeric(opacity) && opacity < 0.5) {
            visible = false;
            break;
        }
        tempHe = tempHe.parentNode;
        if (tempHe.tagName === 'BODY' || tempHe instanceof ShadowRoot) break;
    }
    return visible;
};

// ******************* IDENTIFY BY TEXT FUNCTIONS - OLD METHOD ********************
GmCXt.dom.identifyByText = function(de, selector) {

    GmCXt.l.start('function', 'identifyByText', arguments);

    let he = null;
    let textProperty = de.meta.textPropertyName;

    let newSelector = GmCXt.dom.getIdByTextSelector(selector, textProperty);

    he = GmCXt.dom.identifyByTextGetEl(de, newSelector, true);

    if (he === null) he = GmCXt.dom.identifyByTextGetEl(de, newSelector, false);

    return GmCXt.l.return(he);
};

GmCXt.dom.identifyByTextGetEl = function(de, newSelector, visible) {

    GmCXt.l.start('function', 'identifyByTextGetEl', arguments);

    if (visible) newSelector += ":visible";

    let he = null;
    let nodes = mg$(document).find(newSelector);
    let prop = de.meta.textPropertyName;

    if (nodes) {

        if (nodes.length && prop === 'textContent') {
            nodes = GmCXt.dom.filterByText(nodes, de.meta.textPropertyValue);
        }

        nodes = GmCXt.dom.filterParentTextEl(nodes, de.meta.textPropertyValue);

        if (GmCXt.isMany(nodes)) he = nodes[0];
    }

    return GmCXt.l.return(he);
};

// This function remove all parent elements with same text for intentify by text elements.
GmCXt.dom.filterParentTextEl = function(nodes, text) {

    GmCXt.l.start('function', 'filterParentTextEl', arguments);

    var text = text.trim().toLowerCase();

    nodes.filter(function(index, node) {
        mg$(node).parents().addClass('mgPlayerJSProd_dummy-class');
    });

    nodes = nodes.filter(function(index, node) {
        if (node.innerText) {
            let nodeText = node.innerText.trim().toLowerCase();
            return nodeText === text && !mg$(node).hasClass('mgPlayerJSProd_dummy-class');
        }
    });

    mg$('.mgPlayerJSProd_dummy-class').removeClass('mgPlayerJSProd_dummy-class');

    return GmCXt.l.return(nodes);
};

GmCXt.dom.getIdByTextSelector = function(jsSelector, prop) {

    GmCXt.l.start('function', 'getIdByTextSelector', arguments);

    let newSel = "";

    if (jsSelector.js) {

        let selector = jsSelector.js.slice(0, 1);

        let attributes = GmCXt.dom.getAttributes(selector);
        attributes = attributes[0];

        switch (prop) {

        case "value":
            newSel = attributes.tagName + "[value=" + attributes.value + "]";
            break;

        case "placeholder":
            newSel = attributes.tagName + "[placeholder=" + attributes.placeholder + "]";
            break;

        case "textContent":
            newSel = attributes.tagName;
            break;
        }

        if (attributes.type)
            newSel = newSel + "[type=" + attributes.type + "]";
    }

    return GmCXt.l.return(newSel);
};

GmCXt.dom.trackFinderRequest = function(stepInfo) {

    if (GmCXt.isEmpty(GmCXt.domSelectorTracker) || !GmCXt.domSelectorTracker.hasOwnProperty(GmCXt.id)) {
        GmCXt.domSelectorTracker[GmCXt.id] = {};
    }
    let current = GmCXt.domSelectorTracker[GmCXt.id];

    if (!stepInfo) stepInfo = 'untracked';

    GmCXt.dom.currentElTag = stepInfo;

    if (current.hasOwnProperty(stepInfo)) {
        current[stepInfo].finder++;
    } else {
        current[stepInfo] = {
            finder: 1,
            query: 0
        };
    }
};

GmCXt.dom.trackQueryRequest = function() {
    if (!GmCXt.isEmpty(GmCXt.dom.currentElTag)) {
        GmCXt.domSelectorTracker[GmCXt.id][GmCXt.dom.currentElTag].query++;
    }
};
/**
	* @file DOM finder module
	* @author Nilesh Pachpande
	*/
/*global GmCXt,mg$*/
GmCXt.highlighter = (function() {

    let pub = {};
    let jobs = {};
    let beaconJobs = [];
    let smarttipJobs = [];
    let tagJobs = [];
    let editJob = {};
    let intervalId = null;
    let onChangeNextInterval = null;
    let onKeyupEventJobId = "";
    let tracker = {};
    let deletedDuctTape = [];
    let onElem = false;
    let autoTriggered = {};
    let disableFocus = false;
    let gmjobId = 'gmjobId';
    GmCXt.domElStore = [];
    let beaconHe = {};

    function getDefaultWait() {
        return Date.now() + GmCXt.t.highlighterDefautWT;
    }

    function notInTopWindow(de) {
        if (window.self === window.top && de && de.meta && de.meta.inTopWindow === false)
            return true;
        else
            return false;
    }

    pub.queue = function(req) {

        GmCXt.l.start('function', 'GmCXt.highlighter.queue', arguments);

        if (notInTopWindow(req.data.settings.element)) {
            GmCXt.l.add("Element is NOT present in top window", true);
            return;
        }

        let task, state = "find";
        if (req.data.findOnly && req.data.stepType === GmCXt.STEP_TYPE_MESSAGE) task = "findAndKeep";
        else if (req.data.findOnly) task = "findOnly";
        else if (req.data.requestId) task = "findAndWatch";
        else task = "findAndKeep";

        let jobId = "_" + req.data.requestId;

        if (req.data.tooltipId) {
            jobId += "_" + req.data.tooltipId;
        }

        req.startTime = Date.now();
        req.timeout = req.data.timeout;

        // task: findAndWatch(player) / findAndKeep(edit step)
        // state: find(if element not found) / 
        // watch ( element found and keep watching) 

        let resp = {
            data: {
                requestId: req.data.requestId,
                tooltipId: req.data.tooltipId
            }
        };

        jobs[jobId] = {
            id: jobId,
            req: req,
            resp: resp,
            task: task,
            state: state,
            outline: {}
        };

        if (req.data.task === "workFlowTour") {
            resp.data.tourId = req.data.tourId;
        } else if (req.identifier !== "blackout-request" && !req.data.noOutline) {
            createOutline(jobId, req.data.tooltipId, req.data.identifier);
        }

        findJob(jobId);

        setJobInterval();
    };

    pub.unqueue = function(data) {
        if (data) {
            let jobId = "_" + data.jobId;

            for (let id in jobs) {
                if (id.indexOf(jobId) !== -1) {
                    let rmJobId = id;
                    hideOutline(rmJobId);
                    delete jobs[rmJobId];
                }
            }
        }

        if (onChangeNextInterval) {
            clearInterval(onChangeNextInterval);
        }

        pub.removeOutline();
        mg$('.mgPlayerJSProd_selector-blackout').remove();
        mg$(".mgPlayerJSProd_user-tip-guide-container").remove();
    };

    pub.queueVariable = function(req) {

        if (notInTopWindow(req.data.varElem)) return;

        let jobId = "_" + req.data.varId;

        let resp = {
            requestId: req.data.varId
        };

        jobs[jobId] = {
            id: jobId,
            req: req,
            resp: resp,
            task: '',
            state: "findVariable",
            startTime: Date.now(),
            timeout: req.data.timeout || getDefaultWait()
        };

        findVariable(jobId);

        setJobInterval();
    };

    pub.queueBeacon = function(req) {

        if (notInTopWindow(req.data.stepData)) return;

        let jobId = "_" + req.data.tourId;
        let isPreview = req.data.isPreview;

        if (jobs[jobId]) {
            if (isPreview) jobs[jobId] = {};
            else return;
        }

        let resp = {
            requestId: req.data.tourId
        };

        jobs[jobId] = {
            id: jobId,
            req: req,
            resp: resp,
            task: '',
            state: "findBeacon",
            startTime: Date.now(),
            timeout: req.data.timeout || getDefaultWait()
        };

        beaconJobs.push(jobId);

        findBeacon(jobId);

        setJobInterval();
    };

    pub.clearBeacons = function() {
        for (let index = 0; index < beaconJobs.length; index++) {
            let job = jobs[beaconJobs[index]];
            if (job) {
                pub.clearJob(job.req.data.tourId);
            }
        }
        beaconJobs = [];
        mg$(".mgPlayerJSProd_beacon-icon").remove();
    };

    pub.queueTag = function(req) {

        let step = req.data.step;

        if (notInTopWindow(step.step_settings.element)) return;

        let jobId = "_" + step.step_id;

        if (jobs[jobId]) return;

        GmCXt.log(16, "QUEUE TAG: " + GmCXt.stepLog(step.step_id, step.tour_id));

        let resp = {
            requestId: step.step_id
        };

        jobs[jobId] = {
            id: jobId,
            req: req,
            resp: resp,
            task: '',
            state: "findTag",
            startTime: Date.now(),
            timeout: req.data.timeout || getDefaultWait()
        };

        findTag(jobId);

        tagJobs.push(jobId);

        setJobInterval();
    };

    function findTag(jobId) {
        let job = jobs[jobId];
        let rd = job.req.data;
        let de = rd.step.step_settings.element;
        let he = null;
        let elemPos = null;
        let step = rd.step;

        if (Date.now() > job.timeout) {
            GmCXt.log(16, "NOT FOUND TAG: " + GmCXt.stepLog(step.step_id, step.tour_id));
            delete jobs[jobId];
            return;
        }

        if (de) {
            he = GmCXt.dom.tFinder(de, rd.frame);

            if (he) {
                GmCXt.log(16, "FOUND TAG: " + GmCXt.stepLog(step.step_id, step.tour_id));
                elemPos = he.getBoundingClientRect();

                if (elemPos) {
                    mg$(he).addClass('mg-ft-tag').addClass(GmCXt.tagClassName(step, rd.tour));
                }
            }
        }
    }

    pub.queueSmarttip = function(req) {

        let step = req.data.step;

        if (notInTopWindow(step.step_settings.element)) return;

        let jobId = "_" + step.step_id;
        let isPreview = req.data.isPreview;

        if (deletedDuctTape.indexOf(jobId) === -1 || isPreview) {

            if (jobs[jobId]) {
                if (isPreview) jobs[jobId] = {};
                else return;
            }

            let resp = {
                requestId: step.step_id
            };

            jobs[jobId] = {
                id: jobId,
                req: req,
                resp: resp,
                task: '',
                state: "findSmarttip",
                startTime: Date.now(),
                timeout: req.data.timeout || getDefaultWait()
            };

            findSmarttip(jobId);

            smarttipJobs.push(jobId);

            setJobInterval();
        }
    };

    pub.clearAll = function() {
        jobs = {};
    };

    pub.clearJob = function(jobId) {
        var jobId = "_" + jobId;

        if (jobs[jobId]) {
            let he = jobs[jobId].resp.he;
            mg$(he).off('focus blur keyup click mouseover mouseout');
            delete jobs[jobId];
        }
    };

    pub.removeToolTipIcons = function(d) {
        mg$('.mgPlayerJSProd_smarttip-icon-wrapper-' + d.step_id).remove();
        mg$('.mgPlayerJSProd_smarttip-valid-' + d.step_id).remove();
        mg$('#mgPlayerJSProd_smarttip-' + d.step_id).remove();
        mg$('.gssSmarttip-form-submit-' + d.tour_id).removeClass('gssSmarttip-form-submit');
        mg$('.gssSmarttip-form-submit-' + d.tour_id).removeClass('gssSmarttip-form-submit-' + d.tour_id);
    };

    pub.clearTooltips = function(list) {
        for (let index = 0; index < smarttipJobs.length; index++) {
            let job = jobs[smarttipJobs[index]];
            if (job) {
                let d = {};

                d.step_id = job.req.data.step.step_id;
                d.tour_id = job.req.data.tour.tour_id;
                if (list) {
                    if (list.indexOf(d.tour_id) !== -1) {
                        pub.removeToolTipIcons(d);
                        pub.clearJob(d.step_id);
                    }
                } else {
                    pub.removeToolTipIcons(d);
                    pub.clearJob(d.step_id);
                }

            }
        }
        smarttipJobs = [];
    };

    pub.getElementPrecision = function(criteria) {
        let el = null;
        if (editJob && editJob.resp) {
            if (editJob.resp.labelHe) {
                el = GmCXt.dom.getElement(editJob.resp.labelHe, criteria, editJob.req.data.frame);
                if (el) {
                    el.pathFromLabel = editJob.resp.de.pathFromLabel;
                    el.targetInfo = editJob.resp.de.targetInfo;
                    el.customSettings = editJob.resp.de.customSettings;
                }

            } else {
                el = GmCXt.dom.getElement(editJob.resp.he, criteria, editJob.req.data.frame);
            }
        }

        return el;
    };

    pub.getCurrentHe = function() {
        if (editJob && editJob.resp) {
            return editJob.resp.he;
        }
    };

    pub.bringElementInViewport = function(data, selector, isFrame) {

        if (selector) {
            try {
                var he = mg$(selector);
            } catch (e) {
                console.log('Error executing jquery; iframe not found to scroll');
            }

            if (he && he.length) {
                bringElementInViewport_(he[0], isFrame); // Bring iframe in viewport
            }
        } else {
            if (data.stepType === GmCXt.STEP_TYPE_MESSAGE && data.tooltip) {
                return; // align 1st tooltip only
            }

            let jobId = "_" + data.requestId;

            let resp = null;
            if (!GmCXt.isEmpty(jobs) && !GmCXt.isEmpty(jobs[jobId])) {
                resp = jobs[jobId].resp;
            }

            if (!GmCXt.isEmpty(editJob)) {
                resp = editJob.resp;
            }

            if (resp && resp.he) {
                let scrollParent = GmCXt.getScrollParent(resp.he);
                scrollPage(resp.he, scrollParent);
            }
        }
    };

    pub.queueRuleElement = function(req) {
        let elemInIFrame = notInTopWindow(req.data.element);

        if (elemInIFrame && GmCXt.iframeCount > 1) {
            return;
        }

        let jobId = "_" + req.data.requestId;
        let resp = {
            requestId: req.data.requestId
        };

        if (req.data.job) {

            jobs[jobId] = {
                id: jobId,
                req: req,
                resp: resp,
                task: '',
                state: "findRuleElement",
                startTime: Date.now(),
                timeout: (Date.now() + req.data.job.timeout) || getDefaultWait(),
                initiator: req.data.job.initiator
            };

            if (elemInIFrame && GmCXt.iframeCount === 1) {
                jobs[jobId].timeout = Date.now();
            }

            findRuleElement(jobId);

            setJobInterval();
        }
    };

    pub.clearRuleJobs = function(i, triggerSource) {

        if (i) {
            var inits = [i];
        } else {
            var inits = ['currentPage', 'beacon', 'smartTip', 'notif'];
        }

        GmCXt.log(5, "CLEARED RULES ELEMENT FINDER JOBS source:  " + triggerSource + " for initiator: ", inits);

        for (let jobId in jobs) {
            if (GmCXt.inArrayString(jobs[jobId].initiator, inits)) {
                deleteJob(jobId);
            }
        }

        clearDomElStore();
    };

    function clearDomElStore() {
        let domElArr = [];

        for (let i = 0; i < GmCXt.domElStore.length; i++) {
            if (mg$.contains(window.document, mg$(GmCXt.domElStore[i].he)[0])) {
                if (GmCXt.getElVisibility(GmCXt.domElStore[i].he) === "visible") {
                    domElArr.push(GmCXt.domElStore[i]);
                }
            }
        }

        GmCXt.domElStore = domElArr;
    }

    pub.queueMatchingAlgoElement = function(req) {

        GmCXt.log(12, "FIND matching algo element");

        let jobId = "_" + req.data.requestId;
        let resp = {
            requestId: req.data.requestId
        };

        let waitTime = 2000;

        jobs[jobId] = {
            id: jobId,
            req: req,
            resp: resp,
            task: '',
            state: "findMatchingAlgoElement",
            startTime: Date.now(),
            timeout: Date.now() + waitTime
        };

        findMatchingAlgoElement(jobId);
        setJobInterval();
    };

    pub.clear = function() {
        jobs = {};
    };

    pub.insertPowerForm = function(data) {

        let job = jobs[data.jobId];
        if (!job) return;

        let he = job.resp.he;

        insertPowerHtml(he, data.tag, data.formHtml, data.forceInsert);
        mg$(he).blur();
    };

    function insertPowerHtml(he, tag, value, forceInsert) {
        if (tag === 'input' || tag === 'textarea' || tag === 'select') {

            if (mg$(he).val() && !forceInsert) return;

            var t = GmCXt.getText(value);

            mg$(he).val(t);
            triggerKeyUp(he);
            triggerChange(he);
            addNoWatch(he);

        } else if (mg$(he).attr('contenteditable') || (he && he.isContentEditable)) {

            var t = GmCXt.getText(he.innerHTML);
            if (t && !forceInsert) return;

            he.innerHTML = value;
            disableFocus = true;
            mg$(he).focus();
            triggerAllEvent(he);
            addNoWatch(he);

            GmCXt.timeout(function() {
                disableFocus = false;
            }, 10);
        }
    }

    function deleteJob(jobId) {

        if (!jobs[jobId]) return;

        GmCXt.log(6, "DELETED RULE JOB :  ", jobs[jobId]);
        delete jobs[jobId];
    }

    let jobNumber = 0;

    function setJobInterval() {
        // Start interval when at least one elem in queue. 
        // Stop when no elems in queue.
        if (Object.keys(jobs).length === 1) {
            clearInterval(intervalId);
            jobNumber = 0;
            intervalId = setInterval(processJobs, 300);
        }
    }

    function checkJobsQueue() {
        if (Object.keys(jobs).length === 0) {
            clearInterval(intervalId);
        }
    }

    function processJobs() {
        jobNumber++;
        checkJobsQueue();
        for (let jobId in jobs) {
            let job = jobs[jobId];

            if (job.state === 'watchBeacon') watchBeaconJob(jobId);
            else if (job.state === 'watchSmarttip') watchSmartTip(jobId);

            if (jobNumber % 3 === 0) {
                if (job.state === 'find') findJob(jobId);
                else if (job.state === 'watch') watchJob(jobId);
                else if (job.state === 'findBeacon') findBeacon(jobId);
                else if (job.state === 'findSmarttip') findSmarttip(jobId);
                else if (job.state === 'findRuleElement') findRuleElement(jobId);
                else if (job.state === 'findMatchingAlgoElement') findMatchingAlgoElement(jobId);
                else if (job.state === 'findVariable') findVariable(jobId);
                else if (job.state === 'findTag') findTag(jobId);
            }
        }
    }

    function watchJob(jobId) {

        let req = jobs[jobId].req;
        let resp = jobs[jobId].resp;

        // To handle element keyUp event
        if (req.data.task !== "workFlowTour") {
            if (jobId === onKeyupEventJobId) {
                onUserEvent.call(this, null, false, jobId);
                onKeyupEventJobId = "";
                return;
            }
        }

        if (resp.he) {
            var rect = GmCXt.getBoundingRect(resp.he);
            if (!rect) rect = {};
        } else return;

        if (GmCXt.currentIframeId && GmCXt.currentIframeId !== GmCXt.id) {
            return;
        }

        // Find element again,
        // if DOM is refreshed and resp.he instance is cleared 

        if (!rect.top && !rect.left && !rect.width && !rect.height || !resp.he.getAttribute(gmjobId)) {

            let strictOnly = false;

            if (!req.pageRefreshed) strictOnly = true;

            req.pageRefreshed = true; // for second time onward; as popup was already present on the screen before refresh, cannot delay >1s for it to reappear

            let elems = getDOMElement(resp.de, req.data.frame, req.data.log_stepInfo, strictOnly, req.data);

            if (elems.he) {
                if (resp.de.pathFromLabel && elems.targetHe) {
                    resp.he = elems.targetHe;
                    resp.labelHe = elems.he;
                } else {
                    resp.he = elems.he;
                }

                if (resp.he) {
                    if (req.data.settings.headerNext) {
                        recheckColumnAttributes(resp.he, resp.de.customSettings);
                    }

                    rect = resp.he.getBoundingClientRect();
                    resp.he.setAttribute(gmjobId, jobId);
                    removeActiveEvents(resp.he);

                    if (!req.data.beaconSetting && !req.data.isElem) bindEvents(req, resp);

                }
            }
        }

        if (req.data.task === "workFlowTour") return;

        hideErrorMessage(jobId);

        let visibility = GmCXt.getElVisibility(resp.he);

        if (rect.width === 0 && rect.height === 0) visibility = 'hidden';

        let posChanged = resp.elPos &&
			(resp.elPos.top !== rect.top ||
				resp.elPos.left !== rect.left ||
				resp.elPos.height !== rect.height ||
				resp.elPos.width !== rect.width);

        if (visibility == 'visible') {

            resp.hiddenAt = null;
            resp.elPos = mg$.extend(true, {}, rect);

            setOutline(jobId);

            resp.data.posChanged = posChanged;
            resp.data.watch = true;
            resp.data.element.position = GmCXt.dom.getElementOffset(rect);

            req.cb(resp.data);

        } else {

            GmCXt.log(33, "STEP ELEMENT HIDDEN from view");

            hideOutline(jobId);

            if (!doNotHideStep(req)) {
                if (req.data.tooltipId) {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:hide_inline_step_popup_tootip', {
                        id: req.data.tooltipId
                    });
                } else {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:hide_inline_step_popup');
                }

            } else {
                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:step_element_hidden');
            }
        }
    }

    function doNotHideStep(req) {
        let stepSetting = req.data.settings;
        if (stepSetting.doNotHide === true)
            return true;
        else
            return false;
    }

    function findJob(jobId) {

        let job = jobs[jobId];
        let req = job.req;
        let resp = job.resp;

        if (req.data.tooltipId && jobId.indexOf(req.data.tooltipId) < 0) {
            return;
        }

        function notFound() {

            GmCXt.log(33, "NOT FOUND STEP ELEMENT: " + req.data.log_stepInfo, 1);
            GmCXt.printMatchingAlgoLogs();
            resp.data.status = GmCXt.ELEMENT_NOT_FOUND;
            resp.data.rca = GmCXt.l.primaryInfo[GmCXt.l.primaryInfo.length - 1];

            delete jobs[jobId];

            if (req.cb) {
                if (req.isHighlightEl) {
                    req.cb(req.data.originalRequest);
                } else {
                    req.cb(resp.data);
                }
            }
        }

        if (req.data.timeout) {
            let now = Date.now();
            if (now > req.timeout) {
                notFound();
                return;
            }
        }

        if (req.data.tooltipId && req.identifier !== "blackout-request") {
            resp.de = req.element;
        } else {
            resp.de = req.data.settings.element;
        }

        let strictOnly = false;
        if (strictMatch(req, 4000) && !req.data.tooltipId) {
            strictOnly = true;
        }

        let elems = getDOMElement(resp.de, req.data.frame, req.data.log_stepInfo, strictOnly, req.data);

        if (resp.de.pathFromLabel && elems.targetHe) {
            resp.he = elems.targetHe;
            resp.labelHe = elems.he;
        } else {
            resp.he = elems.he;
        }

        if (!resp.he) {

            if (req.data.waitTime === 0) {
                notFound();
                return;

            } else if (req.data.showLogs === false && req.startTime + 5000 < Date.now()) {
                GmCXt.printMatchingAlgoLogs();
                req.data.showLogs = true;
            }
        }

        if (resp.he) {

            if (req.data.settings.headerNext) {
                recheckColumnAttributes(resp.he, resp.de.customSettings);
            }

            if (job.task === "findAndKeep") {
                var el = GmCXt.dom.getElement(elems.he, getCriteria(req), req.data.frame);

                // In case of target elem path from Label element, 
                // get position of target elem
                if (resp.de.pathFromLabel) {
                    el.position = GmCXt.dom.getElementPos(resp.he).position;
                    el.pathFromLabel = resp.de.pathFromLabel;
                    el.targetInfo = resp.de.targetInfo;
                    el.customSettings = resp.de.customSettings;
                }
            } else {
                var el = GmCXt.dom.getElementPos(resp.he);
            }

            if (el.position.width === 0 && el.position.height === 0) {
                if (resp.de.version && GmCXt.decodeVersion(resp.de.version) >= 10000) {
                    let rect = resp.he.parentNode.getBoundingClientRect();
                    let pos = resp.de.position;

                    if (pos.width === rect.width && pos.height === rect.height) {
                        el.position = rect;
                    }
                }
            }

            if (el.position.width > 0 && el.position.height > 0) {

                if (GmCXt.checkWorkdaySite() && mg$(resp.he).parents("[data-automation-id*='ActiveListRow']")[0]) {
                    let parentStr = "[data-automation-id*='ActiveListRow']";
                    resp.data.workdayEdit = {
                        isTrue: true,
                        index: mg$(parentStr).index(mg$(resp.he).parents(parentStr)[0])
                    };
                }

                GmCXt.log(33, "FOUND STEP ELEMENT: " + req.data.log_stepInfo, 1);
                GmCXt.printMatchingAlgoLogs();

                resp.cssPosition = GmCXt.dom.getElementFixedPosition(resp.he);

                resp.elPos = mg$.extend(true, {}, el.position);

                resp.data.status = GmCXt.ELEMENT_FOUND;

                resp.data.element = el;
                resp.data.he = resp.he;

                resp.data.element.elOptions = GmCXt.getElOptions(resp.he);

                resp.data.cssPosition = resp.cssPosition;

                resp.data.elTag = mg$(resp.he)[0].tagName.toLowerCase();
                resp.data.isEditableEl = mg$(resp.he).attr('contenteditable') || resp.he && resp.he.isContentEditable;
                resp.data.id = GmCXt.id;

                if (req.data.tagId) {
                    resp.data.tagId = req.data.tagId;
                }

                // addBlackoutOverlay(req, resp);
                resp.userEventFlag = false;
                resp.he.setAttribute(gmjobId, jobId);
                let existingClasses = mg$(resp.he).attr('class') || '';
                mg$(resp.he).attr('class', existingClasses + ' doitforme-' + jobId.slice(1));

                removeActiveEvents(resp.he);

                if (!req.data.beaconSetting && !req.data.isElem && req.type != 'tag') {
                    bindEvents(req, resp);
                }

                if (req.data.task === "workFlowTour") {
                    addAttrsForIntel(resp.he, req);
                } else if (!req.data.noOutline) {
                    setOutline(jobId);
                }

                if (job.task === "findAndWatch") {
                    job.state = "watch";
                } else if (job.task === "findAndKeep") {
                    editJob = mg$.extend(true, {}, job);
                }

                if (job.task === "findOnly" || job.task === "findAndKeep") {
                    delete jobs[jobId];
                }

                if (req.cb) {
                    req.cb(resp.data);
                }
            }
        }
    }

    function findVariable(jobId) {
        let job = jobs[jobId];
        let requestData = job.req.data;
        let de = requestData.varElem;
        let he = null;
        let elemValue = null;

        let varlog = GmCXt.tourLog({
            tour_id: requestData.varId,
            tour_title: requestData.varTitle
        });

        if (Date.now() > job.timeout) {
            GmCXt.log(67, "NOT FOUND VARIABLE " + varlog);
            GmCXt.printMatchingAlgoLogs();
            job.resp.value = false;
            job.resp.name = requestData.varTitle;
            job.req.cb(job.resp);
            pub.clearJob(requestData.varId);
            return;
        }

        if (de) {
            let log_stepInfo = "[VARIABLE] " + requestData.varTitle;

            he = getDOMElementForRule(de, requestData.frame, log_stepInfo);

            if (he) {

                GmCXt.log(67, "FOUND VARIABLE " + varlog);
                GmCXt.printMatchingAlgoLogs();
                job.resp.value = GmCXt.getElementText(he) || GmCXt.dom.getElText(he).value;
                job.resp.name = requestData.varTitle;
                job.resp.he = he;
                if (job.req.cb) {
                    job.req.cb(job.resp);
                    pub.clearJob(requestData.varId);
                }
            }
        }
    }

    function recheckColumnAttributes(he, customSettings) {
        let sf = GmCXt.dom.salesForceHeader(he);
        let ubs = GmCXt.dom.checkUBSHeader(he);
        let table = GmCXt.dom.checkTableHeader(he);

        for (var key in customSettings.salesforce) {
            if (sf.hasOwnProperty(key)) {
                customSettings.salesforce[key] = sf[key];
            }
        }

        for (var key in customSettings.ubs) {
            if (ubs.hasOwnProperty(key)) {
                customSettings.ubs[key] = ubs[key];
            }
        }

        for (var key in customSettings.table) {
            if (table.hasOwnProperty(key)) {
                customSettings.table[key] = table[key];
            }
        }
    }

    function findBeacon(jobId) {

        let job = jobs[jobId];
        let requestData = job.req.data;
        let de = requestData.stepData;
        let he = null;
        let elemPos = null;
        let tourlog = GmCXt.tourLog({
            tour_id: requestData.tourId,
            tour_title: requestData.tourTitle
        });

        if (Date.now() > job.timeout) {
            GmCXt.log(48, "NOT FOUND BEACON " + tourlog);
            GmCXt.printMatchingAlgoLogs();

            GmCXt.trackElNotFound({
                source: "beacon",
                tour_id: requestData.tourId
            });

            delete jobs[jobId];
            return;
        }

        let strictOnly = strictMatch(job);

        if (de) {
            let log_stepInfo = "[BEACON] " + requestData.tourTitle;
            he = getDOMElementForRule(de, requestData.frame, log_stepInfo, strictOnly);

            if (he) {

                GmCXt.log(48, "FOUND BEACON " + tourlog);
                GmCXt.printMatchingAlgoLogs();

                elemPos = he.getBoundingClientRect();

                if (elemPos) {
                    job.resp.he = he;
                    job.resp.elemPos = elemPos;
                    setBeaconPosition(jobId);
                    job.state = "watchBeacon";
                }
            }
        }
    }

    function strictMatch(job, duration) {

        if (!duration) duration = 3000;

        if (job.startTime + duration > Date.now()) {
            return true;
        }

        return false;
    }

    function isTargetFrame(de, frame, startTime) {
        let waitTime = GmCXt.t.tragetFrameWT;

        if (de.criteria.precision_level === "High" &&
			!GmCXt.isEmpty(de.iframeAttrs) &&
			(startTime + waitTime) > Date.now()) { // Target frame check not required in these cases

            if (!GmCXt.isEmpty(frame) && GmCXt.validateTargetFrame(de.iframeAttrs, frame.attributes)) {
                return true;
            } else {
                return false;
            }
        }
        return true;
    }

    function findSmarttip(jobId) {
        let job = jobs[jobId];
        let rd = job.req.data;
        let de = rd.step.step_settings.element;
        let he = null;
        let elemPos = null;
        let step = rd.step;

        if (Date.now() > job.timeout) {
            GmCXt.log(43, "NOT FOUND SMARTTIP: " + GmCXt.stepLog(step.step_id, step.tour_id));
            GmCXt.printMatchingAlgoLogs();

            GmCXt.trackElNotFound({
                source: "smartTip",
                tour_id: job.req.data.step.tour_id,
                step_id: step.step_id
            });

            delete jobs[jobId];
            return;
        }

        let strictOnly = strictMatch(job);

        if (de) {

            he = getDOMElementForRule(de, rd.frame, GmCXt.getStepInfoLog(step), strictOnly);

            if (he) {

                removePrevTooltip(he, jobId, rd, step);

                GmCXt.log(43, "FOUND SMARTTIP: " + GmCXt.stepLog(step.step_id, step.tour_id));
                GmCXt.printMatchingAlgoLogs();

                elemPos = he.getBoundingClientRect();

                if (elemPos) {
                    mg$(he).addClass('mg-smarttip-' + jobId);
                    job.resp.he = he;
                    job.resp.elemPos = elemPos;
                    job.resp.de = de;
                    job.resp.text = he.textContent;
                    positionSmartTip(jobId, he);
                    job.state = "watchSmarttip";
                }
            }
        }
    }

    // Checks if element is in visible area of parent container
    // which has scrollbar.
    // Parent container can be any html element or window object.
    // If element is not in parent elements visible area, it brings it in
    // viewport.
    // Sometimes it may happen that element is inside parent container's
    // boundaries, but it's NOT visible in top window's viewport.
    // pub.bringElementInViewport handles this last scenario.

    function bringElementInViewport_(he, isFrame) {

        GmCXt.l.start('function', 'bringElementInViewport_', arguments);

        let scrollParent = GmCXt.getScrollParent(he);
        let pos = he.getBoundingClientRect();

        if (!checkVisible(scrollParent, pos) || GmCXt.getElVisibility(he, isFrame) === 'hidden') {
            scrollPage(he, scrollParent);
        }

        GmCXt.l.end(he);
    }

    function scrollPage(he, scrollParent) {

        let scrollBySF = 0;
        if (GmCXt.checkSalesForceSite()) {
            let containerSF = mg$('DIV.oneCenterStage');
            if (containerSF.length) {
                containerSF = containerSF[0];
                if (containerSF.scrollHeight > (containerSF.clientHeight + 5)) {
                    scrollBySF = sfdcHeaderHeight();
                }
            }
        }

        if (mg$(he).height() < screen.height) {

            he.scrollIntoView(false);

            pos = he.getBoundingClientRect();

            // To vertically center align the selected element
            if (scrollParent) {
                let parentPos = scrollParent.getBoundingClientRect();

                var scrollBy = (mg$(scrollParent).height() - pos.height) / 2.5;
                if (scrollBy > 0 && (pos.top - parentPos.top) > mg$(scrollParent).height() / 2) {
                    scrollBy = mg$(scrollParent).scrollTop() + scrollBy;
                    mg$(scrollParent).scrollTop(scrollBy);
                }
            } else {
                var scrollBy = (screen.height - pos.height) / 2.5;

                if (scrollBy > 0 && scrollBy < pos.top) {
                    scrollBy = mg$(window).scrollTop() + scrollBy - scrollBySF;
                    mg$(window).scrollTop(scrollBy);
                } else if (pos.top < 0) {
                    scrollBy = mg$(window).scrollTop() + pos.top - scrollBySF;
                    mg$(window).scrollTop(scrollBy);
                }
            }
        } else {
            he.scrollIntoView(true);

            if (scrollBySF) {
                mg$(window).scrollTop(mg$(window).scrollTop() - scrollBySF - 20); // buffer 20px
            }
        }
    }

    function sfdcHeaderHeight() {

        let headerHeight = 0;
        let header = mg$('header#oneHeader');
        if (header.length) {
            headerHeight += header[0].offsetHeight;
        }

        let navPanel = mg$('one-appnav');
        if (navPanel.length && !mg$(header).find(mg$('one-appnav')).length) {
            headerHeight += navPanel[0].offsetHeight;
        }

        let highlights = mg$('DIV.highlights');
        if (highlights.length) {
            headerHeight += highlights[0].offsetHeight;
        }
        return headerHeight;
    }

    function checkVisible(scrollParent, pos_) {
        let containerHeight = mg$(window).height();
        let containerWidth = mg$(window).width();
        let pos = mg$.extend(true, {}, pos_);
        let inViewport = false;

        if (scrollParent) {

            let inTopWindow = GmCXt.visibleInViewport(pos, containerHeight, containerWidth);

            let scrollParentPos = scrollParent.getBoundingClientRect();
            containerHeight = scrollParentPos.height;
            containerWidth = scrollParentPos.width;

            pos.top = (pos.top - scrollParentPos.top);
            pos.left = (pos.left - scrollParentPos.left);

            let inChildWindow = GmCXt.visibleInViewport(pos, containerHeight, containerWidth);

            inViewport = inTopWindow && inChildWindow;

        } else {
            inViewport = GmCXt.visibleInViewport(pos, containerHeight, containerWidth);
        }

        return inViewport;
    }

    function getCriteria(req) {
        let data = req.data.settings;
        if (data && data.element) return data.element.criteria;
        else return null;
    }

    function checkVisisbilityForSalesForce(el) {
        // This function added for input elements in salesforce
        if (el.tagName == 'INPUT') {
            let level = 5;
            let tempEl = el;
            for (let ctr = 0; ctr < level; ctr++) {
                if (tempEl.getRootNode() instanceof ShadowRoot) break;

                if (tempEl.classList.contains('slds-hide')) {
                    el = tempEl.parentNode;
                    break;
                }

                tempEl = tempEl.parentNode;
            }
        }
        return el;
    }

    function checkVisibilityForWorkday(el) {
        // This function is for input elements in relx workday
        let returnValue = el;
        if (el.tagName === 'INPUT' && el.placeholder === 'search' && mg$(el).css('display') === 'none') {
            el = el.parentNode;
        }
        if (mg$(el).is("[data-automation-hiddensearch]")) {
            return el.parentNode;
        }
        return returnValue;
    }

    function checkVisibility(el) {

        GmCXt.l.start('function', 'checkVisibility', arguments);

        let returnValue = el;

        if (el && GmCXt.checkSalesForceSite()) {
            el = checkVisisbilityForSalesForce(el);
            returnValue = el;
        }

        if (el && GmCXt.checkWorkdaySite()) {
            el = checkVisibilityForWorkday(el);
            returnValue = el;
        }

        if (el && GmCXt.getElVisibility(el) === 'hidden') {
            GmCXt.l.add('Element is hidden.', true);
            returnValue = null;
        }

        return GmCXt.l.return(returnValue);
    }

    function bringInViewport(d) {
        return !(d && ((d.stepType === GmCXt.STEP_TYPE_MESSAGE && d.tooltip > 0) || d.task === "workFlowTour"));
    }

    function isFrameInViewPort(frame) {
        if (!GmCXt.isEmpty(frame.attributes)) {
            let attributes = frame.attributes;
            let s = '';
            Object.keys(attributes).forEach(function(key) {
                let val = attributes[key];
                if (typeof val === 'string') {
                    val = val.replace(/'/g, "\\'");
                }
                if (val !== null && val !== undefined) {
                    s += "[" + key + "='" + val + "']";
                }

            });
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:check_iframe_visible', {
                selector: s
            });
        }
    }

    function isVisible_(he, de, data) {
        if (!de.meta.inTopWindow && data && data.requestId && data.frame) {
            isFrameInViewPort(data.frame);
        }

        if (bringInViewport(data)) {
            bringElementInViewport_(he);
        }

        return checkVisibility(he);
    }

    function getDOMElement(de, frame, log_stepInfo, strictOnly, data) {
        try {
            GmCXt.l.reset();
            GmCXt.l.start('function', 'getDOMElement', arguments);

            let he, targetHe = null;

            if (de.version && GmCXt.decodeVersion(de.version) >= 10000) {

                he = GmCXt.dom.finder(de, frame, log_stepInfo, strictOnly);

                if (he) {

                    he = checkTableArrow(he);

                    if (de.pathFromLabel) { // if he is label then find input element
                        GmCXt.l.add('Finding the corresponding input element to the label. . .', true);

                        migrateTargetTag(de);
                        targetHe = GmCXt.dom.findTargetInputElement(he, de.pathFromLabel, de.targetInfo, de);

                        if (targetHe) {
                            targetHe = isVisible_(targetHe, de, data);
                        }

                        if (!targetHe) {
                            he = null;
                        }
                    } else {
                        he = isVisible_(he, de, data);
                    }
                }

                var returnObj = {
                    he: he,
                    targetHe: targetHe
                };

            } else if (de) {
                he = legacyMethod(de);
                var returnObj = {
                    he: checkVisibility(he)
                };
            }

            return GmCXt.l.return(returnObj);
        } catch (e) {
            console.error(e);
            return {};
        }
    }

    function checkTableArrow(he) {
        let tempHe = he;
        let columnIndex, rowIndex, nodes;

        if (GmCXt.checkSalesForceSite()) {
            while (tempHe && tempHe.tagName !== 'TBODY') {
                if (tempHe.tagName === 'BODY') {
                    break;
                }

                if (tempHe.tagName === 'TD') {
                    columnIndex = mg$(tempHe).parent().children().index(mg$(tempHe));
                }

                if (tempHe.tagName === 'TR') {
                    rowIndex = mg$(tempHe).parent().children().index(mg$('tr.selected'));
                }

                tempHe = tempHe.parentNode;
            }

            if (columnIndex >= 0 && rowIndex >= 0 && tempHe.tagName === 'TBODY') {
                nodes = mg$(tempHe).children().eq(rowIndex).children().eq(columnIndex).find(he.tagName);
            }
        }

        if (nodes && nodes.length) {
            he = nodes[0];
        }

        return he;
    }

    function migrateTargetTag(de) {
        if (de.targetTag) {
            de.targetInfo = {
                tagName: de.targetTag
            };
            delete de.targetTag;
        }
    }

    function getDOMElementForRule(de, frame, log_stepInfo, strictOnly, ruleEl) {

        GmCXt.l.reset();
        GmCXt.l.start('function', 'getDOMElementForRule', arguments);

        let he = null;

        if (de.version && GmCXt.decodeVersion(de.version) >= 10000) {

            // 1.3.34 westpac
            if (GmCXt.decodeVersion(de.version) <= 5033401) {
                he = GmCXt.dom1334.finder(de, frame, log_stepInfo);

                // if he is label then find input element  
                if (he) {
                    GmCXt.l.add('Element found in the document', true);
                    if (de.pathFromLabel) {
                        GmCXt.l.add('Finding the corresponding input element to the label. . .', true);
                        he = GmCXt.dom1334.findTargetInputElement(he, de.pathFromLabel, de.targetTag);
                    }
                }
            } else {

                he = GmCXt.dom.finder(de, frame, log_stepInfo, strictOnly);

                // if he is label then find input element  
                if (he) {
                    if (de.pathFromLabel) {
                        GmCXt.l.add('Finding the corresponding input element to the label. . .', true);

                        migrateTargetTag(de);
                        he = GmCXt.dom.findTargetInputElement(he, de.pathFromLabel, de.targetInfo, de, ruleEl);
                    }
                }
            }

        } else if (de) {
            he = legacyMethod(de);
        }

        let returnValue = null;

        if (he)
            returnValue = he;
        else
            GmCXt.l.add('Element not found', true);

        return GmCXt.l.return(returnValue);
    }

    function legacyMethod(de) {
        let path = req.data.settings.path;

        if (req.data.settings && req.data.settings.matchLabel) {
            return matchByLabel(de);
        } else {
            return GmCXt.domFinder(de, path);
        }
    }

    function matchByLabel(elem) {
        let he = GmCXt.findElementByLabel(elem);

        if ((he == null) && elem.parentData && elem.parentData.innerText.length) {
            he = GmCXt.findElementByParentLabel(elem, elem.parentData);
        }

        return he;
    }

    pub.onDocumentClick = function(e) {

        let r = {
            onElem: false,
            inColumn: false,
            onRightClickElem: false
        };

        for (let jobId in jobs) {

            let job = jobs[jobId];
            let req = job.req;
            let resp = job.resp;

            if (req && req.data && req.data.task === 'playTour') {
                r.state = job.state;

                if (checkIfClickOnElem(e, jobId)) {
                    GmCXt.log(33, "Event: Click on element");
                    r.onElem = true;
                }
                if (checkIfRightClickOnElem(e, jobId)) {
                    GmCXt.log(33, "Event: Right click on element");
                    r.onRightClickElem = true;
                }
                if (checkIfClickInColumn(e.target, resp.he, resp.de.customSettings)) {
                    GmCXt.log(33, "Event: Click in column");
                    r.inColumn = true;
                }
            } else {
                r.onElem = onElem;
            }
        }
        if (GmCXt.isEmpty(jobs)) {
            r.onElem = onElem;
        }

        onElem = false;
        return r;
    };

    pub.onDocumentClickForTooltip = function(e) {

        for (let jobId in jobs) {

            let job = jobs[jobId];
            let req = job.req;
            var resp = job.resp;

            if (req && req.data) {
                let step = req.data.step;
                if (step) {
                    let el = step.step_settings.element;
                    if (el && el.applyToColumn) {
                        if (GmCXt.checkWorkdaySite()) {
                            checkCol(jobId);
                        }
                    }
                }
            }
        }

        function checkCol(jobId) {
            checkWorkdayColumn(e.target, resp.de)
                .then(function(he) {

                    let job = jobs[jobId];
                    let req = job.req;
                    let step = req.data.step;

                    if (!GmCXt.isEmpty(he)) {

                        if (job) {
                            job.resp.he = he;

                            showPowerForm(he, jobId, step, req.data.isPreview);
                        } else {
                            // Caution: Do NOT change this else block
                            // This is because sometimes jobs[jobId] comes undefined
                            // Some very strange javascript problem detected in Workday
                            GmCXt.timeout(function() {
                                job.resp.he = he;
                                showPowerForm(he, jobId, step, req.data.isPreview);
                            }, 1000);
                        }
                    }
                });
        }
    };

    function getElementHtml(he) {
        let html = mg$(he).html();
        return "<p>" + html + "</p>";
    }

    function showPowerForm(he, jobId, step, isPreview) {

        let job = jobs[jobId];
        let rd = job.req.data;
        let tag = mg$(he)[0].tagName.toLowerCase();
        let value = rd.settings.smartTip.htmlContent;

        let data = {
            he: getElementHtml(he),
            tag: tag,
            value: value,
            oldHe: getFormOldValue(he, value),
            jobId: jobId,
            step: step,
            isPreview: isPreview
        };

        GmCXt.openPowerForm(data);
        mg$(he).blur();
    }

    function isForceMode(req) {
        if (req.data.settings.doNotForceGuide !== true &&
			req.data.playerInstance &&
			req.data.playerInstance.forceGuideMe === true)
            return true;
        else
            return false;
    }

    function checkIfClickInColumn(target, he, customSettings) {

        if (customSettings) {

            let customTable = false;
            for (let key in customSettings) {
                if (!GmCXt.isEmpty(customSettings[key])) {
                    var s = customSettings[key];

                    if (key === 'ubs' && s.tableCategory === 1) {
                        customTable = true;
                    }

                    break;
                }
            }

            if (s) {
                if (customTable) {
                    target = findCell(target, 'datagrid-cell');
                } else {
                    target = findCell(target);
                }

                if (target && mg$.inArray(he, mg$(target).find(he)) === -1) { // Check if click is not in the header itself

                    if (customTable) {
                        return s.columnDataKey === target.getAttribute('data-key');
                    } else {
                        let targetColumnIndex = mg$(target).parent().children().index(mg$(target));
                        return s.columnIndex === targetColumnIndex;
                    }
                }
            }
        }
        return false;
    }

    function findCell(target, className) {
        while (condition(target, className)) {
            if (target.tagName === 'BODY' || target.tagName === 'HTML') {
                target = null;
                break;
            }

            target = target.parentNode;
        }

        return target;
    }

    function condition(target, className) {
        if (target) {
            if (className)
                return !mg$(target).hasClass(className);
            else
                return target.tagName.toLowerCase() !== 'td' && target.tagName.toLowerCase() !== 'th';
        }
        return false;
    }

    function checkWorkdayColumn(target, de) {
        return new Promise(function(resolve, reject) {
            let he = null;
            let button = null;
            if (!de) return;

            while (target && target.tagName !== 'TD') {
                if (target.tagName === 'BODY') {
                    target = null;
                    break;
                }

                target = target.parentNode;
            }

            if (target && de.customSettings && de.applyToColumn) {
                let customSettings = de.customSettings;
                if (customSettings && customSettings.workday && customSettings.workday.isTableHeader) {
                    let workday = customSettings.workday;
                    let targetColumnIndex = mg$(target).parent().children().index(mg$(target));
                    if (targetColumnIndex === workday.columnIndex) {
                        let textarea = mg$(target).find('textarea')[0];
                        he = mg$(textarea).parent().find('[role=textbox]')[0];
                        button = mg$(target).find('button')[0];
                        if (textarea && button) {
                            button.disabled = true;
                        }
                        if (he) {
                            resolve(he);
                        } else {
                            GmCXt.timeout(function() {
                                he = mg$(textarea).parent().find('[role=textbox]')[0];
                                resolve(he);
                            }, 250);
                        }
                    }
                }
            }
        });
    }

    function checkIfClickOnElem(e, jobId) {
        let resp = jobs[jobId].resp;
        let pos = resp.elPos;
        let isRightClick = e && e.button && e.button === 2;

        if (pos && isRightClick !== true &&
			(Math.floor(pos.left) <= e.clientX && e.clientX <= pos.left + pos.width) &&
			(Math.floor(pos.top) <= e.clientY && e.clientY <= pos.top + pos.height)
        ) {
            return true;
        } else {
            return false;
        }
    }

    function checkIfRightClickOnElem(e, jobId) {
        let resp = jobs[jobId].resp;
        let pos = resp.elPos;
        let isRightClick = e && e.button && e.button === 2;

        if (pos && isRightClick === true &&
			(Math.floor(pos.left) <= e.clientX && e.clientX <= pos.left + pos.width) &&
			(Math.floor(pos.top) <= e.clientY && e.clientY <= pos.top + pos.height)
        ) {
            return true;
        } else {
            return false;
        }
    }


    function setOutline(jobId) {

        let job = jobs[jobId];

        if (job.req.identifier === "blackout-request") return;

        let b = 2;
        let resp = job.resp;

        let pos = mg$.extend(true, {}, resp.elPos);
        let outline = job.outline;
        let backgroundColor = '';

        let os = GmCXt.getStepSettings();

        if (os) {
            b = os.selectorStyle.borderWidth;
            backgroundColor = os.selectorStyle.borderColor;
        }

        pos.top = pos.top - b;
        pos.left = pos.left - b;
        pos.width = pos.width + (b * 2);
        pos.height = pos.height + (b * 2);

        if (resp.cssPosition !== true) {
            pos.top += mg$(window).scrollTop();
            pos.left += mg$(window).scrollLeft();
        }

        if (resp.cssPosition) {
            position = "fixed";
        } else {
            position = "absolute";
        }

        let isElectron = (GmCXt.conf.runEnv === "electron");

        if (pos) {
            outline.top.css({
                top: isElectron ? Math.max(0, pos.top) : pos.top,
                left: pos.left,
                width: pos.width,
                height: b,
                background: backgroundColor,
                position: position
            });
            outline.bottom.css({
                top: pos.top + pos.height - b,
                left: pos.left,
                width: pos.width,
                height: b,
                background: backgroundColor,
                position: position
            });
            outline.left.css({
                top: pos.top,
                left: isElectron ? Math.max(0, pos.left) : pos.left,
                width: b,
                height: pos.height,
                background: backgroundColor,
                position: position
            });
            outline.right.css({
                top: pos.top,
                left: pos.left + pos.width - b,
                width: b,
                height: pos.height,
                background: backgroundColor,
                position: position
            });
        }

        showOutline(jobId);
    }

    function hideOutline(jobId) {
        mg$('.mgPlayerJSProd_select-outline.' + jobId).hide();
    }

    function showOutline(jobId) {
        mg$('.mgPlayerJSProd_select-outline.' + jobId).show();
    }

    function editStep(e) {
        GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:execute_edit_step_activerequest');
    }

    function getNextDomain(nextStep) {
        let domain = '';

        if (nextStep && nextStep.step_url) {
            domain = GmCXt.getDomain("https://" + nextStep.step_url);
        }

        return domain;
    }

    function checkReload(s) {

        //if(e && checkForNewTab) {
        //   flag = mg$(this).attr("target") !== "_blank" && !e.ctrlKey && !e.shiftKey;
        //}

        if (GmCXt.playerI.testAutomation) {
            let nextStep = GmCXt.getNextStep();
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:automation_check_reload', {
                pageReloadOption: s.pageReloadOption,
                isNextStep: nextStep ? true : false
            });
        }

        if (s.nextStepOpensInNewTab ||
			s.pageGetsReloaded ||
			s.pageReloadOption === "new_tab" ||
			s.pageReloadOption === "reload" ||
			s.pageReloadOption === "restart_parent") {
            GmCXt.log(33, "Step settings, page reloads or new tab opens.");
            return false;
        } else
            return true;
    }

    function hideErrorMessage(jobId) {

        if (checkForError(jobId)) {
            let id = GmCXt.getHostErrorId();
            if (id && mg$(id).length === 0) {
                GmCXt.toastMsgPersistent().hide();
            }
        }
    }

    function checkForError(jobId) {
        let job = jobs[jobId];
        let c = false;
        if (job) {
            let setting = job.req.data.settings;
            if (setting.checkOnScreenError) {
                c = true;
            }
        }
        return c;
    }

    function onUserEvent(e, checkForNewTab, jobId) {

        if (checkForError(jobId)) {

            GmCXt.timeout(function() {
                if (GmCXt.checkForErrorOnScreen()) return;
                onUserEventIn(e, checkForNewTab, jobId);
            }, 3000);

        } else {
            onUserEventIn(e, checkForNewTab, jobId);
        }
    }

    function onUserEventIn(e, checkForNewTab, jobId) {

        GmCXt.log(33, "onUserEventIn");

        let job = jobs[jobId];
        let PI = GmCXt.playerI;

        let currentStepDomainName = '';
        let nextStepDomainName = '';

        if (PI && job && job.resp.userEventFlag === false) {

            let setting = job.req.data.settings;

            if (setting.clickNext === true || setting.onClickTooltip === true) {
                mg$(job.resp.he).off('mousedown touchstart').on("mousedown touchstart", onMouseUpElement);
                mg$(job.resp.he).off('mouseup touchend').on("mouseup touchend", onMouseUpElement);
            }

            if (setting.onCopyNext) {
                mg$(job.resp.he).unbind('copy', onCopyText);
            }

            job.resp.userEventFlag = true;
            onElem = true;

            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:close_step');

            // TODO: 
            if (PI.tour && PI.tour.steps && mg$.isArray(PI.tour.steps)) {

                let currentStep = GmCXt.getStepFromPlayerI(PI.currentStepId);
                let currentStepUrl = "https://" + currentStep.step_url;
                currentStepDomainName = GmCXt.getDomain(currentStepUrl);
            }

            if (!(setting.pageReloadOption === "new_tab" || setting.pageReloadOption === "reload") &&
				!GmCXt.isLooping()
            ) {
                GmCXt.getSurveyScreen(GmCXt.createDeepCopy(PI));
            }

            if (job.req.data.nextStep) {

                nextStepDomainName = getNextDomain(job.req.data.nextStep);

                if (currentStepDomainName === nextStepDomainName && checkReload(setting)) {

                    GmCXt.log(33, "On user event, send message to play next step.");
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_next_step');

                } else if (setting.pageReloadOption === "restart_parent") {
                    GmCXt.restartInParent();
                }
            } else if (GmCXt.playerI.testAutomation) {
                checkReload(setting);
            }

            if (PI.loops && PI.completeEventTracked) {

                GmCXt.log(33, 'Tour Loop: ' + (PI.currentLoop + 1) + ' completed.');

                if (!(setting.pageReloadOption === "new_tab" || setting.pageReloadOption === "reload")) {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:tour_loop_completed');
                }
            } else if ((!(GmCXt.isPlayer() && PI.tour.tour_settings.enableSentiment) || PI.testAutomation) &&
				GmCXt.isLastStep(PI.currentStepId, PI.playStructure) && !GmCXt.isLooping()) {

                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:close_guide');
            }

            hideOutline(jobId);
            delete jobs[jobId];

            if (GmCXt.isDesktop() && !PI.isLastStep) {
                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_next_step');
            }
        }
    }

    function createOutline(jobId, tooltipId, identifier) {
        let cname = 'mgPlayerJSProd_select-outline ' + jobId;
        if (identifier === "editStep") {
            cname = 'mgPlayerJSProd_select-tool-outline ' + jobId;
        }

        if (tooltipId)
            cname += ' mgPlayerJSProd_msg-tooltip-' + tooltipId;

        let div = '<wmgPlayerJSProd_ class="' + cname + '"></wmgPlayerJSProd_>';

        jobs[jobId].outline = {
            top: mg$(div).prependTo('html'),
            bottom: mg$(div).prependTo('html'),
            left: mg$(div).prependTo('html'),
            right: mg$(div).prependTo('html')
        };
    }

    function clickOnHighlightedArea(e, aoi, framePos) {
        if (!GmCXt.isEmpty(aoi)) {
            let left = e.clientX;
            let top = e.clientY;

            if (!GmCXt.isEmpty(framePos)) {
                left += framePos.x;
                top += framePos.y;
            }

            if ((left > aoi.left && left < (aoi.left + aoi.width)) &&
				(top > aoi.top && top < (aoi.top + aoi.height))) {
                return true;
            }
        }
        return false;
    }

    pub.removeOutline = function(tooltipId) {

        if (tooltipId) {
            mg$('.mgPlayerJSProd_msg-tooltip-' + tooltipId).remove();
        } else
            mg$('.mgPlayerJSProd_select-outline').remove();
        mg$('.mgPlayerJSProd_select-tool-outline').remove();
    };

    // Bind events on the element

    function bindEvents(req, resp) {

        if (req.data.tooltipId && checkGuideLink(req, resp)) {
            mg$(resp.he).one("mouseup", onClickEl);
        } else {
            // completionEvent property is defined in new step creator only
            if (req.data.settings.completionEvent || req.data.settings.keepNext) {

                bindNewEvents(req, resp);

                if (req.data.triggerEvent) {

                    if (GmCXt.autoTrigger) {
                        clearTimeout(GmCXt.autoTrigger);
                    }
                    triggerEvents(req, resp.he);
                }

            } else {
                bindLegacyEvents(req, resp);
            }
        }
    }

    var onClickEl = function(e) {
        let jobId = e.currentTarget.getAttribute(gmjobId);
        let resp = jobs[jobId].resp;

        if (GmCXt.playerI && resp.userEventFlag === false) {
            resp.userEventFlag = true;

            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:close_step');

            let data = {
                tourId: resp.guideLinkId
            };

            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_linked_tour', data);

            hideOutline(jobId);
            delete jobs[jobId];
        }
    };

    var checkGuideLink = function(req, resp) {
        let d = req.data.settings;

        if (!d.domElems) return false;

        for (let i = 0, j = d.domElems.length; i < j; i++) {
            let el = d.domElems[i];

            if (el.id === req.data.tooltipId && el.linkedGuideId) {
                resp.guideLinkId = el.linkedGuideId;
                return true;
            }
        }
        return false;
    };

    let onKeyupElement = function(e) {
        if (mg$(this).val().length) {
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:enable_next_button');
        }
    };

    var onCopyText = function(e) {
        GmCXt.timeout(function() {

            GmCXt.log(33, "onCopyElement");

            let jobId = null;
            let isRightClick = e && e.button && e.button === 2;
            if (e.data && e.data.he) {
                jobId = e.data.he.getAttribute(gmjobId);
            } else {
                jobId = e.currentTarget.getAttribute(gmjobId);
            }
            let el = e.currentTarget;
            let job = jobs[jobId];

            if (!job) return;

            let data = job.req.data;

            GmCXt.log(33, "Event: copy - " + data.task);

            onUserEvent.call(this, e, true, jobId);

        }, 500);
    };

    GmCXt.keyupTimer = null;

    let onKeyupElementNew = function(e, task, waitTime) {
        let jobId = e.currentTarget.getAttribute(gmjobId);
        let job = jobs[jobId];
        if (job && job.resp) var resp = job.resp;
        if (!job) return;

        waitTime = (typeof waitTime === 'number') ? waitTime * 1000 : 1000;
        let timer = (task === 'workFlowTour') ? 100 : waitTime;

        clearTimeout(GmCXt.keyupTimer);

        GmCXt.keyupTimer = GmCXt.timeout(function() {

            let inp = String.fromCharCode(e.keyCode);

            if (/[a-zA-Z0-9-_ `!@#$%^&*(){}|]/.test(inp) || GmCXt.playerI.automate) {

                GmCXt.log(33, "Event: key up");
                GmCXt.log(27, "Event: key up");

                mg$(resp.he).off("keyup paste", onKeyupElementNew);

                onKeyupEventJobId = jobId;
            }
        }, timer);
    };

    let onMouseUpRightClickElement = function(e) {
        if (e && e.button === 2) {
            let jobId = e.currentTarget.getAttribute(gmjobId);

            if (!jobs[jobId]) return;

            let data = jobs[jobId].req.data;
            let el = e.currentTarget;
            let ids = e.currentTarget.getAttribute('wfId');

            GmCXt.log(33, "Event: mouse up for right click");
            GmCXt.log(27, "Event: mouse up for right click");

            onUserEvent.call(this, e, true, jobId);
        }
    };

    var onMouseUpElement = function(e) {

        GmCXt.log(33, "onMouseUpElement");

        if (GmCXt.clickEventFlag) {
            return;
        } else {
            GmCXt.clickEventFlag = true;
        }

        let jobId = null;

        if (e.data && e.data.he) {
            jobId = e.data.he.getAttribute(gmjobId);
            var ids = e.data.he.getAttribute('wfId');
        } else {
            jobId = e.currentTarget.getAttribute(gmjobId);
            var ids = e.currentTarget.getAttribute('wfId');
        }
        let el = e.currentTarget;
        let job = jobs[jobId];

        if (!job) return;

        let data = job.req.data;

        GmCXt.log(33, "Event: mouse up - " + data.task);
        GmCXt.log(27, "Event: mouse up");

        onUserEvent.call(this, e, true, jobId);
    };

    let onEnterPressNext = function(e) {

        GmCXt.log(33, "onMouseUpElement");
        let jobId = null;

        if (e.data && e.data.he) {
            jobId = e.data.he.getAttribute(gmjobId);
            var ids = e.data.he.getAttribute('wfId');
        } else {
            jobId = e.currentTarget.getAttribute(gmjobId);
            var ids = e.currentTarget.getAttribute('wfId');
        }
        let el = e.currentTarget;
        let job = jobs[jobId];

        if (!job) return;

        let data = job.req.data;

        GmCXt.log(33, "Event: mouse up - " + data.task);
        GmCXt.log(27, "Event: mouse up");

        onUserEvent.call(this, e, true, jobId);
    };

    let onChangeValue = function(he) {
        let jobId = he.getAttribute(gmjobId);

        if (!jobs[jobId]) return;

        let data = jobs[jobId].req.data;

        let ids = he.getAttribute('wfId');

        GmCXt.log(33, "Event: change value for text field");
        GmCXt.log(27, "Event: change value for text field");

        onUserEvent.call(this, null, false, jobId);
    };

    let onChangeElement = function(e) {
        let jobId = e.currentTarget.getAttribute(gmjobId);
        let job = jobs[jobId];

        let ids = e.currentTarget.getAttribute('wfId');

        if (!job) return;

        let data = job.req.data;

        GmCXt.log(33, "Event: change value for radio/checkbox");
        GmCXt.log(27, "Event: change value for radio/checkbox");

        onUserEvent.call(this, e, false, jobId);
    };

    let onMouseOverElement = function(e) {
        let jobId = e.currentTarget.getAttribute(gmjobId);
        let el = e.currentTarget;
        let req;

        let ids = e.currentTarget.getAttribute('wfId');

        if (jobs[jobId]) req = jobs[jobId].req;
        else if (editJob) req = editJob.req;

        GmCXt.log(33, "Event: mouse over");
        GmCXt.log(27, "Event: mouse over");

        if (req && req.data.inlineStepEditRequest === true)
            editStep(e);
        else
            onUserEvent.call(this, e, false, jobId);
    };

    function addNoWatch(he) {
        mg$(he).addClass('mgPlayerJSProd_no-watch');
    }

    function removeNoWatch(he) {
        mg$(he).removeClass('mgPlayerJSProd_no-watch');
    }

    function triggerRightClick(he) {
        GmCXt.log(33, "Event trigger: right-click");
        GmCXt.log(27, "Event trigger: right-click");

        let d = {
            bubbles: true,
            cancelable: false
        };
        let clientRect = GmCXt.getBoundingRect(he);
        if (clientRect) {
            d.clientX = clientRect.x;
            d.clientY = clientRect.y;
        }
        d.button = 2;
        he.dispatchEvent(new MouseEvent('mouseup', d));
    }

    function triggerEnterKey(he) {
        GmCXt.log(33, "Event trigger: Enter key");
        GmCXt.log(27, "Event trigger: Enter key");

        let e = mg$.Event("keypress");
        e.which = 13;
        e.keyCode = 13;
        mg$(he).trigger(e);
    }

    function triggerKeyUp(he) {
        GmCXt.log(33, "Event trigger: keyup");
        GmCXt.log(27, "Event trigger: keyup");

        //entering a random char "A" to trigger next step
        let d = {
            bubbles: true,
            cancelable: false,
            keyCode: 65
        };
        he.dispatchEvent(new KeyboardEvent('keyup', d));
    }

    function triggerAllEvent(he) {
        let d = {
            bubbles: false,
            cancelable: true
        };

        he.dispatchEvent(new Event('keydown', d));
        he.dispatchEvent(new Event('keyup', d));
        he.dispatchEvent(new Event('textInput', d));
        he.dispatchEvent(new Event('input', d));
        he.dispatchEvent(new Event('change', d));
        he.dispatchEvent(new KeyboardEvent('keydown', d));
        he.dispatchEvent(new KeyboardEvent('keyup', d));
        he.dispatchEvent(new KeyboardEvent('textInput', d));
        he.dispatchEvent(new KeyboardEvent('input', d));
    }

    function triggerChange(he) {
        GmCXt.log(33, "Event trigger: change");
        GmCXt.log(27, "Event trigger: change");

        let d = {
            bubbles: true,
            cancelable: false
        };
        he.dispatchEvent(new Event('change', d));
    }

    function checkElToContinue(he, stepSettings) {
        let continueNext = false;

        if (stepSettings.elDetails) {

            let hasClass = false;
            let hasAttr = false;

            if (stepSettings.elDetails === "classes" && GmCXt.isDefined(stepSettings.classVal)) {

                //check if he has the class
                let classArray = stepSettings.classVal.split(',');

                classArray.forEach(function(c) {
                    if (mg$(he).hasClass(c)) {
                        hasClass = true;
                    }
                });
            } else if (stepSettings.elDetails === "attributes" && GmCXt.isDefined(stepSettings.attrVal)) {

                let attrArray = stepSettings.attrVal.split(',');

                attrArray.forEach(function(a) {
                    if (he.hasAttribute(a)) {
                        hasAttr = true;
                    }
                });
            }

            if (hasClass || hasAttr) {
                continueNext = true;
            }

        } else {
            continueNext = true;
        }

        return continueNext;
    }

    function triggerNextBtnClick(he, req) {
        GmCXt.log(33, "Event trigger: Next Button");

        if (window.self === window.top) {
            let currentStep = GmCXt.getCurrentStep(GmCXt.playerI.currentStepId);
            if (GmCXt.playerI.testAutomation) {
                // As step preview for automation steps are not shown.
                GmCXt.tourPlayerI.playNextStep();
            } else {

                let continueNext = true;

                if (continueNext) {
                    let nxtBtn = GmCXt.getNextBtnElem();
                    if (nxtBtn) GmCXt.triggerClick(nxtBtn, req);
                }
            }
        } else {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:trigger_next_click');
        }
    }

    function getTextEl(he, type) {
        let elem = null;
        let elems = null;

        if (type === 'input') {
            elems = mg$(he).find('input:not([type=image],[type=button],[type=submit],[type=radio],[type=checkbox])');
        } else if (type === 'textarea') {
            elems = mg$(he).find('textarea');
        } else if (type === 'textbox') {
            elems = mg$(he).find("div.WIY-[role='textbox'][aria-multiline='false']");
        }

        if (elems.length) {
            for (let i = 0; i < elems.length; i++) {
                if (GmCXt.getElVisibility(mg$(elems)[i]) === 'visible') {
                    elem = mg$(elems)[i];
                    break;
                }
            }
            return elem;
        }
    }

    function getRadioEl(he, val) {
        let elem = null;
        let elems = mg$(he).find("input[type=radio]");
        if (elems.length) {
            for (let i = 0; i < elems.length; i++) {
                if (mg$(elems)[i].value === val) {
                    elem = mg$(elems)[i];
                    break;
                }
            }
            return elem;
        }
    }

    function getSelectEl(he, val) {
        let elem = null;
        let elems = mg$(he).find("option");
        if (elems.length) {
            for (let i = 0; i < elems.length; i++) {
                if (mg$(elems)[i].value === val.value) {
                    elem = mg$(elems)[i];
                    break;
                }
            }
            return elem;
        }
    }

    function getcheckboxEl(he, val) {
        let elem = null;
        let elems = mg$(he).find("input[type=checkbox]");
        if (elems.length) {
            for (let i = 0; i < elems.length; i++) {
                elem = mg$(elems)[i];

                if (val && val.toLowerCase().indexOf(elem.value.toLowerCase()) !== -1) {
                    mg$(elem).prop("checked", true);
                } else {
                    mg$(elem).prop("checked", false);
                }
            }
            return true;
        }
    }

    function readFromCsv(auto, data) {

        let val = null;
        let list = data.csvData || null;
        let rowNo = (data.currentLoop + 1) || null;
        let column = auto.csvParam;

        if (list && rowNo && list[rowNo])
            val = list[rowNo][column];

        return val;
    }

    function getDefaultValue(auto, data) {
        if (auto && auto.enableDefaultData) {
            if (auto.inputType && auto.inputType === 'csv') {

                GmCXt.log(33, 'Reading CSV data', 1);
                let val = readFromCsv(auto, data);

                GmCXt.log(33, 'Value from CSV:  ' + val, 1);
                return val;
            } else {
                return auto.defaultData;
            }
        }
    }

    function enterDefaultValue(he, enabled, val, data) {

        if (enabled) {

            GmCXt.log(33, 'Value entered: ' + val);

            let tag = mg$(he)[0].tagName.toLowerCase();


            if (tag === 'input' || tag === 'textarea') {

                enterValue(data, he, val);

            } else if (tag === 'select') {
                let selectE1 = getSelectEl(he, val);
                if (selectE1) {
                    mg$(selectE1).prop("selected", true);
                }

            } else {
                let el = getTextEl(he, 'input') || getTextEl(he, 'textarea');
                if (el) {
                    enterValue(data, el, val);
                    return;
                }

                let radioEl = getRadioEl(he, val);
                if (radioEl) {
                    mg$(radioEl).prop("checked", true);
                    return;
                }

                let checkboxEl = getcheckboxEl(he, val);
                if (checkboxEl) return;

                he.innerHTML = val;
            }
        }
    }

    function enterValue(data, he, val) {

        GmCXt.timeout(function() {

            mg$(he).val(val);

            let s = data.settings;

            // Use the default value and trigger keyup events while guide automation, instead of waiting for the user.
            // Only keyup event here will cause issues on insights portal forms.
            if (data.testAutomation) {
                triggerAllEvent(he);
            } else if (!s.automation.hasHumanInteraction) {
                triggerAllEvent(he);
            }

            if (GmCXt.checkSalesForceSite()) {
                triggerSearch(he);
            }
        }, 1000);
    }

    function triggerSearch(he) {
        if (he.type === 'search') {
            GmCXt.log(33, "Event trigger: search");
            let d = {
                bubbles: true,
                cancelable: false
            };
            he.dispatchEvent(new Event('search', d));
        }
    }

    function getFormOldValue(he, v) {
        let oldBulLength = mg$(he).find('li').length;
        let newBulLength = mg$(v).find('li').length;

        if (oldBulLength !== newBulLength) {
            return mg$(he).html();
        }
    }

    function bindSmartipHtml(he, opt, rd, jobId) {
        let value = opt.htmlContent;
        let isFormInjector = opt.formInjector;
        let isPreview = rd.isPreview;
        let tag = mg$(he)[0].tagName.toLowerCase();

        if (isFormInjector) {
            mg$(he).off('click focus keyup').on('click focus keyup', function() {

                let step = rd.step;
                let tourId = rd.step.tour_id;
                mg$(he).addClass(getGuidenceMessageElmClass(step.step_id, tourId));

                if (!disableFocus) {
                    showPowerForm(he, jobId, step, rd.isPreview);
                }
            });
        } else {
            insertPowerHtml(he, tag, value);
        }

        if (isPreview) mg$(he).addClass('mgPlayerJSProd_preview-smarttip-pwr-html');

        if (!isPreview) {
            GmCXt.updateOnScreenTooltipGuideInfo(rd.tour, rd.tour.tour_id, rd.step.step_id, true, opt, GmCXt.urlParts.fullUrl);
        }
    }

    function copyToClipboad(he) {
        try {
            navigator.clipboard.writeText(he.innerText);
            GmCXt.log(33, 'Text copied to clipboard');
        } catch (err) {
            console.error('Failed to copy: ', err);
        }
        mg$(he).trigger("copy");
    }

    function pasteFromClipBoard(he) {
        he.focus();
        navigator.clipboard.readText()
            .then(function(text) {
                if (typeof he.value === 'string') {
                    he.value = text;
                } else {
                    he.innerText = text;
                }
                triggerKeyUp(he);
            })
            .catch(function(err) {
                console.log('Something went wrong', err);
            });
    }

    function enterBotInput(he, botInfo, data) {
        let inputs = botInfo.split('_'); // ['name', 'type'] type can be USERNAME or PASSWORD
        let bot_title = inputs[0].toLowerCase().trim();
        let key = inputs[1].toLowerCase();
        let val = '';
        if (data && data.botUsers) {
            let users = data.botUsers;
            let len = data.botUsers.length;
            for (let i = 0; i < len; i++) {
                if (users[i].bot_title.toLowerCase().trim() === bot_title) {
                    val = users[i]["bot_" + key];
                    break;
                }
            }
            enterValue(data, he, val);
        }
    }

    function removeElement(he) {
        GmCXt.log(33, "Removing Element");
        // This option is present only in automation step so it will not effect the guide
        he.remove();
        GmCXt.tourPlayerI.playNextStep();
    }

    function triggerEvents(req, he) {
        let s = req.data.settings;
        let autoProceedStep = GmCXt.getStepSettings().autoProceedStep;
        let auto = s.automation;

        if (!GmCXt.playerI) {
            return;
        }

        let nextStep = GmCXt.getNextStep();
        let val = getDefaultValue(auto, req.data);

        if (auto.inputType !== 'filePath') {
            setTimeout(function() {
                enterDefaultValue(he, auto.enableDefaultData, val, req.data);
            }, 500);
        }

        if (auto.getfromBot && auto.botUserInput) {
            enterBotInput(he, auto.botUserInput, req.data);
        }

        if (s.stepType === GmCXt.STEP_TYPE_EXTERNAL_AUTOMATION) {
            // Electron app should trigger events instead.
            return;
        }

        if (window.self === window.top) {
            GmCXt.rotateGear();
        } else {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:rotate_gear');
        }

        if (s.headerNext && GmCXt.isAutomationStep(nextStep) && GmCXt.playerI) {
            GmCXt.tourPlayerI.playNextStep();
            return;
        }

        let tm = 3000;

        if (GmCXt.deskReq && GmCXt.deskReq.isAutomatorExists) {
            tm = 3000;
        } else if (GmCXt.playerI.automate) {
            tm = 5000;
            if (s.automation.manualAutoTimer) {
                tm = s.automation.afterXSeconds * 1000;
            } else if (autoProceedStep) {
                tm = GmCXt.getStepSettings().autoStepDelay * 1000;
            }
            if (tm < 1000) {
                tm = 600;
            }
        }

        if (GmCXt.playerI.source === "bot") {
            tm = 1000;
        }

        if (GmCXt.playerI.keyShorts === true) {
            tm = 1000;
        }

        GmCXt.autoTrigger = GmCXt.timeout(function() {

            if (GmCXt.playerI && !GmCXt.playerI.pauseAutomate) {
                if (s.clickNext || s.onClickTooltip) {
                    GmCXt.triggerClick(he, req);
                } else if (s.onRightClickNext) {
                    triggerRightClick(he);
                } else if (s.onEnterPressNext) {
                    triggerEnterKey(he);
                } else if (s.onKeyupNext) {
                    if (auto.getFromClipboard) {
                        pasteFromClipBoard(he);
                    } else {
                        triggerKeyUp(he);
                    }
                } else if (s.onCopyNext) {
                    copyToClipboad(he);
                } else if (s.keepNext) {
                    triggerNextBtnClick(he, req);
                } else if (s.onClickAnywhere) {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_next_step');
                } else if (s.onPageClickNext === true && (GmCXt.playerI.testAutomation || !auto.hasHumanInteraction)) {
                    GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_next_step');
                } else if (s.removeElement) {
                    removeElement(he);
                }
            }
        }, tm);
    }

    function bindNewEvents(req, resp) {
        let reqData = req.data;
        let setting = reqData.settings;
        let humanInteraction = setting.automation.hasHumanInteraction;

        if (reqData.stepType === GmCXt.STEP_TYPE_MESSAGE && setting.completionEvent !== 'clickNext') {
            setting.clickNext = false;
        }

        let he = resp.he;
        if (setting.clickNext === true || setting.onClickTooltip === true) {
            GmCXt.clickEventFlag = false;
            mg$(he).on("mousedown touchstart", onMouseUpElement);
            mg$(he).on("mouseup touchend", onMouseUpElement);
            mg$(he).on("click", onMouseUpElement);
        } else if (setting.onRightClickNext === true) {
            mg$(he).on("mouseup", onMouseUpRightClickElement);

        } else if (setting.hoverNext === true) {
            mg$(he).one("mouseover", onMouseOverElement);

        } else if (setting.onChangeNext === true) {

            clearInterval(onChangeNextInterval);

            let checkRadioInput = mg$(mg$(he)[0]).find("input[type=radio]").length;
            let checkCheckboxInput = mg$(mg$(he)[0]).find("input[type=checkbox]").length;
            let tagName = mg$(he)[0].tagName.toLowerCase();

            if (resp.de.hasOwnProperty('customSettings')) {
                var s = resp.de.customSettings.salesforce;
                var wd = resp.de.customSettings.workday;
            }

            if (s && s.globalSearch) {
                let url = GmCXt.getUrl();
                watchUrlChange(resp, url);

            } else if (s && s.customInput) {
                watchOnChange(resp, he, null, humanInteraction);

            } else if (wd && (wd.isWDCustomSelect || wd.isSelectBox || he.getAttribute('data-automation-id') === 'selectWidget')) {
                let prop = '';
                if (wd.isWDCustomSelect) {
                    if (he.tagName === 'INPUT') {
                        he = mg$(he).parent().parent()[0];
                    }
                } else if (wd.isSelectBox || he.getAttribute('data-automation-id') === 'selectWidget') {
                    he = mg$(he).find("div.gwt-Label[data-automation-id='selectSelectedOption']")[0];
                    if (he) {
                        prop = "innerHTML";
                    }
                }
                watchOnChange(resp, he, prop, humanInteraction);

            } else if (tagName === 'input' || tagName === 'textarea' || tagName === 'select') {
                watchOnChange(resp, resp.he, 'value', humanInteraction);

            } else if (checkRadioInput || checkCheckboxInput) {

                mg$(he).off("change")
                    .on("change", function(e) {
                        onChangeElement(e);
                    });
            } else {
                findInputElem(resp, humanInteraction);
            }

        } else if (setting.onKeyupNext === true) {
            mg$(he).off("keyup paste", onKeyupElementNew).on("keyup paste", function(e) {
                if (e.keyCode !== 16) {
                    onKeyupElementNew(e, req.data.task, setting.typingCompletionTime);
                }
            });
        } else if (setting.onCopyNext) {
            mg$(he).bind('copy', onCopyText);

        } else if (setting.onEnterPressNext) {
            mg$(he).off("keypress", onEnterPressNext).on("keypress", function(e) {
                if (e.keyCode === 13) {
                    onEnterPressNext(e);
                }
            });
        }

        if (req.data.task === "workFlowTour") {
            GmCXt.log(27, "EVENT ADDED:" + GmCXt.stepLog(req.data.requestId, req.data.tourId));
        }
    }

    function findInputElem(resp, humanInteraction) {

        let el = getTextEl(resp.he, 'input') || getTextEl(resp.he, 'textarea');

        if (el) {
            watchOnChange(resp, el, 'value', humanInteraction);
        } else {
            if (GmCXt.checkWorkdaySite()) {
                el = getTextEl(resp.he, 'textbox');
            }

            if (el) {
                watchOnChange(resp, el, 'innerHTML', humanInteraction);
            } else
                watchOnChange(resp, resp.he, 'innerHTML', humanInteraction);
        }
    }

    function watchUrlChange(resp, initialUrl) {
        onChangeNextInterval = setInterval(function() {
            if (!GmCXt.playerI) {
                clearInterval(onChangeNextInterval);
            }
            let url = GmCXt.getUrl();

            if (initialUrl !== url && (url.includes('/view'))) {
                clearInterval(onChangeNextInterval);
                onChangeValue(resp.he);
            }
        }, 1000);
    }

    function watchOnChange(resp, elem, prop, humanInteraction) {
        if (GmCXt.playerI) {
            // Do not wait for user to change the value on the input 
            // during automation runs if there is an automation step next
            let nextStep = GmCXt.getNextStep();
            if (GmCXt.isAutomationStep(nextStep) &&
				(GmCXt.playerI.testAutomation || GmCXt.playerI.initiator === 'doitforme')) {
                GmCXt.timeout(function() {
                    onChangeValue(resp.he);
                }, 2000);
                return;
            }
        }

        let newValue = null;
        let cs = resp.de.customSettings;

        function clearIntervalAndProceed() {
            if (newValue && newValue !== initialValue) {
                clearInterval(onChangeNextInterval);
                onChangeValue(resp.he);
            }
        }

        function getElVal() {

            let val = null;

            if (prop) {

                if (prop === 'innerHTML') val = mg$(elem)[0].innerHTML;
                if (prop === 'value') val = mg$(elem)[0].value;

            } else if (cs) {

                if (!GmCXt.isEmpty(cs.salesforce) && cs.salesforce.customInput) { // Salesforce custom

                    val = mg$(elem).parent().find("span.pillText").text() || mg$(elem).find('span.slds-pill__label').text();

                } else if (!GmCXt.isEmpty(cs.workday) && cs.workday.isWDCustomSelect) { // Workday custom

                    val = mg$(elem).find("p").text();
                }
            }

            return val;
        }

        function watchChangeEve() {

            clearInterval(onChangeNextInterval);

            onChangeNextInterval = setInterval(function() {

                if (!GmCXt.playerI) {
                    clearInterval(onChangeNextInterval);
                    return;
                }
                newValue = getElVal();
                clearIntervalAndProceed();
            }, 1000);
        }

        if (GmCXt.playerI && (GmCXt.playerI.testAutomation || (GmCXt.playerI.automate && !humanInteraction))) {
            initialValue = getElVal();
            watchChangeEve();
        } else {
            mg$(resp.he.parentNode).one('click', function() {
                initialValue = getElVal();
                watchChangeEve();
            });
        }
    }

    function bindLegacyEvents(req, resp) {

        // TODO: Need to discuss with Nilesh P, This is incorrect code.

        let inputField = (
            elem.tagName.toLowerCase() === 'input' &&
				elem.type !== 'button' &&
				elem.type !== 'submit'
        ) ||
			elem.tagName.toLowerCase() === 'textarea';

        let selectField = elem.tagName.toLowerCase() === 'select';
        let setting = req.data.settings;

        if (!(inputField || selectField) &&
			(setting.keepNext === 0 || setting.keepNext === false)
        ) {

            mg$(resp.he).one("mouseup", onMouseUpElement);
        }

        if (inputField && setting.mandatoryStep === true) {
            mg$(resp.he).one("keyup", onKeyupElement);
        }

        if (selectField && setting.mandatoryStep === true) {
            mg$(resp.he).one("change", onChangeElement);
        }

        if (!(inputField || selectField) && setting.hoverNext === true) {
            mg$(resp.he).one("mouseover", onMouseOverElement);
        }
    }

    function addBlackoutOverlay(req, resp) {

        let data = req.data.settings;

        if (data && mg$.isArray(data.blackoutElements)) {
            let list = data.blackoutElements;
            for (let j = 0; j < list.length; j++) {
                let rect = list[j];
                mg$('<wmgPlayerJSProd_ class="mgPlayerJSProd_selector-blackout ' + req.data.requestId + '"></wmgPlayerJSProd_>')
                    .appendTo('body')
                    .css({
                        'width': rect.width,
                        'height': rect.height,
                        'left': rect.left,
                        'top': rect.top
                    });
            }
        }
    }

    function getBeaconLeftTop(pos, beaconSettings, beaconIcon) {
        let alignment = beaconSettings.beaconPosition;
        let stickTargetElement = beaconSettings.stickTargetElement;
        let parentPos = beaconSettings.parentPos;
        let stickTargetEl = beaconSettings.stickTargetElement;

        let beaconLeft = 0,
            beaconTop = 0;

        switch (alignment) {

        case 'top-left':
            if (stickTargetEl) {
                beaconLeft = (parentPos.left - pos.left) + beaconIcon.width;
                beaconTop = (parentPos.top - pos.top) - beaconIcon.height - 5;
            } else {
                beaconLeft = pos.left + beaconIcon.width;
                beaconTop = pos.top - beaconIcon.height - 5;
            }
            break;

        case 'top-middle':
            if (stickTargetEl) {
                beaconLeft = ((parentPos.left - pos.left) + pos.width / 2) - beaconIcon.width / 2;
                beaconTop = (parentPos.top - pos.top) - beaconIcon.height - 5;
            } else {
                beaconLeft = (pos.left + pos.width / 2) - beaconIcon.width / 2;
                beaconTop = pos.top - beaconIcon.height - 5;
            }
            break;

        case 'top-right':
            if (stickTargetEl) {
                beaconLeft = (parentPos.left - pos.left) + pos.width - beaconIcon.width;
                beaconTop = (parentPos.top - pos.top) - beaconIcon.height - 5;
            } else {
                beaconLeft = pos.left + pos.width - beaconIcon.width;
                beaconTop = pos.top - beaconIcon.height - 5;
            }
            break;

        case 'right-top':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) + pos.width;
                beaconTop = (parentPos.top - pos.top);
            } else {
                beaconLeft = pos.left + pos.width;
                beaconTop = pos.top;
            }
            break;

        case 'right-middle':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) + pos.width;
                beaconTop = ((parentPos.top - pos.top) + pos.height / 2) - (beaconIcon.height / 2);
            } else {
                beaconLeft = pos.left + pos.width;
                beaconTop = (pos.top + pos.height / 2) - (beaconIcon.height / 2);
            }
            break;

        case 'right-bottom':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) + pos.width;
                beaconTop = ((parentPos.top - pos.top) + pos.height) - beaconIcon.height;
            } else {
                beaconLeft = pos.left + pos.width;
                beaconTop = (pos.top + pos.height) - beaconIcon.height;
            }
            break;

        case 'left-top':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) - beaconIcon.width - 5;
                beaconTop = (parentPos.top - pos.top);
            } else {
                beaconLeft = pos.left - beaconIcon.width - 5;
                beaconTop = pos.top;
            }
            break;

        case 'left-middle':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) - beaconIcon.width - 5;
                beaconTop = ((parentPos.top - pos.top) + (pos.height / 2)) - (beaconIcon.height / 2);
            } else {
                beaconLeft = pos.left - beaconIcon.width - 5;
                beaconTop = (pos.top + (pos.height / 2)) - (beaconIcon.height / 2);
            }
            break;

        case 'left-bottom':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) - beaconIcon.width - 5;
                beaconTop = (parentPos.top - pos.top) + pos.height - beaconIcon.height;
            } else {
                beaconLeft = pos.left - beaconIcon.width - 5;
                beaconTop = pos.top + pos.height - beaconIcon.height;
            }
            break;

        case 'bottom-left':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left);
                beaconTop = (parentPos.top - pos.top) + pos.height + 5;
            } else {
                beaconLeft = pos.left;
                beaconTop = pos.top + pos.height + 5;
            }
            break;

        case 'bottom-middle':
            if (stickTargetEl) {
                beaconLeft = ((pos.left - parentPos.left) + pos.width / 2) - beaconIcon.width / 2;
                beaconTop = (parentPos.top - pos.top) + pos.height + 5;
            } else {
                beaconLeft = (pos.left + pos.width / 2) - beaconIcon.width / 2;
                beaconTop = pos.top + pos.height + 5;
            }
            break;

        case 'bottom-right':
            if (stickTargetEl) {
                beaconLeft = (pos.left - parentPos.left) + pos.width - beaconIcon.width;
                beaconTop = (parentPos.top - pos.top) + pos.height + 5;
            } else {
                beaconLeft = pos.left + pos.width - beaconIcon.width;
                beaconTop = pos.top + pos.height + 5;
            }
            break;

        case 'custom':

            beaconLeft = pos.left;
            beaconTop = pos.top;
            break;
            //backward Compatibility
        case 'top_left':
            if (stickTargetEl) {
                beaconLeft = pos.left - parentPos.left;
                beaconTop = parentPos.top - pos.top;
            } else {
                beaconLeft = pos.left;
                beaconTop = pos.top;
            }
            break;

        case 'top_right':
            if (stickTargetEl) {
                beaconLeft = pos.left - parentPos.left + pos.width - beaconIcon.width;
                beaconTop = parentPos.top - pos.top;
            } else {
                beaconLeft = pos.left + pos.width - beaconIcon.width;
                beaconTop = pos.top;
            }
            break;

        case 'center':
            if (stickTargetEl) {
                beaconLeft = pos.left - parentPos.left + (pos.width / 2);
                beaconTop = parentPos.top - pos.top + (pos.height / 2);
            } else {
                beaconLeft = pos.left + (pos.width / 2);
                beaconTop = pos.top + (pos.height / 2);
            }
            if (beaconLeft > 6) {
                beaconLeft = beaconLeft - 6;
            }
            if (beaconTop > 6) {
                beaconTop = beaconTop - 6;
            }
            break;

        case 'bottom_left':
            if (stickTargetEl) {
                beaconLeft = pos.left - parentPos.lef;
                beaconTop = parentPos.top - pos.top + pos.height - beaconIcon.height;
            } else {
                beaconLeft = pos.left;
                beaconTop = pos.top + pos.height - beaconIcon.height;
            }
            break;

        case 'bottom_right':
            if (stickTargetEl) {
                beaconLeft = parentPos.left - pos.left + pos.width - beaconIcon.width;
                beaconTop = parentPos.top - pos.top + pos.height - beaconIcon.height;
            } else {
                beaconLeft = pos.left + pos.width - beaconIcon.width;
                beaconTop = pos.top + pos.height - beaconIcon.height;
            }
            break;
        }

        return {
            left: beaconLeft,
            top: beaconTop
        };
    }

    function removeBeacon(jobId, rd, beaconImg, tourTitle, tourId) {
        GmCXt.log(48, "REMOVED beacon [" + tourId || tourTitle + "]");
        mg$(beaconImg).remove();
        let m = {
            action: "mgPlayerJSProd_action:toggle_beacon_visibility",
            remove: true,
            tourId: tourId || rd.tourId
        };
        GmCXt.sendToParentWindow(m);

        if (!rd || !rd.isPreview) {
            GmCXt.updateBeaconsOnScreen(jobId.slice(1), false);
        }

        deleteJob(jobId);
    }

    function watchBeaconJob(jobId) {

        let job = jobs[jobId];

        if (!job) return;

        let resp = job.resp;
        let he = resp.he;
        let pos = resp.elemPos;
        let rd = job.req.data;
        let tourTitle = rd.tourTitle;
        let beaconImg = mg$(".mgPlayerJSProd_beacon-icon.mgPlayerJSProd_beacon-icon-tour-" + rd.tourId);
        let rect = GmCXt.getBoundingRect(he);

        if (!rect) {
            removeBeacon(jobId, rd, beaconImg, tourTitle);
            return;
        }

        let visibility = GmCXt.getElVisibility(he);

        if (rect.width === 0 && rect.height === 0) visibility = 'hidden';
        let m = {
            action: "mgPlayerJSProd_action:toggle_beacon_visibility",
            show: true,
            tourId: rd.tourId
        };

        if (visibility === 'hidden') {
            m.show = false;

            if (job.elVisible !== "hidden" && !rd.beaconSettings.stickTargetElement) {
                GmCXt.sendToParentWindow(m);
            }
            job.elVisible = 'hidden';
            // If element is removed from DOM 
            // rect.width && rect.height will always be 0 if element get removed from webpage and get recreate by javascript 
            // So removing watch job, new job will initiated on page click. 
            if (!he.parentNode || (rect.width === 0 && rect.height === 0)) {
                removeBeacon(jobId, rd, beaconImg, tourTitle);
                return;
            }

        } else {
            if (job.elVisible !== "visible" && !rd.beaconSettings.stickTargetElement) {
                GmCXt.sendToParentWindow(m);
            }
            job.elVisible = 'visible';
            if (pos && (pos.top !== rect.top || pos.left !== rect.left || pos.height !== rect.height || pos.width !== rect.width) && !rd.beaconSettings.stickTargetElement) {
                GmCXt.log(48, "POS CHANGE beacon [" + tourTitle + "]", pos);

                setBeaconPosition(jobId);
            }
        }
    }

    function setBeaconPosition(jobId) {

        let job = jobs[jobId];
        if (!job) return;

        let resp = job.resp;
        let he = resp.he;
        let pos = he.getBoundingClientRect();
        let requestData = job.req.data;

        let customPos = requestData.beaconSettings.customPosition;

        if (requestData.beaconSettings.stickTargetElement) {
            let parentEl = mg$(he).parent()[0];
            let parentPos = parentEl.getBoundingClientRect();
            requestData.beaconSettings.parentPos = parentPos;
        }

        let obj = getBeaconLeftTop(pos, requestData.beaconSettings, customPos);
        let beaconLeft = obj.left;
        let beaconTop = obj.top;

        let isPositionFixed = GmCXt.dom.getElementFixedPosition(he);

        let css_ = {
            left: beaconLeft,
            top: beaconTop
        };

        if (requestData.beaconSettings.beaconPosition === 'custom') {

            let left = customPos.left;
            let top = customPos.top;

            if (customPos.left_pos === "%") {
                left = ((pos.width * customPos.left) / 100) - (requestData.beaconSettings.customPosition.width / 2);
            }

            if (customPos.top_pos === "%") {
                top = ((pos.height * customPos.top) / 100) - (requestData.beaconSettings.customPosition.height / 2);
            }

            css_ = {
                left: beaconLeft + parseInt(left),
                top: beaconTop + parseInt(top)
            };
        }

        if (customPos) {
            css_.width = parseInt(customPos.width);
            css_.height = parseInt(customPos.height);
        } else {
            css_.width = 20;
            css_.height = 20;
        }

        if (!GmCXt.isEmpty(requestData.beaconSettings.zIndex)) {
            css_.zIndex = requestData.beaconSettings.zIndex;
        } else {
            let zIndex = GmCXt.dom.getElementZindex(he);
            if (zIndex) css_.zIndex = zIndex;
        }


        if (requestData.beaconSettings.stickTargetElement) {
            mg$(he).parent().addClass('mgPlayerJSProd_relative-position');
        }

        css_.position = 'absolute';

        if (isPositionFixed && !requestData.beaconSettings.stickTargetElement) {
            css_.position = 'fixed';
        }

        if (GmCXt.getElVisibility(he) === 'hidden' && !requestData.beaconSettings.stickTargetElement) {
            css_.display = 'none';
        }

        let align = getBeaconTitleAlignment(he, requestData.beaconSettings.beaconPosition);

        if (requestData.beaconSettings.stickTargetElement) {
            addBeaconHtml(jobId, css_, align);
        } else {
            let m = {
                action: "mgPlayerJSProd_action:show_beacon",
                jobId: jobId,
                requestData: requestData,
                isPreview: requestData.isPreview,
                tour: requestData.tour,
                tourId: requestData.tourId,
                tourTitle: requestData.tourTitle,
                userKey: requestData.userKey,
                beaconIcon: requestData.beaconSettings.beaconIcon,
                css_: css_,
                align: align,
                reqId: GmCXt.id,
                isPositionFixed
            };

            GmCXt.sendToParentWindow(m);
        }

        job.resp.elemPos = pos;
    }

    function addBeaconHtml(jobId, css_, align) {
        let job = jobs[jobId];
        let requestData = job.req.data;
        let settings = requestData.beaconSettings;
        let beaconObj = mg$("#mgPlayerJSProd_beacon-icon-" + requestData.tourId);
        let he = job.resp.he;

        if (beaconObj.length) {
            beaconObj.css(css_);

            if (requestData.isPreview) {
                GmCXt.previewBeacons(requestData.tourId);
            }
        } else {
            let beaconIcon = settings.beaconIcon;
            let beaconImgUrl = beaconIcon;

            if (beaconImgUrl.indexOf('default_beacon') === -1) {
                beaconImgUrl = GmCXt.restoreAssetSrc(beaconIcon);
            } else {
                beaconImgUrl = GmCXt.conf.staticContentPath + "default_beacon.png";
            }

            let beaconClass = "mgPlayerJSProd_beacon-icon mgPlayerJSProd_beacon-icon-tour-" + requestData.tourId;
            if (GmCXt.beaconsAreHidden && !requestData.isPreview) {
                beaconClass += " mgPlayerJSProd_hidden";
            }

            if (requestData.isPreview) beaconClass += " mgPlayerJSProd_preview-beacon";

            let titleAlign = align;
            if (requestData.beaconSettings.beaconMsgPosition) {
                titleAlign = requestData.beaconSettings.beaconMsgPosition;
            }

            let t = GmCXt.escapeHtml(requestData.tourTitle);
            let c = GmCXt.singleLineTitle(t);

            let html_ = "<wmgPlayerJSProd_ id='mgPlayerJSProd_beacon-icon-" + requestData.tourId +
				"' class='" + beaconClass + "'>" +
				"   <img src='" + beaconImgUrl + "' class='mgPlayerJSProd_custom-image' />" +
				"   <wmgPlayerJSProd_ class='mgPlayerJSProd_tour-title-on-beacon " + c + " mgPlayerJSProd_tour-title-on-beacon-" +
				titleAlign + "'>" +
				t +
				"</wmgPlayerJSProd_>" +
				"</wmgPlayerJSProd_>";
            let m = {
                tour: requestData.tour,
                action: 'mgPlayerJSProd_action:track_beacon_feature'
            };

            mg$(html_)
                .css(css_)
                .insertAfter(he)
                .on('click', function() {
                    if (!requestData.isPreview) {
                        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:play_tour;event:beacon_click', {
                            tourId: requestData.tourId,
                            userKey: requestData.userKey
                        });

                        m.eventType = 'click';
                        GmCXt.sendToParentWindow(m);
                    }
                })
                .on('mouseover', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex, true); // passing true for incrementing z-index
                    if (!m.isPreview) {
                        m.eventType = 'hover';
                        GmCXt.sendToParentWindow(m);
                    }
                })
                .on('mouseout', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex);
                });

            if (!requestData.isPreview) {
                GmCXt.updateBeaconsOnScreen(jobId.slice(1), true);
                m.eventType = 'display';
                GmCXt.sendToParentWindow(m);
            }
        }
    }

    function getBeaconTitleAlignment(he, align) {

        let spaceToLeft = mg$(he).offset().left;
        let spaceToRight = mg$(window).width() - (mg$(he).offset().left + mg$(he).outerWidth());
        let spaceOnTop = mg$(he).offset().top;
        let spaceAtBottom = mg$(window).height() - (mg$(he).offset().top + mg$(he).outerHeight());
        let msgBoxWidth = 238;
        let msgBoxHeight = 70;

        switch (align) {
        case "top_left":
            if ((spaceToLeft - msgBoxWidth) < 0) {
                align = "right";
            }
            break;
        case "top_right":
            if ((spaceToRight - msgBoxWidth) < 0) {
                align = "left";
            }
            break;
        case "bottom_left":
            if ((spaceOnTop - msgBoxHeight) < 0) {
                align = "bottom";
            }
            break;
        case "bottom_right":
            if ((spaceAtBottom - msgBoxHeight) < 0) {
                align = "top";
            }
            break;
        case "custom":
            if ((spaceToRight - msgBoxWidth) < 0) {
                align = "left";
            }
            if ((spaceToLeft - msgBoxWidth) < 0) {
                align = "right";
            }
            break;
        case "center":
            if ((spaceToRight - msgBoxWidth) < 0) {
                align = "left";
            }
            if ((spaceToLeft - msgBoxWidth) < 0) {
                align = "right";
            }
            break;
        default:
            align = "center";
            break;
        }
        return align;
    }

    function removePrevTooltip(he, jobId, rd, step) {
        if (he.classList.length) {
            let prevJobId = null;
            let prevStepId = null;
            let prevTourId = null;

            for (var i = 0; i < he.classList.length; i++) {
                var className = he.classList[i];
                if (className.startsWith('mg-smarttip-')) {
                    prevStepId = className.replace(/[^\d.]/g, '');
                    prevJobId = '_' + prevStepId;
                    break;
                }
            }

            for (var i = 0; i < he.classList.length; i++) {
                var className = he.classList[i];

                if (className.startsWith(getGuidenceClsPrefix())) {

                    let c = className.split('-');

                    if (c[4] !== step.step_id) {
                        prevStepId = c[4];
                        prevTourId = c[5];
                        prevJobId = '_' + prevStepId;
                        break;
                    }
                }
            }

            if (prevJobId && prevJobId !== jobId) {

                let tooltip = mg$(".mgPlayerJSProd_smarttip-icon-wrapper-" + prevStepId);
                let validationMessage = mg$("#mgPlayerJSProd_smarttip-valid-" + prevStepId);
                let ductTapeTooltip = mg$("#mgPlayerJSProd_smarttip-" + prevStepId);

                mg$(he).off('mouseover focus blur click');

                if (rd.settings.smartTip && rd.settings.smartTip.type === 'guidence') {
                    if (tooltip) mg$(tooltip).remove();
                }

                if (rd.settings.smartTip && rd.settings.smartTip.type === 'validation') {
                    if (validationMessage) mg$(validationMessage).remove();
                }

                if (!rd.isPreview) {

                    if (prevTourId) {
                        mg$('.mgPlayerJSProd_guidence-message-' + prevTourId).remove();
                        mg$(he).removeClass(getGuidenceMessageElmClass(prevStepId, prevTourId));

                        GmCXt.log(42, "REMOVED PREV: " + GmCXt.stepLog(prevStepId, prevTourId));
                        GmCXt.updateOnScreenTooltipGuideInfo(rd.tour, prevTourId, prevStepId, false, rd.settings.smartTip);
                    }
                }

                if (rd.settings.smartTip && rd.settings.smartTip.type === 'disableElement') {
                    if (ductTapeTooltip) mg$(ductTapeTooltip).remove();
                }

                deleteJob(prevJobId);

                removeNoWatch(he);
                mg$(he).removeClass(className);
            }
        }
    }

    function watchSmartTip(jobId) {

        let job = jobs[jobId];
        if (!job) return;

        let rd = job.req.data;

        if (GmCXt.smarttipAreHidden) {

            if (rd.isPreview && GmCXt.APP_PANEL_OPEN) {
                deleteJob(jobId);
                return;
            }

            if (!GmCXt.smartTipPreviewOn) {
                return;
            }

        }

        let he = job.resp.he;
        let de = job.resp.de;
        let step = rd.step;
        let pos = job.resp.elemPos;
        let isPreview = rd.isPreview;
        let smartTip = rd.settings.smartTip;
		
        if (GmCXt.isEmpty(smartTip)) return;

        let type = rd.settings.smartTip.type;
        let isTextChanged = (job.resp.text !== he.textContent) && !de.criteria.ignoreText && type !== 'injector';

		

        let rect = GmCXt.getBoundingRect(he);

        if (job.posChanged === undefined) {
            job.posChanged = false;
        }

        // Find element again,
        // if DOM is refreshed and resp.he instance is cleared 
        if (!rect.top && !rect.left && !rect.width && !rect.height) {
            GmCXt.log(43, "Tooltip dom refreshed Find element again: " + GmCXt.stepLog(step.step_id, step.tour_id));
            let newHe = getDOMElementForRule(de, rd.frame, GmCXt.getStepInfoLog(step));
            if (newHe) {
                he = newHe;
                if (de.criteria.precision_type === GmCXt.DOM_CRITERIA_CUSTOM && de.criteria.precision_level === 'High') {
                    removePrevTooltip(he, jobId, rd, step);
                }
                rect = GmCXt.getBoundingRect(he);
                job.resp.he = he;
                mg$(he).addClass('mg-smarttip-' + jobId);
            }
        }

        let isHidden = !mg$(he).is(":visible") || GmCXt.getElVisibility(he) === 'hidden' || isTextChanged;

        if (mg$(he).hasClass('mgPlayerJSProd_no-watch') && !isHidden) return true;

        if (isHidden && he && de.targetInfo && GmCXt.dom.isWDTextArea(de)) {
            let expandedHe = GmCXt.dom.checkForExpandedTextBox(he, de.meta);
            if (expandedHe) {
                he = expandedHe;
                isHidden = false;
            }
        }

        let tooltip = mg$(".mgPlayerJSProd_smarttip-icon-wrapper-" + step.step_id);
        let validationMessage = mg$("#mgPlayerJSProd_smarttip-" + step.step_id);

        if (!rect) {
            if (!isPreview) {
                if (tooltip) mg$(tooltip).remove();
                if (validationMessage) mg$(validationMessage).remove();
                GmCXt.updateOnScreenTooltipGuideInfo(rd.tour, rd.tour.tour_id, jobId.slice(1), false, smartTip);
            }
            return;
        }

        let ductTape = mg$("." + getDuctTapeClass(step.step_id));

        if (pos && (pos.top !== rect.top || pos.left !== rect.left)) {
            jobs[jobId].resp.elemPos = rect;
            job.posChanged = true;
        }

        if (isHidden) {

            if (job.elVisible !== "hidden") {

                if(step?.step_settings?.smartTip?.type !== 'both' || !isTextChanged){
                    GmCXt.hideTooltip(step);
                }

                if (validationMessage) {
                    GmCXt.hideValidationTooltip(step);
                }
            }
            job.elVisible = "hidden";

            if (ductTape.length) {
                if (smartTip.disableElementType === 'color') {
                    ductTape.removeClass(getDuctTapeClass(job.resp.requestId));
                }
            }

            // If element is removed from DOM then change the state for the job. 
            // Scenario - Element on Popup window
            // rect.width && rect.height will always be 0 if element get removed from webpage and get recreate by javascript 
            // So removing watch job, new job will initiated on page click. 

            if (!he.parentNode || (rect.width === 0 && rect.height === 0) || isTextChanged) {

                if(step?.step_settings?.smartTip?.type !== 'both' || !isTextChanged){
                    if (tooltip) mg$(tooltip).remove();
                }
                
                if (validationMessage) mg$(validationMessage).remove();
                if (!isPreview) GmCXt.updateOnScreenTooltipGuideInfo(rd.tour, rd.tour.tour_id, jobId.slice(1), false, smartTip);

                if (!isPreview) {
                    deleteJob(jobId);
                }

                removeNoWatch(he);
            }

        } else {

            mg$(tooltip).show();
            job.elVisible = "visible";

            if (job.posChanged) {
                job.posChanged = false;
                positionSmartTip(jobId, he, true);
            }

            if (rd.isPreview) GmCXt.previewSmartTips(step.step_id);
        }
    }

    function getDuctTapeOpacity(s) {
        let smartTip = s.step_settings.smartTip;
        let opacity = 1;
        if (smartTip.ductTapeOpacity) {
            opacity = smartTip.ductTapeOpacity / 10;
        } else if (smartTip.ductTapeOpacity === 0) {
            opacity = 0;
        }

        return opacity;
    }

    function getDuctTapeClass(id) {
        return 'mgPlayerJSProd_duct-tape-' + id;
    }

    function addDuctTape(he, opt, w, h, job, rect) {
        if (job) {
            let type = opt.disableElementType;
            let isPreview = job.req.data.isPreview;
            let settings = job.req.data.settings;

            mg$(he).addClass(getDuctTapeClass(job.resp.requestId));

            if (type === 'opacity') {

                if (isPreview)
                    mg$(he).addClass('mgPlayerJSProd_duct-tape-invisible-preview mgPlayerJSProd_duct-tape-smarttip-tour-' + job.req.data.step.tour_id);
                else
                    mg$(he).addClass('mgPlayerJSProd_duct-tape-invisible mgPlayerJSProd_duct-tape-smarttip-tour-' + job.req.data.step.tour_id);

            } else if (type === 'color') {
                if (settings.stickTargetElement) {
                    mg$(he).parent().addClass('mgPlayerJSProd_relative-position');
                    mg$(he).removeClass('mgPlayerJSProd_relative');
                } else {
                    mg$(he).addClass('mgPlayerJSProd_relative');
                    mg$(he).parent().removeClass('mgPlayerJSProd_relative-position');
                }
                positionDuctTape(job, he, opt, w, h, rect);
            } else if (type === 'delete') {
                mg$(he).remove();
            } else if (type === 'replace') {
                let replaceText = job.req.data.step.step_settings.smartTip.replaceTextInput;
                if (he) {
                    if (he.tagName === 'INPUT' && he.type === 'submit' && he.value) {
                        he.value = replaceText;
                    } else if (he.tagName !== 'SELECT') {
                        he.innerText = replaceText;
                    }
                }
            }

            if (!isPreview) {
                GmCXt.updateOnScreenTooltipGuideInfo(job.req.data.tour, job.req.data.tour.tour_id, job.resp.requestId, true, opt, GmCXt.urlParts.fullUrl);
                GmCXt.updateTooltipActionInfo(job.req.data.tour.tour_id, job.req.data.step.step_id, opt, "display");
            }
        }
    }

    function getDuctTapeHtml(job, w, h, opt, posClass) {

        let opacity = getDuctTapeOpacity(job.req.data.step);
        let isPreview = job.req.data.isPreview;
        let d = opt.disableElement || GmCXt.getDiableEleDefaultVal();
        let zIndex = "";
        if (!GmCXt.isEmpty(opt.zIndexVal)) {
            zIndex = opt.zIndexVal;
        }
        let id = 'mgPlayerJSProd_smarttip-' + job.req.data.step.step_id;
        let tourClass = 'mgPlayerJSProd_smarttip-tour-' + job.req.data.step.tour_id;

        let preview = "";
        if (isPreview) preview = "mgPlayerJSProd_preview-smarttip";

        let html = "<wmgPlayerJSProd_ jobid='" + job.id + "' id='" + id + "'" +
			" class='mgPlayerJSProd_duct-tape " + preview + " " + tourClass + " " + posClass + "'" +
			" style='width:" + w + "px;height:" + h + "px;background:" + d.color + ";opacity:" + opacity + ";z-index:" + zIndex + "'>" +
			"</wmgPlayerJSProd_>";

        return html;
    }

    function positionDuctTape(job, he, opt, w, h, rect) {
        if (!job) return;

        let requestData = job.req.data;

        let pos = he.getBoundingClientRect();
        if (!pos) return;

        var opt = requestData.settings.smartTip;

        let id = '#mgPlayerJSProd_smarttip-' + job.req.data.step.step_id;

        var posClass = '';

        let zIndex = GmCXt.dom.getElementZindex(he);

        if (requestData.settings.stickTargetElement) {

            let parentEl = mg$(he).parent()[0];
            var parentPos = parentEl.getBoundingClientRect();
            posClass = 'mgPlayerJSProd_absolute-position';
            mg$(id).removeClass('mgPlayerJSProd_fixed-position');

        } else {

            var scrollTop = mg$(window).scrollTop();
            var scrollLeft = mg$(window).scrollLeft();

            let cssPosition = GmCXt.dom.getElementFixedPosition(he);
            var posClass = GmCXt.getPosition(cssPosition);


        }

        let style = {
            left: requestData.settings.stickTargetElement ? pos.left - parentPos.left : pos.left,
            top: requestData.settings.stickTargetElement ? pos.top - parentPos.top : pos.top
        };

        if (!requestData.settings.stickTargetElement) {
            if (posClass === 'mgPlayerJSProd_absolute-position') {
                mg$(id).removeClass('mgPlayerJSProd_fixed-position');
                mg$(id).addClass('mgPlayerJSProd_absolute-position');
                style.top += scrollTop;
                style.left += scrollLeft;
            } else {
                mg$(id).removeClass('mgPlayerJSProd_absolute-position');
                mg$(id).addClass('mgPlayerJSProd_fixed-position');
            }
        }


        if (mg$(id).length) {
            mg$(id).show().css(style);
        } else {

            if (zIndex && !opt.zIndexVal) style.zIndex = zIndex;

            let ductEl = mg$(getDuctTapeHtml(job, w, h, opt, posClass));

            if (requestData.settings.stickTargetElement) {
                ductEl.css(style).insertAfter(he);
            } else {
                ductEl.css(style).appendTo('html:first');
            }

            if (opt.ductTapeAlert) {

                mg$(document).off('mouseenter', id);
                mg$(document).off('mouseleave', id);

                const el = mg$(id)[0];
                if (el) {
                    const handleClick = function (e) {
                        onDuctTapeClick(e);
                        GmCXt.hideTooltipDelay(requestData.step, opt);
                    };

                    el.removeEventListener('click', handleClick); // remove existing click event listener
                    el.addEventListener('click', handleClick);
                }

                mg$(id).mouseenter(function(){
                    if (!GmCXt.isInspectToolON()) {
                        GmCXt.clearTooltipTimeout();
                        showTooltip(he, opt, rect, requestData, "hover");
                    }
                });

                mg$(id).mouseleave(function(){
                    GmCXt.hideTooltipDelay(requestData.step, opt);
                });

            }
        }
    }

    var onDuctTapeClick = function(e) {
        let jobId = mg$(e.target).attr('jobId');

        if (!jobId) return;

        if (!jobs[jobId]) return;

        let d = jobs[jobId].req.data;
        let opt = d.step.step_settings.smartTip;

        if (opt.ductTapeDescription) {
            opt.ductTapeDescription = GmCXt.restoreAssetSrc("<p>"+opt.ductTapeDescription+"</p>");
            if (!d.isPreview) {
                GmCXt.updateOnScreenTooltipGuideInfo(d.tour, d.tour.tour_id, d.step.step_id, false, opt);

                GmCXt.updateTooltipActionInfo(d.tour.tour_id, d.step.step_id, opt, "click");
            }

            if (!d.step.step_settings.smartTip.showDuctTapeOnClick) {
                deleteJob(jobId);
                mg$(e.target).remove();
                deletedDuctTape.push(jobId);
            }

            let data = {
                desc: opt.ductTapeDescription
            };

        }
    };

    function updateColumnIndex(he, cs) {
        let td = mg$(he).is('td') ? he : mg$(he).parents('TD');
        cs.workday.columnIndex = mg$(td).index();
        return cs;
    }

    function isWorkdayTablePowerform(applyToColumn, cs) {
        if (applyToColumn &&
			cs && cs.workday &&
			cs.workday.isTableHeader) {
            return true;
        }
        return false;
    }

    function positionSmartTip(jobId, he, posChanged) {
        let job = jobs[jobId];
        if (!job) return;

        let rd = job.req.data;
        let de = job.resp.de;
        let tourId = rd.step.tour_id;

        let smartTip = rd.settings.smartTip;
        if(GmCXt.isEmpty(smartTip)) return;

        if (isWorkdayTablePowerform(de.applyToColumn, de.customSettings)) {
            de.customSettings = updateColumnIndex(he, de.customSettings);

            if (!rd.isPreview) {
                GmCXt.updateOnScreenTooltipGuideInfo(rd.tour, tourId, rd.step.step_id, true, smartTip, GmCXt.urlParts.fullUrl);
            }
            return; // Power HTML tooltip in column header
        }

        let rect = GmCXt.getAbsoluteRectFromIframe(he);
        if (!rect) {
            rect = he.getBoundingClientRect();
        }

        if (!rect) return;

        let opt = rd.settings.smartTip;
        opt.guidanceMessage = GmCXt.restoreAssetSrc("<p>"+opt.guidanceMessage+"</p>");

        let hePosition = GmCXt.dom.getElementFixedPosition(he);
        opt.tipPosition = GmCXt.getPosition(hePosition);

        if ((opt.type === 'guidance' || opt.type === 'both') && opt.guidanceMessage) {
            addGuidanceTip(he, opt, rd, rect);
        }

        if ((opt.type === 'validation' || opt.type === 'both')) {
            addValidationTip(he, opt, rd, posChanged, job);
        }

        if (opt.type === 'injector' && opt.htmlContent) {
            if (GmCXt.dom.isWDTextArea(de) && opt.formInjector && he) {
                disableMaximize(he);
            }
            bindSmartipHtml(he, opt, rd, jobId);
        }

        if (opt.type === 'disableElement') {
            updateElement(he, addDuctTape, opt, job, rect);
        }

        if (opt.type === 'formSubmit') {
            mg$('.' + getFormSubmitClass(tourId, rd.isPreview)).removeClass(getFormSubmitClass(tourId, rd.isPreview));
            addFormSubmitTip(he, rd);
        }
    }

    function disableMaximize(he) {
        let tempHe = he;
        let level = 3;
        let i = 0;
        let maximizeB = null;
        while (i < level) {
            i++;
            maximizeB = mg$(tempHe).find('A.cke_button__maximizeworkday[title=Maximize]')[0];
            if (maximizeB) {
                mg$(maximizeB).css('pointer-events', 'none');
                break;
            }
            tempHe = tempHe.parentNode;
        }
    }

    function getFormSubmitClass(tourId, isPreview) {
        let previewClass = isPreview ? ' mgPlayerJSProd_form-submit-preview' : '';
        return 'gssSmarttip-form-submit-' + tourId + previewClass;
    }

    function addGuidanceTip(he, options, requestData, rect) {
        options.size = requestData.settings.smartTip.size;
        options.stickTargetElement = requestData.settings.stickTargetElement;
        if (!options.size) {
            options.size = {
                width: 20,
                height: 20
            };
        }

        if (options.stickTargetElement) {
            let parentEl = mg$(he).parent()[0];
            let parentPos = parentEl.getBoundingClientRect();
            options.parentPos = parentPos;
            options.msgPosition = true;
            let tooltipPositionForMsg = getTooltipLeftTop(options, rect, requestData);
            options.messagePos = getTooltipMessageLeftTop(options, tooltipPositionForMsg);

        }
        options.pos = getTooltipLeftTop(options, rect, requestData);

        if (!GmCXt.isEmpty(requestData.settings.smartTip.zIndexVal)) {
            options.zIndex = requestData.settings.smartTip.zIndexVal;
        } else {
            options.zIndex = GmCXt.dom.getElementZindex(he);
        }

        switch (options.displayOn) {
        case 'icon':
            setOnIconTip(he, options, rect, requestData);
            break;

        case 'element':
            setOnElementTip(he, options, rect, requestData);
            break;

        case 'pageload':
            setAlwaysShowTip(he, options, rect, requestData);
            break;
        }
    }

    function setOnElementTip(he, options, rect, requestData) {

        let step = requestData.step;

        mg$(he)
            .off('mouseover').on('mouseover', function() {
                if (!GmCXt.isInspectToolON()) {
                    GmCXt.clearTooltipTimeout();
                    showTooltip(he, options, rect, requestData, "hover");
                }

            }).off('mouseout').on('mouseout', function() {
                GmCXt.hideTooltipDelay(step, options);

            }).off('focus').on('focus', function() {
                if (!GmCXt.isInspectToolON())
                    showTooltip(he, options, rect, requestData, "focus");

            }).off('blur').on('blur', function() {
                GmCXt.hideTooltip(step);

            }).off('click').off('click').on('click', function(e) {
                if (!requestData.isPreview)
                    GmCXt.tooltipAction(e, requestData.settings.smartTip, step);
            });
    }

    function setAlwaysShowTip(he, options, rect, requestData) {
        let hideTime = options.hideAfter ? options.hideAfter : 10;
        showTooltip(he, options, rect, requestData, 'pageload');
        if (hideTime !== 'showAlways') {
            setOnElementTip(he, options, rect, requestData);
            GmCXt.timeout(function() {
                GmCXt.hideTooltip(requestData.step);
                options.displayOn = 'element';
            }, hideTime * 1000);
        }
    }

    function playGuideFromEmbedUrl(e) {

        GmCXt.log(33, "Playing Guide from Embed URL");

        let guideTourId = e.target.getAttribute('data-guideMe-toursId');
        let automation = e.target.getAttribute('data-automation');

        if (guideTourId) {
            automation = automation == "true" ? true : false;
            let data = {
                tourId: guideTourId
            };
            if (automation) {
                data.initiator = 'doitforme';
            }
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:play_guide_from_link', data);
        }
    }

    function onTooltipClick(e, req) {
        let isAnchorTag = e.target.tagName.toLowerCase() == 'a';
        let isEmbedGuide = e.target.className == 'mgPlayerJSProd_tooltip-embed-url';

        //Tooltip click actions to be overridden if embed guide is present 
        if (isEmbedGuide) {
            playGuideFromEmbedUrl(e);
        }

        if (!req.isPreview && !isAnchorTag && !isEmbedGuide) {
            GmCXt.tooltipAction(e, req.settings.smartTip, req.step);
        }
    }

    function addEventstoTooltip(style, he, requestData, options, step, updatedUrl) {
        if (options.stickTargetElement) {
            mg$(getTooltipHtml(he, requestData, options.size, options, updatedUrl))
                .css(style)
                .insertAfter(he)
                .on('click', function(e) {
                    onTooltipClick(e, requestData);
                })
                .on('mouseover', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex, true); //passing true for incrementing z-index
                    if (!requestData.isPreview) {
                        GmCXt.updateTooltipActionInfo(step.tour_id, step.step_id, requestData.settings.smartTip, "hover");
                    }
                })
                .on('mouseout', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex);
                });

            let msgStyle = {
                left: options.messagePos.left,
                top: options.messagePos.top
            };
            let gId = "mgPlayerJSProd_smarttip-guidance-msg-" + requestData.step.step_id;
            if(mg$("#"+gId).length) {
                mg$("#"+gId).remove();
            }

            mg$(getTooltipMessageHtml(he, requestData, options)).css(msgStyle).appendTo('html:first');

            let iconId = 'mgPlayerJSProd_smarttip-icon-' + requestData.step.step_id;

            let iconEL = document.getElementById(iconId);
            let guidanceEl = document.getElementById(gId);
            iconEL.addEventListener('mouseenter', function() {
                guidanceEl.style.visibility = 'visible';
                guidanceEl.style.opacity = 1;
            });
            iconEL.addEventListener('mouseleave', function() {
                guidanceEl.style.visibility = 'hidden';
                guidanceEl.style.opacity = 0;
            });

        } else {
            mg$(getTooltipHtml(he, requestData, options.size, options, updatedUrl))
                .css(style)
                .appendTo('html:first')
                .on('click', function(e) {
                    onTooltipClick(e, requestData);
                })
                .on('mouseover', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex, true); //passing true for incrementing z-index
                    if (!requestData.isPreview) {
                        GmCXt.updateTooltipActionInfo(step.tour_id, step.step_id, requestData.settings.smartTip, "hover");
                    }
                })
                .on('mouseout', function() {
                    this.style.zIndex = GmCXt.updateZIndex(this.style.zIndex);
                });
        }
    }

    function setOnIconTip(he, options, rect, requestData) {
        let step = requestData.step;
        var style = {
            left: options.pos.left,
            top: options.pos.top
        };
        let iconId = 'mgPlayerJSProd_smarttip-icon-' + step.step_id;

        if (GmCXt.getElVisibility(he) === 'hidden') {
            style.display = 'none';
        }

        if (mg$('#' + iconId).length) {

            mg$('#' + iconId).parent().css(style);

            let gId = "mgPlayerJSProd_smarttip-guidance-msg-" + requestData.step.step_id;

            mg$('#' + gId).attr('style', function(i, style) {
                let props = style.split(';');
                let updatedStyle = "";
                for (let j = 0; j < props.length; j++) {
                    if (props[j].indexOf('border-color') !== -1) {
                        updatedStyle += 'border-color: ' + requestData.os.tooltipColor + ' !important;';
                    } else if (props[j] && props[j] != " ") {
                        updatedStyle += props[j] + ";";
                    }
                }
                return updatedStyle;

            });

            if (options.stickTargetElement) {
                var style = {
                    left: options.messagePos.left,
                    top: options.messagePos.top
                };
                mg$('#' + gId).css(style);
            }



        } else {

            if (options.zIndex) style.zIndex = options.zIndex;

            let updatedUrl = false;
            let url = requestData.settings.smartTip.icon;
            addEventstoTooltip(style, he, requestData, options, step, updatedUrl);

            let tipClass = 'mgPlayerJSProd_smarttip-icon-wrapper-' + requestData.step.step_id;
            GmCXt.imageSizeStyle('.' + tipClass + ' .mgPlayerJSProd_smarttip-msg-inner img');

            GmCXt.zoomImage(options.guidanceMessage, ".mgPlayerJSProd_smarttip-msg-inner");
            if (options.guidanceMessage.indexOf('target = "gssPlayGuide"') !== -1) {
                GmCXt.setLinkGuidePlay(options.guidanceMessage, ".mgPlayerJSProd_smarttip-msg-inner");
            }
			
            let linkData = {
                tid: step.tour_id,
                sid: step.step_id,
                opt: options
            };
			
            GmCXt.setTooltipLinkClickhandler(options.guidanceMessage, ".mgPlayerJSProd_smarttip-msg-inner", linkData);
        }

        if (!requestData.isPreview) {
            GmCXt.updateOnScreenTooltipGuideInfo(requestData.tour, step.tour_id, step.step_id, true, options, GmCXt.urlParts.fullUrl);
        }
    }

    function getElValue(he) {

        let elTagName = mg$(he)[0].tagName.toLowerCase();

        if (mg$(he).get(0).isContentEditable && elTagName !== 'input') {
            return mg$(he).get(0).textContent;
        } else {
            return mg$(he).val();
        }
    }

    function saveInput(he, requestData) {

        requestData.step.innerHTML = mg$(he).html();
        requestData.step.value = getElValue(he);
    }

    function getLongestB(he) {
        let b = mg$(he).find('li');
        let max = 0;
        b.each(function(i, n) {
            let l = mg$(n).text().length;
            if (l > max) max = l;
        });
        return max;
    }

    function valMaxChar(value, rules) {
        let rulesVal = rules.value.charCount || rules.value;

        if (value.length > rulesVal.max) return true;
        else return false;
    }

    function valMinChar(value, rules) {
        let rulesVal = rules.value.charCount || rules.value;

        if (value.length < rulesVal.min) return true;
        else return false;
    }

    function valMinBullet(innerHTML, rules, he) {
        let bCount = GmCXt.getBulletCount(innerHTML);
        let rulesVal = rules.value.bulletCount || rules.value;

        if (bCount < rulesVal.min) return true;
    }

    function valMaxBullet(innerHTML, rules, he) {
        let bCount = GmCXt.getBulletCount(innerHTML);
        let rulesVal = rules.value.bulletCount || rules.value;
        let charsInBullet = getLongestB(he);

        if (bCount > rulesVal.max) return true; // validate number of bullets
        else if (charsInBullet > rulesVal.maxPerBullet) return true; // validate chars per bullet
        else return false;
    }

    function restoreInput(he, requestData) {
        if (mg$(he).get(0).isContentEditable && requestData.step.innerHTML) {
            he.innerHTML = requestData.step.innerHTML;
            mg$(he).blur();
        } else if (requestData.step.value)
            mg$(he).val(requestData.step.value);
    }

    function triggerValidation(he, options, requestData, job, isFirst) {

        let flag = false;
        let rules = options.rules;
        let innerHTML = mg$(he).html();
        let step = requestData.step;
        let v = GmCXt.getValidationTypes();
        requestData.step.hardStop = false;

        let value = getElValue(he);

        if (rules.date === true && !GmCXt.validateDateFormat(value)) {
            v.date = flag = true;
        }

        if (rules.email === true && !GmCXt.validateEmail(value)) {
            v.email = flag = true;
        }

        if (rules.numeric === true && !GmCXt.validateNumeric(value)) {
            v.numeric = flag = true;
        }

        if (rules.phone === true && !GmCXt.validatePhonenumber(value)) {
            v.phone = flag = true;
        }

        if (rules.required === true && !value) {
            v.required = flag = true;
        }

        if (rules.time === true && !GmCXt.validateTimeFormat(value)) {
            v.time = flag = true;
        }

        if (rules.url === true && !GmCXt.validateWebUrl(value)) {
            v.url = flag = true;
        }

        let maxCharFails = false;
        let maxBulFails = false;

        if (rules.charCount === true) {
            maxCharFails = valMaxChar(value, rules);
            v.charCount = maxCharFails || valMinChar(value, rules);
            if (v.charCount) flag = true;
        }

        if (rules.bulletCount === true) {
            maxBulFails = valMaxBullet(innerHTML, rules, he);
            v.bulletCount = maxBulFails || valMinBullet(innerHTML, rules, he);
            if (v.bulletCount) flag = true;
        }

        let regexValue = rules.value;
        let regValue = regexValue.regex || regexValue;

        if (rules.regex === true && !GmCXt.validateRegex(regValue, value)) {
            v.regex = true;
            flag = true;
        }

        let tourId = step.tour_id;
        let stepId = step.step_id;

        if (flag === true) {

            options.validationType = v;

            updateValidationList(stepId, tourId, false);

            addToTriggeredList(stepId, true);
            if (!isFirst) {
                showValidationTooltip(he, options, step, requestData.isPreview, requestData.tour);
            }

            showFormSubmitTooptip(step, requestData.isPreview, options, job);

        } else {

            updateValidationList(stepId, tourId, true);
            addToTriggeredList(stepId, false);

            GmCXt.hideValidationTooltip(step);

            if (isTooltipValid(tourId))
                hideFormSubmitTip(tourId, requestData.isPreview, options, job);
        }
    }

    function isTooltipValid(tourId) {

        let t = tracker["tour_" + tourId];
        let flag = true;

        t.forEach(function(s) {
            if (!s.isValid) flag = false;
        });

        return flag;
    }

    function updateValidationList(stepId, tourId, value) {

        let list = tracker["tour_" + tourId];
        let isUpdated = false;

        if (!list) {

            list = [];
            list.push({
                'stepId': stepId,
                isValid: value
            });

        } else {

            for (let i = 0; i < list.length; i++) {
                if (list[i].stepId === stepId) {
                    list[i].isValid = value;
                    isUpdated = true;
                }
            }

            if (!isUpdated)
                list.push({
                    'stepId': stepId,
                    isValid: value
                });
        }

        tracker["tour_" + tourId] = list;
    }

    function addValidationTip(he, options, requestData, posChanged, job) {

        let step = requestData.step;
        let tourId = step.tour_id;

        updateValidationList(step.step_id, tourId, true);

        if (posChanged) {
            repositionValidationTip(he, options, requestData);
        }

        if (requestData.isPreview && !GmCXt.smartTipPreviewOn) {
            return;
        }

        if (!requestData.isPreview) {
            GmCXt.updateOnScreenTooltipGuideInfo(requestData.tour, tourId, step.step_id, true, options, GmCXt.urlParts.fullUrl);
        }

        mg$(he)
            .off('focus').on('focus', function() {
                GmCXt.hideValidationTooltip(step);
            })
            .off('blur').on('blur', function() {
                triggerValidation(he, options, requestData, job);
            })
            .off('keyup').on('keyup', function() {
                triggerValidation(he, options, requestData, job);
            });

        const durationMs = GmCXt.getOrgStepWaitTime() || 10000;
        const intervalMs = 1000;
        let count = 0;

        const maxCount = durationMs / intervalMs;

        const intervalId = setInterval(function() {
            triggerValidation(he, options, requestData, job, true);
            count++;

            if (count >= maxCount) {
                clearInterval(intervalId); // Stop after reaching the total duration
            }
        }, intervalMs);
    }

    function repositionValidationTip(he, options, requestData) {

        let step = requestData.step;

        if (autoTriggered[step.step_id]) {
            showValidationTooltip(he, options, step, requestData.isPreview, requestData.tour);
        }
    }

    function addFormSubmitTip(he, requestData) {

        let step = requestData.step;
        let tourId = step.tour_id;

        let smartTip = requestData.settings.smartTip;

        mg$(he).addClass(getFormSubmitClass(tourId, requestData.isPreview));

        if (!requestData.isPreview) {
            GmCXt.updateOnScreenTooltipGuideInfo(requestData.tour, tourId, step.step_id, true, smartTip, GmCXt.urlParts.fullUrl);
        }
    }

    function showFormSubmitTooptip(step, isPreview, options, job) {
        let el = mg$('.' + getFormSubmitClass(step.tour_id, isPreview).replace(/\s+/g, '.'));
        if (!el.length && window.top !== window.self) {
            el = mg$(window.document).find('.' + getFormSubmitClass(step.tour_id, isPreview).replace(/\s+/g, '.'));
        }

        function update(he) {
            mg$(he).addClass('gssSmarttip-form-submit');
        }

        updateElement(el[0], update, options, job);
    }

    function hideFormSubmitTip(tourId, isPreview, options, job) {
        let el = mg$('.' + getFormSubmitClass(tourId, isPreview).replace(/\s+/g, '.'));
        if (!el.length && window.top !== window.self) {
            el = mg$(window.document).find('.' + getFormSubmitClass(tourId, isPreview).replace(/\s+/g, '.'));
        }

        function update(he) {
            mg$(he).removeClass('gssSmarttip-form-submit');
        }

        updateElement(el[0], update, options, job);
    }

    function updateElement(he, update, options, job, rect) {
        if (!he) return;

        let settings = job.req.data.settings;

        let w = mg$(he).outerWidth();
        let h = mg$(he).outerHeight();

        update(he, options, w, h, job, rect);

        if (!settings.stickTargetElement || (options.type !== 'disableElement' && settings.stickTargetElement)) {
            let p = mg$(he).parent()[0];
            let pw = mg$(p).outerWidth();
            let ph = mg$(p).outerHeight();

            if (w === pw && h === ph) {
                updateElement(p, update, options, job);
            }
        }
    }

    function getGuidanceMessageAlignment(he, align) {

        let spaceToLeft = mg$(he).offset().left;
        let spaceToRight = mg$(window).width() - (mg$(he).offset().left + mg$(he).outerWidth());
        let spaceOnTop = mg$(he).offset().top;
        let spaceAtBottom = mg$(window).height() - (mg$(he).offset().top + mg$(he).outerHeight());
        let msgBoxWidth = 238;
        let msgBoxHeight = 70;

        switch (align) {
        case "left":
            if ((spaceToLeft - msgBoxWidth) < 0) {
                align = "right";
            }
            break;
        case "right":
            if ((spaceToRight - msgBoxWidth) < 0) {
                align = "left";
            }
            break;
        case "top":
            if ((spaceOnTop - msgBoxHeight) < 0) {
                align = "bottom";
            }
            break;
        case "bottom":
            if ((spaceAtBottom - msgBoxHeight) < 0) {
                align = "top";
            }
            break;
        }
        return align;
    }

    function getGuidenceClsPrefix() {
        // Do NOT change this because parsing of stepId and tourId 
        // is strictly dependent 
        return 'mg-has-guidence-message-';
    }

    function getGuidenceMessageElmClass(stepId, tourId) {
        return getGuidenceClsPrefix() + stepId + "-" + tourId;
    }

    function showTooltip(he, options, rect, requestData, actionType) {

        if (options.type == 'disableElement') {
            options.displayOn = 'element';
        }

        let isPreview = requestData.isPreview;
        let tourId = requestData.step.tour_id;

        if (isPreview && !GmCXt.smartTipPreviewOn) return;

        let step = requestData.step;
        let iconId = 'mgPlayerJSProd_smarttip-icon-' + step.step_id;

        mg$(he).addClass(getGuidenceMessageElmClass(step.step_id, tourId));

        if (options.displayOn === 'icon')
            rect = document.getElementById(iconId).getBoundingClientRect();
        if (options.displayOn === 'element') {
            rect = he.getBoundingClientRect();
            options.pos = getTooltipLeftTop(options, rect, requestData);
        }

        let d = {
            options: options,
            stepId: step.step_id,
            alignment: options.alignment,
            left: options.pos.left,
            top: options.pos.top,
            highlightedArea: rect,
            displayOn: options.displayOn,
            type: options.type,
            step: step,
            rect: rect,
            derivedType: 'guidance',
            tipPosition: options.tipPosition,
            scrollTop: mg$(window).scrollTop(),
            isPreview: isPreview,
            tourId: tourId,
            actionType: actionType,
            inTopWindow: (window.self === window.top),
            os: requestData.os,
            tour: requestData.tour,
            reqId: GmCXt.id
        };

        if (options.zIndex) d.zIndex = options.zIndex;

        if (window.self === window.top) {
            GmCXt.requestHandler.showSmarttip(d);
            GmCXt.addEventOnTooltip(requestData);
        } else {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:show_smarttip', d);
        }
    }

    function getTooltipHtml(he, requestData, size, options, updatedUrl) {
        let as = GmCXt.getAppSetting();

        if (options.stickTargetElement) {
            mg$(he).parent().addClass('mgPlayerJSProd_relative-position');
        } else {
            mg$(he).parent().removeClass('mgPlayerJSProd_relative-position');
        }
        let id = 'mgPlayerJSProd_smarttip-icon-' + requestData.step.step_id;

        let tipClass = 'mgPlayerJSProd_smarttip-icon mg-smarttip-icon mgPlayerJSProd_smarttip-icon-wrapper-' + requestData.step.step_id + ' ' + 'mgPlayerJSProd_smarttip-tour-' + requestData.step.tour_id;

        if (GmCXt.smarttipAreHidden === true && !requestData.isPreview) {
            tipClass += ' tooltip-hidden';
        }

        if (options.tipPosition)
            tipClass += ' ' + options.tipPosition.replace('mgPlayerJSProd_', 'mg-');

        if (requestData.isPreview) tipClass += ' mgPlayerJSProd_preview-smarttip';

        let img = (requestData.settings.smartTip.icon && requestData.settings.smartTip.icon.indexOf(GmCXt.model.organization.settings._obj.tooltip_img._default) === -1) ? requestData.settings.smartTip.icon : as.tooltip_img;

        if (img && img.indexOf(GmCXt.model.organization.settings._obj.tooltip_img._default) === -1) {
            img = GmCXt.restoreAssetSrc(img);
        } else {
            img = GmCXt.conf.staticContentPath + GmCXt.model.organization.settings._obj.tooltip_img._default;
        }

        let os = requestData.os;

        let tTheme = GmCXt.tooltipTheme(os, 'wmgPlayerJSProd_', options);

        let popupFooter = "<wmgPlayerJSProd_ class='mgPlayerJSProd_smarttip-popup-footer mgPlayerJSProd_width-100 mgPlayerJSProd_display-flex mgPlayerJSProd_align-items-center mgPlayerJSProd_justify-content-flex-start'>" +
			"                 <img class='mgPlayerJSProd_custom-image' src='" + GmCXt.brandLogo() + "'>" +
			"              </wmgPlayerJSProd_>";

        let html = "<wmgPlayerJSProd_ class='" + tipClass + " ' style='width:" +
			size.width + "px; height:" + size.height + "px' >" +
			"   <img class='mgPlayerJSProd_custom-image' id='" + id + "'" +
			"       src='" + img + "' " +
			"       style='width:" + size.width + "px; height:" + size.height + "px' />" +
			(options.stickTargetElement ? '' : getTooltipMessageHtml(he, requestData, options)) +
			"   </wmgPlayerJSProd_>" +
			"</wmgPlayerJSProd_>";

        return html;
    }

    function getTooltipMessageHtml(he, requestData, options) {

        let msgPos = requestData.step.step_settings.smartTip.msg_pos;
        let guidanc_class = 'mgPlayerJSProd_smarttip-guidance-msg-' +
			getGuidanceMessageAlignment(he, options.alignment);

        if (msgPos) {
            guidanc_class = 'mgPlayerJSProd_smarttip-guidance-msg-' + msgPos;
        }

        let os = requestData.os;

        let tTheme = GmCXt.tooltipTheme(os, 'wmgPlayerJSProd_', options);

        let gId = "mgPlayerJSProd_smarttip-guidance-msg-" + requestData.step.step_id;

        let popupSize = requestData.settings.smartTip.popupSize;
        let popupStyle = "";

        if (!popupSize) {
            popupSize = {};
        }

        let popupWidth = popupSize.popupWidth ? popupSize.popupWidth : '250';
        let popupHeight = popupSize.popupHeight ? popupSize.popupHeight : '250';
        popupStyle = "max-width:" + popupWidth + "px; max-height:" + popupHeight + "px; ";

        let tooltipHtml = GmCXt.updateOrgAndAddSignature(GmCXt.replaceVariableWithValue(options.guidanceMessage));

        const currentUrl = new URL(window.location.href);

        // regex to check if <a> tag is present with guideMe-tourId param present in url.
        const regex = /<a([^>]*)href="([^"]*guideMe-tourId=([^"&]*)(?:[^"]*?(?:&|&amp;)automation=([^"&]*))?[^"]*)"([^>]*)target="_self"([^>]*)>(.*?)<\/a>/g;
        tooltipHtml = tooltipHtml.replace(regex, (match, p1, href, toursId, automation, p2, p3, content) => {
            const hrefUrl = new URL(href);
            if (hrefUrl.hostname === currentUrl.hostname && hrefUrl.pathname === currentUrl.pathname) {
                return `<wmgPlayerJSProd_ class="mgPlayerJSProd_span mgPlayerJSProd_tooltip-embed-url" data-guideMe-toursId="${toursId}" data-automation="${automation || false}">${content}</wmgPlayerJSProd_>`;
            }
            return match;
        });

        let c = GmCXt.singleLineTitle(tooltipHtml);

        let popupFooter = "<wmgPlayerJSProd_ class='mgPlayerJSProd_smarttip-popup-footer mgPlayerJSProd_width-100 mgPlayerJSProd_display-flex mgPlayerJSProd_align-items-center mgPlayerJSProd_justify-content-flex-start'>" +
			"                 <img class='mgPlayerJSProd_custom-image' src='" + GmCXt.brandLogo() + "'>" +
			"              </wmgPlayerJSProd_>";

        let html = "<wmgPlayerJSProd_ id ='" + gId + "'class='mgPlayerJSProd_smarttip-guidance-msg " + guidanc_class + " " + c + " ' style = 'max-width:unset; " + (tTheme.tooltipBorderC ? tTheme.tooltipBorderC : '') + (tTheme.tooltipBgColor ? tTheme.tooltipBgColor : '') + (tTheme.tooltipBorderW ? tTheme.tooltipBorderW : '') + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + (tTheme.tooltipPaddingTop ? tTheme.tooltipPaddingTop : '') + (tTheme.tooltipPaddingBottom ? tTheme.tooltipPaddingBottom : '') + (tTheme.tooltipPaddingLeft ? tTheme.tooltipPaddingLeft : '') + (tTheme.tooltipPaddingRight ? tTheme.tooltipPaddingRight : '') + "'>" +
			"       <wmgPlayerJSProd_ class='mgPlayerJSProd_smarttip-msg-inner' style='" + popupStyle + (tTheme.tooltipBorderRadius ? tTheme.tooltipBorderRadius : '') + (tTheme.tooltipDescColor ? tTheme.tooltipDescColor : '') + (tTheme.tooltipDescFsize ? tTheme.tooltipDescFsize : '') + (tTheme.tooltipDescFfamily ? tTheme.tooltipDescFfamily : '') + (tTheme.tooltipWidth ? tTheme.tooltipWidth : '') + "'>" + tooltipHtml +
			"       </wmgPlayerJSProd_>" +
			((os.tooltipTheme && !os.hideBrandLogo) ? popupFooter : '');

        return html;

    }


    function getTooltipLeftTop(options, rect, rd) {

        let left = 0;
        let top = 0;

        //get Size Based on window size
        let originalEl = rd.settings.element.position;

        let size = {
            width: options.size.width,
            height: options.size.width
        };

        switch (options.alignment) {

        case 'left':
            if (options.stickTargetElement && !options.msgPosition) {
                left = (rect.left - options.parentPos.left) - size.width - 5;
                top = ((rect.top - options.parentPos.top) + rect.height / 2) - (size.height / 2);
            } else {
                left = rect.left - size.width - 5;
                top = (rect.top + rect.height / 2) - (size.height / 2);
            }
            break;

        case 'right':
            if (options.stickTargetElement && !options.msgPosition) {
                left = (rect.left - options.parentPos.left) + rect.width + 5;
                top = ((rect.top - options.parentPos.top) + rect.height / 2) - (size.height / 2);
            } else {
                left = rect.left + rect.width + 5;
                top = (rect.top + rect.height / 2) - (size.height / 2);
            }
            break;

        case 'top':
            if (options.stickTargetElement && !options.msgPosition) {
                left = ((rect.left - options.parentPos.left) + rect.width / 2) - (size.width / 2);
                top = (rect.top - options.parentPos.top) - size.height - 5;
            } else {
                left = (rect.left + rect.width / 2) - (size.width / 2);
                top = rect.top - size.height - 5;
            }
            break;

        case 'bottom':
            if (options.stickTargetElement && !options.msgPosition) {
                left = ((rect.left - options.parentPos.left) + rect.width / 2) - (size.width / 2);
                top = (rect.top - options.parentPos.top) + rect.height + 5;
            } else {
                left = (rect.left + rect.width / 2) - (size.width / 2);
                top = rect.top + rect.height + 5;
            }
            break;

        case 'center':
            if (options.stickTargetElement && !options.msgPosition) {
                left = ((rect.left - options.parentPos.left) + rect.width / 2) - (size.width / 2);
                top = ((rect.top - options.parentPos.top) + rect.height / 2) - (size.height / 2);
            } else {
                left = (rect.left + rect.width / 2) - (size.width / 2);
                top = (rect.top + rect.height / 2) - (size.height / 2);
            }
            break;

        case 'custom':
            if (options.customPosition.left_pos === '%') {
                if (options.displayOn === 'icon') {
                    var w = ((rect.width * options.customPosition.left) / 100) - (options.size.width / 2);
                } else {
                    var w = ((rect.width * options.customPosition.left) / 100);
                }
            } else {
                var w = options.customPosition.left * (rect.width / originalEl.width);
            }
            if (options.customPosition.top_pos === '%') {
                if (options.displayOn === 'icon') {
                    var h = ((rect.height * options.customPosition.top) / 100) - (options.size.height / 2);
                } else {
                    var h = ((rect.height * options.customPosition.top) / 100);
                }

            } else {
                var h = options.customPosition.top * (rect.height / originalEl.height);
            }
            if (options.stickTargetElement && !options.msgPosition) {
                left = (rect.left - options.parentPos.left) + w;
                top = (rect.top - options.parentPos.top) + h;
            } else {
                left = rect.left + w;
                top = rect.top + h;
            }
        }

        if (!options.stickTargetElement) {
            if (options.tipPosition === "mgPlayerJSProd_absolute-position") {
                top = top + mg$(window).scrollTop();
                left = left + mg$(window).scrollLeft();
            }
        }

        if (options.msgPosition) {
            options.msgPosition = false;
        }

        return {
            left: left,
            top: top
        };
    }


    function getTooltipMessageLeftTop(options, tipPos) {

        let left = tipPos.left;
        let top = tipPos.top;

        let size = {
            width: options.size.width,
            height: options.size.width
        };

        switch (options.msg_pos) {

        case 'left':
            left = left + size.width / 2 - 5;
            top = top + size.height / 2;
            break;

        case 'right':
            left = left + size.width / 2 + 5;
            top = top + size.height / 2;
            break;

        case 'top':
            top = top;
            left = left + size.width / 2;
            break;

        case 'bottom':
            top = top + size.height / 2;
            left = left + size.width / 2;
            break;

        }

        top = top + mg$(window).scrollTop();
        left = left + mg$(window).scrollLeft();



        return {
            left: left,
            top: top
        };

    }

    function getValidationLeftTop(options, rect) {

        let left = 0;
        let top = 0;

        switch (options.rules.alignment) {

        case 'left':
            left = rect.left - 5;
            top = (rect.top + rect.height / 2);
            break;

        case 'right':
            left = rect.left + rect.width + 5;
            top = (rect.top + rect.height / 2);
            break;

        case 'top':
            left = (rect.left + rect.width / 2);
            top = rect.top - 5;
            break;

        case 'bottom':
            left = (rect.left + rect.width / 2);
            top = rect.top + rect.height + 5;
            break;

        case 'custom':
            left = rect.left + options.rules.customPosition.left;
            top = rect.top + options.rules.customPosition.top;
        }

        if (options.tipPosition === "mgPlayerJSProd_absolute-position") {
            top = top + mg$(window).scrollTop();
            left = left + mg$(window).scrollLeft();
        }

        return {
            left: left,
            top: top
        };
    }

    function showValidationTooltip(he, options, step, isPreview, tour) {

        if (isPreview && !GmCXt.smartTipPreviewOn) return;

        let pos = GmCXt.getAbsoluteRectFromIframe(he);
        if (!pos) {
            pos = he.getBoundingClientRect();
        }

        let rect = GmCXt.getRectObject(pos);

        //var newLeft = rect.left + rect.width / 2;
        //var newTop = rect.top;
        let zIndex = GmCXt.dom.getElementZindex(he);

        if (!options.rules.alignment) options.rules.alignment = 'top';

        options.pos = getValidationLeftTop(options, rect);
        let newLeft = options.pos.left;
        let newTop = options.pos.top;

        let d = {
            options: options,
            stepId: step.step_id,
            left: newLeft,
            top: newTop,
            highlightedArea: rect,
            type: options.type,
            step: step,
            rect: rect,
            derivedType: 'validation',
            scrollTop: mg$(window).scrollTop(),
            isPreview: isPreview,
            tourId: step.tour_id,
            actionType: 'validation',
            tipPosition: options.tipPosition,
            inTopWindow: (window.self === window.top),
            tour: tour,
            reqId: GmCXt.id
        };
        if (zIndex) d.zIndex = zIndex;

        if (window.self === window.top) {
            GmCXt.requestHandler.showSmarttip(d);
        } else {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:show_smarttip', d);
        }
    }

    function findRuleElement(jobId) {

        let job = jobs[jobId];
        let req = job.req;
        let resp = job.resp;
        let de = req.data.element;
        let tourLog = GmCXt.tourLog(req.data.job.tour);

        let info = "[El Rule] -" + tourLog + req.data.rule.value;

        function notFound() {

            GmCXt.log(6, "NOT FOUND rule element " + tourLog, 1);
            GmCXt.printMatchingAlgoLogs();

            if (!resp.he) {
                resp.valid = false;
                if (req.data.rule && (req.data.rule.condition === GmCXt.NOT_EXISTS || req.data.rule.condition === GmCXt.NOT_VISIBLE)) {
                    resp.valid = true;
                }
            }
            if (de) removeDeForRules(JSON.stringify(de.selector), tourLog);
            delete jobs[jobId];
            if (req.cb) req.cb(resp);
        }

        if (Date.now() > job.timeout) {
            GmCXt.log(6, "RULE TIMEOUT " + tourLog, 1);
            notFound();
            return;
        }

        if (de) {

            if (alreadySearchingHeForRules(de, jobId, tourLog)) {
                return;
            }

            if (GmCXt.decodeVersion(de.version) <= 5033401) {
                var newDe = mg$.extend(true, {}, de);
                var he = getDOMElementForRule(de, null, info);
            } else {

                var newDe = GmCXt.migrateMatchAlgoSetting(de);
                if (!isTargetFrame(newDe, req.data.frame, job.startTime)) {
                    return;
                }

                let ruleEl = true;
                if (req.data.rule.condition === GmCXt.EXISTS || req.data.rule.condition === GmCXt.NOT_EXISTS || req.data.rule.condition === GmCXt.VISIBLE || req.data.rule.condition === GmCXt.NOT_VISIBLE) {
                    ruleEl = false;
                }

                var he = getDOMElementForRule(newDe, null, info, null, ruleEl);

            }

            if (he) {

                let elemPos = he.getBoundingClientRect();

                if (elemPos) {

                    resp.valid = validateRules(he, req.data.rule, newDe, jobId);
                    resp.he = he;

                    saveHeForRules(de, he, jobId, tourLog);

                    if (resp.valid && req.cb) {
                        delete jobs[jobId];
                        req.cb(resp);
                    } else if (req.cb) {
                        req.cb(resp);
                    }
                }
            }
        }
    }

    function returnRulesCallBack(he, jobId) {
        let job = jobs[jobId];
        if (job) {
            let req = job.req;
            let resp = job.resp;
            let de = req.data.element;
            let tourLog = GmCXt.tourLog(req.data.job.tour);

            GmCXt.log(6, "Executing rules callback " + tourLog);

            resp.valid = validateRules(he, req.data.rule, de, jobId);
            if (resp.valid) {
                if (req.data.rule.condition === GmCXt.EXISTS) {
                    resp.valid = he && mg$(he).length ? true : false;
                } else if (req.data.rule.condition === GmCXt.VISIBLE) {
                    resp.valid = GmCXt.getElVisibility(he) === "visible" ? true : false;
                } else {
                    resp.valid = mg$(he).is(':visible');
                }
            }
            resp.he = he;

            if (resp.valid) {
                delete jobs[jobId];
            }
            if (req.cb) {
                req.cb(resp);
            }
        }
    }

    function alreadySearchingHeForRules(de, jobId, tourLog) {

        let deExist = false;

        for (let i = 0; i < GmCXt.domElStore.length; i++) {

            if (GmCXt.domElStore[i].deSel === JSON.stringify(de.selector)) {

                deExist = true;
                GmCXt.log(6, tourLog + "DE MATCHED");

                if (GmCXt.domElStore[i].he) {
                    if (mg$.contains(window.document, mg$(GmCXt.domElStore[i].he)[0])) {
                        GmCXt.log(6, tourLog + "Cached element exists in the DOM");
                        returnRulesCallBack(GmCXt.domElStore[i].he, jobId);
                    } else {
                        GmCXt.log(6, tourLog + "Element was earlier found for a matching selector, but does not exist in the DOM presently.");
                        removeDeForRules(i, tourLog);
                        deExist = false;
                        break;
                    }
                } else if (GmCXt.domElStore[i].origJobId === jobId) {
                    GmCXt.log(6, tourLog + "Continuing finding he. . . ");
                    return false;
                    // Requests from the original job should be passed to finding
                    // For all other jobs associated with the same el, declare already finding
                }

                GmCXt.domElStore[i].jobId.push(jobId);
                break;
            }
        }

        if (!deExist) {
            GmCXt.log(6, tourLog + "Adding new DE in cache. . .");
            saveDeForRules(de, jobId, tourLog);
        }

        return deExist;
    }

    function removeDeForRules(selector, tourLog) {
        GmCXt.log(6, tourLog + "Removing DE entry from cache. . .");

        if (GmCXt.isNumeric(selector)) {
            GmCXt.domElStore.splice(selector, 1);
        } else {
            for (let i = 0; i < GmCXt.domElStore.length; i++) {
                if (GmCXt.domElStore[i].deSel === selector) {
                    GmCXt.domElStore.splice(i, 1);
                    break;
                }
            }
        }
    }

    function saveDeForRules(de, jobId, tourLog) {
        let obj = {};
        obj.deSel = JSON.stringify(de.selector);
        obj.jobId = [];
        obj.jobId.push(jobId);
        obj.origJobId = jobId;

        GmCXt.domElStore.push(obj);
    }

    function saveHeForRules(de, he, jobId, tourLog) {
        GmCXt.log(6, "Save HE in cache" + tourLog);

        for (let i = 0; i < GmCXt.domElStore.length; i++) {

            if (GmCXt.domElStore[i].deSel === JSON.stringify(de.selector)) {

                GmCXt.domElStore[i].he = he;

                for (let j = 0; j < GmCXt.domElStore[i].jobId.length; j++) {

                    let jID = GmCXt.domElStore[i].jobId[j];
                    if (jobId !== jID) {
                        returnRulesCallBack(he, jID);
                    }
                }
                break;
            }
        }
    }

    function findMatchingAlgoElement(jobId) {

        let job = jobs[jobId];
        let req = job.req;
        let resp = job.resp;
        var de = req.data.element;
        let he = null;
        let elemPos = null;

        function notFound() {
            resp.found = false;
            delete jobs[jobId];
            if (req.cb) req.cb(resp);
        }

        if (Date.now() > job.timeout) {
            GmCXt.log(12, "NOT FOUND element", job);

            notFound();
            return;
        }

        if (de) {

            var de = GmCXt.migrateMatchAlgoSetting(de);

            if (!isTargetFrame(de, req.data.frame, job.startTime)) {
                return;
            }

            he = getDOMElementForRule(de, null, false, null);

            if (he) {

                c = de.criteria;

                if (!c.availableAttr) {
                    de = GmCXt.dom.getElement(he, de.criteria, req.data.frame);
                }

                elemPos = he.getBoundingClientRect();

                if (elemPos) {

                    GmCXt.log(12, "FOUND element", job);

                    resp.found = true;
                    resp.he = he;
                    resp.de = de;

                    editJob = mg$.extend(true, {}, job);
                    delete jobs[jobId];
                    req.cb(resp);
                }
            }
        }
    }

    function validateColumnRules(he, rule, jobId) {
        let table = he;
        let cellText, index;

        for (var i = 0; i < rule.columnConditions.length; i++) {
            rule.columnConditions[i].index = parseInt(rule.columnConditions[i].key);
        }

        let columnsValid = 0;
        for (var i = 1; i < table.rows.length; i++) {

            columnsValid = 0;

            for (let j = 0; j < rule.columnConditions.length; j++) {
                index = rule.columnConditions[j].index;
                cellText = table.rows[i].children[index].textContent.trim().replace(/\n/g, '');

                if (cellText === rule.columnConditions[j].value.trim()) {
                    columnsValid++;
                }
            }
            if (columnsValid === rule.columnConditions.length) {
                beaconHe[jobId.split("_")[2]] = table.rows[i];
                return true;
            }
        }
        return false;
    }

    function validateRules(he, rule, de, jobId) {

        let condition = rule.condition;
        let value = rule.value;

        let elValue = GmCXt.getElementText(he);

        if (de && de.pathFromLabel && !GmCXt.isEmpty(de.targetInfo) && GmCXt.isEmpty(de.targetInfo.text)) {
            // Using "primary element" text not the "label" text for text based rules from version 2020.6.31.02
            he = GmCXt.dom.finder(de);
            elValue = he.textContent;
        }

        let isValid = GmCXt.ruleEngine.validateElRule(condition, value, he, elValue, GmCXt.legacyWildChar(de.version));

        if (rule.type === "Select Table" && isValid) {
            return validateColumnRules(he, rule, jobId);
        }
        return isValid;
    }

    function addAttrsForIntel(el, req) {

        let tourId = req.data.tourId;
        let stepId = req.data.requestId;
        let wfId = el.getAttribute('wfId');

        let jobId = "_" + req.data.requestId;
        let job = jobs[jobId];

        if (!wfId) {
            wfId = [];
        } else {
            wfId = GmCXt.parseJSON(wfId);
        }

        //check if step event already added
        let eventExist = false;
        wfId.forEach(function(m) {
            if (m.stepId == stepId) {
                GmCXt.log(28, "EVENT EXIST " + GmCXt.stepLog(stepId, tourId));
                eventExist = true;
                return;
            }
        });

        if (eventExist) return;

        wfId.push({
            tourId: tourId,
            stepId: stepId
        });

        job.req.data.wfId = wfId;

        el.setAttribute('wfId', JSON.stringify(wfId));
    }

    function removeActiveEvents(elem) {

        mg$(elem).off("mouseup", onMouseUpRightClickElement);
        let aTags = mg$(elem).find('a');

        if (aTags.length === 1) {
            aTag = aTags[0];
            mg$(aTag).off("mousedown touchstart", onMouseUpElement);
            mg$(aTag).off("mouseup touchend", onMouseUpElement);
        } else {
            mg$(elem).off("mouseup touchend", onMouseUpElement);
            mg$(elem).off("mousedown touchstart", onMouseUpElement);
        }
        mg$(elem).off("click", onMouseUpElement);
        mg$(elem).off("change", onChangeElement);
        mg$(elem).off("mouseover", onMouseOverElement);
    }

    pub.triggerDomClick = function(d) {

        let jobId = "_" + d.requestId;
        let job = jobs[jobId];

        if (job && job.resp) {
            let req = job.req;
            GmCXt.triggerClick(job.resp.he, req);
        }
    };

    function addToTriggeredList(sId, val) {
        autoTriggered[sId] = val;
    }

    pub.removeBeaconJob = function(tourId) {

        let jobId = "_" + tourId;
        let job = jobs[jobId];
        if (job) {
            let rd = job.req.data;
            let tourTitle = rd.tourTitle;
            var beaconImg = mg$(".mgPlayerJSProd_beacon-icon.mgPlayerJSProd_beacon-icon-tour-" + rd.tourId);

            removeBeacon(jobId, rd, beaconImg, tourTitle);
        } else {
            var beaconImg = mg$(".mgPlayerJSProd_beacon-icon.mgPlayerJSProd_beacon-icon-tour-" + tourId);

            if (beaconImg.length) {
                removeBeacon(jobId, null, beaconImg, null, tourId);
            }

        }
    };

    pub.clearIframeWatch = function() {
        for (let id in jobs) {

            let job = jobs[id];

            if (job.state === 'watchSmarttip') {

                let data = job.req.data;
                if (data.settings.smartTip && data.settings.smartTip.type === 'validation') {
                    GmCXt.hideValidationTooltip(data.step);
                }
                let smartTip = data.settings.smartTip;
                GmCXt.updateOnScreenTooltipGuideInfo(data.tour, data.tour.tour_id, id.slice(1), false, smartTip);
            }
        }
    };

    return pub;
})();
// This code is executed only once, immediately after content script is injected
// into a webpage.
/*global GmCXt,mg$*/
GmCXt.bootScript = function() {

    GmCXt.domElStore = [];

    // Add a unique identifier to each content script loaded in various frames.
    if (GmCXt.id === undefined) {
        let idPref = 'GmCXt-';
        if (window.self !== window.top) {
            idPref = "I" + idPref;
        }
        GmCXt.id = idPref + parseInt(Math.random() * 100000);
    }

    // Returns a function, that, as long as it continues to be invoked, will not
    // be triggered. The function will be called after it stops being called for
    // N milliseconds. If `immediate` is passed, trigger the function on the
    // leading edge, instead of the trailing.
    GmCXt.debounce = function(func, wait, immediate) {
        let timeout;
        return function() {
            let context = this,
                args = arguments;
            let later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            let callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = GmCXt.timeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    if (window.self === window.top) {
        // Global window message listener to initialise ports communication
        window.addEventListener('message', function(e) {
            if (e.data && typeof e.data === 'string') {
                if (e.data.includes('action":"myguide_action:paste_tour_from_myguide_library')) {
                    if (!GmCXt.FT.isPlayer) GmCXt.listenTopWinCreator(e);
                }
            }
            if (!e.ports.length) return;
            switch (e.data) {
            case 'Guide:workerSelf':
                GmCXt.workerSelfPort = e.ports[0];
                GmCXt.workerSelfPort.onmessage = GmCXt.FT.isPlayer ? GmCXt.listenTopWinPlayer : GmCXt.listenTopWinCreator;
                break;

            case 'Guide:audioIframe':
                GmCXt.audioPort = e.ports[0];
                GmCXt.audioPort.onmessage = GmCXt.FT.isPlayer ? GmCXt.listenTopWinPlayer : GmCXt.listenTopWinCreator;
                break;
            }
            if (e.data && typeof e.data === 'string' && e.data.indexOf('Guide:newIframe-') !== -1) {
                let iframeId = e.data.substr(16);
                GmCXt.iframePorts[iframeId] = e.ports[0];
                GmCXt.iframePorts[iframeId].onmessage = GmCXt.FT.isPlayer ? GmCXt.listenTopWinPlayer : GmCXt.listenTopWinCreator;
                GmCXt.iframeEls[iframeId] = e.source;
                GmCXt.requestHandler.newIframeFound(iframeId);
            }
        });
    }

    //Need to delay this or send from another file after GmCXt.main() has completed loading since its top-window receiver is in that function
    let sendIframeInitialiseMessage = function() {
        if (window.self !== window.top) {
            if (mg$(window).width() >= 1 || mg$(window).height() >= 1) {

                let msg = 'Guide:newIframe-' + GmCXt.id;
                if (window.parent !== window.top) {
                    try {
                        window.parent.postMessage(msg, '*', [GmCXt.msgChannel.port2]);
                    } catch (e) { 

                    }
                } else {
                    try {
                        window.top.postMessage(msg, '*', [GmCXt.msgChannel.port2]);
                    } catch (e) {
                        
                    }
                }
            }
        }
    };

    GmCXt.timeout(sendIframeInitialiseMessage, GmCXt.t_.ms5);

    mg$(window).on('pagehide', function() {
        let pi = GmCXt.playerI;
        if (pi) {
            if (GmCXt.currentIframeId === GmCXt.id) {
                GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:close_step');
            }
        }
        GmCXt.highlighter.clearIframeWatch();
    });

    if (GmCXt.FT.creatorApp) {
        mg$(window).on('keyup', function(e) {
            if (e.which === 16) {
                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:toggle_capture_and_navigate_tool:inform');
            }
        });
    }

    GmCXt.clickEl = null;

    GmCXt.onClickOnPage = function(e) {

        if (GmCXt.conf.appConfig.desktopCommunication) {
            let m = {
                action: "mgPlayerJSProd_action:Establish_desktop_connection",

            };

            GmCXt.sendMessageToBackgroundService(m);
        }

    	if (window.self === window.top) {
            GmCXt.resetIdleActivityTimer();
        } else {
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:reset_activity_timer');
        }


        if (!GmCXt.checkPrecedence()) {
            return;
        }

        let el = mg$(e.target);

        // Disable Insights: click and workflow tracking
        //if (GmCXt.isPlayer() && GmCXt.domainInApp && GmCXt.trackerUtil && GmCXt.trackerUtil.pageTracking) {
        //GmCXt.mutationObserver(e.target);
        //}

        if (!GmCXt.isClickInStepPopup(e) && !GmCXt.isClickInSurveyPopup(e) && !GmCXt.playerI?.targetElement) {
            let d = GmCXt.highlighter.onDocumentClick(e);
            if (GmCXt.playerI) {
                GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:click_event_for_guide', d);
            }

            GmCXt.highlighter.onDocumentClickForTooltip(e);
        }
        if (GmCXt?.playerI?.targetElement) {
            delete GmCXt.playerI.targetElement;
        }

        if (GmCXt.user && !GmCXt.isGmElement(el) && !GmCXt.isMyGuideAction()) {
            if (window.self === window.top) {
                GmCXt.triggerChangeListeners('page_click');
            } else {
                GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:page_clicked');
            }

            if (GmCXt.FT.isPlayer) {
                let tagDetails = GmCXt.isTagged(el);
                if (tagDetails) {
                    let data = GmCXt.getTagStepAndTourId(tagDetails);
                    GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:set_feature_tag_storage', data);
                }
            }
        }
    };

    window.addEventListener("mouseup", GmCXt.onClickOnPage, true);
    document.addEventListener('mousedown', GmCXt.onDocumentMouseDown);

    if (window.self !== window.top) {

        GmCXt.msgChannel.port1.onmessage = GmCXt.FT.isPlayer ? GmCXt.listenIframePlayer : GmCXt.listenIframeCreator;

        // Global window message listener to initialise ports communication
        window.addEventListener('message', function(e) {
            if (!e.ports.length) return;

            if (e.data && typeof e.data === 'string' && e.data.indexOf('Guide:newIframe-') !== -1) {
                let iframeId = e.data.substr(16);
                GmCXt.iframePorts[iframeId] = e.ports[0];
                GmCXt.iframePorts[iframeId].onmessage = GmCXt.FT.isPlayer ? GmCXt.listenIframePlayer : GmCXt.listenIframeCreator;
                GmCXt.iframeEls[iframeId] = e.source;
                try {
                    window.parent.postMessage(e.data, "*", e.ports);
                } catch (e) {

                }
            }
        });
    }

    window.addEventListener('error', function(event) {
        if (event && event.target) {
            GmCXt.onImageLoadError(mg$(event.target));
        }
    }, true);
};

try {
    if (GmCXt._location().href.indexOf('echosign.com') !== -1 || GmCXt.isWestpacOneUI()) {
        console.dir("MG script is not loaded in " + GmCXt._location().href);
    } else {
        GmCXt.bootScript();
    }
} catch (e) {
    GmCXt.bootScript();
}

/**
	* @file DOM selector module
	* @author Nilesh Pachpande
	*/
/*global GmCXt,mg$*/
GmCXt.selector = function(options) {

    options = options || {};

    let pub = {};

    let self = {
        cb: options.cb || false,
        id: 'r_' + Math.floor(Math.random() * 100000),
        elements: {},
        frame: options.frame,
        identifier: options.identifier,
        type: options.type,
        isQuick: options.isQuick
    };

    let shadowRoots = [];

    let currentHe;

    let clickedElementData = null;

    let listenerEl;

    pub.status = 'inactive';

    pub.documentClickEventFlag = false;

    pub.start = function() {
        pub.status = 'active';
        listenerEl = 'body';
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:dom_selctor_started');
        showOutline();
        createOutlineElements();
        subscribeEvents();
    };

    pub.stop = function() {
        GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:dom_selctor_stopped');
        unsubscribeEvents();
    };

    pub.setCurrentHe = function() {
        self.he = GmCXt.currentHe;
    };

    pub.removeOutline = function() {
        mg$('.mgPlayerJSProd_select-tool-outline').remove();
    };

    pub.removeOutlineNew = function() {
        mg$('.mgPlayerJSProd_new-outline').remove();
    };

    pub.hideOutline = function() {
        mg$('.mgPlayerJSProd_select-tool-outline').hide();
    };

    pub.clearBlackoutArea = function() {
        mg$('.mgPlayerJSProd_selector-blackout').remove();
    };

    pub.removeBlackoutOutline = function() {
        mg$('.mgPlayerJSProd_blackout-tool-outline').remove();
    };

    pub.removeRulesEngineOutline = function() {
        mg$('.mgPlayerJSProd_rules-engine-tool-outline').remove();
    };

    pub.getElementPrecision = function(criteria) {
        let el = null;

        if (self.labelData && self.labelData.labelHe && self.labelData.pathFromLabel) {
            el = GmCXt.dom.getElement(self.labelData.labelHe, criteria, self.frame);
            if (el) {
                el.pathFromLabel = self.labelData.pathFromLabel;
                el.targetInfo = self.labelData.targetInfo;
                el.customSettings = self.customSettings;
            }
        } else {
            el = GmCXt.dom.getElement(self.he, criteria, self.frame);
        }

        return el;
    };

    pub.getElemenetUsingJQ = function(jQ, openPanel) {
        let checkjQ = validateJQuery(jQ);
        var message = {
            found: false,
            openPanel: openPanel
        };
        if (checkjQ.he) {
            self.he = checkjQ.he;
            let pos = GmCXt.getAbsoluteRectFromIframe(checkjQ.he);
            createOutline(checkjQ.he, pos);
            showOutline();

            if (openPanel) sendResponse(jQ);

            var message = {
                found: true,
                openPanel: openPanel
            };
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:clear_invalid_jQuery_message;action:inform', message);
        }

        if (checkjQ.nodeCount > 1) {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:show_unique_elem_not_found;action:inform');
        }
    };

    function showChangedElement(he) {
        createOutlineElements();
        createOutline(he);
        showOutline();
        unsubscribeEvents();
        return pub.getElData(he);
    }

    pub.expandElementSelection = function(he) {
        if (!currentHe && he) {
            currentHe = he;
        }

        if (currentHe) {
            self.labelData = null;
            self.he = currentHe.parentElement;
            if (!currentHe.hasAttribute('gm_visited')) {
                currentHe.setAttribute('gm_visited', 'true');
            }
        }
        self.he.setAttribute('gm_visited', 'true');

        return showChangedElement(self.he);
    };

    pub.narrowElementSelection = function(he) {
        if (currentHe) {
            self.he = currentHe;
        } else if (he) {
            self.he = he;
        }

        if (self.he.childElementCount === 1 || mg$(self.he).children('[gm_visited="true"]').length) {
            if (self.he.hasAttribute("gm_visited")) {
                self.he.removeAttribute("gm_visited");
            }

            self.labelData = null;

            if (mg$(self.he).children('[gm_visited="true"]').length) {
                self.he = mg$(self.he).children('[gm_visited="true"]')[0];
            } else
                self.he = self.he.children[0];

        }
        return showChangedElement(self.he);

    };

    function subscribeEvents() {
        self.elementSelected = false;

        unsubscribeEvents();
        window.addEventListener('click', stopEventPropagationforClickEvent, true);
        window.addEventListener('mousedown', documentClickEvent, true);
        window.addEventListener('mouseup', stopEventPropagation, true);

        window.addEventListener('blur', stopEventPropagation, true);
        window.addEventListener('focusout', stopEventPropagation, true);
        window.addEventListener('focus', stopEventPropagation, true);

        let siblings = mg$('body').siblings();
        let skip = ['STYLE', 'HEAD'];
        for (let i = 0; i < siblings.length; i++) {
            let node = siblings[i];

            if (!(skip.includes(node.nodeName) || GmCXt.isMyGuideEl(node) )) {
                listenerEl = 'html';
                break;
            }
        }

        if (GmCXt.stepReq && GmCXt.stepReq.action && GmCXt.stepReq.action.includes('type:automation')) {
            listenerEl = 'html';
        }

        mg$(document).on('mouseenter', onBodyMouseEnter)
            .on('mouseleave', hideOutline);

        mg$(listenerEl).on('mouseenter', onBodyMouseEnter)
            .on('mousemove mouseover', updateOutlinePosition)
            .on('mouseleave', hideOutline)
            .on('keyup', stopOnEscape)
            .one('mousemove', onBodyMouseEnter);

    }

    let removeAllShadowRootEvents = function() {
        for (let i = 0; i < shadowRoots.length; i++) {
            shadowRoots[i].shadowRoot.removeEventListener('mousemove', updateOutlinePosition);
        }
    };
    function getSvgParentIfChild(node) {
        if (!node || node.nodeType !== 1) return null;

        const tag = node.nodeName.toLowerCase();

        // If it's the <svg> element itself, return it directly
        if (tag === 'svg') return node;

        // For nested elements (<path>, <g>, etc.), find the ancestor <svg>
        const svgAncestor = node.closest && node.closest('svg');
        return svgAncestor || null;
    }

    /**
     * Checks whether a node is a child of an SVG element (not the SVG itself)
     */
    function isSvgChild(node) {
        const svgParent = getSvgParentIfChild(node);
        return !!svgParent && svgParent !== node;
    }


    function unsubscribeEvents() {
        self.elementSelected = false;

        window.removeEventListener('click', stopEventPropagationforClickEvent, true);
        window.removeEventListener('mousedown', documentClickEvent, true);
        window.removeEventListener('mouseup', stopEventPropagation, true);

        window.removeEventListener('blur', stopEventPropagation, true);
        window.removeEventListener('focusout', stopEventPropagation, true);
        window.removeEventListener('focus', stopEventPropagation, true);
        window.removeEventListener('mouseout', stopEventPropagation, true);

        mg$(document).off('mouseenter', onBodyMouseEnter)
            .off('mouseleave', hideOutline);

        mg$(listenerEl).off('mouseenter', onBodyMouseEnter)
            .off('mousemove mouseover', updateOutlinePosition)
            .off('mouseleave', hideOutline)
            .off('keyup', stopOnEscape);

        removeAllShadowRootEvents();
    }

    function onBodyMouseEnter() {
        if (!GmCXt.jQElementFound && !GmCXt.enableNavigateTool) {
            mg$('.mgPlayerJSProd_select-tool-outline').show();

            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:clear_outline;action:inform', {
                scriptId: GmCXt.id
            });
        }
    }

    function stopOnEscape(e) {
        if (e.keyCode === 27) {
            pub.stop();
            GmCXt.displayWidget();

            GmCXt.clearStepReqObj();

            GmCXt.timeout(function() {
                GmCXt.toggleStepSelectionToolbar(false);
            }, 1000);

            pub.removeOutline();
            pub.clearBlackoutArea();
            GmCXt.selectorTool.status = 'inactive';
        }
    }

    function hideOutline() {
        if (!GmCXt.jQElementFound)
            mg$('.mgPlayerJSProd_new-outline').hide();
    }

    function showOutline() {
        mg$('.mgPlayerJSProd_select-tool-outline').show();
    }

    function stopEventPropagationforClickEvent(e) {
        if (clickOnToolbar(e)) {
            return;
        }

        if (!pub.documentClickEventFlag) {
            documentClickEvent(e);
        }

        stopEventPropagation(e);
    }

    function stopEventPropagation(e) {
        if (GmCXt.enableNavigateTool === true || clickOnToolbar(e)) {
            return;
        }

        let stop = true;

        if ((GmCXt.stepReq?.isDesktop && GmCXt.stepReq?.isWebHowto) || self.isQuick) {
            stop = false;
        }

        if (stop) {
            e.preventDefault();
            e.stopImmediatePropagation();
        }
    }

    function clickOnToolbar(e) {

        let toolbar = document.getElementsByClassName('mgPlayerJSProd_toolbar-body');

        try {
            if (!GmCXt.isEmpty(toolbar) && toolbar[0].contains(e.target)) {
                return true;
            } else {
                return false;
            }
        } catch {
            return false;
        }
    }

    function clickOnTooltip(e) {

        if (e.target.className === 'ok-got-it' ||
			e.target.className === 'mgPlayerJSProd_toolbar-close') {
            return true;
        } else return false;
    }

    function documentClickEvent(e) {

        if (GmCXt.enableNavigateTool === true || clickOnToolbar(e)) return;

        if (!self.he) return;
        let stop = true;

        if ((GmCXt.stepReq?.isDesktop && GmCXt.stepReq?.isWebHowto) || self.isQuick) {
            clickedElementData = pub.getElData(self.he);
            let xpath = clickedElementData.element.xpath;
            GmCXt.log(74, 'Capturing  screenshot for xpath: ' + xpath);
            mg$('.mgPlayerJSProd_toolbar-panel').hide();
            GmCXt.takeScreenshot(xpath).then(function(imageSrc) {
                mg$('.mgPlayerJSProd_toolbar-panel').show();
                GmCXt.screenshotDetails = {
                    xpath: xpath,
                    imageSrc:imageSrc
                };
                sendResponse();
            });
            stop = false;
        }

        if (clickOnTooltip(e)) {
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:hide_guideme_toolbar_tooltip');
            return;
        }

        if (!GmCXt.user && !(GmCXt.stepReq.isDesktop && GmCXt.stepReq.isWebHowto)) {
            GmCXt.sendMessageToParentWindow('mgPlayerJSProd_action:stop_inline_step_selection_mode');
            return;
        }

        if (stop) {
            e.preventDefault();
            e.stopImmediatePropagation();
        }

        if (!self.he) return;

        if (self.elementSelected) return;

        self.elementSelected = true;

        GmCXt.timeout(function() {
            pub.stop();
        }, 1000);

        window.addEventListener('mouseout', stopEventPropagation, true);

        self.he = GmCXt.skipTags(self.he);
        if (self.type === 'table' && self.he.tagName != 'TABLE') {
            skipToTableTag();
        }

        bringElementInViewport();
        if (!GmCXt.conf.appConfig.desktopCommunication ) {
            sendResponse();
        }

        pub.documentClickEventFlag = true;
    }

    function skipSlot() {
        if (self.he.tagName === 'SLOT') {
            if (self.he.parentNode instanceof ShadowRoot) {
                self.he = self.he.parentNode.host;
            } else {
                self.he = self.he.parentNode;
            }
        }
    }

    function skipToTableTag() {
        let he = self.he;
        let i = 0;
        while (i < 15 && he.parentNode) {
            if (!he.parentNode) break;
            if (he.tagName === 'TABLE') {
                self.he = he;
                break;
            }
            he = he.parentNode;
        }
    }

    function validateJQuery(jQ) {
        let he;
        let found = false;
        let len = 0;
        try {

            let nodes = GmCXt.getNodeFromIframeQuery(jQ);

            len = nodes.length;
            if (!len) {
                if (jQ.indexOf(':visible') === -1) {
                    jQ += ':visible';
                }
                nodes = mg$(jQ);
            }

            if (GmCXt.isOne(nodes)) {
                he = nodes[0];
                found = true;
            }
        } catch (error) {
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:clear_invalid_jQuery_message;action:inform', {
                found: found
            });
        }
        let returnObj = {
            he: he,
            nodeCount: len,
            found: found
        };
        return returnObj;
    }

    function checkSfSelectEl(el) {
        if (GmCXt.checkSalesForceSite() && el.customSettings && el.customSettings.salesforce) {
            return el.customSettings.salesforce.customSelect;
        }
    }

    function findLabelElement(he, el) {

        let data = null;
        let workdayInput = GmCXt.checkWorkdayTextfield(el);
        let customSelect = checkSfSelectEl(el);
        let isSFTextArea = GmCXt.dom.sfTextArea(el);
        let origHe = he;

        if ((he.tagName === 'INPUT' && (he.type !== 'submit' && he.type !== 'button')) ||
			he.tagName === 'SELECT' ||
			he.tagName === 'TEXTAREA' ||
			he.tagName === 'BUTTON' || workdayInput || customSelect || isSFTextArea) {

            let labelElements = mg$('label:visible');
            let siblings = mg$(he).siblings();
            let labelSiblings = siblings.filter(labelElements);
            let labelChildren = siblings.find(labelElements);

            var pathFromLabel = [];
            var labelHe = null;
            var pathFromChildLabel = 0;

            if (mg$(he).find('label').length === 1 && workdayInput &&
				mg$(he).find('input, select, TEXTAREA').length === 1) {
                labelHe = mg$(he).find('label')[0];

                let tempLabel = labelHe;
                while (tempLabel && tempLabel !== he) {
                    pathFromChildLabel++;
                    tempLabel = tempLabel.parentNode;
                }
            }

            if (!pathFromChildLabel) {

                if (labelSiblings.length === 1) {
                    labelHe = labelSiblings[0];
                    pathFromLabel.push(-1);
                } else if (labelChildren.length === 1) {
                    labelHe = labelChildren[0];
                    pathFromLabel.push(-1);
                } else {
                    let parent = null;
                    var obj = {};
                    let tempHe = null;

                    if (checkHost() && (customSelect || isSFTextArea)) {
                        obj = labelElForSalesForce(he, customSelect, isSFTextArea);
                        pathFromLabel = obj.pathFromLabel;
                        he = obj.he;

                    } else if (GmCXt.checkWorkdaySite() && workdayInput) {
                        var obj = labelPathForWorkday(he, el, parent);
                        pathFromLabel = obj.pathFromLabel;
                        he = obj.he;
                    }

                    if (!pathFromLabel.length) {
                        var level = checkHost() ? 7 : 4; // Find label up to level 4 || 7(for salesforce)
                        tempHe = origHe;

                        while (!tempHe.previousElementSibling && level > 0) {
                            parent = tempHe.parentNode;
                            level--;
                            let index = getIndexInParent(parent, tempHe);
                            if (index !== -1) {
                                pathFromLabel.push(index);
                                tempHe = parent;
                            }
                            if (checkHost() && tempHe.tagName === 'TD') {
                                break;
                            }
                        }
                    }

                    if (pathFromLabel.length && !tempHe) {
                        tempHe = he;
                    }

                    if (tempHe && mg$(tempHe).siblings().length > 0 && tempHe.previousElementSibling) {
                        labelHe = tempHe.previousElementSibling;
                        if (workdayInput || isSFTextArea) {

                            labelHe = mg$(labelHe).find('label')[0] || labelHe;
                        }
                    }
                }

            }
        }

        if ((pathFromLabel && pathFromLabel.length) || pathFromChildLabel) {

            if (!pathFromLabel.length) {
                pathFromLabel = pathFromChildLabel;
            }

            if (labelHe && mg$(labelHe).is(':visible') &&
				(GmCXt.validateText(labelHe.textContent) ||
					GmCXt.validateText(escapeNonTextNodes(labelHe)))) {
                data = {
                    targetInfo: {
                        tagName: origHe.tagName,
                        type: origHe.type
                    },
                    labelHe: labelHe,
                    pathFromLabel: pathFromLabel
                };
            }
        }

        return data;
    }

    function escapeNonTextNodes(labelHe) {
        let nodeList = labelHe.childNodes;
        let length = nodeList.length;
        let str = '';
        let i = 0;
        let text = false;

        while (i < length) {
            if (nodeList[i].nodeType === Node.TEXT_NODE) {
                str += nodeList[i].nodeValue;
                text = true;
            } else if (text) {
                break;
            }
            i++;
        }
        return str.trim();
    }

    function checkHost() {
        let host = GmCXt._location().hostname;

        return host.indexOf("csod.com") !== -1 ||
			host.indexOf("salesforce.com") !== -1 ||
			host.indexOf("force.com") !== -1;
    }

    function labelElForSalesForce(he, customSelect, isSFTextArea) {
        let pathFromLabel = [];
        let level = 7;

        function getParent(he) {
            let parent = he.parentNode;
            level--;
            let index = getIndexInParent(parent, he);
            if (index !== -1) {
                pathFromLabel.push(index);
                he = parent;
            }
            return he;
        }

        if (isSFTextArea) {
            level = 5;
            while (he && !he.matches('.blockDiv') && level > 0) {
                level--;
                he = he.parentNode;
            }
            if (he && he.matches('.blockDiv')) {
                he = getParent(he);
            }

        } else {
            if (customSelect) {
                switch (customSelect) {
                case 1:
                    while (!he.matches('.slds-form-element__control') && level > 0) {
                        he = getParent(he);
                    }
                    break;

                case 2:
                    while (!he.matches('.uiInputDate') && level > 0) {
                        he = getParent(he);
                    }
                    break;

                case 3:
                    while (!he.matches('.uiMenu') && !he.previousElementSibling &&
							level > 0) {
                        he = getParent(he);
                    }
                    break;

                case 4:
                    while ((!he.matches('.contentWrapper') || !he.matches('.slds-form-element')) && level > 0) {
                        level--;
                        he = he.parentNode;
                        if (he && he.matches('.contentWrapper') || he.matches('.slds-form-element')) {
                            he = getParent(he);
                            break;
                        }
                    }
                    break;
                }
            }
        }

        let obj = {
            pathFromLabel: pathFromLabel,
            he: he
        };
        return obj;
    }

    function getPathFromLabel(he, parent) {
        let pathFromLabel = [];
        while (!he.previousElementSibling && checkOffset(he)) {
            parent = he.parentNode;
            let index = getIndexInParent(parent, he);
            if (index !== -1) {
                pathFromLabel.push(index);
                he = parent;
            }
        }

        let returnObj = {
            pathFromLabel: pathFromLabel,
            he: he
        };

        return returnObj;
    }

    function labelPathForWorkday(he, el, parent) {
        let workday = el.customSettings.workday;
        let pathFromLabel = [];
        var obj = {};
        if (workday.isTextarea) {
            var level = 5;
            while (!he.previousElementSibling || (he.previousElementSibling.tagName !== 'TEXTAREA') && level > 0) {
                parent = he.parentNode;
                level--;
                var index = getIndexInParent(parent, he);
                if (index !== -1) {
                    pathFromLabel.push(index);
                    he = parent;
                }
            }
            if (he.previousElementSibling.tagName === 'TEXTAREA') {
                parent = he.parentNode;
                var index = getIndexInParent(parent, he);
                if (index !== -1) {
                    pathFromLabel.push(index);
                    he = parent;
                }
                var obj = getPathFromLabel(he, parent);
                pathFromLabel = pathFromLabel.concat(obj.pathFromLabel);
            }

        } else if (workday.isWDCustomSelect) {

            var level = 8;

            while (mg$(he).attr('data-automation-id') !== "multiselectInputContainer" &&
				mg$(he).find('[data-automation-id= "multiselectInputContainer"]').length !== 1 &&
				level > 0) {
                parent = he.parentNode;

                level--;
                he = parent;
            }

            level = 8;
            while (!he.previousElementSibling && level > 0) {
                parent = he.parentNode;
                var index = getIndexInParent(parent, he);
                if (index !== -1) {
                    pathFromLabel.push(index);
                    he = parent;
                }
            }

            var obj = getPathFromLabel(he, parent);
            pathFromLabel = pathFromLabel.concat(obj.pathFromLabel);

        } else {
            if (he.previousElementSibling && he.previousElementSibling.type === 'checkbox') {
                he = he.parentNode;
            }
            var obj = getPathFromLabel(he, parent);
            pathFromLabel = obj.pathFromLabel;
        }

        let returnObj = {
            pathFromLabel: pathFromLabel,
            he: obj.he
        };

        return returnObj;
    }

    function checkOffset(he) {
        let parent = he.parentNode;
        let Xdiff = Math.abs(mg$(parent).offset().top - mg$(he).offset().top);
        let Ydiff = Math.abs(mg$(parent).offset().left - mg$(he).offset().left);

        return Xdiff < 30 && Ydiff < 30;
    }

    function getIndexInParent(parent, he) {
        if (parent && parent.childNodes) {
            for (let i = 0, len = parent.childNodes.length; i < len; ++i) {
                if (parent.childNodes[i] === he) {
                    return i;
                }
            }
        }
        return -1;
    }

    function scoreUpdate(he, el) {
        m = el.meta;
        c = el.criteria;
        if (m.score < 3) {
            c.jquery_selector = m.textNode.jquery_selector;
            m.jqueryInfo = GmCXt.dom.getJqueryEqInfo(he, c.jquery_selector);
            m.score = GmCXt.dom.getCustomQueryScore(m.jqueryInfo);
        }
        return el;
    }

    function getText(he, el) {

        let textData = {};

        if (self.identifier === "rules-engine-request") {
            textData.ruleElText = GmCXt.getElementText(he);
        }

        let text = he.textContent || he.placeholder;

        if (!text && (he.type === 'submit' || he.type === 'button')) text = he.value;

        if (text) {
            text = text.trim();
        }

        if (GmCXt.checkWorkdayTextfield(el, self.identifier) || checkSfSelectEl(el) || GmCXt.dom.sfTextArea(el)) {
            text = "";
        }

        textData.elText = text;

        return textData;
    }

    pub.getElData = function(he) {

        let el = GmCXt.dom.getElement(he, null, self.frame);

        if (he.jQuery) {
            GmCXt.dom.setDefaultCriteria();
            GmCXt.dom.matchCriteria = {
                precision_type: GmCXt.DOM_CRITERIA_CUSTOM,
                precision_level: "High",
                jquery_selector: he.jQuery
            };
            el = GmCXt.dom.getElement(he, GmCXt.dom.matchCriteria, self.frame);
        }

        mg$(self.elements.score).remove();

        let textData = getText(he, el);

        self.labelData = null;

        self.he = he;

        if (!textData.elText || he.tagName === "SELECT") self.labelData = findLabelElement(he, el);

        let title = '';

        if (self.labelData) {
            let pos = mg$.extend(true, {}, el.position);
            let customSettings = el.customSettings;

            el = GmCXt.dom.getElement(self.labelData.labelHe, null, self.frame);
            el.position = pos;
            el.pathFromLabel = self.labelData.pathFromLabel;
            el.targetInfo = self.labelData.targetInfo;
            el.customSettings = customSettings;

            if (textData.ruleElText) el.targetInfo.text = textData.ruleElText;

            if (GmCXt.checkWorkdayTextfield(el)) {
                el = scoreUpdate(self.labelData.labelHe, el);
            }

            title = getTitleSuggestionForLabel(self.labelData.labelHe);

        } else {
            if ((he.tagName === "SELECT" && textData.elText) || self.type === 'variable') {
                el.criteria.ignoreText = true;
            }
            if (self.identifier === "rules-engine-request" && textData.ruleElText) {
                el.targetInfo = {
                    text: textData.ruleElText
                };
            }

            title = getTitleSuggestion();
        }

        el.elOptions = GmCXt.getElOptions(he);

        let data = {
            id: self.id,
            element: el,
            titleSuggestion: title,
            he: he
        };

        currentHe = he;
        if (!self.identifier) {
            GmCXt.currentHe = currentHe;
        }
        mg$('.mgPlayerJSProd_new-outline').removeClass('mgPlayerJSProd_new-outline');
        return data;
    };

    function sendResponse(jQuery) {
        function r_cb() {
            if (self.cb.length === 2) {
                let autoCorrectData = {
                    he: data.he,
                    frame: self.frame
                };
                self.cb(data, autoCorrectData);
            } else {
                self.cb(data);
            }
        }

        var he = self.he;


        if(jQuery) he.jQuery = jQuery;

        var data;
        if(!GmCXt.isEmpty(clickedElementData)){
            data = clickedElementData;
            clickedElementData = null;
        }else{
            data = pub.getElData(he);
        }

		  var inTopWindow = data.element.meta.inTopWindow;

        if (inTopWindow) {
            r_cb();
        } else {
            setTimeout(function() {
                r_cb();
            }, 600);
        }
    }

    function getTitleSuggestionForLabel() {
        let text = self.labelData.labelHe.textContent.trim();

        if (!GmCXt.validateText(text) && GmCXt.validateText(escapeNonTextNodes(self.labelData.labelHe))) {
            text = escapeNonTextNodes(self.labelData.labelHe);
        }

        let prefix = "";
        if (self.he) {
            if (self.he.tagName === "INPUT" || self.he.tagName === 'TEXTAREA') {
                prefix = "Enter ";
            } else if (self.he.tagName === "SELECT") {
                prefix = "Select ";
            }
        }

        return {
            prefix: prefix,
            text: text
        };
    }

    // Brings elements in viewport which are partly visible
    function bringElementInViewport() {
        try {
            if (!mg$(self.he).is(':visible') && mg$(self.he).height() < screen.height) {
                self.he.scrollIntoView();
                let rect = self.he.getBoundingClientRect();

                // To vertically center align the selected element
                let scrollBy = (mg$(window).height() - rect.height) / 2;
                if (scrollBy > 0 && scrollBy !== rect.top) {
                    window.scrollBy(0, -scrollBy);
                }
            }
        } catch (e) {}
    }

    function getTitleSuggestion() {
		  if (!GmCXt.label) GmCXt.label = GmCXt.getCreatorLabels();

        let text = '';
        let prefix = '';

        if (self.he) {

            if ((self.he.tagName === 'INPUT' && self.he.type === 'text') ||
				self.he.tagName === 'TEXTAREA') {

                if (self.he.placeholder) {
                    text = self.he.placeholder;
                } else {
                    text = self.he.name;
                    prefix = GmCXt.label.preEnter;
                }

            } else if ((self.he.tagName === 'INPUT' || self.he.tagName === 'BUTTON') &&
				(self.he.type === 'button' || self.he.type === 'submit')) {

                prefix = GmCXt.label.preClickOn;
                text = self.he.value || self.he.textContent;

            } else if (self.he.tagName === 'INPUT' && (self.he.type === 'checkbox' || self.he.type === 'radio')) {

                prefix = GmCXt.label.select;
                text = self.he.textContent;

            } else if (self.he.tagName === 'SELECT' && self.he.type === 'select-one') {
                prefix = GmCXt.label.select;
                text = self.he.name;

            } else if (self.he.name) {
                prefix = GmCXt.label.preClickOn;
                text = self.he.name;

			  } else if (self.he.textContent) {
				  prefix = GmCXt.label.preClickOn;
				  text = self.he.textContent;
			  }

            if(text === '' && prefix === ''){
                prefix =  GmCXt.label.preClickOn;
                text ='';
            }

            text = text.trim().substring(0, 230);
        }

        return {
            prefix: prefix,
            text: text
        };
    }

    let showingScoreOf = null;

    function setConfidenceScoreCss(color, score) {
        mg$('.mgPlayerJSProd_scoreEl').css({
            boxShadow: "#a0a0a0 2px 2px 5px 0px",
            display: "block",
            position: "relative",
            fontSize: "12px",
            width: "40px",
            height: "40px",
            "border-radius": "50%"
        });

        mg$('.mgPlayerJSProd_figcaption').css({
            "text-align": "center",
            color: color,
            width: "100%",
            position: "absolute",
            left: "0",
            top: "32%",
            zIndex: "2",
            "font-family": "Arial",
            "font-weight": "bold"
        });

        mg$('.mgPlayerJSProd_scoreEl svg').css({
            display: "block",
            height: "100%",
            width: "100%",
            position: "absolute",
            top: "0",
            left: "0",
            overflow: "visible"
        });

        if (mg$('.mgPlayerJSProd_circle').css('stroke-dashoffset') === '0px') {
            mg$('.mgPlayerJSProd_circle').css({
                stroke: color,
                fill: 'rgba(0,0,0,0)',
                'stroke-width': '15%',
                'stroke-dashoffset': '25'
            });
        } else {
            mg$('.mgPlayerJSProd_circle').css({
                background: '#fff',
                "animation": "mgPlayerJSProd_pie" + score + " 4s infinite ease both",
                "-webkit-animation": "mgPlayerJSProd_pie" + score + " 2s infinite ease both"
            });
        }
    }

    function showConfidenceScore(he, pos) {
        function getElAttrHtml(){
            let html = '';
            for (let key in el.meta.elAttributes) {
                if(key && (key === "tagName" || key === "class" || key === "value")){
			  		html = html+'<wmgPlayerJSProd_> <wmgPlayerJSProd_ class="mgPlayerJSProd_element-attr-key">'+key+'</wmgPlayerJSProd_> <wmgPlayerJSProd_ class="mgPlayerJSProd_element-attr-val">'+el.meta.elAttributes[key]+'</wmgPlayerJSProd_></wmgPlayerJSProd_>';
			  	}
            }
            return html;
        }

        if (showingScoreOf === he) return;

        self.elements.score.html("");
        var hoverEl = true; // Do not log every element on hover
        var el = GmCXt.dom.getElement(he, null, self.frame, hoverEl);
        var sc = GmCXt.getMatchConfidence(el.meta.score);
        var el_attr_html = getElAttrHtml(el.meta.elAttributes);
        var htmlInspector = (GmCXt.organization && GmCXt.organization.admin_settings.html_inspector) || false;

        var scoreElHtml = '<div class="mgPlayerJSProd_scoreEl">' +
							'<figcaption class="mgPlayerJSProd_figcaption" style="color:' + sc.color + ';">' + sc.val + '</figcaption>' +
							'<svg viewBox="0 0 40 40">' +
								'<circle stroke="#f3f3f3" stroke-width="15%" fill="none" cx="20" cy="20" r="15"/>' +
								'<circle class="mgPlayerJSProd_pie1 ' + sc.class_ + ' mgPlayerJSProd_circle" cx="20" cy="20" r="15"/>' +
							'</svg>' +
						'</div>';

        var selectorScore = htmlInspector ?
            '<div class="mgPlayerJSProd_element-details-wrapper">'+
				'<div class="mgPlayerJSProd_element-attributes">'+
					el_attr_html +
				'</div>'+
					scoreElHtml+
			'</div>' : scoreElHtml;

        if(!pos){
            pos = he.getBoundingClientRect();
        }

        pos = mg$.extend(true, {}, pos);

        var css_ = {
            top: pos.top - 45,
            left: pos.left,
            background: "rgba(255, 255, 255, 0)"
        };

        if (pos.top < 35) {
            css_.top = pos.top + pos.height + 5;
        }

        if(htmlInspector){
            if(pos.left > window.innerWidth-230){
                css_.left = window.innerWidth-230;
            }
            css_.top = pos.top - 100;

            if (pos.top < 100) {
                css_.top = pos.top + pos.height + 5;
            }
        }

        self.elements.score.css(css_);

        mg$(selectorScore).appendTo(self.elements.score);

        setConfidenceScoreCss(sc.color, el.meta.score);

        showingScoreOf = he;
    }

    function createOutline(he, pos) {
        if (clickOnToolbar({target: he})) {
            pub.hideOutline();
            return;
        }

        if(!pos) {
            pos = he.getBoundingClientRect(); // already in top window
        }

        pos = mg$.extend(true, {}, pos);

        let b = 2;
        let backgroundColor = '';

        let os = GmCXt.getStepSettings();

        if (os) {
            b = os.selectorStyle.borderWidth;
            backgroundColor = os.selectorStyle.borderColor;
        }

        pos.top = pos.top - b;
        pos.left = pos.left - b;
        pos.width = pos.width + (b * 2);
        pos.height = pos.height + (b * 2);
        let position = 'fixed';

        self.elements.score.css({
            position: position
        });

        if (!GmCXt.conf.appConfig.desktopCommunication && GmCXt.stepReq?.action !== 'mgPlayerJSProd_action:create_step,type:quick') {
            showConfidenceScore(he, pos);
        }
        self.elements.top.css({
            top: Math.max(0, pos.top),
            left: pos.left,
            width: pos.width,
            height: b,
            background: backgroundColor,
            position: position
        });
        self.elements.bottom.css({
            top: pos.top + pos.height - b,
            left: pos.left,
            width: pos.width,
            height: b,
            background: backgroundColor,
            position: position
        });
        self.elements.left.css({
            top: pos.top,
            left: Math.max(0, pos.left),
            width: b,
            height: pos.height,
            background: backgroundColor,
            position: position
        });
        self.elements.right.css({
            top: pos.top,
            left: pos.left + pos.width - b,
            width: b,
            height: pos.height,
            background: backgroundColor,
            position: position
        });
	  }

    function updateOutlinePosition(e) {
        if(isSvgChild(e.target)){
            return;
        }

        onBodyMouseEnter(); // clear outline from other frame every time when mousemove or mouseover event occurs
        e.stopPropagation();

        if ((GmCXt.enableNavigateTool === true && !GmCXt.enableManualJQuerySelector) ||
			(GmCXt.enableManualJQuerySelector && !GmCXt.jQElementFound)) {
            hideOutline();
            return;
        } else if (GmCXt.jQElementFound) {
            return;
        }

        if (typeof e.target.className == "string" &&
			e.target.className.indexOf('mgPlayerJSProd_select-tool-outline') !== -1) {
            return;
        }

        if (e.target.tagName === 'IFRAME') {
            return;
        }

        if (e.target.shadowRoot && !shadowRoots.includes(e.target)) {
            e.target.shadowRoot.addEventListener('mousemove', updateOutlinePosition);
            shadowRoots.push(e.target);
        }

        showOutline();

        self.he = e.target;
        skipSlot();

        createOutline(self.he);
        GmCXt.unlockScroll();
	  }


    function createOutlineElements() {

        let c = 'mgPlayerJSProd_select-tool-outline ' + self.id + ' mgPlayerJSProd_new-outline';

        if (self.identifier && self.identifier == 'blackout-request') {
            c += ' mgPlayerJSProd_blackout-tool-outline';
        } else if (self.identifier && self.identifier === 'rules-engine-request') {
            c += ' mgPlayerJSProd_rules-engine-tool-outline';
        }
        let st = '';
        let div = '<wmgPlayerJSProd_ class="' + c + '"' + st + '></wmgPlayerJSProd_>';

        self.elements.top = mg$(div).appendTo('html');
        self.elements.bottom = mg$(div).appendTo('html');
        self.elements.left = mg$(div).appendTo('html');
        self.elements.right = mg$(div).appendTo('html');
        self.elements.score = mg$(div).appendTo('html');
    }
    return pub;
};

GmCXt.getMatchConfidence = function(score) {

    let val = '0/5';
    let color = '#ff0000';
    let class_ = 'mgPlayerJSProd_level-0';

    if (score === 5) {
        val = '5/5';
        color = '#0069d9';
        class_ = 'mgPlayerJSProd_level-5';
    } else if (score === 4) {
        val = '4/5';
        color = '#6bc9b8';
        class_ = 'mgPlayerJSProd_level-4';
    } else if (score === 3) {
        val = '3/5';
        color = '#F9AF6A';
        class_ = 'mgPlayerJSProd_level-3';
    } else if (score === 2) {
        val = '2/5';
        color = '#DE350B';
        class_ = 'mgPlayerJSProd_level-2';
    } else if (score === 1) {
        val = '1/5';
        color = '#B3463F';
        class_ = 'mgPlayerJSProd_level-1';
    }

    return {
        val: val,
        color: color,
        class_: class_
    };
};

/**
 * @file TestMe module
 * @author Nilesh Pachpande
 */
/*global GmCXt*/
GmCXt.testMeWatcher = function(options) {
    options = options || {};

    let pub = {};

    let self = {
        frame: options.frame
    };

    GmCXt.selectorTool = GmCXt.selector({
        cb: null,
        frame: self.frame
    });

    pub.start = function() {
        GmCXt.TestMeActive = true;
        subscribeEvents();
        GmCXt.log(58, "START WATCHING events for MyTest");
    };

    pub.stop = function() {
        GmCXt.TestMeActive = false;
        unsubscribeEvents();
        GmCXt.log(58, "STOP WATCHING events for MyTest");
    };

    function subscribeEvents() {
        unsubscribeEvents();
        window.addEventListener('mousedown', mouseDownEvent);
        window.addEventListener('mouseover', mouseOverEventDebouce);
    }

    function unsubscribeEvents() {
        window.removeEventListener('mousedown', mouseDownEvent);
        window.removeEventListener('mouseover', mouseOverEventDebouce);
    }

    function stopOnEscape(e) {
        if (e.keyCode === 27) {
            pub.stop();
        }
    }

    function checkTestMeWidgetClick(e) {
        if (e.target.className === 'mgPlayerJSProd_testme-active' ||
			e.target.className === 'mgPlayerJSProd_testme-active-head' ||
			e.target.className === 'mgPlayerJSProd_play-pause-position-top' ||
			e.target.className === 'mgPlayerJSProd_play-pause-position-bottom' ||
			e.target.className === 'mgPlayerJSProd_testme-active-close' ||
			e.target.className === 'mgPlayerJSProd_testme-active-inner' ||
			e.target.className === 'mgPlayerJSProd_testme-active-title' ||
			e.target.className === 'mgPlayerJSProd_testme-active-stop') {

            return true;
        } else {
            return false;
        }
    }

    function skipSvgIcon() {
        if (GmCXt.isSvgTag(self.he.tagName)) {

            self.he = self.he.parentNode;

            while (GmCXt.isSvgTag(self.he.tagName)) {
                self.he = self.he.parentNode;
            }
        }
    }

    function skipSalesforcePrimitiveEl() {
        if (GmCXt.checkSalesForceSite()) {
            if (self.he.tagName === 'LIGHTNING-PRIMITIVE-ICON') {
                self.he = self.he.parentNode;
            }

            let parent = self.he.parentNode;
            if (self.he.tagName === 'BUTTON' &&
				(parent.tagName === 'LIGHTNING-BUTTON-ICON' || parent.tagName === 'LIGHTNING-BUTTON')) {
                self.he = parent;
            }
        }
    }

    function recordEvent(e, eventName) {
        if (!checkTestMeWidgetClick(e)) {

            self.he = e.target;

            skipSvgIcon();
            skipSalesforcePrimitiveEl();

            let tempHe = self.he;
            let element = [];
            for (let i = 0; i < 3; i++) {
                if (tempHe) {
                    element[i] = GmCXt.selectorTool.getElData(tempHe).element;
                    tempHe = tempHe.parentNode;
                }
            }

            let data = {
                event: eventName,
                element: element
            };
            GmCXt.sendMessageToTheTopWindow('mgPlayerJSProd_action:record_event;testMe', data);
        }
    }

    function mouseDownEvent(e) {
        recordEvent(e, 'click');
    }

    function mouseOverEvent(e) {
        recordEvent(e, 'mouseover');
    }

    var mouseOverEventDebouce = GmCXt.debounce(mouseOverEvent, 10);
    return pub;
};
/*global GmCXt*/
GmCXt.getEmbedCode = function() {
    let embedCode = "if(!window.guideMe)window.guideMe={}; " +
        "window.guideMe.baseUrl='" + GmCXt.conf.clientJsBaseUrl + "';" +
        "var a=document.createElement('script');" +
        "a.src=guideMe.baseUrl+'guideme.js';" +
        "document.head.appendChild(a);";

    return embedCode;
};


GmCXt.injectGuideMeInIframes = function(windowInstance) {

    let frames_ = windowInstance.frames;
    let randomNumGenerated = function() {
        return crypto.getRandomValues(new Uint32Array(1))[0] / Math.pow(2, 32);
    };
    for (let i = 0; i < frames_.length; i++) {

        try {
            if (!frames_[i].name) {
                frames_[i].name = 'name_' + randomNumGenerated();
            }

            if (GmCXt.isAllowedIframe(frames_[i].name)) {

                if (!frames_[i].GmCXt && (frames_[i].innerWidth > 1) && (frames_[i].innerHeight > 1)) {
                    let embedScript = document.createTextNode(GmCXt.getEmbedCode());

                    let newScript = document.createElement("script");
                    newScript.appendChild(embedScript);

                    let frameContent = frames_[i].document.head;
                    frameContent.appendChild(newScript);

                }

                if (frames_[i].window.frames.length) {
                    GmCXt.injectGuideMeInIframes(frames_[i].window);
                }
            }
        } catch (e) {}
    }
};
/*global GmCXt*/
(function() {
    function load(cssId, path) {
        if (!document.getElementById(cssId)) {
            let head = document.getElementsByTagName('head')[0];
            let link = document.createElement('link');
            link.id = cssId;
            link.rel = 'stylesheet';
            link.type = 'text/css';

            if (GmCXt.conf.baseUrl) {
                link.href = GmCXt.conf.baseUrl + path;
            } else {
                link.href = GmCXt.conf.clientJsBaseUrl + path;
            }

            link.media = 'all';
            head.appendChild(link);
        }
    }

    load('guideme-clientframe-css', 'content_script/dom_selector/css/style_1763457112441.css');
})();
/*global GmCXt*/
(function() {
    function load(cssId, path) {
        if (!document.getElementById(cssId)) {
            let head = document.getElementsByTagName('head')[0];
            let link = document.createElement('link');
            link.id = cssId;
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = GmCXt.conf.baseUrl + path;
            link.media = 'all';
            head.appendChild(link);
        }
    }

    function loadSidePanelClientFiles() {
        var sidePanel = document.createElement('script');
        if (window.self === window.top) {
            sidePanel.src = GmCXt.conf.baseUrl + 'side_panel/sidepanel_1763457112441.js';
        }
        document.head.appendChild(sidePanel);
    }

    load('guideme-clientjs-css', 'content_script/worker/css/style_1763457112441.css');
    load('guideme-sidepanel-css', 'side_panel/bundle_1763457112441.css');
    loadSidePanelClientFiles();


})();
